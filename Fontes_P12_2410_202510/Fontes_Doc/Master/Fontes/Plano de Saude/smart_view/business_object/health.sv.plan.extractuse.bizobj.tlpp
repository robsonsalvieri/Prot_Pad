#include "msobject.ch"
#include "protheus.ch"
#include "totvs.framework.treports.integratedprovider.th"
#include "tlpp-core.th"
#include "tlpp-rest.th"


namespace totvs.protheus.health.smartview.plan.extractuse 

using namespace totvs.protheus.health.smartview.plan.utils

/*/{Protheus.doc} CompaniesBussinesObject
Objeto de negócio para o TReports - Empresas

@type class
@version Protheus 12.1.2310
@authorRobso Nayland Benjamim
@since 06/05/2023
/*/ 

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGAPLS", tables="BD6", name="Extrato de Utilização", country="ALL", initialRelease="12.1.2210")
class ExtractUseTReportsBusinessObject from totvs.framework.treports.integratedprovider.IntegratedProvider
    public method new() as object
    public method getData() as object
    public method getSchema() as object

	private method getQuery() as character
	private method getWhere(oFilter as object) as character
	private method getOrder() as character
endclass

/*/{Protheus.doc} new
Contrutor da classe

@type method
@version Protheus 12.1.2310  
@authorRobso Nayland Benjamim
@since 06/05/2023
@return object, objeto da classe CompaniesBussinesObject
/*/   
method new() class ExtractUseTReportsBusinessObject

	_Super:new()

	//Define a Área
	self:appendArea(UtilsBusinessObject():getAreaName())
	//Define o nome do Objeto de Negócio
	self:setDisplayName("Extrato de Utilização")
	//Define a descrição do Objeto de Negócio
	self:setDescription("Objeto de negocio para atender a geração de informação de extrato de utilização")
	//Seta o Pergunte padrao do relatorio
	self:setPergunte("PLR022")
 
return self

/*/{Protheus.doc} getData
Retorna o objeto de dados

@type method
@version Protheus 12.1.2310  
@authorRobso Nayland Benjamim
@since 06/05/2023
@return object, objeto oData da classe IntegratedProvider 
/*/  
method getData(nPage as numeric, oFilter as object) as object class ExtractUseTReportsBusinessObject
	
	//Define a quantidade máxima por página (Default 100)
	self:setPageSize(100)

	//Seta a Query
	self:setQuery(self:getQuery())
	//Seta o Where da Query
    self:setWhere(self:getWhere(oFilter))
	//Seta o Order da Query
    self:setOrder(self:getOrder())

return self:oData
  
method getSchema() as object class ExtractUseTReportsBusinessObject

//	self:aliasToSchema("BD6")

self:addProperty(GetSx3Cache("BD6_CODOPE", "X3_TITULO"),GetSx3Cache("BD6_CODOPE", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODOPE", "X3_TITULO") , "BD6_CODOPE")
self:addProperty(GetSx3Cache("BD6_CONEMP", "X3_TITULO"),GetSx3Cache("BD6_CONEMP", "X3_TITULO") ,"string",GetSx3Cache("BD6_CONEMP", "X3_TITULO") , "BD6_CONEMP")
self:addProperty(GetSx3Cache("BD6_VERCON", "X3_TITULO"),GetSx3Cache("BD6_VERCON", "X3_TITULO") ,"string",GetSx3Cache("BD6_VERCON", "X3_TITULO") , "BD6_VERCON")
self:addProperty(GetSx3Cache("BD6_SUBCON", "X3_TITULO"),GetSx3Cache("BD6_SUBCON", "X3_TITULO") ,"string",GetSx3Cache("BD6_SUBCON", "X3_TITULO") , "BD6_SUBCON")
self:addProperty(GetSx3Cache("BD6_VERSUB", "X3_TITULO"),GetSx3Cache("BD6_VERSUB", "X3_TITULO") ,"string",GetSx3Cache("BD6_VERSUB", "X3_TITULO") , "BD6_VERSUB")
self:addProperty(GetSx3Cache("BD6_OPEUSR", "X3_TITULO"),GetSx3Cache("BD6_OPEUSR", "X3_TITULO") ,"string",GetSx3Cache("BD6_OPEUSR", "X3_TITULO") , "BD6_OPEUSR")
self:addProperty(GetSx3Cache("BD6_FADENT", "X3_TITULO"),GetSx3Cache("BD6_FADENT", "X3_TITULO") ,"string",GetSx3Cache("BD6_FADENT", "X3_TITULO") , "BD6_FADENT")
self:addProperty(GetSx3Cache("BD6_CODEMP", "X3_TITULO"),GetSx3Cache("BD6_CODEMP", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODEMP", "X3_TITULO") , "BD6_CODEMP")
self:addProperty(GetSx3Cache("BD6_MATRIC", "X3_TITULO"),GetSx3Cache("BD6_MATRIC", "X3_TITULO") ,"string",GetSx3Cache("BD6_MATRIC", "X3_TITULO") , "BD6_MATRIC")
self:addProperty(GetSx3Cache("BD6_TIPREG", "X3_TITULO"),GetSx3Cache("BD6_TIPREG", "X3_TITULO") ,"string",GetSx3Cache("BD6_TIPREG", "X3_TITULO") , "BD6_TIPREG")
self:addProperty(GetSx3Cache("BD6_DENREG", "X3_TITULO"),GetSx3Cache("BD6_DENREG", "X3_TITULO") ,"string",GetSx3Cache("BD6_DENREG", "X3_TITULO") , "BD6_DENREG")
self:addProperty(GetSx3Cache("BD6_DIGITO", "X3_TITULO"),GetSx3Cache("BD6_DIGITO", "X3_TITULO") ,"string",GetSx3Cache("BD6_DIGITO", "X3_TITULO") , "BD6_DIGITO")
self:addProperty(GetSx3Cache("BD6_ANOPAG", "X3_TITULO"),GetSx3Cache("BD6_ANOPAG", "X3_TITULO") ,"string",GetSx3Cache("BD6_ANOPAG", "X3_TITULO") , "BD6_ANOPAG")
self:addProperty(GetSx3Cache("BD6_MESPAG", "X3_TITULO"),GetSx3Cache("BD6_MESPAG", "X3_TITULO") ,"string",GetSx3Cache("BD6_MESPAG", "X3_TITULO") , "BD6_MESPAG")
self:addProperty(GetSx3Cache("BD6_NOMUSR", "X3_TITULO"),GetSx3Cache("BD6_NOMUSR", "X3_TITULO") ,"string",GetSx3Cache("BD6_NOMUSR", "X3_TITULO") , "BD6_NOMUSR")
self:addProperty(GetSx3Cache("BD6_CODRDA", "X3_TITULO"),GetSx3Cache("BD6_CODRDA", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODRDA", "X3_TITULO") , "BD6_CODRDA")
self:addProperty(GetSx3Cache("BD6_NOMRDA", "X3_TITULO"),GetSx3Cache("BD6_NOMRDA", "X3_TITULO") ,"string",GetSx3Cache("BD6_NOMRDA", "X3_TITULO") , "BD6_NOMRDA")
self:addProperty(GetSx3Cache("BD6_FASE"  , "X3_TITULO"),GetSx3Cache("BD6_FASE"  , "X3_TITULO") ,"string",GetSx3Cache("BD6_FASE"  , "X3_TITULO") , "BD6_FASE")
self:addProperty(GetSx3Cache("BD6_DATPRO", "X3_TITULO"),GetSx3Cache("BD6_DATPRO", "X3_TITULO") ,"string",GetSx3Cache("BD6_DATPRO", "X3_TITULO") , "BD6_DATPRO")
self:addProperty(GetSx3Cache("BD6_QTDPRO", "X3_TITULO"),GetSx3Cache("BD6_QTDPRO", "X3_TITULO") ,"string",GetSx3Cache("BD6_QTDPRO", "X3_TITULO") , "BD6_QTDPRO")
self:addProperty(GetSx3Cache("BD6_STAFAT", "X3_TITULO"),GetSx3Cache("BD6_STAFAT", "X3_TITULO") ,"string",GetSx3Cache("BD6_STAFAT", "X3_TITULO") , "BD6_STAFAT")
self:addProperty(GetSx3Cache("BD6_SITUAC", "X3_TITULO"),GetSx3Cache("BD6_SITUAC", "X3_TITULO") ,"string",GetSx3Cache("BD6_SITUAC", "X3_TITULO") , "BD6_SITUAC")
self:addProperty(GetSx3Cache("BD6_DESLOC", "X3_TITULO"),GetSx3Cache("BD6_DESLOC", "X3_TITULO") ,"string",GetSx3Cache("BD6_DESLOC", "X3_TITULO") , "BD6_DESLOC")
self:addProperty(GetSx3Cache("BD6_CODPAD", "X3_TITULO"),GetSx3Cache("BD6_CODPAD", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODPAD", "X3_TITULO") , "BD6_CODPAD")
self:addProperty(GetSx3Cache("BD6_CODPRO", "X3_TITULO"),GetSx3Cache("BD6_CODPRO", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODPRO", "X3_TITULO") , "BD6_CODPRO")
self:addProperty(GetSx3Cache("BD6_DESPRO", "X3_TITULO"),GetSx3Cache("BD6_DESPRO", "X3_TITULO") ,"string",GetSx3Cache("BD6_DESPRO", "X3_TITULO") , "BD6_DESPRO")
self:addProperty(GetSx3Cache("BD6_CODLDP", "X3_TITULO"),GetSx3Cache("BD6_CODLDP", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODLDP", "X3_TITULO") , "BD6_CODLDP")
self:addProperty(GetSx3Cache("BD6_CODPEG", "X3_TITULO"),GetSx3Cache("BD6_CODPEG", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODPEG", "X3_TITULO") , "BD6_CODPEG")
self:addProperty(GetSx3Cache("BD6_NUMERO", "X3_TITULO"),GetSx3Cache("BD6_NUMERO", "X3_TITULO") ,"string",GetSx3Cache("BD6_NUMERO", "X3_TITULO") , "BD6_NUMERO")
self:addProperty(GetSx3Cache("BD6_VLRPAG", "X3_TITULO"),GetSx3Cache("BD6_VLRPAG", "X3_TITULO") ,"string",GetSx3Cache("BD6_VLRPAG", "X3_TITULO") , "BD6_VLRPAG")
self:addProperty(GetSx3Cache("BD6_VLRTPF", "X3_TITULO"),GetSx3Cache("BD6_VLRTPF", "X3_TITULO") ,"string",GetSx3Cache("BD6_VLRTPF", "X3_TITULO") , "BD6_VLRTPF")
self:addProperty(GetSx3Cache("BD6_MATVID", "X3_TITULO"),GetSx3Cache("BD6_MATVID", "X3_TITULO") ,"string",GetSx3Cache("BD6_MATVID", "X3_TITULO") , "BD6_MATVID")
self:addProperty(GetSx3Cache("BD6_VLRGLO", "X3_TITULO"),GetSx3Cache("BD6_VLRGLO", "X3_TITULO") ,"string",GetSx3Cache("BD6_VLRGLO", "X3_TITULO") , "BD6_VLRGLO")
self:addProperty(GetSx3Cache("BD6_CODPLA", "X3_TITULO"),GetSx3Cache("BD6_CODPLA", "X3_TITULO") ,"string",GetSx3Cache("BD6_CODPLA", "X3_TITULO") , "BD6_CODPLA")
self:addProperty(GetSx3Cache("BD6_TIPGUI", "X3_TITULO"),GetSx3Cache("BD6_TIPGUI", "X3_TITULO") ,"string",GetSx3Cache("BD6_TIPGUI", "X3_TITULO") , "BD6_TIPGUI")
self:addProperty(GetSx3Cache("BD6_TIPRDA", "X3_TITULO"),GetSx3Cache("BD6_TIPRDA", "X3_TITULO") ,"string",GetSx3Cache("BD6_TIPRDA", "X3_TITULO") , "BD6_TIPRDA")
self:addProperty(GetSx3Cache("BD6_CPFRDA", "X3_TITULO"),GetSx3Cache("BD6_CPFRDA", "X3_TITULO") ,"string",GetSx3Cache("BD6_CPFRDA", "X3_TITULO") , "BD6_CPFRDA")
self:addProperty(GetSx3Cache("BD6_TPEVCT", "X3_TITULO"),GetSx3Cache("BD6_TPEVCT", "X3_TITULO") ,"string",GetSx3Cache("BD6_TPEVCT", "X3_TITULO") , "BD6_TPEVCT")
self:addProperty(GetSx3Cache("BD6_CDPFRE", "X3_TITULO"),GetSx3Cache("BD6_CDPFRE", "X3_TITULO") ,"string",GetSx3Cache("BD6_CDPFRE", "X3_TITULO") , "BD6_CDPFRE")
self:addProperty(GetSx3Cache("BD6_ESPEXE", "X3_TITULO"),GetSx3Cache("BD6_ESPEXE", "X3_TITULO") ,"string",GetSx3Cache("BD6_ESPEXE", "X3_TITULO") , "BD6_ESPEXE")
 
return self:oSchema

/*/{Protheus.doc} getQuery
Retorna o corpo da Query 

@type method
@version Protheus 12.1.2310  
@authorRobso Nayland Benjamim
@since 06/05/2023
@return character, corpo da Query
/*/  
method getQuery() as character class ExtractUseTReportsBusinessObject

	local cQuery as character


   
	//BG9 (Grupo/Empresa)
	cQuery := "SELECT #QueryFields# FROM " + RetSQLName("BD6")+ " BD6 "
	//Where
	cQuery += " WHERE #QueryWhere#"

return cQuery



/*/{Protheus.doc} getWhere
Retorna as condições para a Query principal

@type method
@version Protheus 12.1.2310  
@authorRobso Nayland Benjamim
@since 06/05/2023
@return character, Where da Query
/*/  
method getWhere(oFilter as object) as character class ExtractUseTReportsBusinessObject
	
	local cWhere as Character
	local jParams as json
	local cTpFil as Character
	local cStatus as Character
	local lWeb as logical

	cStatus := AllTrim(GetNewPar("MV_PLSPEXT","3"))
	lWeb := .F.
	//metodo para retorno do json dos parâmetros vindos do setPergunte
	jParams := oFilter:getParameters()

	nFase := val(jParams['MV_PAR13'][1])
	cWhere := " BD6_FILIAL  = '"+ FWxFilial('BD6') +"' AND "
	//Define como a rotina foi filtrada atraves dos parametros informados
	if empty(jParams['MV_PAR06'][1]+  jParams['MV_PAR05'][1] )
		cTpFil := "1"
	elseif !empty(jParams['MV_PAR06'][1]) .And. empty(jParams['MV_PAR05'][1])
		cTpFil := "2"
	else
		cTpFil := "3"
	endif
	
	//Monta o filtro de acordo com parametros

	
	if cTpFil == '2'
		cWhere += "BD6_OPEUSR = '" + jParams['MV_PAR01'][1]+  "' AND "
		cWhere += "BD6_CODEMP = '" + jParams['MV_PAR02'][1] +  "' AND "
		cWhere += "BD6_MATRIC = '" + jParams['MV_PAR05'][1] +  "' AND "
		cWhere += "BD6_TIPREG = '" + Substr(jParams["MV_PAR06"][1],15,2) + "' AND "
		cWhere += "BD6_DIGITO = '" + Substr(jParams["MV_PAR06"][1],17,1) +  "' AND "
	elseif cTpFil == "3"
		cWhere += "BD6_OPEUSR = '" +  jParams['MV_PAR01'][1] + "' AND "
		cWhere += "BD6_CODEMP = '" +  jParams['MV_PAR02'][1] + "' AND "
		cWhere += "BD6_MATRIC = '" +  jParams['MV_PAR05'][1] + "' AND "
		cWhere += "BD6_CONEMP = '" +  jParams['MV_PAR03'][1] + "' AND "
		cWhere += "BD6_SUBCON = '" +  jParams['MV_PAR04'][1] + "' AND "
	else
		cWhere += "BD6_OPEUSR = '" + jParams['MV_PAR01'][1] + "' AND "
		cWhere += "BD6_CODEMP = '" + jParams['MV_PAR02'][1] + "' AND "
		cWhere += "BD6_CONEMP = '" + jParams['MV_PAR03'][1] + "' AND "
		cWhere += "BD6_SUBCON = '" + jParams['MV_PAR04'][1] + "' AND "
	endif

	cWhere += " BD6_DATPRO   >=  '" + dTos(FwDateTimeToLocal(jParams['MV_PAR07'][1] ,1)[1]) + "' AND "
	cWhere += " BD6_DATPRO   <=  '" + dTos(FwDateTimeToLocal(jParams['MV_PAR08'][1] ,1)[1]) + "' AND "
	cWhere += " BD6_ANOPAG   >=  '" + jParams['MV_PAR09'][1] + "' AND "
	cWhere += " BD6_MESPAG   >=  '" + jParams['MV_PAR10'][1] + "' AND "
	cWhere += " BD6_ANOPAG   <=  '" + jParams['MV_PAR11'][1] + "' AND "
	cWhere += " BD6_MESPAG   <=  '" + jParams['MV_PAR12'][1] + "' AND "
	cWhere += " BD6_LIBERA   <> '1'  AND "
	
	if !lWeb
		if nFase == 1
			cWhere += "BD6_FASE = '3'  AND "
		elseif nFase == 2
			cWhere += "BD6_FASE = '4'  AND " 
		elseif nFase == 3
			cWhere += "BD6_FASE = '2'  AND "
		endif
	elseif !empty(cStatus)
		if At("/", cStatus)
			cWhere += "BD6_FASE IN " + FormatIn(cStatus,"/") + " AND "
		elseif At(",",cStatus)
			cWhere += "BD6_FASE IN " + FormatIn(cStatus,",") + " AND "
		else
			cWhere += "BD6_FASE = '" + cStatus + "' AND "
		endif
	endif
	cWhere += " D_E_L_E_T_= ' ' "

return cWhere

/*/{Protheus.doc} getOrder
Retorna as ordenação para a Query principal

@type method
@version Protheus 12.1.2310  
@authorRobso Nayland Benjamim
@since 06/05/2023
@return character, Order da Query
/*/  
method getOrder() as character class ExtractUseTReportsBusinessObject

	local cOrder as Character

	//Define o campo de ordenação da query
	cOrder := "BD6_DATPRO, BD6_OPEUSR, BD6_CODEMP, BD6_MATRIC , BD6_TIPREG , BD6_DIGITO , BD6_TIPGUI"

return cOrder
