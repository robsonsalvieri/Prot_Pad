#include "fwmvcdef.ch"
#include "tlpp-core.th"
#include "health.plan.unimed.cadbenef.event.batch.ch"

namespace totvs.protheus.health.plan.unimed

/*/{Protheus.doc} CadBenefEventBatch
Eventos MVC do cadastro de lotes do CadBenef
@type class
@version 12.1.2410  
@author vinicius.queiros
@since 21/05/2024
/*/
class CadBenefEventBatch from FwModelEvent

    public method new() constructor
    public method after(oSubModel as object, cModelId as character, cAlias as character, lNewRecord as logical)
    public method before(oSubModel as object, cModelId as character, cAlias as character, lNewRecord as logical)
    public method afterTTS(oModel as object, cModelId as character)                                                       
    public method beforeTTS(oModel as object, cModelId as character)                                                     
    public method inTTS(oModel as object, cModelId as character)                                                          
    public method activate(oModel as object, lCopy as logical)
    public method deActivate(oModel as object)   
    public method vldActivate(oModel as object, cModelId as character) as logical
    public method modelPreVld(oModel as object, cModelId as character) as logical
    public method modelPosVld(oModel as object, cModelId as character) as logical
    public method gridPosVld(oSubModel as object, cModelID as character) as logical
    public method gridLinePreVld(oSubModel as object, cModelID as character, nLine as numeric, cAction as character, cId as character, xValue as variant, xCurrentValue as variant) as logical
    public method gridLinePosVld(oSubModel as object, cModelID as character, nLine as numeric) as logical                                       
    public method fieldPreVld(oSubModel as object, cModelID as character, cAction as character, cId as character, xValue as variant) as logical
    public method fieldPosVld(oSubModel as object, cModelID as character) as logical 

endclass

/*/{Protheus.doc} new
Método construtor da classe
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@return object, objeto da classe CadBenefEventBatch 
/*/
method new() class CadBenefEventBatch

return self

/*/{Protheus.doc} after
Método que é chamado pelo MVC quando ocorrer as ações do commit
depois da gravação de cada submodelo (field ou cada linha de uma grid)
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Sub modelo
@param cModelId, character, Id do submodelo
@param cAlias, character, Alias do submodelo
@param lNewRecord, logical, Indica se é um registro novo
/*/
method after(oSubModel as object, cModelId as character, cAlias as character, lNewRecord as logical) class CadBenefEventBatch

return

/*/{Protheus.doc} before
Método que é chamado pelo MVC quando ocorrer as ações do commit antes 
da gravação de cada submodelo (field ou cada linha de uma grid)
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Sub modelo
@param cModelId, character, Id do submodelo
@param cAlias, character, Alias do submodelo
@param lNewRecord, logical, Indica se é um registro novo
/*/
method before(oSubModel as object, cModelId as character, cAlias as character, lNewRecord as logical) class CadBenefEventBatch    

return

/*/{Protheus.doc} afterTTS
Método que é chamado pelo MVC quando ocorrer as ações do  após a transação.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
/*/
method afterTTS(oModel as object, cModelId as character) class CadBenefEventBatch

return

/*/{Protheus.doc} beforeTTS
Método que é chamado pelo MVC quando ocorrer as ações do commit antes da transação.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
/*/
method beforeTTS(oModel as object, cModelId as character) class CadBenefEventBatch

return

/*/{Protheus.doc} inTTS
Método que é chamado pelo MVC quando ocorrer as ações do commit Após as gravações porém
antes do final da transação.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
/*/
method inTTS(oModel as object, cModelId as character) class CadBenefEventBatch

    local jParameters as json
    local oModelBPW as object
    local nQtdAddTotal := 0 as numeric

    do case
        case oModel:getOperation() == MODEL_OPERATION_INSERT
            jParameters := JsonObject():new()
            oModelBPW := oModel:getModel("BPWMASTER")
        
            jParameters["batchCode"] := oModelBPW:getValue("BPW_CODIGO")
            jParameters["unimedOrigin"] := oModelBPW:getValue("BPW_UNIORI")
            jParameters["movementType"] := oModelBPW:getValue("BPW_TIPMOV")
            jParameters["dateFrom"] := oModelBPW:getValue("BPW_DATINI")
            jParameters["dateTo"] := oModelBPW:getValue("BPW_DATFIN")
            jParameters["companyCodeFrom"] := oModelBPW:getValue("BPW_EMPINI")
            jParameters["companyCodeTo"] := oModelBPW:getValue("BPW_EMPFIN")
            jParameters["contractCodeFrom"] := oModelBPW:getValue("BPW_CONINI")
            jParameters["contractCodeTo"] := oModelBPW:getValue("BPW_CONFIN")
            jParameters["subcontractCodeFrom"] := oModelBPW:getValue("BPW_SUBINI")
            jParameters["subcontractCodeTo"] := oModelBPW:getValue("BPW_SUBFIN")
            jParameters["familyCodeFrom"] := oModelBPW:getValue("BPW_FAMINI")
            jParameters["familyCodeTo"] := oModelBPW:getValue("BPW_FAMFIN")
            jParameters["considerSIB"] := oModelBPW:getValue("BPW_SIB")
            jParameters["considerANS"] := oModelBPW:getValue("BPW_ANS")

            if isBlind()
                cadBenefBatchAddBeneficiaries(jParameters)  
            else
                fwMsgRun(nil, {|| nQtdAddTotal := cadBenefBatchAddBeneficiaries(jParameters)}, "", STR0001) // "Incluindo beneficiários no lote ..."
                fwAlertSuccess(STR0002 + "<b>" + cValToChar(nQtdAddTotal) + STR0003 + "</b>" + STR0004, "") // "Foram adicionados um total de ";" beneficiários ";"no lote."
            endif
        
        case oModel:getOperation() == MODEL_OPERATION_DELETE
            jParameters := JsonObject():new()
            oModelBPW := oModel:getModel("BPWMASTER")
        
            jParameters["batchCode"] := oModelBPW:getValue("BPW_CODIGO")

            if isBlind()
                cadBenefBatchDeleteBeneficiaries(jParameters)  
            else
                fwMsgRun(nil, {|| cadBenefBatchDeleteBeneficiaries(jParameters)}, "", STR0005) // "Excluindo beneficiários do lote ..."
            endif
    endcase

    freeObj(jParameters)

return

/*/{Protheus.doc} activate
Método que é chamado pelo MVC quando ocorrer a ativação do Model.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param lCopy, logical, Informa se o model deve carregar os dados do registro posicionado em operações de inclusão. Essa opção é usada quando é necessário fazer uma operação de cópia.
/*/
method activate(oModel as object, lCopy as logical) class CadBenefEventBatch

return

/*/{Protheus.doc} deActivate
Método que é chamado pelo MVC quando ocorrer a desativação do Model.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
/*/
method deActivate(oModel as object) class CadBenefEventBatch

return

/*/{Protheus.doc} vldActivate
Método que é chamado pelo MVC quando ocorrer as ações de validação do Model.
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@return logical, Se está valido para ativação
/*/ 
method vldActivate(oModel as object, cModelId as character) as logical class CadBenefEventBatch
    
    local lOk := .t. as logical

return lOk

/*/{Protheus.doc} modelPreVld
Método que é chamado pelo MVC quando ocorrer as ações de pre validação do Model
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@return logical, Se o modelo está valido antes das alterações
/*/  
method modelPreVld(oModel as object, cModelId as character) as logical class CadBenefEventBatch

    local lOk := .t. as logical

return lOk

/*/{Protheus.doc} modelPosVld
Método que é chamado pelo MVC quando ocorrer as ações de pos validação do Model
Esse evento ocorre uma vez no contexto do modelo principal.
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@return logical, Se o modelo principal está valido após as alterações
/*/ 
method modelPosVld(oModel as object, cModelId as character) as logical class CadBenefEventBatch

    local lOk := .t. as logical
    local jParameters := JsonObject():new() as json
    local oModelBPW as object
    local nOperation := oModel:getOperation()

    if nOperation == MODEL_OPERATION_INSERT
        oModelBPW := oModel:getModel("BPWMASTER")
            
        jParameters["batchCode"] := oModelBPW:getValue("BPW_CODIGO")
        jParameters["unimedOrigin"] := oModelBPW:getValue("BPW_UNIORI")
        jParameters["movementType"] := oModelBPW:getValue("BPW_TIPMOV")
        jParameters["dateFrom"] := oModelBPW:getValue("BPW_DATINI")
        jParameters["dateTo"] := oModelBPW:getValue("BPW_DATFIN")
        jParameters["companyCodeFrom"] := oModelBPW:getValue("BPW_EMPINI")
        jParameters["companyCodeTo"] := oModelBPW:getValue("BPW_EMPFIN")
        jParameters["contractCodeFrom"] := oModelBPW:getValue("BPW_CONINI")
        jParameters["contractCodeTo"] := oModelBPW:getValue("BPW_CONFIN")
        jParameters["subcontractCodeFrom"] := oModelBPW:getValue("BPW_SUBINI")
        jParameters["subcontractCodeTo"] := oModelBPW:getValue("BPW_SUBFIN")
        jParameters["familyCodeFrom"] := oModelBPW:getValue("BPW_FAMINI")
        jParameters["familyCodeTo"] := oModelBPW:getValue("BPW_FAMFIN")
        jParameters["considerSIB"] := oModelBPW:getValue("BPW_SIB")
        jParameters["considerANS"] := oModelBPW:getValue("BPW_ANS")

        if isBlind()
            lOk := cadBenefBatchHasBeneficiaries(jParameters)  
        else
            fwMsgRun(nil, {|| lOk := cadBenefBatchHasBeneficiaries(jParameters)}, "", STR0006) // "Procurando beneficiários ..."
        endif

        if !lOk
            help("", 1, STR0007, nil, STR0008, 1, 0, nil, nil, nil, nil, nil, {STR0009}) // "Atenção";"Nenhum beneficiário encontrado para o lote.";"Verifique se os parâmetros informados no lote estão preenchidos corretamente, lembrando que os beneficiários que estão pendente em outro lote ou já enviados não serão considerados."
        endif
    endif

    freeObj(jParameters)

return lOk

/*/{Protheus.doc} gridPosVld
Método que é chamado pelo MVC quando ocorrer as ações de pós validação do Grid
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@return logical, Se o modelo está valido após as alterações
/*/ 
method gridPosVld(oSubModel as object, cModelID as character) as logical class CadBenefEventBatch

    local lOk := .t. as logical
    
return lOk

/*/{Protheus.doc} gridLinePreVld
Método que é chamado pelo MVC quando ocorrer as ações de pre validação da linha do Grid
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@param nLine, numeric, Linha do grid
@param cAction, character, Ação executada no grid, podendo ser: UNDELETE, DELETE, SETVALUE, CANSETVALUE
@param cId, character, nome do campo
@param xValue, variant, Novo valor do campo
@param xCurrentValue, variant, Valor atual do campo
@return logical, Se o modelo está valido antes das alterações
/*/ 
method gridLinePreVld(oSubModel as object, cModelID as character, nLine as numeric, cAction as character, cId as character, xValue as variant, xCurrentValue as variant) as logical class CadBenefEventBatch

    local lOk := .t. as logical
    
return lOk

/*/{Protheus.doc} gridLinePosVld
Método que é chamado pelo MVC quando ocorrer as ações de pos validação da linha do Grid
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@param nLine, numeric, Linha do grid
@return logical, Se o modelo está valido após as alterações
/*/  
method gridLinePosVld(oSubModel as object, cModelID as character, nLine as numeric) as logical class CadBenefEventBatch 

    Local lOk := .t. as logical
    
return lOk

/*/{Protheus.doc} fieldPreVld
Método que é chamado pelo MVC quando ocorrer a ação de pré validação do Field
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@param cAction, character, Ação executada no grid, podendo ser: SETVALUE, CANSETVALUE
@param cId, character, nome do campo
@param xValue, variant, Novo valor do campo
@return logical, Se o modelo está valido antes das alterações
/*/ 
method fieldPreVld(oSubModel as object, cModelID as character, cAction as character, cId as character, xValue as variant) as logical class CadBenefEventBatch

    local lOk := .t. as logical

return lOk

/*/{Protheus.doc} fieldPosVld
Método que é chamado pelo MVC quando ocorrer a ação de pós validação do Field
@type method
@version 12.1.2410
@author vinicius.queiros
@since 01/02/2024
@param oSubModel, object, Modelo principal
@param cModelId, character, Id do submodelo
@return logical, Se o modelo está valido após as alterações
/*/
method fieldPosVld(oSubModel as object, cModelID as character) as logical class CadBenefEventBatch 

    local lOk := .t. as logical
    
return lOk
