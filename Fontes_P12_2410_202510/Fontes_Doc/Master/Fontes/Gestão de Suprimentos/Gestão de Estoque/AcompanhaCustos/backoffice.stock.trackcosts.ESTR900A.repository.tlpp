#include "tlpp-core.th"
#include "protheus.ch"
#include "tbiconn.ch"

namespace totvs.protheus.backoffice.stock.trackcosts.ESTR900A.repository

using namespace totvs.protheus.backoffice.stock.trackcosts.model.D4A
using namespace totvs.protheus.backoffice.stock.trackcosts.ESTR900.repository

class ESTR900ARepository

    public method New() 
    public method startAsyncESTR900A()
    public method getTotalProducts()
    public method getProducts()
    public method version()

endclass

/*/{Protheus.doc} ACKardexController:New()
// Metodo responsavel por instanciar e iniciar as variaveis da class acUser
// @typeÂ Â Metodo
// @authorÂ Pedro Missaglia
// @sinceÂ Â OutubroÂ 02, 2020
// @versionÂ 12.1.27
/*/
method new() class ESTR900ARepository

return Self

/*/{Protheus.doc} ACKardexController:New()
// Metodo responsavel por instanciar e iniciar as variaveis da class acUser
// @typeÂ Â Metodo
// @authorÂ Pedro Missaglia
// @sinceÂ Â OutubroÂ 02, 2020
// @versionÂ 12.1.27
/*/
method startAsyncESTR900A(dDataIni, dDataFim, cId, cIdConfig, cUserName, nQuantTot, nMoeda, cPayload, lReproc, oReproc) class ESTR900ARepository

Local nMinimum  as numeric
Local nThread   as numeric
Local nRange    as numeric
Local nIniThr01 as numeric
Local nFimThr01 as numeric
Local nIniThr02 as numeric
Local nFimThr02 as numeric
Local nIniThr03 as numeric
Local nFimThr03 as numeric
Local nIniThr04 as numeric
Local nFimThr04 as numeric
Local nIniThr05 as numeric
Local nFimThr05 as numeric
Local nTotal    as numeric
Local cProc     as character
Local cThread   as character

Local oD4A as Object
Local oObj as Object
Local oError as Object
Local oRepository := Nil as Object

Default lReproc := .F.
Default oReproc := JsonObject():New()

nThread         := 1
nRange          := 5
nIniThr01       := 0
nFimThr01       := 0
nIniThr02       := 0
nFimThr02       := 0
nIniThr03       := 0
nFimThr03       := 0
nIniThr04       := 0
nFimThr04       := 0
nIniThr05       := 0
nFimThr05       := 0
nTotal          := 0
cProc           := "ESTR900A"
cThread         := ""
oD4A            := totvs.protheus.backoffice.stock.trackcosts.model.D4A.D4A():New()
oObj            := JsonObject():New()
oRepository     := totvs.protheus.backoffice.stock.trackcosts.ESTR900.repository.ESTR900Repository():New()
oError          := ErrorBlock({|e| oRepository:setErrorInTransaction(cId, StrZero(nThread,2), cProc, e:Description, e:ErrorStack, cFilAnt)})

nMinimum        := 1000

oObj["D4A_FILIAL"]  := xFilial("D4A")
oObj["D4A_ID"]      := cId
oObj["D4A_CONFIG"]  := cIdConfig
oObj["D4A_THRNUM"]  := "00"
oObj["D4A_PROC"]    := cProc
oObj["D4A_USER"]    := cUserName
oObj["D4A_START"]   := 0
oObj["D4A_END"]     := 0
oObj["D4A_TOTAL"]   := 0
oObj["D4A_STATUS"]  := 'SETUP'
oObj["D4A_ERROR"]   := ""
oObj["D4A_STACK"]   := ""
oObj["D4A_DTEXEC"]  := MsDate()
oObj["D4A_HREXEC"]  := SubStr(Time(),1,TamSx3("D4A_HREXEC")[1])
oObj["D4A_BODY"]    := cPayload


If lReproc 

    oObj["D4A_THRNUM"]  := oReproc['thread']
    oObj["D4A_START"]   := oReproc["start"]
    oObj["D4A_END"]     := oReproc["end"]
    oObj["D4A_TOTAL"]   := oReproc["total"]

    oD4A:SEEK(cId, oReproc['thread'], cProc)
    oD4A:UPDATE(oObj)

    StartJob('ESTR900A',GetEnvServer(),.F.,cEmpAnt,cFilAnt, oReproc['thread'], oReproc["start"], oReproc["end"], dDataIni, dDataFim, cId, cUserName, oReproc["total"], cIdConfig, nMoeda)

Else 

    Begin SEQUENCE
        
        If nQuantTot >= nMinimum
            //ACIONAMENTO DE MULTI-THREAD
            For nThread := 1 to nRange
                cThread := StrZero(nThread,2)
                oObj["D4A_THRNUM"]  := cThread
                If nThread != 5 
                    If nThread == 1 

                        nIniThr01 := 1
                        nFimThr01 := round(nQuantTot / nRange, 0)

                        nTotal := (nFimThr01 - nIniThr01) + 1
                    Else 
                        &('nIniThr'+StrZero(nThread,2)) := &('nFimThr'+StrZero(nThread-1,2))+1
                        &('nFimThr'+StrZero(nThread,2)) := &('nFimThr'+StrZero(nThread-1,2)) + round(nQuantTot / nRange, 0)

                        nTotal := (&('nFimThr'+StrZero(nThread,2)) - &('nIniThr'+StrZero(nThread,2))) + 1
                    Endif
                else
                    nIniThr05 := &('nFimThr'+StrZero(nThread-1,2))+1
                    nFimThr05 :=  nQuantTot

                    nTotal := (nFimThr05 - nIniThr05) + 1
                Endif

                oObj["D4A_START"]   := &('nIniThr'+StrZero(nThread,2))
                oObj["D4A_END"]     := &('nFimThr'+StrZero(nThread,2))
                oObj["D4A_TOTAL"]   := nTotal

                oD4A:INSERT(oObj)
                
                StartJob('ESTR900A',GetEnvServer(),.F.,cEmpAnt,cFilAnt, cThread, &('nIniThr'+StrZero(nThread,2)), &('nFimThr'+StrZero(nThread,2)), dDataIni, dDataFim, cId, cUserName, nTotal, cIdConfig, nMoeda)

            Next nThread
        Else
            //ACIONAMENTO DE MONO-THREAD

            nTotal := nQuantTot
            cThread := StrZero(nThread,2)
            oObj["D4A_THRNUM"]  := cThread

            oObj["D4A_START"]   := 1
            oObj["D4A_END"]     := nQuantTot
            oObj["D4A_TOTAL"]   := nTotal

            oD4A:INSERT(oObj)

            StartJob('ESTR900A',GetEnvServer(),.F.,cEmpAnt,cFilAnt, cThread, 1, nQuantTot, dDataIni, dDataFim, cId, cUserName, nTotal, cIdConfig, nMoeda)
        Endif 

    End SEQUENCE

    ErrorBlock(oError)

EndIf

Return

/*/{Protheus.doc} ACKardexController:New()
// Metodo responsavel por instanciar e iniciar as variaveis da class acUser
// @typeÂ Â Metodo
// @authorÂ Pedro Missaglia
// @sinceÂ Â OutubroÂ 02, 2020
// @versionÂ 12.1.27
/*/
method getTotalProducts(cTable, cQuery) class ESTR900ARepository

Local nQuantTot as numeric
Local cAliasTot as character

cAliasTot := GetNextAlias()
nQuantTot := 0

If TCCanOpen(cTable)
    
    cQuery :=  ChangeQuery(cQuery)
    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasTot,.T.,.T.)

    nQuantTot := (cAliasTot)->TOTAL 
    (cAliasTot)->(DbCloseArea())
EndIf

return nQuantTot

/*/{Protheus.doc} version
    Metodo responsavel por indicar a versao da classe
    @type  Method
    @author Adriano Vieira
    @since  15/02/2024
    @version 12.1.23.10
/*/
Method version() class ESTR900ARepository
    Local nVersion := 200
Return nVersion
