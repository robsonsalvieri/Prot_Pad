#include "msobject.ch"
#include "totvs.framework.treports.integratedprovider.th"
#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "fiscal.sv.fis.edfcie.ch"

namespace totvs.protheus.fiscal.fis.treportsintegratedprovider
@totvsFrameworkTReportsIntegratedProvider(active=.T.,team="SIGAFIS", tables="CIE", name="Objeto de Negócio EFD - CIE", country="BRA", initialRelease="12.1.2310")
//-------------------------------------------------------------------
/*{Protheus.doc}  efdCFASmartviewBusinessObject
Classe para criação do objeto de Créditos Diferidos no Perí­odo  de processamento da Apuração de PIS e COFINS
@author Julia Mota
@since 14/11/2023
*/
//-------------------------------------------------------------------  
class efdCIESmartviewBusinessObject from totvs.framework.treports.integratedprovider.IntegratedProvider

	public method new() as object
	public method getData() as object
	public method getSchema() as object
    public method setData()

endclass


//-------------------------------------------------------------------
/*{Protheus.doc} new
Método de instancia da classe 
@return object: self 
@author Julia Mota
@since 23/11/2023
*/
//-------------------------------------------------------------------   
method new() class efdCIESmartviewBusinessObject

	Local oFisTools := fisSmartviewTools():new()

	_Super:new()
	
	//Define Area
	::appendArea(STR0001) //"Livros Fiscais"
	//Define o nome do objeto de Negócio
	::setDisplayName(STR0002) //"Objeto de Negócio EFD Contribuições - CIE"
	//Define a descrição do objeto de Negócio
	::setDescription(STR0003) //"Objeto de Negócio que fornece o detalhamento do EFD Contribuições (CIE)"
	::setIsCBoxLookup(.T., .F.)

	oFisTools:validPerg(::setPergunte("FISTRR1015"))
	freeobj(oFisTools)

return self

//-------------------------------------------------------------------
/*{Protheus.doc} getData
Retorna os dados do objeto de negócio 
@param nPage, numérico, indica a página atual do relatório
@param oFilter, objeto, contém o filtro do TReports 
@return object: ::oData 
@author julia.mota
@since 23/11/2023
*/
//-------------------------------------------------------------------   
method getData(nPage as numeric, oFilter as object) as object class efdCIESmartviewBusinessObject

	Local cQuery     as Character
	Local cAlias     as Character
	Local oFisTools  := fisSmartviewTools():new()
	Local oFiltQry   := oFilter:getParameters() as Json
	Local dStartDate := FwDateTimeToLocal(oFiltQry['MV_PAR01',1])[1]
    Local dEndDate   := FwDateTimeToLocal(oFiltQry['MV_PAR02',1])[1]
	Local cFilDe     := oFiltQry['MV_PAR03',1] as Character
	Local cFilAte    := oFiltQry['MV_PAR04',1] as Character
	Local lOk		 := .T. as Logical
    Local aFiliais   := {} as array
    Local cFils      := oFisTools:montaFilial(cFilDe, cFilAte, aFiliais) as character
    Local oPrepare   := nil as object

	if cFils == 'Erro'
		oFisTools:validFil(.F.)
		lOk := .f.
	endif

	if lOk

		cQuery += "SELECT "
		cQuery += "CIE.CIE_DOC   ,"
		cQuery += "CIE.CIE_SERIE ,"
		cQuery += "CIE.CIE_ITEM  ,"
		cQuery += "CIE.CIE_LOJA  ,"
		cQuery += "CIE.CIE_PROCES,"
		cQuery += "CIE.CIE_CPIS  ,"
		cQuery += "CIE.CIE_CCOF  ,"
		cQuery += "CIE.CIE_CPISSU,"
		cQuery += "CIE.CIE_CCOFSU,"
		cQuery += "CIE.CIE_BPIS  ,"
		cQuery += "CIE.CIE_BCOF  ,"
		cQuery += "CIE.CIE_APISSU,"
		cQuery += "CIE.CIE_TIPOPR,"
		cQuery += "CIE.CIE_APIS  ,"
		cQuery += "CIE.CIE_ACOF  ,"
		cQuery += "CIE.CIE_ACOFSU,"
		cQuery += "CIE.CIE_BCOFSU,"
		cQuery += "CIE.CIE_BPISSU,"
		cQuery += "CIE.CIE_INDAUT,"
		cQuery += "CIE.CIE_DTOPER,"
		cQuery += "CIE.CIE_VCOF  ,"
		cQuery += "CIE.CIE_VCOFSU,"
		cQuery += "CIE.CIE_VLOPER,"
		cQuery += "CIE.CIE_VPIS  ,"
		cQuery += "CIE.CIE_VPISSU,"
		cQuery += "CIE.CIE_IDITEM,"
		cQuery += "CIE.CIE_PART  ,"
		cQuery += "CIE.CIE_CODCOF,"
		cQuery += "CIE.CIE_CODPIS,"
		cQuery += "CIE.CIE_NATJU ,"
		cQuery += "CIE.CIE_PER   ,"
		cQuery += "CIE.CIE_CHVCL1,"
		cQuery += "CIE.CIE_FILIAL "
		cQuery += "FROM " + RetSQLName("CIE") + " CIE 			"
		cQuery += "WHERE 		  "
		cQuery += "		CIE.CIE_FILIAL IN ( ? ) 				" 
		cQuery += " 	AND CIE.CIE_DTOPER  BETWEEN ? AND ?		" 	 
		cQuery += " 	AND CIE.D_E_L_E_T_ = ? 						 

		// Instancia a classe
    	oPrepare := FwExecStatement():New(cQuery)

		oPrepare:setIn( 1, aFiliais )		
		oPrepare:setDate( 2, dStartDate)
		oPrepare:setDate( 3, dEndDate)		
		oPrepare:setString( 4, ' ' )	

        cAlias := oPrepare:OpenAlias() 
		
		while !(cAlias)->(Eof())

			::oData:appendData({;
				"CIE_DOC"       : (cAlias)->CIE_DOC,;   
				"CIE_SERIE"     : (cAlias)->CIE_SERIE,; 
				"CIE_ITEM"      : (cAlias)->CIE_ITEM,;
				"CIE_LOJA"      : (cAlias)->CIE_LOJA,;  
				"CIE_PROCES"    : (cAlias)->CIE_PROCES,;
				"CIE_CPIS"      : (cAlias)->CIE_CPIS,;
				"CIE_CCOF"      : (cAlias)->CIE_CCOF,;
				"CIE_CPISSU"    : (cAlias)->CIE_CPISSU,;
				"CIE_CCOFSU"    : (cAlias)->CIE_CCOFSU,;
				"CIE_BPIS"      : (cAlias)->CIE_BPIS,;
				"CIE_BCOF"      : (cAlias)->CIE_BCOF,;
				"CIE_APISSU"    : (cAlias)->CIE_APISSU,;
				"CIE_TIPOPR"    : (cAlias)->CIE_TIPOPR,;
				"CIE_APIS"      : (cAlias)->CIE_APIS,;
				"CIE_ACOF"      : (cAlias)->CIE_ACOF,;
				"CIE_ACOFSU"    : (cAlias)->CIE_ACOFSU,;
				"CIE_BCOFSU"    : (cAlias)->CIE_BCOFSU,;
				"CIE_BPISSU"    : (cAlias)->CIE_BPISSU,;
				"CIE_INDAUT"    : (cAlias)->CIE_INDAUT,;
				"CIE_DTOPER"    : totvs.framework.treports.date.stringToTimeStamp((cAlias)->CIE_DTOPER),;
				"CIE_VCOF"      : (cAlias)->CIE_VCOF,;
				"CIE_VCOFSU"    : (cAlias)->CIE_VCOFSU,;
				"CIE_VLOPER"    : (cAlias)->CIE_VLOPER,;
				"CIE_VPIS"      : (cAlias)->CIE_VPIS,; 
				"CIE_VPISSU"    : (cAlias)->CIE_VPISSU,;
				"CIE_IDITEM"    : (cAlias)->CIE_IDITEM,;
				"CIE_PART"      : (cAlias)->CIE_PART,;
				"CIE_CODCOF"    : (cAlias)->CIE_CODCOF,;
				"CIE_CODPIS"    : (cAlias)->CIE_CODPIS,;
				"CIE_INDAUT"    : (cAlias)->CIE_INDAUT,;
				"CIE_NATJU"     : (cAlias)->CIE_NATJU,; 
				"CIE_PER"       : totvs.framework.treports.date.stringToTimeStamp((cAlias)->CIE_PER),;
				"CIE_CHVCL1"    : (cAlias)->CIE_CHVCL1,;
				"CIE_FILIAL"    : (cAlias)->CIE_FILIAL;
				})

			(cAlias)->(dbSkip())

		enddo

		(cAlias)->(DBCloseArea())

		oPrepare:Destroy()
	
	endif

    freeobj(oFisTools)
	oPrepare := nil 
    freeobj(oFiltQry)
    aSize(aFiliais,0)
    aFiliais := nil

return ::oData

//-------------------------------------------------------------------
/*{Protheus.doc} getSchema
Retorna a estrutura dos campos 
@return object: ::oSchema 
@author Julia Mota
@since 23/11/2023
*/
//-------------------------------------------------------------------   
method getSchema() as object class efdCIESmartviewBusinessObject
	
    ::addProperty("CIE_DOC"   , "Número da Nota Fiscal"     , "string"  , "Num. NF"  				,  "CIE_DOC"	)
	::addProperty("CIE_SERIE" , "Série da Nota Fiscal"      , "string"  , "Série NF"  				,  "CIE_SERIE"	)
    ::addProperty("CIE_ITEM"  , "Item da Nota Fiscal"       , "string"  , "Item NF"  				,  "CIE_ITEM"	)
	::addProperty("CIE_LOJA"  , "Loja do Participante"      , "string"  , "Loja Participante"  		,  "CIE_LOJA"	)
    ::addProperty("CIE_PROCES", "Número do Processo"        , "string"  , "Nº Processo"				,  "CIE_PROCES"	)
    ::addProperty("CIE_CPIS"  , "CST PIS Escrituração"      , "string"  , "CST PIS"					,  "CIE_CPIS"	)
    ::addProperty("CIE_CCOF"  , "CST COFINS Escrituração"   , "string"  , "CST COFINS"  			,  "CIE_CCOF"	)
    ::addProperty("CIE_CPISSU", "CST PIS Suspensão"         , "string"  , "CST PIS Suspensão"  		,  "CIE_CPISSU"	)
    ::addProperty("CIE_CCOFSU", "CST COFINS Suspensão"      , "string"  , "CST Cof Suspensão"  		,  "CIE_CCOFSU"	)
    ::addProperty("CIE_BPIS"  , "Base PIS Escriturada"      , "number"  , "Base PIS Escriturada"  	,  "CIE_BPIS"	)
    ::addProperty("CIE_BCOF"  , "Base Cofins Escriturada"   , "number"  , "Base COF Escriturada"  	,  "CIE_BCOF"	)
    ::addProperty("CIE_APISSU", "Alíquota PIS Suspensão"    , "number"  , "Alíquota PIS Suspensão"	,  "CIE_APISSU"	)
    ::addProperty("CIE_TIPOPR", "Tipo do Processo"          , "string"  , "Tipo Processo"			,  "CIE_TIPOPR"	)
    ::addProperty("CIE_APIS"  , "Aliquota PIS Escriturado"  , "number"  , "Alíquota Pis Escriturado",  "CIE_APIS"	)
	::addProperty("CIE_ACOF"  , "Aliq. Cofins Escriturada " , "number"  , "Alíquota Cof Escriturado",  "CIE_ACOF"	)
	::addProperty("CIE_ACOFSU", "Aliq. Cofins Suspensão"    , "number"  , "Alíquota Cof Suspensão"  ,  "CIE_ACOFSU"	)
	::addProperty("CIE_BCOFSU", "Base COFINS Suspenso"      , "number"  , "Base Cof Suspensão"  	,  "CIE_BCOFSU"	)
	::addProperty("CIE_BPISSU", "Base Pis Suspenso"         , "number"  , "Base Pis Suspensão"  	,  "CIE_BPISSU"	)
	::addProperty("CIE_INDAUT", "Autoria da Ação Judicial"  , "string"  , "Autoria Ação Judicial"  	,  "CIE_INDAUT"	)
    ::addProperty("CIE_DTOPER", "Data da Operação"          , "date"    , "Data Operação"  			,  "CIE_DTOPER"	)
    ::addProperty("CIE_VCOF"  , "Val Cofins Escrituração"   , "number"  , "Val Cof Escrituração"  	,  "CIE_VCOF"	)
	::addProperty("CIE_VCOFSU", "Val COFINS Suspensão"      , "number"  , "Val Cof Suspensão"  		,  "CIE_VCOFSU"	)
	::addProperty("CIE_VLOPER", "Valor da Operação"         , "number"  , "Valor Operação"  		,  "CIE_VLOPER"	)
	::addProperty("CIE_VPIS"  , "Valor do PIS Escrituração" , "number"  , "Valor Pis Escrituração"  ,  "CIE_VPIS"	)
	::addProperty("CIE_VPISSU", "Valor PIS Suspensão"       , "number"  , "Val Pis Suspensão"  		,  "CIE_VPISSU"	)
	::addProperty("CIE_IDITEM", "Id Item do Processo"       , "string"  , "Id Item Processo"  		,  "CIE_IDITEM"	)
    ::addProperty("CIE_PART"  , "Código do Participante"    , "string"  , "Cod. Participante"  		,  "CIE_PART"	)
	::addProperty("CIE_CODCOF", "Código Receita COFINS"     , "string"  , "Cod Receita Cof"  		,  "CIE_CODCOF"	)
	::addProperty("CIE_CODPIS", "Código de Receita do PIS"  , "string"  , "Cod Receita PIS"  		,  "CIE_CODPIS"	)
	::addProperty("CIE_NATJU" , "Natureza do Processo"      , "string"  , "Natureza Processo"  		,  "CIE_NATJU"	)
	::addProperty("CIE_PER"   , "Período de apuração"       , "date"    , "Período apuração"  		,  "CIE_PER"	)
    ::addProperty("CIE_CHVCL1", "Chave Regime Caixa"        , "string"  , "Chave Regime Caixa"  	,  "CIE_CHVCL1"	)
	
return ::oSchema

