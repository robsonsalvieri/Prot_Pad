#INCLUDE "tlpp-core.th"
#INCLUDE "tlpp-rest.th"
#INCLUDE "totvs.ch"
#INCLUDE "FISA318.ch"

/*-------------------------------------------------------------
{Protheus.doc} GET MTApurCalcICMSFilter
API com retorno de informações para o gráfico de Apuração de ICMS e Ajustes de Apuração de ICMS

@author Gabriela Luche
@parâmetros de entrada do endpoint
    branches: Filiais
    periodStart: Data Inicial
    periodEnd: Data Final

@since 23/04/2025
--------------------------------------------------------------*/
@get(endpoint='/api/fiscal/tax-monitor/v1/icms/calculation', description='Retorna os valores mensais de credito debito e apuracao para preenchimento do card de apuracao de ICMS')

Function MTApurCalcICMSFilter()
Local oJsResponse         as json
Local cBranches        := oRest:getQueryRequest()['branches'] as character
Local cPeriodStart     := oRest:getQueryRequest()['periodStart']  as character
Local cPeriodEnd       := oRest:getQueryRequest()['periodEnd']  as character

//--------------------------------
// Verifica os parâmetro de entrada da API
//--------------------------------	
If !Empty(cBranches) .and. !Empty(cPeriodStart) .and. !Empty(cPeriodEnd)
    oJsResponse := ApurCalcICMSFilter(cBranches, cPeriodStart, cPeriodEnd)
ElseIf Empty(cBranches)
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0069  //"O parâmetro 'branches' é obrigatório e não foi informado."
    oJsResponse['detailedMessage']  := STR0070 //"Informar Código de Filiais separadas por vírgula."
    oRest:setStatusCode(400)
ElseIf Empty(cPeriodStart)
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0071  //"Nenhuma Data foi informada no parâmetro 'periodStart'."
    oJsResponse['detailedMessage']  := STR0072  //"Informar a data desejada para o período"
    oRest:setStatusCode(400)
Else
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0073  //"Nenhuma Data foi informada no parâmetro 'periodEnd'."
    oJsResponse['detailedMessage']  := STR0072  //"Informar a data desejada para o período"
    oRest:setStatusCode(400)
Endif  
oRest:setResponse( (oJsResponse )) 
FWFreeObj(oJsResponse)

Return 

/*-------------------------------------------------------------------
{Protheus.doc} GET ApurCalcICMSFilter
Função responsável por preencher o Json com informações do resumo de apuração de ICMS.
A funcao retorna um Json com os seguintes campos:

@author Gabriela Luche
@parâmetros de entrada da funcao
    Filiais         as character  // Filiais
    Data Inicial    as character  // Data Inicial
    Data Final      as character  // Data Final

@since 23/04/2025
-------------------------------------------------------------------*/
Static Function ApurCalcICMSFilter(cBranches as character, cPeriodStart as character, cPeriodEnd as character)

Local cAlias       := getNextAlias()            as character
Local nPos         := 0                         as numeric
Local nPageAux     := 0                         as numeric
Local nPageSize    := 10                        as numeric
Local nPage        := 1                         as numeric
Local lHasNext     := .f.                       as logical
Local oJsonResp    := JsonObject():New()        as object
Local oJParams     := oRest:getQueryRequest()   as json
Local cDbMs        := ""                        as character
//--------------------------------
// Verifica se o tipo do objeto é Json
//--------------------------------	
If valtype(oJParams) == 'J'
    If valtype( oJParams['page'] ) != 'U' .and. Val(oJParams['page']) > 0
        nPage := Val(oJParams['page'])
    EndIf
    If valtype( oJParams['pageSize'] ) != 'U' .and. Val(oJParams['pageSize']) > 0
        nPageSize := Val(oJParams['pageSize'])
    EndIf
EndIf
//--------------------------------
// Verifica o banco de dados do ambiente
//--------------------------------	
cDbMs := TcGetDb()
//--------------------------------
// Chama a função responsável por retornar a consulta da query de acordo com o tipo de banco de dados utilizado
//--------------------------------	
If "MSSQL" $ cDbMs
    GetApurCalcICMSMSSQL(@cAlias, nPage, nPageSize, cBranches, cPeriodStart, cPeriodEnd)  
ElseIf "ORACLE" $ cDbMs
    GetApurCalcICMSOracle(@cAlias, nPage, nPageSize, cBranches, cPeriodStart, cPeriodEnd)
ElseIf "POSTGRES" $ cDbMs
    GetApurCalcICMSPostgres(@cAlias, nPage, nPageSize, cBranches, cPeriodStart, cPeriodEnd)
EndIf
//--------------------------------
// Percorre todo o alias retornado pela query
//--------------------------------	
If (cAlias)->(!Eof()) 
    While (cAlias)->(!Eof())

        nPageAux++
        If nPageAux == 1
            oJsonResp["items"] := {}
        Endif

        If nPageAux <= nPageSize
            //--------------------------------	
            // Inicia o objeto Json
            //--------------------------------	        
            aAdd( oJsonResp["items"], JsonObject():New() )
            nPos++
            //--------------------------------
            // Alimenta o json com os dados retornado pela query
            //--------------------------------	               
            oJsonResp["items"][nPos]["month"]         :=   (cAlias)->MESANO
            oJsonResp["items"][nPos]["credit"]        :=   (cAlias)->TOT_ENTRADAS   
            oJsonResp["items"][nPos]["debt"]          :=   (cAlias)->TOT_SAIDAS

            If (cAlias)->IMP_RECOLHER > 0
                oJsonResp["items"][nPos]["calculation"]   :=   (cAlias)->IMP_RECOLHER
            Else
                oJsonResp["items"][nPos]["calculation"]   :=   (cAlias)->SLD_CREDOR
            EndIf            
        Else
            lHasNext := .t.
            Exit
        EndIf
        (cAlias)->(DbSkip())
    EndDo
    oJsonResp["hasNext"]        := lHasNext
Else
    oJsonResp['code']           := 200
    oJsonResp['items']          := {}
    oJsonResp['hasNext']        := lHasNext
EndIf  
//--------------------------------
// Fecha o alias
//--------------------------------	     
(cAlias)->(DBCloseArea())
Return oJsonResp:toJson()
/*--------------------------------------------------------------------
{Protheus.doc} GetApurCalcICMSMSSQL
(Responsável por executar a consulta aos campos da tabela SFT para banco de dados MSSQL)
A função retorna um alias com os seguintes campos:
    MESANO         as character  // Mes e ano
    ANO            as character  // Ano
    TOT_SAIDAS     as numeric    // Total de saidas
    TOT_ENTRADAS   as numeric    // Total de entradas
    IMP_RECOLHER   as numeric    // Imposto a recolher
    SLD_CREDOR     as numeric    // Saldo credor
@author Gabriela Luche
@parâmetros de entrada da funcao
@since 26/02/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApurCalcICMSMSSQL(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := "SELECT "
cQuery += "     DATEPART(MONTH, CONVERT(DATE, CDH_DTINI, 112)) AS MESNUM, 
cQuery += "     DATEPART(YEAR, CONVERT(DATE, CDH_DTINI, 112)) AS ANO, "
cQuery += "     LOWER(LEFT(DATENAME(MONTH, CONVERT(DATE, CDH_DTINI, 112)), 3)) + '/' + CAST(DATEPART(YEAR, CONVERT(DATE, CDH_DTINI, 112)) AS VARCHAR(4)) AS MESANO, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS TOT_SAIDAS, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS TOT_ENTRADAS, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS IMP_RECOLHER, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS SLD_CREDOR "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH.CDH_FILIAL IN (?) "
cQuery += "     AND CDH.CDH_TIPOIP = ? "
cQuery += "     AND CDH.CDH_TIPOPR = ? "
cQuery += "     AND CDH.CDH_PERIOD = ? "
cQuery += "     AND CDH.CDH_LIVRO  = ? "
cQuery += "     AND CDH.CDH_DTINI BETWEEN ? AND ? "
cQuery += "     AND CDH.D_E_L_E_T_ = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) "
cQuery += "     AND CDH2.CDH_TIPOIP = ? "
cQuery += "     AND CDH2.CDH_TIPOPR = ? "
cQuery += "     AND CDH2.CDH_PERIOD = ? "
cQuery += "     AND CDH2.CDH_LIVRO  = ? "
cQuery += "     AND CDH2.CDH_DTINI BETWEEN ? AND ? "
cQuery += "     AND CDH2.D_E_L_E_T_ = ?)
cQuery += " GROUP BY "
cQuery += "    DATEPART(YEAR, CONVERT(DATE, CDH_DTINI, 112)), "
cQuery += "    DATEPART(MONTH, CONVERT(DATE, CDH_DTINI, 112)), "
cQuery += "    LOWER(LEFT(DATENAME(MONTH, CONVERT(DATE, CDH_DTINI, 112)), 3)) + '/' + CAST(DATEPART(YEAR, CONVERT(DATE, CDH_DTINI, 112)) AS VARCHAR(4)) "
cQuery += "    ORDER BY ANO, MESNUM "
cQuery += "    OFFSET ( ? * ? ) ROWS "
cQuery += "    FETCH NEXT ? ROWS ONLY "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------
oGetIcms := FwExecStatement():New()
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetIcms:SetQuery(ChangeQuery(cQuery))
oGetIcms:setString(1, '004')
oGetIcms:SetNumeric(2, 0)
oGetIcms:setString(3, '010')
oGetIcms:SetNumeric(4, 0)
oGetIcms:setString(5, '013')
oGetIcms:SetNumeric(6, 0)
oGetIcms:setString(7, '014')
oGetIcms:SetNumeric(8, 0)
oGetIcms:setIn(9, StrTokArr(cBranches, "," ))
oGetIcms:setString(10, 'IC')
oGetIcms:setString(11, '3')
oGetIcms:setString(12, '1')
oGetIcms:SetString(13, '*')
oGetIcms:SetString(14, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(15, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(16, ' ')
oGetIcms:setIn(17, StrTokArr(cBranches, "," ))
oGetIcms:setString(18, 'IC')
oGetIcms:setString(19, '3')
oGetIcms:setString(20, '1')
oGetIcms:SetString(21, '*')
oGetIcms:SetString(22, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(23, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(24, ' ')
oGetIcms:SetUnsafe(25, cValToChar(nPage-1))
oGetIcms:SetUnsafe(26, cValToChar(nPageSize))
oGetIcms:SetUnsafe(27, cValToChar(nPageSize+1))
oGetIcms:CBASEQUERY := oGetIcms:GETFIXQUERY()
cAlias := oGetIcms:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetIcms)

Return
/*--------------------------------------------------------------------
{Protheus.doc} GetApurCalcICMSOracle
(Responsável por executar a consulta aos campos da tabela SFT para banco de dados ORACLE)
A função retorna um alias com os seguintes campos:
    MESANO         as character  // Mes e ano
    ANO            as character  // Ano
    TOT_SAIDAS     as numeric    // Total de saidas
    TOT_ENTRADAS   as numeric    // Total de entradas
    IMP_RECOLHER   as numeric    // Imposto a recolher
    SLD_CREDOR     as numeric    // Saldo credor
@author Gabriela Luche
@parâmetros de entrada da funcao
@since 26/02/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApurCalcICMSOracle(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := " SELECT "
cQuery += "     EXTRACT(MONTH FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')) AS MESNUM, "
cQuery += "     EXTRACT(YEAR FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')) AS ANO, "  
cQuery += "     LOWER(SUBSTR(TRIM(TO_CHAR(TO_DATE(CDH_DTINI, 'YYYYMMDD'), 'Month', 'NLS_DATE_LANGUAGE=PORTUGUESE')), 1, 3)) || '/' || TO_CHAR(TO_DATE(CDH_DTINI, 'YYYYMMDD'), 'YYYY') AS MESANO, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS TOT_SAIDAS, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS TOT_ENTRADAS, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS IMP_RECOLHER, "
cQuery += "     SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END) AS SLD_CREDOR "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE "
cQuery += " CDH.CDH_FILIAL IN (?)  "
cQuery += " 	  AND CDH.CDH_TIPOIP = ? "
cQuery += " 	  AND CDH.CDH_TIPOPR = ? "
cQuery += " 	  AND CDH.CDH_PERIOD = ? "
cQuery += " 	  AND CDH.CDH_LIVRO  = ? "
cQuery += " 	  AND CDH.CDH_DTINI BETWEEN ? AND ? "
cQuery += "       AND CDH.D_E_L_E_T_ = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) "
cQuery += "     AND CDH2.CDH_TIPOIP = ? "
cQuery += "     AND CDH2.CDH_TIPOPR = ? "
cQuery += "     AND CDH2.CDH_PERIOD = ? "
cQuery += "     AND CDH2.CDH_LIVRO  = ? "
cQuery += "     AND CDH2.CDH_DTINI BETWEEN ? AND ? "
cQuery += "     AND CDH2.D_E_L_E_T_ = ?)
cQuery += " GROUP BY "
cQuery += "     EXTRACT(YEAR FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')), "
cQuery += "     EXTRACT(MONTH FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')), "
cQuery += "     TO_DATE(CDH_DTINI, 'YYYYMMDD') "
cQuery += " ORDER BY "
cQuery += "     EXTRACT(YEAR FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')), EXTRACT(MONTH FROM TO_DATE(CDH_DTINI, 'YYYYMMDD')) "
cQuery += " OFFSET ( ? * ? ) ROWS FETCH NEXT ? ROWS ONLY "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------	
oGetIcms := FwExecStatement():New()
oGetIcms:SetQuery(ChangeQuery(cQuery))
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetIcms:setString(1, '004')
oGetIcms:SetNumeric(2, 0)
oGetIcms:setString(3, '010')
oGetIcms:SetNumeric(4, 0)
oGetIcms:setString(5, '013')
oGetIcms:SetNumeric(6, 0)
oGetIcms:setString(7, '014')
oGetIcms:SetNumeric(8, 0)
oGetIcms:setIn(9, StrTokArr(cBranches, "," ))
oGetIcms:setString(10, 'IC')
oGetIcms:setString(11, '3')
oGetIcms:setString(12, '1')
oGetIcms:SetString(13, '*')
oGetIcms:SetString(14, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(15, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(16, ' ')
oGetIcms:setIn(17, StrTokArr(cBranches, "," ))
oGetIcms:setString(18, 'IC')
oGetIcms:setString(19, '3')
oGetIcms:setString(20, '1')
oGetIcms:SetString(21, '*')
oGetIcms:SetString(22, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(23, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(24, ' ')
oGetIcms:SetUnsafe(25, cValToChar(nPage-1))
oGetIcms:SetUnsafe(26, cValToChar(nPageSize))
oGetIcms:SetUnsafe(27, cValToChar(nPageSize+1))
oGetIcms:CBASEQUERY := oGetIcms:GETFIXQUERY()
cAlias := oGetIcms:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetIcms)

Return
/*--------------------------------------------------------------------
{Protheus.doc} GetApurCalcICMSPostgres
(Responsável por executar a consulta aos campos da tabela SFT para banco de dados ORACLE)
A função retorna um alias com os seguintes campos:
    MESANO         as character  // Mes e ano
    ANO            as character  // Ano
    TOT_SAIDAS     as numeric    // Total de saidas
    TOT_ENTRADAS   as numeric    // Total de entradas
    IMP_RECOLHER   as numeric    // Imposto a recolher
    SLD_CREDOR     as numeric    // Saldo credor
@author Gabriela Luche
@parâmetros de entrada da funcao
@since 26/02/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApurCalcICMSPostgres(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character

cQuery := " SELECT "
cQuery += " DATE_PART('month', TO_DATE(CDH_DTINI, 'YYYYMMDD')) AS MESNUM, "
cQuery += " DATE_PART('year', TO_DATE(CDH_DTINI, 'YYYYMMDD')) AS ANO, "
cQuery += " CONCAT(LOWER(TO_CHAR(TO_DATE(CDH_DTINI, 'YYYYMMDD'), 'Mon'))::bpchar, '/', DATE_PART('year', TO_DATE(CDH_DTINI, 'YYYYMMDD'))) AS MESANO, "
cQuery +="  SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END)::FLOAT8 AS TOT_SAIDAS, "
cQuery +="  SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END)::FLOAT8 AS TOT_ENTRADAS, "
cQuery +="  SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END)::FLOAT8 AS IMP_RECOLHER, "
cQuery +="  SUM(CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE ? END)::FLOAT8 AS SLD_CREDOR "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH.CDH_FILIAL IN (?) "
cQuery += " 	  AND CDH.CDH_TIPOIP = ? "
cQuery += " 	  AND CDH.CDH_TIPOPR = ? "
cQuery += " 	  AND CDH.CDH_PERIOD = ? "
cQuery += " 	  AND CDH.CDH_LIVRO  = ? "
cQuery += " 	  AND CDH.CDH_DTINI BETWEEN ? AND ? "
cQuery += "       AND CDH.D_E_L_E_T_ = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) "
cQuery += "     AND CDH2.CDH_TIPOIP = ? "
cQuery += "     AND CDH2.CDH_TIPOPR = ? "
cQuery += "     AND CDH2.CDH_PERIOD = ? "
cQuery += "     AND CDH2.CDH_LIVRO  = ? "
cQuery += "     AND CDH2.CDH_DTINI BETWEEN ? AND ? "
cQuery += "     AND CDH2.D_E_L_E_T_ = ?)"
cQuery += " GROUP BY "
cQuery += " DATE_PART('year', TO_DATE(CDH_DTINI, 'YYYYMMDD')), "
cQuery += " DATE_PART('month', TO_DATE(CDH_DTINI, 'YYYYMMDD')), "
cQuery += " CONCAT(LOWER(TO_CHAR(TO_DATE(CDH_DTINI, 'YYYYMMDD'), 'Mon'))::bpchar, '/', DATE_PART('year', TO_DATE(CDH_DTINI, 'YYYYMMDD'))) "
cQuery += " ORDER BY ANO, MESNUM "
cQuery += " OFFSET ( ? * ? ) ROWS FETCH NEXT ? ROWS ONLY;"
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------	
oGetIcms := FwExecStatement():New()
oGetIcms:SetQuery(cQuery)
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetIcms:setString(1, '004')
oGetIcms:SetNumeric(2, 0)
oGetIcms:setString(3, '010')
oGetIcms:SetNumeric(4, 0)
oGetIcms:setString(5, '013')
oGetIcms:SetNumeric(6, 0)
oGetIcms:setString(7, '014')
oGetIcms:SetNumeric(8, 0)
oGetIcms:setIn(9, StrTokArr(cBranches, "," ))
oGetIcms:setString(10, 'IC')
oGetIcms:setString(11, '3')
oGetIcms:setString(12, '1')
oGetIcms:SetString(13, '*')
oGetIcms:SetString(14, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(15, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(16, ' ')
oGetIcms:setIn(17, StrTokArr(cBranches, "," ))
oGetIcms:setString(18, 'IC')
oGetIcms:setString(19, '3')
oGetIcms:setString(20, '1')
oGetIcms:SetString(21, '*')
oGetIcms:SetString(22, StrTran(cPeriodStart, "-", ""))
oGetIcms:setString(23, StrTran(cPeriodEnd, "-", ""))
oGetIcms:setString(24, ' ')
oGetIcms:SetUnsafe(25, cValToChar(nPage-1))
oGetIcms:SetUnsafe(26, cValToChar(nPageSize))
oGetIcms:SetUnsafe(27, cValToChar(nPageSize+1))
oGetIcms:CBASEQUERY := oGetIcms:GETFIXQUERY()
cAlias := oGetIcms:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetIcms)

Return

/*-------------------------------------------------------------
{Protheus.doc} GET MTAjustApurICMSFilter 
API de Ajustes da Apuração de ICMS por parâmetros.
@author Evandro Italo
@parâmetros de entrada do endpoint
@since 29/04/2025 
--------------------------------------------------------------*/
@get(endpoint='/api/fiscal/tax-monitor/v1/icms/calculation-adjustments', description='API de Ajustes de apuracao de ICMS')
Function MTAjustApurICMSFilter()
Local oJsResponse         as json
Local cBranches        := oRest:getQueryRequest()['branches'] as character
Local cPeriodStart     := oRest:getQueryRequest()['periodStart']  as character
Local cPeriodEnd       := oRest:getQueryRequest()['periodEnd']  as character

//--------------------------------
// Verifica os parâmetro de entrada da API
//--------------------------------	
If !Empty(cBranches) .and. !Empty(cPeriodStart) .and. !Empty(cPeriodEnd)
    oJsResponse := AdjustmentApurICMSFilter(cBranches, cPeriodStart, cPeriodEnd)
ElseIf Empty(cBranches)
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0069  //"O parâmetro 'branches' é obrigatório e não foi informado."
    oJsResponse['detailedMessage']  := STR0070 //"Informar Código de Filiais separadas por vírgula."
    oRest:setStatusCode(400)
ElseIf Empty(cPeriodStart)
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0071  //"Nenhuma Data foi informada no parâmetro 'periodStart'."
    oJsResponse['detailedMessage']  := STR0072  //"Informar a data desejada para o período"
    oRest:setStatusCode(400)
Else
    oJsResponse := JsonObject():new()
    oJsResponse['code']             := 400
    oJsResponse['message']          := STR0073  //"Nenhuma Data foi informada no parâmetro 'periodEnd'."
    oJsResponse['detailedMessage']  := STR0072  //"Informar a data desejada para o período"
    oRest:setStatusCode(400)
Endif  
oRest:setResponse( (oJsResponse )) 
FWFreeObj(oJsResponse)

Return 

/*-------------------------------------------------------------------
{Protheus.doc} GET AdjustmentApurICMSFilter
Função responsável por preencher o Json com com informações referentes aos ajustes da apuração de ICMS
@author Evandro Italo
@parâmetros de entrada do endpoint
@since 29/04/2025
-------------------------------------------------------------------*/
Static Function AdjustmentApurICMSFilter(cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local nPos         := 0                         as numeric
Local nPageAux     := 0                         as numeric
Local nPageSize    := 10                        as numeric
Local nPos2        := 0                         as numeric
Local nMes         := 0                         as numeric
Local nAno         := 0                         as numeric
Local lHasNext     := .f.                       as logical
Local nPage        := 1                         as numeric
Local oJsonResp    := JsonObject():New()        as object
Local cAlias       := getNextAlias()            as character // Alias para a consulta dos valores de ajuste
Local cAlias2      := getNextAlias()            as character // Alias para a consulta dos valores totais de ajuste
Local oJParams     := oRest:getQueryRequest()   as json //Json com os parâmetros (query param)    
Local cDbMs        := ""                        as character

If valtype(oJParams) == 'J'
    If valtype( oJParams['page'] ) != 'U' .and. Val(oJParams['page']) > 0
        nPage := Val(oJParams['page'])
    EndIf
    If valtype( oJParams['pageSize'] ) != 'U' .and. Val(oJParams['pageSize']) > 0
        nPageSize := Val(oJParams['pageSize'])
    EndIf
EndIf

cDbMs := TcGetDb()

If "MSSQL" $ cDbMs
    GetAjusteApuraICMSMSSQL(@cAlias,nPage,nPageSize,cBranches, cPeriodStart, cPeriodEnd)
ElseIf "ORACLE" $ cDbMs
    GetAjusteApuraICMSORACLE(@cAlias,nPage,nPageSize,cBranches, cPeriodStart, cPeriodEnd)
ElseIf "POSTGRES" $ cDbMs
    GetAjusteApuraICMSPOSTGRES(@cAlias,nPage,nPageSize,cBranches, cPeriodStart, cPeriodEnd)
EndIf

// Iniciando o While
If (cAlias)->(!Eof())
    While (cAlias)->(!Eof())
        nPageAux++
        If nPageAux == 1
            oJsonResp["items"] := {}
        Endif
        If nPageAux <= nPageSize
            aAdd( oJsonResp["items"], JsonObject():New() )
            nPos++
            oJsonResp["items"][nPos]["period"]              :=   AllTrim((cAlias)->MESANO)
            oJsonResp["items"][nPos]["credit"]              :=   (cAlias)->AJUSTCRED     
            oJsonResp["items"][nPos]["debit"]                :=   (cAlias)->AJUSTDEBT
            oJsonResp["items"][nPos]["deduction"]           :=   (cAlias)->DEDUCOES
            
            nMes:= (cAlias)->MESNUMERO
            nAno:= (cAlias)->ANONUMERO
            // Verifica o banco de dados do ambiente e executa a query para retornar os totais de ajuste
            If "MSSQL" $ cDbMs
                GetAjusteApuraICMSTotalMSSQL(@cAlias2,nPage,cBranches, cPeriodStart, cPeriodEnd, nMEs, nAno)
            ElseIf "ORACLE" $ cDbMs
                GetAjusteApuraICMSTotalORACLE(@cAlias2,nPage,cBranches, cPeriodStart, cPeriodEnd, nMEs, nAno)
            ElseIf "POSTGRES" $ cDbMs
                GetAjusteApuraICMSTotalPOSTGRES(@cAlias2,nPage,cBranches, cPeriodStart, cPeriodEnd, nMEs, nAno)
            EndIf

            oJsonResp["items"][nPos]["detail"] := {}
            nPos2 := 0 
            While (cAlias2)->(!Eof())
                //Alimenta o Json com os dados retornados pela query com os totais de ajuste
                nPos2++
                Aadd(oJsonResp["items"][nPos]["detail"], JsonObject():New() )
                oJsonResp["items"][nPos]["detail"][nPos2]["branch"]        :=  AllTrim((cAlias2)->FILIAL)
                oJsonResp["items"][nPos]["detail"][nPos2]["credit"]        :=   (cAlias2)->AJUSTECRED     
                oJsonResp["items"][nPos]["detail"][nPos2]["debit"]          :=   (cAlias2)->AJUSTEDEBT
                oJsonResp["items"][nPos]["detail"][nPos2]["deduction"]     :=   (cAlias2)->DEDUCOES

                (cAlias2)->(DbSkip())
            EndDo
        Else
            lHasNext := .t.
            Exit
        EndIf
        (cAlias)->(DbSkip())
    EndDo
oJsonResp["hasNext"]    := lHasNext
Else
    oJsonResp['code']       := 200
    oJsonResp["items"]      := {}
    oJsonResp["hasNext"]    := lHasNext
EndIf       

(cAlias)->(DBCloseArea())

Return oJsonResp:toJson()
/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSMSSQL()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSMSSQL(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := "SELECT DISTINCT (CDH.MESNOME) AS MESANO, SUM(CDH.VALORCRED) AS AJUSTCRED, SUM(CDH.VALORDEBT) AS AJUSTDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, CDH.MESNUM AS MESNUMERO, CDH.ANONUM AS ANONUMERO "
cQuery += "FROM ("
cQuery += " SELECT CDH_FILIAL AS FILIAL, MONTH(CDH_DTINI) AS MESNUM, YEAR(CDH_DTINI) AS ANONUM, "
cQuery += " CASE "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jan/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'fev/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'mar/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'abr/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'mai/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jun/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jul/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'ago/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'set/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'out/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'nov/' + LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'dez/' + LEFT(CDH_DTINI,4) "
cQuery +="ELSE ? END as MESNOME,   "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORDEBT,"
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND CDH_DTINI BETWEEN ? AND ? AND CDH_LINHA IN (?) "
cQuery +="AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery +="AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2"
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?) "
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, RIGHT(CDH_DTINI,4), LEFT(CDH_DTINI,4), CDH_VALOR, CDH_LINHA, MONTH(CDH_DTINI), YEAR(CDH_DTINI)) AS CDH  "
cQuery += " GROUP BY CDH.MESNOME, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY CDH.ANONUM, CDH.MESNUM"
cQuery += " OFFSET ( ? * ? ) ROWS "
cQuery += " FETCH NEXT ? ROWS ONLY "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------
oGetAjustApurICMS := FwExecStatement():New()
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetAjustApurICMS:SetQuery(ChangeQuery(cQuery))
oGetAjustApurICMS:setString(1, "0101")
oGetAjustApurICMS:setString(2, "0201")
oGetAjustApurICMS:setString(3, "0301")
oGetAjustApurICMS:setString(4, "0401")
oGetAjustApurICMS:setString(5, "0501")
oGetAjustApurICMS:setString(6, "0601")
oGetAjustApurICMS:setString(7, "0701")
oGetAjustApurICMS:setString(8, "0801")
oGetAjustApurICMS:setString(9, "0901")
oGetAjustApurICMS:setString(10,"1001")
oGetAjustApurICMS:setString(11,"1101")
oGetAjustApurICMS:setString(12,"1201")
oGetAjustApurICMS:setString(13, "")
oGetAjustApurICMS:SetIn(14, {'002','003'})
oGetAjustApurICMS:SetIn(15, {'006','007'})
oGetAjustApurICMS:setString(16, "012")
oGetAjustApurICMS:SetIn(17, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(18, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(19, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(20, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(21, ' ')
oGetAjustApurICMS:setString(22, "IC")
oGetAjustApurICMS:SetNumeric(23, 0)
oGetAjustApurICMS:setString(24, "")
oGetAjustApurICMS:SetIn(25, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(26, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(27, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(28, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(29, ' ')
oGetAjustApurICMS:setString(30, "IC")
oGetAjustApurICMS:SetNumeric(31, 0)
oGetAjustApurICMS:setString(32, "")
oGetAjustApurICMS:SetUnsafe(33, cValToChar(nPage-1))
oGetAjustApurICMS:SetUnsafe(34, cValToChar(nPageSize))
oGetAjustApurICMS:SetUnsafe(35, cValToChar(nPageSize+1))
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias := oGetAjustApurICMS:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)

Return 
/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSORACLE()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSORACLE(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := "SELECT DISTINCT (CDH.MESNOME) AS MESANO, SUM(CDH.VALORCRED) AS AJUSTCRED, SUM(CDH.VALORDEBT) AS AJUSTDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, TO_NUMBER(CDH.MESNUM) AS MESNUMERO, TO_NUMBER(CDH.ANONUM) AS ANONUMERO "
cQuery += "FROM ("
cQuery += " SELECT CDH_FILIAL AS FILIAL, TO_CHAR(CAST(CDH_DTINI AS DATE), 'MM') AS MESNUM, TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYY') AS ANONUM, "
cQuery += " CASE "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'jan/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'fev/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'mar/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'abr/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'mai/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'jun/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'jul/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'ago/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'set/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'out/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'nov/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="WHEN SUBSTR(CDH_DTINI,5,2) = ? THEN 'dez/' || SUBSTR(CDH_DTINI,1,4) "
cQuery +="ELSE ? END AS MESNOME,   "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN SUM(CDH_VALOR) ELSE 0 END  AS VALORDEBT,"
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN SUM(CDH_VALOR) ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN SUM(CDH_VALOR) ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYYMMDD')  BETWEEN ? AND ? AND CDH_LINHA IN (?) "
cQuery +="AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery +="AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2"
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?) "
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, SUBSTR(CDH_DTINI,5,2), SUBSTR(CDH_DTINI,1,4), CDH_VALOR, CDH_LINHA, TO_CHAR(CAST(CDH_DTINI AS DATE), 'MM'), TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYY')) CDH  "
cQuery += " GROUP BY CDH.MESNOME, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY CDH.ANONUM, CDH.MESNUM"
cQuery += " OFFSET ( ? * ? ) ROWS "
cQuery += " FETCH NEXT ? ROWS ONLY "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------	
oGetAjustApurICMS := FwExecStatement():New()
oGetAjustApurICMS:SetQuery(ChangeQuery(cQuery))
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetAjustApurICMS:setString(1, "01")
oGetAjustApurICMS:setString(2, "02")
oGetAjustApurICMS:setString(3, "03")
oGetAjustApurICMS:setString(4, "04")
oGetAjustApurICMS:setString(5, "05")
oGetAjustApurICMS:setString(6, "06")
oGetAjustApurICMS:setString(7, "07")
oGetAjustApurICMS:setString(8, "08")
oGetAjustApurICMS:setString(9, "09")
oGetAjustApurICMS:setString(10,"10")
oGetAjustApurICMS:setString(11,"11")
oGetAjustApurICMS:setString(12,"12")
oGetAjustApurICMS:setString(13, "")
oGetAjustApurICMS:SetIn(14, {'002','003'})
oGetAjustApurICMS:SetIn(15, {'006','007'})
oGetAjustApurICMS:setString(16, "012")
oGetAjustApurICMS:SetIn(17, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(18, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(19, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(20, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(21, ' ')
oGetAjustApurICMS:setString(22, "IC")
oGetAjustApurICMS:SetNumeric(23, 0)
oGetAjustApurICMS:setString(24, "")
oGetAjustApurICMS:SetIn(25, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(26, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(27, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(28, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(29, ' ')
oGetAjustApurICMS:setString(30, "IC")
oGetAjustApurICMS:SetNumeric(31, 0)
oGetAjustApurICMS:setString(32, "")
oGetAjustApurICMS:SetUnsafe(33, cValToChar(nPage-1))
oGetAjustApurICMS:SetUnsafe(34, cValToChar(nPageSize))
oGetAjustApurICMS:SetUnsafe(35, cValToChar(nPageSize+1))
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias := oGetAjustApurICMS:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)

Return 

/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSPOSTGRES()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSPOSTGRES(cAlias as character, nPage as numeric, nPageSize as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character)
Local cQuery    := ''  as character

cQuery := "SELECT DISTINCT (CDH.MESNOME) AS MESANO, SUM(CDH.VALORCRED) AS AJUSTCRED, SUM(CDH.VALORDEBT) AS AJUSTDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, TO_NUMBER(CDH.MESNUM,'99') AS MESNUMERO, TO_NUMBER(CDH.ANONUM,'9999') AS ANONUMERO "
cQuery += "FROM ("
cQuery += " SELECT CDH_FILIAL AS FILIAL, TO_CHAR(CDH_DTINI:: DATE, 'MM') AS MESNUM, TO_CHAR(CDH_DTINI:: DATE, 'YYYY') AS ANONUM, "
cQuery += " CASE "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jan/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'fev/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'mar/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'abr/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'mai/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jun/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'jul/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'ago/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'set/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'out/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'nov/' || LEFT(CDH_DTINI,4) "
cQuery +="WHEN RIGHT(CDH_DTINI,4) = ? THEN 'dez/' || LEFT(CDH_DTINI,4) "
cQuery +="ELSE ? END as MESNOME,  "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN SUM(CDH_VALOR) ELSE 0 END  AS VALORDEBT,"
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN SUM(CDH_VALOR) ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN SUM(CDH_VALOR) ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND CDH_DTINI BETWEEN ? AND ? AND CDH_LINHA IN (?) "
cQuery +="AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery +="AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2"
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?) "
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, CDH_VALOR, CDH_LINHA, RIGHT(CDH_DTINI,4), LEFT(CDH_DTINI,4), CDH_LINHA, TO_CHAR(CDH_DTINI:: DATE, 'MM'), TO_CHAR(CDH_DTINI:: DATE, 'YYYY')) AS CDH  "
cQuery += " GROUP BY CDH.MESNOME, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY TO_NUMBER(CDH.ANONUM,'9999'), TO_NUMBER(CDH.MESNUM,'99')"
cQuery += " OFFSET ( ? * ? ) ROWS "
cQuery += " FETCH NEXT ? ROWS ONLY "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------	    
oGetAjustApurICMS := FwExecStatement():New()
oGetAjustApurICMS:SetQuery(cQuery)
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetAjustApurICMS:setString(1, "0101")
oGetAjustApurICMS:setString(2, "0201")
oGetAjustApurICMS:setString(3, "0301")
oGetAjustApurICMS:setString(4, "0401")
oGetAjustApurICMS:setString(5, "0501")
oGetAjustApurICMS:setString(6, "0601")
oGetAjustApurICMS:setString(7, "0701")
oGetAjustApurICMS:setString(8, "0801")
oGetAjustApurICMS:setString(9, "0901")
oGetAjustApurICMS:setString(10,"1001")
oGetAjustApurICMS:setString(11,"1101")
oGetAjustApurICMS:setString(12,"1201")
oGetAjustApurICMS:setString(13, "")
oGetAjustApurICMS:SetIn(14, {'002','003'})
oGetAjustApurICMS:SetIn(15, {'006','007'})
oGetAjustApurICMS:setString(16, "012")
oGetAjustApurICMS:SetIn(17, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(18, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(19, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(20, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(21, ' ')
oGetAjustApurICMS:setString(22, "IC")
oGetAjustApurICMS:SetNumeric(23, 0)
oGetAjustApurICMS:setString(24, "")
oGetAjustApurICMS:SetIn(25, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(26, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(27, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(28, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(29, ' ')
oGetAjustApurICMS:setString(30, "IC")
oGetAjustApurICMS:SetNumeric(31, 0)
oGetAjustApurICMS:setString(32, "")
oGetAjustApurICMS:SetUnsafe(33, cValToChar(nPage-1))
oGetAjustApurICMS:SetUnsafe(34, cValToChar(nPageSize))
oGetAjustApurICMS:SetUnsafe(35, cValToChar(nPageSize+1))
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias := oGetAjustApurICMS:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)

Return 
/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSTotalMSSQL()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSTotalMSSQL(cAlias2 as character, nPage as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character, nMes as numeric, nAno as numeric)
Local cQuery    := ''  as character

cQuery := "SELECT DISTINCT (CDH.FILIAL) AS FILIAL, "
cQuery += "SUM(CDH.VALORCRED) AS AJUSTECRED , SUM(CDH.VALORDEBT) AS AJUSTEDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, CDH.MESNUM AS MESNUMERO, CDH.ANONUM AS ANONUMERO"
cQuery += " FROM (SELECT RIGHT(CDH_DTINI,4) AS MES, LEFT(CDH_DTINI,4) AS ANO, CDH_LINHA, MONTH(CDH_DTINI) AS MESNUM, YEAR(CDH_DTINI) AS ANONUM, CDH_FILIAL AS FILIAL, "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORDEBT,"
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND CDH_DTINI BETWEEN ? AND ? AND CDH_LINHA IN (?)"
cQuery +="AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery +="AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?)"
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, RIGHT(CDH_DTINI,4), LEFT(CDH_DTINI,4), CDH_VALOR, CDH_LINHA, MONTH(CDH_DTINI), YEAR(CDH_DTINI)) AS CDH WHERE CDH.MESNUM = ? AND CDH.ANONUM = ?  "
cQuery += " GROUP BY CDH.FILIAL, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY CDH.ANONUM, CDH.MESNUM"
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------    
oGetAjustApurICMS := FwExecStatement():New()
//--------------------------------
// Montagem dos Binds
//--------------------------------	    
oGetAjustApurICMS:SetQuery(ChangeQuery(cQuery))
oGetAjustApurICMS:SetIn(1, {'002','003'})
oGetAjustApurICMS:SetIn(2, {'006','007'})
OGetAjustApurICMS:setString(3, "012")
oGetAjustApurICMS:SetIn(4, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(5, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(6, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(7, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(8, ' ')
oGetAjustApurICMS:setString(9, "IC")
oGetAjustApurICMS:SetNumeric(10, 0)
oGetAjustApurICMS:setString(11, "")
oGetAjustApurICMS:SetIn(12, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(13, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(14, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(15, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(16, ' ')
oGetAjustApurICMS:setString(17, "IC")
oGetAjustApurICMS:SetNumeric(18, 0)
oGetAjustApurICMS:setString(19, "")
oGetAjustApurICMS:SetNumeric(20, nMes)
oGetAjustApurICMS:SetNumeric(21, nAno)
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias2 := oGetAjustApurICMS:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)
Return 

/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSTotalORACLE()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSTotalORACLE(cAlias2 as character, nPage as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character, nMes as numeric, nAno as numeric)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := "SELECT DISTINCT (CDH.FILIAL) AS FILIAL, "
cQuery += "SUM(CDH.VALORCRED) AS AJUSTECRED , SUM(CDH.VALORDEBT) AS AJUSTEDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, TO_NUMBER(CDH.MESNUM) AS MESNUMERO, TO_NUMBER(CDH.ANONUM) AS ANONUMERO"
cQuery += " FROM (SELECT SUBSTR(CDH_DTINI,5,2) AS MES, SUBSTR(CDH_DTINI,1,4) AS ANO, TO_CHAR(CAST(CDH_DTINI AS DATE), 'MM') AS MESNUM, TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYY') AS ANONUM, CDH_FILIAL AS FILIAL, "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORDEBT, "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYYMMDD')  BETWEEN ? AND ? AND CDH_LINHA IN (?)"
cQuery += " AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery += " AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?)"
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, SUBSTR(CDH_DTINI,5,2), SUBSTR(CDH_DTINI,1,4), CDH_VALOR, CDH_LINHA, TO_CHAR(CAST(CDH_DTINI AS DATE), 'MM'), TO_CHAR(CAST(CDH_DTINI AS DATE), 'YYYY')) CDH WHERE TO_NUMBER(CDH.MESNUM) = ? AND TO_NUMBER(CDH.ANONUM) = ?  "
cQuery += " GROUP BY CDH.FILIAL, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY CDH.ANONUM, CDH.MESNUM"
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------
oGetAjustApurICMS := FwExecStatement():New()
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetAjustApurICMS:SetQuery(ChangeQuery(cQuery))
oGetAjustApurICMS:SetIn(1, {'002','003'})
oGetAjustApurICMS:SetIn(2, {'006','007'})
oGetAjustApurICMS:setString(3, "012")
oGetAjustApurICMS:SetIn(4, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(5, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(6, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(7, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(8, ' ')
oGetAjustApurICMS:setString(9, "IC")
oGetAjustApurICMS:SetNumeric(10, 0)
oGetAjustApurICMS:setString(11, "")
oGetAjustApurICMS:SetIn(12, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(13, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(14, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(15, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(16, ' ')
oGetAjustApurICMS:setString(17, "IC")
oGetAjustApurICMS:SetNumeric(18, 0)
oGetAjustApurICMS:setString(19, "")
oGetAjustApurICMS:SetNumeric(20, nMes)
oGetAjustApurICMS:SetNumeric(21, nAno)
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias2 := oGetAjustApurICMS:OpenAlias()

//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)

Return 
/*--------------------------------------------------------------------
{Protheus.doc} GetAjusteApuraICMSTotalPOSTGRES()
(Responsável por executar a consulta aos campos da tabela CDH)
@author Evandro Italo
@since 29/04/2025
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetAjusteApuraICMSTotalPOSTGRES(cAlias2 as character, nPage as numeric, cBranches as character, cPeriodStart as character, cPeriodEnd as character, nMes as numeric, nAno as numeric)
Local cQuery    := ''  as character
//--------------------------------
// Montagem da query
//--------------------------------	
cQuery := "SELECT DISTINCT (CDH.FILIAL) AS FILIAL, "
cQuery += "SUM(CDH.VALORCRED) AS AJUSTECRED , SUM(CDH.VALORDEBT) AS AJUSTEDEBT, SUM(CDH.DEDUCOES) AS DEDUCOES, TO_NUMBER(CDH.MESNUM,'99') AS MESNUMERO, TO_NUMBER(CDH.ANONUM,'9999') AS ANONUMERO"
cQuery += " FROM (SELECT RIGHT(CDH_DTINI,4) AS MES, LEFT(CDH_DTINI,4) AS ANO, TO_CHAR(CDH_DTINI:: DATE, 'MM') AS MESNUM, TO_CHAR(CDH_DTINI:: DATE, 'YYYY') AS ANONUM, CDH_FILIAL AS FILIAL, "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORDEBT, "
cQuery += " CASE WHEN CDH_LINHA IN (?) THEN CDH_VALOR ELSE 0 END  AS VALORCRED, "
cQuery += " CASE WHEN CDH_LINHA = ? THEN CDH_VALOR ELSE 0 END  AS DEDUCOES "
cQuery += " FROM "+RetSQLName("CDH")+" CDH "
cQuery += " WHERE CDH_FILIAL IN (?) AND CDH_DTINI BETWEEN ? AND ? AND CDH_LINHA IN (?) "
cQuery +="AND D_E_L_E_T_ = ? AND CDH_TIPOIP = ? "
cQuery +="AND CDH_VALOR > ? AND CDH_CODLAN = ? AND CDH_SEQUEN = (SELECT MAX(CDH2.CDH_SEQUEN) FROM "+RetSQLName("CDH")+" CDH2 "
cQuery += " WHERE CDH2.CDH_FILIAL IN (?) AND CDH2.CDH_DTINI BETWEEN ? AND ? AND CDH2.CDH_LINHA IN (?)"
cQuery +="AND CDH2.D_E_L_E_T_ = ? AND CDH2.CDH_TIPOIP = ? "
cQuery +="AND CDH2.CDH_VALOR > ? AND CDH2.CDH_CODLAN = ?) "
cQuery += " GROUP BY CDH_FILIAL, CDH_VALOR, CDH_LINHA, RIGHT(CDH_DTINI,4), LEFT(CDH_DTINI,4), CDH_LINHA, TO_CHAR(CDH_DTINI:: DATE, 'MM'), TO_CHAR(CDH_DTINI:: DATE, 'YYYY')) AS CDH WHERE TO_NUMBER(CDH.MESNUM,'99') = ? AND TO_NUMBER(CDH.ANONUM,'9999') = ?  "
cQuery += " GROUP BY CDH.FILIAL, CDH.MESNUM, CDH.ANONUM"
cQuery += " ORDER BY TO_NUMBER(CDH.ANONUM,'9999'), TO_NUMBER(CDH.MESNUM,'99') "
//--------------------------------
// Executa a criação da área de acordo com a query
//--------------------------------
oGetAjustApurICMS := FwExecStatement():New()
//--------------------------------
// Montagem dos Binds
//--------------------------------	
oGetAjustApurICMS:SetQuery(ChangeQuery(cQuery))
oGetAjustApurICMS:SetIn(1, {'002','003'})
oGetAjustApurICMS:SetIn(2, {'006','007'})
oGetAjustApurICMS:setString(3, "012")
oGetAjustApurICMS:SetIn(4, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(5, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(6, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(7, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(8, ' ')
oGetAjustApurICMS:setString(9, "IC")
oGetAjustApurICMS:SetNumeric(10, 0)
oGetAjustApurICMS:setString(11, "")
oGetAjustApurICMS:SetIn(12, StrTokArr(cBranches, "," ))
oGetAjustApurICMS:setString(13, StrTran(cPeriodStart, "-", ""))
oGetAjustApurICMS:setString(14, StrTran(cPeriodEnd, "-", ""))
oGetAjustApurICMS:SetIn(15, {'002','006','012','003','007'})
oGetAjustApurICMS:setString(16, ' ')
oGetAjustApurICMS:setString(17, "IC")
oGetAjustApurICMS:SetNumeric(18, 0)
oGetAjustApurICMS:setString(19, "")
oGetAjustApurICMS:SetNumeric(20, nMes)
oGetAjustApurICMS:SetNumeric(21, nAno)
oGetAjustApurICMS:CBASEQUERY := oGetAjustApurICMS:GETFIXQUERY()
cAlias2 := oGetAjustApurICMS:OpenAlias()
//--------------------------------
// Libera o objeto
//--------------------------------
FWFreeObj(oGetAjustApurICMS)

Return
