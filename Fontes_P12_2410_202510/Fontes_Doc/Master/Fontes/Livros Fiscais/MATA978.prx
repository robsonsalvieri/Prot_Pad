#INCLUDE "PROTHEUS.CH"
#INCLUDE "TOPCONN.CH"
#INCLUDE "MATA978.CH"
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณMATA978   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณDCTF, Declaracao de Debitos e Creditos Tributarios Federais                                     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณImpostos tratados: IRRF, IRPJ, IPI, IOF, CPMF, PIS, COFINS, CSLL, CIDE. Estes impostos sao iden-บฑฑ
ฑฑบ          ณ tificados atraves de Naturezas, conforme documentacao da rotina.                               บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณNenhum                                                                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณ MATR978 atraves do Menu                                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function MATA978 (lautomato,aWizard)
Local	lRet		:=	.T.
Local	aArea		:=	GetArea ()
Local	aRegra		:=	{}
Local	aStrCmps	:=	{}
Local	cMV_DCTFCDG	:= SuperGetMv("MV_DCTFCDG",.F.,"") //CDG - Caminho Da Gravacao
Local	nI			:=	0
Local	cPerg		:=	"DCTF"
Local	aTitulo		:=	{}
Local	nArqVal		:=	0
Local	cFile		:=	""
Local  cNomWiz     := "DCTF" + FWGrpCompany() + FWGETCODFILIAL
Local   lVerpesssen := Iif(FindFunction("Verpesssen"),Verpesssen(),.T.)

Private lEnd		:=.F.

//Naturezas
Private	cMV_IRPJ	:=	SetVar("MV_IRPJ")
Private	cMV_IOF		:=	SetVar("MV_IOF")
Private	cMV_CPMF	:=	SetVar("MV_CPMF")
Private	cMV_CIDE	:=	SetVar("MV_CIDE")
Private	cMV_UNIAO	:=	SuperGetMv("MV_UNIAO")
Private	cMV_RETPAT	:=	SetVar("MV_RETPAT")
Private	cMV_COSIRF	:=	SetVar("MV_COSIRF")
Private	cMV_CSRF	:=	SetVar("MV_CSRF")
Private	cMV_CPSSS	:=	SetVar("MV_CPSSS")
Private cMV_IRRF	:=	""
Private	cMV_PIS		:=	""
Private	cMV_CSLL	:=	""
Private	cMV_COFINS	:=	""
Private	cMV_IPI		:=	""
//Codigos de receita
Private	cMV_M978RP	:=	SetVar("MV_M978RP")
Private	cMV_M978CSR	:=	SetVar("MV_M978CSR")
Private	cMV_M978COS	:=	SetVar("MV_M978COS")
Private	cMV_M978CPS	:=	SetVar("MV_M978CPS")
Private	cMV_RECTRIM	:=	SuperGetMv("MV_RECTRIM",.F.," ")  //Receitas trimestrais
Private cMVRFB2137  := GetNewPar ("MV_DCTFEXC","")

//Compatibiliza็ใo com automa็ใo de testes.	
Default lautomato	:=	.F.
Default aWizard		:=	{}

If Empty(cMV_RECTRIM)
	cMV_RECTRIM	:= "''" //Montado dessa forma para nใo causar erro na query
EndIf

If Empty(cMVRFB2137)
	cMVRFB2137	:= "''" //Montado dessa forma para nใo causar erro na query
EndIf


If lVerpesssen .And. Pergunte(cPerg,iif(!lautomato,.T.,.F.))
	If MV_PAR01==2
	
		//Naturezas
		#IFDEF TOP
		    If TcSrvType()<>"AS/400"
				//Para ambiente TOP quando concatenar 2 parametros, devo colocar uma virgula entre eles.

				cMV_IRRF	:=	SetVar("MV_IRF")+Iif(Empty(SetVar("MV_IRF2")),"", ","+SetVar("MV_IRF2"))
				If Empty(SetVar("MV_PISNAT"))
				    cMV_PIS	:= SetVar("MV_PISNAT2")
				Else
				    cMV_PIS		:=	SetVar("MV_PISNAT")+Iif(Empty(SetVar("MV_PISNAT2")),"", ","+SetVar("MV_PISNAT2"))
				EndIf
				cMV_CSLL	:=	SetVar("MV_CSLL")+Iif(Empty(SetVar("MV_CSLL2")),"", ","+SetVar("MV_CSLL2"))
				cMV_COFINS	:=	SetVar("MV_COFINS")+Iif(Empty(SetVar("MV_COFINS2")),"", ","+SetVar("MV_COFINS2"))
				cMV_IPI		:=	SetVar("MV_IPI")+Iif(Empty(SetVar("MV_IPI2")),"", ","+SetVar("MV_IPI2"))
				cMV_CIDE		:=	SetVar("MV_CIDE")+Iif(Empty(SetVar("MV_CIDE2")),"", ","+SetVar("MV_CIDE2"))
				
				//Quando alguns parametros particular da DCTF estiverem em branco, devo inserir como conteudo '' para padronizar na query.

				cMV_IRPJ	:=	Iif(Empty(cMV_IRPJ), "''", cMV_IRPJ)
				cMV_IOF		:=	Iif(Empty(cMV_IOF), "''", cMV_IOF)
				cMV_CPMF	:=	Iif(Empty(cMV_CPMF), "''", cMV_CPMF)
				cMV_CIDE	:=	Iif(Empty(cMV_CIDE), "''", cMV_CIDE)
				cMV_RETPAT	:=	Iif(Empty(cMV_RETPAT), "''", cMV_RETPAT)
				cMV_COSIRF	:=	Iif(Empty(cMV_COSIRF), "''", cMV_COSIRF)
				cMV_CSRF	:=	Iif(Empty(cMV_CSRF), "''", cMV_CSRF)
				cMV_CPSSS	:=	Iif(Empty(cMV_CPSSS), "''", cMV_CPSSS)
				cMV_IPI	:=	Iif(Empty(cMV_IPI), "''", cMV_IPI)
				cMV_CSLL	:=	Iif(Empty(cMV_CSLL), "''", cMV_CSLL)
				cMV_IRRF	:=	Iif(Empty(cMV_IRRF), "''", cMV_IRRF)
				cMV_PIS	:=	Iif(Empty(cMV_PIS), "''", cMV_PIS)
				cMV_COFINS	:=	Iif(Empty(cMV_COFINS), "''", cMV_COFINS)
			Else
		#ENDIF

				//Para ambiente DBF quando concatenar 2 parametros, devo colocar uma barra entre eles.

				cMV_IRRF	:=	SetVar("MV_IRF")+"/"+SetVar("MV_IRF2")
				cMV_PIS		:=	SetVar("MV_PISNAT")+SetVar("MV_PISNAT2")
				cMV_CSLL	:=	SetVar("MV_CSLL")+SetVar("MV_CSLL2")
				cMV_COFINS	:=	SetVar("MV_COFINS")+SetVar("MV_COFINS2")
				cMV_IPI		:=	SetVar("MV_IPI")+SetVar("MV_IPI2")
				cMV_CIDE		:=	SetVar("MV_CIDE")+SetVar("MV_CIDE2")
		#IFDEF TOP
			EndIf
		#ENDIF
		
		SetIPCCI(@cMV_IRRF,@cMV_PIS,@cMV_CSLL,@cMV_COFINS)
		
		//Valida os parametros iniciados por MV_DCTF.

		If M978MVDCTF (@aRegra)
			//Chamado do assistente da rotina que contem a base para a geracao do meio-magnetico
			If lautomato
				Processa ({|| M978Proc (aRegra,lautomato,aWizard)}) //Processamento da rotina
			ElseIf	M978Wiz(cMV_DCTFCDG)
				FwMsgRun (,{|| M978Proc (aRegra,lautomato,aWizard)},"Processamento DCTF","") //Processamento da rotina				
			EndIf
		EndIf
	Else
		If FindFunction("TRepInUse")
			If TRepInUse()
				cNomWiz	:=	"DCTF" + FWGrpCompany() + FWGETCODFILIAL
				If !(MontWiz (cNomWiz+"R"))
					Return	//Se o wizard for cancelado aborto o processamento.
				EndIf
			
				If (!xMagLeWiz (cNomWiz+"R", @aWizard, .T.))
					Return	//Se por algum motivo a leitura do CFP falhar aborto a rotina.
				EndIf
				
				aTrbs	:=	LeTxt(@aRegra,@aStrCmps,@aTitulo,aWizard,@nArqVal,@cFile)
				If nArqVal==0
					//Interface de impressao

					oReport := ReportDef(aTrbs,aRegra,aStrCmps,aTitulo,cFile)
					oReport:PrintDialog()
					
				ElseIf nArqVal==1
					xMagHelpFis(STR0011,STR0275,STR0276)	//"Aten็ใo"###"Arquivo texto base para a gera็ใo deste relat๓rio de confer๊ncia ้ incompatํvel com a estrutura definida no ATO COTEPE N. 35/05, DE 17 DE JUNHO DE 2005."###"Selecione um arquivo vแlido para utiliza็ใo desta rotina. Este arquivo deve ser gerado de acordo com as implementa็๕es do boletim t้cnico da rotina."
					
				ElseIf nArqVal==2
					xMagHelpFis(STR0011,STR0277,STR0276)	//"Aten็ใo"###"Arquivo inexistente no diret๓rio especificado."###"Selecione um arquivo vแlido para utiliza็ใo desta rotina. Este arquivo deve ser gerado de acordo com as implementa็๕es do boletim t้cnico da rotina."
				EndIf
				
				For nI := 1 To Len(aTrbs)
					If File(aTrbs[nI,1]+GetDBExtension())
						dbSelectArea(aTrbs[nI,2])
						dbCloseArea()
						Ferase(aTrbs[nI,1]+GetDBExtension())
						Ferase(aTrbs[nI,1]+OrdBagExt())
					Endif	
				Next
			Else
				MsgInfo(STR0300) //"Op็ใo somente disponํvel para relatorio personalizavel"	
			EndIf
		Else
			MsgInfo(STR0278) //"Op็ใo somente disponํvel เ partir da versใo 8.11 Release 4."
		EndIf
	EndIf
EndIf
RestArea (aArea)
Return (lRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Proc  บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de processamento consolidando ou nao as filiais, que recebe um TRB com as informacoes dasบฑฑ
ฑฑบ          ณ darfs para geracao no meio-magnetico.                                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณCaso o CNPJ da empresa esteja em branco, sera assumido como padrao 00000000000000, onde recebe- บฑฑ
ฑฑบ          ณ ra a consolidacao dos dados.                                                                   บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaRegra -> Conteudo do parametro MV_DCTF jah formatado, [1,1]=Protheus, [1,2]=DCTF               บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณ MATR978 atraves do Menu                                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Proc (aRegra,lautomato,aWizard)
Local	lRet	:=	.T.
Local	aIniWiz		:=	{}
Local	cFilDe		:= 	""
Local	cFilAte		:= 	""
Local	cDctf		:=	"DCTF"
Local	l5952		:=	.T.
Local	aAreaSm0	:=	SM0->(GetArea ())
Local	aTrbs		:=	{}
Local	cTxt		:=	""
Local	cTxtBkp		:=	""
Local	cDir       	:=	""
Local	nOpcao		:=	0
Local	cMsg		:=	""
Local	nHandle		:=	0
Local	dDataDe		:=	CToD ("  /  /  ")
Local	dDataAte	:=	CToD ("  /  /  ")
Local	aEspecifico	:=	{}	
Local	nLastKey	:=	0
Local	aLog		:=	{}
Local	aAnual  		:=	{}
Local	aSituacao		:=	{STR0028, STR0029, STR0030, STR0031, STR0032, STR0033, STR0034}	//{"Nao se aplica", "Extincao", "Fusao", "Incorp./Incorporada", "Incorp./Incorporadora", "Cisao Total", "Cisao Parcial"}
Local  lTriAnt		:= .F. 
Local	dDtDeTriAnt	:=	CToD ("  /  /  ")
Local	dDtAtTriAnt	:=	CToD ("  /  /  ")
Local	nMes			:= 0
Local	nAno			:= 0

Private aFilsCalc	
Private lFiliais    
Private lInRfb2137 := .F.

Default lAutomato := .F.

If (lEnd := !xMagLeWiz ("DCTF" + FWGrpCompany() + FWGETCODFILIAL, @aIniWiz, .T.))
	Return (.T.)
EndIf

If !Empty(aWizard)
aIniwiz := aClone(aWizard)
EndIf

lFiliais    := Iif(aIniWiz[1][10] == "Sim",.T.,.F.)

If TcSrvType()== "AS/400"
	cFilDe		:= 	cFilAnt
	cFilAte		:= 	cFilAnt
Else
	If lFiliais  //Seleciona Filiais = Sim		   
			If aIniWiz[1][11] == "Sim"  //Aglutina Cnpj = SIm
			   aFilsCalc	:= MatFilCalc(aIniWiz[1][10] == "Sim",,,aIniWiz[1][11] == "Sim",,3)
			Else
			   aFilsCalc	:= MatFilCalc(lFiliais)
			Endif    
	Else
	 	aFilsCalc:={{.T.,cFilAnt}}		
	EndIf         
EndIf 
cFilDe		:= 	Iif (Val (aIniWiz[1][5])==1, Padr (aIniWiz[1][6], FWSizeFilial()), cFilAnt)
cFilAte	:= 	Iif (Val (aIniWiz[1][5])==1, Padr (aIniWiz[1][7], FWSizeFilial()), cFilAnt)
dDataDe	:=	SToD (Padr (aIniWiz[1][1], 8))
dDataAte	:=	SToD (Padr (aIniWiz[1][2], 8))
cDir      	:=	AllTrim (aIniWiz[1][4])
lTriAnt	:= StrZero(Month(dDataAte),2)$"03|06|09|12"

//Se a Data De / Ate compreenderem um intervalo de 1 mes, altero de mensal (DCTF) para DCTFM
If (SubStr (Padr (aIniWiz[1][1], 8), 1, 6)==SubStr (Padr (aIniWiz[1][2], 8), 1, 6))
	cDctf	+=	"M"

//Se a Data De / Ate compreenderem um intervalo de 6 meses, altero de mensal (DCTF) para DCTFS
ElseIf ((Month (SToD (aIniWiz[1][1]))==1) .And. (Month (SToD (aIniWiz[1][2]))==6)) .Or.;
	((Month (SToD (aIniWiz[1][1]))==7) .And. (Month (SToD (aIniWiz[1][2]))==12))
	cDctf	+=	"S"

//Quando se tratar de DCTF Trimestral, somente os meses de 1-3 ou 4-6 ou 7-9 ou 10-12 deverao ser aceitos.
ElseIf !(;
		(Month (SToD (aIniWiz[1][1]))==1 .And. Month (SToD (aIniWiz[1][2]))==3) .Or.;
		(Month (SToD (aIniWiz[1][1]))==4 .And. Month (SToD (aIniWiz[1][2]))==6) .Or.;
		(Month (SToD (aIniWiz[1][1]))==7 .And. Month (SToD (aIniWiz[1][2]))==9) .Or.;
		(Month (SToD (aIniWiz[1][1]))==10 .And. Month (SToD (aIniWiz[1][2]))==12);
		)
		aAddLog (@aLog,,,, dDataDe, dDataAte,,.T.)
EndIf

//Monta array para tratamento especifico dentro da funcao M978Darf
aAdd (aEspecifico, aRegra)
aAdd (aEspecifico, aIniWiz)
aAdd (aEspecifico, cDctf)

aAddLog (@aLog,,,, dDataDe, dDataAte,aEspecifico)

//l5952, identifica se devo considerar o codigo de receita 5952 (.T.) para os titulos TX aglutinados no financeiro, ou (.F.) devo atribuir os codigos especificos
//de acordo com a natureza, esta atribuicao eh utilizado na DCTF Trimestral, por nao existir o codigo 5952 para utilizacao no proprio software.

l5952	:=	Iif (Len (cDctf)==4, .F., .T.)		//Nao considero codigo de receita 5952 para DCTF Trimestral

//Avalia txt a ser gerado

If "M"$cDctf
	If Year(dDataDe)>=2006	//Layout alterado para VERSAO 1.4
		cTxt := "DCTF"+AllTrim(FWCodFil())+".RFB"
	Else
		cTxt := "DCTF"+AllTrim(FWCodFil())+".SRF"
	EndIf
ElseIf "S"$cDctf
	If Year(dDataDe)>=2006	//Layout alterado para VERSAO 1.3
		cTxt := "DCTF"+AllTrim(FWCodFil())+".RFB"
	Else
		cTxt := "DCTF"+AllTrim(FWCodFil())+".SRF"
	EndIf	
EndIf
cTxt := StrTran(cTxt," ","")

DumpFile(1, @cDir, @cTxt)

If !(File (cTxt))
	nHandle	:=	MsFCreate (cTxt)
Else
	cTxtBkp	:=	StrTran	(cTxt,	".SRF",	".#SR")

	cMsg	:=	STR0080+cTxt+STR0081						//"O arquivo "###" ja existe,"
	cMsg	+=	STR0082+cTxtBkp								//"o sistema gera um Backup "
	nOpcao	:=	IIF(lautomato,2,Aviso ("Drive", cMsg, {STR0083,STR0084})) 	//"Abandonar"###"Continuar"

	If (nOpcao==1) .Or. (nLastKey==27)
		lEnd	:=	.T.
		Return (lEnd)
	Else
		If File (cTxtBkp)
			FErase (cTxtBkp)
		Endif
		FRename (cTxt, cTxtBkp)
		nHandle	:=	MsFCreate (cTxt)
	Endif
Endif

//Apura registro Tipo 1.
M978Head (@nHandle, aIniWiz, cDctf, aSituacao)

//Apura registro Tipo R01.
M978R01 (@nHandle, aIniWiz, cDctf, aSituacao)

//Apura registro Tipo 2.
M978R02 (@nHandle, aIniWiz, cDctf, aSituacao)

//Apura registro Tipo R03
M978R03 (@nHandle, aIniWiz, cDctf, aSituacao)

//Crio os TRBs para o registro 10 e 11, R10 e R11
M978Trb (@aTrbs)

//Funcao que retorna todas as darf's de um periodo em nos TRB's R10 e R11.
If M978Darf(dDataDe, dDataAte, l5952, aEspecifico, @aLog, cFilDe, cFilAte, aFilsCalc, aIniWiz, @aAnual)

//Funcao de geracao dos registros de Debitos/Creditos.
	If (Year( aAnual[1])) < (Year( aAnual[2])) .And. aAnual[3]$"2430|6773" .And. (Month(dDataDe) == 12 .And. Month(dDataAte) == 12)

	ElseIf (Year( aAnual[1])) < (Year( aAnual[2])) .And. (Month(aAnual[2])== 3) .And. (Month(dDataDe) == Month(dDataAte)).And. aAnual[3] $"2430|6773"
		GerDebCre (nHandle, aIniWiz, cDctf, aSituacao)
	Else
		GerDebCre (nHandle, aIniWiz, cDctf, aSituacao)
	Endif
EndIf	
  
//Retorna as darf's do trimestre anterior gerando TRB's R20, R21, R22, R24, R30, R31
If lTriAnt
	nAno := Year(dDataDe) 
	Do Case
		Case Month(dDataDe)==3
			nMes := 12
			nAno --
		Case Month(dDataDe)==6
			nMes := 3
		Case Month(dDataDe)==9
			nMes := 6
		Case Month(dDataDe)==12
			nMes := 9
	EndCase	  
	dDtDeTriAnt	:=	CToD("01/"+StrZero(nMes,2)+"/"+StrZero(nAno,4))
	dDtAtTriAnt	:=	LastDate(dDtDeTriAnt)
	
	//Monta query	e gera TRB do trimestre anterior
	If M978Darf(dDtDeTriAnt, dDtAtTriAnt, l5952, aEspecifico, @aLog, cFilDe, cFilAte, aFilsCalc, aIniWiz, @aAnual, lTriAnt)
		GerDebCreTriAnt(nHandle, aIniWiz, cDctf, aSituacao)
	Endif	
Endif	

//Gero o registro Trailler do arquivo.
M978Trail (@nHandle, aTrbs, aIniWiz, aSituacao)

//Fecho o alias R10 e R11 utilizado como base na geracao dos R10, R11
M978ExcTrb (aTrbs)

//Fecha arquivo texto
If (nHandle>=0)
	FClose (nHandle)
Endif

//Geracao dos Registros R10 e R11 em arquivo texto.
GeraTxtLog (cDir, aLog)

DumpFile(2,,cTxt)

RestArea (aAreaSm0)
Return (lRet)


/************************************************* VALIDACAO *************************************************/
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978MVDCTFบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que verifica de todos parametros iniciados por MV_DCTF na tabela SX6. Este parametro     บฑฑ
ฑฑบ          ณ relaciona os codigos de receita com os codigos de receita do software da DCTF que possuem a    บฑฑ
ฑฑบ          ณ variacao. Alem de identificar a periodicidade de cada um.(D=Diario, S=Semanal, Q=Quinzenal,    บฑฑ
ฑฑบ          ณ X=Decendial, M=Mensal, T=Trimestral e A=Anual). Exemplo de uso: 5960=59601S; 5987=59871S;      บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณSoh irah retornar .F. se o parametro nao existir ou tiver em branco                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaRegra -> Conteudo do parametro MV_DCTF                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T. ou .F.                                                                                      บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณ M978MVDCTF (@aRegra)                                                                           บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978MVDCTF (aRegra)
Local	lRet		:=	.F.
Local	nInd		:=	0
Local	cLetra		:=	""
Local	cRegra		:=	""
Local	cDireita	:=	""
Local	cEsquerda	:=	""
Local	cChave1		:=	FWGETCODFILIAL
Local	cChave2		:=	Space(FWGETTAMFILIAL)
Local	cChave3		:=	Space(2)
Local	lLoop		:=	.F.

If SX6->(DbSeek (cChave1+"MV_DCTF"))
	bLoop		:=	{||cChave1==SX6->X6_FIL .And. "MV_DCTF"$SX6->X6_VAR}
	lLoop		:=	.T.
ElseIf SX6->(DbSeek (cChave2+"MV_DCTF"))
	bLoop		:=	{||cChave2==SX6->X6_FIL .And. "MV_DCTF"$SX6->X6_VAR}
	lLoop		:=	.T.
ElseIf SX6->(DbSeek (cChave3+"MV_DCTF"))
	bLoop		:=	{||cChave3==SX6->X6_FIL .And. "MV_DCTF"$SX6->X6_VAR}
	lLoop		:=	.T.
EndIf

DbSelectArea ("SX6")
SX6->(DbSetOrder (1))
If lLoop
	Do While !SX6->(Eof ()) .And. Eval(bLoop)
		cVar	:=	AllTrim (SX6->X6_CONTEUD)

		For nInd := 1 To Len (cVar)
			lRet	:=	.T.
			cLetra	:=	SubStr (cVar, nInd, 1)

			If (";"$cLetra)
				cDireita	:=	cRegra
				cRegra	:=	""
			ElseIf ("="$cLetra)
				cEsquerda	:=	cRegra
				cRegra	:=	""
			Else
				cRegra	+=	cLetra
			EndIf

			If (";"$cLetra)
				aAdd (aRegra, {cEsquerda, cDireita})
			EndIf

		Next (nInd)

		SX6->(DbSkip ())
	EndDo

	If !(lRet)
		xMagHelpFis (STR0097, STR0096, STR0009)
	EndIf
Else
	xMagHelpFis (STR0094, STR0095, STR0008)
	lRet	:=	.F.
EndIf

Return (lRet)

/************************************************* TEMPORARIOS *************************************************/

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Trb   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que cria os TRBs para o Registro 10 e 11, onde serao alimentados pela funcao M978Res     บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaTrbs -> Array contendo o Alias e o nome Fisico do TRB criado para exclusao.                    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณaTrbs -> [1]=Alias do TRB Criado                                                                บฑฑ
ฑฑบ          ณ         [2]=Nome fisico do TRB Criado                                                          บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Trb (@aTrbs)                                                                                บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Trb (aTrbs)
Local	aCmps	:=	{}
Local	cArq	:=	""
Local 	cArq2	:=	""
Local 	cArq3	:=	""

//D้bito Apurado e Cr้ditos Vinculados 
aAdd (aCmps, {"R10_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R10_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R10_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R10_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R10_MESAPU",	"N", 	02,		0})	//Mes do periodo da apuracao
aAdd (aCmps, {"R10_DSQD",	"N", 	02,		0})	//Dia/Semana/Quinzena/Decendio do perioda da apuracao
aAdd (aCmps, {"R10_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R10_CNPJIN",	"N", 	14,		0})	//CNPJ Incorporacao - DCTF Mensal
aAdd (aCmps, {"R10_VLRDEB",	"N", 	14,		2})	//Valor do debito
aAdd (aCmps, {"R10_BALRED",	"N", 	01,		0})	//Balanco da reducao
aAdd (aCmps, {"R10_SALCOT",	"N", 	01,		0})	//O saldo deste debito sera dividido em cotas (S/N) Somente IRPJ

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R10")
IndRegua ("R10", cArq, "StrZero (R10_GRPTRI, 2)+StrZero (R10_CODREC, 6)+R10_PERIOD+StrZero (R10_ANOAPU, 4)+StrZero (R10_MESAPU, 2)+StrZero (R10_DSQD, 2)+StrZero (R10_CNPJES, 6)")

aAdd (aTrbs, {"R10", cArq})

//Pagamento
aCmps	:=	{}
aAdd (aCmps, {"R11_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R11_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R11_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R11_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R11_MESAPU",	"N", 	02,		0})	//Mes do periodo da apuracao
aAdd (aCmps, {"R11_DSQD",	"N", 	02,		0})	//Dia/Semana/Quinzena/Decendio do perioda da apuracao
aAdd (aCmps, {"R11_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R11_CNPJIN",	"N", 	14,		0})	//CNPJ Incorporacao - DCTF Mensal
aAdd (aCmps, {"R11_PERAPU",	"D", 	08,		0})	//Periodo de apuracao
aAdd (aCmps, {"R11_CNPJDA",	"C", 	14,		0})	//CNPJ do DARF
aAdd (aCmps, {"R11_CODRE2",	"N", 	04,		0})	//Codigo da receita sem a variacao
aAdd (aCmps, {"R11_DTVENC",	"D", 	08,		0})	//Data vencimento
aAdd (aCmps, {"R11_NUMRER",	"C", 	17,		0})	//N. referencia
aAdd (aCmps, {"R11_VLRPRI",	"N", 	14,		2})	//Valor principal
aAdd (aCmps, {"R11_VLRMUL",	"N", 	14,		2})	//Valor da multa
aAdd (aCmps, {"R11_VLRJUR",	"N", 	14,		2})	//Valor dos juros
aAdd (aCmps, {"R11_COMP",	"C", 	01,		0})	//Indicador de Titulo Compensado - S=Titulo Compensado, N=Titulo pago normal
aAdd (aCmps, {"R11_VLRPAG",	"N", 	14,		2})	//Valor pago ou Valor Compensado do debito dependendo do campo R11_COMP
aAdd (aCmps, {"R11_FORMAL",	"C", 	01,		0})	//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp ou 4=DComp com Direito Creditorio Reconhecido em processo
aAdd (aCmps, {"R11_NUMERO",	"C", 	24,		0})	//Numero do PERDCOMP ou PROCESSO
aAdd (aCmps, {"R11_CODAGL",	"C", 	06,		0})	//Codigo Aglutinador
aAdd (aCmps, {"R11_FILIAL",	"C", 	FWGETTAMFILIAL,		0})	//Filial do Darf
aAdd (aCmps, {"R11_IDDARF",	"C", 	20,		0})	//Id do Darf
aAdd (aCmps, {"R11_REGCOM",	"C", 	01,		0})	//Tipo registro de compensa็ใo
aAdd (aCmps, {"R11_TIPCRE",	"C", 	02,		0})	//Tipo credito

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R11")
IndRegua ("R11", cArq, "StrZero(R11_GRPTRI,2)+StrZero(R11_CODREC,6)+R11_PERIOD+StrZero(R11_ANOAPU,4)+StrZero(R11_MESAPU,2)+StrZero(R11_DSQD,2)+StrZero(R11_CNPJES,6)+R11_COMP+R11_REGCOM+R11_FORMAL+R11_NUMERO") 
dbClearIndex()

cArq2 := CriaTrab(Nil,.F.)
IndRegua("R11", cArq2, "R11_FILIAL+R11_IDDARF")
dbClearIndex()

cArq3 := CriaTrab(Nil,.F.)
IndRegua("R11", cArq3, "R11_CODAGL")
dbClearIndex()

dbSelectArea("R11")
dbSetIndex(cArq+OrdBagExt())
dbSetIndex(cArq2+OrdBagExt())
dbSetIndex(cArq3+OrdBagExt())
dbSetOrder(1)

aAdd (aTrbs, {"R11", cArq})

//Suspensใo
aCmps	:=	{}
aAdd (aCmps, {"R14_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R14_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R14_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R14_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R14_MESAPU",	"N", 	02,		0})	//Mes do periodo da apuracao
aAdd (aCmps, {"R14_DSQD",	"N", 	02,		0})	//Dia/Semana/Quinzena/Decendio do perioda da apuracao
aAdd (aCmps, {"R14_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R14_CNPJIN",	"N", 	14,		0})	//CNPJ Incorporacao - DCTF Mensal
aAdd (aCmps, {"R14_VLRSUS",	"N", 	14,		2})	//Valor Suspenso do D้bito
aAdd (aCmps, {"R14_MOTSUS",	"C", 	02,		0})	//Motivo da Suspensใo
aAdd (aCmps, {"R14_COMDEP",	"C", 	01,		0})	//Dep๓sito (Sim/Nใo)
aAdd (aCmps, {"R14_NROPRO",	"C", 	24,		0})	//N๚mero do Processo
aAdd (aCmps, {"R14_IDVARA",	"C", 	02,		0})	//Vara
aAdd (aCmps, {"R14_CODMUN",	"C", 	05,		0})	//Municํpio
aAdd (aCmps, {"R14_UF",		"C", 	02,		0})	//UF
aAdd (aCmps, {"R14_IDEDEP",	"C", 	20,		0})	//Identifica็ใo do Dep๓sito
aAdd (aCmps, {"R14_PERAPU",	"D", 	08,		0})	//Perํodo Apura็ใo
aAdd (aCmps, {"R14_CPFCGC",	"C", 	14,		0})	//CPF/CNPJ
aAdd (aCmps, {"R14_CRECDJ",	"C", 	04,		0})	//Codigo Receita do deposito judicial
aAdd (aCmps, {"R14_DTVCTO",	"D", 	08,		0})	//Data do Vencimento
aAdd (aCmps, {"R14_VLRPRI",	"N", 	14,		2})	//Valor do Principal
aAdd (aCmps, {"R14_VLRMUL",	"N", 	14,		2})	//Valor da Multa
aAdd (aCmps, {"R14_VLRJUR",	"N", 	14,		2})	//Valor dos Juros

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R14")
IndRegua ("R14", cArq, "StrZero(R14_GRPTRI,2)+StrZero(R14_CODREC,6)+R14_PERIOD+StrZero(R14_ANOAPU,4)+StrZero(R14_MESAPU,2)+StrZero(R14_DSQD,2)+StrZero(R14_CNPJES,6)") 
//	IndRegua ("R14", cArq, "R14_MOTSUS")

aAdd (aTrbs, {"R14", cArq})

//D้bito Apurado e Cr้ditos Vinculados do Trimestre Anterior 
aCmps	:=	{}
aAdd (aCmps, {"R20_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R20_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R20_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R20_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R20_TRIAPU",	"C", 	02,		0})	//Trimestre do Perํodo de Apura็ใo
aAdd (aCmps, {"R20_VLRDEB",	"N", 	14,		2})	//Valor do debito
aAdd (aCmps, {"R20_QTDCOT",	"N", 	01,		0})	//Quantidade de Quotas
aAdd (aCmps, {"R20_SCPINC",	"C", 	01,		0})	//D้bito de SCP/INC
aAdd (aCmps, {"R20_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R20")
IndRegua ("R20", cArq, "StrZero(R20_GRPTRI,2)+StrZero(R20_CODREC,6)+R20_PERIOD+StrZero(R20_ANOAPU,4)+R20_TRIAPU+StrZero(R20_CNPJES,6)")
aAdd (aTrbs, {"R20", cArq})

//Pagamento do Trimestre Anterior
aCmps	:=	{}
aAdd (aCmps, {"R21_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R21_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R21_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R21_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R21_TRIAPU",	"C", 	02,		0})	//Trimestre do Perํodo de Apura็ใo
aAdd (aCmps, {"R21_PERAPU",	"D", 	08,		0})	//Periodo de apuracao
aAdd (aCmps, {"R21_CNPJDA",	"C", 	14,		0})	//CNPJ do DARF
aAdd (aCmps, {"R21_CODRE2",	"N", 	04,		0})	//Codigo da receita sem a variacao
aAdd (aCmps, {"R21_DTVENC",	"D", 	08,		0})	//Data vencimento
aAdd (aCmps, {"R21_NUMRER",	"C", 	17,		0})	//N. referencia
aAdd (aCmps, {"R21_VLRPRI",	"N", 	14,		2})	//Valor principal
aAdd (aCmps, {"R21_VLRMUL",	"N", 	14,		2})	//Valor da multa
aAdd (aCmps, {"R21_VLRJUR",	"N", 	14,		2})	//Valor dos juros
aAdd (aCmps, {"R21_VLRPAG",	"N", 	14,		2})	//Valor pago do debito
aAdd (aCmps, {"R21_FORMAL",	"C", 	01,		0})	//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp ou 4=DComp com Direito Creditorio Reconhecido em processo
aAdd (aCmps, {"R21_NUMERO",	"C", 	24,		0})	//Numero do PERDCOMP ou PROCESSO
aAdd (aCmps, {"R21_CODAGL",	"C", 	06,		0})	//Codigo Aglutinador
aAdd (aCmps, {"R21_IDDARF",	"C", 	20,		0})	//Id do Darf
aAdd (aCmps, {"R21_REGCOM",	"C", 	01,		0})	//Tipo registro de compensa็ใo
aAdd (aCmps, {"R21_TIPCRE",	"C", 	02,		0})	//Tipo credito
aAdd (aCmps, {"R21_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R21_COMP",	"C", 	01,		0})	//Indicador de Titulo Compensado - S=Titulo Compensado, N=Titulo pago normal

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R21")
IndRegua ("R21", cArq, "StrZero(R21_GRPTRI,2)+StrZero(R21_CODREC,6)+R21_PERIOD+StrZero(R21_ANOAPU,4)+R21_TRIAPU+DTOC(R21_PERAPU)+StrZero(R21_CNPJES,6)+R21_COMP+R21_FORMAL+R21_NUMERO")
dbClearIndex()

cArq2 := CriaTrab(Nil,.F.)
If GetNewPar("MV_USAFI9",.F.) .And. AliasIndic("FI9")
	IndRegua("R21", cArq2, "R21_IDDARF")
Else
	IndRegua("R21", cArq2, "R21_CODAGL")
Endif
dbClearIndex()

dbSelectArea("R21")
dbSetIndex(cArq+OrdBagExt())
dbSetIndex(cArq2+OrdBagExt())
dbSetOrder(1)

aAdd (aTrbs, {"R21", cArq})

//Suspensใo Trimestre Anterior
aCmps	:=	{}
aAdd (aCmps, {"R24_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R24_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R24_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R24_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R24_TRIAPU",	"C", 	02,		0})	//Trimestre do Perํodo de Apura็ใo
aAdd (aCmps, {"R24_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R24_CNPJIN",	"N", 	14,		0})	//CNPJ Incorporacao - DCTF Mensal
aAdd (aCmps, {"R24_VLRSUS",	"N", 	14,		2})	//Valor Suspenso do D้bito
aAdd (aCmps, {"R24_MOTSUS",	"C", 	02,		0})	//Motivo da Suspensใo
aAdd (aCmps, {"R24_COMDEP",	"C", 	01,		0})	//Dep๓sito (Sim/Nใo)
aAdd (aCmps, {"R24_NROPRO",	"C", 	24,		0})	//N๚mero do Processo
aAdd (aCmps, {"R24_IDVARA",	"C", 	02,		0})	//Vara
aAdd (aCmps, {"R24_CODMUN",	"C", 	05,		0})	//Municํpio
aAdd (aCmps, {"R24_UF",		"C", 	02,		0})	//UF
aAdd (aCmps, {"R24_IDEDEP",	"C", 	20,		0})	//Identifica็ใo do Dep๓sito
aAdd (aCmps, {"R24_PERAPU",	"D", 	08,		0})	//Perํodo Apura็ใo
aAdd (aCmps, {"R24_CPFCGC",	"C", 	14,		0})	//CPF/CNPJ
aAdd (aCmps, {"R24_CRECDJ",	"C", 	04,		0})	//Codigo Receita do deposito judicial
aAdd (aCmps, {"R24_DTVCTO",	"D", 	08,		0})	//Data do Vencimento
aAdd (aCmps, {"R24_VLRPRI",	"N", 	14,		2})	//Valor do Principal
aAdd (aCmps, {"R24_VLRMUL",	"N", 	14,		2})	//Valor da Multa
aAdd (aCmps, {"R24_VLRJUR",	"N", 	14,		2})	//Valor dos Juros

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R24")
IndRegua ("R24", cArq, "R24_MOTSUS")

aAdd (aTrbs, {"R24", cArq})

//Quotas 
aCmps	:=	{}
aAdd (aCmps, {"R30_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R30_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R30_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R30_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R30_TRIAPU",	"C", 	02,		0})	//Trimestre do Perํodo de Apura็ใo
aAdd (aCmps, {"R30_NROQTA",	"C", 	01,		0})	//N๚mero da Quota
aAdd (aCmps, {"R30_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R30")
IndRegua ("R30", cArq, "StrZero(R30_GRPTRI,2)+StrZero(R30_CODREC,6)+R30_PERIOD+StrZero(R30_ANOAPU,4)+R30_TRIAPU+StrZero(R30_CNPJES,6)+R30_NROQTA")

aAdd (aTrbs, {"R30", cArq})

//Pagamento da Quota
aCmps	:=	{}
aAdd (aCmps, {"R31_GRPTRI",	"N", 	02,		0})	//Grupo de Tributo
aAdd (aCmps, {"R31_CODREC",	"N", 	06,		0})	//Codigo Receita com a variacao
aAdd (aCmps, {"R31_PERIOD",	"C", 	01,		0})	//Periodicidade
aAdd (aCmps, {"R31_ANOAPU",	"N", 	04,		0})	//Ano do periodo da apuracao
aAdd (aCmps, {"R31_TRIAPU",	"C", 	02,		0})	//Trimestre do Perํodo de Apura็ใo
aAdd (aCmps, {"R31_PERAPU",	"D", 	08,		0})	//Periodo de apuracao
aAdd (aCmps, {"R31_CNPJDA",	"C", 	14,		0})	//CNPJ do DARF
aAdd (aCmps, {"R31_CODRE2",	"N", 	04,		0})	//Codigo da receita sem a variacao
aAdd (aCmps, {"R31_DTVENC",	"D", 	08,		0})	//Data vencimento
aAdd (aCmps, {"R31_NUMRER",	"C", 	17,		0})	//N. referencia
aAdd (aCmps, {"R31_VLRPRI",	"N", 	14,		2})	//Valor principal
aAdd (aCmps, {"R31_VLRMUL",	"N", 	14,		2})	//Valor da multa
aAdd (aCmps, {"R31_VLRJUR",	"N", 	14,		2})	//Valor dos juros
aAdd (aCmps, {"R31_VLRPAG",	"N", 	14,		2})	//Valor pago do debito
aAdd (aCmps, {"R31_FORMAL",	"C", 	01,		0})	//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp ou 4=DComp com Direito Creditorio Reconhecido em processo
aAdd (aCmps, {"R31_NUMERO",	"C", 	24,		0})	//Numero do PERDCOMP ou PROCESSO
aAdd (aCmps, {"R31_CODAGL",	"C", 	06,		0})	//Codigo Aglutinador
aAdd (aCmps, {"R31_IDDARF",	"C", 	20,		0})	//Id do Darf
aAdd (aCmps, {"R31_REGCOM",	"C", 	01,		0})	//Tipo registro de compensa็ใo
aAdd (aCmps, {"R31_TIPCRE",	"C", 	02,		0})	//Tipo credito
aAdd (aCmps, {"R31_CNPJES",	"N", 	06,		0})	//CNPJ Estabelecimento
aAdd (aCmps, {"R31_COMP",	"C", 	01,		0})	//Indicador de Titulo Compensado - S=Titulo Compensado, N=Titulo pago normal
aAdd (aCmps, {"R31_NROQTA",	"C", 	01,		0})	//N๚mero da Quota

cArq	:=	CriaTrab (aCmps)
DbUseArea (.T., __LocalDriver, cArq, "R31")
IndRegua ("R31", cArq, "StrZero(R31_GRPTRI,2)+StrZero(R31_CODREC,6)+R31_PERIOD+StrZero(R31_ANOAPU,4)+R31_TRIAPU+R31_NROQTA+DTOC(R31_PERAPU)+StrZero(R31_CNPJES,6)+R31_COMP+R31_FORMAL+R31_NUMERO")
dbClearIndex()

cArq2 := CriaTrab(Nil,.F.)
If GetNewPar("MV_USAFI9",.F.) .And. AliasIndic("FI9")
	IndRegua("R31", cArq2, "R31_IDDARF")
Else
	IndRegua("R31", cArq2, "R31_CODAGL")
Endif
dbClearIndex()

dbSelectArea("R31")
dbSetIndex(cArq+OrdBagExt())
dbSetIndex(cArq2+OrdBagExt())
dbSetOrder(1)

aAdd (aTrbs, {"R31", cArq})
	
Return (aTrbs)

/************************************************* PROCESSAMENTO *************************************************/

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Darf  บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao de todas as DARFS para o periodo de apuracao. A data de emissao dos titulos TXบฑฑ
ฑฑบ          ณ identifica o periodo de apuracao de acordo com a periodicidade do codigo de receita atribuido  บฑฑ
ฑฑบ          ณ ao titulo.                                                                                     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณFuncao que monta o R10 e R11 que serah ser tratado no momento de geracao do meio-magnetico.     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณdDataIni -> Data inicio do periodo.                                                             บฑฑ
ฑฑบ          ณdDataFim -> Data final do periodo.                                                              บฑฑ
ฑฑบ          ณl5952 -> Identifica se devo considerar o codigo de receita 5952 ou desmembrar(DCTF Trimestral)  บฑฑ
ฑฑบ          ณaEspecifico -> [1]=Array contendo a regra do parametro MV_DCTF                                  บฑฑ
ฑฑบ          ณ               [2]=Array contendo as informacoes digitadas no Wizard.                           บฑฑ
ฑฑบ          ณ               [3]=String contendo a versao da DCTF a ser gerada, Ex: "DCTF"                    บฑฑ
ฑฑบ          ณaLog -> Array contendo o log a ser gravado no arquivo de log ao final do processamento.         บฑฑ
ฑฑบ          ณcFilDe -> Filial inicial para processamento.                                                    บฑฑ
ฑฑบ          ณcFilAte -> Filial final para processamento.                                                     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณlGerou -> Indica se foram gerados registros para o meio-magnetico.                              บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณ M978Darf (dDataDe, dDataAte, l5952, aEspecifico, aLog, cFilDe, cFilAte,aFilsCalc)              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/ 
Static Function M978Darf(dDataDe, dDataAte, l5952, aEspecifico, aLog, cFilDe, cFilAte, aFilsCalc, aIniWiz, aAnual, lTriAnt)
#IFNDEF TOP
	Local	cIndex	:=	""
	Local	nIndex	:=	0
	Local	cQuery	:=	""
#ENDIF
Local	cCodAgl		:= ""
Local	bFind		:= {|| }
Local	cAlsSe2		:=	"SE2"
Local	nX			:=	0
Local	aFornece	:=	{"",""}
Local	aRegra		:=	aEspecifico[1]
Local	cDctf		:=	aEspecifico[3]
Local	cCodRet		:=	""
Local	cPeriod		:=	""
Local	cCodRetVar	:=	""
Local	dDtApur		:=	CToD ("  /  /  ")
Local	cCnpjDarf	:=	""
Local	cCnpjMat	:=	SM0->M0_CGC
Local	cCodMun		:=	""
Local	aBaixa		:=	{}
Local	lPai		:=	.F.
Local	lGerou		:=	.F.
Local	aInfComp	:=	{"N", "", "", .T., "1", ""}
Local	nJ			:=	1
Local	aSm0Loop	:=	SM0->(GetArea ())
Local	aEmpresa	:=	{}
Local	cAnoApu		:=	""
Local	cMesApu		:=	""
Local	cR10_DSQD	:=	""
Local	cGrpTrib	:=	""
Local	cCnpjEstab	:=	""
Local	lLei11196 	:=	.F.			//SuperGetMv("MV_VC11196",.T.,"2") == "1"                 ((( DESABILITADO )))
Local	cTitulo		:=	OemToAnsi(STR0112)+" !!!"	//"ERRO"
Local	cProblema	:=	OemToAnsi(STR0117)	//"O retorno do Ponto de Entrada [A978CAD] Incorreto !!!"
Local	cSolucao		:=	OemToAnsi(STR0118)	//"O retorno do Ponto de Entrada [A978CAD], deverแ obrigatoriamente"
												//"ser um array conforme a seguinte estrutura e ordem: {SM0->M0_CGC, SM0->M0_CODIGO, SM0->M0_CODFIL}"
Local	cChave		:= ""
Local	lTitAgl	:=	.F.
Local	lBxTitAgl	:=	.F.
Local	aBxTitAgl	:=	{}
Local	cBxTitAgl	:=	"000000"
Local	nPTitAgl	:=	0
Local	lIrrf		:=	.F.
Local	cParcTx		:=	""
Local	aCmpDtFtG	:=	{"",""}	//1=Campo da tabela SE2 para o fato gerador do IR, 2=Campo da tabela SE2 para o fato gerador do PIS/COFINS/CSLL
Local	dDtFtGer	:=	CToD("  /  /  ")
Local	lTx			:=	.F.
Local	lDp			:=	.F.
Local lGPEM670    	:=	.F.
Local cTipo			:= ''
Local lReclock   := .F.
Local lAglutinaR11 := .F.
Local lAglutinaR21 := .F.
Local lR10	:= .T.
Local nY := 0
Local cEmpOri	:= FWGrpCompany()
Local nForFilial
Local cPROCESSO	:= ""
Local lCPOCCLOK	:= CCF->(FieldPos("CCF_MOTSUS")*FieldPos("CCF_IDDEP")*FieldPos("CCF_NRDCOM")*FieldPos("CCF_IDVARA")*FieldPos("CCF_CODMUN")*FieldPos("CCF_UF")*FieldPos("CCF_IDDEP")*FieldPos("CCF_PERAPU")*FieldPos("CCF_CNPJ")*FieldPos("CCF_CODREC"))>0
Local lCFFOK	:= CCF->(FieldPos("CCF_TPCOMP"))>0 .and. CCF->(FieldPos("CCF_NRDCOM"))>0 .and. CCF->(FieldPos("CCF_TIPCOM"))>0 .and.CCF->(FieldPos("CCF_TIPCRE"))>0
Local lDatSus	:= CCF->(FieldPos("CCF_DATSUS"))>0
Local cTriApuAnt := StrZero(Month(dDataAte)/3,2)  
Local nSdoQuota	:= 0 
Local lBx10925	:= (SuperGetMv("MV_BX10925")=="2")
Local lGeraR11 := .T. 
Local lAchouCCF	:= .F.
Local cTITCPSP := AllTrim(SuperGetMv("MV_TITCPSP",.F.,"")) //Tํtulo compensado manualmente (Sem pai) 
Local cAglTipo	:=	''
Local lA978COMP := ExistBlock("A978COMP")
Local lA978PRF	:= ExistBlock("A978PRF")
Local lA978R10	:= ExistBlock("A978R10")
Local lFI9		:= .F.
Local lProcFI9	:= .F.
Local lFound	:= .F.
Local aAreaSE2  := {}


Default lTriAnt := .F.   

If dDataDe < cToD("01/01/2024") // INSTRUวรO NORMATIVA RFB Nบ 2137, DE 21 DE MARวO DE 2023 
   lInRfb2137 :=.T.
EndIf

//Monto no array aEmpresa todas as filiais da empresa corrente
DbSelectArea ("SM0")
SM0->(DbSeek (cEmpAnt+cFilDe, .T.))

//PE - Para tratamento de filiais da empresa corrente

If ExistBlock("A978CAD")
	aEmpresa := ExecBlock("A978CAD",.F.,.F.,{cEmpAnt,cFilDe,cFilAte})
	For nX := 1 To Len(aEmpresa)
		If Len(aEmpresa[nX]) <> 3
			lEnd := .T.		//Aborta o processamento
			xMagHelpFis(cTitulo,cProblema,cSolucao)
			Exit
		EndIf
	Next
Else
	If TcSrvType()<>"AS/400"
		If lFiliais  //se seleciona filiais, adiciono no array somente as filiais marcadas
			For nForFilial := 1 To Len( aFilsCalc )
				If 	aFilsCalc[ nForFilial, 1 ]
					aAdd(aEmpresa,{ IIf(!Empty(aFilsCalc[nForFilial][4]), aFilsCalc[nForFilial][4], Replic("0",14) ), cEmpOri, aFilsCalc[nForFilial][2] } )
				EndIf
			Next
		Else
			AAdd (aEmpresa,{SM0->M0_CGC, FWGrpCompany(),cFilAnt })
		EndIf
	Else
		AAdd (aEmpresa,{SM0->M0_CGC, FWGrpCompany(),cFilAnt })
	EndIf
Endif

aEmpresa := Asort (aEmpresa,,, {|x,y| x[1]<y[1]})

//Processando filiais da mesma empresa consolidacao
For nJ := 1 To Len (aEmpresa)
	lAglutinaR11 := .F.
	lAglutinaR21 := .F.
	lFI9		 := GetNewPar("MV_USAFI9",.F.) .And. AliasIndic("FI9") //Verifica se o tratamento atrav้s da FI9 estแ habilitado
	If (lEnd)
		//Retorno o alias do SM0
		RestArea (aSm0Loop)
		cFilAnt		:=	FWCodFil()
		Return (.F.)
	EndIf

	DbSelectArea("SM0")
	SM0->(DbSeek (aEmpresa[nJ,2]+aEmpresa[nJ,3], .T.))
	cFilAnt := FWCodFil()
	//Crio um novo alias para a tabela SE2 porque necessito de informacoes para
	//Compensacao que estao na NDF mas nao estao na query da tabela SE2
	If lA978COMP
		If ((Select ("__SE2"))<>0)
			__SE2->(DbCloseArea ())
		EndIf
		ChkFile ("SE2", .F., "__SE2")
	EndIf
	
	DbSelectArea ("CCF")
	CCF->(DbSetOrder (1))
	
	//Copia para uso durante o processamento
	If ((Select ("SE2CPY"))<>0)
		SE2CPY->(DbCloseArea ())
	EndIf
	ChkFile ("SE2", .F., "SE2CPY")

	DbSelectArea ("SE2")
	SE2->(DbSetOrder (1))
	#IFDEF TOP
		If TcSrvType()<>"AS/400"
			cAlsSe2	:=	GetNextAlias()
			//QUERY PARA PROCESSAMENTO DA BASE
			cQuery	:=	MontcQry(dDataDe, dDataAte, @aCmpDtFtG, @cAlsSe2, lTriAnt)

			DbSelectArea (cAlsSe2)
			nCntRegSe2	:=	(cAlsSe2)->(LastRec())
			AADD(aAnual,(cAlsSe2)->E2_EMISSAO)
			AADD(aAnual,(cAlsSe2)->E2_VENCREA)
			AADD(aAnual,(cAlsSe2)->E2_CODRET)
		Else
	#ENDIF
		cAlsSe2	:=	"SE2"
		cQuery		:=	MontcQry(dDataDe, dDataAte, @aCmpDtFtG)
		cIndex		:= 	CriaTrab(Nil, .F.)
		IndRegua(cAlsSe2,cIndex,(cAlsSe2)->(IndexKey()),,cQuery)
		nIndex 	:= RetIndex(cAlsSe2)
		#IFNDEF TOP
			DbSetIndex(cIndex+OrdBagExt())
		#ENDIF
		DbSelectArea (cAlsSe2)
		(cAlsSe2)->(DbSetOrder(nIndex+1))
		nCntRegSe2	:= (cAlsSe2)->(LastRec())
		(cAlsSe2)->(DbGoTop())
	#IFDEF TOP
		EndIf
	#ENDIF

	ProcRegua (nCntRegSe2)
	
	If (cAlsSe2)->(Eof ()) .And. !lTriAnt
		aAddLog (@aLog,,,cQuery, dDataDe, dDataAte)
	EndIf

	Do While !(cAlsSe2)->(Eof())
		//Se e o Titulo for gerado pelo MATA996 o tipo do titulo ้ Duplicata e devo considerar    
		lDp	:= IIF(Alltrim((cAlsSe2)->E2_ORIGEM) == "FISA001",.T.,(cAlsSe2)->E2_TIPO$MVDUPLIC .And. Alltrim((cAlsSe2)->E2_ORIGEM) == "MATA996")
		//Titulos gerados pelo M๓dulo Recursos Humanos na Integra็ใo Financeira(GPEM670)
		lGPEM670	:= Alltrim((cAlsSe2)->E2_ORIGEM) == "GPEM670"
		For nX := 1 To 5
			lGPEM670		:= Alltrim((cAlsSe2)->E2_ORIGEM) == "GPEM670" .And. nX == 1
			lTx			:=	((cAlsSe2)->E2_TIPO$(MVTAXA+MVTXA+"PIS#COF"))
			cCnpjDarf		:=	SM0->M0_CGC
			cCodMun		:=	""
			aFornece		:=	{(cAlsSe2)->E2_FORNECE,(cAlsSe2)->E2_LOJA}
			lTitAgl		:=	.F.		//Indica se o titulo em processamento foi baixado por aglutinacao
			lBxTitAgl		:=	.F.		//Indica se o titulo aglutinado foi baixado
			nPTitAgl		:=	0
			cParcTx		:=	""
			cPeriod		:=	" "
			cCodRetVar		:=	""
			dDtApur		:=	CToD ("  /  /  ")
			lGerou			:=	.T.
			dDtFtGer		:=	CToD ("  /  /  ")
			aInfComp		:=	{"N", "", "", .T., "1", ""}	// Restaura array de compensa็ใo			
			lFound          := .F.
			//Os titulos TXs considerados no processamento que virao sao:
			//- PIS/COFINS/CSLL gerados na baixa do titulo original (MV_BX10925=1);
			//- Todos inseridos manualmente, ou seja, que nao possuem PAI;
			//|                                                                         |
			//|Os titulos TXs que NAO sao considerados no processamento e que virao sao:|
			//|- Os de IRRF que possuem PAI (pois o PAI que eh processado - no else);   |
			//|- Os de PIS/COFINS/CSLL que possuem PAI gerados na EMISSAO por outras    |
			//|     rotinas (NAO DA NOTA FISCAL), pois o PAI que eh processado - no else|			
			If lTx .Or. lDp .Or. lGPEM670 .Or. (Alltrim((cAlsSe2)->E2_TIPO)==cTITCPSP .And. nX==1)
				cParcTx	:=	(cAlsSe2)->E2_PARCELA
				dDtFtGer	:=	(cAlsSe2)->E2_EMISSAO					
				If (cAlsSe2)->E2_NATUREZ$cMV_PIS .Or. (cAlsSe2)->E2_NATUREZ$cMV_COFINS .Or. (cAlsSe2)->E2_NATUREZ$cMV_CSLL .Or. (cAlsSe2)->E2_NATUREZ$cMV_IRRF
					lPai	:=	M978TrbPai ((cAlsSe2)->E2_PREFIXO, (cAlsSe2)->E2_NUM, (cAlsSe2)->E2_PARCELA, @aFornece, (cAlsSe2)->E2_NATUREZ)						
					
					//Para os Titulos gerados pelo MATA996 devo considerar apenas uma vez pois nใo
					//existe TX					
					lDp	:= IIF(lDp .And. nX==1,.T.,.F.)
					If Alltrim((cAlsSe2)->E2_ORIGEM) == "FISA001" 
						dDtFtGer	:=	IIF(lDp .And. nX==1,(cAlsSe2)->E2_EMISSAO,CToD("  /  /  "))
					EndIf	
				Endif	

				//Como para o IRRF sao considerados tanto os titulos TX quanto os
				//   titulos originais, devo inserir este tratameneto para quando o respectivo
				//   TX possuir PAI, devo considerar somente o PAI e despresar o TX.

				//OBS: Este caso ocorre para o IRRF e para o PIS/COFINS/CSLL na EMISSAO
				If ((cAlsSe2)->E2_NATUREZ$cMV_IRRF .And. lPai).Or.;
					(lBx10925 .And. (cAlsSe2)->E2_NATUREZ$cMV_PIS+cMV_COFINS+cMV_CSLL .And. lPai)
					dDtFtGer	:=	CToD("  /  /  ")
				EndIf
				//Os titulos de NF (original) que NAO sao processados e que virao sao:   
				//- Os de PIS/COFINS/CSLL gerados na BAIXA, pois os TXs que sao          
				//    considerados (If lTx). Considero o TX da baixa devido o fato gera- 
				//    dor ser o pagamento da nota fiscal original, ou seja, a emissao do 
				//    titulo TX gerado na BAIXA.                                         
			Else
				//Para o IRRF, considero os dados da nota fiscal original, pois os TXs
				//  serao processados mais DESCONSIDERADOS anteriormente (If lTx).    
				If nX==1 .And. ((cAlsSe2)->E2_IRRF > 0 .OR. !Empty((cAlsSe2)->E2_CODRET))
					cParcTx	:=	(cAlsSe2)->E2_PARCIR
					dDtFtGer	:=	(cAlsSe2)->&(aCmpDtFtG[1])

					If  (cAlsSe2)->A2_CALCIRF=="2"
						dDtFtGer	:=	(cAlsSe2)->E2_BAIXA
					Endif

				//So quando o parametro for pela emissao, pois quando ele for
				//pela baixa entrara na primeira condicao (If lTx) e deverei
				//desconsiderar desta.
				
				ElseIf nX==2 .And. (cAlsSe2)->E2_PIS>0 .And. lBx10925
					cParcTx	:=	(cAlsSe2)->E2_PARCPIS
					dDtFtGer	:=	(cAlsSe2)->&(aCmpDtFtG[2])

				//Soh quando o parametro for pela emissao, pois quando ele for
				//   pela baixa entrarah na primeira condicao (If lTx) e deve-
				//   rei desconsiderar desta.

				ElseIf nX==3 .And. (cAlsSe2)->E2_COFINS>0 .And. lBx10925
					cParcTx	:=	(cAlsSe2)->E2_PARCCOF
					dDtFtGer	:=	(cAlsSe2)->&(aCmpDtFtG[2])

				//Soh quando o parametro for pela emissao, pois quando ele for
				//   pela baixa entrarah na primeira condicao (If lTx) e deve-
				//   rei desconsiderar desta.
				ElseIf nX==4 .And. (cAlsSe2)->E2_CSLL>0 .And. lBx10925
					cParcTx	:=	(cAlsSe2)->E2_PARCSLL
					dDtFtGer	:=	(cAlsSe2)->&(aCmpDtFtG[2])
				//altera็ใo para tratar titulos do tipo CIDE.	
				ElseIf nX==5 .And. (cAlsSe2)->E2_CIDE > 0   
					cParcTx		:=	(cAlsSe2)->E2_PARCCID
					dDtFtGer	:=	(cAlsSe2)->&(aCmpDtFtG[1])
				EndIf
			EndIf
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณO tratamento acima                                                             ณ
			//ณIf lTx                                                                         ณ
			//ณ...                                                                            ณ
			//ณelse                                                                           ณ
			//ณ...                                                                            ณ
			//ณEndif                                                                          ณ
			//ณ                                                                               ณ
			//ณse da devido ao fato da query (filtro inicial) retornar tanto os titulos       ณ
			//ณ TXs quanto os titulos originais, por nao ter como controlar a origem          ณ
			//ณ dos mesmos (fato gerador).                                                    ณ
			//ณ                                                                               ณ
			//ณQuando houver titulo original(PAI):                                            ณ
			//ณ - Quando os titulos de retencao de PIS/COFINS/CSLL forem gerados              ณ
			//ณ   pela BAIXA, devo utiliza-los, por se tratar do fato gerador sempre a        ณ
			//ณ   emissao dos mesmos; neste caso, desconsidero o titulo original.             ณ
			//ณ - Quando os titulos de retencao de PIS/COFINS/CSLL forem gerados              ณ
			//ณ   pela EMISSAO, utilizo os valores contidos no proprio titulo original, NAO   ณ
			//ณ   nescessitando dos TXs que sao desconsiderados durante o processamento.      ณ
			//ณ- Quanto aos titulos de retencao de IRRF, utilizo sempre os valores dos        ณ
			//ณ  titulos originais, NAO nescessitando dos titulos TXs, que sao desconsideradosณ
			//ณ  durante o processamento.                                                     ณ
			//ณ                                                                               ณ
			//ณQuando NAO houver titulo original (TX manual sem PAI):                         ณ
			//ณ- Considero todos;                                                             ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			

			//Processo somente quando houver fator gerador calculado conforme condicao acima
			If !Empty(dDtFtGer) .And. (dDtFtGer<dDataDe .Or. dDtFtGer>dDataAte)
				//Tratamento para gerar a descricao no log somente uma vez.
				If  nX==1 .Or. nX==2	//nX==1 -> IRRF, nX==2 -> PIS/COFINS/CSLL (mesmo tratamento para os tres)
					aAddLog (@aLog,,,, dDataDe, dDataAte,,,dDtFtGer,cAlsSe2)
				EndIf
				If (cAlsSe2)->E2_CODRET $ "2430|6773"
					dDtFtGer := (cAlsSe2)->E2_EMISSAO
				Elseif !(nX==1 .And. (cAlsSe2)->E2_CODRET $ cMV_RECTRIM )  
					dDtFtGer	:=	CToD("  /  /  ")
				Endif
			EndIf
			
			If !Empty(dDtFtGer) .And. !(aIniWiz[3][25]$"Sim")				
				//Posicionamento do Cadastro de Fornecedores para envio do CNPJ e Codigo de Municipio				
				SA2->(DbSetOrder (1))
				If (SA2->(DbSeek (xFilial ("SA2")+aFornece[1]+aFornece[2])))
					cCnpjDarf	:=	SA2->A2_CGC
					cCodMun		:=	SubStr (SA2->A2_CODMUN, 1, 8)
				EndIf

				If Alltrim((cAlsSe2)->E2_ORIGEM) $ "FISA001|MATA103" .Or. Alltrim((cAlsSe2)->E2_TIPO)==cTITCPSP
					cTipo := (cAlsSe2)->E2_TIPO
				Else
					If lDp
					   cTipo := MVDUPLIC		            
					ElseIf nX==5 //TRATAMENTO PARA QUANDO FOR CID
						cTipo := "CID"
					ElseIf lGPEM670
						cTipo := ''
                    Elseif (cAlsSe2)->E2_TIPO $ MVPAGANT //PA
                        cTipo := MVTXA
					Else 
					   cTipo := MVTAXA	 		                           		   
					Endif
				EndIf
				SE2CPY->(DbSetOrder(1))
				If SE2CPY->(DbSeek(xFilial("SE2")+(cAlsSe2)->(E2_PREFIXO+E2_NUM+cParcTx+cTipo/*+E2_FORNECE+E2_LOJA*/))) //se adicionar o forncedor e loja da problema, pois os titulos de taxa utilizใo o UNIAO 
									
					//Posiciona na CCF (processo referenciado)
					lGeraR11	:= .T.  
					lAchouCCF	:= .F.
					IF lCPOCCLOK
						If CCF->(MsSeek(xFilial("CCF")+SE2CPY->(E2_NUMPRO+E2_INDPRO)))
							lAchouCCF	:= .T.
							lGeraR11	:= IIf(lDatSus,Empty(CCF->CCF_DATSUS),lGeraR11) //verifica se o titulo esta suspenso, se estiver nใo gera o R11
						Endif	
					Endif
					cCodRet	:=	AllTrim (SE2CPY->E2_CODRET)
					lIrrf		:=	AllTrim (SE2CPY->E2_NATUREZ)$cMV_IRRF

					//ณFuncao do Financeiro - FINXBX                                    ณ
					//ณRetorna uma matriz com os valores pagos ou recebidos de um tituloณ
					If lGeraR11
						aBaixa	:= SE2CPY->(Baixas(E2_NATUREZ, E2_PREFIXO, E2_NUM, E2_PARCELA, E2_TIPO, 1, "P", E2_FORNECE, dDataBase, E2_LOJA, ,E2_EMISSAO,E2_BAIXA, .F.))
					Else
						aBaixa	:= {0,0,0,0,0,0,0,0," ",0,0,0,0,0,0,0,0,0,0,0} 
					Endif		
					cChave	:= (xFilial("SE5")+SE2CPY->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA))
	
					SE5->(dbSetOrder(7))
					If aBaixa[6]>0 .And. SE5->(dbSeek(cChave))

						//While para verificar se o registro de baixa estah cancelado
						While !SE5->(Eof()) .And.;
								SE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)==cChave
							If SE5->E5_SITUACA<>"C" .And. !TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
								Exit
							EndIf
							SE5->(dbSkip())
						EndDo
	
						If !SE5->(Eof()) .And. SE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)==cChave
							lFound := .T.
							//Se o registro de baixa acima nao foi cancelado, entra neste IF para identificar se a
							//    baixa eh por AGLUTINACAO

							If !Empty(SE5->E5_AGLIMP)
								lTitAgl   := .T.
								lBxTitAgl := .F.
								cAglTipo  := ''
								cChave    := xFilial( "SE5" )+SE2CPY->(E2_NATUREZ+Iif( lIrrf,"AGL","AGP" )+iif(!EMPTY(E2_AGLIMP),E2_AGLIMP,E2_NUM))	//AGP - FINA378(PIS/COF/CSLL), AGL - FINA376(IR) // AGL - FINA381 - Agrupa IR/PIS/COFINS/CSLL
								lFound    := .F.
								aAreaSE2  := SE2->(GetArea())
								//cAglTipo:=Iif( lIrrf,"AGL","AGP" )
								//Tratamento pois pode ser aglutinado e pago em qualquer filial por este motivo retirou se o filtro de filial
								//Foi verificado junto ao financeiro
								BeginSql Alias 'AGLSE5'
									SELECT SE5.E5_FILIAL, SE5.E5_FILORIG, SE5.E5_PREFIXO, SE5.E5_NUMERO, SE5.E5_PARCELA, SE5.E5_TIPO, SE5.E5_CLIFOR, SE5.E5_LOJA, SE5.E5_SEQ, SE5.E5_SITUACA, SE5.E5_NATUREZ, SE5.E5_VALOR, SE5.E5_VLJUROS, SE5.E5_VLMULTA
									FROM
										%Table:SE5% SE5
									WHERE
										SE5.E5_NUMERO = %Exp:SE5->E5_AGLIMP% AND
										SE5.E5_TIPO IN (%Exp:MVTAXA%,%Exp:MVTXA%) AND
										SE5.E5_PREFIXO IN ('AGL','AGP')  AND
										SE5.E5_NATUREZ = %Exp:SE2CPY->E2_NATUREZ% AND
										SE5.%NotDel%
								EndSql

								If lA978PRF
									cChave := ExecBlock("A978PRF",.F.,.F.,cChave)
									SE5->(dbSetOrder(4))
									If SE5->(dbSeek(cChave))	//Pesquiso codigo do processo de aglutinacao
										cChave	:=	xFilial( "SE5" )+SE5->(E5_NATUREZ+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)
										While !SE5->(Eof()) .And.;
												SE5->(E5_FILIAL+E5_NATUREZ+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)==cChave
											//Verifico se a baixa por aglutinacao no momento teve um cancelamento, se nao, trata-se de uma baixa original
											If SE5->E5_SITUACA<>"C" .And. !TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ),,SE5->E5_FILIAL)
												lBxTitAgl	:=	.T.
												//Tratamento para aglutinar todas as baixas por AGLUTINACAO do SE5 em um unico registro R11.
												//Presume-se que cada titulo aglutinado corresponde a uma DARF.
												If aScan( aBxTitAgl,{|aX| aX[1]==SE5->E5_NUMERO .And. aX[3]==SE2CPY->E2_CODRET} )==0
													cBxTitAgl	:=	Soma1( cBxTitAgl )
													aAdd( aBxTitAgl,{SE5->E5_NUMERO,cBxTitAgl,SE2CPY->E2_CODRET} )
												EndIf
												nPTitAgl	:=	aScan( aBxTitAgl,{|aX| aX[1]==SE5->E5_NUMERO .And. aX[3]==SE2CPY->E2_CODRET} )
												aBaixa[3]	:=	(SE5->E5_VLJUROS/(SE5->E5_VALOR-SE5->E5_VLJUROS-SE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR JUROS
												aBaixa[4]	:=	(SE5->E5_VLMULTA/(SE5->E5_VALOR-SE5->E5_VLJUROS-SE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR MULTA
												aBaixa[6]	:=	SE5->E5_VALOR	//VALOR BAIXA
												lFound      := .T.
												Exit
											EndIf
											SE5->(dbSkip())
										EndDo
									EndIf
								EndIf

								cChave := ''
								While !AGLSE5->(Eof())
									If SE2->(DbSeek(xFilial('SE2',AGLSE5->E5_FILORIG)+AGLSE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA))) .And. SE2->E2_CODRET == SE2CPY->E2_CODRET //---Devido ao fato de o tํtulo aglutinado poder estar em filial diferente da que estแ sendo processada, nใo trouxe o registro SE2 correspondente via JOIN na query, e sim posicionando via DbSeek---//

										//Verifico se a baixa por aglutinacao no momento teve um cancelamento, se nao, trata-se de uma baixa original
										If AGLSE5->E5_SITUACA<>"C" .And. !TemBxCanc(AGLSE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ),,AGLSE5->E5_FILIAL)
											lBxTitAgl	:=	.T.
											//Tratamento para aglutinar todas as baixas por AGLUTINACAO do SE5 em um unico registro R11.
											//Presume-se que cada titulo aglutinado corresponde a uma DARF.
											If aScan( aBxTitAgl,{|aX| aX[1]==AGLSE5->E5_NUMERO .And. aX[3]==SE2CPY->E2_CODRET} )==0
												cBxTitAgl	:=	Soma1( cBxTitAgl )
												aAdd( aBxTitAgl,{AGLSE5->E5_NUMERO,cBxTitAgl,SE2CPY->E2_CODRET} )
											EndIf
											nPTitAgl	:=	aScan( aBxTitAgl,{|aX| aX[1]==AGLSE5->E5_NUMERO .And. aX[3]==SE2CPY->E2_CODRET} )
											aBaixa[3]	:=	(AGLSE5->E5_VLJUROS/(AGLSE5->E5_VALOR-AGLSE5->E5_VLJUROS-AGLSE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR JUROS
											aBaixa[4]	:=	(AGLSE5->E5_VLMULTA/(AGLSE5->E5_VALOR-AGLSE5->E5_VLJUROS-AGLSE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR MULTA
											aBaixa[6]	:=	AGLSE5->E5_VALOR	//VALOR BAIXA
											cChave      :=  AGLSE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) //7	E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ
											Exit
										EndIf

									EndIf
									AGLSE5->(dbSkip())
								EndDo
								AGLSE5 -> (DbCloseArea())
								RestArea(aAreaSE2)

							ElseIf SE5->E5_MOTBX == "FAT"

								lTitAgl   := .T.
								lBxTitAgl := .F.
								
								//Tratamento pois pode ser aglutinado e pago em qualquer filial por este motivo retirou se o filtro de filial
								//Mesmo cenแrio da Baixa por Aglutina็ใo
								BeginSql Alias 'FATSE5'
									SELECT SE5.E5_FILIAL, SE5.E5_FILORIG, SE5.E5_PREFIXO, SE5.E5_NUMERO, SE5.E5_PARCELA, SE5.E5_TIPO, SE5.E5_CLIFOR, SE5.E5_LOJA, SE5.E5_SEQ, SE5.E5_SITUACA, SE5.E5_NATUREZ, SE5.E5_VALOR, SE5.E5_VLJUROS, SE5.E5_VLMULTA
									FROM
										%Table:SE5% SE5
									WHERE 
										SE5.E5_CLIFOR  = %Exp:SE2CPY->E2_FATFOR%   	AND
										SE5.E5_PREFIXO = %Exp:SE2CPY->E2_FATPREF%   AND
										SE5.E5_NUMERO  = %Exp:SE2CPY->E2_FATURA%	AND
										SE5.E5_TIPO    = %Exp:SE2CPY->E2_TIPOFAT%  	AND
										SE5.%NotDel%
								EndSql

								cChave := ''
								While !FATSE5->(Eof())

									//Verifico se a baixa por aglutinacao no momento teve um cancelamento, se nao, trata-se de uma baixa original
									If FATSE5->E5_SITUACA<>"C" .And. !TemBxCanc(FATSE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ),,FATSE5->E5_FILIAL)
										lBxTitAgl	:=	.T.
										//Tratamento para aglutinar todas as baixas por AGLUTINACAO do SE5 em um unico registro R11.
										aBaixa[3]	:=	(FATSE5->E5_VLJUROS/(FATSE5->E5_VALOR-FATSE5->E5_VLJUROS-FATSE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR JUROS
										aBaixa[4]	:=	(FATSE5->E5_VLMULTA/(FATSE5->E5_VALOR-FATSE5->E5_VLJUROS-FATSE5->E5_VLMULTA))*SE2CPY->E2_VALOR //VALOR MULTA
										aBaixa[6]	:=	FATSE5->E5_VALOR	//VALOR BAIXA
										cChave      :=  FATSE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) //7	E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ
										Exit
									EndIf

									FATSE5->(dbSkip())
								EndDo
								FATSE5 -> (DbCloseArea())

							Endif
						Endif
					Endif
					//A geracao dos codigos de receita abaixo separados se deve a versao TRIMESTRAL nao comportar o 5952
					If (AllTrim (SE2CPY->E2_NATUREZ)$cMV_PIS)
						If !(l5952)
							cCodRet	:=	"5979"
						EndIf
					ElseIf (AllTrim (SE2CPY->E2_NATUREZ)$cMV_COFINS)
						If !(l5952)
							cCodRet	:=	"5960"
						EndIf
					ElseIf (AllTrim (SE2CPY->E2_NATUREZ)$cMV_CSLL)
						If !(l5952)
							cCodRet	:=	"5987"
						EndIf
					EndIf

					//Atribuicao da Periodocidade e Variacao do codigo de receita utilizado na DCTF.
					//   pode ser de acordo com o parametro MV_DCTF ou os campos na tabela SE2.
					If !Empty(SE2CPY->E2_VARIAC) .And. !Empty(SE2CPY->E2_PERIOD)
						cCodRetVar	:=	cCodRet + StrZero(SE2CPY->E2_VARIAC, 2)
						cPeriod	:=	AllTrim (SE2CPY->E2_PERIOD)
					Else
						If !Empty (cCodRet)
							If (Len (aRegra)>0)
								If (aScan (aRegra, {|aZZZ| cCodRet$aZZZ[1]})>0)
									cCodRetVar	:=	SubStr (aRegra[aScan (aRegra, {|aZZZ| cCodRet$aZZZ[1]})][2], 1, 6)
									cPeriod	:=	SubStr (aRegra[aScan (aRegra, {|aZZZ| cCodRet$aZZZ[1]})][2], 7, 1)
								EndIf
							EndIf
						EndIf
					EndIf
					aAddLog (@aLog, cCodRet, cCodRetVar)

					//Retornando o ultimo dia util do periodo de apuracao para o fato gerador de acordo com
					//   a periodicidade do codigo de receita utilizado.
					dDtApur     := RetDtApur (dDtFtGer, Alltrim(SE2CPY->E2_NATUREZ), cPeriod, lLei11196)
					cAnoApu		:=	StrZero (Year (dDtApur), 4)
					cMesApu		:=	StrZero (MBTQS (cPeriod, dDtApur), 2)
					cR10_DSQD	:=	StrZero (DSQD (cPeriod, dDtApur), 2)
					cGrpTrib		:=	RetGrpTrib (cDctf, SE2CPY->E2_CODRET, SE2CPY->E2_NATUREZ) 
					cCnpjEstab	:=	StrZero (0, 6)
					If (AllTrim (cGrpTrib)$"#03#09#")
						cCnpjEstab	:=	Right (SM0->M0_CGC, 6)
					Endif
					//Log para identificacao do possivel erro na importacao do meio-magnetico
					If Empty(cGrpTrib)
						aAddLog (@aLog,,,, dDataDe, dDataAte,,,,,cGrpTrib)
					EndIf

					If !lFound .And. !Empty(cChave)
						//Localiza registro de compensa็ใo
						SE5->(dbSetOrder(7)) 
						If SE5->(dbSeek(cChave))
							While !SE5->(Eof()) .And.;
									SE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)==cChave
								If SE5->E5_SITUACA<>"C" .And. !TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ),,SE5->E5_FILIAL)
									lFound := .T.
									Exit
								EndIf
								SE5->(dbSkip())
							EndDo
						EndIf
					EndIf

					If lFound .And. (AllTrim(SE5->E5_TIPODOC)=="CP" .Or. AllTrim(SE5->E5_TIPO)==cTITCPSP)
						cPROCESSO := ''
						If !Empty(SE2CPY->E2_NUMPRO)
							cPROCESSO := SE2CPY->(E2_NUMPRO + E2_INDPRO)
						Else
							SE2->(DbSetOrder(1))
							If SE2->(DbSeek(xFilial("SE2")+SE5->(E5_DOCUMEN)))
								cPROCESSO := SE2->(E2_NUMPRO + E2_INDPRO)
							Endif
						Endif
						//Processo referenciado
						If !Empty(cPROCESSO) .And. CCF->(MsSeek(xFilial("CCF")+SE2CPY->(cPROCESSO)))
							aInfComp[1] := "S"
							aInfComp[2] := IIf(lCFFOK,IIf(CCF->CCF_TPCOMP=="2","1",CCF->CCF_TPCOMP),"")
							aInfComp[3] := IIf(lCFFOK,CCF->CCF_NRDCOM,"")
							aInfComp[5] := IIf(lCFFOK.And.!Empty(CCF->CCF_TIPCOM),IIf(CCF->CCF_TIPCOM=="2","1",CCF->CCF_TIPCOM),"1")
							aInfComp[6] := IIf(lCFFOK,CCF->CCF_TIPCRE,"")
						Endif
					Endif

					//Tratamento para o PE quando se optar por utilizar a compensacao
					If lA978COMP
						aInfComp	:=	{"N", "", "", .T.}
						aInfComp	:=	ExecBlock ("A978COMP", .F., .F., {"SE2CPY", aBaixa, aFornece, cCodRetVar, DSQD (cPeriod, dDtApur), dDtApur, MBTQS (cPeriod, dDtApur), cPeriod, Val(cCnpjDarf), cCodMun, cCodRet})
						//tratamento de erro, caso o array nao retorne o padrao
						If (aInfComp==Nil) .Or. (Len (aInfComp)<>4) .Or. (aInfComp[4])
							aInfComp	:=	{"N","","", .T.}
						EndIf
						If Len(aInfComp)==4
							AADD(aInfComp, "1")
							AADD(aInfComp, "1")
						EndIf
					EndIf

					//Existino o PE A978COMP o indice 4 do array retornado deverah ser .T. para
					//   gravar as informacoes do titulo TX, quando o PE nao existir, esta posicao
					//   sempre serah .T., pois serah tratado pelo PADRAO.
					If (aInfComp[4])
						If !Empty( SE2CPY->E2_CODAGL )
							cCodAgl	:= SE2CPY->E2_CODAGL
						Else
							If lTitAgl .And. lBxTitAgl .And. nPTitAgl>0
								cCodAgl	:= aBxTitAgl[nPTitAgl][2]
							Else
								cCodAgl	:= ""
							EndIf
						Endif
						//Se a moeda for 2 (dolar) e o tํtulo nao foi baixado, entao nao houve a conversao
						//para real e nao sera gerado R11. Nao deve ser gerado R10 c/ valor zerado.
						If !(SE2CPY->E2_MOEDA == 2 .And. aBaixa[6] == 0)
							//Cria R10
							If !lTriAnt
								If lA978R10
									cChave	:= (xFilial("SE5")+SE2CPY->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA))
									lR10 := ExecBlock("A978R10", .F., .F., cChave)
								Endif
								If lR10 .And. (!cCodRet $cMVRFB2137 .Or. lInRfb2137)

								    lReclock := R10->(DbSeek(cGrpTrib+StrZero(Val(cCodRetVar),6)+cPeriod+StrZero(Val(cAnoApu),4)+StrZero(Val(cMesApu),2)+StrZero(Val(cR10_DSQD),2)+StrZero(Val(cCnpjEstab),6)   ))
									
									If !SE2CPY->E2_PREFIXO $ 'AGL#AGP'
										nSdoQuota := VerSdoQuota(SE2CPY->E2_PREFIXO,SE2CPY->E2_NUM,cTipo)
										If !lReclock
											RecLock ("R10", .T.)
											R10->R10_GRPTRI	:=	Val(cGrpTrib)
											R10->R10_CODREC	:=	Val(cCodRetVar)
											R10->R10_PERIOD	:=	cPeriod
											R10->R10_ANOAPU	:=	Val(cAnoApu)
											R10->R10_MESAPU	:=	Val(cMesApu)
											R10->R10_DSQD	:=	Val(cR10_DSQD)
											R10->R10_CNPJES	:=	Val(cCnpjEstab)
											R10->R10_BALRED	:=	0
											R10->R10_SALCOT	:=	nSdoQuota
										Else
											RecLock ("R10", .F.)
										EndIf
										//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao
										//ou quando for e a formalizacao for 3
										If ("S"$aInfComp[1] .And. aInfComp[2]$"13") .Or. ("N"$aInfComp[1])
											R10->R10_VLRDEB	+= SE2CPY->E2_VALOR
										EndIf
										MsUnLock ()
										aAddLog (@aLog,,cCodRetVar,,,,,,,,,.T.)
									EndIf
								EndIf
							Else //Cria R20/R30
								If Right(SE2CPY->E2_PARCELA,1)$"234" //Quotas
									If !SE2CPY->E2_PREFIXO $ 'AGL#AGP'
										RecLock ("R30", .T.)
										R30->R30_GRPTRI	:=	Val(cGrpTrib)
										R30->R30_CODREC	:=	Val(cCodRetVar)
										R30->R30_PERIOD	:=	cPeriod
										R30->R30_ANOAPU	:=	Val(cAnoApu)
										R30->R30_TRIAPU	:=	cTriApuAnt
										R30->R30_NROQTA	:=	Str(Val(SE2CPY->E2_PARCELA)-1,1)
										R30->R30_CNPJES	:=	Val(cCnpjEstab)
										MsUnLock ()
										//Atualiza valor
										If R20->(DbSeek(StrZero(Val(cGrpTrib),2)+StrZero(Val(cCodRetVar),6)+cPeriod+StrZero(Val(cAnoApu),4)+cTriApuAnt))
											RecLock ("R20", .F.)
											//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao
											//ou quando for e a formalizacao for 3
											If ("S"$aInfComp[1] .And. aInfComp[2]$"13") .Or. ("N"$aInfComp[1])
												R20->R20_VLRDEB	+= SE2CPY->E2_VALOR
												R20->R20_QTDCOT	:= Val(SE2CPY->E2_PARCELA)-1
											EndIf
											MsUnLock ()
										EndIf
									EndIf
								Else
									lReclock := R20->(DbSeek(StrZero(Val(cGrpTrib),2)+StrZero(Val(cCodRetVar),6)+cPeriod+StrZero(Val(cAnoApu),4)+cTriApuAnt))
									If !SE2CPY->E2_PREFIXO $ 'AGL#AGP'
										If !lReclock
											RecLock ("R20", .T.)
											R20->R20_GRPTRI	:=	Val(cGrpTrib)
											R20->R20_CODREC	:=	Val(cCodRetVar)
											R20->R20_PERIOD	:=	cPeriod
											R20->R20_ANOAPU	:=	Val(cAnoApu)
											R20->R20_TRIAPU	:=	cTriApuAnt
											R20->R20_QTDCOT	:=	2
											R20->R20_SCPINC	:=	"0"
											R20->R20_CNPJES	:=	Val(cCnpjEstab)
										Else
											RecLock ("R20", .F.)
										EndIf
										//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao
										//ou quando for e a formalizacao for 3
										If ("S"$aInfComp[1] .And. aInfComp[2]$"13")  .Or. ("N"$aInfComp[1])
											R20->R20_VLRDEB	+= SE2CPY->E2_VALOR
										EndIf
										MsUnLock ()
									EndIf
								EndIf
							EndIf
						EndIf
						
						//Verifico se houve pagamento para gerar o R11
						If nSdoQuota==0 .And. aBaixa[6]>0 .And. ((!lTitAgl .And. SE2CPY->E2_PREFIXO <>'AGL' .And. SE2CPY->E2_PREFIXO <>'AGP') .Or. (lTitAgl .And. lBxTitAgl))
							//R11
							If !lTriAnt								

								//Se utiliza็ใo da FI9 estiver habilitado, e o tํtulo foi considerado na aglutina็ใo, foi baixado e nใo ter o ID da DARF
								//o registro R11 serแ gerado considerando os valores do tํtulo original e nใo da FI9.
								lProcFI9	:= lFI9								
								If lFI9 .AND. lTitAgl .AND. lBxTitAgl .AND. Empty(SE2CPY->E2_IDDARF)								
									lProcFI9	:= .F.
								EndIF
								
								//Registro 11 nao deve ser aglutinado conforme: 
								//- Instrucao Preenchimento, Pasta Debito/Credito, 7.3-Ficha Pagamento, item 2								
								If lProcFI9
									dbSelectArea("FI9")
									dbsetorder(1) //FI9_FILIAL+FI9_IDDARF+FI9_STATUS
									FI9->(Dbseek(xFilial("FI9")+SE2CPY->E2_IDDARF+"B"))
									While !FI9->(Eof()) .And. SE2CPY->(E2_FILIAL+E2_IDDARF) == FI9->(FI9_FILIAL+FI9_IDDARF)
										If FI9->(FI9_PREFIX+FI9_NUM+FI9_PARCEL+FI9_TIPO) == SE2CPY->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO) .And. FI9->FI9_STATUS $ "B"
											bFind := { || !(R11->(DbSeek (FI9->(FI9_FILIAL+FI9_IDDARF)))) }
											R11->(dbSetOrder(2))
											If Eval(bFind)
												RecLock ("R11", .T.)
												R11->R11_CODAGL := cCodAgl                 //Codigo Aglutinador
												R11->R11_FILIAL := FI9->FI9_FILIAL
												R11->R11_IDDARF := FI9->FI9_IDDARF			//Codigo do DARF no Sistema
												R11->R11_GRPTRI := Val (cGrpTrib)
												R11->R11_CODREC := Val (cCodRetVar)
												R11->R11_PERIOD := cPeriod
												R11->R11_ANOAPU := Val (cAnoApu)
												R11->R11_MESAPU := Val (cMesApu)
												R11->R11_DSQD   := Val (cR10_DSQD)
												R11->R11_CNPJES := Val (cCnpjEstab)
												R11->R11_COMP   := aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
												R11->R11_FORMAL := aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
												R11->R11_NUMERO := aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
												R11->R11_REGCOM := aInfComp[5]		//TIPO DE COMPENSACAO
												R11->R11_TIPCRE := aInfComp[6]		//TIPO CREDITO
												R11->R11_VLRPRI := FI9->FI9_VALOR
												R11->R11_VLRMUL := aBaixa[4]
												R11->R11_VLRJUR := aBaixa[3]
												R11->R11_VLRPAG := FI9->FI9_VALOR
												If ("4028"$cCodRet)
													R11->R11_NUMRER := cCodMun
												Else
													R11->R11_NUMRER := ""
												EndIf
												//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando	for e a formalizacao for 3
												//COMPENSACAO possui tratamento atraves do PE A978COMP
												If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
													//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
													If (AllTrim (cGrpTrib)$"#03#09#")
														R11->R11_CNPJDA := SM0->M0_CGC
													Else
														R11->R11_CNPJDA := cCnpjMat
													EndIf
													R11->R11_PERAPU := dDtApur
													R11->R11_CODRE2 := Val (SE2CPY->E2_CODRET)
													R11->R11_DTVENC := SE2CPY->E2_VENCREA
												EndIf
											Else
												RecLock ("R11", .F.)
												R11->R11_VLRPRI += FI9->FI9_VALOR
												R11->R11_VLRMUL += aBaixa[4]
												R11->R11_VLRJUR += aBaixa[3]
												R11->R11_VLRPAG += FI9->FI9_VALOR
											Endif
											MsUnLock ()
										EndIf
										R11->(dbSetOrder(1))
										FI9->(dbSkip())
									EndDo
								Else
									If Empty(cCodAgl)
										bFind := { || .T. }
									Else
										bFind := { || !(R11->(DbSeek (cCodAgl))) }
									Endif
									R11->(dbSetOrder(3))
									//So podemos aglutinar o R11 quando se tratar de PCC - Cod. 5952.
									lAglutinaR11 := "5952"$cCodRetVar
									If lAglutinaR11
										// Posiciono no ultimo registro da tabela R11 e volto para verificar se 
										// exite algum registro para agrutinacao dentro do Titulo principal
										R11->(DbGoBottom())
										For nY := 1 To If(nX > 1 , nX - 1 ,nX)
											If  nX == 1
												lAglutinaR11 := .F.
												Exit
											ElseIf R11->R11_CODREC == Val(cCodRetVar)
												lAglutinaR11 := .T.
												Exit
											Else
												lAglutinaR11 := .F.
											EndIf
											R11->(DbSkip(-1))
										Next nY
									EndIf
									If Eval(bFind)
										lAglutinaR11 := .F.
									EndIf
									If Eval(bFind) .And. !lAglutinaR11
										RecLock ("R11", .T.)
										R11->R11_CODAGL := cCodAgl			//Codigo Aglutinador
										R11->R11_GRPTRI := Val(cGrpTrib)
										R11->R11_CODREC := Val(cCodRetVar)
										R11->R11_PERIOD := cPeriod
										R11->R11_ANOAPU := Val(cAnoApu)
										R11->R11_MESAPU := Val(cMesApu)
										R11->R11_DSQD   := Val(cR10_DSQD)
										R11->R11_CNPJES := Val(cCnpjEstab)
										R11->R11_COMP   := aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
										R11->R11_FORMAL := aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
										R11->R11_NUMERO := aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
										R11->R11_REGCOM := aInfComp[5]		//TIPO DE COMPENSACAO
										R11->R11_TIPCRE := aInfComp[6]		//TIPO CREDITO
										If ("4028"$cCodRet)
											R11->R11_NUMRER := cCodMun
										Else
											R11->R11_NUMRER := ""
										EndIf
										//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando	for e a formalizacao for 3
										//COMPENSACAO possui tratamento atraves do PE A978COMP
										If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
											//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
											If (AllTrim (cGrpTrib)$"#03#09#")
												R11->R11_CNPJDA := SM0->M0_CGC
											Else
												R11->R11_CNPJDA := cCnpjMat
											End If
											R11->R11_PERAPU := dDtApur
											R11->R11_CODRE2 := Val(SE2CPY->E2_CODRET)
											R11->R11_DTVENC := SE2CPY->E2_VENCREA
										EndIf
									Else
										RecLock ("R11", .F.)
									Endif
									// Realizado esse tratamento por que identificamos que quando o motivo da baixa ้ fatura ,o  arquivo ้ gerado varios R11 para cada tributo, nใo temos a certeza  se esse processo esta correto, acreditomos que deveria ser somente 1 R11 aglutinado tamb้mm, mas precisa ser melhor avalidao.
									// Portanto estamos mantendo a regra conforme issue DSERFIS1-29444
									If SE5->E5_MOTBX == "FAT"
										R11->R11_VLRPRI += SE2CPY->E2_VALOR
										R11->R11_VLRPAG += SE2CPY->E2_VALOR
									Else									
										R11->R11_VLRPRI += aBaixa[10] // Altera็ใo realizada na issue Dserfis1-30234 , onde o valor rdo R11 aglutinado esta recuperando valor do SE2, mas o R11 ้ referente a baixa nesse caso podemo usar o retorno da query AGLSE5 onde grava no array aBAixas.
										R11->R11_VLRPAG += aBaixa[10] // Altera็ใo realizada na issue Dserfis1-30234 , onde o valor rdo R11 aglutinado esta recuperando valor do SE2, mas o R11 ้ referente a baixa nesse caso podemo usar o retorno da query AGLSE5 onde grava no array aBAixas.
									Endif

									R11->R11_VLRMUL += aBaixa[4]
									R11->R11_VLRJUR += aBaixa[3]

									MsUnLock ()
									R11->(dbSetOrder(1))
								EndIF

							Else

								If Right(SE2CPY->E2_PARCELA,1)$"234" //Quotas
									If GetNewPar("MV_USAFI9",.F.) .And. AliasIndic("FI9")
										dbSelectArea("FI9")
										dbsetorder(1) //FI9_FILIAL+FI9_IDDARF+FI9_STATUS
										FI9->(Dbseek(xFilial("FI9")+SE2CPY->E2_IDDARF+"B"))
										While !FI9->(Eof()) .And. SE2CPY->(E2_FILIAL+E2_IDDARF) == FI9->(FI9_FILIAL+FI9_IDDARF)
											If FI9->(FI9_PREFIX+FI9_NUM+FI9_PARCEL+FI9_TIPO) == SE2CPY->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO) .And. FI9->FI9_STATUS $ "B"
												bFind := { || !(R31->(DbSeek (FI9->FI9_IDDARF))) }
												R31->(dbSetOrder(2))
												If Eval(bFind)
													RecLock ("R31", .T.)
													R31->R31_CODAGL	:=	cCodAgl                 //Codigo Aglutinador
													R31->R31_IDDARF	:=	FI9->FI9_IDDARF			//Codigo do DARF no Sistema
													R31->R31_GRPTRI	:=	Val(cGrpTrib)
													R31->R31_CODREC	:=	Val(cCodRetVar)
													R31->R31_PERIOD	:=	cPeriod
													R31->R31_ANOAPU	:=	Val(cAnoApu)
													R31->R31_TRIAPU	:=	cTriApuAnt
													R31->R31_DSQD		:=	Val(cR10_DSQD)
													R31->R31_CNPJES	:=	Val(cCnpjEstab)
													R31->R31_COMP		:=	aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R31->R31_FORMAL	:=	aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R31->R31_NUMERO	:=	aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R31->R31_REGCOM	:=	aInfComp[5]		//TIPO DE COMPENSACAO
													R31->R31_TIPCRE 	:=	aInfComp[6]		//TIPO CREDITO
													R31->R31_VLRPRI	:=	FI9->FI9_VALOR
													R31->R31_VLRMUL	:=	aBaixa[4]
													R31->R31_VLRJUR	:=	aBaixa[3]
													R31->R31_VLRPAG	:=	FI9->FI9_VALOR
													If ("4028"$cCodRet)
														R31->R31_NUMRER	:=	cCodMun
													Else
														R31->R31_NUMRER	:=	""
													EndIf
													//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando	for e a formalizacao for 3
													//COMPENSACAO possui tratamento atraves do PE A978COMP
													If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
														//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
														If (AllTrim (cGrpTrib)$"#03#09#")
															R31->R31_CNPJDA	:=	SM0->M0_CGC
														Else
															R31->R31_CNPJDA	:=	cCnpjMat
														EndIf
														R31->R31_PERAPU	:=	dDtApur
														R31->R31_CODRE2	:=	Val(SE2CPY->E2_CODRET)
														R31->R31_DTVENC	:=	SE2CPY->E2_VENCREA
													EndIf
												Else
													RecLock ("R31", .F.)
													R31->R31_VLRPRI	+=	FI9->FI9_VALOR
													R31->R31_VLRMUL	+=	aBaixa[4]
													R31->R31_VLRJUR	+=	aBaixa[3]
													R31->R31_VLRPAG	+=	FI9->FI9_VALOR
													MsUnLock()
												Endif
											EndIf
											R31->(dbSetOrder(1))
											FI9->(dbSkip())
										EndDo
									Else

										If Empty(cCodAgl)
											bFind := { || .T. }
										Else
											bFind := { || !(R31->(DbSeek (cCodAgl))) }
										Endif
										R31->(dbSetOrder(2))
										If Eval(bFind)
											RecLock ("R31", .T.)
											R31->R31_CODAGL	:=	cCodAgl			//Codigo Aglutinador
											R31->R31_GRPTRI	:=	Val(cGrpTrib)
											R31->R31_CODREC	:=	Val(cCodRetVar)
											R31->R31_PERIOD	:=	cPeriod
											R31->R31_ANOAPU	:=	Val(cAnoApu)
											R31->R31_TRIAPU	:=	cTriApuAnt
											R31->R31_CNPJES	:=	Val(cCnpjEstab)
											R31->R31_COMP		:=	aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R31->R31_FORMAL	:=	aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R31->R31_NUMERO	:=	aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R31->R31_REGCOM	:=	aInfComp[5]		//TIPO DE COMPENSACAO
											R31->R31_TIPCRE 	:=	aInfComp[6]		//TIPO CREDITO
											R31->R31_NROQTA	:=	Str(Val(SE2CPY->E2_PARCELA)-1,1)
											If ("4028"$cCodRet)
												R31->R31_NUMRER	:=	cCodMun
											Else
												R31->R31_NUMRER	:=	""
											EndIf
											//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando for e a formalizacao for 3
											//COMPENSACAO possui tratamento atraves do PE A978COMP
											If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
												//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
												If (AllTrim (cGrpTrib)$"#03#09#")
													R31->R31_CNPJDA	:=	SM0->M0_CGC
												Else
													R31->R31_CNPJDA	:=	cCnpjMat
												End If
												R31->R31_PERAPU	:=	dDtApur
												R31->R31_CODRE2	:=	Val(SE2CPY->E2_CODRET)
												R31->R31_DTVENC	:=	SE2CPY->E2_VENCREA
											EndIf
										Else
											RecLock ("R31", .F.)
										Endif
										R31->R31_VLRPRI	+=	SE2CPY->E2_VALOR
										R31->R31_VLRMUL	+=	aBaixa[4]
										R31->R31_VLRJUR	+=	aBaixa[3]
										R31->R31_VLRPAG	+=	SE2CPY->E2_VALLIQ
										MsUnLock ()
										R31->(dbSetOrder(1))
									EndIF
								Else
								//Registro R21
									If GetNewPar("MV_USAFI9",.F.) .And. AliasIndic("FI9")
										dbSelectArea("FI9")
										dbsetorder(1) //FI9_FILIAL+FI9_IDDARF+FI9_STATUS
										FI9->(Dbseek(xFilial("FI9")+SE2CPY->E2_IDDARF+"B"))
										While !FI9->(Eof()) .And. SE2CPY->E2_IDDARF == FI9->FI9_IDDARF
											If FI9->(FI9_PREFIX+FI9_NUM+FI9_PARCEL+FI9_TIPO) == SE2CPY->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO) .And. FI9->FI9_STATUS $ "B"
												bFind := { || !(R21->(DbSeek (FI9->FI9_IDDARF))) }
												R21->(dbSetOrder(2))
												If Eval(bFind)
													RecLock ("R21", .T.)
													R21->R21_CODAGL	:=	cCodAgl                 //Codigo Aglutinador
													R21->R21_IDDARF	:=	FI9->FI9_IDDARF			//Codigo do DARF no Sistema
													R21->R21_GRPTRI	:=	Val(cGrpTrib)
													R21->R21_CODREC	:=	Val(cCodRetVar)
													R21->R21_PERIOD	:=	cPeriod
													R21->R21_ANOAPU	:=	Val(cAnoApu)
													R21->R21_TRIAPU	:=	cTriApuAnt
													R21->R21_DSQD		:=	Val(cR10_DSQD)
													R21->R21_CNPJES	:=	Val(cCnpjEstab)
													R21->R21_COMP		:=	aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R21->R21_FORMAL	:=	aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R21->R21_NUMERO	:=	aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
													R21->R21_REGCOM	:=	aInfComp[5]		//TIPO DE COMPENSACAO
													R21->R21_TIPCRE 	:=	aInfComp[6]		//TIPO CREDITO
													R21->R21_VLRPRI	:=	FI9->FI9_VALOR
													R21->R21_VLRMUL	:=	aBaixa[4]
													R21->R21_VLRJUR	:=	aBaixa[3]
													R21->R21_VLRPAG	:=	FI9->FI9_VALOR
													If ("4028"$cCodRet)
														R21->R21_NUMRER	:=	cCodMun
													Else
														R21->R21_NUMRER	:=	""
													EndIf
													//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando	for e a formalizacao for 3
													//COMPENSACAO possui tratamento atraves do PE A978COMP
													If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
														//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
														If (AllTrim (cGrpTrib)$"#03#09#")
															R21->R21_CNPJDA	:=	SM0->M0_CGC
														Else
															R21->R21_CNPJDA	:=	cCnpjMat
														EndIf
														R21->R21_PERAPU	:=	dDtApur
														R21->R21_CODRE2	:=	Val(SE2CPY->E2_CODRET)
														R21->R21_DTVENC	:=	SE2CPY->E2_VENCREA
													EndIf
												Else
													RecLock ("R21", .F.)
													R21->R21_VLRPRI	+=	FI9->FI9_VALOR
													R21->R21_VLRMUL	+=	aBaixa[4]
													R21->R21_VLRJUR	+=	aBaixa[3]
													R21->R21_VLRPAG	+=	FI9->FI9_VALOR
													MsUnLock()
												Endif
											EndIf
											R21->(dbSetOrder(1))
											FI9->(dbSkip())
										EndDo
									Else
										If Empty(cCodAgl)
											bFind := { || .T. }
										Else
											bFind := { || !(R21->(DbSeek (cCodAgl))) }
										Endif
										R21->(dbSetOrder(2))

										If Eval(bFind)
											RecLock ("R21", .T.)
											R21->R21_CODAGL	:=	cCodAgl			//Codigo Aglutinador
											R21->R21_GRPTRI	:=	Val(cGrpTrib)
											R21->R21_CODREC	:=	Val(cCodRetVar)
											R21->R21_PERIOD	:=	cPeriod
											R21->R21_ANOAPU	:=	Val(cAnoApu)
											R21->R21_TRIAPU	:=	cTriApuAnt
											R21->R21_CNPJES	:=	Val(cCnpjEstab)
											R21->R21_COMP		:=	aInfComp[1]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R21->R21_FORMAL	:=	aInfComp[2]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R21->R21_NUMERO	:=	aInfComp[3]		//COMPENSACAO possui tratamento atraves do PE A978COMP
											R21->R21_REGCOM	:=	aInfComp[5]		//TIPO DE COMPENSACAO
											R21->R21_TIPCRE 	:=	aInfComp[6]		//TIPO CREDITO

											If ("4028"$cCodRet)
												R21->R21_NUMRER	:=	cCodMun
											Else
												R21->R21_NUMRER	:=	""
											EndIf
											//Regra na validacao - Somente deverah ser preenchido quando nao for compensacao ou quando for e a formalizacao for 3
											//COMPENSACAO possui tratamento atraves do PE A978COMP
											If ("S"$aInfComp[1] .And. "3"$aInfComp[2]) .Or. ("N"$aInfComp[1])
												//Quando nao for IPI ou CIDE o CNPJ do DARF deverแ ser o mesmo do contribuinte. Caso contrario sera acusado erro no validador
												If (AllTrim (cGrpTrib)$"#03#09#")
													R21->R21_CNPJDA	:=	SM0->M0_CGC
												Else
													R21->R21_CNPJDA	:=	cCnpjMat
												End If
												R21->R21_PERAPU	:=	dDtApur
												R21->R21_CODRE2	:=	Val(SE2CPY->E2_CODRET)
												R21->R21_DTVENC	:=	SE2CPY->E2_VENCREA
											EndIf
										Else
											RecLock ("R21", .F.)
										Endif
										R21->R21_VLRPRI	+=	SE2CPY->E2_VALOR
										R21->R21_VLRMUL	+=	aBaixa[4]
										R21->R21_VLRJUR	+=	aBaixa[3]
										R21->R21_VLRPAG	+=	SE2CPY->E2_VALLIQ
										MsUnLock ()
										R21->(dbSetOrder(1))
									EndIF
								Endif
							EndIf
						Endif
					Endif
					//Para gerar o registro R14 ้ verificado o campo E2_DATASUS ou o campo CCF_DATSUS
					//ษ necessแrio existir um Processo referenciado
					If (lAchouCCF .And. lCPOCCLOK .And. !Empty(SE2CPY->E2_DATASUS)) .Or. (lDatSus .And. !Empty(CCF->CCF_DATSUS))
						RecLock ("R14", .T.)
						R14->R14_GRPTRI	:=	Val(cGrpTrib)
						R14->R14_CODREC	:=	Val(cCodRetVar)
						R14->R14_PERIOD	:=	cPeriod
						R14->R14_ANOAPU	:=	Val(cAnoApu)
						R14->R14_MESAPU	:=	Val(cMesApu)
						R14->R14_DSQD	:=	Val(cR10_DSQD)
						R14->R14_CNPJES	:=	Val(cCnpjEstab)
						R14->R14_MOTSUS	:=	CCF->CCF_MOTSUS 						//Motivo da Suspensใo
						R14->R14_COMDEP	:=	IIf(!Empty(CCF->CCF_IDDEP),"1","0")//Dep๓sito (Sim/Nใo)
						R14->R14_NROPRO	:=	CCF->CCF_NRDCOM						//N๚mero do Processo
						R14->R14_IDVARA	:=	CCF->CCF_IDVARA						//Vara
						R14->R14_CODMUN	:=	CCF->CCF_CODMUN						//Municํpio
						R14->R14_UF		:=	CCF->CCF_UF							//UF
						R14->R14_IDEDEP :=	CCF->CCF_IDDEP						//Identifica็ใo do Dep๓sito
						R14->R14_PERAPU	:=	CCF->CCF_PERAPU						//Perํodo da Apura็ใo
						R14->R14_CPFCGC	:=	CCF->CCF_CNPJ							//CPF/CNPJ
						R14->R14_CRECDJ	:=	CCF->CCF_CODREC						//C๓digo Receita do processo 
						R14->R14_VLRSUS	:=	SE2CPY->E2_VALOR						//Valor Suspenso do D้bito
						R14->R14_DTVCTO :=	SE2CPY->E2_VENCREA					//Data do Vencimento
						R14->R14_VLRPRI :=	SE2CPY->E2_VALOR						//Valor do Principal
						R14->R14_VLRMUL :=	SE2CPY->E2_MULTA						//Valor da Multa
						R14->R14_VLRJUR	:=	SE2CPY->E2_JUROS						//Valor dos Juros
						MsUnLock()
					EndIf
					//Para gerar o registro R24 ้ verificado o campo E2_DATASUS ou o campo CCF_DATSUS
					//ษ necessแrio existir um Processo referenciado
					If (lTriAnt .And. lAchouCCF .And. lCPOCCLOK .And. !Empty(SE2CPY->E2_DATASUS)) .Or. (lDatSus .And. !Empty(CCF->CCF_DATSUS))
						RecLock ("R24", .T.)
						R24->R24_GRPTRI	:=	Val(cGrpTrib)
						R24->R24_CODREC	:=	Val(cCodRetVar)
						R24->R24_PERIOD	:=	cPeriod
						R24->R24_ANOAPU	:=	Val(cAnoApu)
						R24->R24_TRIAPU	:=	cTriApuAnt
						R24->R24_CNPJES	:=	Val(cCnpjEstab)
						R24->R24_MOTSUS	:=	CCF->CCF_MOTSUS 						//Motivo da Suspensใo
						R24->R24_COMDEP	:=	IIf(!Empty(CCF->CCF_IDDEP),"1","0")//Dep๓sito (Sim/Nใo)
						R24->R24_NROPRO	:=	CCF->CCF_NRDCOM						//N๚mero do Processo
						R24->R24_IDVARA	:=	CCF->CCF_IDVARA						//Vara
						R24->R24_CODMUN	:=	CCF->CCF_CODMUN						//Municํpio
						R24->R24_UF		:=	CCF->CCF_UF							//UF
						R24->R24_IDEDEP	:=	CCF->CCF_IDDEP						//Identifica็ใo do Dep๓sito
						R24->R24_PERAPU	:=	CCF->CCF_PERAPU						//Perํodo da Apura็ใo
						R24->R24_CPFCGC	:=	CCF->CCF_CNPJ							//CPF/CNPJ
						R24->R24_CRECDJ	:=	CCF->CCF_CODREC						//C๓digo Receita do processo
						R24->R24_VLRSUS	:=	SE2CPY->E2_VALOR						//Valor Suspenso do D้bito
						R24->R24_DTVCTO	:=	SE2CPY->E2_VENCREA					//Data do Vencimento
						R24->R24_VLRPRI	:=	SE2CPY->E2_VALOR						//Valor do Principal
						R24->R24_VLRMUL	:=	SE2CPY->E2_MULTA						//Valor da Multa
						R24->R24_VLRJUR	:=	SE2CPY->E2_JUROS						//Valor dos Juros
						MsUnLock()
					EndIf
				Endif
			EndIf
			//Quando for Titulo TX processo somente uma vez
			If lTx
				Exit
			EndIf
		Next nX

		DbSelectArea (cAlsSe2)
		(cAlsSe2)->(DbSkip ())
	EndDo
	lGPEM670  := .F.

	#IFDEF TOP
		DbSelectArea (cAlsSe2)
		(cAlsSe2)->(DbCloseArea ())
	#ELSE
		DbSelectArea (cAlsSe2)
		RetIndex (cAlsSe2)
		(cAlsSe2)->(DbClearFilter ())
		Ferase (cIndex+OrdBagExt())
	#ENDIF
Next (nJ)

RestArea (aSm0Loop)
cFilAnt :=	FWCodFil()
	
Return (lGerou)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณRetGrpTribบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que retorna o Grupo de Tributacao para determinado IMPOSTO.                              บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcDctf -> Versao da DCTF em porcessamento.                                                       บฑฑ
ฑฑบ          ณcCodRet -> codigo de receita + variacao                                                         บฑฑ
ฑฑบ          ณcNatureza -> Natureza do titulo TX                                                              บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณcGrpTrib -> Grupo de Tributacao                                                                 บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณMT978Res (cDctf, cCodRet, cNatureza)                                                            บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function RetGrpTrib (cDctf, cCodRet, cNatureza)
	Local 	cGrpTrib	:=""	// Grupo de tributo
	Local	aGrpTrib	:=	{{"IRPJ","01"},{"IRRF","02"},{"IPI","03"},{"IOF","04"},{"CSLL","05"},{"PIS/PASEP","06"},{"COFINS","07"},{"CPMF","08"},{"CIDE","09"},{"RET/PATRIMONIO DE AFETACAO","10"},{"CSRF","11"},{"COSIRF","12"},{"CPSSS","13"}}
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณEstes parametros definem os CODIGOS DE RECEITAS que deverao compor os grupos:                                             ณ
	//ณ- RET/PATRIMONIO DE AFETACAO                                                                                              ณ
	//ณ- CSRF                                                                                                                    ณ
	//ณ- COSIRF                                                                                                                  ณ
	//ณOBS: Estes ifs sao necessarios porque ambos grupos possuem codigos de receita dieferentes para o mesmo imposto, ou seja,  |
	//ณ se o codigo de receita processado no momento pertencer a um dos 3 grupos nem faco o processamento para os grupos         |
	//ณespecificos abaixo (ELSE).                                                                                                ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	//
	//Este grupo somente existe na DCTF Mensal ou Semestral
	If ("M"$cDctf .Or. "S"$cDctf) .And. (SubStr (cCodRet, 1, 4)$cMV_M978RP)
		cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "RET/PATRIMONIO DE AFETACAO"$aX[1]})][2]

	//Este grupo somente existe na DCTF Mensal ou Semestral
	ElseIf ("M"$cDctf .Or. "S"$cDctf) .And. (SubStr (cCodRet, 1, 4)$cMV_M978CSR)
		cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CSRF"$aX[1]})][2]

	//Este grupo somente existe na DCTF Mensal ou Semestral
	ElseIf ("M"$cDctf .Or. "S"$cDctf) .And. (SubStr (cCodRet, 1, 4)$cMV_M978COS)
		cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "COSIRF"$aX[1]})][2]
	
	//Este grupo somente existe na DCTF Mensal ou Semestral
	ElseIf ("M"$cDctf .Or. "S"$cDctf) .And. (SubStr (cCodRet, 1, 4)$cMV_M978CPS)
		cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CPSSS"$aX[1]})][2]

	Else
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProcessamento para os codigos de receita especificos cuja identificacao dos mesmos       ณ
		//ณpode ser feita apenas pela natureza, pois onde poderia ocorrer o problema de cair em     ณ
		//ณgrupos diferente ja foi feito anteriormente atraves da atribuicao de determinados codigosณ
		//ณnos parametros MV_M978RP, MV_M978CSR, MV_M978COS.                                        ณ 
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_IRRF," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "IRRF"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_CSLL," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CSLL"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_PIS," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "PIS/PASEP"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_COFINS," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "COFINS"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_CIDE," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CIDE"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_IRPJ," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "IRPJ"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_CPMF," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CPMF"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_IOF," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "IOF"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_IPI," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "IPI"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_RETPAT," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "RET/PATRIMONIO DE AFETACAO"$aX[1]})][2]

		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_COSIRF," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "COSIRF"$aX[1]})][2]
						
		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_CSRF," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CSRF"$aX[1]})][2]
		
		ElseIf "'"+AllTrim(cNatureza)+"'" $ Replace(cMV_CPSSS," ", "")
			cGrpTrib	:=	aGrpTrib[aScan (aGrpTrib, {|aX| "CPSSS"$aX[1]})][2]
		EndIf
		
	EndIf
Return (cGrpTrib)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Trim  บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que retorna o TOFG - Trimestre de Ocorrencia do Fato Gerador.                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaIniWiz -> Informacoes preenchidas no Wizard                                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณnTrimFg -> Trimestre                                                                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Trim (aIniWiz)                                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Trim (aIniWiz)
	Local	nTrimFg	:=	0
	//
	If !(Month (SToD (Padr (aIniWiz[1][2], 8)))<=3)
		If !(Month (SToD (Padr (aIniWiz[1][2], 8)))<=6)
			If !(Month (SToD (Padr (aIniWiz[1][2], 8)))<=9)
				nTrimFg	:=	4
			Else
				nTrimFg	:=	3
			EndIf
		Else
			nTrimFg	:=	2
		EndIf
	Else
		nTrimFg	:=	1
	EndIf
Return (nTrimFg)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978TrbPaiบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao retorna o Forncedor, Loja do titulo PAI do TX                                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณSomente para os impostos PIS/COFINS/CSLL e IR                                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcPrefixo -> Prefixo do titulo TX                                                                บฑฑ
ฑฑบ          ณcNum -> Numero do titulo TX                                                                     บฑฑ
ฑฑบ          ณcParcela -> Parcela do titulo TX                                                                บฑฑ
ฑฑบ          ณaFornece -> Array que recebe o codigo do fornecedor[1] e loja[2].                               บฑฑ
ฑฑบ          ณcNatTx -> Natureza do titulo TX                                                                 บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณlRet -> Flag para a existencia do titulo pai(.T.) ou nao(.F.)                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978TrbPai (cPrefixo, cNum, cParcela, aFornece, cNatTx)                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978TrbPai (cPrefixo, cNum, cParcela, aFornece, cNatTx)
	Local	lRet	:=	.F.
	Local	cAlsSe2	:=	"SE2"
	Local	aAreaSe2	:=	(cAlsSe2)->(GetArea ())
	Local	cIfParcela	:=	""

	cNatTx	:=	AllTrim (cNatTx)

	DbSelectArea (cAlsSe2)
	(cAlsSe2)->(DbSetOrder (1))
	If ((cAlsSe2)->(DbSeek (xFilial ("SE2")+cPrefixo+cNum)))
		Do While !(cAlsSe2)->(Eof ()) .And. (cAlsSe2)->E2_FILIAL+(cAlsSe2)->E2_PREFIXO+(cAlsSe2)->E2_NUM==xFilial ("SE2")+cPrefixo+cNum
			
			If (cNatTx$cMV_PIS)
				cIfParcela	:=	"E2_PARCPIS"
			ElseIf (cNatTx$cMV_COFINS)
				cIfParcela	:=	"E2_PARCCOF"
			ElseIf (cNatTx$cMV_CSLL)
				cIfParcela	:=	"E2_PARCSLL"
			ElseIf (cNatTx$cMV_IRRF)
				cIfParcela	:=	"E2_PARCIR"
			ElseIf (cNatTx$cMV_CIDE)
				 cIfParcela	:=	"E2_PARCCID"	 
			EndIf

			If &(cAlsSe2+"->"+cIfParcela+"=='"+cParcela+"'") .And. !Empty(&(cIfParcela))
				lRet		:= .T.
				aFornece[1]	:=	(cAlsSe2)->E2_FORNECE
				aFornece[2]	:=	(cAlsSe2)->E2_LOJA
			EndIf
			
			(cAlsSe2)->(DbSkip ())
		EndDo
	EndIf

	RestArea (aAreaSe2)
Return (lRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณRetDtApur บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao retorna a data de apuracao do titulo TX de acordo com a emissao do mesmo e periodicidade.บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณRetorna a data de apuracao de acordo com a emissao e periodicidade do titulo TX.                บฑฑ
ฑฑบ          ณ Periodicidade pode ser: D=Diario, S=Semanal, X=Decendial, Q=Quinzenal, M=Mensal, B=Bimentral,  บฑฑ
ฑฑบ          ณ T=Trimestral, U=Quadrimestral, E=Semestral e A=Anual.                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณdEmissao -> Data de emissao do titulo TX                                                        บฑฑ
ฑฑบ          ณcNatureza -> Natureza do titulo TX                                                              บฑฑ
ฑฑบ          ณcPeriod -> Periodicidade de acordo com o codigo de receita utilizado no titulo TX               บฑฑ
ฑฑบ          ณlLei11196 -> Indica se o fato gerador do periodo de apuracao esta sendo calculado de acordo com บฑฑ
ฑฑบ          ณ Lei 11.196.                                                                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณdDtApur -> Data de apuracao do titulo TX de acordo com a emissao do mesmo.                      บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณRetDtApur (dEmissao, cNatureza, cPeriod)                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function RetDtApur (dEmissao, cNatureza, cPeriod, lLei11196)

	Local aArea		:= GetArea()
	Local dDtApur	:= dEmissao
	Local cAnoEmiss	:=	StrZero (Year (dEmissao), 4)
	Local nNextMes	:=	0
//
	Do Case
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณIRRF, somente D=Diario, S=Semanal, M=Mensal e X=Decendialณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_IRRF)
		If ("D"$cPeriod)					  								//Diario
			dDtApur	:=	dEmissao			  								//Diario - Dia do periodo de apuracao
		ElseIf ("S"$cPeriod)				 						 		//Semanal
			While (.T.)
				If (DOW (dDtApur))==7	  							   		//Sabado - Ultimo dia do periodo de apuracao
					Exit
				EndIf
				++dDtApur
			Enddo
		ElseIf ("M"$cPeriod)				  								//Mensal
			dDtApur	:=	LastDay (dEmissao)									//2. Quinzena - Ultimo dia do periodo de apuracao
		ElseIf ("X"$cPeriod)				  								//Decendial
			If Day (dDtApur)<=10
				While (.T.)
					If (Day (dDtApur))==10	  								//1. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			ElseIf Day (dDtApur)<=20
				While (.T.)
					If (Day (dDtApur))==20	  								//2. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			Else
				dDtApur	:=	LastDay (dEmissao)								//3. Decendio - Ultimo dia do periodo de apuracao
			EndIf
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCPMF, Somente S=Semanal e X=Decendial         ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_CPMF)
		If ("S"$cPeriod)					 								//Semanal
			While (.T.)
				If (DOW (dDtApur))==5				  	  					//Quarta - Ultimo dia do periodo de apuracao
					Exit
				EndIf
				++dDtApur
			Enddo
		ElseIf ("X"$cPeriod)				  								//Decendial
			If Day (dDtApur)<=10
				While (.T.)
					If (Day (dDtApur))==10	  								//1. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			ElseIf Day (dDtApur)<=20
				While (.T.)
					If (Day (dDtApur))==20	  								//2. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			Else
				dDtApur	:=	LastDay (dEmissao)								//3. Decendio - Ultimo dia do periodo de apuracao
			EndIf
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณPIS, COFINS e CSLL, somente D=Diario, Q=Quinzenal, M=Mensal, T=Trimestral, A=Anualณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_PIS) .Or. (cNatureza$cMV_COFINS) .Or. (cNatureza$cMV_CSLL)
		If ("D"$cPeriod)									  		   		//Diario
			dDtApur	:=	dEmissao											//Diario - Dia do periodo de apuracao
			
		ElseIf ("Q"$cPeriod)				  				  		  		//Quinzenal
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณArt. 74. O art. 35 da Lei no 10.833, de 29 de dezembro de 2003, passa a vigorar com a seguinte reda็ใo:       ณ
			//ณ   "Art. 35. Os valores retidos na quinzena, na forma dos arts. 30, 33 e 34 desta Lei, deverใo ser recolhidos ณ
			//ณ    ao Tesouro Nacional pelo ๓rgใo p๚blico que efetuar a reten็ใo ou, de forma centralizada, pelo estabe-     ณ
			//ณ    lecimento matriz da pessoa jurํdica, at้ o ๚ltimo dia ๚til da quinzena subseqente เquela quinzena em     ณ
			//ณ   que tiver ocorrido o pagamento เ pessoa jurํdica fornecedora dos bens ou prestadora do servi็o." (NR)      ณ
			//ณ                                                                                                              ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If (lLei11196) .And. dDtApur>CTOD("01/01/06")
				If (Day (dDtApur)<=15)
					dDtApur	:=	LastDay (dEmissao)
				Else
					nNextMes	:=	Month (dDtApur)+1
					If (nNextMes==13)
						dDtApur		:=	CToD ("15/01/"+StrZero (Year (dDtApur)+1, 4))
					Else
						dDtApur		:=	CToD ("15/"+StrZero (nNextMes, 2)+"/"+StrZero (Year (dDtApur), 4))
					EndIf
				EndIf
			Else
				If Day (dDtApur)<=15
					While (.T.)
						If (Day (dDtApur))==15								//1. Quinzena - Ultimo dia do periodo de apuracao
							Exit
						EndIf
						++dDtApur
					Enddo
				Else
					dDtApur	:=	LastDay (dEmissao)	  						//2. Quinzena - Ultimo dia do periodo de apuracao
				EndIf
			EndIf
		ElseIf ("M"$cPeriod)					  				   			//Mensal
			dDtApur	:=	LastDay (dEmissao)	   								//2. Quinzena - Ultimo dia do periodo de apuracao
		ElseIf ("T"$cPeriod)				  								//Trimestral
			If (Month (dEmissao)>=1 .And. Month (dEmissao)<=3)
				dDtApur	:=	LastDay (cToD ("01/03/"+cAnoEmiss))			//1. Trimestre
			ElseIf (Month (dEmissao)>=4 .And. Month (dEmissao)<=6)
				dDtApur	:=	LastDay (cToD ("01/06/"+cAnoEmiss))			//2. Trimestre
			ElseIf (Month (dEmissao)>=7 .And. Month (dEmissao)<=9)
				dDtApur	:=	LastDay (cToD ("01/09/"+cAnoEmiss))			//3. Trimestre
			Else
				dDtApur	:=	LastDay (cToD ("01/12/"+cAnoEmiss))			//4. Trimestre
			EndIf
		ElseIf ("A"$cPeriod)												//Anual
			dDtApur	:=	LastDay (cToD ("01/12/"+cAnoEmiss))				//Anual
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณIRPJ, somente M=Mensal, T=Trimestral, A=Anual     ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_IRPJ)
		If ("M"$cPeriod)					   								//Mensal
			dDtApur	:=	LastDay (dEmissao)	   								//Ultimo dia do Mes
		ElseIf ("T"$cPeriod)					 							//Trimestral
			If (Month (dEmissao)>=1 .And. Month (dEmissao)<=3)
				dDtApur	:=	LastDay (cToD ("01/03/"+cAnoEmiss))			//1. Trimestre
			ElseIf (Month (dEmissao)>=4 .And. Month (dEmissao)<=6)
				dDtApur	:=	LastDay (cToD ("01/06/"+cAnoEmiss))			//2. Trimestre
			ElseIf (Month (dEmissao)>=7 .And. Month (dEmissao)<=9)
				dDtApur	:=	LastDay (cToD ("01/09/"+cAnoEmiss))			//3. Trimestre
			Else
				dDtApur	:=	LastDay (cToD ("01/12/"+cAnoEmiss))			//4. Trimestre
			EndIf
		ElseIf ("A"$cPeriod)												//Anual
			dDtApur	:=	LastDay (cToD ("01/12/"+cAnoEmiss))				//Anual
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณIOF, somente S=Semanal, M=Mensal e X=Decendial   ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_IOF)
		If ("S"$cPeriod)													//Semanal
			While (.T.)
				If (DOW (dDtApur))==7	  									//Sabado - Ultimo dia do periodo de apuracao
					Exit
				EndIf
				++dDtApur
			Enddo
		ElseIf ("M"$cPeriod)												//Mensal
			dDtApur	:=	LastDay (dEmissao)									//2. Quinzena - Ultimo dia do periodo de apuracao
		ElseIf ("X"$cPeriod)				  								//Decendial
			If Day (dDtApur)<=10
				While (.T.)
					If (Day (dDtApur))==10	  								//1. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			ElseIf Day (dDtApur)<=20
				While (.T.)
					If (Day (dDtApur))==20	  								//2. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			Else
				dDtApur	:=	LastDay (dEmissao)								//3. Decendio - Ultimo dia do periodo de apuracao
			EndIf
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCIDE, somente D=Diario, M=Mensal                  ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_CIDE)
		If ("D"$cPeriod)	   												//Diario
			dDtApur	:=	dEmissao											//Diario - Dia do periodo de apuracao
		ElseIf ("M"$cPeriod)	   											//Mensal
			dDtApur	:=	LastDay (dEmissao)	   								//Ultimo dia do mes
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณIPI, somente X=Decendial, M=Mensal               ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (cNatureza$cMV_IPI)
		If ("X"$cPeriod)	   				   								//Decendial
			If Day (dDtApur)<=10
				While (.T.)
					If (Day (dDtApur))==10	  								//1. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			ElseIf Day (dDtApur)<=20
				While (.T.)
					If (Day (dDtApur))==20	  								//2. Decendio - Ultimo dia do periodo de apuracao
						Exit
					EndIf
					++dDtApur
				Enddo
			Else
				dDtApur	:=	LastDay (dEmissao)								//3. Decendio - Ultimo dia do periodo de apuracao
			EndIf
		ElseIf ("M"$cPeriod)
			dDtApur	:=	LastDay (dEmissao)									//Ultimo dia do Mes
		EndIf
	EndCase

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณData de Apuracao da tabela SGH ( Aglutinacao de Titulos )  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If !Empty(SE2CPY->E2_CODAGL)
		dbSelectArea("SGH")
		dbSetOrder(1)
		If dbSeek(xFilial("SGH")+SE2CPY->E2_CODAGL)
			dDtApur := SGH->GH_DTAPUR
		Endif
	Endif

	RestArea(aArea)

Return (dDtApur)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณDSQD      บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณVerifica a periodocidade de uma data.                                                           บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณExemplo: cPeriod="Q" e dData 14/10/2004, retorno 1, 1. Quinzena. Assim por diante.              บฑฑ
ฑฑบ          ณ Periodicidade pode ser: D=Diario, S=Semanal, X=Decendial, Q=Quinzenal, M=Mensal, B=Bimentral,  บฑฑ
ฑฑบ          ณ T=Trimestral, U=Quadrimestral, E=Semestral e A=Anual.                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcPeriod -> Periodicidade de acordo com o codigo de receita utilizado no titulo TX               บฑฑ
ฑฑบ          ณdData -> Data a ser processada.                                                                 บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณnRet -> Retorna X, de acordo com a periodicidade                                                บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณDSQD (cPeriod, dData)                                                                           บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function DSQD (cPeriod, dData)
	Local	nRet	:=	0

	Do Case
	Case ("D"$cPeriod)
		nRet	:=	Day (dData)			
	Case ("S"$cPeriod)
		nRet	:=	SemanaMes (dData)			
	Case ("X"$cPeriod)
		If (Day (dData)>=1 .And. Day (dData)<=10)
			nRet	:=	1
		ElseIf (Day (dData)>=11 .And. Day (dData)<=20)
			nRet	:=	2
		Else
			nRet	:=	3
		EndIf			
	Case ("Q"$cPeriod)
		If (Day (dData)>=1 .And. Day (dData)<=15)
			nRet	:=	1
		Else
			nRet	:=	2
		EndIf			
	Case (AllTrim (cPeriod)$"#M#B#T#U#A#")	//Mes, Bimestre, Trimestre, Quadrimestre, Anual
		nRet	:=	0
	EndCase
Return (nRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณMBTQS     บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que retorna a mes de apuracao de acordo com a periodicidade do codigo de receita.        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณ Periodicidade pode ser: D=Diario, S=Semanal, X=Decendial, Q=Quinzenal, M=Mensal, B=Bimentral,  บฑฑ
ฑฑบ          ณ T=Trimestral, U=Quadrimestral, E=Semestral e A=Anual.                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcPeriod -> Periodicidade de acordo com o codigo de receita utilizado no titulo TX               บฑฑ
ฑฑบ          ณdData -> Data a ser processada.                                                                 บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณnRet -> Periodicidade para o Mes de apuracao                                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณMBTQS (cPeriod, dData)                                                                          บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function MBTQS (cPeriod, dData)
	Local	nRet	:=	0

	Do Case
	Case (AllTrim (cPeriod)$"D#S#X#Q#M")	//Dia / semana / decendio / quinzena / mes
		nRet	:=	Month (dData)
			
	Case (AllTrim (cPeriod)$"B")			//Bimestre
		If (Month (dData)>=1 .And. Month (dData)<=2)
			nRet	:=	1
		ElseIf (Month (dData)>=3 .And. Month (dData)<=4)
			nRet	:=	2
		ElseIf (Month (dData)>=5 .And. Month (dData)<=6)
			nRet	:=	3
		ElseIf (Month (dData)>=7 .And. Month (dData)<=8)
			nRet	:=	4
		ElseIf (Month (dData)>=9 .And. Month (dData)<=10)
			nRet	:=	5
		Else
			nRet	:=	6
		EndIf
			
	Case (AllTrim (cPeriod)$"T")	//Trimestre
		If (Month (dData)>=1 .And. Month (dData)<=3)
			nRet	:=	1
		ElseIf (Month (dData)>=4 .And. Month (dData)<=6)
			nRet	:=	2
		ElseIf (Month (dData)>=7 .And. Month (dData)<=9)
			nRet	:=	3
		Else
			nRet	:=	4
		EndIf
			
	Case (AllTrim (cPeriod)$"U")								//Quadrimetre
		If (Month (dData)>=1 .And. Month (dData)<=4)
			nRet	:=	1
		ElseIf (Month (dData)>=5 .And. Month (dData)<=8)
			nRet	:=	2
		Else
			
			nRet	:=	3
		EndIf
			
	Case (AllTrim (cPeriod)$"E")								//Semestre
		If (Month (dData)>=1 .And. Month (dData)<=6)
			nRet	:=	1
		Else
			nRet	:=	2
		EndIf
	EndCase
Return (nRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Fil   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณEncaixa conteudo em espaco especificado.                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcConteudo -> String a ser tratada                                                               บฑฑ
ฑฑบ          ณnTam -> Tamanho a ser transformado                                                              บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณcRetorno -> String ja tratada                                                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Fil (cConteudo, nTam)                                                                       บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function M978Fil (cConteudo, nTam)
	Local	cRetorno	:=	""

	cConteudo	:=	Iif (cConteudo==NIL, "", cConteudo)
	If (Len (cConteudo)>nTam)
		cRetorno	:=	SubStr (cConteudo, 1, nTam)
	Else
		cRetorno	:=	cConteudo+Space (nTam-Len (cConteudo))
	Endif
Return (cRetorno)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณRetDatDCTFบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณRetorna data no formato exigido pelo layout da DCTF.                                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณdData -> Data a ser transformada no padrao da DCTF.                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณdData -> Data transformada                                                                      บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณRetDatDCTF (dData)                                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function RetDatDCTF (dData)
Return (StrZero (Day (dData), 2)+StrZero (Month (dData), 2)+StrZero (Year (dData), 4))
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Grava บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณGrava registro no arquivo texto.                                                                บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcConteudo -> Conteudo a ser gravado no arquivo texto.                                           บฑฑ
ฑฑบ          ณnHandle -> Handle do arquivo texto.                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณRetDatDCTF (dData)                                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function M978Grava (cConteudo, nHandle)
	cConteudo += Chr (13)+Chr (10)
	
	If !(lEnd)
		FWrite (nHandle, cConteudo, Len (cConteudo))
	Endif
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978ExcTrbบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao utilizada para fechar o TRB alimentado pela funcao M978Darf.                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaTrb -> Array contendo o nome logico e fisico do TRB criado.                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978ExcTrb (aTrb)                                                                               บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function M978ExcTrb (aTrb)
	Local	nX	:=	0
	//
	For nX	:=	1 To Len (aTrb)
		DbSelectArea (aTrb[nX][1])
		(aTrb[nX][1])->(DbCloseArea ())
		Ferase (aTrb[nX][2]+GetDBExtension ())
		Ferase (aTrb[nX][2]+OrdBagExt ())
	Next (nX)
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณSemanaMes บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao para retornar a semana de um determinado dia no Mes da data passada como parametro.      บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณdData -> Data a ser tratada                         .                                           บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณnSemana -> Retorna em qual semana do mes cai determinado dia                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณSemanaMes (dData)                                                                               บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function SemanaMes (dData)
	Local	nSemana		:=	1
	Local	nDiasMes	:= 	DiaMes (Month (dData))
	Local	dDataAux	:=	CToD ("  /  /  ")
	Local	nCnt		:=	0
	//
	For nCnt := 1 To nDiasMes
		dDataAux := CToD (StrZero (nCnt, 2)+"/"+Alltrim (Str (Month (dData)))+"/"+Alltrim (Str (Year (dData))))
		//
		If (Dow (dDataAux)==1) .And. (nCnt<>1)
			nSemana++
		Endif
		//
		If (dDataAux==dData)
			Exit
		Endif
	Next
Return (nSemana)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  |DiaMes    บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao para retornar uma quantidade de dias em um determinado mes.                              บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnMes -> Mes do periodo de apuracao.                 .                                           บฑฑ
ฑฑบ          ณcAno -> Ano do periodo de apuracao.                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณaMeses -> Periodo de mes em questao.                                                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณDiaMes (nMes, cAno)                                                                             บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/	
Static Function DiaMes (nMes, cAno)
	Local	aMeses := {{01,31},{02,28,29},{03,31},{04,30},{05,31},{06,30},{07,31},{08,31},{09,30},{10,31},{11,30},{12,31}}
	//
	If (nMes<1) .Or. (nMes>12)
		Return (0)
	Endif
Return (aMeses[aScan (aMeses, {|x| x[1]==nMes}), 2])
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  |aAddLog   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao para consistir o codigo de receita do titulo tx para posteior geracao de um arquivo TXT  บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณArquivo TXt de log gerado chama-se LOGDCTF.TXT no mesmo diretorio do arquivo-magnetico.         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaLog -> Array de log para geracao do TXT ao final do processo.                                  บฑฑ
ฑฑบ          ณcAlsSe2 -> Alias da tabela SE2 em processamento.                                                บฑฑ
ฑฑบ          ณcCodRet -> Codigo de receita do titulo TX.                                                      บฑฑ
ฑฑบ          ณcCodRetVar -> Codigo de receita apos o relacionamento.                                          บฑฑ
ฑฑบ          ณcQuery -> Query principal executada na selecao dos titulos do periodo.                          บฑฑ
ฑฑบ          ณdDataDe -> Data inicial do periodo de apuracao digitada no Wizard.                              บฑฑ
ฑฑบ          ณdDataAte -> Data final do periodo de apuracao digitada no Wizard.                               บฑฑ
ฑฑบ          ณaEspecifico -> [1]=Array contendo a regra do parametro MV_DCTF                                  บฑฑ
ฑฑบ          ณ               [2]=Array contendo as informacoes digitadas no Wizard.                           บฑฑ
ฑฑบ          ณ               [3]=String contendo a versao da DCTF a ser gerada, Ex: "DCTF"                    บฑฑ
ฑฑบ          ณlForaPer -> Indica que quando se tratar de DCTF Trimestral o periodo selecionado esta invalido  บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณaAddLog (aLog, cCodRet, cCodRetVar, cQuery, dDataDe, dDataAte, aEspecifico, lForaPer)           บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function aAddLog (aLog, cCodRet, cCodRetVar, cQuery, dDataDe, dDataAte, aEspecifico, lForaPer,dDtFtGer,cAlsSe2,cGrpTrib, lOk)
	Local	lRet		:=	.T.
	Local	cErro		:=	""
	Local	cSolucao	:=	""

Default lOk := .F.
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTratamento para apresentar no log, as incompatibilidades entre as versoes da DCTF para o periodo a ser processado.ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If (lForaPer<>Nil) .And. (lForaPer)	//Flag de periodo invalido para DCTF Trimestral.
		cErro		:=	STR0122+MesExtenso (Month (dDataDe))+" a "+MesExtenso (Month (dDataAte))+STR0121	//"O meio-magn้tico gerado trata-se de DCTF Trimestral, por้m a mesma estแ abrangendo um perํodo invแlido, ["###"]. Esta inconsist๊ncia impossibilitarแ a importa็ใo do meio-magn้tico."

		cSolucao	:=	STR0120	//"Quando se tratar de DCTF Trimestral, a mesma deverแ abranger um dos quatro trimestres do ano, devendo ser: "
		cSolucao	+=	STR0119	//"1. Trimestre: Jan-Mar, 2. Trimestre=Abr-Jun, 3.Trimestre=Jul-Set, 4. Trimestre=Out-Dez."

		aAdd (aLog, {cErro, cSolucao})
	EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTratamento para a data do fato gerador.ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If dDtFtGer<>Nil
		cErro		:=	STR0142									//"O Titulo com as seguintes caracterํsticas [Filial: "
		cErro		+=	STR0002+(cAlsSe2)->E2_PREFIXO			//", Prefixo: "
		cErro		+=	STR0003+(cAlsSe2)->E2_NUM				//", N๚mero: "
		cErro		+=	STR0004+(cAlsSe2)->E2_PARCELA			//", Parcela: "
		cErro		+=	STR0005+(cAlsSe2)->E2_TIPO	 			//", Tipo: "
		cErro		+=	STR0006+(cAlsSe2)->E2_NATUREZ			//", Natureza: "
		cErro		+=	STR0143									//"] nao serแ considerado neste perํodo de Apura็ใo por pertenceter a um outro perํodo ["
		cErro		+=	StrZero(Month(dDtFtGer),2)+"/"+StrZero(Year(dDtFtGer),4)+"]. "
		cErro		+=	STR0144									//"Se os valores desconsiderados nใo foram apresentados ao fisco em uma declara็ใo anterior deverใo ser enviados na declara็ใo do perํodo seguinte."
		
		cSolucao	:=	STR0145+CHR(13)+CHR(10)					//"Estas exclus๕es podem ocorrer dependendo das configura็๕es de dois parโmetros, MV_BX10925 e MV_VENCIRF."
		cSolucao	+=	STR0146									//"- Quando o parโmetro MV_BX10925 estiver configurado para EMISSรO(2), a data do fato gerador ้ a data de "
		cSolucao	+=	STR0147+CHR(13)+CHR(10)					//"vencimento real dos tํtulos originais (E2_VENCREA)."
		cSolucao	+=	STR0148									//"- Quando o parโmetro MV_BX10925 estiver configurado para BAIXA(1), a emissใo dos tํtulos TX que possuem tํtulos "
		cSolucao	+=	STR0149									//"originais relacionados sใo considerados no filtro, pois o fato gerador trata-se do pagamento, e a data de "
		cSolucao	+=	STR0150+CHR(13)+CHR(10)					//"emissใo destes TXs sempre serแ a referida data."
		cSolucao	+=	STR0151									//"- Quando o parโmetro MV_VENCIRF estiver configurado para vencimento real (V), o fato gerador ้ o  "
		cSolucao	+=	STR0152+CHR(13)+CHR(10)					//"vencimento real do titulo original deste TX(E2_VENCREA)."
		cSolucao	+=	STR0153									//"- Quando o parโmetro MV_VENCIRF estiver configurado para data de contabiliza็ใo (C), o fato gerador ้ a  "
		cSolucao	+=	STR0154+CHR(13)+CHR(10)					//"data de contabiliza็ใo do titulo original deste TX(E2_EMIS1)."
		cSolucao	+=	STR0155									//"- Quando o parโmetro MV_VENCIRF estiver configurado para data de emissใo (E), o fato gerador ้ a  "
		cSolucao	+=	STR0156+CHR(13)+CHR(10)+CHR(13)+CHR(10)//"data de emissใo do titulo original deste TX(E2_EMISSAO)."
		cSolucao	+=	STR0157									//"OBSERVAวรO: Quando NรO houver tํtulo original relacionado a um TX de tributo, ou seja, um tํtulo lan็ado "
		cSolucao	+=	STR0158									//"manualmente, a data de emissใo do mesmo ้ considerada como data do fato gerador, despresando os "
		cSolucao	+=	STR0159									//"que nใo estiverem no perํodo de Apura็ใo da DCTF."
	
		aAdd (aLog, {cErro, cSolucao})
	EndIf
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTratamento para quando o grupo de tributacao estiver em branco.ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If cGrpTrib<>Nil
		cErro		:=	STR0142												//"O Titulo com as seguintes caracterํsticas [Filial: "
		cErro		+=	STR0002+SE2CPY->E2_PREFIXO							//", Prefixo: "
		cErro		+=	STR0003+SE2CPY->E2_NUM								//", N๚mero: "
		cErro		+=	STR0004+SE2CPY->E2_PARCELA							//", Parcela: "
		cErro		+=	STR0005+SE2CPY->E2_TIPO	 							//", Tipo: "
		cErro		+=	STR0006+SE2CPY->E2_NATUREZ							//", Natureza: "
		cErro		+=	STR0160+SE2CPY->E2_NATUREZ+STR0161					//"] nao possui a natureza ["###"] relacionada a nenhum parโmetro que define os 'Grupos de Tributa็ใo' da DCTF."
	
		cSolucao	:=	STR0162+SE2CPY->E2_NATUREZ+STR0163+CHR(13)+CHR(10)//"Deverแ ser analisado em quais parโmetros esta natureza ["###"] deve se enquadrar. Sใo eles: "+CHR(13)+CHR(10)
		cSolucao	+=	STR0164												//"MV_IRF/MV_IRF2 para o grupo de tributa็ใo IRRF, MV_CSLL para o grupo de tributa็ใo CSLL, MV_PISNAT/PISNAT2 para o grupo de tributa็ใo PIS, "
		cSolucao	+=	STR0165												//"MV_COFINS/MV_COFINS2 para o grupo de tributa็ใo COFINS, MV_CIDE para o grupo de tributa็ใo CIDE, MV_IRPJ para o grupo de tributa็ใo IRPJ, "
		cSolucao	+=	STR0166												//"MV_CPMF para o grupo de tributa็ใo CPMF, MV_IOF para o grupo de tributa็ใo IOF, MV_IPI para o grupo de tributa็ใo IPI, "
		cSolucao	+=	STR0167												//"MV_RETPAT para o grupo de tributa็ใo RET/PATRIMONIO DE AFETACAO, MV_COSIRF para o grupo de tributa็ใo COSIRF, "
		cSolucao	+=	STR0168												//"MV_CSRF para o grupo de tributa็ใo CSRF."
		aAdd (aLog, {cErro, cSolucao})
	EndIf

	If (aEspecifico<>Nil)
		If (Year (dDataDe))<2006
			If (Len (aEspecifico[3])==4) .And. (Year (dDataDe)>=2005)	//Quando o tamanho for somente 4, quer dizer que eh DCTF Trimestral. DCTF Trimestral eh somente para os anos inferiores a 2004
				cErro		:=	STR0128	//"Quando se tratar do software validador da DCTF Trimestral devemos observar as vers๕es disponํveis para cada perํodo de apura็ใo."
				cSolucao	:=	STR0127	//"A DCTF Trimestral possui as vers๕es : 300 para o Ano de 2004, 210 para o ano de 1999 a 2003, 610 para o ano de 1997 a 1998 "
				cSolucao	+=	STR0123	//"e 430 para o ano de 1993 a 1996. Verificar se a versใo digitada no wizard corresponde a uma das disponํveis para o perํodo a ser processado."
				aAdd (aLog, {, cSolucao, cErro})
			ElseIf (Len (aEspecifico[3])==4) .And. (Year (dDataDe)==2004) .And. !("300"$aEspecifico[2][1][8])	//DCTF Trimestral eh somente para o ano de 2004 na versao 300.
				cErro		:=	STR0126	//"A versใo do software validador da DCTF Trimestral digitada no wizard da rotina nใo estแ correta para o perํodo, "
				cErro		+=	STR0125+aEspecifico[2][1][8]+"]"	//"podendo causar um erro na importa็ใo deste meio-magn้tico. Versใo digitada no wizard ["###"]"
				cSolucao	:=	STR0124	//"ษ necessแrio alterar para a versใo correta do software validador da DCTF quando se tratar do perํodo Trimestral no ano de 2004. [300]."
				aAdd (aLog, {, cSolucao, cErro})
			ElseIf ("S"$aEspecifico[3])		//Tipo da DCTF - S=Semestral, M=Mensal
				If !("100"$aEspecifico[2][1][8])	//Versao da DCTF digitada no Wizard
					cErro		:=	STR0140	//"A versใo do software validador da DCTF Semestral digitada no wizard da rotina nใo estแ correta para o perํodo, "
					cErro		+=	STR0139+aEspecifico[2][1][8]+"]"	//"podendo causar um erro na importa็ใo deste meio-magn้tico. Versใo digitada no wizard ["###"]"
					cSolucao	:=	STR0138	//"ษ necessแrio alterar para a versใo correta do software validador da DCTF quando se tratar do perํodo Semetral anterior a 2006. [100]."
					aAdd (aLog, {cErro, cSolucao})
				EndIf
			ElseIf ("M"$aEspecifico[3])		//Tipo da DCTF - S=Semestral, M=Mensal
				If !("110"$aEspecifico[2][1][8])	//Versao da DCTF digitada no Wizard
					cErro		:=	STR0137	//"A versใo do software validador da DCTF Mensal digitada no wizard da rotina nใo estแ correta para o perํodo, "
					cErro		+=	STR0136+aEspecifico[2][1][8]+"]"	//"podendo causar um erro na importa็ใo deste meio-magn้tico. Versใo digitada no wizard ["###"]"
					cSolucao	:=	STR0135	//"ษ necessแrio alterar para a versใo correta do software validador da DCTF quando se tratar do perํodo Mensal anterior a 2006. Versใo correta: 110."
					aAdd (aLog, {cErro, cSolucao})
				EndIf
			EndIf
		Else
			If (Len (aEspecifico[3])==4)		//Quando o tamanho for somente 4, quer dizer que eh DCTF Trimestral. DCTF Trimestral eh somente para o ano de 2004
				cErro		:=	STR0128	//"Quando se tratar do software validador da DCTF Trimestral devemos observar as vers๕es disponํveis para cada perํodo de apura็ใo."
				cSolucao	:=	STR0127	//"A DCTF Trimestral possui as vers๕es : 300 para o Ano de 2004, 210 para o ano de 1999 a 2003, 610 para o ano de 1997 a 1998 "
				cSolucao	+=	STR0123	//"e 430 para o ano de 1993 a 1996. Verificar se a versใo digitada no wizard corresponde a uma das disponํveis para o perํodo a ser processado."
				aAdd (aLog, {, cSolucao, cErro})
			ElseIf ("S"$aEspecifico[3])		//Tipo da DCTF - S=Semestral, M=Mensal
				If ("100"$aEspecifico[2][1][8]) .And. ;
						(aEspecifico[2][3][6]$STR0170 .Or.  ; //"Soc.Coop.Prod.Agro.Cons."
					aEspecifico[2][3][6]$STR0171 .Or.  ; //"Autarquia/Fundacao Publica"
					aEspecifico[2][3][6]$STR0172 .Or.  ; //"Orgใo P๚blico da Adm. Direta"
					aEspecifico[2][3][6]$STR0173)        //"Emp.Pub./Soc.Econ.Mista/Demais PJ"
					cErro		:= STR0174 //"O Item selecionado para a Qualifica็ใo da Pessoa Jurํdica nใo ้ vแlido para a versใo selecionada"
					cSolucao	:= STR0175 + " 150." //"ษ necessแrio alterar para a versใo correta do software validador da DCTF Semestral, para indicar a versใo"
					aAdd (aLog, {cErro, cSolucao})
				EndIf
				If !(aEspecifico[2][1][8]$"130#140#150")//!("130"$aEspecifico[2][1][8])	//Versao da DCTF digitada no Wizard
					cErro		:=	STR0134	//"A versใo do software validador da DCTF Semestral digitada no wizard da rotina nใo estแ correta para o perํodo, "
					cErro		+=	STR0133+aEspecifico[2][1][8]+"]"	//"podendo causar um erro na importa็ใo deste meio-magn้tico. Versใo digitada no wizard ["###"]"
					cSolucao	:=	STR0132	//"ษ necessแrio alterar para a versใo correta do software validador da DCTF quando se tratar do perํodo Semetral no ano de 2006. Versใo correta 130."
					aAdd (aLog, {cErro, cSolucao})
				EndIf
			ElseIf ("M"$aEspecifico[3])		//Tipo da DCTF - S=Semestral, M=Mensal
				If (("140"$aEspecifico[2][1][8]) .Or.("150"$aEspecifico[2][1][8])).And. ;
						(aEspecifico[2][3][6]$STR0170 .Or.  ;
						aEspecifico[2][3][6]$STR0171 .Or.  ;
						aEspecifico[2][3][6]$STR0172 .Or.  ;
						aEspecifico[2][3][6]$STR0173)
					cErro		:= STR0174 //"O Item selecionado para a Qualifica็ใo da Pessoa Jurํdica nใo ้ vแlido para a versใo selecionada"
					cSolucao	:= STR0175+" 170." //"ษ necessแrio alterar para a versใo correta do software validador da DCTF Mensal, para indicar a versใo"
					aAdd (aLog, {cErro, cSolucao})
				EndIf
				If aEspecifico[2][1][8]<"140"	//Versao da DCTF digitada no Wizard
					cErro		:=	STR0131	//"A versใo do software validador da DCTF Mensal digitada no wizard da rotina nใo estแ correta para o perํodo, "
					cErro		+=	STR0130+aEspecifico[2][1][8]+"]"	//"podendo causar um erro na importa็ใo deste meio-magn้tico. Versใo digitada no wizard ["###"]"
					cSolucao	:=	STR0129	//"ษ necessแrio alterar para a versใo correta do software validador da DCTF Mensal, pois declara็๕es superiores ao ano de 2006 deverใo indicar a versใo 140."
					aAdd (aLog, {cErro, cSolucao})
				EndIf
			EndIf
		EndIf
	EndIf

	If (cQuery<>Nil) .And. (!Empty (cQuery))
		cErro		:=	STR0114	//"As condi็๕es de filtro principal para a tabela SE2 (Tํtulos a Pagar) passadas pela rotina nใo foram satisfeitas. "
		cErro		+=	STR0115+cQuery	//"FILTRO executado: "
		cSolucao	:=	STR0116	//"Verificar se existem tํtulos nas condi็๕es especificadas para o filtro no perํodo informado. FILTRO -> [IRRF: "
		aAdd (aLog, {cErro, cSolucao})
		Return (lRet)
	EndIf

	If (cCodRetVar<>Nil .And. Empty (cCodRetVar)) .Or. (cCodRet<>Nil .And. Empty (cCodRet))
		If (cCodRet<>Nil .And. Empty (cCodRet))
			cErro		:=	STR0001+SE2CPY->E2_FILIAL			//"C๓digo de receita do tํtulo TX [Filial: "
			cErro		+=	STR0002+SE2CPY->E2_PREFIXO			//", Prefixo: "
			cErro		+=	STR0003+SE2CPY->E2_NUM				//", N๚mero: "
			cErro		+=	STR0004+SE2CPY->E2_PARCELA			//", Parcela: "
			cErro		+=	STR0005+SE2CPY->E2_TIPO	 			//", Tipo: "
			cErro		+=	STR0006+SE2CPY->E2_NATUREZ			//", Natureza: "
			cErro		+=	STR0007								//"] estแ vazio."
			cSolucao	:=	STR0102									//"Inserir manualmente o c๓digo de receita vแlido para a DCTF neste tํtulo TX."
			aAdd (aLog, {cErro, cSolucao})
		ElseIf (cCodRetVar<>Nil .And. Empty (cCodRetVar))
			cErro		:=	STR0100+SE2CPY->E2_FILIAL			//"Nใo foi encontrado relacionamento para o c๓digo de receita do tํtulo TX [Filial: "
			cErro		+=	STR0002+SE2CPY->E2_PREFIXO			//", Prefixo: "
			cErro		+=	STR0003+SE2CPY->E2_NUM				//", N๚mero: "
			cErro		+=	STR0004+SE2CPY->E2_PARCELA			//", Parcela: "
			cErro		+=	STR0005+SE2CPY->E2_TIPO				//", Tipo: "
			cErro		+=	STR0006+SE2CPY->E2_NATUREZ   		//", Natureza: "
			cErro		+=	STR0101									//"] no parโmetro MV_DCTF."
			cSolucao	:=	STR0103							//"Foi constatado a exist๊ncia dos campos E2_VARIAC e E2_PERIOD no dicionแrio, "
			cSolucao	+=	STR0104							//"para que a rotina gere a informa็ใo correta para a DCTF, deve ser adotado o procedimento "
			cSolucao	+=	STR0105							//"de configura็ใo do parโmetro MV_DCTF conforme boletim t้cnico ou informar o relacionamento "
			cSolucao	+=	STR0106							//"no pr๓prio tํtulo TX atrav้s dos campos E2_VARIAC e E2_PERIOD tamb้m explicados no boletim t้cnico da rotina."
			aAdd (aLog, {cErro, cSolucao})
		EndIf
	EndIf

//Mostra o tํtulo gerado
If lOk 
	cErro		:=	STR0002+SE2CPY->E2_PREFIXO			//"Prefixo: "
	cErro		+=	STR0003+SE2CPY->E2_NUM				//"N๚mero: "
	cErro		+=	STR0004+SE2CPY->E2_PARCELA			//"Parcela: "
	cErro		+=	STR0005+SE2CPY->E2_TIPO	 			//"Tipo: "
	cErro		+=	", Valor: "+Transform(SE2CPY->E2_VALOR,PesqPict("SE2","E2_VALOR"))		//" - Valor: "
	cErro		+=	", Cod. Reten็ใo: " + cCodRetVar
	aAdd (aLog, {cErro, "Gerado"})
Endif

Return (lRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  |GeraTxtLogบAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao para consistir o codigo de receita do titulo tx para posteior geracao de um arquivo TXT  บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณArquivo TXt de log gerado chama-se LOGDCTF.TXT no mesmo diretorio do arquivo-magnetico.         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcDir -> Diretorio de geracao do meio-magnetico.                                                 บฑฑ
ฑฑบ          ณaLog -> Array de log para geracao do TXT ao final do processo.                                  บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณGeraTxtLog (cDir, aLog)                                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function GeraTxtLog (cDir, aLog)
	Local lRet	:= .T.
	Local nI	:= 0
	Local cTxt	:= AllTrim (cDir)+"LOGDCTF.TXT"
	Local nHandle := 0
	Local cTxtBkp := ""
	Local aTitGer := {}

	If !(File (cTxt))
		nHandle	:=	MsFCreate (cTxt)
	Else
		cTxtBkp	:=	StrTran	(cTxt,	".TXT",	".#XT")
		If File (cTxtBkp)
			FErase (cTxtBkp)
		Endif
		FRename (cTxt, cTxtBkp)
		nHandle	:=	MsFCreate (cTxt)
	Endif

	If (Len (aLog)==0)
		cRegistro := STR0111 //"Nenhuma ocorr๊ncia conhecida foi constatada."
		M978Grava (cRegistro, @nHandle)
	Else
		For nI := 1 To Len (aLog)
			If (aLog[nI][1]==Nil) .And. (Len (aLog[nI])==3)
				cRegistro := STR0169+"("+Str (nI, 3)+"): "+aLog[nI][3] //"ALERTA, NAO ERRO"
				M978Grava (cRegistro, @nHandle)

				cRegistro := STR0141+"("+Str (nI, 3)+"): "+aLog[nI][2] //"ACAO TOMADA"
				M978Grava (cRegistro, @nHandle)
			Else
			If aLog[nI][2]=="Gerado" 
				aAdd(aTitGer, aLog[nI][1])
			Else
				cRegistro := STR0112+"("+Str (nI, 3)+"): "+aLog[nI][1] //ERRO
				M978Grava (cRegistro, @nHandle)

				cRegistro := STR0113+"("+Str (nI, 3)+"): "+aLog[nI][2] //SOLUCAO
				M978Grava (cRegistro, @nHandle)
			EndIf
		EndIf
			M978Grava ("", @nHandle)
		Next (nI)
		//Grava a relacao dos titulos gerados
		M978Grava("Titulos Gerados", @nHandle)
		M978Grava("---------------", @nHandle)
		For nI := 1 To Len(aTitGer)
			M978Grava("Item "+StrZero(nI,6)+aTitGer[nI], @nHandle)
		Next
	EndIf
	//-- Fecha arquivo texto                                          ณ
	If (nHandle>=0)
		FClose (nHandle)
	Endif
Return (lRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  |MontcQry  บAutorณ                     Gustavo G. Rueda                       บDataณ  08/02/2006 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao para montar a variavel cQuery com o filtro do processamento.                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณMonta tanto filtro em ambiente TOP (QUERY) ou DBF(INDREGUA).                                    บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณdDataDe -> Data informada no wizard para o inicio do periodo a ser apurado.                     บฑฑ
ฑฑบ          ณdDataAte -> Data informada no wizard para o final do periodo a ser apurado.                     บฑฑ
ฑฑบ          ณaCmpDtFtG -> Campos a serem tratados como fato gerador para calculo do periodo de apuracao.     บฑฑ
ฑฑบ          ณcAlsSe2 -> Alias da tabela SE2 para montagem da query.                                          บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณMontcQry (dDataDe, dDataAte, aCmpDtFtG, cAlsSe2)                                                บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function MontcQry (dDataDe, dDataAte, aCmpDtFtG, cAlsSe2, lTriAnt)
	Local cE2Loja	:= PadR("0000",TamSx3("E2_LOJA")[1])
	Local cE2Fornece:= PadR(cMV_UNIAO,TamSx3("E2_FORNECE")[1])
	Local cQuery	:= ""
	Local cMATA996	:= PadR("MATA996", TamSx3("E2_ORIGEM")[1])
	Local cFISA001	:= PadR("FISA001", TamSx3("E2_ORIGEM")[1])
	Local cMVTPTITU	:= GetNewPar ("MV_TPTITU","")
	Local cFilOri	:= ""
	Local cMVVENCIRF:= Alltrim(SuperGetMv("MV_VENCIRF"))
	Local cMVIRPJ	:= Alltrim(SuperGetMv("MV_IRPJ"))
	Local lMVIRPJ	:= ! Empty(cMVIRPJ)
	Local cMVDCTF000:= SuperGetMv( "MV_DCTF000" )
	Local lMVDCTF000:= "243001A" $ cMVDCTF000 .Or. "677301A" $ cMVDCTF000
	Local lTrimes	:= DateDiffDay(dDataDe,dDataAte) > 60 //Se a diferen็a dos dias for maior que 60 entใo ้ trimestral

	
	#IFDEF TOP
		Local cCmpQry := ""
		Local cCond0  := ""
		Local cCond1  := ""
		Local cCond2  := ""
		Local cWhere1 := ""
		Local cWhere2 := ""
		Local cWhere3 := ""
		Local cWhere4 := ""
		Local cOrderBy:= ""
	#ENDIF
		
	SE2->(DbSetOrder (5))
	
	// Tratamento de forncedor
	IF SA2->(DbSeek(xFilial('SA2')+cE2Fornece))
		cE2Loja := "'" + PadR(Alltrim(SA2->A2_LOJA),TamSx3("E2_LOJA")[1]) + "'"
	EndIF

	If FWModeAccess( "SE2" , 3 ) == "C" .And. SE2->( FieldPos( "E2_FILORIG" ) ) > 0
		cFilOri := "E2_FILORIG='"+cFilAnt+"' AND "
	Else
		cFilOri := "E2_FILIAL='"+xFilial("SE2")+"' AND "
	EndIf
	
	SE2->(DbSetOrder (1))
	
	#IFDEF TOP
		If TcSrvType()<>"AS/400"
			cCmpQry	:=	"%"
			cCmpQry	+=	"E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_FORNECE,E2_LOJA,E2_VALOR,E2_EMISSAO,"
			cCmpQry	+=	"E2_VENCREA,E2_CODRET,E2_PARCSLL,E2_PARCPIS,E2_PARCCOF,E2_PARCIR,E2_EMIS1,E2_IRRF,E2_PIS,E2_COFINS,"
			cCmpQry	+=	"E2_CSLL,E2_CODAGL,E2_PERIOD,E2_VARIAC,E2_DIRF,E2_FILORIG,E2_ORIGEM,E2_BAIXA,SA2.A2_TIPO, SA2.A2_CALCIRF,"
			cCmpQry	+=	"E2_NUMPRO,E2_INDPRO,E2_MULTA,E2_JUROS,E2_PARCCID,E2_CIDE"
			If SE2->(FieldPos("E2_IDDARF")) > 0
				cCmpQry	+=	" ,E2_IDDARF"
			Endif	
			If SE2->(FieldPos("E2_DATASUS")) > 0
				cCmpQry	+=	" ,E2_DATASUS"
			Endif
	    	cCmpQry	+=	"%"
	    
			cCond0	:=	"%" 

			cCond0	+=	cFilOri
			

			If lTriAnt
				cCond0 +=	" (E2_CODRET IN (" + cMV_RECTRIM + ") AND E2_PARCELA NOT IN ('0',' ') AND ( E2_PARCELA NOT IN ('0',' ') OR E2_BAIXA>'"+DToS(dDataAte)+"' ) ) AND E2_TIPO='TX' AND "
			Else	
				cCond0 +=	" ( E2_CODRET NOT IN (" + cMV_RECTRIM + ") OR ( E2_PARCELA IN('0',' ') OR(E2_PARCELA IN ('0',' ') AND (E2_BAIXA=' ' OR E2_BAIXA <= '"+DToS(dDataAte)+"')) AND "      		
				cCond0 +=	"E2_TIPO='TX ')) AND "
			Endif 
            			   
			cCond0  += " (E2_CODRET Not in ('0561', '0588', '0610', '1889', '3533', '3562','0473')) AND " //INSTRUวรO NORMATIVA RFB Nบ 2137, DE 21 DE MARวO DE 2023
			cCond0	+=	"%"
	    
			cCond1	:=	"%"
			If Empty(cMVTPTITU)
				cCond1	+=	"E2_TIPO='"+MVNOTAFIS+"' AND "
			Else
				cCond1	+=  "E2_TIPO IN("+cMVTPTITU+") AND "
			Endif
			cCond1	+=	"%"
			
			cCond2	:=	"%"
			cCond2	+=	"(E2_TIPO='"+MVTAXA+"' OR E2_TIPO='"+MVTXA+"') OR "
			cCond2	+=	"("
			cCond2	+=		"E2_TIPO='"+MVDUPLIC+"' AND "
			cCond2	+=		"E2_ORIGEM='"+cMATA996+"' OR E2_ORIGEM='"+cFISA001+"'"
			cCond2	+=	")"
			cCond2	+=	"%"
			
			cCond3 := "%"
			cCond3 += " E2_PREFIXO <> 'AGP' AND "
			cCond3 += " E2_PREFIXO <> 'AGL' AND "
			cCond3 += " E2_NATUREZ <> '' AND "
			cCond3 += " E2_FORNECE= '" + cE2Fornece +"' AND "
			cCond3 += " E2_LOJA= " +ValToSql(cE2Loja) +" AND "
			If lMVIRPJ .And. lMVDCTF000 .And. Year (dDataDe) == Year (dDataAte) .And. Year (dDataDe) <= Year (dDataBase) .And. Month(dDataAte)== 3
				cCond3 += " E2_VENCREA>= '" + DToS(dDataDe) + "' AND "
				cCond3 += " E2_VENCREA<= '" + DToS(dDataAte) +"' AND "
			ElseIf (SE2->E2_TIPO $ MVTAXA .Or. SE2->E2_TIPO $ MVTXA) .And. Year(dDataDe) <= Year(dDataBase) .And. Month(dDataAte) <= Month(SE2->E2_BAIXA) .And. !lTrimes
				cCond3 += " E2_VENCREA>= '" + DToS(dDataDe) + "' AND "
				cCond3 += " E2_VENCREA<= '" + DToS(dDataAte) +"' AND "
			ElseIf (cMVVENCIRF =="V") .And. lTrimes
				cCond3 += " E2_VENCREA>= '" + DToS(dDataDe) + "' AND "
				cCond3 += " E2_VENCREA<= '" + DToS(dDataAte) +"' AND "
			Else
				cCond3 += " E2_EMISSAO>= '" + DToS(dDataDe) + "' AND "
				cCond3 += " E2_EMISSAO<= '" + DToS(dDataAte) +"' AND "
			Endif
			cCond3 += "%"
			
			cWhere1	:=	"%"
		
			cWhere1	+= "(( E2_IRRF>0 OR E2_CODRET <> '' ) AND "
			if lTriAnt
				cWhere1 += "(E2_EMISSAO>='"+DToS(dDataDe)+"' AND E2_EMISSAO<='"+DToS(dDataAte)+"') "
				//Quando for pessoa fisica e calculo no titulo usa data da baixa
				cWhere1 += " OR (E2_BAIXA BETWEEN '" + DToS(dDataDe) + "' AND '" + DToS(dDataAte) + "' AND SA2.A2_TIPO='F' AND SA2.A2_CALCIRF='2')) "

				aCmpDtFtG[1] := "E2_EMISSAO"
			else
				If cMVVENCIRF=="V" //Se for pelo vencimento
					cWhere1 += "(E2_VENCREA>='"+DToS(dDataDe)+"' AND E2_VENCREA<='"+DToS(dDataAte)+"') "
					//Se titulo IRF gerado na baixa do titulo usa data da baixa.
					cWhere1 += " OR (E2_BAIXA BETWEEN '" + DToS(dDataDe) + "' AND '" + DToS(dDataAte) + "' AND SA2.A2_CALCIRF='2')) "

					aCmpDtFtG[1] := "E2_VENCREA"
				ElseIf cMVVENCIRF=="C"	//Se for pela Contabilizacao
					cWhere1 += "(E2_EMIS1>='"+DToS(dDataDe)+"' AND E2_EMIS1<='"+DToS(dDataAte)+"')) "

					aCmpDtFtG[1] := "E2_EMIS1"
				Else
					cWhere1 += "(E2_EMISSAO>='"+DToS(dDataDe)+"' AND E2_EMISSAO<='"+DToS(dDataAte)+"') "
					//Quando for pessoa fisica e calculo no titulo usa data da baixa
					cWhere1 += " OR (E2_BAIXA BETWEEN '" + DToS(dDataDe) + "' AND '" + DToS(dDataAte) + "' AND SA2.A2_CALCIRF='2')) "

					aCmpDtFtG[1] := "E2_EMISSAO"
				EndIf

			endif
			
			cWhere1	+=	"%"
			
			//Somente considerarei o pai dos titulos TX de PIS/COFINS/CSLL quando o retencao for pela emissao; 
			//	pois quando for pela baixa, estou levando os TXs no OR abaixo.
			cWhere2	:=	"%"
			If AllTrim( SuperGetMv( "MV_BX10925" ) )=="2"
				cWhere2	+=	 		" OR ("
				cWhere2	+=				"E2_VENCREA>='"+DToS(dDataDe)+"' AND "
				cWhere2	+=				"E2_VENCREA<='"+DToS(dDataAte)+"' AND "
				cWhere2	+=				"("
				cWhere2	+=					"E2_PIS>0 OR "
				cWhere2	+=					"E2_COFINS>0 OR "
				cWhere2	+=					"E2_CSLL>0"
				cWhere2	+=				")"
				cWhere2	+=			")"
				
				aCmpDtFtG[2]	:=	"E2_VENCREA"
			EndIf
			cWhere2	+=	"%"
			
			cWhere3	:=	"%"
			If cMV_IRPJ<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_IRPJ+") OR "
			EndIf
			If cMV_IPI<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_IPI+") OR "
			EndIf
			If cMV_CPMF<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_CPMF+") OR "
			EndIf
			If cMV_CIDE<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_CIDE+") OR "
			EndIf
			If cMV_IOF<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_IOF+") OR "
			EndIf
			If cMV_CPSSS<>"''"
				cWhere3	+=	"E2_NATUREZ IN("+cMV_CPSSS+") OR "
			EndIf
			If cMV_IRRF<>"''"
				cWhere3	+=	"(E2_NATUREZ IN("+cMV_IRRF+") AND E2_ORIGEM NOT IN('MATA100')) OR "
			EndIf
			If cMV_CSLL<>"''"
				cWhere3	+=	"(E2_NATUREZ IN("+cMV_CSLL+") AND E2_ORIGEM NOT IN('MATA100')) OR "
			EndIf
			If cMV_PIS<>"''"
				cWhere3	+=	"(E2_NATUREZ IN("+cMV_PIS+") AND E2_ORIGEM NOT IN('MATA100')) OR "
			EndIf
			If cMV_COFINS<>"''"
				cWhere3	+=	"(E2_NATUREZ IN("+cMV_COFINS+") AND E2_ORIGEM NOT IN('MATA100')) OR "
			Endif
			cWhere3	+=	"%"
			
			cWhere4	+=	"%"
			cWhere4	+=	"E2_ORIGEM='GPEM670' AND (E2_PREFIXO='IRF' OR "				
			If Empty(cMVTPTITU)
				cWhere4 +=	"E2_TIPO='IRF' "
			Else
				cWhere4 += "E2_TIPO IN("+cMVTPTITU+") "
			EndIf
			cWhere4	+=	") AND "
			cWhere4	+=	"(E2_EMISSAO>='"+DToS(dDataDe)+"' AND "
			cWhere4	+=	" E2_EMISSAO<='"+DToS(dDataAte)+"' AND "
			cWhere4	+=	" E2_VALOR>0) "

			cWhere4	+=	"%"

			cOrderBy	:=	"% "+SqlOrder (SE2->(IndexKey ()))+" %"
			
			BeginSql Alias cAlsSe2

				COLUMN E2_EMISSAO AS DATE
				COLUMN E2_VENCREA AS DATE
				COLUMN E2_EMIS1 AS DATE
				COLUMN E2_BAIXA AS DATE
		
				SELECT
				%Exp:cCmpQry%
				FROM
				%Table:SE2% SE2
				LEFT JOIN %Table:SA2% SA2 ON(SA2.A2_FILIAL=%xFilial:SA2% AND SA2.A2_COD=SE2.E2_FORNECE and SA2.A2_LOJA=SE2.E2_LOJA AND SA2.%NotDel%)
				WHERE
				SE2.%NotDel% AND
				%Exp:cCond0%
				((
				%Exp:cCond1%
				(
				(
				%Exp:cWhere1%
				)			
				%Exp:cWhere2%
				)
				)
				OR
				(
				(
				%Exp:cCond2%
				) AND
					
				%Exp:cCond3%										
				(
				%Exp:cWhere3%
				(
				%Exp:cWhere4%
				)
				)
				))
				ORDER BY
				%Exp:cOrderBy%
			EndSql
			
			cQuery	:=	GetLastQuery()[2]

		Else
	#ENDIF
			If FWModeAccess( "SE2" , 3 ) == "C" .And. SE2->( FieldPos( "E2_FILORIG" ) ) > 0
				cQuery	:=	'E2_FILORIG=="'+cFilAnt+'" .And. '
			Else
				cQuery	:=	'E2_FILIAL=="'+xFilial("SE2")+'" .And. '
			EndIf
			cQuery	+=	'(('
			If Empty(cMVTPTITU)
				cQuery	+=		'E2_TIPO$"'+MVNOTAFIS+'" .And. '
			Else
				cQuery	+=		'E2_TIPO$"'+cMVTPTITU+'" .And. '
			EndIf
			cQuery	+=		'('
			cQuery	+=			'('
			If cMVVENCIRF=="V"		//Se for pelo vencimento
				cQuery	+=			'DToS (E2_VENCREA)>="'+DToS (dDataDe)+'" .And. '
				cQuery	+=			'DToS (E2_VENCREA)<="'+DToS (dDataAte)+'" .And. '
				aCmpDtFtG[1]	:=	"E2_VENCREA"
			ElseIf cMVVENCIRF=="C"	//Se for pela Contabilizacao
				cQuery	+=			'DToS (E2_EMIS1)>="'+DToS (dDataDe)+'" .And. '
				cQuery	+=			'DToS (E2_EMIS1)<="'+DToS (dDataAte)+'" .And. '
				aCmpDtFtG[1]	:=	"E2_EMIS1"
			Else												//Se for pela Emissao
				cQuery	+=			'DToS (E2_EMISSAO)>="'+DToS (dDataDe)+'" .And. '
				cQuery	+=			'DToS (E2_EMISSAO)<="'+DToS (dDataAte)+'" .And. '
				aCmpDtFtG[1]	:=	"E2_EMISSAO"
			EndIf
			cQuery	+=				'E2_IRRF>0'
			cQuery	+=			')'
			//Somente considerarei o pai dos titulos TX de PIS/COFINS/CSLL quando o retencao for pela emissao; 
			//	pois quando for pela baixa, estou levando os TXs no OR abaixo.
			If AllTrim( SuperGetMv( "MV_BX10925" ) )=="2"
				cQuery	+=		' .Or. ('
				cQuery	+=			'DToS (E2_VENCREA)>="'+DToS (dDataDe)+'" .And. '
				cQuery	+=			'DToS (E2_VENCREA)<="'+DToS (dDataAte)+'" .And. '
				cQuery	+=			'(E2_PIS>0 .Or. E2_COFINS>0 .Or. E2_CSLL>0)'
				cQuery	+=		')'
				aCmpDtFtG[2]	:=	"E2_VENCREA"
			EndIf
			cQuery	+=		')'
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณNeste .OR. deve entrar todos os titulos TX que nao tem pai ou os titulos   ณ
			//ณ   TX gerado pela BAIXA (E2_EMISSAO==DATA BAIXA) no caso do PIS/COFINS/CSLLณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			cQuery	+=	')'
			cQuery	+=	' .Or.'
			cQuery	+=	'('
			cQuery	+=		'('
			cQuery	+=			'(E2_TIPO="'+MVTAXA+'" .Or. E2_TIPO="'+MVTXA+'" ).Or. '
			cQuery	+=			'('
			cQuery	+=				'E2_TIPO="'+MVDUPLIC+'" .And. E2_ORIGEM="'+cMATA996+'" OR E2_ORIGEM="'+cFISA001+'" '
			cQuery	+=			')'
			cQuery	+=		') .And. '
			cQuery	+=		'!"AGP"$E2_PREFIXO .And. '
			cQuery	+=		'!"AGL"$E2_PREFIXO .And. '
			cQuery	+=		'E2_NATUREZ<>"'+Space(Len(SE2->E2_NATUREZ))+'" .And. '
			cQuery	+=		'E2_FORNECE=="'+cE2Fornece+'" .And. '
			cQuery	+=		'E2_LOJA=="'+cE2Loja+'" .And. '
			cQuery	+=		'DToS (E2_EMISSAO)>="'+DToS (dDataDe)+'" .And. '
			cQuery	+=		'DToS (E2_EMISSAO)<="'+DToS (dDataAte)+'" .And. '
			cQuery	+=		'(E2_NATUREZ$"'+cMV_IRPJ+cMV_IPI+cMV_CPMF+cMV_CIDE+cMV_IOF+'" .Or. '
			cQuery	+=		'(E2_NATUREZ$"'+cMV_IRRF+cMV_CSLL+cMV_PIS+cMV_COFINS+'" .And. !"MATA100"$E2_ORIGEM))'		//no caso do IRRF, PIS, COFINS e CSLL, somente considerarei o TX quando for lancado manualmente (diferente MATA100 - NF)
			cQuery	+=	'))'
	#IFDEF TOP
		EndIf
	#ENDIF
Return (cQuery)	//Retorno somente tratado em DBF
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณSetVar    บAutorณ                     Gustavo G. Rueda                       บDataณ  25/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que monta o conteudo dos parametros conforme ambiente TOP/DBF para filtros posteriores   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcPar -> Nome do parametro a ser formatado no padrao para compracao atraves do contem ou contido บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณcMvStr -> Variavel com o conteudo formatado para comparacao atraves do contem ou contido        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณSetVar(cPar)                                                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function SetVar(cPar)
	Local	nLenNat	:=	TamSx3("E2_NATUREZ")[1]
	Local	nLenRet	:=	TamSx3("E2_CODRET")[1]
	Local	cStrAux	:=	""
	Local	cMvStr	:=	""
	Local	nI		:=	0
	Local	cCont	:=	""

	If(cPar$"MV_IRF")

		#IFDEF TOP
			cMvStr	:=	"'"+PadR(&(GetNewPar (cPar,	"")), nLenNat)+"'"
		#ELSE
			cMvStr	+=	PadR(&(SuperGetMv (cPar)), nLenNat)
		#ENDIF

	Else

		cStrAux	:=	GetNewPar (cPar, "")
		For nI := 1 To Len(cStrAux)
			If ("/"$SubStr (cStrAux, nI, 1) .Or.;
					(!"/"$SubStr (cStrAux, nI, 1) .And. Len(cStrAux)==nI)) .And.;
					!Empty (cCont)
			
				If (!"/"$SubStr (cStrAux, nI, 1) .And. Len(cStrAux)==nI)
					cCont	+=	SubStr (cStrAux, nI, 1)
				EndIf
			
				#IFDEF TOP
					cMvStr	+=	"'"+PadR (cCont, nLenNat)+"'"
					If !Len (cStrAux)==nI
						cMvStr	+=	","
					EndIf
				#ELSE
					cMvStr	+=	PadR (cCont, nLenNat)+"/"
				#ENDIF

				cCont	:=	""
			Else
				cCont	+=	SubStr (cStrAux, nI, 1)
			EndIf
		Next(nI)
	
		If(cPar$"MV_M978CSR")

			#IFDEF TOP
				cMvStr	:=	"'5952','5960','5979','5987',"+cMvStr
			#ELSE
				cMvStr	+=	PadR ("5952", nLenRet)+"/"
				cMvStr	+=	PadR ("5960", nLenRet)+"/"
				cMvStr	+=	PadR ("5979", nLenRet)+"/"
				cMvStr	+=	PadR ("5987", nLenRet)+"/"
			#ENDIF

		EndIf

	EndIf

Return(cMvStr)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณSetIPCCI  บAutorณ                     Gustavo G. Rueda                       บDataณ  25/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que monta o conteudo dos parametros que identificam as naturezas dos titulos TX. Atraves บฑฑ
ฑฑบ          ณ desta funcao, podemos ter varios parametros para uma mesma natureza, desde que inicie-se por   บฑฑ
ฑฑบ          ณ MV_978IR para o IR, MV_978PI para o PIS, MV_978CS para a CSLL e MV_978CO para a COFINS.        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcMV_IRRF -> Parametro de IR a receber as outras naturezas conforme nova regra.                  บฑฑ
ฑฑบ          ณcMV_PIS -> Parametro de PIS a receber as outras naturezas conforme nova regra.                  บฑฑ
ฑฑบ          ณcMV_CSLL -> Parametro de CSLL a receber as outras naturezas conforme nova regra.                บฑฑ
ฑฑบ          ณcMV_COFINS -> Parametro de COFINS a receber as outras naturezas conforme nova regra.            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณcMvStr -> Variavel com o conteudo formatado para comparacao atraves do contem ou contido        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณSetVar(cPar)                                                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function SetIPCCI(cMV_IRRF,cMV_PIS,cMV_CSLL,cMV_COFINS)
	Local	lRet	:=	.T.
	Local	aPar	:=	{"MV_978IR","MV_978PI","MV_978CS","MV_978CO"}
	Local	nI		:=	0

//MV_978IR??, MV_978PI??, MV_978CS??, MV_978CO??

	For nI := 1 To Len(aPar)
		SX6->(dbSeek(xFilial("SX6")+aPar[nI]))
		While !SX6->(Eof()) .And. SX6->(X6_FIL+Left(X6_VAR,Len(aPar[nI])))==xFilial("SX6")+aPar[nI]
        
			#IFDEF TOP
				If nI==1 .And. cMV_IRRF<>"''"
					cMV_IRRF	+=	","
				EndIf
				If nI==2 .And. cMV_PIS<>"''"
					cMV_PIS		+=	","
				EndIf
				If nI==3 .And. cMV_CSLL<>"''"
					cMV_CSLL	+=	","
				EndIf
				If nI==4 .And. cMV_COFINS<>"''"
					cMV_COFINS	+=	","
				EndIf
			#ENDIF
		
			If nI==1
				cMV_IRRF	+=	SetVar(SX6->X6_VAR)
			ElseIf nI==2
				cMV_PIS		+=	SetVar(SX6->X6_VAR)
			ElseIf nI==3
				cMV_CSLL	+=	SetVar(SX6->X6_VAR)
			ElseIf nI==4
				cMV_COFINS	+=	SetVar(SX6->X6_VAR)
			EndIf
	   	
			SX6->(dbSkip())
		End
	Next nI

Return(lRet)


/************************************************* WIZARD *************************************************/

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Wiz   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que monta o wizard da rotina.                                                            บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณNenhum                                                                                          บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณlRet -> Flag de conclusao do wizard(.T.) ou cancelamento(.F.)                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Wiz ()                                                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Wiz (cMV_DCTFCDG)
	Local	aTxtApre	:=	{}
	Local	aPaineis	:=	{}
	Local	aItens1		:=	{}
	Local	aItens2		:=	{}
	Local	cTitObj1	:=	""
	Local	cTitObj2	:=	""
	Local	lRet		:=	.T.
	Local	cNomeAnt	:=	"DCTF" + FWGETCODFILIAL
	Local	cNomeCfp	:=	"DCTF" + FWGrpCompany() + FWGETCODFILIAL
	Local	cNomeRen	:=	"DCTF" + FWGrpCompany() + FWGETCODFILIAL	+ ".cf#"
	
	//Consistencia do CFP utilizado para este meio-magnetico. Caso o que exista nao esta nas caracteristicas do utilizado pela rotina sera excluido e gerado um novo correto.
	cNomeCFP := Iif(File(cNomeCfp+".cfp"),cNomeCfp,cNomeAnt)
	If (xMagLeWiz (cNomeCFP, @aPaineis, .T.))
		If Len (aPaineis[1])<9 .Or. Len (aPaineis[3])<>20
			FRename( cNomeCFP , cNomeRen )
			FErase (cNomeCFP)
		EndIf
	EndIf
	aPaineis	:=	{}

	//
	aAdd (aTxtApre, STR0010)	//"Parametros necessarios da DCTF."
	aAdd (aTxtApre, STR0011)
	aAdd (aTxtApre, STR0012)	//"Preencha corretamente as informacoes solicitadas."
	aAdd (aTxtApre, STR0013)	//"Informacoes necessarias para preechimento automatico da DCTF - Declaracao de Debitos e Creditos dos Tributarios Federais."
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 0ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)	//"Parametros necessarios da DCTF."
	aAdd (aPaineis[nPos], STR0014)	//"Preenchimento de algumas das informacoes necessarias para a geracao do meio-magnetivo conforme versao 3.0 do validador."
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0015;								   			cTitObj2	:=	STR0016
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});					aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,,3,,,,});							aAdd (aPaineis[nPos][3], {2,,,3,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0017;											cTitObj2	:=	STR0018		//"Numero Livro"###"Diretorio de destino"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});					aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	cTitObj1	:=	"X";  												cTitObj2	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,"X",1,,,,40})
	//
	If Empty(cMV_DCTFCDG)
		aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,40})
	Else
		aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,40,{.T.,cMV_DCTFCDG}})
	EndIf
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0019;											cTitObj2	:=	STR0020		//"Considera Filiais ?"###"Filial De"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});					aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens1	:=	{STR0021, STR0022}		//"Sim"###"Nao"
	aAdd (aPaineis[nPos][3], {6,,,,,aItens1,,});						aAdd (aPaineis[nPos][3], {2,,replicate("X",tamSX3("F3_FILIAL")[1]),1,,,,tamSX3("F3_FILIAL")[1]})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//																	
	cTitObj2	:=	STR0023		//"Filial Ate"
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {2,,replicate("X",tamSX3("F3_FILIAL")[1]),1,,,,tamSX3("F3_FILIAL")[1]})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0086;											cTitObj2	:=	STR0313
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});					aAdd (aPaineis[nPos][3], {1,cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXX",1,,,,3});                      aItens1	:=	{STR0314,STR0315}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,})

	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	
		
	cTitObj1	:=	"Seleciona filiais?";								cTitObj2	:=	"Aglutina por CNPJ?"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});					aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens1		:=	{"Sim", "Nใo"}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});						aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,})
					
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 1ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0024)		//"Preenchimento de algumas das informacoes necessarias para uma nova DCTF."
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0025		//"Situacao Especial"
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});							aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0026;										cTitObj2	:=	STR0027			//"Data Evento"###"Evento"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens2	:=	{STR0028, STR0029, STR0030, STR0031, STR0032, STR0033, STR0034}
	aAdd (aPaineis[nPos][3], {2,,,3,,,,});						aAdd (aPaineis[nPos][3], {3,,,,,aItens2,,})
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 2ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0035)
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0036;										cTitObj2	:=	STR0037
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens1		:=	{STR0038, STR0039}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});					aAdd (aPaineis[nPos][3], {2,,"XXXXXXXXXXXX",1,,,,12})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0040
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//                                                               
	cTitObj1	:=	STR0041;										cTitObj2	:=	STR0092
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens1		:=	{STR0043, STR0044, STR0045, STR0046, STR0047, STR0048, STR0176, STR0028}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});					aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0042
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//Qualificacao da PJ	
	aItens1	:=	{STR0049, STR0050, STR0051, STR0052, STR0053, STR0054, STR0055, STR0170, STR0171, STR0172, STR0173}
	cTitObj2	:=	STR0056
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});					aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj2	:=	STR0057;										cTitObj1	:=	STR0058
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj2	:=	STR0059;										cTitObj1	:=	STR0089
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj2	:=	STR0090;										cTitObj1	:=	STR0091
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0060;										cTitObj2	:=	STR0061
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0087
	cTitObj2	:=	STR0088
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aItens1	:=	{STR0302,STR0303,STR0304,STR0305}
	cTitObj1	:=	STR0306;										cTitObj2	:=	STR0307
	aAdd (aPaineis[nPos][3], {1,cTitObj1,,,,,,});				    aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,})
	//									    	
	
	aItens1 := {STR0316, STR0317, STR0318, STR0319, STR0320, STR0333}
	cTitObj1	:=	STR0312
	aAdd (aPaineis[nPos][3], {1,"",,,,,,});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	aAdd (aPaineis[nPos][3], {1,"",,,,,,})
	aAdd (aPaineis[nPos][3], {1,cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});			aAdd (aPaineis[nPos][3], {1,"",,,,,,})
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
    								

	aItens1 := {STR0322, STR0323, STR0324, STR0325}
	
	aItens2 := {STR0326, STR0327, STR0328, STR0329, STR0330}
	
	
	cTitObj1	:=	STR0331;										cTitObj2	:=	STR0332
	
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});   	   	aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});		   		aAdd (aPaineis[nPos][3], {3,,,,,aItens2,,});
	//
		aAdd (aPaineis[nPos][3], {0,"",,,,,,});			   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	
	cTitObj1	:=	STR0335;										cTitObj2	:=	STR0336
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aItens1		:=	{"Sim", "Nใo"}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});				aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})	
	cTitObj1	:=	STR0337;										aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,})
	aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	aItens1		:=	{"Sim", "Nใo"}
	aAdd (aPaineis[nPos][3], {3,,,,,aItens1,,});
	
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 3ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0062)	//"Preenchimento de algumas das informacoes necessarias para a guia de Dados Cadastrais."
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0063;											cTitObj2	:=	STR0064		//"DDD Telefone"###"Numero Telefone"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});					aAdd (aPaineis[nPos][3], {2,,"XXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});	   					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//                                 
	cTitObj1	:=	STR0065;										cTitObj2	:=	STR0066		//"DDD Fax"###"Numero Fax"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});					aAdd (aPaineis[nPos][3], {2,,"XXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0067;										cTitObj2	:=	STR0068
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//                                       
	aAdd (aPaineis[nPos][3], {2,,"XXXXXX",1,,,,6});				aAdd (aPaineis[nPos][3], {2,,"XX",1,,,,2})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0069
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});		   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXXXXXX",1,,,,8});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});				   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//                                 
	cTitObj1	:=	STR0070
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,40});				aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 4ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0071)		//"Preenchimento de algumas das informacoes necessarias para a guia de Dados do Representante para PJ."
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0072;									cTitObj2	:=	STR0073		//"Nome Representante"###"CPF Representante"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	cTitObj2	:=	"XXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,60});	  		aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,11})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			  		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0063;									cTitObj2	:=	STR0064
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});   	   		aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});		   		aAdd (aPaineis[nPos][3], {2,,"XXXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			   		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0074
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
    //                                      
	aAdd (aPaineis[nPos][3], {2,,"XXXXX",1,,,,5});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0065;									cTitObj2	:=	STR0066
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});				aAdd (aPaineis[nPos][3], {2,,"XXXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0070
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,40});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	
	
	
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 5ณ
	//ภฤฤฤฤฤฤฤฤู
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0075)	//"Preenchimento de algumas das informacoes necessarias para a guia de Dados do Responsavel pelo preenchimento."
	aAdd (aPaineis[nPos], {})
	//
	cTitObj1	:=	STR0076;									cTitObj2	:=	STR0077
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	cTitObj2	:=	"XXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,60});			aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,11})
	//                                                      
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0078;									cTitObj2	:=	STR0079
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXX";							cTitObj2	:=	"XX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,15});			aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,2})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0063;									cTitObj2	:=	STR0064
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});				aAdd (aPaineis[nPos][3], {2,,"XXXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			 		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//	
	cTitObj1	:=	STR0074
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
    //                                                      	
	aAdd (aPaineis[nPos][3], {2,,"XXXXX",1,,,,5});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			 		aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0065;									cTitObj2	:=	STR0066
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {1, cTitObj2,,,,,,})
	//
	aAdd (aPaineis[nPos][3], {2,,"XXXX",1,,,,4});				aAdd (aPaineis[nPos][3], {2,,"XXXXXXXXX",1,,,,9})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});					aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	STR0070		//"Correio Eletronico"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	aAdd (aPaineis[nPos][3], {2,,cTitObj1,1,,,,40});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 6ณ
	//ภฤฤฤฤฤฤฤฤู
	//
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0010)
	aAdd (aPaineis[nPos], STR0301)	//"Meses com aus๊ncia de D้bitos a Declarar"
	aAdd (aPaineis[nPos], {})
	//
	cTitObj2	:=	"Janeiro";										cTitObj1	:=	"Fevereiro"
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj2	:=	"Mar็o";										cTitObj1	:=	"Abril"
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj2	:=	"Maio";										cTitObj1	:=	"Junho"
	aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"Julho";										cTitObj2	:=	"Agosto"
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"Setembro";										cTitObj2	:=	"Outubro"
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1	:=	"Novembro";										cTitObj2	:=	"Dezembro"
	aAdd (aPaineis[nPos][3], {4, cTitObj1,,,,,.F.,});				aAdd (aPaineis[nPos][3], {4, cTitObj2,,,,,.F.,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});						aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	If ExistBlock("A978WIZ")
		aPaineis	:=	ExecBlock ("A978WIZ", .F., .F., {aPaineis})
	EndIf

	//Se nao existir configuracao por filial, carrega a ultima (arquivo DCTF.CFP) e depois grava configuracao da filial
	If cNomeCFP == cNomeAnt
		lRet	:=	xMagWizard (aTxtApre, aPaineis, "DCTF" + FWGrpCompany() + FWGETCODFILIAL,cNomeAnt)
	Else
		lRet	:=	xMagWizard (aTxtApre, aPaineis, "DCTF" + FWGrpCompany() + FWGETCODFILIAL)
	EndIf
	
Return (lRet)

/************************************************* REGISTROS *************************************************/


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Head  บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao do registro Header do arquvio.                                                บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณcDctf -> Versao da DCTF em processamento                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Head (@nHandle, aIniWiz, cDctf)                                                             บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Head (nHandle, aIniWiz, cDctf, aSituacao)
	Local 	cRegistro	:= ""
	Local 	nPos		:=	0
	Local	nTrimFg		:=	M978Trim (aIniWiz)
	Local	cSituacao	:=	""
	Local	aTipDecl	:=	{STR0038, STR0039}	//{"Original", "Retificadora"}
	//
	//Somente na DCTF Mensal ou Semestral
	If ("M"$cDctf .Or. "S"$cDctf)
		//
		//Sistema
		cRegistro   := M978Fil (cDctf, 5)
		//
		//Reservado
		cRegistro   += M978Fil (Space(08), 7)
		
	//DCTF Trimestral
	Else
		//
		//Sistema
		cRegistro   := M978Fil ("DCTF", 4)
		//
		//Reservado
		cRegistro   += M978Fil (Space (08), 8)
	EndIf
	//
	// Ano de competencia da declaracao
	cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4), 4)
	//
	// Reservado
	cRegistro   += M978Fil (Iif(aIniWiz[1,8] >= "340","1930","0000"), 4)
	//
	// Tipo de declaracao - "0" Original, "1" Retificadora 
	cRegistro   += StrZero (aScan (aTipDecl, AllTrim (aIniWiz[3][1]))-1, 1)
	//
	// CNPJ do contrubuinte
	cRegistro   += M978Fil (SM0->M0_CGC, 14)
	//
	// Reservado
	cRegistro   += M978Fil ("0", 1)
	//
	// Versao
	cRegistro   += M978Fil (aIniWiz[1][8], 3)
	//
	// Nome empresarial
	cRegistro   += M978Fil (SubStr (SM0->M0_NOMECOM, 1, 60), 60)
	//
	// UF domicilio
	If "1"$aIniwiz[1][9]
		cRegistro   += M978Fil (SubStr (SM0->M0_ESTENT, 1, 2), 2)
	Else
		cRegistro   += M978Fil (SubStr (SM0->M0_ESTCOB, 1, 2), 2)
	EndIf
	//
	//Somente na DCTF Mensal ou Semestral
	If ("M"$cDctf) .Or. ("S"$cDctf)
		//
		// Reservado
		cRegistro   += M978Fil ("00000000000", 11)
		
	//DCTF Trimestral
	Else
		//
		// Reservado
		cRegistro   += M978Fil ("0000000000", 10)
	EndIf
	//
	// Situacao
	nPos	:=	aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1
	cSituacao	:=	M978Fil (StrZero (nPos, 2), 2)
	cRegistro   += M978Fil (cSituacao, 2)
	//
	// Ano de competencia da declaracao
	cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4), 4)
	//
	//Somente na DCTF Mensal
	If ("M"$cDctf)
		//
		// Mes de competencia da declaracao
		cRegistro	+=	M978Fil (StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 2)
		
	//Somente na DCTF Semestral
	ElseIf ("S"$cDctf)
		//
		// Semestre de competencia da declaracao
		If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
			cRegistro   += StrZero (2, 2)		//SS
		
		// Semestre de competencia da declaracao
		Else
			cRegistro   += StrZero (1, 2)		//SS
		EndIf

	//Somente na DCTF Trimestral
	Else
		// Trimestre de competencia da declaracao
		cRegistro   += M978Fil (StrZero (nTrimFg, 2), 2)
	EndIf
	//
	// Reservado
	cRegistro   += M978Fil ("00000000000", 11)
	//                                                                       
	// Periodo base inicial
	cRegistro   += M978Fil (RetDatDCTF (SToD (Padr (aIniWiz[1][1], 8))), 8)
	//
	// Periodo base final
	cRegistro   += M978Fil (RetDatDCTF (SToD (Padr (aIniWiz[1][2], 8))), 8)
	//
	// Data de ocorrencia do evento
	If ("00"$cSituacao)
		cRegistro	+=	M978Fil ("00000000", 8)
	Else
		cRegistro   += M978Fil (RetDatDCTF (SToD (Padr (aIniWiz[2][2], 8))), 8)
	EndIf
	//
	//Somente na DCTF Mensal
	If ("M"$cDctf)
		//Reservado
		cRegistro   += M978Fil ("00", 2)
		//
		//Reservado
		If Year(SToD (Padr (aIniWiz[1][1], 8)))>=2006	//Layout alterado para VERSAO 1.4
			cRegistro   += M978Fil (Space (207), 207)
		Else
			cRegistro   += M978Fil (Space (81), 81)	//Layout antigo, versao 1.1
		EndIf
		
	//Somente na DCTF Semestral
	ElseIf ("S"$cDctf)
		//
		//Se versao 100, "000" e 80 espacos
		//Se versao 130, "00" e 207 zeros
		If M978Fil (aIniWiz[1][8], 3) == "100"
			//Reservado
			cRegistro   += M978Fil ("000", 3)
			//
			//Reservado
			cRegistro   += M978Fil (Space(80), 80)
		ElseIf M978Fil (aIniWiz[1][8], 3) == "130" .or. M978Fil (aIniWiz[1][8], 3) ="140" .or. M978Fil (aIniWiz[1][8], 3) ="150"
			//Reservado
			cRegistro   += M978Fil ("00", 2)
			//
			//Reservado
			cRegistro   += M978Fil (Replicate("0",207), 207)
		EndIf
	
	//Somente na DCTF Trimestral
	Else
		//
		//Reservado
		cRegistro   += M978Fil ("0", 1)
		//
		//Reservado
		cRegistro   += M978Fil (Space (83), 83)
	EndIf
	//
	// Reservado
	cRegistro   += M978Fil ("0000000000", 10)
	//
	M978Grava(cRegistro, @nHandle)
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978R01   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao do registro R01 do arquvio.                                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณcDctf -> Versao da DCTF em processamento                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978R01 (@nHandle, aIniWiz, cDctf)                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978R01 (nHandle, aIniWiz, cDctf, aSituacao)
	Local	nTrimFg		:=	M978Trim (aIniWiz)
	Local 	cRegistro   :=	""
	Local	nPos 		:= 	0
	Local	aFormTrib	:=	{STR0043, STR0044, STR0045, STR0046, STR0047, STR0048, STR0176, STR0028}	//{"Real Trimestral", "Real Estimativa", "Presumido", "Arbitrario", "Imune do IRPJ", "Isenta do IRPJ", "Declarante Nใo ้ Contribuinte do IRPJ", "Nใo se aplica"}
	Local	aQualiPJ	:=	{STR0049, STR0050, STR0051, STR0052, STR0053, STR0054, STR0055, STR0170, STR0171, STR0172, STR0173} //{"Financeira", "Soc. Seg. de Capitalizacao ou...", "Corretora Aut. de Seguros", "Cooperativa de Credito", "Entid. fechada ou Aberta de PC", "Sociedade Corporativa", "PJ em Geral", "Soc.Coop.Prod.Agro.Cons.", "Autarquia/Fundacao Publica", "Orgใo P๚blico da Adm. Direta", "Emp.Pub./Soc.Econ.Mista/Demais PJ"}
	Local	aTipDecl	:=	{STR0038, STR0039}	//{"Original", "Retificadora"}
	Local	cForTriLuc	:= ""
	//
	//Tipo do registro
	cRegistro   := M978Fil ("R01", 3)
	//
	//CNPJ contribuinte
	cRegistro   += M978Fil (SM0->M0_CGC, 14)
	//
	//Somente DCTF Mensal
	If ("M"$cDctf)
		//
		//AAAA+MM
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
	//Somente DCTF Semestral
	ElseIf ("S"$cDctf)
		If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
			//
			//AAAA+SS
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
		Else
			//
			//AAAA+SS
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
		EndIf
	//Somente DCTF Trimestral
	Else
		//
		//AAAA+T
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
	EndIf
	//
	// Situacao
	nPos	:=	aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1
	cSituacao	:=	StrZero (nPos, 1)
	cRegistro   += M978Fil (cSituacao, 1)
	//
	// Data de ocorrencia do evento
	If ("0"$cSituacao)
		cRegistro	+=	M978Fil ("00000000", 8)
	Else
		cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
	EndIf
	//
	//Periodo inicial
	cRegistro	+=	M978Fil (StrZero (Day (SToD (Padr (aIniWiz[1][1], 8))), 2)+StrZero (Month (SToD (Padr (aIniWiz[1][1], 8))), 2), 4)
	//
	//Periodo final
	cRegistro	+=	M978Fil (StrZero (Day (SToD (Padr (aIniWiz[1][2], 8))), 2)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 4)
	//
	// Tipo de declaracao - "0" Original, "1" Retificadora 
	cRegistro   += StrZero (aScan (aTipDecl, AllTrim (aIniWiz[3][1]))-1, 1)
	//
	//Num. do recebido da declaracao retificadora
	If "1"$StrZero (aScan (aTipDecl, AllTrim (aIniWiz[3][1]))-1, 1)
		cRegistro   +=	M978Fil (Padr (aIniWiz[3][2], 12), 12)
	Else
		cRegistro   +=	"000000000000"
	EndIf
	//
	//Somento DCTF Mensal
	If("M"$cDctf)
		//
		//Forma de tributacao do lucro
		If (cForTriLuc := aScan(aFormTrib, AllTrim(aIniWiz[3][4]))-1) > 5			
			If aIniWiz[1,8] >= "340" .And. AllTrim(aIniWiz[3][25])$"Sim" .And. aQualiPJ[10] <> aIniWiz[3][6]
				cForTriLuc := 9
			Else
				cForTriLuc := 8
			Endif
		Endif		
		cRegistro	+=	StrZero(cForTriLuc, 1)
		//
		//Qualificacao PJ
		If Val(M978Fil(aIniWiz[1,8],3)) >= 150
			cRegistro   +=	StrZero (aScan (aQualiPJ, AllTrim (aIniWiz[3][6])), 2) //Tamanho 2 para versao 150
		Else
			cRegistro   +=	StrZero (aScan (aQualiPJ, AllTrim (aIniWiz[3][6])), 1) //Tamanho 1 para outras versoes
		EndIf
		//
		//PJ levantou balanco/balancete de suspensao no mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][7], 1), "0", "1")
		//
		//PJ com debitos de SCP a serem declarados
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][14], 1), "0", "1")
		//
		IF aIniWiz[1,8] >= "330"
			cRegistro   +=	Iif ("N"$Padr(aIniWiz[3][23],1), "0", "1") //Empresa optante pelo Simples Nacional
			cRegistro   +=	Iif ("N"$Padr(aIniWiz[3][24],1), "0", "1") //PJ optante pela CPRB
		ElseIF aIniWiz[1,8] >= "310" /*Ordem 14 - Reservado na versao 310*/
			cRegistro   += "00"
		EndIf
		IF aIniWiz[1,8] >= "340"
			cRegistro   +=	Iif ("N"$Padr(aIniWiz[3][25],1), "0", "1") //PJ inativa no m๊s da declara็ใo
		Endif		
		IF aIniWiz[1,8] < "310"
			//PJ Optante pelo Regime Especial de Tributacao do art. 2. da MP n. 2.222/2001
			If M978Fil (aIniWiz[1,8], 3) $ "150/160/170/190/200/210/220"
				cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][15], 1), "0", "1")
			EndIf
			//PJ Esteve inativa
			If M978Fil (aIniWiz[1,8], 3) $ "230/240/250"
				cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][3], 1), "0", "1")
			EndIf
			//PJ com incorporacao submetida ao Regime Especial Tributario do Patrimonio de Afetacao(art. 1. da Lei n. 10.931/2004)
			If M978Fil (aIniWiz[1,8], 3) $ "150/160/170/190/200/210/220"
				cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][16], 1), "0", "1")
			EndIf
			//PJ esteve obrigada a apresetacao da DCTF no ano anterior
			cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][17], 1), "0", "1")
		EndIf
		//Criterio de Reconhecimento das Variacoes Monetarias 
		If Val(M978Fil(aIniWiz[1,8],3)) >= 230
			cRegistro   +=	Padr (aIniWiz[3][20], 1)
		EndIf
   		IF aIniWiz[1,8]>= "340"
			cRegistro   += "00000000000"
		ElseIF aIniWiz[1,8]>= "310"
			cRegistro   += "000000000000"	
		EndIf
   		
		//
		//Meses com ausencia de debitos a declarar
		//
		IF aIniWiz[1,8] < "310"
			//Janeiro
			cRegistro += Iif("T"$Padr(aIniWiz[7][1],1),"1","0")
			//Fevereiro
			cRegistro += Iif("T"$Padr(aIniWiz[7][2],1),"1","0")
			//Mar็o
			cRegistro += Iif("T"$Padr(aIniWiz[7][3],1),"1","0")
			//Abril
			cRegistro += Iif("T"$Padr(aIniWiz[7][4],1),"1","0")
			//Maio                            
			cRegistro += Iif("T"$Padr(aIniWiz[7][5],1),"1","0")
			//Junho
			cRegistro += Iif("T"$Padr(aIniWiz[7][6],1),"1","0")
			//Julho
			cRegistro += Iif("T"$Padr(aIniWiz[7][7],1),"1","0")
			//Agosto
			cRegistro += Iif("T"$Padr(aIniWiz[7][8],1),"1","0")
			//Setembro
			cRegistro += Iif("T"$Padr(aIniWiz[7][9],1),"1","0")
			//Outubro
			cRegistro += Iif("T"$Padr(aIniWiz[7][10],1),"1","0")
			//Novembro
			cRegistro += Iif("T"$Padr(aIniWiz[7][11],1),"1","0")
			//Dezembro
			cRegistro += Iif("T"$Padr(aIniWiz[7][12],1),"1","0")
		EndIf
		//
		//Regime de Apura็ใo da Contribui็ใo para o PIS/Pasep e da Cofins
		cRegistro += M978Fil (Padr (aIniWiz[3][19], 1), 1)
		//
		// PJ iniciou atividades no mes da declara็ใo
		IF aIniWiz[1,8] < "310"
			cRegistro += Iif ("F"$Padr(aIniWiz[3][18],1),"0","1")
		EndIf
		
		IF aIniWiz[1,8] >= "310"
			//18 -Situa็ใo da PJ no m๊s da declara็ใo
			cRegistro += M978Fil (Padr (aIniWiz[3][21], 1), 1)
			
			//19- Op็๕es referentes เ Lei 12.973/2014 para o ano-calendแrio de 2014
			cRegistro += M978Fil (Padr (aIniWiz[3][22], 1), 1)
		EndIf
		
	//Somente DCTF Semestral
	ElseIf ("S"$cDctf)
		//
		//PJ esteve inativa desde o inicio do ano calendario/data de sua constituicao ate o trimestre anterior ao desta declaracao.		
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][3], 1), "0", "1")
		//
		//Forma de tributacao do lucro 1. Trimestre
		If StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][4]))-1, 1) == "6"
			cRegistro += "8"
		ElseIf StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][4]))-1, 1) == "7"
			cRegistro += "9"
		Else
			cRegistro   +=	StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][4]))-1, 1)
		EndIf
		//
		//Forma de tributacao do lucro 2. Trimestre
		If StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][5]))-1, 1) == "6"
			cRegistro += "8"
		ElseIf StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][5]))-1, 1) == "7"
			cRegistro += "9"
		Else
			cRegistro   +=	StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][5]))-1, 1)
		EndIf
		//
		//Qualificacao PJ 
		If M978Fil (aIniWiz[1][8], 3) == "130" .or. M978Fil (aIniWiz[1][8], 3) == "140" .or. M978Fil (aIniWiz[1][8], 3) == "150"
			cRegistro   +=	StrZero (aScan (aQualiPJ, AllTrim (aIniWiz[3][6])), 2) //Tamanho 2 para versao 130
		Else
			cRegistro   +=	StrZero (aScan (aQualiPJ, AllTrim (aIniWiz[3][6])), 1) //Tamanho 1 para outras versoes
		EndIf
		//
		//PJ levantou balanco/balancete de suspensao no trimestre
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][7], 1), "0", "1")
		//
		//1. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][8], 1), "0", "1")
		//
		//2. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][9], 1), "0", "1")
		//	
		//3. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][10], 1), "0", "1")
		//
		//4. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][11], 1), "0", "1")
		//
		//5. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][12], 1), "0", "1")
		//
		//6. Mes
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][13], 1), "0", "1")
		//
		//PJ com debitos de SCP a serem declarados
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][14], 1), "0", "1")
		//
		cRegistro   +=	"0"
		//
		//PJ com incorporacao submetida ao Regime Especial Tributario do Patrimonio de Afetacao(art. 1. da Lei n. 10.931/2004)
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][16], 1), "0", "1")
		//
		//PJ esteve obrigada a apresetacao da DCTF Semestral no ano anterior
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][17], 1), "0", "1")
		
	//Somente DCTF Trimestral
	Else
		//
		//PJ esteve inativa desde o inicio do ano calendario/data de sua constituicao ate o trimestre anterior ao desta declaracao.
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][3], 1), "0", "1")
		//
		//Forma de tributacao do lucro
		cRegistro   +=	StrZero (aScan (aFormTrib, AllTrim (aIniWiz[3][4]))-1, 1)
		//
		//Qualificacao PJ
		cRegistro   +=	StrZero (aScan (aQualiPJ, AllTrim (aIniWiz[3][6])), 1)
		//
		//PJ levantou balanco/balancete de suspensao no trimestre
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][7], 1), "0", "1")
		//
		//Outubro
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][8], 1), "0", "1")
		//
		//Novembro
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][9], 1), "0", "1")
		//	
		//Dezembro
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][10], 1), "0", "1")
		//
		//PJ com debitos de SCP a serem declarados
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][14], 1), "0", "1")
		//
		//PJ Optante pelo Regime Especial de Tributacao do art. 2. da MP n. 2.222/2001
		cRegistro   +=	Iif ("F"$Padr (aIniWiz[3][15], 1), "0", "1")
	EndIf
	//
	//Reservado
	cRegistro   +=	M978Fil (Space (10), 10)
	//
	M978Grava(cRegistro, @nHandle)
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978R02   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao do registro R02 do arquvio.                                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณcDctf -> Versao da DCTF em processamento                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978R02 (@nHandle, aIniWiz, cDctf)                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978R02 (nHandle, aIniWiz, cDctf, aSituacao)
	Local	nTrimFg		:=	M978Trim (aIniWiz)
	Local 	cRegistro   :=	""
	Local	lA978EndCob := ExistBlock("A978EndCob")
	Local	aEndCob     := {}

	//Logradouro - 0 Cobranca - Padrao, 1 - Fiscal
	Local cEndCob := M978Fil (SubStr (SubStr (SM0->M0_ENDCOB, 1, IIF(At (",", SM0->M0_ENDCOB) > 0, At (",", SM0->M0_ENDCOB) - 1, Len(SM0->M0_ENDCOB) )), 1, 40), 40)
	Local cNumero := (Substr(SM0->M0_ENDCOB, At (",", SM0->M0_ENDCOB)+1, (40-(At (",", SM0->M0_ENDCOB)+1))))
	Local cCompCob:= (Alltrim(SM0->M0_COMPCOB))
	Local cBairCob:= (Alltrim(SM0->M0_BAIRCOB))
	Local cMunCob := (Alltrim(SM0->M0_CIDCOB))
	Local cEstCob := (Alltrim(SM0->M0_ESTCOB))
	Local cCepCob := (Alltrim(SM0->M0_CEPCOB))

	If aIniWiz[1][9]<>Nil .And. "1"$aIniWiz[1][9]
		cEndCob := M978Fil (SubStr (SubStr (SM0->M0_ENDENT, 1, At (",", SM0->M0_ENDENT)), 1, 40), 40)
		cNumero := (Substr(SM0->M0_ENDENT, At (",", SM0->M0_ENDENT)+1, (40-(At (",", SM0->M0_ENDENT)+1))))
		cCompCob:= (Alltrim(SM0->M0_COMPENT))
		cBairCob:= (Alltrim(SM0->M0_BAIRENT))
		cMunCob := (Alltrim(SM0->M0_CIDENT))
		cEstCob := (Alltrim(SM0->M0_ESTENT))
		cCepCob := (Alltrim(SM0->M0_CEPENT))
	EndIf
		
	//
	//Tipo do Registro	
	cRegistro   := M978Fil ("R02", 3)
	//
	//CNPJ do Contribuinte
	cRegistro   += M978Fil (SM0->M0_CGC, 14)
	//
	//Somente DCTF Mensal
	If( "M"$cDctf )
		//
		//AAAA+MM
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)

	//Somente DCTF Semestral
	ElseIf ("S"$cDctf)
		If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semestre
			//
			//AAAA+SS
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
		Else
			//
			//AAAA+SS
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
		EndIf
		
	//Somente DCTF Trimestral
	Else
		//
		//AAAA+T
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
	EndIf
	//
	// Situacao
	cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
	//
	// Data de ocorrencia do evento
	If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
		cRegistro	+=	M978Fil ("00000000", 8)
	Else
		cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
	EndIf
	//
	//Nome empresarial
	cRegistro	+=	M978Fil (SubStr (SM0->M0_NOMECOM, 1, 115), 115)
	//
	//Reservado
	cRegistro	+=	M978Fil ("0000", 4)
	//
	//Somente DCTF Mensal e Semestral
	If !("M"$cDctf .Or. "S"$cDctf)
		//
		//Codigo da atividade economica(CNAE)
		cRegistro	+=	M978Fil (SubStr (SM0->M0_CNAE, 1, 7), 7)
	EndIf


	If lA978EndCob // Ponto de Entrada para troca do endere็o de entrega padrใo
		aEndCob := ExecBlock("A978EndCob",.F.,.F.,)
		If ValType(aEndCob) == "A" .And. Len(aEndCob) > 0
					
			cEndCob := aEndCob[1,1] //--ENDERECO DE COBRANCA S/ NUMERO
			cNumero := aEndCob[1,2] //--NUMERO
			cCompCob:= aEndCob[1,3] //--COMPLEMENTO
			cBairCob:= aEndCob[1,4] //--BAIRRO
			cMunCob := aEndCob[1,5] //--CIDADE
			cEstCob := aEndCob[1,6] //--ESTADO
			cCepCob := aEndCob[1,7] //--CEP

		EndIf
	EndIf


		//Logradouro
	cRegistro	+=	M978Fil (SubStr(cEndCob, 1, 40), 40)
		//
		//Numero
	cRegistro	+=	M978Fil (SubStr(cNumero,1, 6), 6)
		//
		//Complemento
	cRegistro	+=	M978Fil (SubStr(cCOMPCOB, 1, 21), 21)
		//
		//Bairro
	cRegistro	+=	M978Fil (SubStr(cBairCob, 1, 20), 20)
		//
		//Municipio
	cRegistro	+=	M978Fil (SubStr(cMunCob, 1, 50), 50)
		//
		//UF
	cRegistro	+=	M978Fil (SubStr(cESTCOB, 1, 2), 2)
		//
		//CEP
	cRegistro	+=	M978Fil (SubStr(cCEPCOB, 1, 8), 8)

		//
		//DDD telefone
	cRegistro   += Padr (aIniWiz[4][1], 4)
		//
		//Num. telefone
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[4][2], 8)
	Else
		cRegistro   += Padr (aIniWiz[4][2], 9)
	EndIf
		//
		//DDD Fax
	cRegistro   += Padr (aIniWiz[4][3], 4)
		//
		
		//Num. Fax
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[4][4], 8)
	Else
		cRegistro   += Padr (aIniWiz[4][4], 9)
	EndIf
		//
		//CX Postal
	cRegistro   += Padr (aIniWiz[4][5], 6)
		//
		//UF CS Postal
	cRegistro   += Padr (aIniWiz[4][6], 2)
		//
		//CEP CX Postal
	cRegistro   += Padr (aIniWiz[4][7], 8)
		//
		//Correio eletronico
	cRegistro   += Padr (aIniWiz[4][8], 40)
		//
		//Reservado
	cRegistro   += M978Fil (Space (10), 10)
		//
	M978Grava (cRegistro, @nHandle)
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978R03   บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao do registro R03 do arquvio.                                                   บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณcDctf -> Versao da DCTF em processamento                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978R03 (@nHandle, aIniWiz, cDctf)                                                              บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978R03 (nHandle, aIniWiz, cDctf, aSituacao)
	Local	nTrimFg		:=	M978Trim (aIniWiz)
	Local 	cRegistro   :=	""

	//
	cRegistro   := M978Fil ("R03", 3)
	cRegistro   += M978Fil (SM0->M0_CGC, 14)
	//
	//Somente para a DCTF Mensal
	If( "M"$cDctf )
		//
		//AAAA+MM
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)

	//Somente para a DCTF Semestral
	ElseIf ("S"$cDctf)
		//
		//AAAA+SS
		If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
		Else
			//
			//AAAA+SS
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
		EndIf
		
	//Somente para a DCTF Trimestral
	Else
		//
		//AAAA+T
		cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
	EndIf
	//
	// Situacao
	cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
	//
	// Data de ocorrencia do evento
	If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
		cRegistro	+=	M978Fil ("00000000", 8)
	Else
		cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
	EndIf
	//
	//Nome representante	
	cRegistro   += Padr (aIniWiz[5][1], 60)
	//
   	//CPF Representante
	cRegistro   += Padr (aIniWiz[5][2], 11)
	//
	//DDD Telefone Represantante
	cRegistro   += Padr (aIniWiz[5][3], 4)
	//
	//Telefone Representante
	
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[5][4], 8)
	Else
		cRegistro   += Padr (aIniWiz[5][4], 9)
	EndIf
	//
	//Ramal Representante
	cRegistro   += Padr (aIniWiz[5][5], 5)
	//
	//DDD Fax Representante
	cRegistro   += Padr (aIniWiz[5][6], 4)
	//
	//FAX Representante
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[5][7], 8)
	Else
		cRegistro   += Padr (aIniWiz[5][7], 9)
	EndIf
	//
	//Correio eletronico Representante
	cRegistro   += Padr (aIniWiz[5][8], 40)
	//
	//Nome Responsavel
	cRegistro   += Padr (aIniWiz[6][1], 60)
	//
	//CPF Responsavel
	cRegistro   += Padr (aIniWiz[6][2], 11)
	//
	//CRC Responsavel
	cRegistro   += Padr (aIniWiz[6][3], 15)
	//
	//UF do CRC do Responsavel
	cRegistro   += Padr (aIniWiz[6][4], 2)
	//
	//DDD Telefone Responsavel
	cRegistro   += Padr (aIniWiz[6][5], 4)
	//
	//Num. Telefone Responsavel
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[6][6], 8)
	Else
		cRegistro   += Padr (aIniWiz[6][6], 9)
	EndIf
	//
	//Ramal Responsavel
	cRegistro   += Padr (aIniWiz[6][7], 5)
	//
	//DDD Fax Responsavel
	cRegistro   += Padr (aIniWiz[6][8], 4)
	//
	//Num. Fax Responsavel
	IF aIniWiz[1,8] < "310"
		cRegistro   += Padr (aIniWiz[6][9], 8)
	Else
		cRegistro   += Padr (aIniWiz[6][9], 9)
	EndIf
	//
	//Correio eletronico Responsavel
	cRegistro   += Padr (aIniWiz[6][10], 40)
	//
	//Reservado
	cRegistro   += M978Fil (Space (10), 10)
	//
	M978Grava (cRegistro, @nHandle)
Return (.T.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณGerDebCre บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao de geracao dos registro R10 e R11 em meio-magnetico.                                     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณcDctf -> Versao da DCTF em processamento                                                        บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณGerDebCre (nHandle, aIniWiz, cDctf)                                                             บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function GerDebCre (nHandle, aIniWiz, cDctf, aSituacao)
	Local	nTrimFg	:=	M978Trim (aIniWiz)
	Local 	cRegistro	:=	""
	Local  cSCP		:= SuperGetMv("MV_SCP000",.F.,"") // Codigos de retencao de Debito - SCP
	Local  cINC		:= SuperGetMv("MV_INC000",.F.,"") // Codigos de retencao de Debito - INC
	Local  cVersao 	:= aIniWiz[01][08]
	
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณGerando Registro R10ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	DbSelectArea ("R10")
	R10->(DbGoTop ())
	Do While !(R10->(Eof ()))
		//
		//Tipo de Registro 
		cRegistro   := M978Fil ("R10", 3)
		//
		//CNPJ do Contribuinte
		cRegistro   += M978Fil (SM0->M0_CGC, 14)
		//
		//Somente DCTF Mensal
		If( "M"$cDctf )
			//
			//AAAA+MM
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)

		//Somente DCTF Semestral
		ElseIf ("S"$cDctf)
			//
			//AAAA+SS
			If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
			Else
				//
				//AAAA+SS
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
			EndIf

		//Somente DCTF Trimestral
		Else
			//
			//AAAA+T
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
		EndIf
		//
		//Situacao
		cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
		//
		//Data de ocorrencia do evento
		If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
			cRegistro	+=	M978Fil ("00000000", 8)
		Else
			cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
		EndIf
		//
		//Grupo de Tributos
		cRegistro	+=	M978Fil (StrZero (R10->R10_GRPTRI, 2), 2)
		//
		//Somente DCTF Mensal e Semestral
		If ("M"$cDctf) .Or. ("S"$cDctf)
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณA DCTF mensal/semestral exige que a variacao do codigo da receita possua 2 caracteresณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			cRegistro	+=	SubStr (M978Fil (StrZero (R10->R10_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R10->R10_CODREC, 6), 6), 5, 2)
		//Somente DCTF Trimestral		
		Else
			cRegistro	+=	SubStr (M978Fil (StrZero (R10->R10_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R10->R10_CODREC, 6), 6), 6, 1)
		EndIf
		//
		//Periodicidade
		cRegistro	+=	M978Fil (R10->R10_PERIOD, 1)
		//
		//Ano da Apuracao
		cRegistro	+=	M978Fil (StrZero (R10->R10_ANOAPU, 4), 4)
		//
		//Mes da Apuracao
		cRegistro	+=	M978Fil (StrZero (R10->R10_MESAPU, 2), 2)
		//
		//Dia, Semana, Quinzena, Decendio
		cRegistro	+=	M978Fil (StrZero (R10->R10_DSQD, 2), 2)
		//
		//Ordem do Estabelecimento
		cRegistro	+=	M978Fil (StrZero (R10->R10_CNPJES, 6), 6)
		//
		//Somente DCTF Mensal e Semestral
		//CNPJ da incorporacao
		If ("M"$cDctf) .Or. ("S"$cDctf)
			cRegistro	+=	M978Fil (StrZero (R10->R10_CNPJIN, 14), 14)
		EndIf
		//
		//Reservado
		cRegistro	+=	M978Fil ("0", 1)
		//
		//Valor do Debito
		cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R10->R10_VLRDEB, 14, 2), ".", ""), 14)
		//
		//Balanco de Reducao
		cRegistro	+=	M978Fil (StrZero (R10->R10_BALRED, 1) ,1)
		//
		//Saldo deste debito em quotas
		cRegistro	+=	M978Fil (StrZero (R10->R10_SALCOT, 1) ,1)
		//Reservado
		cRegistro   +=  M978Fil ("0", 1)
		//
		//D้bito de SCP/INC
		If (M978Fil (StrZero (R10->R10_CODREC, 6), 6)+M978Fil (R10->R10_PERIOD, 1))$cSCP
			cRegistro   += "1"
		ElseIf (M978Fil (StrZero (R10->R10_CODREC, 6), 6)+M978Fil (R10->R10_PERIOD, 1))$cINC
			cRegistro   += "2"
		Else
			cRegistro   += "0"
		EndIf
		//
		//Reservado
		cRegistro	+=	M978Fil (Space (10), 10)
		//
		M978Grava(cRegistro, @nHandle)
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณGerando Registro R11ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		DbSelectArea ("R11")
		R11->(DbGoTop ())
		R11->(DbSeek (StrZero (R10->R10_GRPTRI, 2)+StrZero (R10->R10_CODREC, 6)+R10->R10_PERIOD+StrZero(R10->R10_ANOAPU, 4)+StrZero (R10->R10_MESAPU, 2)+StrZero (R10->R10_DSQD, 2)+StrZero (R10->R10_CNPJES, 6)))
		//
		Do While !(R11->(Eof ())) .And.;
				StrZero (R10->R10_GRPTRI, 2)+StrZero (R10->R10_CODREC, 6)+R10->R10_PERIOD+StrZero (R10->R10_ANOAPU, 4)+StrZero (R10->R10_MESAPU, 2)+StrZero (R10->R10_DSQD, 2)+StrZero (R10->R10_CNPJES, 6)==;
				StrZero (R11->R11_GRPTRI, 2)+StrZero (R11->R11_CODREC, 6)+R11->R11_PERIOD+StrZero (R11->R11_ANOAPU, 4)+StrZero (R11->R11_MESAPU, 2)+StrZero (R11->R11_DSQD, 2)+StrZero (R11->R11_CNPJES, 6)
			//
			//Tipo de Registro
			If ("S"$R11->R11_COMP) .And. cVersao < "310" //COMPENSACAO
				cRegistro   := M978Fil (IIf(R11->R11_REGCOM$"S1", "R12", "R13"), 3) //dependendo cadastro R12/R13
			ElseIf  ("S"$R11->R11_COMP) .And. cVersao >= "310"
				cRegistro   := M978Fil("R12",3)
			Else
				cRegistro   := M978Fil ("R11", 3)
				Reclock("R11", .F.)
				R11->R11_REGCOM := ""
				MsUnlock()
			EndIf
			//
			//CNPJ do contribuinte
			cRegistro   += M978Fil (SM0->M0_CGC, 14)
			//
			//Somente DCTF Mensal
			If ("M"$cDctf)
				//
				//AAAA+MM
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
				
			//Somente DCTF Semestral
			ElseIf ("S"$cDctf)
				//
				//AAAA+SS
				If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
				Else
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
				EndIf
				
			//Somente DCTF Trimestral
			Else
				//
				//AAAA+T
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
			EndIf
			//
			//Situacao
			cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
			//
			//Data de ocorrencia do evento
			If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
				cRegistro	+=	M978Fil ("00000000", 8)
			Else
				cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
			EndIf
			//
			//Grupo de tributos
			cRegistro	+=	M978Fil (StrZero (R11->R11_GRPTRI, 2), 2)
			//
			//Somente DCTF Mensal e Semestral
			If ("M"$cDctf) .Or. ("S"$cDctf)
				cRegistro	+=	SubStr (M978Fil (StrZero (R11->R11_CODREC , 6 ), 6), 1, 4)
				cRegistro	+=	"0"+SubStr (M978Fil (StrZero (R11->R11_CODREC, 6), 6), 6, 1)
			Else
				cRegistro	+=	M978Fil (StrZero (R11->R11_CODREC, 5), 5)
			EndIf
			//
			//Periodicidade
			cRegistro	+=	M978Fil (R11->R11_PERIOD, 1)
			//
			//Ano de apuracao
			cRegistro	+=	M978Fil (StrZero (R11->R11_ANOAPU, 4), 4)
			//
			//Mes de apuracao
			cRegistro	+=	M978Fil (StrZero (R11->R11_MESAPU, 2), 2)
			//
			//Dia, Semana, Quinzena, Decendio
			cRegistro	+=	M978Fil (StrZero (R11->R11_DSQD, 2), 2)
			//
			//Ordem do Estabelecimento
			cRegistro	+=	M978Fil (StrZero (R11->R11_CNPJES, 6), 6)
			//
			//Somente DCTF Mensal e Semestral
			//CNPJ da Incorporacao
			If ("M"$cDctf) .Or. ("S"$cDctf)
				cRegistro	+=	M978Fil (StrZero (R11->R11_CNPJIN, 14), 14)
			EndIf
			//
			//Reservado
			cRegistro	+=	M978Fil ("0", 1)

			If Empty(R11->R11_REGCOM) //R11
				//Periodo de apuracao
				cRegistro	+=	M978Fil (RetDatDCTF (R11->R11_PERAPU), 8)
				//CNPJ DARF
				cRegistro	+=	M978Fil (R11->R11_CNPJDA, 14)
				//Codigo de receita
				cRegistro	+=	M978Fil (StrZero (R11->R11_CODRE2, 4), 4)
				//Data Vencimento
				cRegistro	+=	M978Fil (RetDatDCTF (R11->R11_DTVENC), 8)
				//Numero de Referencia
				//Somente DCTF Mensal e Semestral
				If ("M"$cDctf) .Or. ("S"$cDctf)
					cRegistro	+=	M978Fil (R11->R11_NUMRER ,17)
				Else
					cRegistro	+=	M978Fil (R11->R11_NUMRER ,8)
				EndIf
				//Valor principal
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRPRI, 14, 2), ".", ""), 14)
				//Valor Muta
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRMUL, 14, 2), ".", ""), 14)
				//Valor Juros
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRJUR, 14, 2), ".", ""), 14)
				//Valor pago ou Valor Compensado do debito dependendo do campo R11_COMP
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRPAG, 14, 2), ".", ""), 14)
			ElseIf cVersao < "310"
				IF R11->R11_REGCOM=="1" //R12
				
					//Valor pago ou Valor Compensado do debito dependendo do campo R11_COMP
					cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRPAG, 14, 2), ".", ""), 14)
					//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp 
					cRegistro  += 	M978Fil (R11->R11_FORMAL, 1)
					//Numero do PERDCOMP ou PROCESSO
					cRegistro  += 	M978Fil (R11->R11_NUMERO, 24)
				Else	//R13
					//Tipo do Credito
					cRegistro  += 	M978Fil (R11->R11_TIPCRE, 2)
					//Valor pago ou Valor Compensado do debito dependendo do campo R11_COMP
					cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRPAG, 14, 2), ".", ""), 14)
					//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp
					cRegistro  += 	M978Fil (R11->R11_FORMAL, 1)
					//Numero do PERDCOMP ou PROCESSO
					cRegistro  += 	M978Fil (R11->R11_NUMERO, 24)
				EndIf
			ElseIf cVersao >= "310" // Se for versใo maior oi igual a 310 gera somente o R12
				//Valor pago ou Valor Compensado do debito dependendo do campo R11_COMP
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R11->R11_VLRPAG, 14, 2), ".", ""), 14)
				//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp 
				cRegistro  += 	M978Fil (R11->R11_FORMAL, 1)
				//Numero do PERDCOMP ou PROCESSO
				cRegistro  += 	M978Fil (R11->R11_NUMERO, 24)
			EndIf

			//Reservado
			cRegistro	+=	M978Fil (Space (10), 10)
			//
			M978Grava (cRegistro, @nHandle)
			//
			R11->(DbSkip ())
		EndDo
		//
		GeraR14(nHandle, aIniWiz, cDctf, aSituacao)
		R10->(DbSkip ())
	EndDo
Return (.T.)
//-------------------------------------------------------------------
/*/{Protheus.doc} GeraR14
Gera็ใo do registro R14 

@author Mauro A. Goncalves
@since 29/02/2016
@version 1.0
/*/
//-------------------------------------------------------------------
Static Function GeraR14(nHandle, aIniWiz, cDctf, aSituacao)
	Local	nTrimFg	:=	M978Trim (aIniWiz)
	Local 	cRegistro	:=	""
	Local  lDep:=.F.
	DbSelectArea("R14")
	R14->(DbGoTop())
	R14->(DbSeek(StrZero(R10->R10_GRPTRI,2)+StrZero(R10->R10_CODREC,6)+R10->R10_PERIOD+StrZero(R10->R10_ANOAPU,4)+StrZero(R10->R10_MESAPU,2)+StrZero(R10->R10_DSQD,2)+StrZero(R10->R10_CNPJES,6)))
	Do While !(R14->(Eof ())).And.;
			StrZero(R10->R10_GRPTRI,2)+StrZero(R10->R10_CODREC,6)+R10->R10_PERIOD+StrZero(R10->R10_ANOAPU,4)+StrZero(R10->R10_MESAPU,2)+StrZero(R10->R10_DSQD,2)+StrZero(R10->R10_CNPJES,6)==;
			StrZero(R14->R14_GRPTRI,2)+StrZero(R14->R14_CODREC,6)+R14->R14_PERIOD+StrZero(R14->R14_ANOAPU,4)+StrZero(R14->R14_MESAPU,2)+StrZero(R14->R14_DSQD,2)+StrZero(R14->R14_CNPJES,6)
		lDep:=.F.
		//Tipo de Registro 
		cRegistro   := M978Fil("R14", 3)
		//CNPJ do Contribuinte
		cRegistro   += M978Fil(SM0->M0_CGC, 14)
		//Somente DCTF Mensal
		If("M"$cDctf)
			//AAAA+MM
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(Month(SToD(Padr(aIniWiz[1][2],8))),2),6)
		//Somente DCTF Semestral
		ElseIf ("S"$cDctf)
			//AAAA+SS
			If (Month(SToD(Padr(aIniWiz[1][2],8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
				cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(2,2),6)
			Else
				//AAAA+SS
				cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(1,2),6)
			EndIf
		//Somente DCTF Trimestral
		Else
			//AAAA+T
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(nTrimFg,1),5)
		EndIf
		//Situacao
		cRegistro   += StrZero(aScan(aSituacao,AllTrim(aIniWiz[2][3]))-1,1)
		//Data de ocorrencia do evento
		If ("00"$StrZero(aScan(aSituacao,AllTrim(aIniWiz[2][3]))-1,2))
			cRegistro	+=	M978Fil("00000000",8)
		Else
			cRegistro	+= M978Fil(Padr(aIniWiz[2][2],8),8)
		EndIf
		//Grupo de Tributos
		cRegistro	+=	M978Fil(StrZero(R14_GRPTRI,2),2)
		//Somente DCTF Mensal e Semestral
		If ("M"$cDctf) .Or. ("S"$cDctf)
			//A DCTF mensal/semestral exige que a variacao do codigo da receita possua 2 caracteres
			cRegistro	+=	SubStr(M978Fil(StrZero(R14_CODREC,6),6),1,4)
			cRegistro	+=	SubStr(M978Fil(StrZero(R14_CODREC,6),6),5,2)
		//Somente DCTF Trimestral		
		Else
			cRegistro	+=	SubStr(M978Fil(StrZero(R14_CODREC,6),6),1,4)
			cRegistro	+=	SubStr(M978Fil(StrZero(R14_CODREC,6),6),6,1)
		EndIf
		//Periodicidade
		cRegistro	+=	M978Fil(R14_PERIOD,1)
		//Ano da Apuracao
		cRegistro	+=	M978Fil(StrZero(R14_ANOAPU,4),4)
		//Mes da Apuracao
		cRegistro	+=	M978Fil(StrZero(R14_MESAPU,2),2)
		//Dia, Semana, Quinzena, Decendio
		cRegistro	+=	M978Fil(StrZero(R14_DSQD,2),2)
		//Ordem do Estabelecimento
		cRegistro	+=	M978Fil(StrZero(R14_CNPJES,6),6)
		//Somente DCTF Mensal e Semestral
		//CNPJ da incorporacao
		If ("M"$cDctf) .Or. ("S"$cDctf)
			cRegistro	+=	M978Fil(StrZero(R14_CNPJIN,14),14)
		EndIf
		//Reservado
		cRegistro	+=	M978Fil ("0", 1)
		//Valor Suspenso do D้bito 
		cRegistro	+= M978Fil("0"+StrTran(StrZero(R14_VLRSUS,14,2),".",""),14)
		//Motivo da Suspensใo 
		cRegistro	+=	M978Fil(R14_MOTSUS,2)
		//Dep๓sito 
		cRegistro	+=	M978Fil(IIF(R14_MOTSUS=='07','0',IIF(R14_MOTSUS=='02','1',R14_COMDEP)),1)
		lDep:= IIF(R14_MOTSUS=='07','0',IIF(R14_MOTSUS=='02','1',R14_COMDEP)) == '1'
		//Reservado
		cRegistro	+=	M978Fil("0",1)
		//N๚mero do Processo 
		cRegistro  +=	M978Fil(IIF(R14_MOTSUS=='07','',R14_NROPRO),24)
		//Vara 
		cRegistro  +=	M978Fil(IIF(R14_MOTSUS=='07','',R14_IDVARA),2)
		//Municํpio 
		cRegistro  +=	M978Fil(IIF(R14_MOTSUS=='07','',Posicione("CC2",1,xFilial("CC2")+R14->(R14_UF+R14_CODMUN),"CC2_MUN")),50)
		//UF 
		cRegistro  +=	M978Fil(IIF(R14_MOTSUS=='07','',R14_UF),2)
		//Identifica็ใo do Dep๓sito 
		cRegistro  +=	M978Fil(IIF(lDep,R14_IDEDEP,''),20)
		//Perํodo de Apura็ใo 
		cRegistro  +=	M978Fil(IIF(lDep,RetDatDCTF(R14_PERAPU,8),Replicate('0',8)),8)
		//CPF/CNPJ 
		cRegistro  += M978Fil(IIF(lDep,R14_CPFCGC,''),14)
		//C๓digo da Receita 
		cRegistro	 += M978Fil(IIF(lDep,R14_CRECDJ,'0000'),4)
		//Data do Vencimento 
		cRegistro	+=	M978Fil(IIF(lDep,RetDatDCTF(R14_DTVCTO),replicate('0',8)),8)
		//Valor principal
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R14_VLRPRI,0),14,2),".",""),14)
		//Valor Muta
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R14_VLRMUL,0),14,2),".",""),14)
		//Valor Juros
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R14_VLRJUR,0),14,2),".",""),14)
		//Reservado
		cRegistro	+=	M978Fil(Space(10),10)

		M978Grava(cRegistro, @nHandle)
		R14->(DbSkip ())
	EndDo
Return (.T.)

/*/{Protheus.doc} GerDebCreTriAnt
Gera็ใo dos registros R20, R21, R22 e R24 
@author Mauro A. Goncalves
@since 12/05/2016
@version 1.0
/*/
Static Function GerDebCreTriAnt(nHandle, aIniWiz, cDctf, aSituacao)
	Local nTrimFg	:=	M978Trim(aIniWiz)
	Local cRegistro	:=	""
	Local cVersao 	:= aIniWiz[01][08]
	Local cChvR30	:= ""
	
	DbSelectArea ("R20")
	R20->(DbGoTop ())
	Do While !(R20->(Eof ()))
		//Tipo de Registro 
		cRegistro   := M978Fil("R20", 3)
		//CNPJ do Contribuinte
		cRegistro   += M978Fil(SM0->M0_CGC, 14)
		//Somente DCTF Mensal
		If( "M"$cDctf )
			//AAAA+MM
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2], 8))), 4)+StrZero(Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
		ElseIf ("S"$cDctf)
			//AAAA+SS
			If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
			Else
				//AAAA+SS
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
			EndIf
		Else
			//AAAA+T
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
		EndIf
		//Situacao
		cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
		//Data de ocorrencia do evento
		If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
			cRegistro	+=	M978Fil ("00000000", 8)
		Else
			cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
		EndIf
		//Grupo de Tributos
		cRegistro	+=	M978Fil (StrZero (R20->R20_GRPTRI, 2), 2)
		//Somente DCTF Mensal e Semestral
		If ("M"$cDctf) .Or. ("S"$cDctf)
			//A DCTF mensal/semestral exige que a variacao do codigo da receita possua 2 caracteres
			cRegistro	+=	SubStr (M978Fil (StrZero (R20->R20_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R20->R20_CODREC, 6), 6), 5, 2)
		//Somente DCTF Trimestral		
		Else
			cRegistro	+=	SubStr (M978Fil (StrZero (R20->R20_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R20->R20_CODREC, 6), 6), 6, 1)
		EndIf
		//Periodicidade
		cRegistro	+=	M978Fil (R20->R20_PERIOD, 1)
		//Ano da Apuracao
		cRegistro	+=	M978Fil (StrZero (R20->R20_ANOAPU, 4), 4)
		//Trimestre da Apuracao
		cRegistro	+=	M978Fil(R20->R20_TRIAPU, 2)
		//Reservado
		cRegistro	+=	M978Fil ("00", 2)
		//Reservado
		cRegistro	+=	M978Fil ("000000", 6)
		//Reservado
		cRegistro	+=	M978Fil ("00000000000000", 14)
		//Reservado
		cRegistro	+=	M978Fil ("0", 1)
		//Valor do Debito
		cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R20->R20_VLRDEB, 14, 2), ".", ""), 14)
		//Reservado
		cRegistro   +=  M978Fil ("0", 1)
		//Reservado
		cRegistro   +=  M978Fil ("0", 1)
		//Quantidade de Quotas
		cRegistro   += M978Fil(Str(R20->R20_QTDCOT,1), 1)
		//D้bito de SCP/INC
		cRegistro   += M978Fil(R20->R20_SCPINC, 1)
		//Reservado
		cRegistro	+=	M978Fil (Space (10), 10)
		//
		M978Grava(cRegistro, @nHandle)
		cChvR30 := StrZero(R20->R20_GRPTRI,2)+StrZero(R20->R20_CODREC,6)+R20->R20_PERIOD+StrZero(R20->R20_ANOAPU,4)+R20->R20_TRIAPU
		//Gerando Registro R21
		DbSelectArea ("R21")
		R21->(DbGoTop())
		R21->(DbSeek(StrZero(R20->R20_GRPTRI,2)+StrZero(R20->R20_CODREC,6)+R20->R20_PERIOD+StrZero(R20->R20_ANOAPU,4)+R20->R20_TRIAPU))
		//
		Do While !(R21->(Eof ())) .And.;
			StrZero(R20->R20_GRPTRI,2)+StrZero(R20->R20_CODREC,6)+R20->R20_PERIOD+StrZero(R20->R20_ANOAPU,4)+R20->R20_TRIAPU==;
			StrZero(R21->R21_GRPTRI,2)+StrZero(R21->R21_CODREC,6)+R21->R21_PERIOD+StrZero(R21->R21_ANOAPU,4)+R21->R21_TRIAPU
			//Tipo de Registro
			If ("S"$R21->R21_COMP) .And. cVersao >= "310"
				cRegistro   := M978Fil("R22",3)
			Else
				cRegistro   := M978Fil("R21",3)
				Reclock("R21", .F.)
				R21->R21_REGCOM := ""
				MsUnlock()
			EndIf
			//CNPJ do contribuinte
			cRegistro   += M978Fil (SM0->M0_CGC, 14)
			//Somente DCTF Mensal
			If ("M"$cDctf)
				//AAAA+MM
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
			ElseIf ("S"$cDctf)
				//AAAA+SS
				If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
				Else
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
				EndIf
			Else
				//AAAA+T
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
			EndIf
			//Situacao
			cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
			//Data de ocorrencia do evento
			If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
				cRegistro	+=	M978Fil ("00000000", 8)
			Else
				cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
			EndIf
			//Grupo de tributos
			cRegistro	+=	M978Fil (StrZero (R21->R21_GRPTRI, 2), 2)
			//Somente DCTF Mensal e Semestral
			If ("M"$cDctf) .Or. ("S"$cDctf)
				cRegistro	+=	SubStr (M978Fil (StrZero (R21->R21_CODREC , 6 ), 6), 1, 4)
				cRegistro	+=	"0"+SubStr (M978Fil (StrZero (R21->R21_CODREC, 6), 6), 6, 1)
			Else
				cRegistro	+=	M978Fil (StrZero (R21->R21_CODREC, 5), 5)
			EndIf
			//Periodicidade
			cRegistro	+=	M978Fil (R21->R21_PERIOD, 1)
			//Ano de apuracao
			cRegistro	+=	M978Fil (StrZero (R21->R21_ANOAPU, 4), 4)
			//Trimestre da Apuracao
			cRegistro	+=	M978Fil(R21->R21_TRIAPU, 2)
			//Reservado
			cRegistro	+=	M978Fil ("00", 2)
			//Reservado
			cRegistro	+=	M978Fil ("000000", 6)
			//Reservado
			cRegistro	+=	M978Fil ("00000000000000", 14)
			//Reservado
			cRegistro	+=	M978Fil ("0", 1)
			If Empty(R21->R21_REGCOM) //R21
				//Perํodo de Apura็ใo ??? trimestre
				cRegistro	+=	M978Fil (RetDatDCTF (R21->R21_PERAPU), 8)
				//CNPJ da DARF
				cRegistro	+=	M978Fil (R21->R21_CNPJDA, 14)
				//C๓digo da Receita do DARF
				cRegistro	+=	M978Fil (StrZero (R21->R21_CODRE2, 4), 4)
				//Data de Vencimento
				cRegistro	+=	M978Fil (RetDatDCTF (R21->R21_DTVENC), 8)
				//Numero de Referencia				
				If ("M"$cDctf) .Or. ("S"$cDctf) //Somente DCTF Mensal e Semestral
					cRegistro	+=	M978Fil (R21->R21_NUMRER ,17)
				Else
					cRegistro	+=	M978Fil (R21->R21_NUMRER ,8)
				EndIf
				//Valor principal
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R21->R21_VLRPRI, 14, 2), ".", ""), 14)
				//Valor Muta
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R21->R21_VLRMUL, 14, 2), ".", ""), 14)
				//Valor Juros
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R21->R21_VLRJUR, 14, 2), ".", ""), 14)
				//Valor pago ou Valor Compensado do debito dependendo do campo R21_COMP
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R21->R21_VLRPAG, 14, 2), ".", ""), 14)
			ElseIf cVersao >= "310" // Se for versใo maior ou igual a 310 gera somente o R22
				//Valor Compensado do D้bito
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R21->R21_VLRPAG, 14, 2), ".", ""), 14)
				//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp 
				cRegistro  +=	M978Fil (R21->R21_FORMAL, 1)
				//Numero do PERDCOMP ou PROCESSO
				cRegistro  +=	M978Fil (R21->R21_NUMERO, 24)
			EndIf
			//Reservado
			cRegistro	+=	M978Fil (Space (10), 10)

			M978Grava (cRegistro, @nHandle)

			R21->(DbSkip ())
		EndDo
		GeraR24(nHandle, aIniWiz, cDctf, aSituacao)
		GerQtaTriAnt(nHandle, aIniWiz, cDctf, aSituacao,cChvR30)
		R20->(DbSkip ())
	EndDo
Return .T.
//-------------------------------------------------------------------
/*/{Protheus.doc} GeraR24
Gera็ใo do registro R24 

@author Mauro A. Goncalves
@since 29/02/2016
@version 1.0
/*/
//-------------------------------------------------------------------
Static Function GeraR24(nHandle, aIniWiz, cDctf, aSituacao)
	Local 	cRegistro	:=	""
	Local	nTrimFg	:=	M978Trim (aIniWiz)
	DbSelectArea ("R24")
	R24->(DbGoTop ())
	Do While !(R24->(Eof ()))
		//Tipo de Registro 
		cRegistro   := M978Fil("R24", 3)
		//CNPJ do Contribuinte
		cRegistro   += M978Fil(SM0->M0_CGC, 14)
		//Somente DCTF Mensal
		If("M"$cDctf)
			//AAAA+MM
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(Month(SToD(Padr(aIniWiz[1][2],8))),2),6)
		//Somente DCTF Semestral
		ElseIf ("S"$cDctf)
			//AAAA+SS
			If (Month(SToD(Padr(aIniWiz[1][2],8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
				cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(2,2),6)
			Else
				//AAAA+SS
				cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(1,2),6)
			EndIf
		//Somente DCTF Trimestral
		Else
			//AAAA+T
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2],8))),4)+StrZero(nTrimFg,1),5)
		EndIf
		//Situacao
		cRegistro   += StrZero(aScan(aSituacao,AllTrim(aIniWiz[2][3]))-1,1)
		//Data de ocorrencia do evento
		If ("00"$StrZero(aScan(aSituacao,AllTrim(aIniWiz[2][3]))-1,2))
			cRegistro	+=	M978Fil("00000000",8)
		Else
			cRegistro	+= M978Fil(Padr(aIniWiz[2][2],8),8)
		EndIf
		//Grupo de Tributos
		cRegistro	+=	M978Fil(StrZero(R24_GRPTRI,2),2)
		//Somente DCTF Mensal e Semestral
		If ("M"$cDctf) .Or. ("S"$cDctf)
			//A DCTF mensal/semestral exige que a variacao do codigo da receita possua 2 caracteres
			cRegistro	+=	SubStr(M978Fil(StrZero(R24_CODREC,6),6),1,4)
			cRegistro	+=	SubStr(M978Fil(StrZero(R24_CODREC,6),6),5,2)
		//Somente DCTF Trimestral		
		Else
			cRegistro	+=	SubStr(M978Fil(StrZero(R24_CODREC,6),6),1,4)
			cRegistro	+=	SubStr(M978Fil(StrZero(R24_CODREC,6),6),6,1)
		EndIf
		//Periodicidade
		cRegistro	+=	M978Fil(R24_PERIOD,1)
		//Ano da Apuracao
		cRegistro	+=	M978Fil(StrZero(R24_ANOAPU,4),4)
		//Trimestre da Apuracao
		cRegistro	+=	M978Fil(R24->R24_TRIAPU, 2)
		//Reservado
		cRegistro	+=	M978Fil ("00", 2)
		//Reservado
		cRegistro	+=	M978Fil ("000000", 6)
		//Reservado
		cRegistro	+=	M978Fil ("00000000000000", 14)
		//Reservado
		cRegistro	+=	M978Fil ("0", 1)
		//Valor Suspenso do D้bito 
		cRegistro	+= M978Fil("0"+StrTran(StrZero(R24_VLRSUS,14,2),".",""),14)
		//Motivo da Suspensใo 
		cRegistro	+=	M978Fil(R24_MOTSUS,2)
		//Dep๓sito 
		cRegistro	+=	M978Fil(IIF(R24_MOTSUS=='07','0',IIF(R24_MOTSUS=='02','1',R24_COMDEP)),1)
		lDep:= IIF(R24_MOTSUS=='07','0',IIF(R24_MOTSUS=='02','1',R24_COMDEP)) == '1'
		//Reservado
		cRegistro	+=	M978Fil("0",1)
		//N๚mero do Processo 
		cRegistro  +=	M978Fil(IIF(R24_MOTSUS=='07','',R24_NROPRO),24)
		//Vara 
		cRegistro  +=	M978Fil(IIF(R24_MOTSUS=='07','',R24_IDVARA),2)
		//Municํpio 
		cRegistro  +=	M978Fil(IIF(R24_MOTSUS=='07','',Posicione("CC2",1,xFilial("CC2")+R24->(R24_UF+R24_CODMUN),"CC2_MUN")),50)
		//UF 
		cRegistro  +=	M978Fil(IIF(R24_MOTSUS=='07','',R24_UF),2)
		//Identifica็ใo do Dep๓sito 
		cRegistro  +=	M978Fil(IIF(lDep,R24_IDEDEP,''),20)
		//Perํodo de Apura็ใo 
		cRegistro  +=	M978Fil(IIF(lDep,RetDatDCTF(R24_PERAPU,8),Replicate('0',8)),8)
		//CPF/CNPJ 
		cRegistro  += M978Fil(IIF(lDep,R24_CPFCGC,''),14)
		//C๓digo da Receita 
		cRegistro	 += M978Fil(IIF(lDep,R24_CRECDJ,'0000'),4)
		//Data do Vencimento 
		cRegistro	+=	M978Fil(IIF(lDep,RetDatDCTF(R24_DTVCTO),replicate('0',8)),8)
		//Valor principal
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R24_VLRPRI,0),14,2),".",""),14)
		//Valor Muta
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R24_VLRMUL,0),14,2),".",""),14)
		//Valor Juros
		cRegistro	+=	M978Fil("0"+StrTran(StrZero(IIF(lDep,R24_VLRJUR,0),14,2),".",""),14)
		//Reservado
		cRegistro	+=	M978Fil(Space(10),10)
		M978Grava(cRegistro, @nHandle)
		R24->(DbSkip ())
	EndDo
Return (.T.)

/*/{Protheus.doc} GerQtaTriAnt
Gera็ใo dos registros R30, R31 e R32 
@author Mauro A. Goncalves
@since 12/05/2016
@version 1.0
/*/
Static Function GerQtaTriAnt(nHandle, aIniWiz, cDctf, aSituacao,cChvR30)
	Local nTrimFg	:=	M978Trim(aIniWiz)
	Local cRegistro	:=	""
	Local cVersao 	:= aIniWiz[01][08]
	
	Default cChvR30 := ""
	
	DbSelectArea("R30")
	R30->(DbGoTop ())
	R30->(DbSeek(cChvR30))
	Do While !(R30->(Eof ())) .and. cChvR30 == ;
							StrZero(R30->R30_GRPTRI,2)+StrZero(R30->R30_CODREC,6)+R30->R30_PERIOD+StrZero(R30->R30_ANOAPU,4)+R30->R30_TRIAPU
		//Tipo de Registro 
		cRegistro   := M978Fil("R30", 3)
		//CNPJ do Contribuinte
		cRegistro   += M978Fil(SM0->M0_CGC, 14)
		//Somente DCTF Mensal
		If( "M"$cDctf )
			//AAAA+MM
			cRegistro   += M978Fil(StrZero(Year(SToD(Padr(aIniWiz[1][2], 8))), 4)+StrZero(Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
		ElseIf ("S"$cDctf)
			//AAAA+SS
			If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
			Else
				//AAAA+SS
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
			EndIf
		Else
			//AAAA+T
			cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
		EndIf
		//Situacao
		cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
		//Data de ocorrencia do evento
		If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
			cRegistro	+=	M978Fil ("00000000", 8)
		Else
			cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
		EndIf
		//Grupo de Tributos
		cRegistro	+=	M978Fil (StrZero (R30->R30_GRPTRI, 2), 2)
		//Somente DCTF Mensal e Semestral
		If ("M"$cDctf) .Or. ("S"$cDctf)
			//A DCTF mensal/semestral exige que a variacao do codigo da receita possua 2 caracteres
			cRegistro	+=	SubStr (M978Fil (StrZero (R30->R30_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R30->R30_CODREC, 6), 6), 5, 2)
		//Somente DCTF Trimestral		
		Else
			cRegistro	+=	SubStr (M978Fil (StrZero (R30->R30_CODREC, 6), 6), 1, 4)
			cRegistro	+=	SubStr (M978Fil (StrZero (R30->R30_CODREC, 6), 6), 6, 1)
		EndIf
		//Periodicidade
		cRegistro	+=	M978Fil (R30->R30_PERIOD, 1)
		//Ano da Apuracao
		cRegistro	+=	M978Fil (StrZero (R30->R30_ANOAPU, 4), 4)
		//Trimestre da Apuracao
		cRegistro	+=	M978Fil(R30->R30_TRIAPU, 2)
		//Reservado
		cRegistro	+=	M978Fil ("00", 2)
		//Reservado
		cRegistro	+=	M978Fil ("000000", 6)
		//Reservado
		cRegistro	+=	M978Fil ("00000000000000", 14)
		//N๚mero da Quota
		cRegistro	+=	M978Fil (R30->R30_NROQTA, 1)
		//Reservado
		cRegistro	+=	M978Fil (Space (10), 10)
		//
		M978Grava(cRegistro, @nHandle)
	
		//Gerando Registro R31
		DbSelectArea ("R31")
		R31->(DbGoTop())
		R31->(DbSeek(StrZero(R30->R30_GRPTRI,2)+StrZero(R30->R30_CODREC,6)+R30->R30_PERIOD+StrZero(R30->R30_ANOAPU,4)+R30->R30_TRIAPU+R30->R30_NROQTA))
		//
		Do While !(R31->(Eof ())) .And.;
			StrZero(R30->R30_GRPTRI,2)+StrZero(R30->R30_CODREC,6)+R30->R30_PERIOD+StrZero(R30->R30_ANOAPU,4)+R30->R30_TRIAPU+R30->R30_NROQTA==;
			StrZero(R31->R31_GRPTRI,2)+StrZero(R31->R31_CODREC,6)+R31->R31_PERIOD+StrZero(R31->R31_ANOAPU,4)+R31->R31_TRIAPU+R31->R31_NROQTA
			//Tipo de Registro
			cRegistro   := M978Fil("R31",3)
			Reclock("R31", .F.)
			R31->R31_REGCOM := ""
			MsUnlock()
			//CNPJ do contribuinte
			cRegistro   += M978Fil (SM0->M0_CGC, 14)
			//Somente DCTF Mensal
			If ("M"$cDctf)
				//AAAA+MM
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (Month (SToD (Padr (aIniWiz[1][2], 8))), 2), 6)
			ElseIf ("S"$cDctf)
				//AAAA+SS
				If (Month (SToD (Padr (aIniWiz[1][2], 8)))==12)	//Se for o mes 12 como mes final do periodo eh pq se esta processando o 2. semenstre
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (2, 2), 6)
				Else
					cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (1, 2), 6)
				EndIf
			Else
				//AAAA+T
				cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 1), 5)
			EndIf
			//Situacao
			cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
			//Data de ocorrencia do evento
			If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
				cRegistro	+=	M978Fil ("00000000", 8)
			Else
				cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
			EndIf
			//Grupo de tributos
			cRegistro	+=	M978Fil (StrZero (R31->R31_GRPTRI, 2), 2)
			//Somente DCTF Mensal e Semestral
			If ("M"$cDctf) .Or. ("S"$cDctf)
				cRegistro	+=	SubStr (M978Fil (StrZero (R31->R31_CODREC , 6 ), 6), 1, 4)
				cRegistro	+=	"0"+SubStr (M978Fil (StrZero (R31->R31_CODREC, 6), 6), 6, 1)
			Else
				cRegistro	+=	M978Fil (StrZero (R31->R31_CODREC, 5), 5)
			EndIf
			//Periodicidade
			cRegistro	+=	M978Fil (R31->R31_PERIOD, 1)
			//Ano de apuracao
			cRegistro	+=	M978Fil (StrZero (R31->R31_ANOAPU, 4), 4)
			//Trimestre da Apuracao
			cRegistro	+=	M978Fil(R31->R31_TRIAPU, 2)
			//Reservado
			cRegistro	+=	M978Fil ("00", 2)
			//Reservado
			cRegistro	+=	M978Fil ("000000", 6)
			//Reservado
			cRegistro	+=	M978Fil ("00000000000000", 14)
			If Empty(R31->R31_REGCOM) //R31
				//N๚mero da Quota
				cRegistro	+=	M978Fil (R31->R31_NROQTA, 1)
				//Perํodo de Apura็ใo
				cRegistro	+=	M978Fil (RetDatDCTF (R31->R31_PERAPU), 8)
				//CNPJ da DARF
				cRegistro	+=	M978Fil (R31->R31_CNPJDA, 14)
				//C๓digo da Receita do DARF
				cRegistro	+=	M978Fil (StrZero (R31->R31_CODRE2, 4), 4)
				//Data de Vencimento
				cRegistro	+=	M978Fil (RetDatDCTF (R31->R31_DTVENC), 8)
				//Numero de Referencia				
				If ("M"$cDctf) .Or. ("S"$cDctf) //Somente DCTF Mensal e Semestral
					cRegistro	+=	M978Fil (R31->R31_NUMRER ,17)
				Else
					cRegistro	+=	M978Fil (R31->R31_NUMRER ,8)
				EndIf
				//Valor principal
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R31->R31_VLRPRI, 14, 2), ".", ""), 14)
				//Valor Muta
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R31->R31_VLRMUL, 14, 2), ".", ""), 14)
				//Valor Juros
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R31->R31_VLRJUR, 14, 2), ".", ""), 14)
				//Valor pago ou Valor Compensado do debito dependendo do campo R31_COMP
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R31->R31_VLRPAG, 14, 2), ".", ""), 14)
			ElseIf cVersao >= "310" // Se for versใo maior ou igual a 310 gera somente o R32
				//Valor Compensado do D้bito
				cRegistro	+=	M978Fil ("0"+StrTran (StrZero (R31->R31_VLRPAG, 14, 2), ".", ""), 14)
				//Formalizacao do pedido, 1=Processo Administrativo, 3=DComp 
				cRegistro  +=	M978Fil (R31->R31_FORMAL, 1)
				//Numero do PERDCOMP ou PROCESSO
				cRegistro  +=	M978Fil (R31->R31_NUMERO, 24)
			EndIf
			//Reservado
			cRegistro	+=	M978Fil (Space (10), 10)

			M978Grava (cRegistro, @nHandle)

			R31->(DbSkip ())
		EndDo
		
		R30->(DbSkip ())
	EndDo
Return .T.

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออหออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM978Trail บAutorณ                     Gustavo G. Rueda                       บDataณ  27/09/2005 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออสออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณFuncao que monta o registro trailler do meio-magnetico.                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบObservacaoณNenhuma                                                                                         บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณnHandle -> Handle do TXT criado.                                                                บฑฑ
ฑฑบ          ณaTrbs -> Temporario criado pela rotina para geracao do meio-magnetico                           บฑฑ
ฑฑบ          ณaIniWiz ->Informacoes preenchidas no wizard                                                     บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ.T.                                                                                             บฑฑ
ฑฑบ          ณ                                                                                                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบSintaxe   ณM978Trail (@nHandle, aTrbs, aIniWiz)                                                            บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function M978Trail (nHandle, aTrbs, aIniWiz, aSituacao)
	Local	lRet		:=	.T.
	Local	nTrimFg		:=	M978Trim (aIniWiz)
	Local 	cRegistro   :=	""
	//
	//Tipo de Registro
	cRegistro   := M978Fil ("T9", 2)
	//
	//CNPJ do Contribuinte
	cRegistro   += M978Fil (SubStr (SM0->M0_CGC, 1, 14), 14)
	//
	//Mes de ocorrencia do Fato Gerador
	cRegistro   += M978Fil (StrZero (Year (SToD (Padr (aIniWiz[1][2], 8))), 4)+StrZero (nTrimFg, 2), 6)
	//
	// Situacao
	cRegistro   += StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 1)
	//
	// Data de ocorrencia do evento
	If ("00"$StrZero (aScan (aSituacao, AllTrim (aIniWiz[2][3]))-1, 2))
		cRegistro	+=	M978Fil ("00000000", 8)
	Else
		cRegistro   += M978Fil (Padr (aIniWiz[2][2], 8), 8)
	EndIf
	//
	//Qtd de registros do arquivo
	cRegistro   += M978Fil (SubStr (StrZero ((aTrbs[1][1])->(LastRec ()), 5), 1, 5), 5)
	//
	//Reservado
	cRegistro   += M978Fil (Space (66), 66)
	//
	M978Grava (cRegistro, @nHandle)
Return (lRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |LeTxt     ณ Autor ณ Murilo Alves          ณ Data ณ28.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de processamento e armazenamento dos conteudos a     |ฑฑ
ฑฑณ          ณ serem impressos.                                           |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณaTrbs -> Array contendo os temporarios criados na rotina.   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|aRegra   -> Array contendo as regras p/geracao dos registrosณฑฑ
ฑฑณ          |aStrCmps -> Array contendo a estrutura das celulas          ณฑฑ
ฑฑณ          |aTitulos -> Array contendo os labels e pictures das celulas ณฑฑ
ฑฑณ          |aWizard  -> Array contendo as informacoes do assistente.    ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function LeTxt(aRegra,aStrCmps,aTitulo,aWizard,nArqVal,cFile)
	Local	aTrbs		:=	{}
	Local	aStru		:=	{}
	Local	cArq		:=	""
	Local	cLinha		:=	""
	Local	nAlsTrb		:=	1
	Local	cAls		:=	""
	Local	cTpDCTF		:=	""
 
	cFile	:=	AllTrim(aWizard[1][1])
	If File( cFile )
		FT_FUSE(cFile)
		FT_FGOTOP()
		If !FT_FEOF()
			cLinha	:=	FT_FREADLN()
			If !"DCTF"$cLinha
				nArqVal	:= 1
				Return(aTrbs)
			EndIf
		EndIf
		cTpDCTF	:=	SubStr(cLinha,5,1)
		FT_FUSE()
	//Regra para geracao do registro 0
		aAdd( aRegra,{"HEAD"} )													//N1
		aAdd( aRegra,{"R01 "} )													//N1
		aAdd( aRegra,{"R02 "} )													//N1
		aAdd( aRegra,{"R03 "} )													//N1
		aAdd( aRegra,{"R10 "} )													//N1
		aAdd( aRegra[Len( aRegra )],{"R11 "} )					//N2

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro HEADER ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_SIST",		"C",	005,	0 } )
		aAdd( aStru,{ cAls+"_RESER1",	"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_RESER2",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_ANO",		"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_RESER3",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_TPDECL",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_CNPJC",	"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_RESER4",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_VERSAO",	"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_NOMEEM",	"C",	060,	0 } )
		aAdd( aStru,{ cAls+"_UFDOM",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_RESER5",	"C",	010,	0 } )
		aAdd( aStru,{ cAls+"_RESER6",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_SITUA",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_ANO2",		"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_PERIOD",	"C",	002,	0 } ) //mes ou semestre de competencia
		aAdd( aStru,{ cAls+"_RESER7",	"C",	011,	0 } )
		aAdd( aStru,{ cAls+"_INI",		"D",	008,	0 } )
		aAdd( aStru,{ cAls+"_FIM",		"D",	008,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",	"D",	008,	0 } )
		aAdd( aStrCmps,aStru )
	
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_SIST")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"HEAD" } )

		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0216))	//"HEADER da Declaracao"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0255,"@!" })						//"Sistema"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })  						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0177,"@!" })  						//"Ano de Competencia"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })  						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0261,"@!" }) 						//"Tipo de Declaracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" })					 	//"CNPJ do Contribuinte"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })  						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0271,"@!" })  						//"Versao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0231,"@!" })						//"Nome Empresarial"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0265,"@!" })						//"UF Domicilio"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" }) 						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0177,"@!" })						//"Ano de Competencia"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0226,"@!" })					//"Mes de Competencia"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0253,"@!" })					//"Semestre de Competencia"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0182,"@!" })  						//"Base Inicial"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0181,"@!" })						//"Base Final"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0196,"@!" })  						//"Data de Ocorrencia"
 
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro R01 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_TIPO",			"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ",			"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_XOFG",			"C",	006,	0 } ) //PERIODO DE OCORRENCIA DO FATO GERADOR
		aAdd( aStru,{ cAls+"_SITUA",		"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",		"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_PERINI",		"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_PERFIM",		"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_DECLRE",		"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_RECIBO",		"C",	012,	0 } ) //NUMERO DO RECIBO DE ENTREGA DA DCTF A SER RETIFICADA
		If cTpDCTF == "M" //MENSAL
			aAdd( aStru,{ cAls+"_FRMTRB",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_QLFCPJ",	"C",	002,	0 } )
			aAdd( aStru,{ cAls+"_PJBLNC",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJDEBI",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJINAT",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJINC",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJOBRG",	"C",	001,	0 } )
		Else //SEMESTRAL
			aAdd( aStru,{ cAls+"_PJINAT",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_FTLPT",	"C",	001,	0 } ) //FORMA DE TRIBUTACAO DO LUCRO NO PRIMEIRO SEMESTRE
			aAdd( aStru,{ cAls+"_FTLSS",	"C",	001,	0 } ) //FORMA DE TRIBUTACAO DO LUCRO NO SEGUNDO  SEMESTRE
			aAdd( aStru,{ cAls+"_QLFCPJ",	"C",	002,	0 } )
			aAdd( aStru,{ cAls+"_JPBLNC",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES1",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES2",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES3",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES4",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES5",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_MES6",		"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJDEBT",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_RESERV",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJINC",	"C",	001,	0 } )
			aAdd( aStru,{ cAls+"_PJOBRG",	"C",	001,	0 } )
		EndIf
		aAdd( aStrCmps,aStru )
	
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_CNPJ")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"R01" } )
	
		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0245))  						//"R01 - Dados Iniciais"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0260,"@!" })						//"Tipo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" })						//"CNPJ do Contribuinte"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0227,"@!" })  					//"Mes de Ocorrencia do Fato Gerador"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0253,"@!" })  					//"Semestre de Ocorrencia do Fato Gerador"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" })  						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0197,"@!" })						//"Data do Evento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0217,"@!" }) 						//"Inicio do Periodo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0211,"@!" }) 						//"Final do Periodo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0205,"@!" })  						//"Declara็ใo Retificadora"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0232,"@!" })  						//"Num. do Rec. a ser Retificada"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0212,"@!" })					//"Forma de Tributacao do Lucro"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0243,"@!" })					//"Qualificacao da PJ"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0241,"@!" })   				//"PJ levantou Balanco"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0238,"@!" })					//"PJ com Debitos"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0240,"@!" }) 					//"PJ Inativa"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0213,"@!" })					//"Forma de Tributacao do Lucro no Primeiro Semestre"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0214,"@!" })					//"Forma de Tributacao do Lucro no Segundo Semestre"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0243,"@!" })					//"Qualifica็ใo da PJ"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0241,"@!" })  					//"PJ levantou Balanco"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0220,"@!" })  					//"Mes 1"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0221,"@!" })  					//"Mes 2"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0222,"@!" })  					//"Mes 3"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0223,"@!" })  					//"Mes 4"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0224,"@!" })  					//"Mes 5"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0225,"@!" })  					//"Mes 6"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0238,"@!" })  					//"PJ com Debitos"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })  					//"RESERV"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0239,"@!" })  			   			//"PJ com Incorporacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0242,"@!" })  			  			//"PJ Obrigada"
    
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro R02 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_TIPO",		"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ",		"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_XOFG",		"C",	006,	0 } ) //PERIODO DE OCORRENCIA DO FATO GERADOR
		aAdd( aStru,{ cAls+"_SITUA",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_NOMEEM",	"C",	115,	0 } )
		aAdd( aStru,{ cAls+"_NATUR",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_LOGRAD",	"C",	040,	0 } )
		aAdd( aStru,{ cAls+"_NUMERO",	"C",	006,	0 } )
		aAdd( aStru,{ cAls+"_COMPL",	"C",	021,	0 } )
		aAdd( aStru,{ cAls+"_BAIRRO",	"C",	020,	0 } )
		aAdd( aStru,{ cAls+"_MUNIC",	"C",	050,	0 } )
		aAdd( aStru,{ cAls+"_UF",		"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_CEP",		"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_DDDTEL",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_TELEF",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_DDDFAX",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_FAX",		"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_CXPOST",	"C",	006,	0 } )
		aAdd( aStru,{ cAls+"_UFCX",		"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_CEPCX",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_EMAIL",	"C",	040,	0 } )
		aAdd( aStrCmps,aStru )
		
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_CNPJ")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"R02" } )

		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0246))						//"R02 - Dados Cadastrais do Estabelecimento Matriz"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0260,"@!" })						//"Tipo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" })  						//"CNPJ do Contribuinte"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0227,"@!" })  					//"Mes de Ocorrencia do Fato Gerador"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0254,"@!" })  					//"Semestre de Ocorrencia do Fato Gerador"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" })  						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0197,"@!" })						//"Data do Evento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0231,"@!" })						//"Nome Empresarial"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0189,"@!" })						//"Codigo da Natureza Juridica"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0218,"@!" })  						//"Logradouro"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0234,"@!" })  						//"Numero"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0192,"@!" })  						//"Complemento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0179,"@!" })  						//"Bairro"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0228,"@!" })  						//"Municipio"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0262,"@!" })  						//"UF"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0184,"@!" })  						//"CEP"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0201,"@!" })  						//"DDD do Telefone"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0257,"@!" })  						//"Telefone"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0199,"@!" })  						//"DDD do FAX"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0209,"@!" })  						//"FAX"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0183,"@!" })  						//"Caixa Postal"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0263,"@!" })  						//"UF da Caixa Postal"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0185,"@!" })  						//"CEP da Caixa Postal"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0193,"@!" })  						//"Correio Eletronico"
    
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro R03 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_TIPO",		"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ",		"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_XOFG",		"C",	006,	0 } ) //PERIODO DE OCORRENCIA DO FATO GERADOR
		aAdd( aStru,{ cAls+"_SITUA",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_NOMERR",	"C",	060,	0 } )
		aAdd( aStru,{ cAls+"_CPF_RR",	"C",	011,	0 } )
		aAdd( aStru,{ cAls+"_DDDTRR",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_TEL_RR",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_R_RR",		"C",	005,	0 } )
		aAdd( aStru,{ cAls+"_DDDFRR",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_F_RR",		"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_EMA_RR",	"C",	040,	0 } )
		aAdd( aStru,{ cAls+"_NOM_RS",	"C",	060,	0 } )
		aAdd( aStru,{ cAls+"_CPF_RS",	"C",	011,	0 } )
		aAdd( aStru,{ cAls+"_CRC_RS",	"C",	015,	0 } )
		aAdd( aStru,{ cAls+"_UF_RS",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_DDDTRS",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_TEL_RS",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_R_RS",		"C",	005,	0 } )
		aAdd( aStru,{ cAls+"_DDDFRS",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_FAX_RS",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_EMA_RS",	"C",	040,	0 } )
		aAdd( aStrCmps,aStru )
	
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_CNPJ")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"R03" } )

		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0247))						//"R03 - Dados dos Responsaveis pela Pessoa Juridica"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0260,"@!" })						//"Tipo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" })						//"CNPJ do Contribuinte"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0227,"@!" })  					//"Mes de Ocorrencia do Fato Gerador"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0254,"@!" })  					//"Semestre de Ocorrencia do Fato Gerador"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" })  						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0197,"@!" })						//"Data do Evento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0229,"@!" })						//"Nome do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0194,"@!" })	  					//"CPF do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0202,"@!" })						//"DDD do Telefone do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0258,"@!" })						//"Telefone do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0250,"@!" })						//"Ramal do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0272,"@!" })						//"DDD do Fax do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0273,"@!" })						//"Fax do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0207,"@!" })						//"Email do Representante"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0230,"@!" })						//"Nome do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0274,"@!" })						//"CPF do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0195,"@!" })						//"CRC do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0264,"@!" })						//"UF do CRC do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0203,"@!" })						//"DDD do Telefone do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0259,"@!" })						//"Telefone do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0251,"@!" })						//"Ramal do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0200,"@!" })						//"DDD do FAX do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0210,"@!" })						//"FAX do Responsavel"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0208,"@!" })						//"Email do Responsavel"
	
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro R10 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_TIPO",		"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ",		"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_XOFG",		"C",	006,	0 } ) //PERIODO DE OCORRENCIA DO FATO GERADOR
		aAdd( aStru,{ cAls+"_SITUA",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",	"C",	008,	0 } )
		aAdd( aStru,{ cAls+"_GRPTRB",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_CODREC",	"C",	006,	0 } )
		aAdd( aStru,{ cAls+"_PERIOD",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_ANO",	   	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_MBTQSA",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_DSQDA",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_ORDEM",	"C",	006,	0 } ) //ORDEM DO ESTABELECIMENTO
		aAdd( aStru,{ cAls+"_CNPJIN",	"C",	014,	0 } ) //CNPJ DA INCORPORACAO
		aAdd( aStru,{ cAls+"_RESERV",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_VLRDBT",	"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_BALANC",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DIVQTS",	"C",	001,	0 } )
		If !cTpDCTF == "M"
			aAdd( aStru,{ cAls+"_QTQTS","C",	001,	0 } )
		EndIf
		aAdd( aStru,{ cAls+"_RELAC",	"C",	010,	0 } )
		aAdd( aStrCmps,aStru )
	
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_RELAC")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"R10" } )

		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0248))						//"R10 - Debito Apurado e Creditos Vinculados"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0260,"@!" })						//"Tipo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" }) 						//"CNPJ do Contribuinte"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0227,"@!" })  					//"Mes de Ocorrencia do Fato Gerador"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0254,"@!" })  					//"Semestre de Ocorrencia do Fato Gerador"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" })  						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0197,"@!" })						//"Data do Evento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0215,"@!" })						//"Grupo de Tributo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0190,"@!" })						//"Codigo da Receita"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0236,"@!" })						//"Periodicidade"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0178,"@!" })						//"Ano do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0219,"@!" })						//"MBTQS do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0206,"@!" })						//"DSQD do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0235,"@!" })						//"Ordem do Estabelecimento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0186,"@!" })						//"CNPJ da incorporacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0267,"@!" })						//"Valor do Debito"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0180,"@!" })						//"Balan็o de Reducao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0204,"@!" })						//"Debito dividido em Quotas"
		If !cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0244,"@!" })						//"Quantidade de Quotas"
		EndIf
	
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMontagem do registro R11 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAls	:=	"T"+StrZero(nAlsTrb++,2)
		aStru	:=	{}
		aAdd( aStru,{ cAls+"_TIPO",		"C",	003,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ",		"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_XOFG",		"C",	006,	0 } ) //PERIODO DE OCORRENCIA DO FATO GERADOR
		aAdd( aStru,{ cAls+"_SITUA",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_DTEVEN",	"D",	008,	0 } )
		aAdd( aStru,{ cAls+"_GRPTRB",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_CODREC",	"C",	006,	0 } )
		aAdd( aStru,{ cAls+"_PERIOD",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_ANO",	   	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_MBTQSA",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_DSQDAP",	"C",	002,	0 } )
		aAdd( aStru,{ cAls+"_ORDEM",	"C",	006,	0 } ) //ORDEM DO ESTABELECIMENTO
		aAdd( aStru,{ cAls+"_CNPJIN",	"C",	014,	0 } ) //CNPJ DA INCORPORACAO
		aAdd( aStru,{ cAls+"_RESERV",	"C",	001,	0 } )
		aAdd( aStru,{ cAls+"_P_APUR",	"D",	008,	0 } )
		aAdd( aStru,{ cAls+"_CNPJ_D",	"C",	014,	0 } )
		aAdd( aStru,{ cAls+"_REC_D",	"C",	004,	0 } )
		aAdd( aStru,{ cAls+"_DTVCTO",	"D",	008,	0 } )
		aAdd( aStru,{ cAls+"_NUMREF",	"C",	015,	0 } )
		aAdd( aStru,{ cAls+"_VLPRIN",	"C",	016,	0 } )
		aAdd( aStru,{ cAls+"_VLMULT",	"C",	015,	0 } )
		aAdd( aStru,{ cAls+"_VLJURO",	"C",	015,	0 } )
		aAdd( aStru,{ cAls+"_VLPGDB",	"C",	015,	0 } )
		aAdd( aStru,{ cAls+"_RELAC",	"C",	010,	0 } )
		aAdd( aStrCmps,aStru )
	
		cArq	:=	CriaTrab(aStru)
		dbUseArea(.T.,__LocalDriver,cArq,SubStr(aStru[1][1],1,3))
		IndRegua(SubStr(aStru[1][1],1,3),cArq,SubStr(aStru[1][1],1,3)+"_RELAC")
		aAdd( aTrbs,{ cArq,SubStr(aStru[1][1],1,3),"R11" } )

		aAdd( aTitulo, {})
		aAdd( aTitulo[Len(aTitulo)], OemToAnsi(STR0249))						//"R11 - Pagamentos com DARF"
		aAdd( aTitulo[Len(aTitulo)], {})
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0260,"@!" })						//"Tipo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0187,"@!" })						//"CNPJ do Contribuinte"
		If cTpDCTF == "M"
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0227,"@!" })  					//"Mes de Ocorrencia do Fato Gerador"
		Else
			aAdd( aTitulo[Len(aTitulo)][2],{ STR0254,"@!" })  					//"Semestre de Ocorrencia do Fato Gerador"
		EndIf
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0256,"@!" })  						//"Situacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0197,"@!" })						//"Data do Evento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0215,"@!" })						//"Grupo de Tributo"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0190,"@!" })						//"Codigo da Receita"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0236,"@!" })						//"Periodicidade"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0178,"@!" })						//"Ano do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0219,"@!" })						//"MBTQS do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0206,"@!" })						//"DSQD do Periodo de Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0235,"@!" })						//"Ordem do Estabelecimento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0186,"@!" }) 						//"CNPJ da Incorporacao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0252,"@!" })						//"RESERV"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0237,"@!" })						//"Periodo da Apuracao"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0188,"@!" })						//"CNPJ do DARF"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0191,"@!" })						//"Codigo da Receita do DARF"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0198,"@!" })						//"Data do Vencimento"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0233,"@!" })						//"Num. Referencia"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0268,"@!" })						//"Valor do Principal"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0266,"@!" })						//"Valor da Multa"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0269,"@!" })						//"Valor dos Juros"
		aAdd( aTitulo[Len(aTitulo)][2],{ STR0270,"@!" })						//"Valor pago do Debito"

	Else
		nArqVal	:=	2
	EndIf
Return( aTrbs )

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |ReportDef ณ Autor ณ Murilo Alves          ณ Data ณ28.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de definicao dos objetos do relatorio.               |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณoReport -> Objeto do TReport.                               ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|aTrbs    -> Arquivos de trabalho utilizado na rotina.       ณฑฑ
ฑฑณ          |aRegra   -> Array contendo as regras p/geracao dos registrosณฑฑ
ฑฑณ          |aStrCmps -> Array contendo a estrutura das celulas          ณฑฑ
ฑฑณ          |aTitulos -> Array contendo os labels e pictures das celulas ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function ReportDef(aTrbs,aRegra,aStrCmps,aTitulo,cFile)
	Local	oReport
	Local	aReg	:=	{}
	Local	nI		:=	0
	Local	nY		:=	0
	Local	nX		:=	0
	Local	nZ		:=	0
	Local	nTam	:=	0
	Local	nPos1	:=	0
	Local	nPosPai	:=	0
	Local	nPosReg	:=	0
	Local	nPosReg2:=	0
	Local	nPosReg3:=	0
	Local	nPosPai2:=	0

	oReport	:=	TReport():New("RDCTF",OemToAnsi(STR0280),"", {|oReport| ReportPrint(oReport,aRegra,aTitulo,cFile,aTrbs,aStrCmps)},OemToAnsi(STR0281))	//"Confer๊ncia DCTF"###"Este relat๓rio tem o objetivo de possibiliar de forma grแfica a confer๊ncia das informa็๕es que serใo enviadas ao fisco."
	oReport:SetLandscape()

	For nX := 1 To Len(aTitulo)
		cAlias	:=	"T"+StrZero(nX,2)
		cReg	:=	SubStr(aTitulo[nX][1],1,4)

		dbSelectArea(cAlias)
		If (nPosReg	:=	aScan(aRegra,{|aX| aX[1]==cReg}))>0
			aAdd( aReg, TRSection():New(oReport,OemToAnsi(aTitulo[nX][1]),{cAlias},{STR0279},/*Campos do SX3*/,/*Campos do SIX*/))	//"Por Registro"
			aReg[Len(aReg)]:SetNoFilter({cAlias})
		
		// Para uso futuro - utilizado para imprimir por coluna.
		//
		//aReg[Len(aReg)]:SetLineStyle(.T.)
		//aReg[Len(aReg)]:SetCols(nCols)
		
			nPosPai	:=	Len(aReg)
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณPRIMEIRO NIVELณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			For nI := 1 To Len(aTitulo[nX][2])
				nPos1	:=	aScan(aStrCmps[nX], {|aX| aX[1]==FieldName(nI)})
				nTam	:=	aStrCmps[nX][nPos1][3]
		    	
				TRCell():New(aReg[Len(aReg)],FieldName(nI),cAlias,aTitulo[nX][2][nI][1],aTitulo[nX][2][nI][2],	nTam,/*lPixel*/,&("{|| "+SubStr( FieldName(nI),1,3 )+"->"+FieldName( nI )+"}"))
			Next nI
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณSEGUNDO NIVELณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If Len(aRegra[nPosReg])>1
				For nY := 2 To Len(aRegra[nPosReg])
					cReg	:=	aRegra[nPosReg][nY][1]
				
					If (nPosReg2 := aScan(aTitulo,{|aX| SubStr(aX[1],1,4)==cReg}))>0
						cAlias	:=	"T"+StrZero(nPosReg2,2)
	
						dbSelectArea(cAlias)
					
						aAdd( aReg, TRSection():New(aReg[nPosPai],OemToAnsi(aTitulo[nPosReg2][1]),{cAlias},/*{Array com as ordens do relat๓rio}*/,/*Campos do SX3*/,/*Campos do SIX*/))
						aReg[Len(aReg)]:NLEFTMARGIN := 4
						nPosPai2:=	Len(aReg)
	
						For nI := 1 To Len(aTitulo[nPosReg2][2])
							nPos1	:=	aScan(aStrCmps[nPosReg2], {|aX| aX[1]==FieldName(nI)})
							nTam	:=	aStrCmps[nPosReg2][nPos1][3]

							TRCell():New(aReg[Len(aReg)],FieldName(nI),cAlias,aTitulo[nPosReg2][2][nI][1],aTitulo[nPosReg2][2][nI][2],	nTam,/*lPixel*/,&("{|| "+SubStr( FieldName(nI),1,3 )+"->"+FieldName( nI )+"}"))
						Next nI
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณTERCEIRO NIVELณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
						If Len(aRegra[nPosReg][nY])>1
							For nZ := 2 To Len(aRegra[nPosReg][nY])
								cReg	:=	aRegra[nPosReg][nY][nZ][1]
							
								If (nPosReg3 := aScan(aTitulo,{|aX| SubStr(aX[1],1,4)==cReg}))>0
									cAlias	:=	"T"+StrZero(nPosReg3,2)
				
									dbSelectArea(cAlias)
								
									aAdd( aReg, TRSection():New(aReg[nPosPai2],OemToAnsi(aTitulo[nPosReg3][1]),{cAlias},/*{Array com as ordens do relat๓rio}*/,/*Campos do SX3*/,/*Campos do SIX*/))
									aReg[Len(aReg)]:NLEFTMARGIN := 8
				
									For nI := 1 To Len(aTitulo[nPosReg3][2])
										nPos1	:=	aScan(aStrCmps[nPosReg3], {|aX| aX[1]==FieldName(nI)})
										nTam	:=	aStrCmps[nPosReg3][nPos1][3]
								   
										TRCell():New(aReg[Len(aReg)],FieldName(nI),cAlias,aTitulo[nPosReg3][2][nI][1],aTitulo[nPosReg3][2][nI][2],	nTam,/*lPixel*/,&("{|| "+SubStr( FieldName(nI),1,3 )+"->"+FieldName( nI )+"}"))
									Next nI
								EndIf
							Next nZ
						EndIf
					EndIf
				Next nY
			EndIf
		EndIf
	Next nX
	oReport:NFontBody := 5
	aReg[4]:ACELL[02]:NSIZE	:= 35 //Tipo R03 - CNPJ
	aReg[4]:ACELL[6]:NSIZE 	:= 45 //Tipo R03 - Nome Repr
	aReg[4]:ACELL[07]:NSIZE	:= 18 //Tipo R03 - CPF
	aReg[4]:ACELL[09]:NSIZE	:= 18 //Tipo R03 - Tel Repr
	aReg[4]:ACELL[12]:NSIZE	:= 16 //Tipo R03 - Fax Re
	aReg[4]:ACELL[13]:NSIZE	:= 45 //Tipo R03 - Email
	aReg[4]:ACELL[14]:NSIZE	:= 45 //Tipo R03 - Nome Res
	aReg[4]:ACELL[15]:NSIZE	:= 18 //Tipo R03 - CPF
	aReg[4]:ACELL[19]:NSIZE	:= 15 //Tipo R03 - Tel
	aReg[4]:ACELL[22]:NSIZE	:= 16 //Tipo R03 - Fax
	aReg[4]:ACELL[23]:NSIZE	:= 50 //Tipo R03 - Nome Resp
 
	aReg[6]:ACELL[2]:NSIZE := 30 //Tipo R11 - CNPJ
	aReg[6]:ACELL[15]:NSIZE	:= 18 //Tipo R11 - Dt Evento
	aReg[6]:ACELL[16]:NSIZE	:= 35 //Tipo R11 - CNPJ
	aReg[6]:ACELL[18]:NSIZE	:= 18 //Tipo R11 - Dt Evento
	aReg[6]:ACELL[20]:NSIZE	:= 40 //Tipo R11 - Vlr Princ
	aReg[6]:ACELL[23]:NSIZE	:= 38 //Tipo R11 - Vlr Beb

Return oReport
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |ReportPrintณ Autor ณ Murilo Alves         ณ Data ณ28.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de processamento e armazenamento dos conteudos       |ฑฑ
ฑฑณ          ณ a serem impressos.                                         |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณoReport -> Objeto do TReport.                               ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|oReport  -> Objeto do TReport.                              ณฑฑ
ฑฑณ          |aRegra   -> Array contendo as regras p/geracao dos registrosณฑฑ
ฑฑณ          |aTitulos -> Array contendo os labels e pictures das celulas ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function ReportPrint(oReport,aRegra,aTitulo,cFile,aTrbs,aStrCmps)
	Local	nX			:=	0
	Local	nY			:=	0
	Local	nZ			:=	0
	Local	nPosReg		:=	0
	Local	nPosReg2	:=	0
	Local	nPosReg3	:=	0
	Local	cAlias		:=	""
	Local	cAlias2		:=	""
	Local	cReg		:=	""
	Local	b2Relation	:=	{||}
	Local	b2ParFilter	:=	{||}
	Local	b3Relation	:=	{||}
	Local	b3ParFilter	:=	{||}

//Alimentacao dos arquivos de trabalho
	AlimentTrb(cFile, aTrbs, aRegra, aStrCmps)

	oReport:SetMeter(Len(aTitulo))
	For nX := 1 To Len(aTitulo)
		If oReport:Cancel()
			Exit
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณPRIMEIRO NIVELณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cAlias	:=	"T"+StrZero(nX,2)
		cReg	:=	SubStr(aTitulo[nX][1],1,4)
	
		dbSelectArea(cAlias)
		If (nPosReg	:=	aScan(aRegra,{|aX| aX[1]==cReg}))>0
			If Len(aRegra[nPosReg])>1
				For nY := 2 To Len(aRegra[nPosReg])
			    
					If AllTrim(cReg) <> 'R11'
						cReg	:=	aRegra[nPosReg][1]
					Else
						cReg	:=	aRegra[nPosReg][nY][1]
					EndIf
			   
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณSEGUNDO NIVELณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If (nPosReg2 := aScan(aTitulo,{|aX| SubStr(aX[1],1,4)==cReg}))>0
						cAlias2		:=	"T"+StrZero(nPosReg2,2)
						dbSelectArea(cAlias2)
						b2Relation	:=	&("{||"+cAlias+ "->"+cAlias+ "_RELAC}")
						b2ParFilter	:=	&("{||"+cAlias2+"->"+cAlias2+"_RELAC=="+cAlias+"->"+cAlias+"_RELAC}")
		
						oReport:Section(nPosReg):Section(nY-1):SetRelation(b2Relation,cAlias2,1,.T.)
						oReport:Section(nPosReg):Section(nY-1):SetParentFilter(b2ParFilter)
					
						If Len(aRegra[nPosReg][2][1])>1
							For nZ := 2 To Len(aRegra[nPosReg][2][1])
								cReg	:=	aRegra[nPosReg][nY][1]
							//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
							//ณTERCEIRO NIVELณ
							//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
								If (nPosReg3 := aScan(aTitulo,{|aX| SubStr(aX[1],1,4)==cReg}))>0
									cAlias3		:=	"T"+StrZero(nPosReg3,2)
									dbSelectArea(cAlias3)
								   
									b3Relation	:=	&("{||"+cAlias+ "->"+cAlias+ "_RELAC}")
									b3ParFilter	:=	&("{||"+cAlias3+"->"+cAlias3+"_RELAC=="+cAlias+"->"+cAlias+"_RELAC .And. " +cAlias2+"->"+cAlias2+"_RELAC=="+cAlias+"->"+cAlias+"_RELAC  }")
  							   
									oReport:Section(nPosReg):Section(nY-1):SetRelation(b3Relation,cAlias3,1,.T.)
									oReport:Section(nPosReg):Section(nY-1):SetParentFilter(b3ParFilter)
								EndIf
							Next nZ
						EndIf
					EndIf
				Next nY
			EndIf
			oReport:Section(nPosReg):Print()
			oReport:IncMeter()
		EndIf
	Next nX
Return
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |AlimentTrbณ Autor ณ Murilo Alves          ณ Data ณ28.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao utilizada para alimentar os TRBs criados de acordo   |ฑฑ
ฑฑณ          ณ o arquivo texto gerado anteriormente.                      |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|cFile    -> Nome do arquivo texto gerado anteriormente.     ณฑฑ
ฑฑณ          |aTrbs    -> Array contendo os nomes dos TRBs gerados.       ณฑฑ
ฑฑณ          |aRegra   -> Regra de nivel dos registros.                   ณฑฑ
ฑฑณ          |aStrCmps -> Estrutura de campos dos TRBs criados.           ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function AlimentTrb(cFile, aTrbs, aRegra, aStrCmps)
	Local	cLinha		:=	""
	Local	aCmps		:=	{}
	Local	nCmp		:=	0
	Local	nX			:=	1
	Local	nI			:=	1
	Local	nRecPai		:=	0
	Local	nRecFilho	:=	0
	Local	cReg		:=	""
	Local	cRegPai		:=	""
	Local	nPosReg		:=	0
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณAlimentacao dos TRBs acimaณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	FT_FUSE(cFile)
	FT_FGOTOP()
	Do While !FT_FEOF()
		cLinha	:=	FT_FREADLN()
		nCmp	:=	1
		cReg	:=	SubStr(cLinha,1,3)
		cReg	:=	Iif("DCT"$cReg,"HEAD",cReg)

		If (nPos	:=	aScan(aTrbs, {|aX| AllTrim(aX[3])==cReg}))>0
			cAlias	:=	aTrbs[nPos][2]
			nX		:=	Val(SubStr(cAlias,2,2))
			aCmps	:=	RetCntCmp( cLinha,aStrCmps[nX] )

			dbSelectArea(cAlias)
			RecLock(cAlias,.T.)
		
			If (nPosReg	:=	aScan(aRegra,{|aX| AllTrim(aX[1])==cReg}))>0
				cRegPai	:=	cReg
				nRecPai	:=	(cAlias)->(Recno())
			Else
				If (nPosReg	:=	aScan(aRegra,{|aX| AllTrim(aX[1])==cRegPai}))>0
					If Len(aRegra[nPosReg])>1
						For nI := 2 To Len(aRegra[nPosReg])
							If AllTrim(aRegra[nPosReg][nI][1])==cReg
								If Len(aRegra[nPosReg][nI])>1
									nRecFilho	:=	(cAlias)->(Recno())
								EndIf
							EndIf
						Next nI
					EndIf
				EndIf
			EndIf
		
			For nI := 1 To Len(aStrCmps[nX])
				If nI<=Len(aCmps) .Or. "_RELAC"$aStrCmps[nX][nI][1]
					If !"_RELAC"$aStrCmps[nX][nI][1]
						If aStrCmps[nX][nI][2]=="D"
							(cAlias)->(FieldPut(nI, CToD( Transform( aCmps[nCmp++],"@R 99/99/9999" ))))
						ElseIf aStrCmps[nX][nI][2]=="N"
							(cAlias)->(FieldPut(nI, Val(StrTran(aCmps[nCmp++],",","."))))
						Else
							(cAlias)->(FieldPut(nI, aCmps[nCmp++]))
						EndIf
	
					ElseIf "_RELAC2"$aStrCmps[nX][nI][1]
						(cAlias)->(FieldPut(nI, StrZero(nRecFilho,10)))
					
					ElseIf "_RELAC"$aStrCmps[nX][nI][1]
						(cAlias)->(FieldPut(nI, StrZero(nRecPai,10)))
					EndIf
				EndIf
			Next nI
			MsUnLock()
		EndIf
	
		FT_FSKIP()
	EndDo
Return
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |RetCntCmp ณ Autor ณ Murilo Alves          ณ Data ณ28.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao utilizada para montar um array com os campos de cada |ฑฑ
ฑฑณ          ณ registro.                                                  |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณaRet   -> Array na estrutura do registro alimentado.        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|cLinha -> Linha do arquivo texto a ser estruturado.         ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function RetCntCmp( cLinha,aStrCmps)
	Local	nX		:=	2
	Local	aRet	:=	{}
//Local	cCmp	:=	""
	Local	aCab	:=	{}

	For nX := 1 To Len(aStrCmps)
		aAdd(aCab,aStrCmps[nX,3])
	Next nX

	For nX := 1 To Len( aCab )
		aAdd(aRet,SubStr(cLinha,1,aCab[nX]))
		cLinha	:=	SubStr(cLinha,aCab[nX]+1)
	Next nX
Return( aRet )

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |MontWiz   ณ Autor ณMurilo Alves           ณ Data ณ29.05.2009ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ                                                            ณฑฑ
ฑฑณ          ณ                    MONTAGEM DO WIZARD                      ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณObservacaoณFuncao que monta o Wizard em tela para processamento.       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณNivel HierณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณlRet -> .T. se o wizard foi finalizado com sucesso ou .F. seณฑฑ
ฑฑณ          ณ foi cancelado.                                             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros|Nenhum                                                      ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function MontWiz (cNomWiz)
	Local	aTxtApre	:=	{}
	Local	aPaineis	:=	{}
	Local	cTitObj1	:=	""
	Local	cTitObj2	:=	""
	Local	lRet		:=	.T.
	//
	aAdd (aTxtApre, STR0296)	//"Parametros necessarios."
	aAdd (aTxtApre, "")
	aAdd (aTxtApre, STR0012)	//"Preencha corretamente as informacoes solicitadas."
	aAdd (aTxtApre, STR0297)	//"Informacoes necessarias para a impressใo de um relat๓rio de confer๊ncia do ATO COTEPE N. 35/05, baseado no arquivo texto jแ gerado atrav้s desta mesma rotina."
	//ฺฤฤฤฤฤฤฤฤฟ
	//ณPainel 0ณ
	//ภฤฤฤฤฤฤฤฤู	
	aAdd (aPaineis, {})
	nPos	:=	Len (aPaineis)
	aAdd (aPaineis[nPos], STR0012)	//"Preencha corretamente as informacoes solicitadas."
	aAdd (aPaineis[nPos], STR0298)	//"Parametros para Gera็ใo"
	aAdd (aPaineis[nPos], {})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	aAdd (aPaineis[nPos][3], {0,"",,,,,,});			aAdd (aPaineis[nPos][3], {0,"",,,,,,})
	//
	cTitObj1 := STR0299;								cTitObj2 := Replicate("X",100)	//"Informe o Arquivo origem"
	aAdd (aPaineis[nPos][3], {1, cTitObj1,,,,,,});	aAdd (aPaineis[nPos][3], {2,,cTitObj2,1,,,,100,,.T.})
	
	lRet := xMagWizard (aTxtApre, aPaineis, cNomWiz)
	
Return (lRet)

//-------------------------------------------------------------------
/*/{Protheus.doc} VerSdoQuota
Verifica se o Saldo vai ser pago em Cotas 

@param		cPref - Prefixo do  Tํtulo
@param		cNum - N๚mero do Tํtulo
@param		cTipo - Tipo do Tํtulo

@return	0 - Nใo
			1 - Sim

@author Mauro A. Goncalves
@since 29/02/2016
@version 1.0
/*/
//-------------------------------------------------------------------
Function VerSdoQuota(cPref,cNum,cTipo)
Local nQteQuota	:= 0
Local cAliasE2	:= ""

If Alltrim(SE2CPY->E2_PARCELA)=="0" .And. SE2CPY->E2_CODRET$cMV_RECTRIM
   	If (TcSrvType ()<>"AS/400")
		cAliasE2	:=	GetNextAlias()	  		   	

    	BeginSql Alias cAliasE2    	
			SELECT 
				COUNT(*) As QTEQUOTAS 	
			FROM 
				%Table:SE2% SE2
			WHERE 
				SE2.E2_FILIAL=%xFilial:SE2% AND
				SE2.E2_PREFIXO=%Exp:cPref% AND
				SE2.E2_NUM=%Exp:cNum% AND
				SE2.E2_TIPO=%Exp:cTipo% AND			
				SE2.%NotDel%
		EndSql
		
		nQteQuota	:= (cAliasE2)->QTEQUOTAS
		(cAliasE2)->(dbCloseArea())
	Endif
Endif

Return IIf(nQteQuota>0,1,0)

//-------------------------------------------------------------------
/*/{Protheus.doc} DumpFile
@description geracao do arquivo texto
@author Flavio Luiz Vicco
@since 15/08/2017
@version 1.0
/*/
//-------------------------------------------------------------------
Static Function DumpFile(nAcao, cDir, cFileDest)
Local cLib       := ""
Local cStartPath := AllTrim(GetSrvProfString("StartPath",""))
Local nRemType   := GetRemoteType(@cLib)
Local lHtml      := IIf(nRemType == 5 ,.T.,.F.)
Local nRet       := 0

Default nAcao    := 1
Default cDir     := ""
Default cFileDest:= ""

If nAcao == 1
	If Empty(cDir) .Or. lHtml
		cDir := cStartPath
	EndIf
	If !SubStr(cDir,Len(cDir),1)$"\/"
		cDir += "\"
	EndIf
	cFileDest := AllTrim(cFileDest)
	cFileDest := cDir+cFileDest
	If IsSrvUnix() .Or. nRemType == 2
		cFileDest := StrTran(cFileDest,"\","/")
		cFileDest := StrTran(StrTran(StrTran(Alltrim(cFileDest)," ","_"),chr(13),""),chr(10),"")
	Else
		//Se o drive nao existir, pergunto ao usuario se deseja cria-lo atraves da funcao LjDirect()
		If !ExistDir(cDir)
			LjDirect(cDir,.T.)
		Endif
	EndIf
Else
	If File(cFileDest)
		If lHtml
			MsgAlert("Em fun็ใo do acesso ao sistema ser via SmartClient HTML, o caminho informado para salvar o arquivo serแ desconsiderado, e serแ processado conforme configura็ใo do navegador.")
			nRet := CPYS2TW(cFileDest)
			If nRet == 0
				FErase(cFileDest)
				MsgInfo(OemToAnsi("Arquivo " + cFileDest + " gerado com sucesso!")) //"Arquivo "###" gerado com sucesso!"
			EndIf
		Else
			MsgInfo(OemToAnsi("Arquivo " + cFileDest + " gerado com sucesso!")) //"Arquivo "###" gerado com sucesso!"
		EndIf
	Else
		MsgAlert(OemToAnsi("Nใo foi possํvel gerar o arquivo!")) //"Nใo foi possํvel gerar o arquivo!"
	EndIf
EndIf

Return Nil
