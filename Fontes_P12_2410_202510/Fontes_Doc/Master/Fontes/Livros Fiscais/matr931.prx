#INCLUDE "Matr931.ch"
#INCLUDE "Protheus.ch"
#INCLUDE "Matr930Def.ch"
/*


Ŀ
Funo    Matr931      Autor Juan Jose Pereira     Data  18.12.96 		
Ĵ
Descrio Imprime Registro de Entradas P1 e Saidas P2                  		
Ĵ
 ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                     		
Ĵ
 PROGRAMADOR   DATA    BOPS   MOTIVO DA ALTERACAO                   		
Ĵ
 Marcos Simidu26/11/97XXXXXXImpressao de itens com Tes do livro ='Z'		
 Marcos Simidu23/12/9713597AAcertos nas quebras de pagina.          		
 Marcos Simidu23/12/9713855ACorrecao nas totalizacoes mes/periodos. 		
 Marcos Simidu24/03/9814621AInclusao parametro Totaliza por dia.    		
 Rodrigo Sart.25/03/9810385AAlteracao do parametro mv_par04  Lista: 		
                            (1)Livros (2)Termos (3)Livros e Termos  		
 Rodrigo Sart.27/03/9814810A Tratamento do estado origem no Resumo varia-	
                      14810Avel (lLisEstOri).                 			
 Marcos Simidu02/04/9815022AImpr. de Termo Encerr. quando o periodo inofor
                      15022Amado nao possuir movimento. 	    			
 Marcos Simidu06/05/98XXXXXXAcertos na impressao do termo de encerramento	
                            no livro de saidas.             				
 Eduardo      02/06/98xxxxxxDesenvolvimento do CIAP                 		
 Marcos Simidu02/07/98XXXXXXAcertos de dbSelectArea(0) - CIAP.      		
 Marcos Simidu11/08/98XXXXXXZera array acumulador dos resumos.      		
 Marcos Simidu22/10/9818419AAcertos no param.consid.UF no demonstrativo 	
              22/10/9818419Avo por estado de origem.                 		
 Marcos Simidu03/11/98XXXXXXAcertos no ano com 4 bytes.             		
 Marcos Simidu24/11/9810986AAcertos na totalizacao do vlr.contabil. 		
 Andreia      29/01/99xxxxxxAlteracao do lay-out devido ao aumento do cam-
                            po conta contabil.                			
 Andreia      11/03/99xxxxxxTratamento da especie das notas fiscais cance-
                            ladas atraves do parametro MV_ESPECIE			
 Andreia      10/08/9922553ATratamento do parametro MV_PAR21 que define em
                            qual coluna sera impresso o imposto retido 	
 Andreia      14/12/9919277ANo resumo por CFOP,trocar TOTAL por SUB-TOTAL	 
                            e TOTAL GERAL por TOTAL(Portaria CAT 08/90).	
 Guilherme    06/07/07125854Inclusao do numero da Reducao Z para os       
 Santos                     movimentos gerados para ECF's.                
                                                                          
 Vogas Junior 23/03/18DSERFIS2-4167 Parametrizacao da informacao de UF nas 
                            notas de conhecimento de transporte.          
                                                                      	
 Vogas Junior 26/04/18DSERFIS2-4546 Retornar tratamento referemte ao para	
                            metro 37 - Imprime Mapa Resumo.				
ٱ


*/
STATIC aSX6		:= R930LoadX6()

FUNCTION Matr931()

Local cArqCiap := ""

Private aSX6		:= R930LoadX6()
Private cIndxSF3  :=""
Private nCredAtivo :=0
Private cPesqCFO	:= PESQPICT("SF3","F3_CFO")
Private cPesqICMRET := PESQPICT("SF3","F3_ICMSRET")
Private cPesqOBSI	:= PESQPICT("SF3","F3_OBSICM")
Private cPesqOBSS	:= PESQPICT("SF3","F3_OBSSOL")
Private cPesqCRPR	:= PESQPICT("SF3","F3_CRPRST")

//Ŀ
// Flag de Movimentacao            
//
lHouveMov:=.F.
//Ŀ
// Largura do campo de observacoes 
//
nLargObs:=If(nTipoMov=1,17,32)
//Ŀ
// Pictures de campos numericos - Colunas Valores    
//
cPictVl:=If(nTipoMov==1,"@E 999,999,999,999.99","@E 999,999,999,999.99")
//Ŀ
// Recebe layout do modelo escolhido 
//
aL:=NIL
R931LayOut()
//Ŀ
// So trata arquivo quando for imprimir Livros ou Livros e Termos
//
If nImpTerm == 1 .Or. nImpTerm == 3
	//Ŀ
	// Cria Arquivo a ser Impresso com um indice de mesmo nome            
	// Ordem (1) = F3_FILIAL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO  
	//
	cArqTemp:=EmiteLivro(If(nTipoMov==1,"E","S"),dDtIni,dDtFim,lLacuna,lServico,lDesconto,cNrLivro,cFilterUser,@cArqCiap,MV_PAR27,MV_PAR09,MV_PAR31,MV_PAR32,MV_PAR33,MV_PAR36,"MATR930",,(MV_PAR30==1),lConjugada)
	//Ŀ
	// Salva periodos de Apuracao 
	//
	nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
	nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
EndIf
If !lAbortPrint
	If nTipoMov==1
		R931RegEntradas()
	Else
		R931RegSaidas()
	Endif
Endif
//Ŀ
// Restaura area 
//
//Ŀ
// So trata arquivo quando for imprimir Livros ou Livros e Termos
//
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dbCloseArea()
    Ferase(cArqTemp+GetDbExtension())
	Ferase(cArqTemp+OrdBagExt())
EndIf
If ( Select("CIAP")!=0 )
	dbSelectArea("CIAP")
	dbCloseArea()
    Ferase(cArqCiap+GetDbExtension())
	Ferase(cArqCiap+OrdBagExt())
EndIf

dbSelectArea(aSvArea[1])
dbSetOrder(aSvArea[2])
dbGoto(aSvArea[3])
Return
/*


Ŀ
Funo    R931RegEntradasAutor Juan Jose Pereira   Data  18.12.96 
Ĵ
Descrio Imprime Registro de Entradas                                
ٱ


*/
STATIC FUNCTION R931RegEntradas()
Local lApur := .F.          
Local aAreaSM0	 	:= SM0->(GetArea())
Local lP1IcmST		:= aSX6[MV_P1ICMST]
Local lProcST		:= .T.
Local lAliqstn      := aSX6[MV_ALIQSTN] // parametro tem como objetivo nao imprimir aliquota de ICMS ST no relatorio
Local lUnicaNf		:= .T.
Local EntAmbulante  := .F.
Local lImprZero		:= aSX6[MV_IMPZNFC]
Local cIdTipo       := ""							//Identifica Tipo CNPJ/CPF
Local cUltNF		:= ''								// ltima Nota para controle de total do valor contbil no primeiro item
Local nVlrOrig		:= 0								// Valor original do campo para parametrizao de valor contbil por item
Local cUfFornecedor	:= aSX6[MV_NFCTEUF]
Local lF3_VL43080	:= lF3_VL43080
Local lF3_VLINCMG	:= lF3_VLINCMG
Local nTamCon		:= 0
Local nMaxLin		:= 0
Local nMaxCol		:= 14
Local nIniPos		:= 0
Local nH			:= 0
Local nI			:= 0
Local cContaFor		:= ""

Private lMod55		:= aSX6[MV_SPED55]
Private aLinCont	:= {}
aGrade:=NIL             

//Ŀ
// So trata arquivo quando for imprimir Livros ou Livros e Termos
//
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
		lTotGrade:=.F.
		lUnicaNf := .T.
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
		//Ŀ
		// Cabecalho 
		//
		If nLin>nLimPag .And. !(cArqTemp)->SEMMOV
			R931Cabec(dDia)
		Endif
		//Ŀ
		// Contador de Tamanho de nota 
		//
		nTamNota:=nLin             
		
		//Ŀ
		//Verifica o valor do ICMS Retido de acordo com a configuracao da TES     
		//Quando o campo F3_CREST existir e estiver configurado como "4",         
		//o valor do ICMS retido nao deve ser apresentado na coluna de observacoes
		//     
        lProcST := .T.
		If lCredST
		    If (cArqTemp)->F3_CREDST == "4" .And. lP1IcmST
                lProcST := .T.
			Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST
                lProcST := .F.
            Endif
        Endif
		lEntAmbulante := .F.                       
		
		//Ŀ
		//Imprime os periodos sem movimento
		//
		If (cArqTemp)->SEMMOV
			dDia:=(cArqTemp)->F3_ENTRADA
			R931Cabec(dDia)
			cLinha:=FmtLin(Array(18),aL[17],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA          
			lHouveMov := .T.
			Loop
		Endif

		//Ŀ
		// Salva periodos de Apuracao 
		//
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
		Endif            
		//Ŀ
		//Posiciona na filial em que foi processado o registro	
		//
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
		//Ŀ
		// Posiciona nos cadastros de Clientes/Fornecedores
		//
		cClieFor:=(cArqTemp)->(F3_CLIEFOR+F3_LOJA)
		If lF3_CLIDVMC .And. !Empty(F3_CLIDVMC)
			cClieFor:=Alltrim(F3_CLIDVMC)+Alltrim(F3_LOJDVMC)
		Endif
		If(F3_TIPO$"DB",dbSelectArea("SA1"),dbSelectArea("SA2"))
		MSSeek(xFilial()+cClieFor)
		//Ŀ
		//Conta contabil devera ser buscada no parametro MV_CTALFE de cada filial
		//
		cContaContab := Alltrim(aSX6[MV_CTALFE])
		cContaContab :=	StrTran(cContaContab,"SF3->","(cArqTemp)->")
		cContaContab := IIF(Empty(EvalMacro(cContaContab)), (cArqTemp)->CONTA,EvalMacro(cContaContab))
		//dbSelectArea(cArqTemp)
		//Ŀ
		//Restaura a filial e area corrente 
		//
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao 
		//
		aObs:=LivrArrayObs(nLargObs,,lListaNFO,,lObsFecp,,;
			(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA+(cArqTemp)->F3_SERIE+(cArqTemp)->F3_NFISCAL+(cArqTemp)->F3_IDENTFT;
		)
		R931IniGrade()
		
	    If lEntAmbulante
		    aGrade[1,1]:=""
		Else
		    If lImpZer.or.F3_BASEICM+F3_VALICM>0  
			    aGrade[1,1]:="1"
			    aGrade[1,2]:=F3_BASEICM
			    aGrade[1,3]:=F3_VALICM
			Else
				aGrade[1,1]:=""
			Endif
        EndIf
		If lImpZer.or.F3_ISENICM>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
			    aGrade[nx,1]:="2"
			    aGrade[nx,2]:=F3_ISENICM
		    EndIf
		Endif
		If lImpZer.or.F3_OUTRICM>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
    			aGrade[nx,1]:="3"				
				If F3_OUTRICM>0
		    		aGrade[nx,2]:=F3_OUTRICM
				Endif
		    EndIf
		Endif                                               		
		If lImpZer.or.(lF3_VL43080 .and. F3_VL43080>0)
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
    			aGrade[nx,1]:="3"				
				If lF3_VL43080
				    If F3_VL43080 > 0
				    	aGrade[nx,2] += F3_VL43080
				    EndIf
				Endif                                               					   				    
		    EndIf
		Endif                                               		
		If lImpZer.or. (lF3_VLINCMG .and. F3_VLINCMG>0)
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
    			aGrade[nx,1]:="3"				
			    If lF3_VLINCMG
			        If F3_VLINCMG > 0
			    	    aGrade[nx,2] += F3_VLINCMG
			       EndIf
			    EndIf
		    EndIf
		Endif                                               		
	    If lEntAmbulante
		    aGrade[1,4]:=""
		Else
			If lImpZer.or.F3_BASEIPI+F3_VALIPI>0
				aGrade[1,4]:="1"
			    aGrade[1,5]:=F3_BASEIPI
    	        aGrade[1,6]:=F3_VALIPI
 	     	Else
				aGrade[1,4]:=""
			Endif
        EndIf
		If lImpZer.or.F3_ISENIPI>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
				aGrade[nx,4]:="2"
				aGrade[nx,5]:=F3_ISENIPI
		    EndIf
		Endif
		If lImpZer.or.F3_OUTRIPI>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
			    aGrade[nx,4]:="3"
				aGrade[nx,5]:=F3_OUTRIPI
		    EndIf
		Endif    
		
		//Imprime no campo codigo emitente o CNPJ/CPF ou o codigo do fornecedor
		If mv_par47==1 
			If RetPessoa((cArqTemp)->CGC) == "F"
		    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R 999.999.999-99")
		    ELSE
		    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R! NN.NNN.NNN/NNNN-99")
		    EndIf
    	Else
			cIdTipo := (Alltrim((cArqTemp)->COD)+"-"+(cArqTemp)->LOJA)
		Endif   			

		aDados:=Array(18)
		aDados[1]:=DTOC(F3_ENTRADA)
		aDados[2]:=IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,SerieNfId(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE))
		aDados[3]:=SerieNfId(cArqTemp,2,"F3_SERIE") 
		aDados[4]:=F3_NFISCAL                          
		aDados[5]:=DTOC(F3_EMISSAO)
        aDados[6]:=cIdTipo
        aDados[7]:= Iif( cUfFornecedor =='1' .And. AllTrim( (cArqTemp)->F3_ESPECIE ) == 'CTE', SA2->A2_EST, F3_ESTADO )
		
		aLinCont:= {}	//zera array devido a carga R931ImpGrade para impressao de conhecimento de frete	
		If Empty(F3_DTCANC) .Or. lImprZero
			aDados[8]:=Iif(lEntAmbulante,0,F3_VALCONT)
			aDados[9]:=Alltrim(Substr(cContaContab,1,TamSX3("A2_CONTA")[1]))

			//Tratativa para imprimir conta contabil com tamanho maior que 20 sem quebrar a coluna do relatorio
			nTamCon := IIF(Valtype(aDados[7]) == "C", Len(Alltrim(aDados[9])), 0) //checa a quantidade de caracteres da conta contabil
			If nTamCon > nMaxCol //verifica necessidade de tratativa para quebra de linha devido ao tamanho da conta contabil
				nMaxLin := Ceiling(nTamCon/nMaxCol) //qtd total de quebras de linhas
				cContaFor := aDados[9]
				aAdd(aLinCont,Substr(cContaFor,1,nMaxCol)) //limita o tamanho da conta contabil para impressao na primeira linha

				//Cria array para armazenar os dados da conta contabil por quebra de linha
				For nH:=2 to nMaxLin
					nIniPos :=(nMaxCol*nH)-13
					cQuebraCon := Substr(cContaFor,nIniPos,nMaxCol)
					If !Empty(cQuebraCon)
						aAdd(aLinCont,cQuebraCon) //alimenta o array das quebras da conta contabil por linha
					EndIf
				Next nH
			EndIf	

	        aDados[10]:=If(substr(F3_CFO,1,3)$"999#000",,Transform(F3_CFO,cPesqCFO))
			If nModelo != 5
				If lEntAmbulante
				    aDados[13]:=""
				Else 
				    aDados[13]:=Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),"")
			    EndIf
			EndIf
		Endif
	
		//Ŀ
		// Imprime Linhas de detalhe              
		//
		If lVlCtTot
			nVlrOrig	:= aDados[8]
			aDados[8]	:= R931TVlCtEn(@cUltNF)
			R931ImpGrade(lUnicaNf)
			aDados[8]	:= nVlrOrig
		Else
			R931ImpGrade(lUnicaNf)
		EndIf
				
		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			Endif
		End
   		//Ŀ
		// Para atender legislacao Fomentar de GO 
		//
		If !Empty(cTitLivro) .and. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST
			aDados[11]:="ST"
			aDados[12]:=F3_BASERET
			If nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=F3_ICMSRET-F3_OBSSOL
			ElseIf nColuna == 3	
	            If F3_TIPO == "D"
				   aDados[14]:=F3_ICMSRET-F3_OBSSOL
				Else
				   aDados[18]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST .And. F3_CREDST <> '4'
			aDados[11]:="ST"
			aDados[12]:=F3_BASERET
			If nModelo != 5
            	aDados[13]:= Iif(lAliqstn,"",Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[14]:=F3_ICMSRET-F3_OBSSOL
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Endif

		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			For nI:=1 to Len(aLinCont)
				aDados[9] := aLinCont[nI]
				FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			Next nI
		EndIf

		//Ŀ
		// Acumula valores 
		//
		nLinNec:=nLin-nTamNota+If(lImpZer,1,0)
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3,,@aResCFOZer,@aTotObs)
		dDiaAnt:=F3_ENTRADA
		********************* CIAP **********************
		//Ŀ
		// Atualiza a Manutencao do CIAP                   
		//
        If lEmiteCiap
		   If Select("CIAP") > 0
			  dbSelectArea("CIAP")
			  If ( MSSeek(&(cArqTemp)->(Recno())) )
				 While ( !Eof() .And. CIAP->SF3==&(cArqTemp)->(Recno()) )
					   dbSelectArea("SF9")
					   dbGoto(CIAP->SF9)
					   Begin Transaction
						     RecLock("SF9",.F.)
						     SF9->F9_NLRE := Val(cLivro)
						     SF9->F9_FLRE := nPagina
						     MsUnlock()
					   End Transaction
					   dbSelectArea("CIAP")
					   dbSkip()
				 EndDo
			  Endif
		   EndIf
		Endif   
		********************* CIAP **********************
		dbSelectArea(cArqTemp)
		dbSkip()
		If !Eof()
			dDia:=F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf
		//Ŀ
		// Imprime Totais e finaliza relatorio 
		//
		lTotGrade:=.T.
		lHouveMov:=.T.
		R931Totais()
		If lUnicaNf
			lUnicaNf := .F.
		EndIf
	End
	//Ŀ
	// Quando nao ha movimento                                      
	//
	If !lHouveMov
		dDia:=dDtIni
		R931Cabec(dDia)
		cLinha:=FmtLin(Array(18),aL[17],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R931TermEnc()
	Endif
Else
	//Ŀ
	// Imprime Termo de Abertura    
	//
	R931TermIni()
	//Ŀ
	// Imprime Termo de Encerramento
	//
	R931TermEnc()
EndIf
Return

/*


Ŀ
Funo    R931RegSaidasAutorJuan Jose Pereira      Data  18.12.96 
Ĵ
Descrio Imprime Registro de Saidas                                  
ٱ


*/
STATIC FUNCTION R931RegSaidas
Local lMV_ESTCLI 	:= aSX6[MV_ESTCLI]	//Parametro para mudar a pesquisa do estado do cliente. F3_ESTADO pelo A1_EST ou A2_EST.
Local lApur			:= .F.  
Local lEcfNotas 	:= aSX6[MV_ECFNOTA]	//Parametro tem como objetivo imprimir o documento final mesmo sem a utilizacao de Aglutinar Notas Fiscais de Saida
Local lAliqstn      := aSX6[MV_ALIQSTN] // parametro tem como objetivo nao imprimir aliquota de ICMS ST no relatorio
Local aAreaSM0 		:= SM0->(GetArea())
Local lF3_VLINCMG	:= lF3_VLINCMG
Local lProcST		:= .T.
Local lSaiAmbulante := .F.
Local lImprZero		:= aSX6[MV_IMPZNFC]
Local lP1IcmST		:= aSX6[MV_P1ICMST]
Local cRet931Ecf	:= ""
Local nTamCon		:= 0
Local nMaxLin		:= 0
Local nMaxCol		:= 14
Local nIniPos		:= 0
Local cContaFor		:= ""
Local nH			:= 0
Local nI			:= 0

PRIVATE aLinCont	:= {}
PRIVATE aGrade 		:= {}

//Ŀ
// So trata arquivo quando for imprimir Livros ou Livros e Termos
//
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=(cArqTemp)->F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
        //Ŀ
		//Verifica o valor do ICMS Retido de acordo com a configuracao da TES     
		//Quando o campo F3_CREST existir e estiver configurado como "4",         
		//o valor do ICMS retido nao deve ser apresentado na coluna de observacoes
		//
        lProcST := .T.
		If lCredST
		    If (cArqTemp)->F3_CREDST == "4" .And. (cArqTemp)->F3_OBSSOL>0
                lProcST := .F.
            Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST 
	   			lProcST := .F.
            Endif
        Endif

        If (!lLacuna .AND. !Empty((cArqTemp)->F3_DTCANC))
     	   dbSelectArea(cArqTemp)
		   dbSkip()
		   If Eof() .And. lHouveMov
				dDia:=(cArqTemp)->F3_ENTRADA
				R931Totais()
		   EndIf
         loop
        Endif
		lSaiAmbulante := .F.
      
		//Ŀ
		// Cabecalho 
		//
		If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
			R931Cabec(dDia)
		Endif
		//Ŀ
		//Imprime os periodos sem movimento
		//
		If (cArqTemp)->SEMMOV
			dDia:=(cArqTemp)->F3_ENTRADA
			R931Cabec(dDia)
			cLinha:=FmtLin(Array(15),aL[19],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA          
			lHouveMov := .T.
			Loop
		Endif

		//Ŀ
		// Salva periodos de Apuracao 
		//
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo((cArqTemp)->F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo((cArqTemp)->F3_ENTRADA,nApurIPI)
		Endif
		//Ŀ
		//Posiciona na filial em que foi processado o registro	
		//
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)	
		
		//Ŀ
		//Verifica o parametro para cada filial processada
		//
        lMV_ESTCLI 	:= aSX6[MV_ESTCLI]
		//Ŀ
		// Posiciona nos cadastros de Clientes/Fornecedores 
		//
		cClieFor:=(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA
		If(F3_TIPO$"DB",dbSelectArea("SA2"),dbSelectArea("SA1"))		
		MSSeek(xFilial()+cClieFor)		

		//Ŀ
		//Conta contabil devera ser buscada no parametro MV_CTALFS de cada filial
		//
		cContaContab := Alltrim(aSX6[MV_CTALFS])
		cContaContab :=	StrTran(cContaContab,"SF3->","(cArqTemp)->")
		cContaContab := IIF(Empty(EvalMacro(cContaContab)), (cArqTemp)->CONTA,EvalMacro(cContaContab))
		
		//Ŀ
		//Restaura a filial e area corrente 
		//
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//Ŀ
		// Contador de Tamanho de nota 
		//
		nTamNota:=nLin
        
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		aObs:=LivrArrayObs(nLargObs,,lListaNFO,,lObsFecp,,;
			(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA+(cArqTemp)->F3_SERIE+(cArqTemp)->F3_NFISCAL+(cArqTemp)->F3_IDENTFT;
		)
		//Ŀ
		// Linhas de Detalhe
		//
		aDados:=Array(15)

		//Ŀ
		//Preenche a especie de acordo com a regra e Artigo utilizado utilizada  
		//
		aDados[1] := R931GetEcf(cArqTemp,1)  
		aDados[2] := R931GetEcf(cArqTemp,2)
		
		IF lAglutina        
		   aDados[3]:=F3_NFISCAL+" A "+IF(!EMPTY((cArqTemp)->F3_DTCANC),(cArqTemp)->F3_NFISCAL,(cArqTemp)->F3_DOCOR)
		ELSE   
		   aDados[3]:=F3_NFISCAL+" A "+IF((cArqTemp)->F3_TIPO$"L" .And. !lEcfNotas ,(cArqTemp)->F3_DOCOR,(cArqTemp)->F3_NFISCAL)
		ENDIF 
		//Ŀ
		//Layout de acordo com a lei 9.513 (lista o intervalo de cupons fiscais - ECF)
		//
		If lLeiECF .AND. (lF3_NUMINI .AND. lF3_NUMFIM) .AND. !Empty(F3_PDV)
			//Ŀ
			//Posiciona na filial em que foi processado o registro	
			//
	        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
			//Ŀ
			//Recupera a partir do SFI, o numero do ultimo documento emitido no ECF.
			//
			If !(AllTrim(F3_ESPECIE) == "NFCE" .Or. AllTrim(F3_ESPECIE) == "SATCE")
				cRet931Ecf := R931GetEcf(cArqTemp,3) 
				aDados[3] := Iif(!Empty(cRet931Ecf),cRet931Ecf,aDados[3]) 
			EndIf
	
			dbSelectArea(cArqTemp)
			//Ŀ
			//Restaura a filial e area corrente 
			//
			Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		Endif
		aDados[4]:=StrZero(Day(F3_ENTRADA),2)
		//
		aDados[5]:=F3_ESTADO
		If (lMV_ESTCLI)
			aDados[5]:= (cArqTemp)->EST
		EndIf

		aLinCont:= {}	//zera array devido a carga R931ImpGrade para impressao de conhecimento de frete	
		If Empty((cArqTemp)->F3_DTCANC) .Or. lImprZero		
		
			aDados[6]:=Iif(lSaiAmbulante==.T.,0,(cArqTemp)->F3_VALCONT)
			aDados[7]:=Alltrim(Substr(cContaContab,1,TamSX3("A1_CONTA")[1]))

			//Tratativa para imprimir conta contabil com tamanho maior que 20 sem quebrar a coluna do relatorio
			nTamCon := IIF(Valtype(aDados[7]) == "C", Len(Alltrim(aDados[7])), 0) //checa a quantidade de caracteres da conta contabil
			If nTamCon > nMaxCol //verifica necessidade de tratativa para quebra de linha devido ao tamanho da conta contabil
				nMaxLin := Ceiling(nTamCon/nMaxCol) //qtd total de quebras de linhas
				cContaFor := aDados[7]
				aAdd(aLinCont,Substr(cContaFor,1,nMaxCol)) //limita o tamanho da conta contabil para impressao na primeira linha

				//Cria array para armazenar os dados da conta contabil por quebra de linha
				For nH:=2 to nMaxLin
					nIniPos :=(nMaxCol*nH)-13
					cQuebraCon := Substr(cContaFor,nIniPos,nMaxCol)
					If !Empty(cQuebraCon)
						aAdd(aLinCont,cQuebraCon) //alimenta o array das quebras da conta contabil por linha
					EndIf
				Next nH
			EndIf

	      	aDados[8]:=If(substr((cArqTemp)->F3_CFO,1,3)$"999#000",,Transform((cArqTemp)->F3_CFO,cPesqCFO))
			If lSaiAmbulante
	    		aDados[9]:=""
	  		Else
	    		aDados[9]:=If((cArqTemp)->F3_TIPO=="S".OR.(cArqTemp)->F3_FORMUL=="S",,"ICMS")
			    aDados[10]:=(cArqTemp)->F3_BASEICM       
			    If nModelo != 5
				    aDados[11]:=Iif((cArqTemp)->F3_ALIQICM > 0,Transform((cArqTemp)->F3_ALIQICM,"@E 99.99"),"")
			    EndIf
			    aDados[12]:=(cArqTemp)->F3_VALICM
			    aDados[13]:=(cArqTemp)->F3_ISENICM
			    aDados[14]:=(cArqTemp)->F3_OUTRICM
			    If lF3_VLINCMG
			        If !Empty((cArqTemp)->F3_VLINCMG)
			            aDados[14] += (cArqTemp)->F3_VLINCMG
			        EndIf
			    EndIf
			EndIf
		Endif
		
		R931LoadObs()

		FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		nPosObs:=Ascan(aObs,{|x|x[2]})
		If Empty((cArqTemp)->F3_DTCANC)
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0               
				    //Verifica se havera salto de pagina p/impressao das OBS
				    If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
						aDados[3]:=STR0023 //"A TRANSPORTAR"
						aDados[6]:=aTransp[ColF3("F3_VALCONT")]
						aDados[9]:="ICMS"
						aDados[10]:=aTransp[ColF3("F3_BASEICM")]
						aDados[12]:=aTransp[ColF3("F3_VALICM")]
						aDados[13]:=aTransp[ColF3("F3_ISENICM")]
						aDados[14]:=aTransp[ColF3("F3_OUTRICM")]
						If lF3_VLINCMG
			    			If !Empty(aTransp[ColF3("F3_VLINCMG")])
				    		    aDados[14] += aTransp[ColF3("F3_VLINCMG")]
					    	EndIf
						EndIf
						FmtLin(@aDados,aL[20],cPictVl,,@nLin)
						aDados[9]:="IPI"
						aDados[10]:=aTransp[ColF3("F3_BASEIPI")]
						aDados[12]:=aTransp[ColF3("F3_VALIPI")]
						aDados[13]:=aTransp[ColF3("F3_ISENIPI")]
						aDados[14]:=aTransp[ColF3("F3_OUTRIPI")]
						FmtLin(@aDados,aL[20],cPictVl,,@nLin)				
						R931Filler()
						R931Cabec()  
	                Else
	                	FmtLin(@aDados,aL[19],cPictVl,,@nLin)
	                Endif                
				Endif
			End
			
			If !((cArqTemp)->F3_TIPO=="S".OR.(cArqTemp)->F3_FORMUL=="S")
				If lSaiAmbulante
				    aDados[9]:=""
				Else			
	   			    aDados[9]:="IPI"
				    aDados[10]:=(cArqTemp)->F3_BASEIPI
				    aDados[12]:=(cArqTemp)->F3_VALIPI
				    aDados[13]:=(cArqTemp)->F3_ISENIPI
				    aDados[14]:=(cArqTemp)->F3_OUTRIPI
				EndIf
				R931LoadObs()
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Endif
			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0             
					FmtLin(@aDados,aL[19],cPictVl,,@nLin)
				Endif
			End
		Endif
	 	//Ŀ
		// Atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro).and. (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL>0 .And. lProcST
			aDados[9]:="ST"
			aDados[10]:=(cArqTemp)->F3_BASERET
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform((cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:= (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
			ElseIf nColuna == 3	
                If F3_TIPO <> "D"
				   aDados[12]:= (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
                Else
				   aDados[15]:=STR0001+Alltrim(Transform((cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL>0 .And. lProcST .And. F3_CREDST <> '4'
			aDados[09]:="ST"
			aDados[10]:=(cArqTemp)->F3_BASERET       
			If nModelo != 5
				aDados[11]:= Iif(lAliqstn,"",Iif((cArqTemp)->F3_ALIQICM > 0,Transform((cArqTemp)->F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[12]:= (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif
		//Ŀ
		// Acumula valores 
		//

		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			For nI:=1 to Len(aLinCont)
				aDados[7] := aLinCont[nI]
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Next nI
		EndIf

		nLinNec:=nLin-nTamNota+If(lImpZer,1,0)
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3,,@aResCFOZer,@aTotObs,,lMV_ESTCLI)
		dDiaAnt:=(cArqTemp)->F3_ENTRADA
		dbSelectArea(cArqTemp)
		dbSkip()
		If !Eof()
			dDia:=(cArqTemp)->F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf                 
      
      While nPosObs>0
			R931LoadObs()
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			nPosObs:=Ascan(aObs,{|x|x[2]})		
		Enddo
				
		//Ŀ
		// Imprime Totais e finaliza relatorio 
		//
		lHouveMov:=.T.
		R931Totais()
	End
	//Ŀ
	// Quando nao ha movimento                                      
	//
	If !lHouveMov
		dDia:=dDtIni
		R931Cabec(dDia)
		cLinha:=FmtLin(Array(15),aL[19],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R931TermEnc()
	Endif
Else
	//Ŀ
	// Imprime Termo de Abertura    
	//
	R931TermIni()
	//Ŀ
	// Imprime Termo de Encerramento
	//
	R931TermEnc()
EndIf
Return
/*


Ŀ
Funo     R931Cabec Autor  Juan Jose Pereira      Data  18.12.96 
Ĵ
Descrio  Impressao de Cabecalho                                     
ٱ


*/
FUNCTION R931Cabec(dData)
Local lLFisOrd := aSX6[MV_LFISORD]
Local cTermoSAb := aSX6[MV_LSAIAB]
Local cTermoEAb	:= aSX6[MV_LENTAB]
Local cMvEstado := aSX6[MV_ESTADO]
dData:=IIf(dData==NIL,dDiaAnt,dData)
If MV_PAR41 == 1 .And. !Empty(aSX6[MV_P2ABER]) .And. !Empty(aSX6[MV_P1ABER])
	cTermoSAb := aSX6[MV_P2ABER]
	cTermoEAb := aSX6[MV_P1ABER]
EndIf


cPeriodo:=aMeses[Month(dData)]+" / "+Str(Year(dData),4)
//Ŀ
// Imprime Termos de Abertura/Encerramento
//
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3).and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
//Ŀ
// Imprime Cabecalho  
//
nLin:=3
FmtLin(,AvalImp(nLargMax),,,@nLin)
FmtLin(,aL[1],,,@nLin)
FmtLin({cCabNumLiv},aL[2],,,@nLin)
FmtLin(,aL[3],,,@nLin)
FmtLin({cNome},aL[4],,,@nLin)
FmtLin(,aL[5],,,@nLin)
FmtLin({cInscr,cCGC},aL[6],,,@nLin)
FmtLin(,aL[7],,,@nLin)
If lLFisOrd .and. !(cMvEstado == "PE")
	FmtLin({cLivro,cPagina,cPeriodo},aL[8],,,@nLin)
Else
	FmtLin({cPagina,cPeriodo},aL[8],,,@nLin)
Endif
FmtLin(,{aL[9],aL[10],aL[11],aL[12],aL[13],aL[14],aL[15],aL[16]},,,@nLin)
If nTipoMov==2
	FmtLin(,{aL[17],aL[18]},,,@nLin)
Endif

Return
/*


Ŀ
Funo     R931LayOutAutor  Juan Jose Pereira      Data  18.12.96 
Ĵ
Descrio  Layout dos modelos P1 e P2                                 
ٱ


*/
STATIC FUNCTION R931LayOut

Local nSubDiv	:= mv_par36
Local lLFisOrd	:= aSX6[MV_LFISORD]
Local lImp  	:= aSX6[MV_IMPCABE]
Local lImpPag  	:= aSX6[MV_IMPPAGI]

If nTipoMov==1
	aL:=Array(18)  
	aL[01]:="+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	
	//Ŀ
	//Para atender a Legislacao de Pernambuco                        
	//O valor do ICMS ST nas entradas deve ser apresentado em coluna 
	//especifica - Contribuinte Substituido - ICMS na Fonte          
	//
	If cMV_ESTADO == "PE"
		aL[02]:=STR0050 //"|                                                                  REGISTRO DE ENTRADAS #                                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
		aL[03]:="|                                                                                                                                                               |------------------------------------------------------------|"
		aL[04]:=STR0051 //"| FIRMA: #############################                                                                                                                        |1-OPERACOES COM CREDITO DO IMPOSTO                          |"
		aL[05]:=STR0052 //"|                                                                                                                                                             |                                                            |"
		aL[06]:=STR0053 //"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                                    |2-OPERACOES SEM CREDITO DO IMPOSTO-ISENTAS OU NAO TRIBUTADAS|"
		aL[07]:=STR0054 //"|                                                                                                                                                             |                                                            |"
		aL[08]:=STR0055 //"| FOLHA: #######                   MES OU PERIODO/ANO: #######                                                                                                |3-OPERACOES SEM CREDITO DO IMPOSTO - OUTRAS                 |"
		aL[09]:=STR0056 //"|                                                                                                                                                             |                                                            |"		
		aL[10]:=STR0057 //"|                                                                                                                                                             |ST-CONTRIBUINTE-SUBSTITUIDO - ICMS NA FONTE                 |"
    Else
    	If nSubDiv == 1 
    		//Ŀ
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      
			// 
    		If cMV_ESTADO == "SE"   
    			aL[02]:=STR0071 	//"|                                                                REGISTRO DE ENTRADAS MODELO P1                                                               |                  (*) CODIGO DE VALORES FISCAIS             |"	
    		Else
	    		If lImp
	    	    	aL[02]:=STR0064 //"|                                                                  REGISTRO DE ENTRADAS # - P1                                                                |                  (*) CODIGO DE VALORES FISCAIS             |"
	    	    Else
			   		aL[02]:=STR0003 //"|                                                                  REGISTRO DE ENTRADAS #                                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
				Endif 
	    	EndIf 
    	ElseIf nSubDiv == 2
    		//Ŀ
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      
			// 
    		If cMV_ESTADO == "SE"   
    			aL[02]:=STR0073		//"|                                                        LIVRO REGISTRO DE ENTRADAS ESTADUAIS MODELO - P1                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
    		Else
	   			If lImp
	   				aL[02]:=STR0065 //"|                                                            LIVRO REGISTRO DE ENTRADAS ESTADUAIS # - P1                                                      |                  (*) CODIGO DE VALORES FISCAIS             |"
	   			Else
			   		aL[02]:=STR0058 //"|                                                            LIVRO REGISTRO DE ENTRADAS ESTADUAIS #                                                           |                  (*) CODIGO DE VALORES FISCAIS             |"
	            Endif
	  		EndIf 
    	ElseIf nSubDiv == 3    
    		
    		If cMV_ESTADO == "SE"
    		  	aL[02]:=STR0074 	//"|                                                     LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS - MODELO P1                                                   |                  (*) CODIGO DE VALORES FISCAIS             |"        
    		Else 
	    		If lImp
	    			aL[02]:=STR0066 //"|                                                         LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS # - P1                                                    |                  (*) CODIGO DE VALORES FISCAIS             |"        
	            Else
			   		aL[02]:=STR0059 //"|                                                         LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS #                                                         |                  (*) CODIGO DE VALORES FISCAIS             |"
	            Endif 
	    	EndIf 
	    	
		Endif
		aL[03]:="|                                                                                                                                                               |------------------------------------------------------------|"
		aL[04]:=STR0004 //"| FIRMA: #############################                                                                                                                        |                                                            |"
		aL[05]:=STR0005 //"|                                                                                                                                                             |1-OPERACOES COM CREDITO DO IMPOSTO                          |" 
		aL[06]:=STR0006 //"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                                    |                                                            |" 
		aL[07]:=STR0007 //"|                                                                                                                                                             |2-OPERACOES SEM CREDITO DO IMPOSTO-ISENTAS OU NAO TRIBUTADAS|" 
		If lLFisOrd
				aL[08]:=STR0078 //"| ORDEM/FOLHA: ###-E / #######     MS OU PERODO/ANO: #######                                                                                                  |                                                            |"
			ElseIf lImpPag
				aL[08]:=STR0077 //"| PGINA: #######                    MS OU PERODO/ANO: #######                                                                                                |                                                            |"
   			Else
				aL[08]:=STR0008 //"| FOLHA: #######                   MS OU PERODO/ANO: #######                                                                                                  |                                                            |"
	 	Endif
		aL[09]:=STR0009 //"|                                                                                                                                                             |3-OPERACOES SEM CREDITO DO IMPOSTO - OUTRAS                 |" 
		aL[10]:="|                                                                                                                                                               |                                                            |"
	Endif
	aL[11]:="|============================================================================================================================================================================================================================|"
	aL[12]:=STR0010//"|        |                    DOCUMENTOS FISCAIS                      |                  |    CODIFICACAO      |        ICMS - VALORES FISCAIS                 |       IPI - VALORES FISCAIS             |                 |"
	aL[13]:="|          |------------------------------------------------------------|                  |---------------------|-----------------------------------------------|-----------------------------------------|                 |"
	aL[14]:=STR0011//"|DATA DE |ESPE |  SERIE  |         |DATA     |                   | UF |                  |              |      |COD|BASE DE CALCULO   |     |    IMPOSTO       |COD|BASE DE CALCULO   |    IMPOSTO       |                 |"
	aL[15]:=STR0012//"|ENTRADA |CIE  |SUB-SERIE| NUMERO  |DOCUMENTO| CODIGO DO EMITENTE|ORIG| VALOR CONTABIL   |   CONTABIL   |FISCAL|(*)|VL. DA OPERACAO   |ALIQ.|   CREDITADO      |(*)|VL. DA OPERACAO   |   CREDITADO      | OBSERVACOES     |"
	aL[16]:="|==========|=====+=========+=========+==========+==================+====|==================|==============+======|===+==================+=====+==================|===+==================+==================|=================|"
    aL[17]:="|##########|#####|   ###   |#########|##########|##################| ## |##################|##############|######| # |##################|#####|##################| # |##################|##################|#################|"
    aL[18]:="|# # # #   |# #####################################################| ## |##################|##############|######| # |##################|#####|##################| # |##################|##################|#################|"
Else                                                                                                                                                                                                
	aL:=Array(20)
	aL[01]:="+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	If nSubDiv == 1 
	
		//Ŀ
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      
		// 
  		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0072 	//"|                                                                                             REGISTRO DE SAIDAS MODELO - P2                                                                                               |"
    	Else
			If lImp
	    	    aL[02]:=STR0067 //"|                                                                                                     REGISTRO DE SAIDAS # - P2                                                                                            |"
	  		Else
		  		aL[02]:=STR0013 //"|                                                                                                     REGISTRO DE SAIDAS #                                                                                                 |"		
			Endif 
		EndIf
			
	ElseIf nSubDiv == 2           
	
		//Ŀ
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      
		//
		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0075 	//"|                                                                                        LIVRO REGISTRO DE SAIDAS ESTADUAIS - MODELO P2                                                                                    |"
    	Else
			If lImp
				aL[02]:=STR0068 //"|                                                                                             LIVRO REGISTRO DE SAIDAS ESTADUAIS # - P2                                                                                    |"
	        Else
		  		aL[02]:=STR0061 //"|                                                                                             LIVRO REGISTRO DE SAIDAS ESTADUAIS #                                                                                         |"		
		    Endif 
		EndIf 
		
	ElseIf nSubDiv == 3       
	    
		//Ŀ
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      
		//
		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0076 	//"|                                                                                       LIVRO REGISTRO DE SAIDAS INTERESTADUAIS - MODELO P2                                                                                |"
    	Else
			If lImp
				aL[02]:=STR0069 //"|                                                                                           LIVRO REGISTRO DE SAIDAS INTERESTADUAIS # - P2                                                                                 |"
			Else
		  		aL[02]:=STR0062 //"|                                                                                           LIVRO REGISTRO DE SAIDAS INTERESTADUAIS #                                                                                      |"				
		    Endif   
		EndIf    
		
	Endif
	aL[03]:="|                                                                                                                                                                                                                            |"
	aL[04]:=STR0014 //"| FIRMA: #########################                                                                                                                                                                                         |"
	aL[05]:="|                                                                                                                                                                                                                            |"
	aL[06]:=STR0015 //"| INSC.EST: #########             C.N.P.J.: ##############                                                                                                                                                                 |"
	aL[07]:="|                                                                                                                                                                                                                            |"
	If lLFisOrd
			aL[08]:=STR0060 //"| ORDEM/FOLHA: ###-E / #######     MS OU PERODO/ANO: #######                                                                                                  |                                                            |"
		ElseIf lImpPag
			aL[08]:=STR0070 //"| PGINA: #######                    MS OU PERODO/ANO: #######                                                                                                                                                             |"
   		Else
		  	aL[08]:=STR0016 //"| FOLHA: #######                   MS OU PERODO/ANO: #######                                                                                                                                                               |"
 	Endif
	aL[09]:="|                                                                                                                                                                                                                            |"
	aL[10]:="|                                                                                                                                                                                                                            |"
	aL[11]:="|============================================================================================================================================================================================================================|"
	aL[12]:="|             DOCUMENTOS FISCAIS                      |                  |       CODIFICAO         |                                      VALORES FISCAIS                                 |                                |"  //STR0017 //"|            DOCUMENTOS FISCAIS                  |                  |      CODIFICACAO        |                                      VALORES FISCAIS                                 |                                     |"
	aL[13]:="|-----------------------------------------------------|                  |---------------------------|--------------------------------------------------------------------------------------|                                |"  //STR0018 //"|------------------------------------------------|                  |-------------------------|--------------------------------------------------------------------------------------|                                     |"
	aL[14]:="|     |         |                            |   |    |                  |                    |      |    |     OPERAES COM DBITO DO IMPOSTO       |  OPERAES SEM DBITO DO IMPOSTO    |                                |"  //STR0019 //"|     |     |                           |   |    |                  |                  |      |    |      OPERACOES COM DEBITO DO IMPOSTO      |   OPERACOES SEM DEBITO DO IMPOSTO   |                                     |"
	aL[15]:="|     |         |                            |   |    |                  |                    |      |ICMS|-------------------------------------------|-------------------------------------|                                |"  //STR0020 //"|     |SERIE|                           |   |    |                  |                  |      |ICMS|-------------------------------------------|-------------------------------------|                                     |"
	aL[16]:="|ESP |  SRIE  |                            |   | UF |     VALOR        |                    |      |    |    BASE DE       |     |    IMPOSTO       |   ISENTAS OU     |                  |                                |"  //STR0021 //"|ESPE | SUB-|                           |   | UF |      VALOR       |                  |      |    |     BASE DE      |     |     IMPOSTO      |    ISENTAS OU    |                  |                                     |"
	aL[17]:="|CIE  |SUB-SRIE|           NMERO           |DIA|DEST|    CONTBIL      |   CONTBIL         |FISCAL|IPI |    CALCULO       |ALIQ |    DBITADO      | NO TRIBUTADAS   |      OUTRAS      |          OBSERVAES           |"  //STR0022 //"|CIE  |SERIE|          NUMERO           |DIA|DEST|     CONTABIL     |   CONTABIL       |FISCAL|IPI |     CALCULO      |ALIQ |     DEBITADO     |  NAO TRIBUTADAS  |      OUTRAS      |          OBSERVACOES                |"
	aL[18]:="|=====+=========+============================+===+====|==================|====================+======|====+==================+=====+==================|==================+==================|================================|"
	aL[19]:="|#####| ###     |############################| ##| ## |##################|####################| #### |####|##################|#####|##################|##################|##################|################################|"
	aL[20]:="|# #  |         |############################| ##| ## |##################|####################| #### |####|##################|#####|##################|##################|##################|################################|"
Endif

Return

/*


Ŀ
Funo     R931TranspAutor  Juan Jose Pereira      Data  18.12.96 
Ĵ
Descrio  Imprime linhas de transporte                               
ٱ


*/
STATIC FUNCTION R931Transp(lTotal,aTamTransp)
Local nTamTransp  := 0
Local lF3_VLINCMG  := lF3_VLINCMG

Default aTamTransp  := LivrArrayObs(nLargObs,aTransp,,,lObsFecp)

//Pego o tamanho da Observao do aTransportar + 2 linhas que sero impressas nessa funo caso seja Entrada ou 4 linhas caso seja Saida + 3 linhas se imprimir Linhas sem valor
Default lTotal	:=	.F.

nTamTransp  := Len(aTamTransp)+7+If(lImpZer,3,0)

nMaior:=0
AEval(aTamNotas,{|x|nMaior:=Max(nMaior,x)})
aTamNotas[2]:=nMaior
nLinNec:=aTamNotas[2]

//Se o tamanho da pagina for igual a linha + o tamanho do aTransportar devo imprimir o Transportar
lTransp:=(nLimPag <= (nLin+nTamTransp))//Tamanho da pag. = numero da linha + tamanho a transpotar Ex: 58 = 40 + 18	

//Se estou chamando a funo R931Transp atravs de algum Totalizador posso imprimir pois a validao de tamanho j foi feita na funo do Totalizador
If lTotal
	lTransp:= .T.
EndIf


If lTransp
	nTamTransp:=nLin

	If nTipoMov==1

		aObs:= aTamTransp//LivrArrayObs(nLargObs,aTransp,,,lObsFecp)

		R931IniGrade()

		aGrade[1,1]:="1"
		aGrade[1,2]:=aTransp[ColF3("F3_BASEICM")]
		aGrade[1,3]:=aTransp[ColF3("F3_VALICM")]
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
		aGrade[nx,1]:="2"
		aGrade[nx,2]:=aTransp[ColF3("F3_ISENICM")]
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
		aGrade[nx,1]:="3"
		
		If aTransp[ColF3("F3_OUTRICM")]>0		
	    	aGrade[nx,2]:=aTransp[ColF3("F3_OUTRICM")]
		Endif  	
		If lF3_VLINCMG
		    If !Empty(aTransp[ColF3("F3_VLINCMG")])
		        aGrade[nx,2] += aTransp[ColF3("F3_VLINCMG")]
		    EndIf
		EndIf
		
		aGrade[1,4]:="1"
		aGrade[1,5]:=aTransp[ColF3("F3_BASEIPI")]
		aGrade[1,6]:=aTransp[ColF3("F3_VALIPI")]
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
		aGrade[nx,4]:="2"
		aGrade[nx,5]:=aTransp[ColF3("F3_ISENIPI")]
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
		aGrade[nx,4]:="3"
		aGrade[nx,5]:=aTransp[ColF3("F3_OUTRIPI")]

		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0023 //"A TRANSPORTAR"
		aDados[8]:=aTransp[ColF3("F3_VALCONT")]

		//Ŀ
		// Imprime Linhas de detalhe              
		//
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
            If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//Ŀ
		// Para atender legislacao Fomentar de GO 
		//
		If !Empty(cTitLivro) .and. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1 
				aDados[18]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
                Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0 .And. aTransp[ColF3("F3_CREDST")] <> '4'
			aDados[11]:="ST"
			aDados[12]:=aTransp[ColF3("F3_BASERET")]
			aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Endif
		nLinNec:=nLin-nTamTransp+If(lImpZer,1,0)
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R931Filler()
	   R931Cabec()
	Else

		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		aObs:= aTamTransp //LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0023 //"A TRANSPORTAR"
		aDados[6]:=aTransp[ColF3("F3_VALCONT")]
		aDados[9]:="ICMS"
		aDados[10]:=aTransp[ColF3("F3_BASEICM")]
		aDados[12]:=aTransp[ColF3("F3_VALICM")]
		aDados[13]:=aTransp[ColF3("F3_ISENICM")]
		aDados[14]:=aTransp[ColF3("F3_OUTRICM")]
   	    If lF3_VLINCMG
		    If !Empty(aTransp[ColF3("F3_VLINCMG")]) 
	            aDados[14] += aTransp[ColF3("F3_VLINCMG")]
	        EndIf
	    EndIf
		
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		aDados[9]:="IPI"
		aDados[10]:=aTransp[ColF3("F3_BASEIPI")]
		aDados[12]:=aTransp[ColF3("F3_VALIPI")]
		aDados[13]:=aTransp[ColF3("F3_ISENIPI")]
		aDados[14]:=aTransp[ColF3("F3_OUTRIPI")]
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
 		//Ŀ
		// Atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro) .and. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO <> "D"
				   aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0 .And. aTransp[ColF3("F3_CREDST")] <> '4'
			aDados[9]:="ST"
			aDados[10]:=aTransp[ColF3("F3_BASERET")]
			aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif

		nLinNec:=nLin-nTamTransp+If(lImpZer,1,0)
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R931Filler()
	    R931Cabec()
	Endif
Endif

Return
/*


Ŀ
Funo     R931TotdiaAutor  Juan Jose Pereira      Data  18.12.96 
Ĵ
Descrio  Imprime total do dia                                       
ٱ


*/
STATIC FUNCTION R931TotDia
Local nX := 0
Local nLinDia   	:= 0
Local nLinTrans 	:= 0
Local aLinDia   	:= {}
Local aLinTrans 	:= {}
Local lP1IcmST		:= aSX6[MV_P1ICMST]
Local lF3_VLINCMG  	:= lF3_VLINCMG
lTotDia:=(dDiaAnt!=dDia)

				
If (lTotDia .And. !Empty(dDia)) .Or. Eof()
	
	aLinDia   	:= LivrArrayObs(nLargObs,aTotDia,,,lObsFecp)
	aLinTrans 	:= LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
	
	nLinDia   	:= Len(aLinDia)+If(nTipoMov==1,3,5)+If(lImpZer,3,0)
	nLinTrans 	:= Len(aLinTrans)+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//Observaes + Tam. Max. das linhas impressas a transportar  2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor

	aTamNotas[3]:=Max(aTamNotas[3],If(nLin>=nLimPag,nLinNec+(nLin-nLimPag),nLinNec))
	nLinNec:=aTamNotas[3]
    
    //Se o tamanho da pagina for menor que as linhas do Totalizador do dia + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do dia.
    If nLimPag<nLin+nLinDia+nLinTrans
		R931Transp(.T., aLinTrans)
	Endif

	nTamTotDia:=nLin
	

	If nTipoMov==1

		aObs:=aLinDia//LivrArrayObs(nLargObs,aTotDia,,,lObsFecp)

		R931IniGrade()
	
		If lImpZer.Or.(aTotDia[ColF3("F3_BASEICM")]>0.Or.aTotDia[ColF3("F3_VALICM")]>0)
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_BASEICM")] ==0
			    aGrade[1,1]:=""
		    Else 
			    aGrade[1,1]:="1"
		    	aGrade[1,2]:=aTotDia[ColF3("F3_BASEICM")]
		    	aGrade[1,3]:=aTotDia[ColF3("F3_VALICM")]
		    EndIf
		Else                                                                      
			aGrade[1,1]:=""
		Endif
		If lImpZer.Or.(aTotDia[ColF3("F3_ISENICM")]>0)
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENICM")]==0
			    aGrade[nx,1]:=""
		    Else 
				aGrade[nx,1]:="2"
				aGrade[nx,2]:=aTotDia[ColF3("F3_ISENICM")]
            EndIf
		Endif
		
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
		
		If lImpZer.Or.aTotDia[ColF3("F3_OUTRICM")]>0	
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_OUTRICM")]==0
			    aGrade[nx,1]:=""
		    Else 
				aGrade[nx,1]:="3"
			    If aTotDia[ColF3("F3_OUTRICM")]>0
				    aGrade[nx,2]:=aTotDia[ColF3("F3_OUTRICM")] 
	           EndIf
		    Endif
		Endif		
		If lImpZer.Or.aTotDia[ColF3("F3_VLINCMG")]>0
			If lF3_VLINCMG
				aGrade[nx,1]:="3"
			    If aTotDia[ColF3("F3_VLINCMG")]>0
			       aGrade[nx,2] += aTotDia[ColF3("F3_VLINCMG")]
			    Endif
			EndIf			
		Endif
		
		If lImpZer.Or.(aTotDia[ColF3("F3_BASEIPI")]>0.Or.aTotDia[ColF3("F3_VALIPI")]>0)
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_BASEIPI")]==0
			    aGrade[1,4]:=""
			Else
				aGrade[1,4]:="1"
				aGrade[1,5]:=aTotDia[ColF3("F3_BASEIPI")]
				aGrade[1,6]:=aTotDia[ColF3("F3_VALIPI")]
            EndIf
		Else
			aGrade[1,4]:=""
		Endif
		If lImpZer.Or.aTotDia[ColF3("F3_ISENIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENIPI")]==0
			    aGrade[nx,4]:=""
			Else
				aGrade[nx,4]:="2"
				aGrade[nx,5]:=aTotDia[ColF3("F3_ISENIPI")]
            EndIf
		Endif
		If lImpZer.Or.aTotDia[ColF3("F3_OUTRIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_OUTRIPI")]==0
			    aGrade[nx,4]:=""
			Else
    			aGrade[nx,4]:="3"
	    		aGrade[nx,5]:=aTotDia[ColF3("F3_OUTRIPI")]
		    EndIf
		Endif

		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0024+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "
		aDados[8]:=aTotDia[ColF3("F3_VALCONT")]

		//Ŀ
		// Imprime Linhas de detalhe              
		//
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//Ŀ
		// Para atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro) .and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14] := aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14] := aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
				Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
				aDados[12]:=aTotDia[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[14]:= aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[12]:=aTotDia[ColF3("F3_BASERET")]
				aDados[14]:= aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
		nLinNec:=nLin-nTamTotDia+If(lImpZer,1,0)
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Else
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		aObs:= aLinDia//LivrArrayObs(nLargObs,aTotDia,,,lObsFecp)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0024+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "

		If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENICM")]==0 .And. aTotDia[ColF3("F3_OUTRICM")]==0
		    aDados[9]:=""
		Else
			aDados[6]:=aTotDia[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotDia[ColF3("F3_BASEICM")]
			aDados[12]:=aTotDia[ColF3("F3_VALICM")]
			aDados[13]:=aTotDia[ColF3("F3_ISENICM")]
			aDados[14]:=aTotDia[ColF3("F3_OUTRICM")] 

			If lF3_VLINCMG
			    If !Empty(aTotDia[ColF3("F3_VLINCMG")])
			        aDados[14] += aTotDia[ColF3("F3_VLINCMG")]		
			    EndIf
			EndIf
        EndIf

		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENIPI")]==0 .And. aTotDia[ColF3("F3_OUTRIPI")]==0
    		aDados[9]:=""
		Else
			aDados[9]:="IPI"
			aDados[10]:=aTotDia[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotDia[ColF3("F3_VALIPI")]
			aDados[13]:=aTotDia[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotDia[ColF3("F3_OUTRIPI")]
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
 		//Ŀ
		// Atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro).and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO <> "D"
				   aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
				aDados[10]:=aTotDia[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[10]:=aTotDia[ColF3("F3_BASERET")]
				aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
		nLinNec:=nLin-nTamTotDia+If(lImpZer,1,0)
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Endif
Endif
If lTotDia
	For nX := 1 to Len(aTotDia)
	Do Case
		Case ValType(aTotDia[nX]) == "C"
			aTotDia[nX] := ""
		Case ValType(aTotDia[nX]) == "N"
			aTotDia[nX] := 0
		OtherWise
			aTotDia[nX] := Nil				
		End Case
	Next nX		
Endif

Return
/*


Ŀ
Funo     R931TotMesAutor  Juan Jose Pereira      Data  18.12.96 
Ĵ
Descrio  Imprime total do Mes                                       
ٱ


*/
STATIC FUNCTION R931TotMes
Local xx 		:= 1
Local nPosicao 	:= 0                                                                            
Local nProcFil	:= mv_par31
Local nRecBrutA	:= 0
Local nRecBrutM	:= 0
Local nPercent	:= aSX6[MV_PERCRJ] // Percentual Aliquota Simples RJ
Local nTaxa		:= mv_par35
Local cFilDe	:= mv_par32
Local cFilAte	:= mv_par33        
Local aArea		:= GetArea()
Local aAreaSm0 	:= SM0->(GetArea())
Local aICMSDev	:= {}
Local nLinMes   := 0
Local nLinTrans := 0
Local aLinMes   := {}
Local aLinTrans := {}
Local lP1IcmST		:= aSX6[MV_P1ICMST]

//Ŀ
//Verifica se o processamento e centralizado, imprimindo mais de uma filial
//
If nProcFil <> 1
	cFilDe 	:= cFilAnt
	cFilAte	:= cFilAnt
Endif      

MATR930Fil(cEmpAnt+cFilDe) //SM0->(MSSeek(cEmpAnt+cFilDe,.T.))

//********************* CIAP **********************
If lEmiteCiap
   nPosicao := ColF3("F3_VALICM") //Ascan((cArqTemp)->(dbstruct()),{ |x| ( "F3_VALICM" $ x[1] ) })   
   if nTipoMov==1 .and. lTotMes
      If nLin>=nLimPag.and.lImpMes
		 R931Transp()
	  Endif
	
	  dData := LastDay(MV_PAR01)
	  SFA->(dbSetOrder(2))
	  
      //Ŀ
      //Imprime atraves das filiais selecionadas para o processamento
      //
      Do While !SM0->(Eof()) .And. SM0->M0_CODIGO+SM0->M0_CODFIL <= cEmpAnt+cFilAte

  	     cFilAnt	:= SM0->M0_CODFIL

	     If SFA->(MSSeek(xFilial("SFA")+dTos( dData )))
		    While SFA->(!EOF()) .and. SFA->FA_FILIAL == xFilial("SFA") .and. Dtos(SFA->FA_DATA)== dTos(ddata)
			   If ( SFA->FA_TIPO == "1" ) .and. (SFA->FA_CREDIT =="1")  			      
				  cMensagem:=Trim("Credito ICMS Ativo")+If(lColCiap,PADL(Transform(SFA->FA_VALOR,"@E 9,999,999.99"),21),"")
				  For xx:=1 to MlCount(cMensagem,nLargObs)
					  AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
				  Next xx
						
				  SF9->(MSSeek(xFilial()+SFA->FA_CODIGO))
				  R931IniGrade()
				  aGrade[1,1]:="1"
                  If !lColCiap
				     aGrade[1,3]:=SFA->FA_VALOR
				  Endif
				  nCredAtivo  +=SFA->FA_VALOR
				  
				  aDados:=Array(18)				

    		      If nLin>=nLimPag
			         R931Filler()
			         R931Cabec()
		          Endif
				  
				  FmtLin(@aDados,aL[18],,,@nLin)
                  aDados[10]	:= SF9->F9_CFOENT
				  R931ImpGrade()
				  nPosObs:=Ascan(aObs,{|x|x[2]})
				  While nPosObs>0
					    R931LoadObs()
					    If nPosObs>0
						   FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					    Endif
				  Enddo
			   EndIf				
			   SFA->(dBSkip())
		    EndDo
		Endif
		SM0->(dbSkip())	     
      Enddo
	  aTotMes[nPosicao] +=nCredAtivo
   EndIf
Endif   
//******************* CIAP FIM *********************

If lTotMes .and. lImpMes
	aLinMes   := LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)
	aLinTrans := LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
	
	nLinMes   := Len(aLinMes)+3+If(lImpZer,3,0)//Observaes + Tam. Max. da totalizacao do mes 3 + 3 linhas caso imprima linhas sem valor
	nLinTrans := Len(aLinTrans)+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//Observaes + Tam. Max. das linhas impressas a transportar  2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor

	//Se o tamanho da pagina for menor que as linhas do Totalizador Mensal + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador Mensal.
    If nLimPag<nLin+nLinMes+nLinTrans
		R931Transp(.T., aLinTrans)
	Endif

	If nTipoMov==1

		//Ŀ
		// Tam. Max. da totalizacao do mes - 3    
		//
		If (nLin+3)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		aObs:=aLinMes 

		R931IniGrade()
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_BASEICM")]==0
			aGrade[1,1]:=""
        Else 
			aGrade[1,1]:="1"
 			aGrade[1,2]:=aTotMes[ColF3("F3_BASEICM")]
			aGrade[1,3]:=aTotMes[ColF3("F3_VALICM")]
        EndIf	
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
        
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_ISENICM")]==0
			aGrade[nx,1]:=""
        Else
			aGrade[nx,1]:="2"
			aGrade[nx,2]:=aTotMes[ColF3("F3_ISENICM")]
		EndIf	
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
        
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_OUTRICM")]==0
			aGrade[nx,1]:=""
        Else
			aGrade[nx,1]:="3"
           If aTotMes[ColF3("F3_OUTRICM")]>0
			   aGrade[nx,2]:=aTotMes[ColF3("F3_OUTRICM")]
           EndIf
		EndIf
		If lF3_VLINCMG
			aGrade[nx,1]:="3"
		   If !Empty(aTotMes[ColF3("F3_VLINCMG")])
		      aGrade[nx,2] += aTotMes[ColF3("F3_VLINCMG")]		 
			EndIf
		EndIf
        
		If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_BASEIPI")]==0 .And. aTotMes[ColF3("F3_OUTRIPI")]==0
			aGrade[1,4]:=""
   		Else
			aGrade[1,4]:="1"
			aGrade[1,5]:=aTotMes[ColF3("F3_BASEIPI")]
			aGrade[1,6]:=aTotMes[ColF3("F3_VALIPI")]
        EndIf	
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
        
       	If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_ISENIPI")]==0 .And. aTotMes[ColF3("F3_OUTRIPI")]==0
			aGrade[nx,4]:=""
		Else	
			aGrade[nx,4]:="2"
			aGrade[nx,5]:=aTotMes[ColF3("F3_ISENIPI")]
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			aGrade[nx,4]:="3"
			aGrade[nx,5]:=aTotMes[ColF3("F3_OUTRIPI")]
	    EndIf
		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0025 //"TOTAL DO MES"
		aDados[8]:=aTotMes[ColF3("F3_VALCONT")]
   
		If nTipoMov==5
			If Alltrim(cMV_ESTADO) == "SP"
				//Ŀ
				//Quando optante pelo Simples Paulista, o registro de entradas deve mostrar as operacoes de saida
				//
	 	 		cMensagem := "Valor Total Operacoes Sadas " + Transform(CalcRecBru(FirstDay(dDiaAnt),LastDay(dDiaAnt)),"@E 9,999,999.99")
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx
			Endif
        Endif
		//Ŀ
		// Imprime Linhas de detalhe              
		//
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//Ŀ
		// Para atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotMes[ColF3("F3_BASERET")]
			if nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:= aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14]:= aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
                Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			EndIf
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
				aDados[12]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[12]:=aTotMes[ColF3("F3_BASERET")]
				aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		If (nLin+3)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		aObs:=aLinMes //LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0025 //"TOTAL DO MES"
		If aTotMes[ColF3("F3_ALIQICM")]+aTotMes[ColF3("F3_BASEICM")]+aTotMes[ColF3("F3_VALICM")]+aTotMes[ColF3("F3_ISENICM")]+aTotMes[ColF3("F3_OUTRICM")] ==0
		    aDados[9]:=""
		Else
			aDados[6]:=aTotMes[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotMes[ColF3("F3_BASEICM")]
			aDados[12]:=aTotMes[ColF3("F3_VALICM")]
			aDados[13]:=aTotMes[ColF3("F3_ISENICM")]
			aDados[14]:=aTotMes[ColF3("F3_OUTRICM")]

			If lF3_VLINCMG
			    If !Empty(aTotMes[ColF3("F3_VLINCMG")])
			       aDados[14] += aTotMes[ColF3("F3_VLINCMG")]
			    EndIf
			EndIf
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		If aTotMes[ColF3("F3_ALIQICM")]==0 
		    aDados[9]:=""
		Else
			aDados[9]:="IPI"
			aDados[10]:=aTotMes[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotMes[ColF3("F3_VALIPI")]
			aDados[13]:=aTotMes[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotMes[ColF3("F3_OUTRIPI")]
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

 		If nModelo == 5
 			If Alltrim(cMV_ESTADO) == "RJ"				
				//Ŀ
				//Quando optante pelo Simples RJ, o registro de sadas deve mostrar a Receita Bruta e o ICMS Dev.
				//
	 	 		dDtRecIni	:= Ctod("01/01/"+ Str(Year(dDtIni)-1,4))
				dDtRecFim	:= Ctod("31/12/"+ Str(Year(dDtIni)-1,4))
	
	 	 		nRecBrutA 	:= CalcRBruta(dDtRecIni, dDtRecFim)     
				nRecBrutM	:= CalcRBruta(dDtIni, dDtFim)       
				aICMSDev	:= CalcImpost(nRecBrutA, nRecBrutM, nTaxa)
	
	 	 		cMensagem := STR0046 + Transform((nRecBrutM),"@E 9,999,999.99") //"Receita Bruta do perodo .... R$ "
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx        
				
				If (aICMSDev[1][3])$("Regime Simplificado Especial")
					cMensagem := STR0047 + Alltrim(Str(nPercent))+ STR0048 + Transform((aICMSDev[1][1]),"@E 9,999,999.99") //"ICMS devido (" # "%)............. R$ "
				Else	
					cMensagem := STR0049 + Transform((aICMSDev[1][1]),"@E 9,999,999.99") //"ICMS devido ................. R$ "      
		  		Endif
		  		
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx  
			Endif
        Endif
 		
		//Ŀ
		// Imprime Linhas de detalhe              
		//
		R931ImpGrade()
		
 		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
 		
 		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		
 		//Ŀ
		// Atender legislacao Fomentar de GO 
		//
		If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotMes[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
			    If F3_TIPO <> "D"
				   aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			    Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
				aDados[10]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[10]:=aTotMes[ColF3("F3_BASERET")]
				aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
	Endif
Else
	If lTotMes
		R931Filler()
	Endif
Endif
If lTotMes
   R931Filler()
	For xx := 1 to Len(aTransp)
		If ValType(aTransp[xx]) == "N"
			aTransp[xx] := 0
		Else
			aTransp[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTotMes)
		If ValType(aTotMes[xx]) == "N"
			aTotMes[xx] := 0
		Else
			aTotMes[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTamNotas)
		If ValType(aTamNotas[xx]) == "N"
			aTamNotas[xx] := 0
		Else
			aTamNotas[xx] := "NULL"
		Endif
	Next
Endif

//Ŀ
//Restaura a filial e area corrente 
//
RestArea(aAreaSm0)
cFilAnt	:= SM0->M0_CODFIL
RestArea(aArea)

Return
/*


Ŀ
Funo     R931TotPerAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Imprime total do periodo de apuracao                       
ٱ


*/
STATIC FUNCTION R931TotPer
Local nCntFor :=1
Local nLinICM   := 0
Local nLinIPI   := 0
Local nLinTrans := 0
Local aLinICM   := {}
Local aLinIPI   := {}
Local aLinTrans := {}
Local lP1IcmST	:= aSX6[MV_P1ICMST]
nLinNec2:=0


If lTotPerICM
	aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[4]
Endif
If lTotPerIPI
	aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[5]
Endif

If lTotPerICM.or.lTotPerIPI
	nLinNec:=nLinNec2
	
	aLinTrans := LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
	nLinTrans := Len(aLinTrans)+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//Observaes + Tam. Max. das linhas impressas a transportar  2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor	
	
	//Se o tamanho da pagina for menor que as linhas do Totalizador do ICM + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do ICM.
    If lTotPerICM
		aLinICM	  := LivrArrayObs(nLargObs,aTotPerIcm,,,lObsFecp)
		nLinICM   := Len(aLinICM)+If(nTipoMov==1,3,3)+If(lImpZer,3,0)
	    If nLimPag<nLin+nLinICM+nLinTrans
			R931Transp(.T., aLinTrans)
		Endif
	EndIf
	//Se o tamanho da pagina for menor que as linhas do Totalizador do IPI + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do IPI.
	If lTotPerIPI
		aLinIPI	  := LivrArrayObs(nLargObs,aTotPerIPI,,,lObsFecp)
		nLinIPI   := Len(aLinIPI)+If(nTipoMov==1,2,2)+If(lImpZer,3,0)
	    If nLimPag<nLin+nLinIPI+nLinTrans
			R931Transp(.T. , aLinTrans)
		Endif
	EndIf

	If nTipoMov==1
		aObs:={}

		R931IniGrade()

		If lTotPerIcm
			aObs := aLinICM//LivrArrayObs(nLargObs,aTotPerIcm,,,lObsFecp)
			If (aTotPerIcm[ColF3("F3_BASEICM")]>0.Or.aTotPerIcm[ColF3("F3_VALICM")]>0)
				aGrade[1,1]:="1"
				aGrade[1,2]:=aTotPerIcm[ColF3("F3_BASEICM")]
				aGrade[1,3]:=aTotPerIcm[ColF3("F3_VALICM")]
			Else
				aGrade[1,1]:=If(!lImpZer,"","1")
			Endif

			If aTotPerIcm[ColF3("F3_ISENICM")]>0
				nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
				aGrade[1,1]:="2"
				aGrade[1,2]:=aTotPerIcm[ColF3("F3_ISENICM")]
			Endif

			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
			
			If aTotPerIcm[ColF3("F3_OUTRICM")]>0
				aGrade[1,1]:="3"
				aGrade[1,2]:=aTotPerIcm[ColF3("F3_OUTRICM")]
			Endif
			If lF3_VLINCMG
				aGrade[1,1]:="3"
				If aTotPerIcm[ColF3("F3_VLINCMG")]>0
					aGrade[1,2] += aTotPerIcm[ColF3("F3_VLINCMG")]
				EndIf
			EndIf

		Endif

		If lTotPerIPI
			If (aTotPerIPI[ColF3("F3_BASEIPI")]>0 .Or.aTotPerIPI[ColF3("F3_VALIPI")]>0)
				aGrade[1,4]:="1"
				aGrade[1,5]:=aTotPerIPI[ColF3("F3_BASEIPI")]
				aGrade[1,6]:=aTotPerIPI[ColF3("F3_VALIPI")]
			Else
				aGrade[1,4]:=If(!lImpZer,"","1")
			Endif

			If aTotPerIPI[ColF3("F3_ISENIPI")]>0
				nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
				aGrade[1,4]:="2"
				aGrade[1,5]:=aTotPerIPI[ColF3("F3_ISENIPI")]
			Endif

			If aTotPerIPI[ColF3("F3_OUTRIPI")]>0
				nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
				aGrade[1,4]:="3"
				aGrade[1,5]:=aTotPerIPI[ColF3("F3_OUTRIPI")]
			Endif

		Endif

		aDados:=Array(18)

		If lTotPerICM .Or. lTotPerIPI
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=STR0026 //"TOTAL DO PERIODO "
			If lTotPerIcm
				aDados[8]:=aTotPerICM[ColF3("F3_VALCONT")]
			Endif
			If lTotPerIPI
				aDados[8]:=aTotPerIPI[ColF3("F3_VALCONT")]
			Endif
			//Ŀ
			// Imprime Linhas de detalhe              
			//
			R931ImpGrade()

			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0
					FmtLin(@aDados,aL[18],cPictVl,,@nLin)
				Endif
			End
		Endif

		aDados:=Array(18)

		nTamTotPer:=nLin
		//Ŀ
		// Para atender legislacao Fomentar de GO
		//
		If lTotPerICM
			If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ST"
				aDados[12]:=aTotMes[ColF3("F3_BASERET")]
				if nColuna == 1
					aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
					If F3_TIPO == "D"
					   aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
					Else
					   aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
					Endif   
				endif
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ST"
				If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
					aDados[12]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
					aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
				Else
					aDados[12]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
					aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				Endif
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		Endif
		If lTotPerICM
			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
		If lTotPerIPI
			nLinNec:=nLin-nTamTotPer
			aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		nTamTotPer:=nLin
		aObs:={}
		aDados:=Array(15)
		aDados[3]:=STR0027 //"TOTAL DO PERIODO"
		If lTotPerICM
			aObs:= aLinICM//LivrArrayObs(nLargObs,aTotPerICM,,,lObsFecp)
			aDados[6]:=aTotPerICM[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotPerICM[ColF3("F3_BASEICM")]
			aDados[12]:=aTotPerICM[ColF3("F3_VALICM")]
			aDados[13]:=aTotPerICM[ColF3("F3_ISENICM")]
			aDados[14]:=aTotPerICM[ColF3("F3_OUTRICM")]

			If lF3_VLINCMG
			    If !Empty(aTotPerICM[ColF3("F3_VLINCMG")])
			        aDados[14] += aTotPerICM[ColF3("F3_VLINCMG")]
			    EndIf           
			EndIf
			R931LoadObs()
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		If lTotPerIPI
			aDados[6]:=aTotPerIPI[ColF3("F3_VALCONT")]
			aDados[9]:="IPI"
			aDados[10]:=aTotPerIPI[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotPerIPI[ColF3("F3_VALIPI")]
			aDados[13]:=aTotPerIPI[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotPerIPI[ColF3("F3_OUTRIPI")]
			R931LoadObs()
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		If lTotPerICM
			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0
					FmtLin(@aDados,aL[20],cPictVl,,@nLin)
				Endif
			End
		Endif
 		//Ŀ
		// Atender legislacao Fomentar de GO
		//
		If lTotPerICM
			If !Empty(cTitLivro) .And. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[9]:="ST"
				aDados[10]:=aTotPerICM[ColF3("F3_BASERET")]
				if nColuna == 1
					aDados[15]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
                    If F3_TIPO <> "D"
				  	   aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
                    Else
					   aDados[15]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
					Endif   
				Endif
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[9]:="ST"
				If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
					aDados[10]:=aTotPerICM[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
					aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
				Else
					aDados[10]:=aTotPerICM[ColF3("F3_BASERET")]
					aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				Endif
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		EndIf
		FmtLin(@aDados,aL[20],,,@nLin)
		If lTotPerICM
			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
		If lTotPerIPI
			nLinNec:=nLin-nTamTotPer
			aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
		Endif
	Endif
	If lTotPerICM.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerICM)
			If ValType(aTransp[nCntFor]) == "N"
				aTotPerICM[nCntFor] := 0
			Else
				aTotPerICM[nCntFor] := "NULL"
			Endif
		Next
		nSvApurICM:=DefPeriodo(dDia,nApurICM)
	Endif
	If lTotPerIPI.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerIPI)
			If ValType(aTotPerIPI[nCntFor]) == "N"
				aTotPerIPI[nCntFor] := 0
			Else
				aTotPerIPI[nCntFor] := "NULL"
			Endif
		Next
		nSvApurIPI:=DefPeriodo(dDia,nApurIPI)
	Endif
Endif
Return
/*


Ŀ
Funo     R931ResCfoAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Resumo por CFO                                             
ٱ


*/
STATIC FUNCTION R931ResCfo

Local i :=0
Local nPosCFOZer := 0

//Ŀ
// Ordena CFOs
//
aResCFO := Asort(aResCFO,,,{|x,y|x[ColF3("F3_CFO")]<y[ColF3("F3_CFO")]})

If Len(aResCFO)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)
	Return
Endif

aCFOS:={STR0028,; //"1.00 ENTRADAS DO ESTADO"
		STR0029,; //"2.00 ENTRADAS DE FORA DO ESTADO"
		STR0030,; //"3.00 ENTRADAS DO EXTERIOR"
		"",;
		STR0031,; //"5.00 SAIDAS PARA O ESTADO"
		STR0032,; //"6.00 SAIDAS PARA FORA DO ESTADO"
		STR0033} //"7.00 SAIDAS PARA O EXTERIOR"

cSvCFO:="X"

If nLin<nLimPag
   R931Filler()
Endif   

nLin:=80
For i:=1 to Len(aResCFO)
	If nLin>=nLimPag
        R931Filler()
		R931Cabec()
	EndIf
	
	cCFO:=Trim(aResCFO[i,ColF3("F3_CFO")])
	aObs:=LivrArrayObs(nLargObs,aResCFO[i],,cCFO,lObsFecp)
	
	If nTipoMov==1
		If i==1
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=STR0034 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL DE OPERACAO"
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:="==============================================================="
			FmtLin(@aDados,aL[18],,,@nLin)
		EndIf

		If lImpZer .And. (nLin+4)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		R931IniGrade()
		
		nPosCFOZer := aScan(aResCFOZer, {|x| x[ColF3("F3_CFO")] == aResCFO[i,ColF3("F3_CFO")]})

		If (aResCFO[i,ColF3("F3_BASEICM")] > 0 .Or. aResCFO[i,ColF3("F3_VALICM")] > 0) 
			aGrade[1,1]:="1"
			aGrade[1,2]:=aResCFO[i,ColF3("F3_BASEICM")]
			aGrade[1,3]:=aResCFO[i,ColF3("F3_VALICM")]
		Else
			aGrade[1,1]:=If(!lImpZer,"","1")
						
			If nPosCFOZer > 0 .And. aResCFOZer[nPosCFOZer,ColF3("F3_VALCONT")] > 0
				aGrade[1,7] := aResCFOZer[nPosCFOZer,ColF3("F3_VALCONT")]
			EndIf
		Endif
		
		If aResCFO[i,ColF3("F3_ISENICM")] > 0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
			aGrade[nx,1]:="2"
			aGrade[nx,2]:=aResCFO[i,ColF3("F3_ISENICM")]
		Endif
		
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})  
    	aGrade[nx,1]:="3"
    	
		If aResCFO[i,ColF3("F3_OUTRICM")] > 0
		    aGrade[nx,2]:=aResCFO[i,ColF3("F3_OUTRICM")]
		Endif
		       
		If lF3_VLINCMG
			If aResCFO[i,ColF3("F3_VLINCMG")] > 0
				aGrade[nx,2] += aResCFO[i,ColF3("F3_VLINCMG")]
			Endif
		Endif
		
		// Colunas IPI
		
		If (aResCFO[i,ColF3("F3_BASEIPI")] > 0 .Or. aResCFO[i,ColF3("F3_VALIPI")] > 0)
			aGrade[1,4]:="1"
			aGrade[1,5]:=aResCFO[i,ColF3("F3_BASEIPI")]
			aGrade[1,6]:=aResCFO[i,ColF3("F3_VALIPI")]
		Else
			aGrade[1,4]:=If(!lImpZer,"","1")
		Endif
		
		If aResCFO[i,ColF3("F3_ISENIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			aGrade[nx,4]:="2"
			aGrade[nx,5]:=aResCFO[i,ColF3("F3_ISENIPI")]
		Endif
		
		If aResCFO[i,ColF3("F3_OUTRIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			aGrade[nx,4]:="3"
			aGrade[nx,5]:=aResCFO[i,ColF3("F3_OUTRIPI")]
		Endif

		aDados:=Array(18)
        If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)$"TTT") .And. !Empty (cCfo)
			FmtLin(@aDados,aL[18],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[6]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))
			FmtLin(@aDados,aL[18],,,@nLin)
		Endif

		If (nLin+4)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		If ("TT"$cCFO)
			FmtLin(@aDados,aL[18],,,@nLin)
            aDados[6]:=If(ALLTRIM(cCFO)=="TTT",STR0035,STR0036) //"TOTAL"###"SUB-TOTAL"
		Else
            aDados[10]:=TransForm(cCFO,cPesqCFO)
		Endif
		
		aDados[8]:=aResCFO[i,ColF3("F3_VALCONT")]

		//Ŀ
		// Imprime Linhas de detalhe              
		//
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		EndDo
		
		//Ŀ
		// Para atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aResCFO[i,ColF3("F3_BASERET")]
			if nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
			    If F3_TIPO == "D"
				   aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			    Else
				   aDados[18]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
	Else
       //Ŀ
       //Controla a impressao de CFO's de Saida.
       //
	    If Val(Substr(cCFO,1,1))<5 .AND. !(ALLTRIM(cCFO)=="TTT")
	       Loop
	    Endif                      
		If i==1
			If mv_par27 == 1 .And. nTotIcmDeb > 0
				FmtLin(@aDados,aL[20],,,@nLin)
				aDados[15]:= STR0042+Transform(nTotIcmDeb,cPesqICMRET) //"ICMS A SER DEBITADO: "
				FmtLin(@aDados,aL[20],,,@nLin)
			Endif

			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=STR0034 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL DE OPERACAO"
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:="==============================================================="
			FmtLin(@aDados,aL[20],,,@nLin)
		EndIf
		//Ŀ
		// Cria Array com mensagens a serem impressas na coluna de Observacao
		//
		aDados:=Array(15)

        If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)=="TTT")
			If (nLin+3)>=nLimPag
			   R931Filler()
			   R931Cabec()
			Endif
			FmtLin(@aDados,aL[20],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[3]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		If ("TT"$cCFO)
			FmtLin(@aDados,aL[20],,,@nLin)
            aDados[3]:=If(ALLTRIM(cCFO)=="TTT",STR0035,STR0036) //"TOTAL"###"SUB-TOTAL"
		Else
            aDados[8]:=TransForm(cCFO,cPesqCFO)
		Endif
		aDados[6]:=aResCFO[i,ColF3("F3_VALCONT")]
		aDados[9]:="ICMS"
		aDados[10]:=aResCFO[i,ColF3("F3_BASEICM")]
		aDados[12]:=aResCFO[i,ColF3("F3_VALICM")]
		aDados[13]:=aResCFO[i,ColF3("F3_ISENICM")]
		aDados[14]:=aResCFO[i,ColF3("F3_OUTRICM")]
		If lF3_VLINCMG
		    If !Empty(aResCFO[i,ColF3("F3_VLINCMG")])
		        aDados[14] += aResCFO[i,ColF3("F3_VLINCMG")]
		    EndIf                               
		EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		aDados[9]:="IPI"
		aDados[10]:=aResCFO[i,ColF3("F3_BASEIPI")]
		aDados[12]:=aResCFO[i,ColF3("F3_VALIPI")]
		aDados[13]:=aResCFO[i,ColF3("F3_ISENIPI")]
		aDados[14]:=aResCFO[i,ColF3("F3_OUTRIPI")]
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
     		   FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End

 		//Ŀ
		// Atender legislacao Fomentar de GO
		//
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aResCFO[i,ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
	Endif
	//Ŀ
	// Completa preenchimento da folha 
	//
	If i==Len(aResCFO)
		If nTipoMov==1
			FmtLin(@aDados,aL[18],,,@nLin)
		Else
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		aResCFO	:= {}
		R931Filler()
	Endif    
Next i

Return
/*


Ŀ
Funo     R931ResEstAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Resumo por Estado                                          
ٱ


*/
STATIC FUNCTION R931ResEst
Local xx:=0
Local i:=1
Local j:=1
Local lFirstCO:=.T.
Local lFirstNC:=.T.
Local nTotvlrctb:=0
Local nTotvlrbsc:=0
Local nTotimpdeb	:=0
Local nTotisenta	:=0
Local nTotoutras	:=0
Local nTotIcmCre	:=0
Local nTotIPICre	:=0
Local nTotBasIPI	:=0
Local lAntiICM		:= (lF3_VALANTI .And. aSX6[MV_ESTADO]=="SP")

If Len(aResumo)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)
	Return
Endif

nLin:=80
//Ŀ
// Arranja o resumo em ordem de CFO e Estado
//
aResumo:=ASort(aResumo,,,{|x,y|x[1]+x[2]<y[1]+y[2]})
lFirstCO:=.T.
lFirstNC:=.T.
For i:=1 to Len(aResumo)
   If nLin>nLimPag
   		If nLin<>80
   			FmtLin({},aL[01],,,@nLin)
   		EndIf
		R931Cabec()
	Endif
	If nTipoMov==1
		aDados:=Array(18)
		If (lLisEstOri.Or.(!lLisEstOri.And.aResumo[i,16]!=aResumo[i,2]))
			If i==1
				FmtLin(@aDados,aL[17],,,@nLin)
				aDados[8]:=STR0037 //"DEMONSTRATIVO POR ESTADO DE ORIGEM DA MERCADORIA OU DE INICIO DA PRESTACAO DE SERVICO"
				FmtLin(@aDados,aL[17],,,@nLin)
				aDados[8]:="====================================================================================="
				FmtLin(@aDados,aL[17],,,@nLin)
				FmtLin(@aDados,aL[17],,,@nLin)
			Endif
         
		    aGrade:={}


			If mv_par26 == 1
	           aDados[07]:=aResumo[i,2] 		// Estado
			   aDados[08]:=aResumo[i,3] 		//Valor Contabil

			   If aResumo[i,4]>0 //Base de Calculo
				  AADD(aGrade,{"1",aResumo[i,4]})
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  AADD(aGrade,{"2",aResumo[i,7]})
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  AADD(aGrade,{"3",aResumo[i,5]})
 				EndIf
 	           If aResumo[i,18]>0 //Reduo de Base - D.L.43.080
				   AADD(aGrade,{"3",aResumo[i,18]})
				Endif			   
 	           If aResumo[i,19]>0 //Incentivo a prod.leite-MG
				   AADD(aGrade,{"3",aResumo[i,19]})
				Endif			   
               If aResumo[i,8]>0          		//Valor Icms
				  aDados[14] :=aResumo[i,8]
               EndIf
               If aResumo[i,9]>0 				// Base de Calculo IPI
				  aDados[16] :=aResumo[i,9]
			   Endif
               If aResumo[i,10]>0          		//Valor IPI
				  aDados[17] :=aResumo[i,10]
               EndIf
			Else
	           aDados[7]:=aResumo[i,2] // Estado
			   aDados[8]:=aResumo[i,3] //Valor Contabil
			   If aResumo[i,4]>0 //Base de Calculo
				  AADD(aGrade,{"1",aResumo[i,4]})
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  AADD(aGrade,{"2",aResumo[i,7]})
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  AADD(aGrade,{"3",aResumo[i,5]})
			    Endif
	           If aResumo[i,18]>0 //Reduo de Base DL 43.080
				   AADD(aGrade,{"3",aResumo[i,18]})
				 Endif	
	           If aResumo[i,19]>0 //Incentivo a prod.leite-MG
				   AADD(aGrade,{"3",aResumo[i,19]})
				 Endif	
			EndIf
			If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS Retido
				aObs := {}
				cMensagem:=STR0038+Alltrim(Transform(aResumo[i,6],cPesqICMRET))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx				
				//aDados[18]:=STR0038+Alltrim(Transform(aResumo[i,6],cPesqICMRET))
			Endif 

			 //X
             //criar totalizador de resumo por estado. quando o parametro  mv_par24 for sim 
             //X

			IF MV_PAR25 == 1                
     		   nTotvlrctb +=aResumo[i,3] //Valor Contabil

			   If aResumo[i,4]>0 //Base de Calculo
				  nTotvlrbsc +=	aResumo[i,4]
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  nTotvlrbsc +=	aResumo[i,7]
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  nTotvlrbsc +=	aResumo[i,5]
			    Endif
	           If aResumo[i,18]>0 //Reduo de base DL 43080
				   nTotvlrbsc += aResumo[i,18]
			    Endif
	           If aResumo[i,19]>0 //Incentivo a prod.leite-MG
				   nTotvlrbsc += aResumo[i,19]
			    Endif

	    	   If mv_par26 == 1
				  nTotIcmCre	+=aResumo[i,08] //Total Icm Creditado
				  nTotIPICre	+=aResumo[i,10] //Total Ipi Creditado
				  nTotBasIPI	+=aResumo[i,09] //Base de Calculo IPI
	    	   Endif
			endif 

			if len(aGrade) > 0
				For j:=1 to Len(aGrade)
					aDados[11]:=aGrade[j,1]
					aDados[12]:=aGrade[j,2]
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					If Len(aObs) <= 0
						FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					Else
						nPosObs:=Ascan(aObs,{|x|x[2]})
						While nPosObs>0
							R931LoadObs()
							If nPosObs>0
								FmtLin(@aDados,aL[17],cPictVl,,@nLin)
							Endif                      
							nPosObs:=Ascan(aObs,{|x|x[2]})							
						End					
					EndIf
				Next j
			Else
				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			
			Endif	
			If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
				aObs := {}
				cMensagem:=STR0043+Alltrim(Transform(aResumo[i,13],cPesqOBSI))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx				

				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			    				
			Endif			
			If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
				If lAntiICM
					aObs := {}
					cMensagem:=STR0044+Alltrim(Transform(aResumo[i,14]-aResumo[i,17],cPesqOBSS))
				    For xx:=1 to MlCount(cMensagem,17)
					   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
				    Next xx									
				Else       
					aObs := {}
					cMensagem:=STR0044+Alltrim(Transform(aResumo[i,14],cPesqOBSS))
				    For xx:=1 to MlCount(cMensagem,17)
					   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
				    Next xx					
				Endif  

				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf				
			Endif	
			If aResumo[i,15]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //CRED. PRES. ST
				aObs := {}
				cMensagem:=STR0045+Alltrim (Transform (aResumo[i,15], cPesqCRPR))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx
	
				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			    
			Endif 
		Endif
	Else
		aDados:=Array(15)
		If (lLisEstOri.Or.(!lLisEstOri.And.aResumo[i,16]!=aResumo[i,2]))
			If i==1
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[7]:=STR0039 //"DEMONSTRATIVO POR ESTADO DE DESTINO DA MERCADORIA OU DA PRESTACAO DE SERVICO"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[7]:="============================================================================"
				FmtLin(@aDados,aL[19],,,@nLin)
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif
			If lFirstCO.and.aResumo[i,1]=="CO"
				lFirstCO:=.F.
				aDados[9]:=STR0040 //"OPERACOES REALIZADAS COM CONTRIBUINTES"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[9]:="======================================"
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif
			If lFirstNC.and.aResumo[i,1]=="NC"
				lFirstNC:=.F.
				aDados[9]:=STR0041 //"OPERACOES REALIZADAS COM NAO CONTRIBUINTES"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[9]:="=========================================="
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif

			If mv_par26 == 1
			   aDados[05]:=aResumo[i,2]
			   aDados[06]:=aResumo[i,3]
			   aDados[09]:="ICMS"
			   aDados[10]:=aResumo[i,4]
			   aDados[12]:=aResumo[i,8]
			   aDados[13]:=aResumo[i,7]            
			   aDados[14]:=aResumo[i,5]            
			   If aResumo[i,18]>0
			       aDados[14] += aResumo[i,18]
			   EndIf           
			   If aResumo[i,19]>0
			       aDados[14] += aResumo[i,19]
			   EndIf           
			Else
			   aDados[5]:=aResumo[i,2]
			   aDados[6]:=aResumo[i,3]
			   aDados[9]:="ICMS"
			   aDados[10]:=aResumo[i,4]
			Endif   

            IF mv_par25 == 1                
     		   nTotvlrctb +=aResumo[i,3] //Valor Contabil
	    	   nTotvlrbsc +=aResumo[i,4] //Base de Calculo
	    	   If mv_par26 == 1
				  nTotimpdeb	+=aResumo[i,8]
				  nTotisenta	+=aResumo[i,7]
				  nTotoutras	+=aResumo[i,5]
				  If aResumo[i,18]>0
				      nTotoutras += aResumo[i,18]
				  EndIf
				  If aResumo[i,19]>0
				      nTotoutras += aResumo[i,19]
				  EndIf
	    	   Endif
     		endif 

			If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)
				aDados[15]:=STR0038+Alltrim(Transform(aResumo[i,6],cPesqICMRET)	) //"ICMS RETIDO...: "
			Endif
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
				aDados[15]:=STR0043+Alltrim(Transform(aResumo[i,13],cPesqOBSI))
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Endif			
			If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
				If lAntiICM
					aDados[15]:=STR0044+Alltrim(Transform(aResumo[i,14]-aResumo[i,17],cPesqOBSS))
				Else
					aDados[15]:=STR0044+Alltrim(Transform(aResumo[i,14],cPesqOBSS))
				Endif			
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			EndIf
		Endif
	Endif
	//Ŀ
	// Completa preenchimento da folha 
	//
	If i==Len(aResumo)

	   IF nTipoMov==1 .AND. MV_PAR25 == 1
          aDados[5]		:= STR0035
          aDados[8]		:= nTotvlrctb //TOTAL Valor Contabil
          aDados[12]	:= nTotvlrbsc //TOTAL Base de Calculo    
          If mv_par26 == 1
	   	     aDados[14]	:= nTotIcmCre
		     aDados[17]	:= nTotIPICre
		     aDados[16]	:= nTotBasIPI
		  Endif   

			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		ELSE
          IF  nTipoMov == 2  .AND. MV_PAR25 == 1
              aDados[03]	:=	STR0035
              aDados[06]	:=	nTotvlrctb //TOTAL Valor Contabil
              aDados[10]	:=	nTotvlrbsc //TOTAL Base de Calculo
              If mv_par26 == 1
		         aDados[12]	:=	nTotimpdeb
			     aDados[13]	:=	nTotisenta
			     aDados[14]	:=	nTotoutras
			  Endif   
              FmtLin(@aDados,aL[19],cPictVl,,@nLin)
          ENDIF
       ENDIF
	   
	   R931Filler()
	Endif
Next i
aResumo:={}
Return
/*


Ŀ
Funo    R931LoadObsAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Carrega observacao para ser impressa                       
ٱ


*/
STATIC FUNCTION R931LoadObs(nReserv)

Local cTipo 	:= IIF(FWIsInCallStack('R931RegEntradas'), "aDados[9]", "aDados[7]")                                 
Default nReserv := 0

// nPosOBS indica a linha da OBSERVACAO que sera impressa
if nReserv <> 0
	nPosObs:= nReserv
else
	nPosObs:=Ascan(aObs,{|x|x[2]})
endif

If nPosObs>0
	aDados[If(nTipoMov==1,18,15)]:=aObs[nPosObs,1]
	aObs[nPosObs,2]:=.F.
	//Verifica necessidade de impressao da conta contabil por quebra de linha
	If Len(aLinCont) > 0 .AND. !FWIsInCallStack('R931Transp')
		&cTipo := aLinCont[1] 			//Preenche a continuacao da conta contabil
		ADel( aLinCont, 1 )					//Remove a dimensao que foi utilizada
		ASize( aLinCont, Len(aLinCont)-1 )	//Redimensiona o array
	EndIf
Endif

If (Empty(&cTipo) .OR. Len(&cTipo)>14); 
	.AND. !FWIsInCallStack('R931TotDia') .AND. !FWIsInCallStack('R931Transp')
	If IIF(Substr(cTipo,8,1) == "9", IIF(!Empty(aDados[11]),.T.,.F.), IIF(!Empty(aDados[9]),.T.,.F.))
		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			(&cTipo) := aLinCont[1] 			//Preenche a continuacao da conta contabil
			ADel( aLinCont, 1 )					//Remove a dimensao que foi utilizada
			ASize( aLinCont, Len(aLinCont)-1 )	//Redimensiona o array
		EndIf
	EndIf
EndIf

Return
/*


Ŀ
Funo    R931Totais Autor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Aciona funcoes de totalizacao                              
ٱ


*/
STATIC FUNCTION R931Totais
Local nLinTrans := 0
Local aLinTrans := {}

If !lImpZer
	R931Transp()
Else
    //Fao essa validao pois quando imprimimos linhas sem valor (ImpZer) conto de 3 em 3 linhas e no de 1 em 1
    //Se o tamanho da pagina for menor que as 3 prximas linhas + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir as Notas.
	aLinTrans  := LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
	 nLinTrans := Len(aLinTrans)+If(nTipoMov==1,2,4)+If(lImpZer,3,0)
    If nLimPag<=nLin+3+nLinTrans
		R931Transp(.T., aLinTrans)
	Endif
EndIf	

If lTotalDia
	R931TotDia()
	R931Transp()
Endif

lTotPerICM:=(nSvApurICM!=DefPeriodo(dDia,nApurICM)) .Or. IIf(nApurIcm==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotPerIPI:=(nSvApurIPI!=DefPeriodo(dDia,nApurIPI)) .Or. IIf(nApurIpi==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotMes:=(Month(dDiaAnt)!=Month(dDia))


R931TotPer()
R931TotMes()
//Ŀ
// Termino do Relatorio
//
If lTotMes
	//Ŀ
	// Imprime Resumo por CFO 
	//
	R931ResCfo()
	//Ŀ
	// Imprime Resumo por Estado 
	//
    R931ResEst()
Endif
//Ŀ
// Imprime Termo de Encerramento
//
R931TermEnc()
If nLin<=nLimPag .And. (cArqTemp)->(EOF())
   R931Filler()
Endif   
Return
/*


Ŀ
Funo    R931TermIniAutor  Rodrigo de A. Sartorio Data  25.03.98 
Ĵ
Descrio  Imprime termo de abertura no caso de so listar termos      
ٱ


*/
STATIC FUNCTION R931TermIni()
Local cTermoSAb := aSX6[MV_LSAIAB]
Local cTermoEAb	:= aSX6[MV_LENTAB]
If MV_PAR41 == 1 .And. !Empty(aSX6[MV_P2ABER]) .And. !Empty(aSX6[MV_P1ABER])
	cTermoSAb := aSX6[MV_P2ABER]
	cTermoEAb := aSX6[MV_P1ABER]
EndIf

nPagina:=1
//Ŀ
// Imprime Termos de Abertura/Encerramento
//
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3).and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
Return
/*


Ŀ
Funo    R931TermEncAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Imprime termo de encerramento no fim do relatorio          
ٱ


*/
STATIC FUNCTION R931TermEnc()
If ((Eof().Or.!lHouveMov).and. nImpTerm == 3) .Or. (nImpTerm == 2)
	If nTipoMov==1
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
	Else
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
	Endif
Endif
Return
/*


Ŀ
Funo     R931FillerAutor  Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Preenche folha com linha vazias                            
ٱ


*/
STATIC FUNCTION R931Filler

IF nLin < 67        

   While nLin<nLimPag
     	FmtLin(@aDados,If(nTipoMov==1,aL[17],aL[19]),,,@nLin) 
   End                       
   If nLin>=nLimPag
      FmtLin(@aDados,aL[1],,,@nLin)
   ENdif   

ENDIF
Return
/*


Ŀ
Funo    R931IniGradeAutor Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Inicializa array aGrade do registro de entradas            
ٱ


*/
STATIC FUNCTION R931IniGrade
//Ŀ
// Monta grade de impressao            
// [1]=Codigo de Operacao de ICMS      
// [2]=Base de ICMS / Isentas / Outras 
// [3]=Valor do ICMS                   
// [4]=Codigo de Operacao de IPI       
// [5]=Base de IPI / Isentas / Outras  
// [6]=Valor do IPI                    
//
If !lImpZer
	aGrade:={{"",0,0,"",0,0,0},{"",0,0,"",0,0,0},{"",0,0,"",0,0,0}}
Else
	aGrade:={{"1",0,0,"1",0,0,0},{"2",0,0,"2",0,0,0},{"3",0,0,"3",0,0,0}}
Endif
Return
/*


Ŀ
Funo    R931ImpGradeAutor Juan Jose Pereira      Data  23.12.96 
Ĵ
Descrio  Imprime aGrade do registro de entradas                     
ٱ


*/
STATIC FUNCTION R931ImpGrade(lUnicaNf)

Local lImprimiu :=.F.
Local nX		:= 1
Local aQuebra	:= {}
Local nPosObsQ  := 0
Local cChave4   := ""

DEFAULT lUnicaNf := .F.

For nx:=1 to Len(aGrade)

	If MV_PAR15 = 1
		If !lImpZer.and.(aGrade[nx,2]+aGrade[nx,3]+aGrade[nx,5]+aGrade[nx,6]+aGrade[nx,7])==0 .And. !lServico
			Loop
		Endif
	Else
		If (!lImpZer .And. !lServico .and.(aGrade[nx,2]+aGrade[nx,3]+aGrade[nx,5]+aGrade[nx,6]+aGrade[nx,7])==0) .Or. ;
	   (aGrade[nx,2]+aGrade[nx,3]+aGrade[nx,5]+aGrade[nx,6]+aGrade[nx,7])==0 
		Loop
		Endif
	EndIf	
	
	lImprimiu:=.T.
	
	//Ŀ
	// Colunas de ICMS 
	//                       
	If ((aGrade[nx,2] + aGrade[nx,3] > 0) .Or. (lImpZer))
		aDados[11]:=aGrade[nx,1]
		aDados[12]:=aGrade[nx,2]
		aDados[14]:=aGrade[nx,3]  
	EndIf

	//Ŀ
	// Colunas de IPI  
	//
	If ((aGrade[nx,5] + aGrade[nx,6] > 0) .Or. (lImpZer))
		nLinha :=6
		aDados[15]:=aGrade[nx,4]
		aDados[16]:=aGrade[nx,5]		  
		aDados[17]:=aGrade[nx,6]	
	Endif     	

	R931LoadObs(nPosObsQ) 

	If Len(aDados) > 0 .And. aDados[1] <> Nil   
		aQuebra := AClone(aDados)
	Endif

	FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)  

	nPosObs:=Ascan(aObs,{|x|x[2]})
    
	While nPosObs>0         
		R931LoadObs(nPosObsQ)
		
		If nPosObs>0   
			//Ŀ
			// Cabecalho 
			//
			If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
				// Guardo a proxima observacao para imprimir na primeira linha apos a quebra de pagina
			If Len(aDados) > 0
				aQuebra := AClone(aDados)
				endif
				R931Filler()
				R931Cabec()  			

				// Imprimo os dados na nota fiscal novamente pois mudou de pagina e ainda existe observacoes a 
				// serem impressas para esta nota fiscal
				FmtLin(@aQuebra,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)				
			Else
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				nPosObsQ:=0
			Endif		
		Endif
	End

	nPosObsQ  := 0
Next nx

//Ŀ
// Imprime itens com lancamento no livro fiscal zerado   
//
If !lImprimiu .And. !Empty(aDados[1]) .And. F3_VALCONT>0
	cChave4 := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
	SD1->(dbSetOrder(1))
	SF4->(dbSetOrder(1))
	
	If SD1->(MSSeek(xFilial("SD1")+cChave4))								
		If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
			If SF4->F4_LFICM == "T"
				aDados[11]:="1"
			ElseIf SF4->F4_LFICM == "I"				
				aDados[11]:="2"
			ElseIf SF4->F4_LFICM == "O"				
				aDados[11]:="3"	
			Endif			
			If SF4->F4_LFIPI == "T"
				aDados[15]:="1"
			ElseIf SF4->F4_LFIPI == "I"				
				aDados[15]:="2"
			ElseIf SF4->F4_LFIPI == "O"				
				aDados[15]:="3"	
			Endif			
		Endif
	Endif	
	
	//Ŀ
	// Colunas de ICMS 
	//
	aDados[12]:=0
	aDados[14]:=0
	
	//Ŀ
	// Colunas de IPI  
	//
	aDados[16]:=0
	aDados[17]:=0
	
	//Ŀ
	// Coluna de Observacoes 
	//
	R931LoadObs()
	
	If lIcmIpZer
		FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
	Else
		aDados[11]:= NIL
		aDados[15]:= NIL
		aDados[12]:= NIL
		aDados[14]:= NIL
		aDados[16]:= NIL
		aDados[17]:= NIL
		FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
	EndIf
Endif

Return
/*


Ŀ
Funo     R931GetEcf Autor Vendas e CRM           Data  18.05.09 
Ĵ
Descrio  Retorna alguns dados para o preenchimento das Colunas      
ٱ
Parametros cAliasECF - Alias temporario    							  
			  nOpcField - Define campo de retorno 1-Especie 2-Serie   	  
ٱ


*/
Function R931GetEcf(cAliasECF,nOpcField)

Local cRet	 := ""			// Sempre retorna caracter
Local lMod55 := aSX6[MV_SPED55]
Local lEspCup:= .F.
Local cNFiscal 	:= "" 			// Numero do comprovante fiscal
Local lSAT		:= aSX6[MV_R930SAT]

DbSelectArea(cAliasECF)		// Arquivo temporario
//Ŀ
//Caso 1 - retorna a especie  2- a serie
//
If nOpcField == 1 
	If(Empty( (cAliasECF)->(F3_ESPECIE) ) )
		cRet	:= R930CFOTra((cAliasECF)->(F3_CFO),(cAliasECF)->(F3_SERIE))
	Else
		lEspCup:= Alltrim((cAliasECF)->(F3_ESPECIE))== "CF" .OR. ("ECF" $ (cAliasECF)->(F3_ESPECIE) .and. LjAnalisaLeg(18)[1])

		If lLeiECF .AND. lEspCup 		// Apenas especie cupom
			Do case
				Case(nLegisArt == 3)  	// Artigo 80
					cRet	:= "CMR"
				Case(nLegisArt == 4)  	// Artigo 81
					cRet	:= "MRC"
				OtherWise
					cRet	:= "CF"   	// Para os Artigos 25 e 26 sempre fica "CF"                                 		
			EndCase	
		ElseIf lMod55 .And. Alltrim((cAliasECF)->(F3_ESPECIE)) == "SPED"  // Para modelo Sped codigo 55.
			cRet	:= "55"	
		Else	
			cRet	:= (cAliasECF)->(F3_ESPECIE)
		EndIf	
	EndIf	
ElseIf nOpcField == 2 
	lEspCup:= Alltrim((cAliasECF)->(F3_ESPECIE))== "CF" .OR. ("ECF" $ (cAliasECF)->(F3_ESPECIE) .and. LjAnalisaLeg(18)[1])

	If (!lLeiECF .OR. (Empty((cAliasECF)->(F3_PDV)) .OR. !lEspCup )) .AND. (cAliasECF)->(F3_SERIE) <> "ECF"
		cRet := IIF(lSAT .And. !Empty((cAliasECF)->(F3_SERSAT)) .And. !Empty((cAliasECF)->(F3_PDV)), (cAliasECF)->(F3_SERSAT), (cAliasECF)->(F3_SERIE))
	Else
		Do Case
			Case(nLegisArt == 1)  		// Artigo 25
				cRet	:= "ECF"
			Case(nLegisArt == 4)  		// Artigo 81
				cRet	:= "CMR"
			OtherWise
				cRet := Alltrim((cAliasECF)->(F3_PDV))	// Para os Artigos 26 e 80 grava o n do PDV
		EndCase	
	EndIf 
Else	
	//Ŀ
	//Lista o intervalo de cupons fiscais , exceto para os artigos 25 e 80 que utilizam o numero do Mapa
	//
	IF !Empty((cAliasECF)->(F3_PDV))
		DbSelectArea("SFI")
		DbSetOrder(1)		//FILIAL + DTMOVTO + PDV
		If MSSeek(xFilial("SFI") + DTOS((cAliasECF)->(F3_EMISSAO)) + (cAliasECF)->(F3_PDV))
			If (nLegisArt == 1 .OR. nLegisArt == 4)  	// Artigo 25 e Artigo 81
				If lMapResumo
					cRet := SFI->FI_NUMERO + " A " + SFI->FI_NUMERO
				Else
					cNFiscal	:= IIF(Empty( (cAliasECF)->(F3_NUMINI) ),(cAliasECF)->(F3_NFISCAL),(cAliasECF)->(F3_NUMINI))
					cRet 		:= cNFiscal + " A " + cNFiscal
				EndIf	
			Else
				//Ŀ
				//Verifica nmero, rotina antiga(Loja300) armazenava no campo F3_NUMINI 
				//
				cNFiscal	:= IIF(Empty( (cAliasECF)->(F3_NUMINI) ),(cAliasECF)->(F3_NFISCAL),(cAliasECF)->(F3_NUMINI))
				cRet 		:= cNFiscal + " A " + SFI->FI_COO
			EndIf		
		EndIf
	Endif
EndIf	

Return(cRet)
   


/*


Ŀ
Funo     R931TVlCtEnAutorLTrombini               Data  25.06.13 
Ĵ
Descrio  Calcula valor total contbil por NF impressa               
ٱ


*/
Static Function R931TVlCtEn(cUltNF)
Local nVlrCtNF	:= 0
Local aDadT		:= aClone(aDados)
Local nRecOri	:= Recno()
Local cIdTipo   := ""   
Local aAreaCF  := {}

If cUltNF <> aDadT[1]+aDadT[2]+aDadT[3]+aDadT[4]+aDadT[5]+aDadT[6]+aDadT[7]
	If mv_par47 ==1 
		aAreaCF := GetArea()
		If RetPessoa((cArqTemp)->CGC) == "F"
	    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R 999.999.999-99")
	    ELSE
	    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R! NN.NNN.NNN/NNNN-99")
	    EndIf
   EndIf
	aDadT[1]:= DTOC(F3_ENTRADA)
	aDadT[2]:= IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,SerieNfId(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE))
	aDadT[3]:= SerieNfId(cArqTemp,2,"F3_SERIE")
	aDadT[4]:= F3_NFISCAL
	aDadT[5]:= DTOC(F3_EMISSAO)
	aDadT[6]:= If(mv_par47 == 1 ,cIdTipo, F3_CLIEFOR+"-"+F3_LOJA)
	aDadT[7]:= F3_ESTADO
	cUltNF := aDadT[1]+aDadT[2]+aDadT[3]+aDadT[4]+aDadT[5]+aDadT[6]+aDadT[7]
	While !Eof() .and. aDadT[1]== DTOC(F3_ENTRADA) .and.;
		aDadT[2]== IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,SerieNfId(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE)) .and.;
		aDadT[3]==SerieNfId(cArqTemp,2,"F3_SERIE") .and. aDadT[4]==F3_NFISCAL .and. aDadT[5]== DTOC(F3_EMISSAO) .and. aDadT[6]==If(mv_par47 == 1 ,cIdTipo, F3_CLIEFOR+"-"+F3_LOJA) .and. aDadT[7]==F3_ESTADO

		nVlrCtNF += F3_VALCONT
		dbSelectArea(cArqTemp)
		dbSkip()
		//Autualizo o cIdTipo pois pode existir a mesma nota e serie com fornecedores Diferentes.
		If mv_par47 == 1 .And. !Eof()
			cIdTipo := Posicione(If(F3_TIPO$"DB","SA1","SA2"),1,xFilial(If(F3_TIPO$"DB","SA1","SA2"))+F3_CLIEFOR+F3_LOJA,If(F3_TIPO$"DB","A1_CGC","A2_CGC"))
			If F3_TIPO$"DB"
				If RetPessoa(SA1->A1_CGC) == "F"
			    	cIdTipo := TRANSFORM(SA1->A1_CGC,"@R 999.999.999-99")
			    ELSE
			    	cIdTipo := TRANSFORM(SA1->A1_CGC,"@R! NN.NNN.NNN/NNNN-99")
			    EndIf
			Else
				If RetPessoa(SA2->A2_CGC) == "F"
			    	cIdTipo := TRANSFORM(SA2->A2_CGC,"@R 999.999.999-99")
				Else    	
			    	cIdTipo := TRANSFORM(SA2->A2_CGC,"@R! NN.NNN.NNN/NNNN-99")
			    EndIf
			EndIf
		EndIf
	EndDo
	If mv_par47 ==1 
		RestArea(aAreaCF)
	EndIf
	DbGoto(nRecOri)
Else
	nVlrCtNF	:= ' '		// Para no imprimir zero no relatrio, transforma em branco
EndIf
Return(nVlrCtNF)
