#INCLUDE "Matr930.ch"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "Matr930Def.ch"

STATIC __cFileLogo := ""


STATIC aColunas // Utilizada na Funcao ColF3

STATIC __aPrepared	:= {}
STATIC cQryInsert	:= ""
STATIC cSGBD 		:= TCGetDB()

STATIC lMatr931  := (Existblock("MATR931"))
STATIC lMatr932  := (Existblock("MATR932"))
STATIC lMatr930A := (ExistBlock("MATR930A"))
STATIC nTamF2DOC := TamSX3("F2_DOC")[1]

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³FUNCAO    ³ MATR930  ³ Autor ³ Juan Jose Pereira     ³ Data ³ 18.12.96   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³DESCRICAO ³ Imprime Registro de Entadas P1 P1A e Saidas P2 P2A           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ PROGRAMADOR  ³ DATA   ³ BOPS ³  MOTIVO DA ALTERACAO                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Marcos Simidu³14/09/98³09795A³ Considerar data de emissao na impressao  ³±±
±±³              ³14/09/98³09795A³ de NF entrada no livro de saida.         ³±±
±±³ Marcos Simidu³23/09/98³XXXXXX³ Acertos NF form prop nos livros de saida.³±±
±±³ Marcos Simidu³11/11/98³XXXXXX³ Impressao dos parametros de data nos     ³±±
±±³              ³11/11/98³XXXXXX³ termos de abertura/encerramento.         ³±±
±±³ Andreia      ³27/01/99³18598A³ Tratamento do no. de registros impressos ³±±
±±³              ³        ³      ³ quando for nota de servico.              ³±±
±±³ Andreia      ³11/03/99³xxxxxx³Tratamento da especie das notas fiscais   ³±±
±±³              ³        ³      ³canceladas atraves do parametro MV_ESPECIE³±±
±±³ Andreia      ³15/06/99³xxxxxx³Acertos Protheus.                         ³±±
±±³ Andreia      ³09/08/99³22553A³ Criacao de pergunta para escolher se o im³±±
±±³              ³        ³      ³ posto retido sera impresso na coluna "OB-³±±
±±³              ³        ³      ³ SERVACAO" ou na coluna "Tributado"       ³±±
±±³              ³        ³      ³ (mv_par21).                              ³±±
±±³ Andreia      ³04/10/99³23914A³ Funcao EXISTNF() - Acerto na verificacao ³±±
±±³              ³        ³      ³ de notas fiscais canceladas.             ³±±
±±³ Andreia      ³08/10/99³xxxxxx³ Tratamento da variavel nColuna na funcao ³±±
±±³              ³        ³      ³ LivrArrayObs, quando e emitido o relato- ³±±
±±³              ³        ³      ³ rio MATR920.                             ³±±
±±³ Edilaine     ³01/06/00³003880³ Tratamento de variavel CTIPO. Funcao     ³±±
±±³              ³        ³      ³ LivrAcumula()                            ³±±
±±³ Andre Veiga  ³05/05/01³008831³ Escrituracao do Mapa Resumo ECF (Portaria³±±
±±³              ³        ³      ³ CAT 55/98, Conv.ICMS 50/00)              ³±±
±±³ Denis Martins³20/09/01³Melhor³ Tratamento de Filiais(Exc/Comp.)-F3_MSFIL³±±
±±³ Machima      ³09/06/06³100780³ Implementacao do decreto 22.928/02 art.1 ³±±
±±³              ³        ³                                                 ³±±
±±³ Vogas Junior ³27/02/18³ISSUE DSERFIS2-341  Nao apresentar valores em no-³±±
±±³              ³        ³tas de entrada de servico.                       ³±±
±±³              ³        ³      ³                                          ³±±
±±³ Vogas Junior ³23/03/18³DSERFIS2-4167 Parametrizacao da informacao de UF ³±±
±±³              ³        ³      ³nas notas de conhecimento de transporte.  ³±±
±±³              ³        ³      ³                                          ³±±
±±³ Vogas Junior ³25/04/18³DSERFIS2-2926 Totalizar valores referentes a FECP³±±
±±³              ³        ³      ³e FECP-ST.								³±±
±±³              ³        ³      ³                                          ³±±
±±³ Vogas Junior ³26/04/18³DSERFIS2-4546 Retornar tratamento referemte ao pa³±±
±±³              ³        ³      ³rametro 37 - Imprime Mapa Resumo.			³±±
±±³ Vogas Junior ³04/05/18³DSERFIS2-151 Correcao da impressao da serie de   ³±±
±±³              ³        ³      ³documentos SAT parametro MV_R930SAT=.T.	³±±
±±³ Vogas Junior ³30/05/18³DSERFIS2-3691 (MATR920) Criado pergunte para sele³±±
±±³              ³        ³      ³ cionar coluna para apresentar ICMS-ST.	³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION MATR930

Local 	lVerpesssen := Iif(FindFunction("Verpesssen"),Verpesssen(),.T.)
Local cRelease as character

Local cEndWeb		:= "https://tdn.totvs.com/pages/viewpage.action?pageId=792425840"

cRelease 	:=  GetRPORelease()     

If !IsBlind() 
	If FindFunction("DlgRelVer")
		DlgRelVer("MATR930","Relatorio Lancamentos fiscais",cEndWeb )  
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define Variaveis ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
wnRel	  :="MATR930"
Titulo    :=STR0001 //"Regime de Processamento de Dados"
cDesc1    :=STR0002 //"Emiss„o dos Registros de Entradas modelos P1 e P1A e Registros de Saidas"
cDesc2    :=STR0003 //"modelos P2 e P2A."
cDesc3    :=STR0004 //"Ir  imprimir os lan‡amentos fiscais conforme os parƒmetros informados."
aReturn   :={ STR0005, 1,STR0006, 2, 2, 1, "",1 } //"Zebrado"###"Administra‡„o"
nomeprog  :="MATR930"
cPerg	  :="MTR930"
cString	  :="SF3"
nPagina	  :=0
nLin	  :=3
nLargMax  :=220
Tamanho	  :="G"
cArqTemp  :=""
cNomeArq  :=""
dbSelectArea("SF3")
dbSetOrder(1)
aSvArea	  :={Alias(),IndexOrd(),Recno()}
nPosObs	  :=0
aOrd	  :={"Data de Entrada+Série+Número da NFE","Data de Entrada+Número da NFE+Série","Número da NFE+Série+Data de Entrada"}
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis utilizadas no cabecalho     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aMeses	  :={STR0007,STR0008,STR0009,STR0010,STR0011,STR0012,STR0013,STR0014,STR0015,STR0016,STR0017,STR0018} //"JANEIRO"###"FEVEREIRO"###"MARCO"###"ABRIL"###"MAIO"###"JUNHO"###"JULHO"###"AGOSTO"###"SETEMBRO"###"OUTUBRO"###"NOVEMBRO"###"DEZEMBRO"
cNome 	  :=SM0->M0_NOMECOM
cInscr	  :=InscrEst()
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o campo "CGC" nao esta sendo utilizado para armazenar outro tipo de informacao.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If SM0->M0_TPINSC == 2 .Or. SM0->M0_TPINSC == 0
	cCGC  :=TRANSFORM(SM0->M0_CGC,"@R! NN.NNN.NNN/NNNN-99")
Else
	cCGC  :=""
Endif

If lVerpesssen
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicializa grupo de perguntas.        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Pergunte(cPerg,.F.)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Envia controle para a funcao SETPRINT ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nLastKey  :=0
	wnrel	  :=SetPrint(cString,wnrel,cPerg,Titulo,cDesc1,cDesc2,cDesc3,.F.,aOrd,.F.,Tamanho,,.T.)
	If nLastKey==27
		dbClearFilter()
		Return
	Endif
	SetDefault(aReturn,cString)
	If nLastKey==27
		dbClearFilter()
		Return
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Executa relatorio                                            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	RptStatus({|lEnd| R930Imp(@lEnd,wnRel,cString,Tamanho)},titulo)

	If aReturn[5]==1
		Set Printer To
		ourspool(wnrel)
	Endif
	MS_FLUSH()
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ R930Imp  ³ Autor ³ Juan Jose Pereira     ³ Data ³ 18.12.96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Imprime Relatorio                                          ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
STATIC FUNCTION R930Imp(lEnd,wnRel,cString,Tamanho)

Local	aRegSF3     :={}
Local 	nFilchave	:= FWSizeFilial()
Local	cNew       	:=	"HMNew()"
Local 	nStart      := seconds()

PRIVATE oArqSF3
PRIVATE coArqSF3Na	:= "" //Nome fisico da tabela
PRIVATE aSX6		:= R930LoadX6()
PRIVATE aSX3		:= R930LoadX3()
PRIVATE aPict		:= R930Pict()

Private cArqSF3		:=""
Private lAbortPrint :=.F.
Private nRegPerm	:= 1000000
Private nReg115		:= 0
Private	nVolume		:= 1
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Parametros utilizados pelo Programa                          ³
//³ mv_par01 - A partir da Data                                  ³
//³ mv_par02 - Ate a Data                                        ³
//³ mv_par03 - Imprime Modelo                                    ³
//³ mv_par04 - Imprime  (1) Livros (2) Termos (3) Livros e Termos³
//³ mv_par05 - Numero do Livro                                   ³
//³ mv_par06 - Numero da Pagina Inicial                          ³
//³ mv_par07 - Qtd. Paginas do Feixe                             ³
//³ mv_par08 - Reinicia Paginas                                  ³
//³ mv_par09 - Considera lacuna                                  ³
//³ mv_par10 - Apuracao de ICMS                                  ³
//³ mv_par11 - Apuracao de IPI                                   ³
//³ mv_par12 - Livro Selecionado                                 ³
//³ mv_par13 - Destaca NFs. de Servicos                          ³
//³ mv_par14 - Destaca descontos                                 ³
//³ mv_par15 - Imprime Linhas sem valor                          ³
//³ mv_par16 - Imprime Total Mensal                              ³
//³ mv_par17 - Imprime NF. de Entrada                            ³
//³ mv_par18 - Aglutina NF                                       ³
//³ mv_par19 - Totaliza por dia - Sim X Nao                      ³
//³ mv_par20 - Estado Origem no Resumo - Sim X Nao               ³
//³ mv_par21 - Imp. Retido Coluna: ?                             ³
//³ mv_par22 - Imp. Oper. Isentas ?                              ³
//³ mv_par23 - Considera CIAP ?                                  ³
//³ mv_par24 - Valor CIAP na Coluna ?                            ³
//³ mv_par25 - Totaliza Res.Estado ?                             ³
//³ mv_par26 - Totaliza Icm/Ipi/B.Calc. IPI ?                    ³
//³ mv_par27 - Totaliza ICMS Entr. ?                             ³
//³ mv_par28 - Lista NF origem ?                                 ³
//³ mv_par29 - Resumo Produtor ?                                 ³
//³ mv_par30 - Cupom Fiscal ?                                    ³
//³ mv_par31 - Processa Filiais ?                                ³
//³ mv_par32 - Filial de ?                                       ³
//³ mv_par33 - Filial ate ?                                      ³
//³ mv_par34 - Consolidação na mesma UF ?                        ³
//³ mv_par35 - Taxa UFIR ?                                       ³
//³ mv_par36 - Operações a imprimir?                             ³
//³ mv_par37 - Imprime Mapa Resumo ?                             ³
//³ mv_par38 - Imprime Imposto Res/Comp?                         ³
//³ mv_par39 - Artigo para Impressão ?                           ³
//³ mv_par40 - Seleciona Filiais ?                               ³
//³ mv_par41 - Série no Termo ?                                  ³
//³ mv_par42 - Série/SubSérie ?                                  ³
//³ mv_par43 - Impr. ICMS/IPI Zerado ?                           ³
//³ mv_par44 - Impr. NF Inutil. ?                                ³
//³ mv_par45 - Impr. Vl.Ctb.Total?                               ³
//³ mv_par46 - Aglutina por CNPJ+IE                              ³
//³ mv_par47 - Codigo Emitente                                   ³
//³ mv_par48 - Imprime FECP ?                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE dDtIni      := mv_par01
PRIVATE dDtFim      := mv_par02
PRIVATE cMV_ESTADO  := aSX6[MV_ESTADO]
PRIVATE cMV_CFOZER  := aSX6[MV_CFOZER]
PRIVATE nModelo     := mv_par03
PRIVATE nImpTerm    := mv_par04
PRIVATE cLivro      := mv_par05
PRIVATE nPagIni     := mv_par06
PRIVATE nPagAnt     := IIf(nImpTerm<>2,mv_par06,1)
PRIVATE nQtFeixe    := mv_par07
PRIVATE lReiniPg    := (mv_par08==1)
PRIVATE lLacuna     := (mv_par09==1 .Or. mv_par09==3)
PRIVATE nApurICM    := mv_par10
PRIVATE nApurIPI    := mv_par11
PRIVATE cNrLivro    := mv_par12
PRIVATE lServico    := (mv_par13==1)
PRIVATE lDesconto   := (mv_par14==1)
PRIVATE lImpZer     := (mv_par15==1)
PRIVATE lImpMes     := (mv_par16==1)
PRIVATE lEntrada    := (mv_par17==1)
PRIVATE lAglutina   := (mv_par18==1)
PRIVATE lTotalDia   := (mv_par19==1)
PRIVATE lLisEstOri  := (mv_par20==1)
PRIVATE nPagina     := IIf(nPagIni>0,nPagIni-1,1)
PRIVATE cFilterUser := aReturn[7]
PRIVATE nTipoMov    := If(nModelo==1 .or. nModelo==2 .or.(nmodelo==5 .And. AllTrim(cMV_ESTADO) == "SP"),1,2)
PRIVATE nColuna     := mv_par21
PRIVATE lLisIsenta  := (mv_par22==1)
PRIVATE lEmiteCiap  := (mv_par23==1)
PRIVATE lColCiap    := (mv_par24==1)
PRIVATE lListaNFO   := (mv_par28==1)
PRIVATE lProdutor   := (mv_par29==1)
PRIVATE lLeiECF	   := (mv_par30==1)
PRIVATE lConsUF     := (mv_par34==1)
PRIVATE nLegisArt   := mv_par39
PRIVATE lIcmIpZer   := (mv_par43==1)
PRIVATE lNFInutil   := (mv_par44==1)
PRIVATE lVlCtTot    := (mv_par45==1)
PRIVATE lObsFecp    := (mv_par48==1)
Private lMapResumo  := .F.
PRIVATE lConjugada  := .F.

If Type("mv_par49") == "N"
	lConjugada := (mv_par49==1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Recebe parametros ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE lCat21       := aSX6[MV_CAT21]
PRIVATE cContaContab :=NIL

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Limite da pagina em linhas³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE nLin         :=80
PRIVATE nLimPag      :=58
PRIVATE nLinNec      :=0
PRIVATE aTotFecp	:= {}
PRIVATE	lTop		:= TcSrvType() <> "AS/400"
PRIVATE lBuild   	:= GetBuild() >= "7.00.131227A"
PRIVATE lBuildjS 	:= GetBuild() >="7.00.170117A"

PRIVATE lF3MsFil	:= aSX3[FP_F3_MSFIL]
PRIVATE lF3Difal	:= aSX3[FP_F3_DIFAL]
PRIVATE lF3FCDifal 	:= aSX3[FP_F3_VFCPDIF]
PRIVATE lF3BASNDES 	:= aSX3[FP_F3_BASNDES]
PRIVATE lICMSNDES	:= aSX3[FP_F3_ICMNDES]
PRIVATE lF3_VL43080 := aSX3[FP_F3_VL43080]
PRIVATE lF3_VLINCMG := aSX3[FP_F3_VLINCMG]
PRIVATE lCredST		:= aSX3[FP_F3_CREDST]
PRIVATE lF3_NUMINI	:= aSX3[FP_F3_NUMINI]
PRIVATE lF3_NUMFIM	:= aSX3[FP_F3_NUMFIM]
PRIVATE lF3_VALANTI	:= aSX3[FP_F3_VALANTI]
PRIVATE lF3_CLIDVMC	:= aSX3[FP_F3_CLIDVMC]
PRIVATE lF3_DS43080	:= aSX3[FP_F3_DS43080]
PRIVATE lF3_SERSAT	:= aSX3[FP_F3_SERSAT]


PRIVATE	oHashColF3	:= Nil
PRIVATE	oNotasjS	:= Nil
PRIVATE	oFiliais	:= Nil
PRIVATE	oHashPar	:= Nil

If lBuild
	oHashColF3	:= &cNew	
	oHashFil	:= &cNew
	oHashPar	:= &cNew
	conout(Alltrim(Str(ThreadID())) + " Inicio do processamento:  " + Time())
EndIf




nQtFeixe	:=IIf(nQtFeixe>3,nQtFeixe,500)

If nPagAnt==0
	nPagina:=0
Endif

If nTipoMov==1
	cContaContab:=Alltrim(aSX6[MV_CTALFE])
	// Retira ref. ao Alias SF3 //
	cContaContab	:=	StrTran(cContaContab,"SF3->",)
Else
	cContaContab:=Alltrim(aSX6[MV_CTALFS])
	// Retira ref. ao Alias SF3 //
	cContaContab	:=	StrTran(cContaContab,"SF3->",)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Armazena maior tamanho das notas (em linhas)³
//³ [1]=Maior Nota da Pagina                    ³
//³ [2]=Maior Totalizacao de Transporte         ³
//³ [3]=Maior Totalizacao do Dia                ³
//³ [4]=Maior Totalizacao de Periodo ICM        ³
//³ [5]=Maior Totalizacao de Periodo IPI        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE nTamNota	:=0
PRIVATE nTamTransp	:=0
PRIVATE nTamPerICM	:=0
PRIVATE nTamPerIPI	:=0 
PRIVATE aTamNotas	:={0,0,0,0,0}
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Especifico para os legislacao Fomentar de Goias ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE cCabNumLiv:= IIf(cNrLivro=="*",Space(9),"- LIVRO "+cNrLivro)
PRIVATE cTitLivro :=AvalFomentar()
cTitLivro         :=If(Empty(cTitLivro)," ",cTitLivro)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define Totalizadores ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE aTotDia     := NIL	// Totalizador diario 
PRIVATE aTotPerICM  := NIL	// Totalizador de periodos de apuracao de ICMS
PRIVATE aTotPerIPI  := NIL	// Totalizador de periodos de apuracao de IPI
PRIVATE aTransp     := NIL	// Totalizador de transporte de pagina
PRIVATE aTotMes     := NIL	// Totalizador Mensal
PRIVATE aTotObs     := NIL	// Totalizador Observação
PRIVATE aResumo     := NIL	// Totalizador para resumo final
PRIVATE aResCFO     := NIL	// Totalizador para resumo por CFO
PRIVATE aResCFOZer  := NIL	// Totalizador para resumo por CFO C/ livro de ICMS Zerado
PRIVATE nTotIcmDeb  :=  0	// Totalizador de ICMS NORMAL+ICMS ST 
PRIVATE npag        :=  1	// Controla impressao manual do cabecalho 

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Cria Arquivo Temporario para Controle de Contribuintes e Nao Contribuintes ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aRegSF3,{"CHAVE"	,"C",100,0})
AADD(aRegSF3,{"CONTR"	,"C",01,0})
AADD(aRegSF3,{"FILIAL"	,"C",nFilchave,0})
AADD(aRegSF3,{"MES"		,"C",02,0})
AADD(aRegSF3,{"ANO"		,"C",04,0})
AADD(aRegSF3,{"RECNOF3"	,"N",10,0})

cArqSF3     := GetNextAlias()
oArqSF3 	:= FwTemporaryTable():New(cArqSF3)

oArqSF3:SetFields(aRegSF3)
oArqSF3:AddIndex("01", {"CONTR", "CHAVE"} )
oArqSF3:AddIndex("02", {"CONTR", "MES", "ANO"} )

oArqSF3:Create()

coArqSF3Na := oArqSF3:GetRealName() //Nome fisico da tabela

If aSX6[MV_IMPSX1] == "S"
	ImpParSX1(STR0001,"MATR930",Tamanho,,.T.) //"Imprime pagina de parametros" 
EndIf

If nModelo==1 .or. nModelo==3 .or. nModelo==5
	If lMatr931
		ExecBlock("MATR931",.F.,.F.)
	Else
		Matr931()
	Endif
Else
	If lMatr932
		ExecBlock("MATR932",.F.,.F.)
	Else
		Matr932()
	Endif
Endif

conout(Alltrim(Str(ThreadID()))+ " - Fim do Processamento:  " + Time())
conout(Alltrim(Str(ThreadID()))+ " - Tempo do Processamento:  " + cValTochar(seconds() - nStart))


FreeObj(oArqSF3)
oArqSF3 := Nil

If lBuild
	FreeObj(oHashColF3)
	oHashColF3 := NIL

	FreeObj(oHashFil)

	FreeObj(oHashPar)
Endif

If lBuildjS
	FreeObj(oNotasjS)
Endif

Return
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                              ³
//³           FUNCOES GENERICAS DOS LIVROS FISCAIS               ³
//³                                                              ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³EmiteLivro³ Autor ³ Juan Jose Pereira             ³ Data ³ 13/12/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Gera arquivo temporario com lancamentos do SF3 que deverao ser      ³±±
±±³          ³ser lancados nos registros de entradas e saidas                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³cArqTemp:=EmiteLivro(cMov,cDtIni,dDtFim,lLacuna,lServico,cNrLivro,  ³±±
±±³          ³          cFiltroUser)                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³parametros³cArqTemp:=Alias/Nome do Arquivo gerado                              ³±±
±±³          ³cMov:="E"ntradas / "S"aidas                                         ³±±
±±³          ³dDtIni:=Data de Inicio dos Lancamentos                              ³±±
±±³          ³dDtFim:=Data de Fim dos Lancamentos                                 ³±±
±±³          ³lLacuna:=Lanca notas canceladas/nao lancadas/excluidas              ³±±
±±³          ³lServico:=Lanca notas de Servico                                    ³±±
±±³          ³cNrLivro:=Numero do Livro lancado , (*) Todos - FOMENTAR            ³±±
±±³          ³cFiltroUser:=Filtro criado pelo usuario para o SF3                  ³±±
±±³          ³cArqCiap:=Arquivo Ciap                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function EmiteLivro(	cMov	,	dDtIni	,	dDtFim	,	lLacuna	,	;
						lServico,lDesconto	,cNrLivro	,cFilterUser,	;
						cArqCiap,nTotIcmsEnt,nLacuna	,nProcFil	,	;
						cFilDe	,cFilAte	,nSubDiv	,cChamOrig, MVIsento, LLEIECF, lConjugada)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define Variaveis                                             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Local aCampos     	:=	{}
Local aLivro      	:=	{}
Local aFixos      	:=	MatXAfixos()
Local aSeries     	:=	{}
Local aStruSf3		:=	{}
Local aArea			:= 	{}
Local aAreaSM0	 	:= 	SM0->(GetArea())
Local aProcessa		:= 	{}
Local aFilsCalc  	:= 	{}
Local aMapaResumo	:= 	{}							   		// Informacoes do Mapa Resumo
Local aGravaMapRes	:= 	{}							   		// Registros a serem informados no Mapa Resumo
Local aSd1			:=	{}
Local aAtacNCIPI    :=  {}

Local cCliente    	:=	""
Local cLoja       	:=	""
Local cFiltro     	:=	""
Local cChave	  	:=	""
Local cArqIndxF3  	:=	""
Local cIndxTemp1  	:=	""
Local cIndxTemp2  	:=	""
Local cLivros     	:=	""
Local cLivrEP     	:=	aSX6[MV_LIVRESP]
Local cNFIni      	:=	""
Local cNFFim      	:=	""
Local cEst        	:=	""
Local cEsp        	:=	""
Local cSer		  	:=	""	
Local cCFO        	:=	""
Local cFormula	  	:=	""
Local cQuery		:=	""
Local cAliasSf3		:=	"SF3"
Local cFilProc		:= 	""
Local cSerNf        :=  ""                              	// Serie da Nota Fiscal sobre Cupom
Local cNfCup        :=  ""                              	// Numero da Nota Fiscal sobre Cupom
Local cNumNota		:= 	""
Local cTipoEsp      :=  ""                              	// Especie do registro na SF3
Local cTipoSF2      :=  ""                              	// Especie do registro na SF2
Local cChaveSD1 	:=	""
Local cObserv		:=	""
Local cMvCFTR930	:= aSX6[MV_CFTR930]

Local i           	:=	0
Local j           	:=	0
Local nPos        	:=	0
Local nI          	:=	0
Local nx          	:=	0
Local nAliq       	:=	0
Local nMesIni		:= 	0
Local nAnoIni		:= 	0
Local nMesFim		:= 	0
Local nAnoFim		:= 	0       
Local nPosi			:= 	0
Local nMesAux		:= 	0
Local nSf3			:=	0
Local nF3FCount		:=	0
Local nProc			:= 	0
Local nPosFil		:= 	0
Local nTamNF		:= 	0   
	
Local nTamSerie		:= SerieNfId("SF2",6,"F2_SERIE")// Tamanho da serie da Nota Fiscal sobre Cupom

Local lCanc       	:=	.F.
Local lExist      	:=	.F.
Local lMapResumo	:= 	.F.	// Se trabalha com Mapa Resumo
Local lFisLivro		:= 	.F.	// Conteudo do parametro MV_LJLVFIS
Local lImpEcf 		:= 	.T.	// Se trabalha com lei ECF
Local lATACNCIPI    :=  Iif(lTop, .T., .F.) //---Indicador de campo na query que demonstra operação com atacadista não contribuinte de IPI---//
Local lLFICMZER     :=  Iif(lTop, .T., .F.) //---Indicador de campo na query que demonstra operação com Livro ICM Zerado---//
Local lLFIPIZER     :=  Iif(lTop, .T., .F.) //---Indicador de campo na query que demonstra operação com Livro IPI Zerado---//
Local lF3CREDST     :=  Iif(lTop, .T., .F.)

Local dDtCanc     	:=	""
Local dDtCan1     	:=	""

Local cVlCtbZL		:= aSX6[MV_VLCTBZL]

Local lVldFil		:= .F.
Local lSelFil   	:= Iif(Type("MV_PAR40")== "N",iif(mv_par40==1,.T.,.F.),.F.)
Local cChvEmiL      := ""
Local lLei_ECF   := if( ValType(lLeiECF) == "L", lLeiECF, .F. )
Local lVldLeiECF := Iif(Alltrim(cChamOrig) == "MATR921",.F.,.T.)
Local cChaveSFT		:= ""
Local cCredST		:= ""
Local nFilchave		:= FWSizeFilial()
Local aCampF3		:= {}
Local aCmpF1F2		:= {}
Local cCpoSF3       := ""

Private cArqTemp  	:= ""
Private cNomeArq	:= ""
Private cCampos		:= ""

//
Default nLacuna		:=	2
Default nTotIcmsEnt	:=	2
Default nProcFil	:=  2
Default cFilDe		:= 	cFilAnt
Default cFilAte		:= 	cFilAnt
Default cChamOrig	:= 	""
Default nSubDiv		:= 	1
Default MVIsento	:= 	2
Default LLEIECF     := .F.
Default lConjugada  := .F.

If Type("lLisIsenta") == "U" .And. MVIsento <> 1
	lLisIsenta := .F.
Else
	lLisIsenta := .T.
Endif

lExist     	:=	IIF(SF3->F3_OBSSOL>0,.T.,.F.)
aStruSf3	:=	SF3->(DbStruct ())
nF3FCount	:=	SF3->(FCount ())

If aSX6[MV_LJLVFIS]== 2
	If MaxRVerFunc(cChamOrig)
		lFisLivro	:= .T.
	EndIf
EndIf

If lFisLivro
	If Alltrim(cChamOrig) == "MATR930"
		If mv_par37 == 1
		  Aviso(STR0025,STR0095) 
		Endif 
		lMapResumo	:= .F.  // IIF(mv_par37 == 1,.T.,.F.)
	ElseIf Alltrim(cChamOrig) == "MATR921"
		lMapResumo	:= IIF(mv_par14 == 1,.T.,.F.)
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Cria Arquivo CIAP Temporario                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lEmiteCiap
	dbSelectArea("SF9")
   If ( cArqCiap != NIL ) .And. Select("SF9") > 0
      
	 // __LocalDriver := "CTREECDX"

	  cArqCiap := CriaTrab({{"SF3","N",14,0},{"SF9","N",14,0}})
	  dbUseArea(.T.,,cArqCiap,"CIAP",.T.,.F.)
	  IndRegua("CIAP",cArqCiap,"SF3")

	 //__LocalDriver := _RDD_
	  
   EndIf
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Cria Arquivo Temporario                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cCampos:=   "F3_FILIAL|F3_CLIEFOR|F3_LOJA|F3_NFISCAL|F3_SERIE|F3_EMISSAO|F3_ENTRADA|F3_CFO|F3_NRLIVRO|F3_DTCANC|F3_FORMUL|
cCampos+=   "F3_NUMINI|F3_NUMFIM|F3_TIPO|F3_VALCONT|F3_ESPECIE|F3_IDENTFT|F3_OBSERV|F3_FORMULA|F3_CODRSEF|F3_ESTADO|
cCampos+=   "F3_BASEICM|F3_ALIQICM|F3_VALICM|F3_OUTRICM|F3_ISENICM|F3_CREDST|F3_OBSSOL|F3_BASNDES|F3_ICMNDES|F3_OBSICM|
cCampos+=   "F3_BASERET|F3_ICMSRET|F3_DIFAL|F3_VFCPDIF|F3_VL43080|F3_VLINCMG|F3_VALANTI|F3_CLIDVMC|F3_DS43080|F3_SERSAT|
cCampos+=   "F3_DOCOR|F3_OUTRIPI|F3_BASEIPI|F3_VALIPI|F3_ISENIPI|F3_IPIOBS|F3_VALOBSE|F3_ICMSCOM|F3_ICMAUTO|F3_VALTST|
cCampos+=   "F3_VALFECP|F3_VFECPST|F3_CRPRST|F3_VALFUN|F3_VLSENAR|F3_PDV|F3_MDCAT79|F3_LOJDVMC|F3_DESCZFR|F3_VFECPRN|
cCampos+=   "F3_VFESTRN|F3_VFESTMG|F3_VFECPMG|F3_CLIENT|F3_LOJENT|

aCampF3 := FWSX3Util():GetListFieldsStruct(cAliasSf3 , .F. )

For nX := 1 to Len(aCampF3)
	IF (aCampF3[nX][1]) $ cCampos
		AADD(aCampos,{aCampF3[nX][1],aCampF3[nX][2],aCampF3[nX][3],aCampF3[nX][4]}) 
	ElseIF aCampF3[nX][2] != "M" .And. aCampF3[nX][1] $ AllTrim(cFilterUser)
		cCpoSF3 += "SF3."+aCampF3[nX][1]+"," 
	Endif
Next

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Campo auxiliar para corrigir numeracao nas lacunas           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aCampos,{"NUMNOTA","C",nTamF2DOC,0})
AADD(aCampos,{"FILCORR","C", nFilchave,0})

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Para inserir os periodos sem movimento³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aCampos,{"SEMMOV" ,"L",1,0})

//---Campos auxiliares que informam Livro Zerado---//
AADD(aCampos,{"LFICMZER","N",1,0})
AADD(aCampos,{"LFIPIZER","N",1,0})
AADD(aCampos,{"LCIAP","N",1,0})
AADD(aCampos,{"RECNOSF3","N",15,0})
AADD(aCampos,{"COUNTF3","N",4,0})

//Dados Participante
AADD(aCampos,{"CONTRIB","C",1,0})
AADD(aCampos,{"INSCR","C",18,0})
AADD(aCampos,{"INSCRUR","C",18,0})
AADD(aCampos,{"TIPO","C",1,0})
AADD(aCampos,{"TPJ","C",1,0})
AADD(aCampos,{"EST","C",2,0})
AADD(aCampos,{"CONTA","C",TamSX3("A1_CONTA")[1],0})
AADD(aCampos,{"CGC","C",TamSX3("A1_CGC")[1],0})
AADD(aCampos,{"COD","C",TamSX3("A1_COD")[1],0})
AADD(aCampos,{"LOJA","C",TamSX3("A1_LOJA")[1],0})

//Dados da nota (SF1 ou SF2)
If nModelo==1 .Or. nModelo==2
	aCmpF1F2 := TamSX3("F1_CONTSOC")
	AADD(aCampos,{"CONTSOC",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
	
	aCmpF1F2 := TamSX3("F1_VLSENAR")
	AADD(aCampos,{"VLSENAR",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
	
	aCmpF1F2 := TamSX3("F1_INSS")
	AADD(aCampos,{"INSS",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
Else
	aCmpF1F2 := TamSX3("F2_CONTSOC")
	AADD(aCampos,{"CONTSOC",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
	
	aCmpF1F2 := TamSX3("F2_VLSENAR")
	AADD(aCampos,{"VLSENAR",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
	
	aCmpF1F2 := TamSX3("F2_VALINSS")
	AADD(aCampos,{"INSS",aCmpF1F2[3],aCmpF1F2[1],aCmpF1F2[2]})
Endif

cArqTemp:=CriaTrab(Nil,.F.)

// Cria a tabela 
//cArqTemp := "MATR_SC"+AllTrim(GetNextAlias())
DbCreate(cArqTemp,aCampos,"CTREECDX" )

//__LocalDriver := "CTREECDX"
dbUseArea(.T.,"CTREECDX",cArqTemp,cArqTemp,.T.,.F.)
//__LocalDriver := _RDD_

If cMov == "S"
	cIndxTemp1:=Substr(CriaTrab(NIL,.F.),1,7)+"A"
	cIndxTemp2:=Substr(CriaTrab(NIL,.F.),1,7)+"B"
	cIndxTemp3:=Substr(CriaTrab(NIL,.F.),1,7)+"C"
	cChave:="F3_FILIAL+F3_SERIE+NUMNOTA+STR(F3_ALIQICM,5,2)+F3_CFO+F3_FORMULA"
	IndRegua(cArqTemp,cIndxTemp1,cChave,,,STR0019) //"Buscando Nts.Canceladas..."
	cChave:="F3_SERIE+F3_TIPO+F3_DOCOR+F3_FILIAL"
	IndRegua(cArqTemp,cIndxTemp2,cChave,,,STR0019) //"Buscando Nts.Canceladas..."
	cChave:="F3_SERIE+NUMNOTA+F3_FILIAL"
	IndRegua(cArqTemp,cIndxTemp3,cChave,,,STR0019) //"Buscando Nts.Canceladas..."
	dbClearIndex()
	DbSetIndex(cIndxTemp1+OrdBagExt())
	DbSetIndex(cIndxTemp2+OrdBagExt())
	DbSetIndex(cIndxTemp3+OrdBagExt())	
	dbSetOrder(1)
EndIf	                              

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o processamento e centralizado, imprimindo mais de uma filial³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

// Alterado para que seja possivel selecionar filial mesmo se o parametro Processa Filiais = Nao
lVldFil:= Iif(AllTrim(cChamOrig)=="MATR921",.F.,lSelFil)

If lVldFil  //Selecina Filiais
	//Alterado para passar por todas a Filiais uma vez que 
	//será tratado dentro do processamento somente as filiais
	//Selecionadas
	aFilsCalc   := MatFilCalc(.T.,,,mv_par46 == 1,,2)
	cFilDe 	:=  padr("", nFilchave)
	cFilAte	:=  Replicate("Z", nFilchave)
ELSEIf nProcFil <> 1
	cFilDe 	:= cFilAnt
	cFilAte	:= cFilAnt
Endif      

lImpEcf := lLei_ECF        

SM0->(MSSeek(cEmpAnt+cFilDe,.T.))

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Imprime atraves das filiais selecionadas para o processamento³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do While !SM0->(Eof()) .and. FWGrpCompany()+FWCodFil() <= cEmpAnt+cFilAte 

	cFilAnt	:= FWCodFil() 
	
	                         
	//Tratamento de Selecao de Filiais
	If /*nProcFil == 1 .and. */If(AllTrim(cChamOrig)=='MATR921',.F., lSelFil)
		nPosFil := aScan( aFilsCalc, {|x| AllTrim(x[2]) == Alltrim(cFilAnt) } )
		If nPosFil == 0 //Nao achei a filial corrente no tratamento de filiais (verificando direitos de acesso
			SM0->( dbSkip() ) 
			Loop
		Else
			If !aFilsCalc[nPosFil,1] //A Filial corrente nao foi selecinada
				SM0->( dbSkip() ) 
				Loop
			EndIf
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atendimento ao Art. 121 do ANEXO 5 do RICMS/SC. O mesmo determina que todo prestador de                    ³
	//³  serviço de transporte deve apresentar as obrigações acessórias de forma consolidada pelo estabelecimento ³
	//³  matriz, e esta consolidação deverá abranger somente as empresas que estiverem domiciliadas no mesmo      ³
	//³  estado do estabelecimento consolidador.                                                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lConsUF .And. (SM0->M0_ESTENT<>cMV_ESTADO)
		SM0->(DbSkip ())
		Loop
	EndIf
	

	//Atualiza Parametros para Filial em processamento
	aSX6	  :=	R930LoadX6()
	//Foi acrescentado o tratamento abaixo para considerar o MV_ESTADO da Filial corrente.                             
	cMV_ESTADO := aSX6[MV_ESTADO]
	// Sera verificada a configuracao do parametro para cada uma das filiais
	cLivrEP := aSX6[MV_LIVRESP]

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Prepara SF3 para extracao de dados                           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cAliasSf3 := "SF3"
	dbSelectArea (cAliasSf3)	

	//
	#IFDEF TOP
		cAliasSf3	:=	"EmiteLivro"
		cCampos := "SF3.F3_FILIAL, SF3.F3_CLIEFOR, SF3.F3_LOJA, SF3.F3_NFISCAL, SF3.F3_SERIE, SF3.F3_EMISSAO, SF3.F3_ENTRADA, SF3.F3_CFO, SF3.F3_NRLIVRO, SF3.F3_DTCANC, SF3.F3_FORMUL,"
		cCampos += "SF3.F3_NUMINI, SF3.F3_NUMFIM, SF3.F3_TIPO, SF3.F3_VALCONT, SF3.F3_ESPECIE, SF3.F3_IDENTFT, SF3.F3_OBSERV, SF3.F3_FORMULA, SF3.F3_CODRSEF, SF3.F3_ESTADO,"		
        cCampos += "SF3.F3_BASEICM, SF3.F3_ALIQICM, SF3.F3_VALICM, SF3.F3_OUTRICM, SF3.F3_ISENICM, SF3.F3_CREDST, SF3.F3_OBSSOL, SF3.F3_BASNDES, SF3.F3_ICMNDES, SF3.F3_OBSICM,  "
		cCampos += "SF3.F3_BASERET, SF3.F3_ICMSRET, SF3.F3_DIFAL, SF3.F3_VFCPDIF, SF3.F3_VL43080, SF3.F3_VLINCMG, SF3.F3_VALANTI, SF3.F3_CLIDVMC, SF3.F3_DS43080, SF3.F3_SERSAT, "
		cCampos += " SF3.F3_DOCOR, SF3.F3_OUTRIPI, SF3.F3_BASEIPI, SF3.F3_VALIPI, SF3.F3_ISENIPI, SF3.F3_IPIOBS, SF3.F3_VALOBSE, SF3.F3_ICMSCOM, SF3.F3_ICMAUTO, SF3.F3_VALTST,  "
		cCampos += "SF3.F3_VALFECP, SF3.F3_VFECPST, SF3.F3_CRPRST, SF3.F3_VALFUN, SF3.F3_VLSENAR, SF3.F3_PDV, SF3.F3_MDCAT79, SF3.F3_LOJDVMC, SF3.F3_DESCZFR, SF3.F3_VFECPRN,  "
		cCampos += " SF3.F3_VFESTRN, SF3.F3_VFESTMG,SF3.F3_VFECPMG,SF3.F3_CLIENT,SF3.F3_LOJENT, SA1.A1_CONTRIB, SA1.A1_INSCR, SA1.A1_TIPO, SA1.A1_CGC, SA1.A1_EST, SA1.A1_CONTA, SA1.A1_COD, SA1.A1_LOJA, SA1.A1_TPJ, SA1.A1_INSCRUR, SA2.A2_CONTRIB, SA2.A2_INSCR, SA2.A2_TIPO, SA2.A2_CGC, SA2.A2_EST, SA2.A2_CONTA, SA2.A2_COD, SA2.A2_LOJA,"
		cCampos += "ISNULL(SFTQRY.QATACNCIPI,0) QATACNCIPI, ISNULL(SFTQRY.QLFICMZER,0) QLFICMZER, ISNULL(SFTQRY.QLFIPIZER,0) QLFIPIZER, "

		cCampos += cCpoSF3

		IF lEmiteCiap
			cCampos +=  " ISNULL(SF9QRY.QLCIAP,0) QLCIAP,"			
		Endif

		If nModelo==1 .Or. nModelo==2
			cCampos	+= "SF1.F1_CONTSOC CONTSOC, SF1.F1_VLSENAR VLSENAR, SF1.F1_INSS INSS, "
		Else
			cCampos	+= "SF2.F2_CONTSOC CONTSOC, SF2.F2_VLSENAR VLSENAR, SF2.F2_VALINSS INSS, SF2.F2_ESPECIE, SF2.F2_NFCUPOM, "
		EndIf

		cCampos +=  " SF3.R_E_C_N_O_ AS RECNOSF3, "
		cCampos +=  "(CASE WHEN F3_IDENTFT <> '000001' THEN 2 ELSE (SELECT COUNT(*) FROM "+RetSqlName ("SF3")+" SF32 WHERE SF32.F3_FILIAL= SF3.F3_FILIAL AND SF32.F3_NFISCAL = SF3.F3_NFISCAL AND SF32.F3_SERIE = SF3.F3_SERIE AND  SF32.F3_CLIEFOR = SF3.F3_CLIEFOR AND SF32.F3_LOJA = SF3.F3_LOJA AND SF32.D_E_L_E_T_ = ' ')END) COUNTF3" //Conta quando registros existem da SF3 para evitar fazer soma

		cQuery		:=	"SELECT "
		cQuery		+=	cCampos+" FROM "+RetSqlName ("SF3")+" SF3 "

		cQuery		+=	" LEFT OUTER JOIN (SELECT SFT.FT_FILIAL, SFT.FT_TIPOMOV, SFT.FT_CLIEFOR, SFT.FT_LOJA, SFT.FT_SERIE, SFT.FT_NFISCAL, SFT.FT_CFOP, " 
		cQuery		+=	"                         SUM(CASE WHEN SF4.F4_IPI = 'R' AND SF4.F4_LFIPI = 'O' THEN 1 ELSE 0 END) QATACNCIPI, "
		cQuery		+=	"                         SUM(CASE WHEN SF4.F4_LFICM = 'Z' THEN 1 ELSE 0 END) QLFICMZER, "
		cQuery		+=	"                         SUM(CASE WHEN SF4.F4_LFIPI = 'Z' THEN 1 ELSE 0 END) QLFIPIZER "
		cQuery		+=	"                  FROM "+RetSqlName("SFT")+" SFT INNER JOIN "+RetSqlName("SF4")+" SF4 ON (SF4.F4_FILIAL = '"+ xFilial("SF4") +"' AND SF4.F4_CODIGO = SFT.FT_TES AND SF4.D_E_L_E_T_ = '') "
		cQuery		+=	"                  WHERE SFT.FT_FILIAL = '"+ xFilial("SFT") +"' AND " 
		cQuery		+=	"                  SFT.D_E_L_E_T_ = ' ' "
		cQuery		+=	"                  GROUP BY SFT.FT_FILIAL, SFT.FT_TIPOMOV, SFT.FT_CLIEFOR, SFT.FT_LOJA, SFT.FT_SERIE, SFT.FT_NFISCAL, SFT.FT_CFOP) SFTQRY ON (SFTQRY.FT_FILIAL = '"+ xFilial("SFT") +"' AND SFTQRY.FT_TIPOMOV = CASE WHEN SUBSTRING(SF3.F3_CFO,1,1)<'5' THEN 'E' ELSE 'S' END AND SFTQRY.FT_CLIEFOR = SF3.F3_CLIEFOR AND SFTQRY.FT_LOJA = SF3.F3_LOJA AND SFTQRY.FT_SERIE = SF3.F3_SERIE AND SFTQRY.FT_NFISCAL = SF3.F3_NFISCAL AND SFTQRY.FT_CFOP = SF3.F3_CFO) " 
		
		//Valida se existe CIAP a ser processado
		IF lEmiteCiap
			cQuery		+=	" LEFT OUTER JOIN (SELECT SF9.F9_FILIAL, SF9.F9_DTENTNE, SF9.F9_DOCNFE, SF9.F9_SERNFE, SF9.F9_FORNECE, SF9.F9_LOJAFOR, SF9.F9_CFOENT,  "
			cQuery		+=	"                  SUM(CASE WHEN SF9.F9_DOCNFE <> '' THEN 1 ELSE 0 END) QLCIAP "
			cQuery		+=	"                  FROM "+RetSqlName("SF9")+" SF9 "
			cQuery		+=	"                  WHERE SF9.F9_FILIAL = '"+ xFilial("SF9") +"' AND " 
			cQuery		+=	"                  SF9.D_E_L_E_T_ = ' ' "
			cQuery		+=	"                  GROUP BY SF9.F9_FILIAL, SF9.F9_DTENTNE, SF9.F9_DOCNFE, SF9.F9_SERNFE, SF9.F9_FORNECE, SF9.F9_LOJAFOR, SF9.F9_CFOENT) SF9QRY "
			cQuery		+=	"ON (SF9QRY.F9_FILIAL = '"+ xFilial("SF9") +"' AND SF9QRY.F9_DTENTNE = SF3.F3_ENTRADA AND SF9QRY.F9_DOCNFE = SF3.F3_NFISCAL AND SF9QRY.F9_SERNFE = SF3.F3_SERIE AND SF9QRY.F9_FORNECE = SF3.F3_CLIEFOR AND SF9QRY.F9_LOJAFOR = SF3.F3_LOJA AND SF9QRY.F9_CFOENT = SF3.F3_CFO) " 
		Endif				

		cQuery	+=	" LEFT JOIN "+RetSqlName("SA1")+" SA1 ON SA1.A1_FILIAL='"+xFilial("SA1")+"' AND SA1.A1_COD=SF3.F3_CLIEFOR AND "
		cQuery	+=	" SA1.A1_LOJA=SF3.F3_LOJA AND SA1.D_E_L_E_T_=' '"
		cQuery	+=	" LEFT JOIN "+RetSqlName("SA2")+" SA2 ON SA2.A2_FILIAL='"+xFilial("SA2")+"' AND SA2.A2_COD=SF3.F3_CLIEFOR AND "
		cQuery	+=	" SA2.A2_LOJA=SF3.F3_LOJA AND SA2.D_E_L_E_T_=' '"
		
		If nModelo==1 .Or. nModelo==2
			cQuery	+= "LEFT JOIN "+RetSqlName("SF1")+" SF1 ON(SF1.F1_FILIAL='"+xFilial("SF1")+"'  AND SF1.F1_DOC=SF3.F3_NFISCAL AND SF1.F1_SERIE=SF3.F3_SERIE AND SF1.F1_FORNECE=SF3.F3_CLIEFOR AND SF1.F1_LOJA=SF3.F3_LOJA AND SF1.D_E_L_E_T_=' ') "
		Else
			cQuery	+= "LEFT JOIN "+RetSqlName("SF2")+" SF2 ON(SF2.F2_FILIAL='"+xFilial("SF2")+"'  AND SF2.F2_DOC=SF3.F3_NFISCAL AND SF2.F2_SERIE=SF3.F3_SERIE AND SF2.F2_CLIENTE=SF3.F3_CLIEFOR AND SF2.F2_LOJA=SF3.F3_LOJA AND SF2.D_E_L_E_T_=' ') "
		EndIf
	

		cQuery		+=	" WHERE "
		
		If FWModeAccess("SF3",3)=="C" .And. lF3MsFil
			cQuery		+=	"SF3.F3_MSFIL='"+cFilAnt+"' AND "
		Else	
			cQuery		+=	"SF3.F3_FILIAL='"+xFilial ("SF3") + "' AND "
		EndIf
		
		IF (aSX6[MV_LFMD2DT]) .And. cMov == "S"
			cQuery  += "SF3.F3_EMISSAO>='"+DTOS (dDtIni)+"' AND SF3.F3_EMISSAO<='"+DTOS (dDtFim)+"' AND "
		Else
			cQuery  += "SF3.F3_ENTRADA>='"+DTOS (dDtIni)+"' AND SF3.F3_ENTRADA<='"+DTOS (dDtFim)+"' AND "		
		EndIf
		cQuery      += "SF3.D_E_L_E_T_=' ' "
		//
		If (cMov=="E")
			If nSubDiv == 1
				cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1)<'5' "
			ElseIf nSubDiv == 2                                 
				cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1)='1' "
			ElseIf nSubDiv == 3
				cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1) IN ('2','3') "
			Endif
			If !Empty(cMvCFTR930)
				cQuery	+=	" AND SF3.F3_CFO NOT IN ("+ cMvCFTR930 +") "
			EndIf
		    If !lServico .And. !lConjugada		
				cQuery	+=	" AND SF3.F3_TIPO<>'S' "
			ElseIf !lServico .And. lConjugada
				cQuery	+=	" AND (SF3.F3_TIPO='S' AND SUBSTRING(SF3.F3_CFO,2,3) = '933' AND SF3.F3_ESPECIE IN ('NFE','SPED') OR SF3.F3_TIPO<>'S') "			
			Endif
			If (cNrLivro!="*")
				cQuery	+=	" AND SF3.F3_NRLIVRO='"+cNrLivro+"' "
			Else
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Filtra notas de Entrada de Ativo p/ Ceara "MV_LIVRESP"       ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cQuery	+=	" AND SF3.F3_NRLIVRO<>'"+cLivrEP+"' "
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera notas canceladas quando considerar lacuna.³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !(lLacuna)
				cQuery	+=	" AND NOT (SF3.F3_DTCANC<>'' AND SF3.F3_FORMUL='S') "
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera operacoes isentas - MV_PAR22 - Imp. Op. Isentas ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   
			If !lLisIsenta
				cQuery  +=  " AND F3_ISENICM <= 0 "
			EndIf
		Else
			If !(lEntrada)
				If nSubDiv == 1
					cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1)>='5' "
				ElseIf nSubDiv == 2                                 
					cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1)='5' "
				ElseIf nSubDiv == 3
					cQuery	+=	" AND SUBSTRING(SF3.F3_CFO,1,1) IN ('6','7') "
				Endif
			Else
				If nSubDiv == 1
					cQuery	+=	" AND (SUBSTRING(SF3.F3_CFO,1,1)>='5' OR SF3.F3_FORMUL='S') "
				ElseIf nSubDiv == 2                                 
					cQuery	+=	" AND (SUBSTRING(SF3.F3_CFO,1,1)='5' OR (SF3.F3_FORMUL='S' AND SUBSTRING(SF3.F3_CFO,1,1)='1')) "
				ElseIf nSubDiv == 3
					cQuery	+=	" AND (SUBSTRING(SF3.F3_CFO,1,1) IN ('6','7') OR (SF3.F3_FORMUL='S' AND SUBSTRING(SF3.F3_CFO,1,1) IN ('2','3'))) "
				Endif
			Endif   
			If !Empty(cMvCFTR930)
					cQuery	+=	" AND SF3.F3_CFO NOT IN ("+ cMvCFTR930 +") "
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera operacoes isentas - MV_PAR22 - Imp. Op. Isentas ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   
			If !lLisIsenta
				cQuery  +=  " AND F3_ISENICM <= 0 "
			EndIf
			//
			If !(lServico) .And. !lConjugada
				cQuery	+=	" AND SF3.F3_TIPO<>'S' "
			ElseIf !lServico .And. lConjugada
				cQuery	+=	" AND (SF3.F3_TIPO='S' AND SUBSTRING(SF3.F3_CFO,2,3) = '933' AND SF3.F3_ESPECIE IN ('NFE','SPED') OR SF3.F3_TIPO<>'S') "			
			Endif
			//
			If (lMapResumo .AND. !lAglutina) .or. Iif(lVldLeiECF,(!lMapResumo .and. !lLei_ECF),.F.)
				cQuery	+=	"AND SF3.F3_ESPECIE NOT IN ('ECF','CF','SATCE') "
			EndIf

			If (cNrLivro!="*")
				cQuery	+=	" AND SF3.F3_NRLIVRO='"+cNrLivro+"' "
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera notas canceladas quando campo considerar lacuna = Não.³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !(lLacuna)
				cQuery	+= " AND NOT (SF3.F3_DTCANC<>'') "
			Endif
		Endif
		//   
	  
		If !lNFInutil
			cQuery	+=	" AND SF3.F3_CODRSEF <> '102'"
		Endif
		
		If FWModeAccess("SF3",3)=="C" .And. lF3MsFil
			cQuery	+=	" ORDER BY SF3.F3_MSFIL, SF3.F3_ENTRADA, SF3.F3_SERIE, SF3.F3_NFISCAL, SF3.F3_CFO "
		Else	
			cQuery	+=	" ORDER BY SF3.F3_FILIAL, SF3.F3_ENTRADA, SF3.F3_SERIE, SF3.F3_NFISCAL, SF3.F3_CFO "
		EndIf
		//
		cQuery 	:= 	ChangeQuery (cQuery)
	    //
		DbUseArea (.T., "TOPCONN", TcGenQry (,,cQuery), cAliasSf3, .T., .T.)
		//
		For nSF3 := 1 To (Len (aStruSF3))
			If (aStruSF3[nSF3][2]<>"C") //.And. (Fieldpos(aStruSF3[nSF3][1]) > 0)
				TcSetField (cAliasSf3, aStruSF3[nSF3][1], aStruSF3[nSF3][2], aStruSF3[nSF3][3], aStruSF3[nSF3][4])
			EndIf
		Next (nSF3)
	#ELSE
		If cMov=="E"
			If FWModeAccess("SF3",3)=="C" .And. lF3MsFil
				cFiltro:="F3_MSFIL=='"+cFilAnt+"'.AND.DTOS(F3_ENTRADA)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_ENTRADA)<='"+DTOS(dDtFim)+"' "	
			Else	
				cFiltro:="F3_FILIAL=='"+xFilial()+"'.AND.DTOS(F3_ENTRADA)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_ENTRADA)<='"+DTOS(dDtFim)+"' "	
			EndIf
			
			If nSubDiv == 1
			    cFiltro +=  ".AND. F3_CFO<'500"+SPACE(LEN(F3_CFO)-3)+"' "
			ElseIf nSubDiv == 2                                          
				cFiltro +=  ".AND. SUBSTR(F3_CFO,1,1) == '1' "
			ElseIf nSubDiv == 3
				cFiltro +=  ".AND. SUBSTR(F3_CFO,1,1) $ '23' "
			Endif
			If !Empty(cMvCFTR930)
				cFiltro	+=	" .AND. !SF3.F3_CFO $ ("+ cMvCFTR930 +") "
			EndIf
			//Notas de servico nao devem sair no reg. de entradas
				cFiltro	+=	".AND.F3_TIPO!='S' "
			If cNrLivro!="*"
				cFiltro	+=	".AND.F3_NRLIVRO=='"+cNrLivro+"' "
			Else
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Filtra notas de Entrada de Ativo p/ Ceara "MV_LIVRESP"       ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cFiltro	+=	".AND.F3_NRLIVRO<>'"+cLivrEP+"' "
			Endif   

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera operacoes isentas - MV_PAR22 - Imp. Op. Isentas ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ    
			If !lLisIsenta
				cFiltro  +=  " .AND. F3_ISENICM <= 0 "
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera notas canceladas quando considerar lacuna.³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !(lLacuna)
				cFiltro	+=	".AND. !(!Empty (F3_DTCANC) .AND. F3_FORMUL=='S') "
			Endif
		Else
			If FWModeAccess("SF3",3)=="C" .And. lF3MsFil
				IF !(aSX6[MV_LFMD2DT])
					cFiltro:="F3_MSFIL=='"+cFilAnt+"'.AND.DTOS(F3_ENTRADA)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_ENTRADA)<='"+DTOS(dDtFim)+"' "	
				Else
					cFiltro:="F3_MSFIL=='"+cFilAnt+"'.AND.DTOS(F3_EMISSAO)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_EMISSAO)<='"+DTOS(dDtFim)+"' "	
				EndIf
			Else	
				IF !(aSX6[MV_LFMD2DT])
					cFiltro:="F3_FILIAL=='"+xFilial()+"'.AND.DTOS(F3_ENTRADA)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_ENTRADA)<='"+DTOS(dDtFim)+"' "	
				Else
					cFiltro:="F3_FILIAL=='"+xFilial()+"'.AND.DTOS(F3_EMISSAO)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_EMISSAO)<='"+DTOS(dDtFim)+"' "	
				EndIf
			EndIf
			
			If !lEntrada
				If nSubDiv == 1
			        cFiltro +=  ".AND. F3_CFO>='500"+SPACE(LEN(F3_CFO)-3)+"' "
			 	ElseIf nSubDiv == 2
			 		cFiltro +=  ".AND. SUBSTR(F3_CFO,1,1) == '5' "
			 	ElseIf nSubDiv == 3                           
			 		cFiltro +=  ".AND. SUBSTR(F3_CFO,1,1) $ '67' "
			 	Endif
			Else     
				If nSubDiv == 1
			        cFiltro +=  ".AND.(F3_CFO>='500"+SPACE(LEN(F3_CFO)-3)+"' .OR.F3_FORMUL=='S') "
			 	ElseIf nSubDiv == 2                                                               
			 		cFiltro +=  ".AND.(SUBSTR(F3_CFO,1,1)=='5' .OR. (SUBSTR(F3_CFO,1,1)=='1' .AND. F3_FORMUL=='S')) "
			 	ElseIf nSubDiv == 3                                                                              
			 		cFiltro +=  ".AND.(SUBSTR(F3_CFO,1,1) $ '67' .OR. (SUBSTR(F3_CFO,1,1)$'23' .AND. F3_FORMUL=='S')) "
			 	Endif
			Endif
			If !Empty(cMvCFTR930)
				cFiltro	+=	" .AND. !SF3.F3_CFO $ ("+ cMvCFTR930 +") "
			EndIf
			If !lServico
				cFiltro	+=	".AND.F3_TIPO!='S'"
			Endif
			
			If  (lMapResumo .AND. !lAglutina) .or. Iif(lVldLeiECF,(!lMapResumo .and. !lLei_ECF),.F.)
				cFiltro	+=	".AND. !(AllTrim(F3_ESPECIE) $ 'ECF/CF') "			
			EndIf
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Desconsidera operacoes isentas - MV_PAR22 - Imp. Op. Isentas ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ    
			If !lLisIsenta
				cFiltro  +=  " .AND. F3_ISENICM <= 0 "
			EndIf
			If cNrLivro!="*"
				cFiltro	+=	".AND.F3_NRLIVRO=='"+cNrLivro+"'"
			Endif		
		Endif

		If FWModeAccess("SF3",3)=="C" .And. lF3MsFil
			cChave		:=	"F3_MSFIL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO"
		Else	
			cChave		:=	"F3_FILIAL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO"
		EndIf
		
		cArqIndxF3	:=	CriaTrab(NIL,.F.)
		IndRegua ("SF3", cArqIndxF3, cChave,, cFiltro, STR0020) //"Filtrando registros..."
		//
		dbClearIndex ()
		dbSetIndex (cArqIndxF3+OrdBagExt ())
	#ENDIF

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica os meses a processar. Caso seja necessario imprimir mais de um mes                     ³
	//³e entre os meses exista algum sem movimento, devera ser impressa a descricao de "SEM MOVIMENTO".³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nMesIni	:= Month(dDtIni)
	nAnoIni	:= Year(dDtIni)
	nMesFim	:= Month(dDtFim)
	nAnoFim	:= Year(dDtFim)
	nMesAux := nMesFim
	For nPosi := nAnoIni to nAnoFim
		If nPosi <> nAnoFim
			nMesFim := 12
		Else             
			nMesFim := nMesAux
		Endif
		Do While nMesIni <= nMesFim
			nProc := aScan(aProcessa,{|x| x[1]==nMesIni .And. x[2]==nPosi})

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Somente adiciona se a referencia nao existir. No processamento³
			//³consolidado, essa rotina sera processada mais que uma vez.    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If nProc == 0
				Aadd(aProcessa,{nMesIni,nPosi,.F.})
			Endif
		
			If nMesIni == 12
				nMesIni	:= 1
				Exit
			Else
				nMesIni += 1
			Endif
		Enddo	
	Next 
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Alimenta arquivo temporario                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//lATACNCIPI := (cAliasSf3)->(FieldPos("QATACNCIPI")) > 0
	//lLFICMZER  := (cAliasSf3)->(FieldPos("QLFICMZER")) > 0
	//lLFIPIZER  := (cAliasSf3)->(FieldPos("QLFIPIZER")) > 0
	//lF3CREDST  := (cAliasSf3)->(FieldPos("F3_CREDST")) > 0
	DbSelectArea (cAliasSf3)
	SetRegua(LastRec())
	dbGotop()

	While !(cAliasSf3)->(eof())
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Considera filtro do usuario                                  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If !Empty(cFilterUser).and.!(&cFilterUser)
			dbSkip()
			Loop
		Endif
        
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Consulta se a TES é para Atacadista não contribuinte IPI     ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

		aAtacNCIPI := aSize(aAtacNCIPI,0)
		If lATACNCIPI .And. (cAliasSf3)->QATACNCIPI > 0
			aAtacNCIPI := RetIPIAta((cAliasSf3)->F3_NFiscal,(cAliasSf3)->F3_Serie,(cAliasSf3)->F3_CLIEFOR,(cAliasSf3)->F3_LOJA,(cAliasSf3)->F3_CFO,(cAliasSf3)->F3_ALIQICM,(cAliasSf3)->F3_IDENTFT)
		EndIf
				
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Armazena os numeros de livros lancados             ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If !(F3_NRLIVRO$cLivros)
			cLivros	+=	F3_NRLIVRO+"/"
		Endif
	    //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Para armazenar os períodos com movimento³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	    If (cMov=="S" .And. aSX6[MV_LFMD2DT])
			nPosi := aScan(aProcessa,{|x| x[1]==Month((cAliasSf3)->F3_EMISSAO) .And. x[2]==Year((cAliasSf3)->F3_EMISSAO)})
	    Else
			nPosi := aScan(aProcessa,{|x| x[1]==Month((cAliasSf3)->F3_ENTRADA) .And. x[2]==Year((cAliasSf3)->F3_ENTRADA)})	    
	    Endif

		cEspecie := aModNoT((cArqTemp)->F3_ESPECIE)

	    aProcessa[nPosi][3] := .T.
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Verifica se os lancamentos serao aglutinados                 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If nTipomov==1 .or. !lAglutina
			dbSelectArea(cArqTemp)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Desconsidera item de entrada c/ formul. proprio nos livros   ³
			//³ de saida qdo ja foi gravado um item do lancto.               ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cMov=="S".And.lEntrada.And.Val(substr((cAliasSf3)->F3_CFO,1,1))<5.And.(cAliasSf3)->F3_FORMUL=="S".And. ;
				MSSeek((cAliasSf3)->F3_FILIAL+(cAliasSf3)->F3_SERIE+StrZero(Val((cAliasSf3)->F3_NFISCAL)),.F.)
				dbSelectArea (cAliasSf3)
				dbSkip()
				Loop
			Endif
			
			// Verifica se eh Nota Fiscal sobre Cupom
			cTipoEsp :=  (cAliasSf3)->F3_ESPECIE                             
			If !Empty((cAliasSf3)->F3_OBSERV) .AND. AllTrim(cTipoEsp)== "NF" .AND. !lAglutina      
				If SubStr((cAliasSf3)->F3_OBSERV, 1 , 9 ) == "CF/SERIE:" 
					DbSelectArea (cAliasSf3)
					DbSkip()
					Loop
			    EndIf   
			EndIf 
			
			If ((cAliasSf3)->F3_TIPO) =="S"
			    If lServico .Or. (lConjugada .And. Substring((cAliasSf3)->F3_CFO,2,3) == "933" .And. Alltrim((cAliasSf3)->F3_ESPECIE) $ 'NFE|SPED')
					RecLock(cArqTemp,.T.)
			  	Else
					RecLock(cArqTemp,.F.)
			  	EndIf   
			Else
				RecLock(cArqTemp,.T.)
			EndIf

			If !eof()
				For i	:=	1 to FCount()
					nx	:= FieldPos((cAliasSf3)->(FieldName(i)))
					if nx>0
						 FieldPut(nx,(cAliasSf3)->(FieldGet(i)))
					endif
				Next i
					
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Corrige valores de notas de servico(iss).  Apos a DSERFIS2-341, inclusive o valor contabil ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If lServico .And. (lEntrada .Or. cMov == "E") .And. F3_TIPO =="S" .And. cPaisLoc == "BRA" .And. Alltrim(F3_OBSERV) <> 'NF CANCELADA' .And. !(lConjugada .And. F3_TIPO == "S" .And. Substring(F3_CFO, 2, 3) == "933" .And. Alltrim(F3_ESPECIE) $ "SPED|NFE")
					(cArqTemp)-> F3_VALCONT	:= 0
					(cArqTemp)-> F3_BASEICM := 0	
					(cArqTemp)-> F3_VALICM  := 0
					(cArqTemp)-> F3_OUTRICM := 0
					(cArqTemp)-> F3_ISENICM := 0
					(cArqTemp)-> F3_ALIQICM := 0   
					(cArqTemp)-> F3_OBSERV  := 'NF SERVICO'
				EndIf   
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Corrige valores de IPI para Comercial e Atacadista n Contribuinte IPI.  Apos a DSERFIS1-15706 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

				If (lEntrada .Or. cMov == "E") .And. (Len(aAtacNCIPI) == 4 .And. aAtacNCIPI[3] > 0)
					(cArqTemp)-> F3_OUTRIPI := aAtacNCIPI[3]
					(cArqTemp)-> F3_BASEIPI	:= aAtacNCIPI[1]
					(cArqTemp)-> F3_VALIPI  := aAtacNCIPI[2]
					(cArqTemp)-> F3_OBSERV	:= aAtacNCIPI[4]
				EndIf  
			EndIf 

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Corrige numeracao da Nota                                    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cMov=="S"
				(cArqTemp)->NUMNOTA := STRZERO(VAL((cAliasSf3)->F3_NFISCAL),nTamF2DOC)
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Zera valor de desconto para nao ser escriturado              ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !lDesconto
				(cArqTemp)->F3_VALOBSE := 0
			Endif
			
			//verifica se deve zerar o valor contabil conforme cfops do parametro
			If Alltrim((cArqTemp)->F3_CFO)$cVlCtbZL
				(cArqTemp)->F3_VALCONT := 0	
			EndIf
			
			//Grava temporario 	
			If lAglutina .And. nTipomov <> 1 .and. Empty((cAliasSf3)->F3_DTCANC) .and. (cAliasSf3)->F3_FORMUL<>"S"
				ExecStat(cAliasSf3, coArqSF3Na)
			Endif

			DbSelectArea(cArqTemp)  // Caso for Nota Fiscal sobre Cupom grava na Observacao a serie e o numero da nota fiscal 
			
			If cMov=="S" .And. cPaisLoc == "BRA" .and. !lAglutina .and. aModNoT((cAliasSf3)->F3_ESPECIE) $ "01|1B|04|55|65" 
				cTipoSF2 :=  (cAliasSf3)->F2_ESPECIE
				If cPaisLoc == "BRA" .AND. AllTrim(cTipoSF2)== "CF" .AND. !Empty((cAliasSf3)->(F2_NFCUPOM)) .AND. !lAglutina
					cSerNf := Substr((cAliasSf3)->(F2_NFCUPOM) , 1, nTamSerie )
					cNfCup := Substr((cAliasSf3)->(F2_NFCUPOM) , nTamSerie+ 1 , nTamF2DOC) 
					(cArqTemp)->F3_OBSERV := "SERIE/NF: "+ cSerNf  + "/" +cNfCup   // Serie e Numero da Nota Fiscal sobre o Cupom
				EndIf 
			Endif
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Altera registro de notas de Formulario Proprio na Saida e    ³
			//³ Notas fiscais de Servico                                     ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cMov=="S".and.(((cAliasSf3)->F3_FORMUL=="S".or.(cAliasSf3)->F3_TIPO=="S") .Or. (!empty((cAliasSf3)->F3_DTCANC) .Or. (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I","D"}) )) .And. !(lConjugada .And. F3_TIPO == "S" .And. Substring(F3_CFO, 2, 3) == "933" .And. Alltrim(F3_ESPECIE) $ "SPED|NFE");
				.or. (cMov=="E".and.(cAliasSf3)->F3_FORMUL=="S" .and. (!empty((cAliasSf3)->F3_DTCANC) .Or. (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I","D"}))  )
				For i:=1 to FCount()
					If Valtype(FieldGet(i))=="N"
						FieldPut(i,0)  
					Endif
				Next
				If F3_FORMUL=="S" .And. empty(F3_DTCANC)
					(cArqTemp)->F3_OBSERV := STR0021 //"NT.FISCAL DE ENTRADA"
				Elseif F3_FORMUL=="S" .And. !empty(F3_DTCANC)
					If Empty((cArqTemp)->F3_OBSERV)
					   (cArqTemp)->F3_OBSERV := STR0022    //"CANCELADA"
                    Else  
						If (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"D"})
						   (cArqTemp)->F3_OBSERV := "NF DENEGADA" //"NF DENEGADA"
						ElseIf (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I"}) //"NF INUTILIZADA"
						   (cArqTemp)->F3_OBSERV := "NF INUTILIZADA"						
						EndIf
					EndIf
				ElseIf !empty(F3_DTCANC	) .OR. (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I","D"})
					If Empty((cAliasSf3)->F3_OBSERV)
						(cArqTemp)->F3_OBSERV := STR0022    //"CANCELADA"
                    Else
						If (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"D"})
						   (cArqTemp)->F3_OBSERV := "NF DENEGADA" //"NF DENEGADA"
						ElseIf (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I"}) //"NF INUTILIZADA"
						   (cArqTemp)->F3_OBSERV := "NF INUTILIZADA"						
						EndIf
					EndIf
				Else
					(cArqTemp)->F3_OBSERV := STR0023+" "+(cArqTemp)->F3_OBSERV  //"NT.FISCAL DE SERVICO"
				EndIf
				if	empty(F3_DTCANC)	
					(cArqTemp)->F3_CFO	:= "999"
				EndIf		
				If F3_FORMUL<>"S" .Or. (cMov=="S".and. aSX6[MV_LFMD2DT])
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Considera Dt.emissao NF entrada na emissao livro de saidas.  ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					(cArqTemp)->F3_ENTRADA := F3_EMISSAO
				Endif
			Endif                                      
			
			IF !eof()
				If lF3CREDST .And. (cArqTemp)->(F3_BASERET + F3_ICMSRET + F3_CRPRST + F3_OBSSOL) > 0 
					//Verifico F3_CREDST apenas se existir ICMS ST no cabeçalho (F3)
					//F3_FILIAL, F3_ENTRADA, F3_NFISCAL, F3_SERIE, F3_CLIEFOR, F3_LOJA, F3_CFO, F3_ALIQICM, R_E_C_N_O_, D_E_L_E_T_
					If cChaveSFT != xFilial("SF3")+(cArqTemp)->(dTos(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA+SubStr(Alltrim(F3_CFO), 1, 1)) 
						cChaveSFT	:= xFilial("SF3")+(cArqTemp)->(dTos(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA+SubStr(Alltrim(F3_CFO), 1, 1))
						
						cCredST := RetFTCREDST(cArqTemp)		
					EndIf

					(cArqTemp)->F3_CREDST := cCredST

					dbSelectArea(cArqTemp)
				endif

				If lLFICMZER .And. lLFIPIZER
					(cArqTemp)->LFICMZER := Iif((cAliasSf3)->QLFICMZER > 0, 1, 0)
					(cArqTemp)->LFIPIZER := Iif((cAliasSf3)->QLFIPIZER > 0, 1, 0)					
				endif

				IF lEmiteCiap
					(cArqTemp)->LCIAP   := Iif((cAliasSf3)->QLCIAP    > 0, 1, 0)
				Else
					(cArqTemp)->LCIAP   := 0
				Endif	
				
				If nTipoMov==1
					IF (cAliasSf3)->F3_TIPO$"DB"
						(cArqTemp)->CONTRIB	:= Iif(FisContr("C", (cAliasSf3)->A1_INSCR, (cAliasSf3)->A1_CONTRIB, (cAliasSf3)->A1_TPJ, (cAliasSf3)->A1_INSCRUR, (cAliasSf3)->A1_TIPO, "E", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
						(cArqTemp)->INSCR	:= (cAliasSf3)->A1_INSCR
						(cArqTemp)->INSCRUR	:= (cAliasSf3)->A1_INSCRUR
						(cArqTemp)->TIPO	:= (cAliasSf3)->A1_TIPO
						(cArqTemp)->TPJ		:= (cAliasSf3)->A1_TPJ		
						(cArqTemp)->EST		:= (cAliasSf3)->A1_EST
						(cArqTemp)->CONTA	:= (cAliasSf3)->A1_CONTA
						(cArqTemp)->CGC		:= (cAliasSf3)->A1_CGC
						(cArqTemp)->COD		:= (cAliasSf3)->A1_COD
						(cArqTemp)->LOJA	:= (cAliasSf3)->A1_LOJA
					Else
						(cArqTemp)->CONTRIB	:= Iif(FisContr("F", (cAliasSf3)->A2_INSCR, (cAliasSf3)->A2_CONTRIB, "", "", (cAliasSf3)->A2_TIPO, "E", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
						(cArqTemp)->INSCR	:= (cAliasSf3)->A2_INSCR
						(cArqTemp)->TIPO	:= (cAliasSf3)->A2_TIPO	
						(cArqTemp)->EST		:= (cAliasSf3)->A2_EST
						(cArqTemp)->CONTA	:= (cAliasSf3)->A2_CONTA		
						(cArqTemp)->CGC		:= (cAliasSf3)->A2_CGC
						(cArqTemp)->COD		:= (cAliasSf3)->A2_COD
						(cArqTemp)->LOJA	:= (cAliasSf3)->A2_LOJA
					Endif
				Else
					IF (cAliasSf3)->F3_TIPO$"DB"				
						(cArqTemp)->CONTRIB	:= Iif(FisContr("F", (cAliasSf3)->A2_INSCR, (cAliasSf3)->A2_CONTRIB, "", "", (cAliasSf3)->A2_TIPO, "S", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
						(cArqTemp)->INSCR	:= (cAliasSf3)->A2_INSCR
						(cArqTemp)->TIPO	:= (cAliasSf3)->A2_TIPO	
						(cArqTemp)->EST		:= (cAliasSf3)->A2_EST
						(cArqTemp)->CONTA	:= (cAliasSf3)->A2_CONTA		
						(cArqTemp)->CGC		:= (cAliasSf3)->A2_CGC
						(cArqTemp)->COD		:= (cAliasSf3)->A2_COD
						(cArqTemp)->LOJA	:= (cAliasSf3)->A2_LOJA
					Else
						(cArqTemp)->CONTRIB	:= Iif(FisContr("C", (cAliasSf3)->A1_INSCR, (cAliasSf3)->A1_CONTRIB, (cAliasSf3)->A1_TPJ, (cAliasSf3)->A1_INSCRUR, (cAliasSf3)->A1_TIPO, "S", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
						(cArqTemp)->INSCR	:= (cAliasSf3)->A1_INSCR
						(cArqTemp)->INSCRUR	:= (cAliasSf3)->A1_INSCRUR
						(cArqTemp)->TIPO	:= (cAliasSf3)->A1_TIPO
						(cArqTemp)->TPJ		:= (cAliasSf3)->A1_TPJ	
						(cArqTemp)->EST		:= (cAliasSf3)->A1_EST
						(cArqTemp)->CONTA	:= (cAliasSf3)->A1_CONTA
						(cArqTemp)->CGC		:= (cAliasSf3)->A1_CGC
						(cArqTemp)->COD		:= (cAliasSf3)->A1_COD
						(cArqTemp)->LOJA	:= (cAliasSf3)->A1_LOJA
					Endif
				Endif				
					
				(cArqTemp)->CONTSOC := (cAliasSf3)->CONTSOC
				(cArqTemp)->VLSENAR	:= (cAliasSf3)->VLSENAR
				(cArqTemp)->INSS	:= (cAliasSf3)->INSS

				(cArqTemp)->RECNOSF3 := (cAliasSf3)->RECNOSF3
				(cArqTemp)->COUNTF3  := (cAliasSf3)->COUNTF3 //verifica se Existe apenas uma SF3 para esta nota, evitar fazer seek na sft
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Grava a filial corrente no momento do processamento³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				(cArqTemp)->FILCORR := cFilAnt
				(cArqTemp)->(MsUnLock())
				
			Endif
            //
	        If lEmiteCiap .and. (cArqTemp)->LCIAP == 1
			   If ( Select("CIAP") != 0 )
				  	dbSelectArea("SD1")
				  	dbSetOrder(1)

					cChaveSD1 :=	xFilial("SD1")+(cAliasSf3)->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)

				If aScan(aSd1, {|aX| aX[1]==cChaveSD1})==0
						aAdd(aSd1,{cChaveSD1})
					
				  		If SD1->(MSSeek(cChaveSD1))
							 
					  		While SD1->(!Eof()) .And. cChaveSD1==SD1->(D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
					  			dbSelectArea("SF9")
				  	           dbSetOrder(2)
						  		If ( MSSeek(F3Filial("SF9")+Dtos((cAliasSf3)->F3_ENTRADA)+(cAliasSf3)->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA+SD1->(D1_CF+STR(D1_PICM,5,2)))))
							 		While ( !Eof() .And. F3Filial("SF9")==SF9->F9_FILIAL .And.;
									   (cAliasSf3)->F3_ENTRADA	==SF9->F9_DTENTNE	 	.And.;
								 	   (cAliasSf3)->F3_NFISCAL	==SF9->F9_DOCNFE	 	.And.;
									   (cAliasSf3)->F3_SERIE	==SF9->F9_SERNFE	 	.And.;
									   (cAliasSf3)->F3_CLIEFOR	==SF9->F9_FORNECE		.And.;
									   (cAliasSf3)->F3_LOJA		==SF9->F9_LOJAFOR		.And.;
									   SD1->D1_CF				==SF9->F9_CFOENT		.And.;
									   SD1->D1_PICM				==SF9->F9_PICM )
									   RecLock("CIAP",.T.)
									   CIAP->SF3 := &(cArqTemp)->(Recno())
									   CIAP->SF9 := SF9->(Recno())
									   MsUnlock()

									   SF9->(dbSkip())
									EndDo
						  		EndIf
							  	SD1->(dbSkip())
						  	EndDo
						EndIf
				  	EndIF
					 	  
				  dbSelectArea("SF9")
				  dbSetOrder(1)
			   EndIf
			Endif
			dbSelectArea(cAliasSf3)
			dbSkip()
		Else
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Aglutina lancamentos de mesma Data+Serie+CFO                 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cNFIni	  := F3_NFISCAL
			cNFFim	  := F3_NFISCAL
			dData	  := F3_ENTRADA
			cEst	  := F3_ESTADO
			cEsp	  := F3_ESPECIE 
			dDtCan1   := F3_DTCANC 
		    cCliente  := F3_CLIEFOR
		    cLoja     := F3_LOJA
	        nAliq     := F3_ALIQICM         
		    cSer 	  := F3_SERIE        
		    cFormula  := F3_FORMULA
			cTipo	  := F3_TIPO     
			cFilProc  := F3_FILIAL
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Inicializa array de aglutinacao.            ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			aLivro := Array(Len(aFixos))
			For i:=1 To Len(aFixos)
				aLivro[i] := aFixos[i][2]
			Next
			
			cSeek:=F3_FILIAL+dTos(F3_ENTRADA)+F3_SERIE+F3_CFO+Str(F3_ALIQICM,5,2)+cEst+cEsp+cFormula+cTipo
			While !Eof().And.cSeek==F3_FILIAL+dTos(F3_ENTRADA)+F3_SERIE+F3_CFO+Str(F3_ALIQICM,5,2)+F3_ESTADO+F3_ESPECIE+F3_FORMULA	+F3_TIPO
		        //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Considera Nf's de Entrada                ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !lEntrada .and. Val(substr(F3_CFO,1,1))<5
					dbSkip()
					Loop
				Endif                                    
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Acumula valores.             ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
				if empty(F3_DTCANC)
					For i:=1 To Len(aFixos)						
						IF aFixos[i][1] <> 'XXX' // aFixos XXX quando não possui campo
							IF aFixos[i][1] $ cCampos								
								aLivro[i]:=&(aFixos[i,1])
							Endif
						Endif	
					Next

					//Grava temporario 			  	  
					If lAglutina .And. nTipomov <> 1 .and. Empty((cAliasSf3)->F3_DTCANC) .and. (cAliasSf3)->F3_FORMUL<>"S"
						ExecStat(cAliasSf3, coArqSF3Na)
					Endif
						
					cNFFim   :=(cAliasSf3)->F3_NFISCAL
					cSer 	 :=(cAliasSf3)->F3_SERIE
					cCFO     :=(cAliasSf3)->F3_CFO
		  		    cFormula :=(cAliasSf3)->F3_FORMULA				
		  		    cFilProc :=(cAliasSf3)->F3_FILIAL
					
					If !lMapResumo
						GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,cFormula,,cFilProc,cAliasSf3)
					Else
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Caso utilize Mapa Resumo, somente gera o temporario para NF. ³
						//³Pois os registros de Mapa Resumo (SFI) serao de acordo com a ³
						//³funcao Mtr930Resumo                                          ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	            		If Alltrim((cAliasSf3)->F3_ESPECIE) <> "CF" .AND. Alltrim((cAliasSf3)->F3_ESPECIE) <> "ECF"
							GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,cFormula,,cFilProc,cAliasSf3)
						EndIf	            						
					EndIf
	
	            Else
	               lCanc :=.T.
	               exit 
				EndIf
				dbSelectArea(cAliasSf3)
				cChvEmiL := (cAliasSf3)->F3_NFISCAL+(cAliasSf3)->F3_SERIE+(cAliasSf3)->F3_CFO+Dtos((cAliasSf3)->F3_EMISSAO)+(cAliasSf3)->F3_CLIEFOR+(cAliasSf3)->F3_LOJA
	            dbSkip()
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Verifica se proxima nota nao esta cancelada.                 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Se existir 2 SF3 para o mesmo documento com o mesmo CFOP deve aglutinar  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cChvEmiL <> (cAliasSf3)->F3_NFISCAL+(cAliasSf3)->F3_SERIE+(cAliasSf3)->F3_CFO+Dtos((cAliasSf3)->F3_EMISSAO)+(cAliasSf3)->F3_CLIEFOR+(cAliasSf3)->F3_LOJA
					If (Val(cNFFim)+1) <> Val(F3_NFISCAL)
						Exit
					Endif
				EndIf
			EndDo
			if lCanc
	           //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			   //³ Inicializa array de aglutinacao.            ³
			   //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			   aLivro := Array(Len(aFixos))
			   For i:=1 To Len(aFixos)
				   aLivro[i] := aFixos[i][2]
			   Next
			   cNFIni	 := (cAliasSf3)->F3_NFISCAL
			   cNFFim	 := (cAliasSf3)->F3_NFISCAL
			   dData	 := (cAliasSf3)->F3_ENTRADA
			   cEst	     := (cAliasSf3)->F3_ESTADO
			   cEsp	     := (cAliasSf3)->F3_ESPECIE 
			   dDtCan1   := (cAliasSf3)->F3_DTCANC 
			   cCliente  := (cAliasSf3)->F3_CLIEFOR
			   cLoja     := (cAliasSf3)->F3_LOJA
			   cFilProc  := (cAliasSf3)->F3_FILIAL
			   lCanc     :=.F.
	           
			   If !lMapResumo
	           		GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,,,cFilProc,cAliasSf3)
			   Else
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Caso utilize Mapa Resumo, somente gera o temporario para NF. ³
					//³Pois os registros de Mapa Resumo (SFI) serao de acordo com a ³
					//³funcao Mtr930Resumo                                          ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			   		If Alltrim((cAliasSf3)->F3_ESPECIE) <> "CF" .AND. Alltrim((cAliasSf3)->F3_ESPECIE) <> "ECF"
						GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,,,cFilProc,cAliasSf3)			        
			   		EndIf
			   EndIf               
			   
			   dbSelectArea(cAliasSf3)
	           dbSkip()		
			endif
			dbSelectArea(cAliasSf3)
		Endif
	End

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica a necessidade de analisar o aProcessa, devido³
	//³as informacoes de Mapa Resumo aparecerem depois do    ³
	//³processamento do SF3                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lMapResumo .AND. cMov=="S"		

		If lMapResumo
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Alimenta array com as informacoes do Mapa Resumo³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			aMapaResumo		:= 	MaxRMapRes(dDtIni,dDtFim)

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica se anteriormente foi inserido registro para data³
			//³sem movimento                                            ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If Len(aProcessa) > 0
				For nX := 1 To Len(aMapaResumo)
					nPosi := aScan(aProcessa,{|x| x[1]==Month(aMapaResumo[nX][1]) .And. x[2]==Year(aMapaResumo[nX][1])})	
				    If nPosi > 0
				    	If !aProcessa[nPosi][3]
							aProcessa[nPosi][3] := .T.		    	
				    	EndIf
				    EndIf
				Next nX
            EndIf
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Adiciona um registro no temporario para imprimir o periodo sem movimento³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nPosi := 1 To Len(aProcessa)
		If ! aProcessa[nPosi][3]
			cNFIni		:= ""
			cNFFim		:= ""
			cSer		:= ""
			nAliq		:= 0
			cFormula	:= ""
			dData		:= cToD("01/" + StrZero(aProcessa[nPosi][1],2) + "/" + StrZero(aProcessa[nPosi][2],4))
			cEst		:= ""
			cEsp		:= ""
			dDtCan1		:= cTod("  /  /  ")
			cCliente	:= ""
			cLoja		:= ""
			lCanc		:= .F.
			cFilProc  	:= xFilial("SF3")
	        GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,cFormula,.T.,cFilProc,cAliasSf3)
		Endif
	Next
	
	#IFDEF TOP
		(cAliasSf3)->(DbCloseArea ())
	#ENDIF
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Reposiciona SF3                                              ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SF3")
	dbClearFilter()
	RetIndex("SF3")
	dbSetOrder(1)
	#IFNDEF TOP
		Ferase(cArqIndxF3+OrdBagExt())
	#ENDIF
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Acumula Valores do ICMS Normal + Retido - Instr. Normativa n. 564/02-GSF - Goias ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If nTotIcmsEnt == 1 .And. cMov=="S" .And. lExist
		dbSelectArea("SF3")
		#IFDEF TOP
			cQuery := "SELECT SUM (SF3.F3_OBSICM) F3_OBSICM, SUM (SF3.F3_OBSSOL) F3_OBSSOL "
			cQuery += "FROM "+RetSqlName("SF3")+" SF3 "
			cQuery += "WHERE SF3.F3_FILIAL='"+xFilial("SF3")+"' AND "
			cQuery += "SUBSTRING(SF3.F3_CFO,1,1)<'5' AND "
			If !Empty(cMvCFTR930)
				cQuery	+=	"SF3.F3_CFO NOT IN ("+ cMvCFTR930 +") AND "
			EndIf
			cQuery += "SF3.F3_ENTRADA>='"+DTOS(dDtIni)+"' AND SF3.F3_ENTRADA<='"+DTOS(dDtFim)+"' AND "
			cQuery += "SF3.D_E_L_E_T_=' ' "
	
			If !(lServico)
				cQuery	+=	" AND SF3.F3_TIPO<>'S' "
			EndIf
			
			If (cNrLivro!="*")
				cQuery	+=	" AND SF3.F3_NRLIVRO='"+cNrLivro+"' "
			EndIf
			
			cQuery := ChangeQuery(cQuery)
	
			dbUseArea (.T.,"TOPCONN",TcGenQry (,,cQuery),"QUERY")
	
			nTotIcmDeb := QUERY->F3_OBSICM+QUERY->F3_OBSSOL
	
			QUERY->(dbCloseArea ())
		#ELSE
			cFiltro:="F3_FILIAL=='"+xFilial()+"'.AND.DTOS(F3_ENTRADA)>='"+DTOS(dDtIni)+"'.AND.DTOS(F3_ENTRADA)<='"+DTOS(dDtFim)+"'"
			cFiltro +=  ".AND. F3_CFO<'500"+SPACE(LEN(F3_CFO)-3)+"'"
			If !Empty(cMvCFTR930)
				cFiltro	+=	".AND. !SF3.F3_CFO $ ("+ cMvCFTR930 +") "
			EndIf
			If !lServico
				cFiltro	+=	".AND.F3_TIPO!='S'"
			Endif
			If cNrLivro!="*"
				cFiltro	+=	".AND.F3_NRLIVRO=='"+cNrLivro+"'"
			Endif
			cChave		:=	"F3_FILIAL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO"
			cArqIndxF3	:=	CriaTrab(NIL,.F.)
			IndRegua("SF3",cArqIndxF3,cChave,,cFiltro,STR0020) //"Filtrando registros..."
			//
			dbClearIndex()
			dbSetIndex(cArqIndxF3+OrdBagExt())
			//
			SetRegua(LastRec())
			dbGotop()
			While !SF3->(eof())
				IncRegua()
				If Interrupcao(@lAbortPrint)
					Exit
				Endif
				nTotIcmDeb += F3_OBSICM+F3_OBSSOL
				dbSkip()		
			EndDo
			//
			dbSelectArea("SF3")
		dbClearFilter()
			RetIndex("SF3")
			dbSetOrder(1)
			Ferase(cArqIndxF3+OrdBagExt())
		#ENDIF
		//
		dbSelectArea("SF3")
		dbSetOrder(1)
	Endif

	If lMapResumo .AND. lImpEcf .AND. Len(aMapaResumo) > 0

		aGravaMapRes	:= 	MaXRAgrupF3(cFilAnt,aMapaResumo,cChamOrig,nLegisArt,.T.)
		cArqTemp		:=	MaXRAddArq(2,cArqTemp,/*cAlias*/,aCampos,aGravaMapRes)

	EndIf
	If FWModeAccess("SF3",3)=="C" 
		Exit
	Else
   		SM0->(dbSkip())	
	Endif	

Enddo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Restaura a filial e area corrente ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aArea := GetArea()
RestArea(aAreaSM0)
cFilAnt	:= FWCodFil()
RestArea(aArea)

//Aqui restauro o ESTADO da Filial logada.
cMV_ESTADO	:= aSX6[MV_ESTADO]

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Busca notas Fiscais Canceladas/Nao Lancadas/Nf.Servico       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cMov=="S".and.lLacuna.and.!lAbortPrint .And. ((cMov=="S".And.lEntrada) .or. nLacuna == 1) 
	dbSelectArea(cArqTemp)
	dbSetOrder(1)
	dbGotop()
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Busca series lancadas                                        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aSeries:={}
	SetRegua(LastRec())
	conout(Alltrim(Str(ThreadID())) + " Inicio do Processamento de notas para lacuna:  " + Time())
	While !eof()
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
		If !SEMMOV 
			nPos:=Ascan(aSeries,{|x|x[1]==F3_NRLIVRO.and.x[2]==F3_SERIE.and.x[5]==F3_FILIAL})
			If nPos==0
				nTamNF := Len(AllTrim(F3_NFISCAL))
				AADD(aSeries,{F3_NRLIVRO,F3_SERIE,Val(NUMNOTA),0,F3_FILIAL,FILCORR,nTamNF})
				nPos:=Len(aSeries)
			Endif              
			
			aSeries[nPos,4]:=Max(Max(Val(NUMNOTA),Val(F3_DOCOR)),aSeries[nPos,4])    
			aSeries[nPos,7]:=Iif(Len(Alltrim(F3_NFISCAL))==aSeries[nPos,7],aSeries[nPos,7],nTamF2DOC)
		Endif
		dbSkip()
	End         
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Verifica Series Lancadas                                     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dDtCanc	:=	dDtFim
	conout(Alltrim(Str(ThreadID())) + " Inicio do processamento Canceladas:  " + Time())
	For i:=1 to Len(aSeries)

		//Carrega jSON
		IF lBuildjS .and. (aSeries[i,4]-aSeries[i,3]) > 0
			FreeObj(oNotasjS)
			CarregaNF(aSeries[i,2],aSeries[i,3],aSeries[i,4],aSeries[i,6],aSeries[i,7])
		Endif

		SetRegua(aSeries[i,4]-aSeries[i,3])
		For j:=aSeries[i,3] to aSeries[i,4]

			IncRegua()
			If Interrupcao(@lAbortPrint)
				Exit
			Endif
			
			cNumNota 	:=	StrZero(j,aSeries[i,7])+Space(nTamF2DOC-aSeries[i,7])
			cSeek		:=	aSeries[i,2]+cNumNota+aSeries[i,5]
			dbSetOrder(3)
			If MSSeek(cSeek,.F.)
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Nao considera notas de Lote na sequencia ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If F3_TIPO=="L".And.!Empty(F3_DOCOR)
					j:=Val(F3_DOCOR)
					dbSkip()
					While ( !Eof() .And. J==Val(NUMNOTA) )
						j:=Val(F3_DOCOR)
						dbSkip()
					EndDo
					If j>=aSeries[i,4]
						Exit
					Endif
				Endif
				dDtCanc:=F3_ENTRADA
				Loop
			Else
				dbSetOrder(2)
				cSeek:=aSeries[i,2]+"C"+cNumNota+aSeries[i,5]
				If !MSSeek(cSeek)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Verifica se a nota existe em outro livro ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If !ExistNF(cNumNota,aSeries[i,2],aSeries[i,1],cLivros,aSeries[i,6]) 
     					If nLacuna==1

							cObserv	:= Iif( SF3->F3_CODRSEF$XFUNCodSef({"D"}),"NF DENEGADA",STR0022 )  //"CANCELADA"

	  						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Tratamento para as notas fiscais Inutilizadas ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If SF3->F3_CODRSEF$XFUNCodSef({"I"})
								cObserv	:= "NF INUTILIZADA"
							EndIf

							RecLock(cArqTemp,.T.)                                              
                         //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                         //³Posiciona na filial em que foi processado o registro ³
                         //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
                         Mtr930Fil(aAreaSM0,aSeries[i,6],1)
					   		(cArqTemp)->F3_FILIAL 	:= xFilial("SF3")
					   		(cArqTemp)->F3_TIPO		:= "C"
					   		(cArqTemp)->F3_NFISCAL 	:= StrZero(j,aSeries[i,7])
					   		(cArqTemp)->F3_DOCOR	:= StrZero(j,aSeries[i,7])
					   		(cArqTemp)->NUMNOTA		:= cNumNota
					   		(cArqTemp)->F3_NRLIVRO 	:= aSeries[i,1]
					   		(cArqTemp)->F3_SERIE	:= aSeries[i,2]
					   		(cArqTemp)->F3_EMISSAO	:= dDtCanc
					   		(cArqTemp)->F3_ENTRADA 	:= dDtCanc
					   		(cArqTemp)->F3_CFO		:= "999"
					   		(cArqTemp)->F3_OBSERV	:= cObserv 
					   		MsUnLock()
   					       	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 	 				       	//³Restaura a filial e area corrente ³
				      		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					   		Mtr930Fil(aAreaSM0,aSeries[i,6],2)
						Endif
					Else
						If !MSSeek(cSeek,.F.)
          		            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                     		//³Posiciona na filial em que foi processado o registro	³
                     		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							Mtr930Fil(aAreaSM0,aSeries[i,6],1)
							dbSelectArea("SF3")
							dbSetOrder(5)
							If cMov=="S".And.lEntrada.And.MSSeek(xFilial()+aSeries[i,2]+cNumNota,.F.).And.Val(substr(SF3->F3_CFO,1,1))<5.And.(SF3->F3_FORMUL=="S") ;
								.And.(SF3->F3_EMISSAO>=dDtIni.And.SF3->F3_EMISSAO<=dDtFim)
								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
								//³ Altera registro de notas de Formulario Proprio na Saida e    ³
								//³ Notas fiscais de Servico                                     ³
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
								If SF3->(EOF())
									RecLock(cArqTemp,.T.)
									(cArqTemp)->F3_FILIAL  := xFilial("SF3")
									(cArqTemp)->F3_NFISCAL := StrZero(j,aSeries[i,7])
									(cArqTemp)->F3_DOCOR   := StrZero(j,aSeries[i,7])
									(cArqTemp)->NUMNOTA    := cNumNota
									(cArqTemp)->F3_NRLIVRO := aSeries[i,1]
									(cArqTemp)->F3_SERIE   := aSeries[i,2]
									(cArqTemp)->F3_OBSERV  := STR0021 //"NT.FISCAL DE ENTRADA"
									(cArqTemp)->F3_CFO     := "999"
									(cArqTemp)->F3_ENTRADA := SF3->F3_EMISSAO
									For nI:=1 to FCount()
										If Valtype(FieldGet(nI))=="N"
											FieldPut(nI,0)
										Endif
									Next
									//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
									//³ Considera Dt.emissao NF entrada na emissao livro de saidas.  ³
									//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
									MsUnLock()
								Endif
								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
								//³Restaura a filial e area corrente ³
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
								Mtr930Fil(aAreaSM0,aSeries[i,6],2)
								dDtCanc:=F3_ENTRADA
							Endif
						Endif
						dbSelectArea(cArqTemp)
					Endif
				Else
					dDtCanc:=F3_ENTRADA
					RecLock(cArqTemp,.F.)
					If J>Val(F3_DOCOR)
						(cArqTemp)->F3_DOCOR 	:= StrZero(j,aSeries[i,7])
					Endif
					MsUnLock()
				Endif
			Endif
		Next j
		If lAbortPrint
			Exit
		Endif
	Next i
Endif
conout(Alltrim(Str(ThreadID())) + " Termino do processamento Canceladas:  " + Time())
dbSelectArea(cArqTemp)
If cMov=="S"
	dbClearIndex()
	Ferase(cIndxTemp1+OrdBagExt())
	Ferase(cIndxTemp2+OrdBagExt())
	Ferase(cIndxTemp3+OrdBagExt())
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Indice principal de impressao                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !lAbortPrint
	if aReturn[8]==1
		cChave	:=	"DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO+F3_FORMULA+F3_FILIAL"
	elseif aReturn[8]==2
		cChave	:=	"DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CFO+F3_FORMULA+F3_FILIAL"
	else
		cChave	:=	"F3_NFISCAL+F3_SERIE+DTOS(F3_ENTRADA)+F3_CFO+F3_FORMULA+F3_FILIAL"
		lTotalDia:=.F.
	endif
	IndRegua(cArqTemp,cArqTemp,cChave,,,STR0024) //"Ordenando Notas..."
	dbGoTop()
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Inicializa array aColunas statico com colunas do SF3         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
ColF3()

//Força a gravaçao da temporaria
IF !(cSGBD $ "ORACLE")
	ExecStat("", coArqSF3Na, .T.) 
Endif

Return (cArqTemp)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ LivrAcumula()³Autor ³ Juan Jose Pereira    ³Data³ 17/02/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Acumulador de valores fiscais para o ModP1,ModP1A          ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION LivrAcumula(	cArqTemp,;
aTotDia,;
aTotPerICM,;
aTotPerIPI,;
aTotMes,;
aTransp,;
aResumo,;
aResCFO,;
cArqSF3,;
lMatr921,;
aResCFOZer,;
aTotObs,;
nCol921,;
lMV_ESTCLI)

LOCAL aSF3		:= {}
Local i
Local cSvAlias	:= Alias()
Local nPos
Local nPosCFO
LOCAL cMens		:= ""
Local cCaption	:= STR0025 //" ATENCAO "
LOCAL cInscr
LOCAL cTipo
Local lExist 	:= .F.
Local aAreaSM0 	:= SM0->(GetArea())
Local cFilProc	:= ""
Local lP1IcmST	:= aSX6[MV_P1ICMST]
Local lProcST	:= .T.
Local dAuxData	:= cTod("//")
Local lRemAmb   := .F. 
Local nValor	:= 0 
Local cObsCfp	:=	aSX6[MV_OBSCFO] // Indica a CFOP utilizanda quando o Livro Fiscal de ICMS = B-Observacao
Local aDadSF3   := {}
Local cUfDes    := ""
Local cUfForCte	:= aSX6[MV_NFCTEUF]
Local lContrib  := .F.

Default lMatr921 := .F.
Default nCol921	 := 1

Private oDlgAviso  

aTotFecp := {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se CFO das NFs sao validos.             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If (Empty(F3_CFO) .Or. ValType(Val(F3_CFO))!="N") .And. !SEMMOV  //.And.  FieldPos ("SEMMOV")>0
	cMens:=STR0026+SerieNfId("SF3",2,"F3_SERIE")+" "+F3_NFISCAL+STR0027 //"NF "###" possui CFO incorreto ! "
	
	DEFINE MSDIALOG oDlgAviso TITLE OemtoAnsi(cCaption) FROM  165,190 TO 300,440 PIXEL OF oMainWnd
	@ 03, 10 TO 43, 118 LABEL "" OF oDlgAviso  PIXEL
	@ 20, 15 SAY OemToAnsi(cMens) SIZE 100, 8 OF oDlgAviso PIXEL
	DEFINE SBUTTON FROM 50  ,80  TYPE 1 ACTION (oDlgAviso:End()) ENABLE OF oDlgAviso
	ACTIVATE MSDIALOG oDlgAviso
	Return
Endif

If aResCFO==NIL
	aResCFO:={}
Endif
If aResumo==NIL
	aResumo:={}
Endif
If aResCFOZer == NIL
	aResCFOZer := {}
EndIf

dbSelectArea(cArqTemp)
                       
lExist := IIF((cArqTemp)->F3_OBSSOL>0,.T.,.F.)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica o valor do ICMS Retido de acordo com a configuracao da TES     ³
//³Quando o campo F3_CREST existir e estiver configurado como "4",         ³
//³o valor do ICMS retido nao deve ser apresentado na coluna de observacoes³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lProcST := .T.
If (cArqTemp)->F3_CREDST == "4" .And. lP1IcmST .And. (cArqTemp)->F3_CFO < "5"
	lProcST := .T.
Elseif (cArqTemp)->F3_CREDST == "4" .And. (lExist .Or. !lP1IcmST )
	lProcST := .F.
Elseif !lExist
	lProcST := .T.
Endif

aAdd(aDadSF3,{xFilial("SF3"), F3_CREDST, F3_BASERET, F3_ICMSRET,  F3_OBSSOL})           
For i:=1 to FCount()
	If ValType(FieldGet(i))=="N"
		// Quando o ICMS ST nao deve ser apresentado como Retido - ST Transportes
	  	If (Alltrim(FieldName(i)) == "F3_ICMSRET" .Or. AllTrim(FieldName(i)) == "F3_BASERET" .Or. AllTrim(FieldName(i)) == "F3_OBSSOL" .Or. AllTrim(FieldName(i)) == "F3_CRPRST") .And. !lProcST
			AADD(aSF3,0)
	  	Else
			If (AllTrim(FieldName(i)) == "F3_BASERET") .And. !lExist				
				AADD(aSF3,VerICMRET("F3_BASERET", FieldGet(i), !lExist, aDadSF3,lP1IcmST))
			ElseIf (AllTrim(FieldName(i)) == "F3_ICMSRET")			
				AADD(aSF3,VerICMRET("F3_ICMSRET", FieldGet(i), lExist , aDadSF3,lP1IcmST))
			ElseIf (AllTrim(FieldName(i)) == "F3_BASERET") .And. lExist
				AADD(aSF3,0)
			ElseIf (AllTrim(FieldName(i)) == "F3_BASNDES")
				AADD(aSF3,FieldGet(ColF3("F3_BASNDES")))
			ElseIf (AllTrim(FieldName(i)) == "F3_ICMNDES")
				AADD(aSF3,FieldGet(ColF3("F3_ICMNDES")))	
			Else
				AADD(aSF3,FieldGet(i))
				If (AllTrim(FieldName(i)) == "F3_VALFECP" .Or. AllTrim(FieldName(i)) == "F3_VFECPST")
					AADD(aTotFecp,{FieldName(i),FieldGet(i)})
				EndIf						
			Endif			
		Endif
	Else 
		AADD(aSF3,"NULL")
	Endif
Next
aDadSF3 := {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Para o relatorio de transcricao MATR921 o tratamento abaixo nao deve ser aplicado   ³
//³pois esta zerando os totalizadores do relatorio. (Alinhado com equipe de legislacao)³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !lMatr921
	//verifica se efetura tratamento - Remessa de Venda p/ Fora do Estabelecimento
	If cMV_ESTADO=="SP" .And. Alltrim(F3_CFO)$cMV_CFOZER
	    lRemAmb := .T.
	Else
	    lRemAmb := .F.     
	EndIf
EndIf                                                                                   

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o registro nao e do Mapa Resumo do ECF              ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If substr(F3_CFO,1,3)=="999" .And. (Alltrim(F3_ESPECIE)<>"CF" .AND. Alltrim(F3_ESPECIE)<>"ECF")
	For i:=1 to Len(aSF3)
		aSF3[i]:=If(Valtype(aSF3[i])=="N",0,aSF3[i])
	Next
Endif

If aTotDia==NIL
    
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Ao alimentar os totalizadores pela primeira vez, deve verificar se trata-se de Remessa para Fora do Estabelecimento	³
	//³Se a variavel lRemAmb for .T. que dizer que trata-se deste caso, entao os valores devem ser zerados	               	³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lRemAmb
		aSF3[ColF3("F3_ALIQICM")]	:=	0
		aSF3[ColF3("F3_VALCONT")]	:=	0
		aSF3[ColF3("F3_BASEICM")]	:=	0
		aSF3[ColF3("F3_VALICM")]	:=	0
		aSF3[ColF3("F3_OUTRICM")]	:=	0
		aSF3[ColF3("F3_ICMSRET")]	:=	0
		aSF3[ColF3("F3_ISENICM")]	:=	0
		aSF3[ColF3("F3_BASEIPI")]	:=	0
		aSF3[ColF3("F3_VALIPI")]	:=	0
		aSF3[ColF3("F3_ISENIPI")]	:=	0
		aSF3[ColF3("F3_OUTRIPI")]	:=	0
		aSF3[ColF3("F3_CRPRST")]	:=	0
		aSF3[ColF3("F3_VALANTI")]	:=	0
		aSF3[ColF3("F3_VL43080")]	:=	0
		aSF3[ColF3("F3_VLINCMG")]	:=	0
		aSF3[ColF3("F3_BASNDES")]	:=	0
		aSF3[ColF3("F3_ICMNDES")]	:=	0

	Endif
	aTotObs 		:=	Aclone(aSF3)							
	aTotDia		:=	Aclone(aSF3)	
	If (cArqTemp)->F3_CREDST <> "4" 
		aTotObs[ColF3("F3_BASERET")] := 0
		aTotObs[ColF3("F3_ICMSRET")] := 0
	Endif	
	If ((cArqTemp)->F3_VALOBSE>0 .And. (cArqTemp)->F3_VALCONT==0) .Or. ((cArqTemp)->F3_VALOBSE==0 .And. (cArqTemp)->F3_VALCONT==0)
		If	Alltrim((cArqTemp)->F3_CFO)$ cObsCfp
	   		aSF3[ColF3("F3_VALOBSE")] := 0
	   		aTotDia[ColF3("F3_VALOBSE")] := 0 
   		Endif
	Endif
	aTotPerICM	:=	Aclone(aSF3)
	aTotPerIPI	:=	Aclone(aSF3)
	aTotMes		:=	Aclone(aSF3)
	aTransp		:=	Aclone(aSF3)	
Else
	For i:=1 to Len(aSF3)
		If Valtype(aSF3[i])=="N"
			nValor:=aSF3[i]
			
			If lRemAmb
				aSF3[ColF3("F3_VALCONT")]	:=	0 
			 	aSF3[ColF3("F3_OUTRICM")]	:=	0
   			EndIf
   			If (AllTrim(FieldName(i)) == "F3_BASERET".Or. AllTrim(FieldName(i)) == "F3_ICMSRET")
   				If lP1IcmST .And. F3_CREDST == '4'
	   				If Valtype(aTotObs[i])=="U"
	   					aTotObs[i]	:=	nValor
	   				Else
	   					aTotObs[i]	+=	nValor
	   				Endif
	   			Else
	   				aTotObs[i] := 0		
	   			Endif
   			Endif    
			If  (nCol921 <> 2 .Or. F3_CREDST <> '4') //coluna tributada desconsidera credst=4
				aTotDia[i]		+=nValor
		 	   	aTotPerICM[i]	+=nValor
	 		   	aTotPerIPI[i]	+=nValor
	 	   		aTotMes[i] 		+=nValor
		 	   	aTransp[i]		+=nValor					
			EndIf
		EndIf 
        
        If ((cArqTemp)->F3_VALOBSE>0 .And. (cArqTemp)->F3_VALCONT==0) .Or. ((cArqTemp)->F3_VALOBSE==0 .And. (cArqTemp)->F3_VALCONT==0)
  			If Alltrim((cArqTemp)->F3_CFO)$ cObsCfp
	   		   aSF3[ColF3("F3_VALOBSE")] := 0
	   		   aTotDia[ColF3("F3_VALOBSE")] := 0 
			Endif
	    Endif
	Next i
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Acumula valores por CFOS                                                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nPosCFO:=ColF3("F3_CFO")
If !(Subs(F3_CFO,1,3) $ "999#000") .And. Empty(F3_DTCANC) .And. !lRemAmb // nao imprimi resumo por CFOP para transferencias/Canceladas
	nPos:=Ascan(aResCFO,{|x|x[nPosCFO]==F3_CFO})
	If nPos==0
		AADD(aResCFO,AClone(aSF3))
		nPos:=Len(aResCFO)
		aResCFO[nPos,nPosCFO]:=F3_CFO
		If F3_CREDST=='4' .And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]:=0
			aResCFO[nPos,ColF3("F3_ICMSRET")]:=0
		Endif
	Else
		For i:=1 to Len(aSF3)
			If ValType(aSF3[i])=="N"
				aResCFO[nPos,i]+=aSF3[i]
			Endif
		Next i
		If F3_CREDST=='4'.And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]-=aSF3[ColF3("F3_BASERET")]
			aResCFO[nPos,ColF3("F3_ICMSRET")]-=aSF3[ColF3("F3_ICMSRET")]
		Endif
	Endif
	nPos:=Ascan(aResCFO,{|x|x[nPosCFO]==Substr(F3_CFO,1,1)+"TT"})
	If nPos==0
		AADD(aResCFO,AClone(aSF3))
		nPos:=Len(aResCFO)
		aResCFO[nPos,nPosCFO]:=Substr(F3_CFO,1,1)+"TT"
		If F3_CREDST=='4'.And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]:=0
			aResCFO[nPos,ColF3("F3_ICMSRET")]:=0
		Endif
	Else
		For i:=1 to Len(aSF3)
			If ValType(aSF3[i])=="N"
				aResCFO[nPos,i]+=aSF3[i]
			Endif
		Next i
		If F3_CREDST=='4'.And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]-=aSF3[ColF3("F3_BASERET")]
			aResCFO[nPos,ColF3("F3_ICMSRET")]-=aSF3[ColF3("F3_ICMSRET")]
		Endif
	Endif
	nPos:=Ascan(aResCFO,{|x|x[nPosCFO]=="TTT"})
	If nPos==0
		AADD(aResCFO,AClone(aSF3))
		nPos:=Len(aResCFO)
		aResCFO[nPos,nPosCFO]:="TTT"
		If F3_CREDST=='4'.And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]:=0
			aResCFO[nPos,ColF3("F3_ICMSRET")]:=0
		Endif

	Else
		For i:=1 to Len(aSF3)
			If ValType(aSF3[i])=="N"
				aResCFO[nPos,i]+=aSF3[i]
			Endif
		Next i
		If F3_CREDST=='4'.And. !lProcST
			aResCFO[nPos,ColF3("F3_BASERET")]-=aSF3[ColF3("F3_BASERET")]
			aResCFO[nPos,ColF3("F3_ICMSRET")]-=aSF3[ColF3("F3_ICMSRET")]
		Endif
	Endif
	
	// Resumo por CFOP c/ Livro Zerado
	
	If ((F3_BASEICM == 0 .And. F3_VALICM == 0) .Or. (F3_BASEIPI == 0 .And. F3_VALIPI == 0)) 
	
		If (cArqTemp)->LFICMZER = 1 .Or. (cArqTemp)->LFIPIZER = 1

			nPos := Ascan(aResCFOZer,{|x|x[nPosCFO] == F3_CFO})

			If nPos==0
				AADD(aResCFOZer,AClone(aSF3))
				nPos := Len(aResCFOZer)
				aResCFOZer[nPos,nPosCFO] := F3_CFO
			Else
				For i := 1 to Len(aSF3)
					If ValType(aSF3[i])=="N"
						aResCFOZer[nPos,i] += aSF3[i]
					Endif
				Next i
			Endif

			nPos:=Ascan(aResCFOZer,{|x|x[nPosCFO]==Substr(F3_CFO,1,1)+"TT"})

			If nPos==0
				AADD(aResCFOZer,AClone(aSF3))
				nPos:=Len(aResCFOZer)
				aResCFOZer[nPos,nPosCFO]:=Substr(F3_CFO,1,1)+"TT"
			Else
				For i:=1 to Len(aSF3)
					If ValType(aSF3[i])=="N"
						aResCFOZer[nPos,i]+=aSF3[i]
					Endif
				Next i
			Endif

			nPos:=Ascan(aResCFOZer,{|x|x[nPosCFO]=="TTT"})

			If nPos==0
				AADD(aResCFOZer,AClone(aSF3))
				nPos:=Len(aResCFOZer)
				aResCFOZer[nPos,nPosCFO]:="TTT"
			Else
				For i:=1 to Len(aSF3)
					If ValType(aSF3[i])=="N"
						aResCFOZer[nPos,i]+=aSF3[i]
					Endif
				Next i
			Endif

		EndIf
	EndIf 
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Acumula valores de operacoes interestaduais                                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dAuxData := F3_ENTRADA

IF Empty(F3_DTCANC) //Nao gera resumo para notas fiscais canceladas 
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica se foi passada a filial pelo cArqSF3 (Matr920)³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cArqSF3 <> Nil
		IF !Empty((cArqSF3)->RECNOF3)
			cFilProc := (cArqSF3)->FILIAL
		Else
			cFilProc := cFilAnt
		Endif
	Else
		cFilProc := cFilAnt
	Endif

	IF lAglutina .And. nTipomov <> 1
	   	cAliasSF3 :=ALIAS()
	   	dbSelectArea("SF3")
	   	dbsetorder(1)

	   	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	   	//³Verifica se o mes/ano da chave e o mesmo do mes que esta sendo processado³
	   	//³para nao aglutinar varios meses em um resumo somente.                    ³
	   	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	   	(cArqSF3)->(dbSetOrder(2))
	   	(cArqSF3)->(dbGoTop())
	 	(cArqSF3)->(MSSeek(" " + StrZero(Month(dAuxData),2) + StrZero(Year(dAuxData),4)))

	    While !(cArqSF3)->(EOF()) .And. ;
				StrZero(Month(dAuxData),2) == (cArqSF3)->MES .And. ;
				StrZero(Year(dAuxData),4) == (cArqSF3)->ANO			

			If (cArqSF3)->CONTR != "*"
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Posiciona na filial em que foi processado o registro	³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				Mtr930Fil(aAreaSM0,(cArqSF3)->FILIAL,1)

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Verifica o valor do ICMS Retido de acordo com a configuracao da TES     ³
				//³Quando o campo F3_CREST existir e estiver configurado como "4",         ³
				//³o valor do ICMS retido nao deve ser apresentado na coluna de observacoes³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				lProcST := .T.
				If F3_CREDST == "4" .And. lP1IcmST .And. F3_CFO < "5"
					lProcST := .T.  
				Elseif (cArqTemp)->F3_CREDST == "4" .And. (lExist .Or. !lP1IcmST )
					lProcST := .F. 
				Elseif !lExist
					lProcST := .T.
				Endif

				SF3->(dbGoTo((cArqSF3)->RECNOF3))
	
				If F3_FORMUL<>"S"

					lContrib := Iif((cArqTemp)->CONTRIB == "1", .T., .F.)

					cInscr := (cArqTemp)->INSCR //If( F3_TIPO$"DB",SA2->A2_INSCR,SA1->A1_INSCR)
					cTipo  := (cArqTemp)->TIPO  //If( F3_TIPO$"DB",SA2->A2_TIPO,SA1->A1_TIPO)
					cContrib := Iif(!lContrib,"NC","CO")
					
		         	nPos:=Ascan(aResumo,{|x|x[1]==cContrib.and.x[2]==F3_ESTADO})

		            If (Subs(F3_CFO,1,3) $ "999#000") // nao imprimi demonstrativo para transferencias	
		                If nPos==0
			                        AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
			                        F3_ESTADO,;// [2] Estado
			                                0.00,; // [3] Valor Contabil
			                                0.00,; // [4] Base de Calculo
			                                0.00,; // [5] ICMS Outras
			                                0.00,; // [6] ICMS Retido
			                                0.00,; // [7] ICMS Isento
			       	                        0.00,; // [08] Valor do ICMS 
			       	                        0.00,; // [09] Base de Calculo IPI
			       	                        0.00,; // [10] Valor do IPI  
			        	                    0.00,; // [11] IPI Isento    
                                            0.00,; // [12] IPI Outras 
				      	                    0.00,; // [13] ICMS NORMAL
				       	                    0.00,; // [14] ICMS ST. INT.
				      	                    0.00,; // [15] CRED PRES ST
				      	            aSX6[MV_ESTADO],; // [16] UF onde esta localizada a Matriz/Filial    
				      	                    0.00,; // [17] Valor antecipacao
				      	                    0.00,; // [18] Valor ICMS sem debito decreto 43.080/02
					   	                    0.00,; // [19] Valor incentivo a prod.leite-MG
				      	                    0.00,; // [20] BASENDES
				      	                    0.00}) // [21] ICMNDES				      
                        Endif
		            Else
		                If nPos==0
			       		    If F3_TIPO<>"S"                   
			                    If lRemAmb
			                        AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
			                        F3_ESTADO,;	// [2] Estado
			                                0,;	// [3] Valor Contabil
			                 				0,;	// [4] Base de Calculo
			                   				0,;	// [5] ICMS Outras             
					           				0,;	// [6] ICMS Retido
				   	           				0,;	// [7] ICMS Isento
			       	           				0,;	// [08] Valor do ICMS 
			       	         				0,;	// [09] Base de Calculo IPI
			       	           				0,;	// [10] Valor do IPI  
			       	           				0,;	// [11] IPI Isento    
			       	           				0,; // [12] IPI Outras 
			       	           				0,; // [13] ICMS NORMAL  
			       	        				0,; // [14] ICMS ST. INT.	
			       	    				    0,; //[15] CRED PRES ST
			       	           		aSX6[MV_ESTADO],;// [16] UF onde esta localizada a Matriz/Filial
				               				0,;	// [17] Valor antecipacao			           	  
			                   				0,; // [18] Valor ICMS sem debito de impsoto decreto 43.080/02			        
			                   				0,; // [19] Valor incentivo a prod.leite-MG
			                 				0,;	// [20] BASENDES
				      			 			0})	// [21] ICMNDES	
			               		Else  
			                  		AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
			                   				F3_ESTADO,;	// [2] Estado
			                   				F3_VALCONT,;// [3] Valor Contabil
			                   				F3_BASEICM,;// [4] Base de Calculo
			                 		        F3_OUTRICM,;// [5] ICMS Outras             
					           				Iif(lProcST,F3_ICMSRET-IIF(lExist,F3_OBSSOL,0),0),;	// [6] ICMS Retido
				   	           		        F3_ISENICM,;// [7] ICMS Isento
			       	           	         	F3_VALICM,;	// [08] Valor do ICMS 
											F3_BASEIPI,;// [09] Base de Calculo IPI
											F3_VALIPI,;	// [10] Valor do IPI  
			       	          				F3_ISENIPI,;// [11] IPI Isento    
											F3_OUTRIPI,;// [12] IPI Outras	   
			       	           				IIF(lExist,F3_OBSICM,0),;// [13] ICMS NORMAL  
			       	         				IIF(lExist,F3_OBSSOL,0),;// [14] ICMS ST. INT.	
			       	           				IIF(lProcST,F3_CRPRST, 0),;//[15] CRED PRES ST
			       	           				aSX6[MV_ESTADO],;// [16] UF onde esta localizada a Matriz/Filial
				               				F3_VALANTI,;// [17] Valor antecipacao			           	  
			                   				F3_VL43080,;// [18] Valor ICMS sem debito de impsoto decreto 43.080/02			        
			     	           				F3_VLINCMG,;// [19] Valor incentivo a prod.leite-MG
			     	          				F3_BASNDES,;
			     	           				F3_ICMNDES})  
			     	            EndIf
			     	        Endif
		                Else 
					        If F3_TIPO<>"S"
			                    If lRemAmb
			                        aResumo[nPos,3]+=0
			                        aResumo[nPos,4]+=0
			                        aResumo[nPos,5]+=0
				                    aResumo[nPos,6]+=0
				                    aResumo[nPos,7]+=0
		        		                aResumo[nPos,08]+=0
				       	            aResumo[nPos,09]+=0
				       	            aResumo[nPos,10]+=0
				           	        aResumo[nPos,11]+=0
				           	        aResumo[nPos,12]+=0		              
				           	        aResumo[nPos,13]+=0
				           	        aResumo[nPos,14]+=0
				           	        aResumo[nPos,15]+=0
				           	        aResumo[nPos,17]+=0
				           	        aResumo[nPos,18]+=0			           	  
				           	        aResumo[nPos,19]+=0
								    aResumo[nPos,20]+=0
				           	   	    aResumo[nPos,21]+=0				           	  
						        Else
				                    aResumo[nPos,3]+=F3_VALCONT
				                    aResumo[nPos,4]+=F3_BASEICM
				                    aResumo[nPos,5]+=F3_OUTRICM
				                    aResumo[nPos,6]+=Iif(lProcST,F3_ICMSRET-IIF(lExist,F3_OBSSOL,0),0)
				                    aResumo[nPos,7]+=F3_ISENICM
			       		            aResumo[nPos,08]+=F3_VALICM
									aResumo[nPos,09]+=F3_BASEIPI
									aResumo[nPos,10]+=F3_VALIPI
				           	        aResumo[nPos,11]+=F3_ISENIPI
									aResumo[nPos,12]+=F3_OUTRIPI
				           	        aResumo[nPos,13]+=IIF(lExist,F3_OBSICM,0)
				           	        aResumo[nPos,14]+=IIF(lExist,F3_OBSSOL,0)
				           	        aResumo[nPos,15]+=IIF(lProcST, F3_CRPRST,0)
				           	        aResumo[nPos,17]+=F3_VALANTI
				           	        aResumo[nPos,18]+=F3_VL43080			           	  
				           	        aResumo[nPos,19]+=F3_VLINCMG
				           	        aResumo[nPos,20]+= F3_BASNDES
				           	        aResumo[nPos,21]+= F3_ICMNDES		           	  
				   		        Endif
			                Endif
                        EndIf
		            Endif   
	            Endif       
	 		    RecLock(cArqSF3,.F.)
	            (cArqSF3)->CONTR :="*"
	            (cArqSF3)->(MsUnLock())
				Mtr930Fil(aAreaSM0,(cArqSF3)->FILIAL,2)
	        Endif   	        
	        dbSelectArea("SF3")
			(cArqSF3)->(dbSkip())
	    Enddo
	    (cArqSF3)->(dbSetOrder(1))
	    dbselectarea(cAliasSF3)
	Else                                           
  	    Mtr930Fil(aAreaSM0,cFilProc,1)	 	   

			lContrib := Iif((cArqTemp)->CONTRIB == "1", .T., .F.)

            //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		    //³Verifica o valor do ICMS Retido de acordo com a configuracao da TES     ³
		    //³Quando o campo F3_CREST existir e estiver configurado como "4",         ³
		    //³o valor do ICMS retido nao deve ser apresentado na coluna de observacoes³
		    //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
            lProcST := .T.
       	    If F3_CREDST == "4" .And. lP1IcmST .And. F3_CFO < "5"
            	lProcST := .T.  
            Elseif (cArqTemp)->F3_CREDST == "4" .And. (lExist .Or. !lP1IcmST ) 
			    lProcST := .F.  
            Elseif !lExist
			 	lProcST := .T.
            Endif

		    If nTipoMov==1
			    cInscr := (cArqTemp)->INSCR //If( F3_TIPO$"DB",SA1->A1_INSCR,SA2->A2_INSCR)
			    cTipo  := (cArqTemp)->TIPO  //If( F3_TIPO$"DB",SA1->A1_TIPO,SA2->A2_TIPO)
			    cContrib := Iif(!lContrib,"NC","CO")
	        else
			    cInscr := (cArqTemp)->INSCR //If( F3_TIPO$"DB",SA2->A2_INSCR,SA1->A1_INSCR)
			    cTipo  := (cArqTemp)->TIPO  //If( F3_TIPO$"DB",SA2->A2_TIPO,SA1->A1_TIPO)
	            cContrib := Iif(!lContrib,"NC","CO")
		    EndIf		    

		    cUfDes := Iif(nTipoMov==1 .And. cUfForCte=="1" .And. AllTrim((cArqTemp)->F3_ESPECIE)=="CTE", (cArqTemp)->EST, F3_ESTADO)		    
			nPos:=Ascan(aResumo,{|x|x[1]==cContrib.and.x[2]==cUfDes})
	        If (Subs(F3_CFO,1,3) $ "999#000") // nao imprimi demonstrativo para transferencias								
		        If nPos==0
			 			AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
	  		 			cUfDes,;// [2] Estado
								0.00,;// [3] Valor Contabil
			 					0.00,;// [4] Base de Calculo
			 					0.00,;// [5] ICMS Outras
			 					0.00,;// [6] ICMS Retido
	         					0.00,;// [7] ICMS Isento
	   	     					0.00,;// [08] Valor do ICMS
		     					0.00,;// [09] Base de Calculo IPI
		     					0.00,;// [10] Valor do IPI
		     					0.00,;// [11] IPI Isento
             					0.00,;// [12] IPI Outras
			 					0.00,;// [13] ICMS NORMAL
		     					0.00,;// [14] ICMS ST. INT.
		     					0.00,;// [15] CRED PRES ST
		    	 		aSX6[MV_ESTADO],;// [16] UF onde esta localizada a Matriz/Filial
     						    0.00,;// [17] Valor antecipacao  
     		 					0.00,;// [18] Valor ICMS sem debito de impsoto decreto 43.080/02
     		 					0.00,;// [19] Valor incentivo a prod.leite-MG
     							0.00,;// BASNDES
     		 					0.00})// ICMNDES
	            Endif
	        Else
		        If nPos==0
		            If lRemAmb
			            AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
	  		            	cUfDes,;// [2] Estado
  			                    0,;// [3] Valor Contabil
   			                    0,;// [4] Base de Calculo
			                    0,;// [5] ICMS Outras
			                    0,;// [6] ICMS Retido
			                    0,;// [7] ICMS Isento
			                    0,;// [08] Valor do ICMS 
			                    0,;// [09] Base de Calculo IPI
						        0,;// [10] Valor do IPI  
			    				0,;// [11] IPI Isento    
							    0,;// [12] IPI Outras 
			    				0,;// [13] ICMS NORMAL   
				     			0,;// [14] ICMS ST. INT.
	            	 			0,;//[15] CRED PRES ST
			        	aSX6[MV_ESTADO],;// [16] UF onde esta localizada a Matriz/Filial
	 						    0,;// [17] Valor antecipacao
				 		        0,;// [18] Valor ICMS sem debito de imposto decreto 43.080/02
	 					        0,;// [19] Valor incentivo a prod.leite-MG
	 		     				0,;// [20] BASNDES
	 		                    0})// [21] ICMNDES
			        Else
			            AADD(aResumo,{	cContrib,;// [1] Flag de Contribuinte
	  		            		Iif(lMV_ESTCLI .AND. nTipoMov==2 .AND. F3_CLIEFOR<>F3_CLIENT,(cArqTemp)->EST,cUfDes),;// [2] Estado
  			                    aSF3[ColF3("F3_VALCONT")],;// [3] Valor Contabil
   			                    aSF3[ColF3("F3_BASEICM")],;// [4] Base de Calculo
             			        aSF3[ColF3("F3_OUTRICM")],;// [5] ICMS Outras
			            		Iif(lProcST,aSF3[ColF3("F3_ICMSRET")]-IIF(lExist,aSF3[ColF3("F3_OBSSOL")],0),0),;// [6] ICMS Retido
			                    aSF3[ColF3("F3_ISENICM")],;// [7] ICMS Isento
			   				    aSF3[ColF3("F3_VALICM")],;// [08] Valor do ICMS 
			          		  	aSF3[ColF3("F3_BASEIPI")],;  // [09] Base de Calculo IPI
			         		  	aSF3[ColF3("F3_VALIPI")],; // [10] Valor do IPI  
			                    aSF3[ColF3("F3_ISENIPI")],;// [11] IPI Isento    
			            		aSF3[ColF3("F3_OUTRIPI")],;// [12] IPI Outras 
			            		IIF(lExist,aSF3[ColF3("F3_OBSICM")],0),;// [13] ICMS NORMAL   
			            		IIF(lExist,aSF3[ColF3("F3_OBSSOL")],0),;// [14] ICMS ST. INT.
	                    		IIF(lProcST, aSF3[ColF3("F3_CRPRST")], 0),;//[15] CRED PRES ST
	        					aSX6[MV_ESTADO],;// [16] UF onde esta localizada a Matriz/Filial
	 		     	     		aSF3[ColF3("F3_VALANTI")],;// [17] Valor antecipacao
	 		             		aSF3[ColF3("F3_VL43080")],;// [18] Valor ICMS sem debito de imposto decreto 43.080/02
			 		            aSF3[ColF3("F3_VLINCMG")],;// [19] Valor incentivo a prod.leite-MG
	 		    		    	aSF3[ColF3("F3_BASNDES")],;// [20] BASNDES
	 		                    aSF3[ColF3("F3_ICMNDES")]})
			        EndIf
		        Else 
		       		If !lRemAmb
				                aResumo[nPos,03]+=aSF3[ColF3("F3_VALCONT")]
				                aResumo[nPos,04]+=aSF3[ColF3("F3_BASEICM")]
				                aResumo[nPos,05]+=aSF3[ColF3("F3_OUTRICM")]
			    	            aResumo[nPos,06]+=Iif(lProcST,(aSF3[ColF3("F3_ICMSRET")]-IIF(lExist,aSF3[ColF3("F3_OBSSOL")],0)),0)
			                    aResumo[nPos,07]+=aSF3[ColF3("F3_ISENICM")]
			          	        aResumo[nPos,08]+=aSF3[ColF3("F3_VALICM")]
        		                aResumo[nPos,09]+=aSF3[ColF3("F3_BASEIPI")]
			                    aResumo[nPos,10]+=aSF3[ColF3("F3_VALIPI")]
			           	        aResumo[nPos,11]+=aSF3[ColF3("F3_ISENIPI")]
			                    aResumo[nPos,12]+=aSF3[ColF3("F3_OUTRIPI")]
			                    aResumo[nPos,13]+=IIF(lExist,aSF3[ColF3("F3_OBSICM")],0)
			            	    aResumo[nPos,14]+=IIF(lExist,aSF3[ColF3("F3_OBSSOL")],0)
			        	        aResumo[nPos,15]+=IIF(lProcST,aSF3[ColF3("F3_CRPRST")],0)
                	            aResumo[nPos,17]+=aSF3[ColF3("F3_VALANTI")]	
            	                aResumo[nPos,18]+=aSF3[ColF3("F3_VL43080")]		           	  
	                            aResumo[nPos,19]+=aSF3[ColF3("F3_VLINCMG")]
	    	                    aResumo[nPos,20]+= aSF3[ColF3("F3_BASNDES")]
		                        aResumo[nPos,21]+= aSF3[ColF3("F3_ICMNDES")]		           	  
		            EndIf
		        Endif
		    Endif   
	        //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	        //³Restaura a filial e area corrente ³
	        //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	        Mtr930Fil(aAreaSM0,cFilProc,2)
	Endif
Endif
dbSelectArea(cSvAlias)

RETURN
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ LivrArrayObs ³Autor ³ Juan Jose Pereira    ³Data³ 17/02/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Cria array com mensagens da coluna de observacoes          ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION LivrArrayObs(nTamObs,aArray, lListaNFO, cCFO, lObsFecp, nCol920, cChaveSFT )

Local aSF3 		 := {}//SF3->(GetArea())
Local aColObs	 := {}, lArray:=(aArray==NIL), xx:=0, cMensagem := ""
Local aSave		 := {}//{Alias(),IndexOrd(),Recno()}
Local lExist 	 := Iif(lArray,Iif((cArqTemp)->F3_OBSSOL>0,.T.,.F.),Iif(aArray[ColF3("F3_OBSSOL")]>0,.T.,.F.))
Local aArea 	 := {}
Local aAreaSM0 	 := SM0->(GetArea())
Local lP1IcmST	 := aSX6[MV_P1ICMST]
Local lProcST	 := .T.
// Verifica se o valor do ICMS do frete autonomo devera ser apresentado nas observacoes do livro
Local lIcmAuto	 := aSX6[MV_FAUT930]
Local nValor     := 0 
Local aDadSf3    := {}
Local cEntSai    := ""
Local lSAT       := aSX6[MV_R930SAT]
Local lCSS       := Iif(aSX6[MV_IMPCSS] == "S",.T.,.F.)
Local nI	     := 0
Local lF3NFCanc  := .F.
Local cAliasSD1	 := ""
Local cAliasSD2	 := ""
Local cAliasINSS := ""
Local aInsert	 := {}
Local lposF3	 := .F.


Default lListaNFO	:=	.F.
Default lObsFecp	:=	.F.
Default cCFO		:= ""
Default nCol920		:= 1
Default cChaveSFT	:= ""

if type( "nColuna" ) =="U"
	nColuna := 1
EndIF
If FWIsInCallStack('MATR921')
	nColuna := nCol920
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Posiciona na filial em que foi processado o registro	³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1) 

If lArray
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Este posicionamento se faz necessario quando da utilizacao dos campos do SF3 na formula ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF (cArqTemp)->RECNOSF3 > 0 .And. (!Empty((cArqTemp)->F3_FORMULA) .And. !( STR0022$(cArqTemp)->F3_OBSERV .Or. "NF DENEGADA"$(cArqTemp)->F3_OBSERV .Or. "NF INUTILIZADA"$(cArqTemp)->F3_OBSERV  ))	//"CANCELADA" ou DENEGADA ou INUTILIZADA
	    lposF3 := .T.
		aSF3 		 := SF3->(GetArea())	
		aSave		 := {Alias(),IndexOrd(),Recno()}

		dbSelectArea("SF3")
		SF3->(dbSetOrder(1))
		SF3->(dbGoTo((cArqTemp)->RECNOSF3))
	Endif

	IF !Empty((cArqTemp)->F3_CODRSEF) .and. ((lF3Difal .and. (cArqTemp)->F3_DIFAL>0) .or. (lF3FCDifal .and. (cArqTemp)->F3_VFCPDIF>0))
		lF3NFCanc := Iif(!(cArqTemp)->(Eof()) .And. (!Empty((cArqTemp)->F3_DTCANC) .Or. (cArqTemp)->F3_CODRSEF $ XFUNCodSef({"I","D"})), .T., .F.)
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica o valor do ICMS Retido de acordo com a configuracao da TES     ³
	//³Quando o campo F3_CREST existir e estiver configurado como "4",         ³
	//³o valor do ICMS retido nao deve ser apresentado na coluna de observacoes³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lProcST := .T.
	If (cArqTemp)->F3_CREDST == "4" .And. lP1IcmST .And. (cArqTemp)->F3_CFO < "5"
		lProcST := .T. 
	Elseif (cArqTemp)->F3_CREDST == "4" .And. (lExist .Or. !lP1IcmST )
		lProcST := .F.
	Elseif !lExist
		lProcST := .T.
	Endif

   If !Empty((cArqTemp)->F3_OBSERV)
	   	aArea := GetArea ()
	   	//
   		If nModelo==1 .Or. nModelo==2
	   	   	If (lListaNFO) .And. ("N.F.ORIG.: DIVERSAS"$(cArqTemp)->F3_OBSERV)		   		
				cMensagem := Substr ((cArqTemp)->F3_OBSERV, 1, At(":", (cArqTemp)->F3_OBSERV)+1)
				
				Aadd(aInsert,{'C',(cArqTemp)->F3_NFISCAL})
				Aadd(aInsert,{'C',(cArqTemp)->F3_SERIE})
				Aadd(aInsert,{'C',(cArqTemp)->F3_CLIEFOR})
				Aadd(aInsert,{'C',(cArqTemp)->F3_LOJA})
				Aadd(aInsert,{'C',(cArqTemp)->F3_CFO})

				IF R930Filtro(1,"ENT_N.F.ORIG",@cAliasSD1,aInsert) //Verifica se encontra alguma nota com as caracteristicas passada
									
										
					Do While !(cAliasSD1)->(Eof ())						
						cMensagem += AllTrim((cAliasSD1)->D1_NFORI+"/"+SerieNfId(cAliasSD1,2,"D1_SERIORI"))+", "						
						(cAliasSD1)->(DbSkip ())
					EndDo
					
					cMensagem := SubStr (cMensagem, 1, Len (cMensagem)-2)
					
					//Fecha Alias
					R930Filtro(2,"",@cAliasSD1)					
				Endif
		   	Else
				cMensagem := Trim((cArqTemp)->F3_OBSERV)
		    EndIf
	
			If lCSS	
				If Empty( cChaveSFT )			
					If (cArqTemp)->CONTSOC > 0 
						AADD(aColObs,{STR0092,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->CONTSOC,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->VLSENAR > 0 
						AADD(aColObs,{STR0093,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->VLSENAR,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->INSS > 0 
						AADD(aColObs,{STR0094,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->INSS,"@E 999,999,999.99")),.T.})
					EndIf
				Else
					If (cArqTemp)->F3_VALFUN > 0
						AADD(aColObs,{STR0092,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->F3_VALFUN,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->F3_VLSENAR > 0
						AADD(aColObs,{STR0093,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->F3_VLSENAR,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->INSS > 0 //Indica que Nota possui calculo de INSS / Baixo somo apenas os filos deste SF3 pelo FT_IDENTF3
						IF (cArqTemp)->COUNTF3 > 1 
							Aadd(aInsert,{'C',"E"})
							Aadd(aInsert,{'C',(cArqTemp)->F3_CLIEFOR})
							Aadd(aInsert,{'C',(cArqTemp)->F3_LOJA})
							Aadd(aInsert,{'C',(cArqTemp)->F3_SERIE})						
							Aadd(aInsert,{'C',(cArqTemp)->F3_NFISCAL})
							Aadd(aInsert,{'C',(cArqTemp)->F3_IDENTFT})

							IF R930Filtro(1,"FT_VALINS",@cAliasINSS,aInsert)
								AADD(aColObs,{STR0094,.T.})
								AADD(aColObs,{Alltrim(Transform((cAliasINSS)->FT_VALINS,"@E 999,999,999.99")),.T.})
								
								//Fecha Alias
								R930Filtro(2,"",@cAliasINSS)					
							Endif
						Else
							// Quando possuir apenas uma SF3 não é nescessario ir para SF3, SF2 resolve							
							AADD(aColObs,{STR0094,.T.})
							AADD(aColObs,{Alltrim(Transform((cArqTemp)->INSS,"@E 999,999,999.99")),.T.})
						Endif
					EndIf
				Endif
			EndIf
   	  	Else
	   	   	If (lListaNFO) .And. (("Dev. terc. N.F.ORIG.: DIVERSAS"$(cArqTemp)->F3_OBSERV) .Or. ("N.F.ORIG.: DIVERSAS"$(cArqTemp)->F3_OBSERV))
		   		cMensagem := Substr ((cArqTemp)->F3_OBSERV, 1, At(":", (cArqTemp)->F3_OBSERV)+1)
	   		    
				Aadd(aInsert,{'C',(cArqTemp)->F3_NFISCAL})
				Aadd(aInsert,{'C',(cArqTemp)->F3_SERIE})
				Aadd(aInsert,{'C',(cArqTemp)->F3_CLIEFOR})
				Aadd(aInsert,{'C',(cArqTemp)->F3_LOJA})
				Aadd(aInsert,{'C',(cArqTemp)->F3_CFO})

				IF R930Filtro(1,"SAI_N.F.ORIG",@cAliasSD2,aInsert) //Verifica se encontra alguma nota com as caracteristicas passada	
					
										
					Do While !(cAliasSD2)->(Eof ())						
						cMensagem += AllTrim((cAliasSD2)->D2_NFORI+"/"+SerieNfId(cAliasSD2,2,"D2_SERIORI"))+", "						
						(cAliasSD2)->(DbSkip ())
					EndDo
					
					cMensagem := SubStr (cMensagem, 1, Len (cMensagem)-2)
					
					//Fecha Alias
					R930Filtro(2,"",@cAliasSD2)					
				Endif

		   	Else
				cMensagem := Trim((cArqTemp)->F3_OBSERV)
		    EndIf

			If lCSS	
				If Empty( cChaveSFT )
					If (cArqTemp)->CONTSOC > 0 
						AADD(aColObs,{STR0092,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->CONTSOC,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->VLSENAR > 0
						AADD(aColObs,{STR0093,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->VLSENAR,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->INSS > 0 
						AADD(aColObs,{STR0094,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->INSS,"@E 999,999,999.99")),.T.})
					EndIf
				Else
					cValINS := 0

					If(cArqTemp)->F3_VALFUN > 0
						AADD(aColObs,{STR0092,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->F3_VALFUN,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->F3_VLSENAR > 0
						AADD(aColObs,{STR0093,.T.})
						AADD(aColObs,{Alltrim(Transform((cArqTemp)->F3_VLSENAR,"@E 999,999,999.99")),.T.})
					EndIf
					If (cArqTemp)->INSS > 0 //Indica que Nota possui calculo de INSS / Baixo somo apenas os filos deste SF3 pelo FT_IDENTF3
						IF (cArqTemp)->COUNTF3 > 1 
							Aadd(aInsert,{'C',"S"})
							Aadd(aInsert,{'C',(cArqTemp)->F3_CLIEFOR})
							Aadd(aInsert,{'C',(cArqTemp)->F3_LOJA})
							Aadd(aInsert,{'C',(cArqTemp)->F3_SERIE})						
							Aadd(aInsert,{'C',(cArqTemp)->F3_NFISCAL})
							Aadd(aInsert,{'C',(cArqTemp)->F3_IDENTFT})

							IF R930Filtro(1,"FT_VALINS",@cAliasINSS,aInsert)
								AADD(aColObs,{STR0094,.T.})
								AADD(aColObs,{Alltrim(Transform((cAliasINSS)->FT_VALINS,"@E 999,999,999.99")),.T.})
								
								//Fecha Alias
								R930Filtro(2,"",@cAliasINSS)					
							Endif
						Else
							// Quando possuir apenas uma SF3 não é nescessario ir para SF3, SF2 resolve							
							AADD(aColObs,{STR0094,.T.})
							AADD(aColObs,{Alltrim(Transform((cArqTemp)->INSS,"@E 999,999,999.99")),.T.})
						Endif
					EndIf
				Endif
			EndIf 		
   	  	EndIf
	    
		For xx:=1 to MlCount(cMensagem,nTamObs)
	  	   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
	   RestArea (aArea) 	
   Endif
   If !lSAT .And. !Empty((cArqTemp)->F3_SERSAT) .And. !Empty((cArqTemp)->F3_PDV)
	   AADD(aColObs,{MemoLine("SÉRIE CFe-SAT: "+(cArqTemp)->F3_SERSAT, nTamObs),.T.})
   Endif
   If aModNoT((cArqTemp)->F3_ESPECIE) $ "06|21|22" .And. SUBSTR((cArqTemp)->F3_CFO,1,1) $ "5|6|7"
   		nReg115++
   		nVolume := IIF(nReg115>=nRegPerm,nVolume++,nVolume)
		cMensagem := aSX6[MV_ESTADO]+Alltrim((cArqTemp)->F3_SERIE)+Alltrim(STR(Year(dDtIni)))+StrZero(Month(dDtIni),2);
		+"N"+"M"+"."+StrZero(nVolume,3)

		AADD(aColObs,{MemoLine(cMensagem,nTamObs),.T.})

		cMensagem := (cArqTemp)->F3_MDCAT79
		For xx:=1 to MlCount(cMensagem,nTamObs)
		      AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	    Next xx


		IIF(nReg115>nRegPerm,nReg115:=0,nReg115)
   Endif
   If !Empty((cArqTemp)->F3_FORMULA) .And. !( STR0022$(cArqTemp)->F3_OBSERV .Or. "NF DENEGADA"$(cArqTemp)->F3_OBSERV .Or. "NF INUTILIZADA"$(cArqTemp)->F3_OBSERV  )	//"CANCELADA" ou DENEGADA ou INUTILIZADA
	   cMensagem:=Formula((cArqTemp)->F3_FORMULA)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Tratamento especifico para escrituracao de Nota sobre Cupom.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
       If aSX6[MV_LJLVFIS] <> 2 .And. Valtype(cMensagem)=="C"	   
	      For xx:=1 to MlCount(cMensagem,nTamObs)
		      AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	      Next xx
	   Else
	      If Valtype(cMensagem)=="C"	      
		      If "S" <> Alltrim(cMensagem) .AND. !Empty(cMensagem)
		         For xx:=1 to MlCount(cMensagem,nTamObs)
			        AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		         Next xx	      
		      EndIf
		  EndIf
	   EndIf
   Endif
   If (cArqTemp)->F3_VALOBSE>0 .And. (cArqTemp)->F3_VALCONT>0
      If (cArqTemp)->F3_DESCZFR>0
         cMensagem:=STR0028+Alltrim(TransForm((cArqTemp)->F3_VALOBSE,Alltrim(aPict[PF3_VALOBSE])))+" ,SENDO "+Alltrim(TransForm((cArqTemp)->F3_DESCZFR,Alltrim(aPict[PF3_DESCZFR])))+" DESCONTO ZFM"
	  Else                                                                                                    
	     cMensagem:=STR0028+Alltrim(TransForm((cArqTemp)->F3_VALOBSE,Alltrim(aPict[PF3_VALOBSE]))) //"DESCONTO.....: "
	  Endif
	  //	   
	  For xx:=1 to MlCount(cMensagem,nTamObs)
	  	AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  	  Next xx
   Else
	  If (cArqTemp)->F3_DS43080>0
		  cMensagem:=STR0028+Alltrim(TransForm((cArqTemp)->F3_DS43080,Alltrim(aPict[PF3_DS43080]))) //"DESCONTO.....: "
		  For xx:=1 to MlCount(cMensagem,nTamObs)
			  AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		  Next xx
	  EndIf    
   Endif
   If (nModelo==1 .Or. nModelo==2) .And. aSX3[FP_F3_BASNDES] .And. aSX3[FP_F3_ICMNDES]
      If (cArqTemp)->F3_BASNDES>0 .And. (cArqTemp)->F3_ICMNDES>0
         cMensagem:="B.ICMS ST An.: "+Alltrim(TransForm((cArqTemp)->F3_BASNDES,Alltrim(aPict[PF3_BASNDES])))+" ICMS ST Ant.: "+Alltrim(TransForm((cArqTemp)->F3_ICMNDES,Alltrim(aPict[PF3_ICMNDES])))
         For xx:=1 to MlCount(cMensagem,nTamObs)
         	AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
      	  Next xx
      Endif        
   Endif
   
   If (cArqTemp)->F3_VLINCMG > 0
		cEntSai := IIf(Left((cArqTemp)->F3_CFO,1)<"5","E","S")        
		If (cArqTemp)->F3_TIPO=="D"
       	cEntSai := Iif(cEntSai=="E","S","E")
       Endif	        

		SFT->(DbSetOrder(1),MsSeek(xFilial("SFT")+cEntSai+(cArqTemp)->(F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA)))
   		Do While !SFT->(Eof()) .And. xFilial("SFT")==SFT->FT_FILIAL .And. (cArqTemp)->F3_NFISCAL==SFT->FT_NFISCAL .And.;
   		   (cArqTemp)->F3_SERIE==SFT->FT_SERIE .And. (cArqTemp)->F3_CLIEFOR==SFT->FT_CLIEFOR .And. (cArqTemp)->F3_LOJA==SFT->FT_LOJA
			If SFT->FT_PRINCMG > 0
				cMensagem:=Alltrim(TransForm(SFT->FT_PRINCMG,Alltrim(aPict[PFT_PRINCMG])))+"% de Incentivo do leite-MG." 
				For xx:=1 to MlCount(cMensagem,nTamObs)
				    AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
				    Next xx
				Exit
			EndIf
	   		SFT->(DbSkip ())
		EndDo
   EndIf    

   If cMV_ESTADO=="RN"        
       
       If RetValFecp( (cArqTemp)->F3_VFECPRN , (cArqTemp)->F3_VALFECP) >0
           cMensagem:="BASE CALC.: "+Alltrim(TransForm(F3_BASEICM,Alltrim(aPict[PF3_BASEICM])))+"-FECOP: "+Alltrim(TransForm(RetValFecp( (cArqTemp)->F3_VFECPRN , (cArqTemp)->F3_VALFECP),Alltrim(aPict[PF3_VALFECP]))) 
           For xx:=1 to MlCount(cMensagem,nTamObs)
               AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  	       Next xx  
  		
  	   ElseIf RetValFecp( (cArqTemp)->F3_VFESTRN , (cArqTemp)->F3_VFECPST) >0
           cMensagem:="BASE CALC.: "+Alltrim(TransForm((cArqTemp)->F3_BASEICM,Alltrim(aPict[PF3_BASEICM])))+"-FECOP-ST: "+Alltrim(TransForm(RetValFecp( (cArqTemp)->F3_VFESTRN , (cArqTemp)->F3_VFECPST),Alltrim(aPict[PF3_VFECPST]))) 
           For xx:=1 to MlCount(cMensagem,nTamObs)
               AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  	       Next xx  	   
  	   EndIf   
   EndIf
   If cMV_ESTADO=="MG" .And. Empty((cArqTemp)->F3_VALFECP)
   		//-----------------------------------------------------------------------------------------------------
		//Observacoes - FECP MG
		//-----------------------------------------------------------------------------------------------------
		If (cArqTemp)->F3_VFECPMG > 0
			cMensagem	:=	RetObsFECP((cArqTemp)->F3_VFECPMG,(cArqTemp)->F3_CFO,Iif((cArqTemp)->F3_CFO<"5",(cArqTemp)->F3_ESTADO,cMV_ESTADO),.F.)
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif

		//-----------------------------------------------------------------------------------------------------
		//Observacoes - FECP MG
		//-----------------------------------------------------------------------------------------------------
		If (cArqTemp)->F3_VFESTMG > 0
			cMensagem	:=	RetObsFECP((cArqTemp)->F3_VFESTMG,(cArqTemp)->F3_CFO,Iif((cArqTemp)->F3_CFO<"5",(cArqTemp)->F3_ESTADO,cMV_ESTADO),.T.)
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif
   EndIf
   	If lObsFecp
		//-----------------------------------------------------------------------------------------------------
		//Observacoes - FECP
		//-----------------------------------------------------------------------------------------------------
		If (cArqTemp)->F3_VALFECP > 0
			cMensagem	:=	RetObsFECP((cArqTemp)->F3_VALFECP,(cArqTemp)->F3_CFO,Iif((cArqTemp)->F3_CFO<"5",(cArqTemp)->F3_ESTADO,cMV_ESTADO),.F.)
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif

		//-----------------------------------------------------------------------------------------------------
		//Observacoes - FECP ST
		//-----------------------------------------------------------------------------------------------------
		If (cArqTemp)->F3_VFECPST > 0
			cMensagem	:=	RetObsFECP((cArqTemp)->F3_VFECPST,(cArqTemp)->F3_CFO,Iif((cArqTemp)->F3_CFO<"5",(cArqTemp)->F3_ESTADO,cMV_ESTADO),.T.)
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif
	Endif
   //
   If (cArqTemp)->F3_IPIOBS>0
	   cMensagem:=STR0029+Alltrim(TransForm((cArqTemp)->F3_IPIOBS,Alltrim(aPict[PF3_IPIOBS]))) //"IPI..........: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If Empty(cTitLivro) .and. (cArqTemp)->F3_ICMSRET-IIF(lExist,(cArqTemp)->F3_OBSSOL,0) >0  .and. (nColuna == 1 .Or. nColuna == 3 .Or. ((cArqTemp)->F3_CREDST == '4' .And. lP1IcmST)) .And. (lProcST .or. (DDia != dDiaAnt .and. !lArray))
	   If !lExist
		   aDadSF3 := {}
		   aAdd(aDadSF3,{xFilial("SF3"), (cArqTemp)->F3_CREDST, (cArqTemp)->F3_BASERET, (cArqTemp)->F3_ICMSRET,  (cArqTemp)->F3_OBSSOL})
	   	   nValor := VerICMRET("F3_BASERET", (cArqTemp)->F3_BASERET,    , aDadSf3, lP1IcmST)		
		   cMensagem:=STR0030+Alltrim(TransForm(nValor,Alltrim(aPict[PF3_BASERET]))) //"BASE ICMS RET: "
	
		   For xx:=1 to MlCount(cMensagem,nTamObs)
		   	   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		   Next xx
   	   Endif    
	   aDadSF3 := {}
   	   aAdd(aDadSF3,{xFilial("SF3"), (cArqTemp)->F3_CREDST, (cArqTemp)->F3_BASERET, (cArqTemp)->F3_ICMSRET,  (cArqTemp)->F3_OBSSOL})
   	   nValor := VerICMRET("F3_ICMSRET",(cArqTemp)->F3_ICMSRET, .T., aDadSf3, lP1IcmST)
	   cMensagem:=STR0031+Alltrim(TransForm(nValor-(cArqTemp)->F3_OBSSOL,Alltrim(aPict[PF3_ICMSRET]))) //"ICMS RETIDO..: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
	   If (cArqTemp)->F3_CRPRST>0
   		cMensagem	:=	STR0042+Alltrim (TransForm ((cArqTemp)->F3_CRPRST, Alltrim(aPict[PF3_CRPRST]))) //"CRED. PRES. ST: "
	   	For xx:=1 to MlCount (cMensagem, nTamObs)
		   AADD (aColObs, {MemoLine (cMensagem, nTamObs, xx), .T.})
	   	Next xx
	   EndIf
   Endif
   If (cArqTemp)->F3_ICMSCOM>0
	   cMensagem:=STR0032+Alltrim(TransForm((cArqTemp)->F3_ICMSCOM,Alltrim(aPict[PF3_ICMSCOM]))) //"ICMS DIF.ALIQ: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If (cArqTemp)->F3_VALANTI>0
	   cMensagem:=STR0075+Alltrim(TransForm((cArqTemp)->F3_VALANTI,Alltrim(aPict[PF3_VALANTI]))) //"ANTECI.ICMS"
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If (cArqTemp)->F3_ICMAUTO>0 .And. lIcmAuto
	   cMensagem:=STR0033+Alltrim(TransForm((cArqTemp)->F3_ICMAUTO,Alltrim(aPict[PF3_ICMAUTO]))) //"ICMS FRET.AUT: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If (cArqTemp)->F3_VALTST>0 .And. lIcmAuto
	   cMensagem:=STR0074+Alltrim(TransForm((cArqTemp)->F3_VALTST,Alltrim(aPict[PF3_VALTST]))) //"ICMSST FR.AUT: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If (cArqTemp)->F3_OBSICM>0
	   cMensagem:=STR0039+Alltrim(TransForm((cArqTemp)->F3_OBSICM,Alltrim(aPict[PF3_OBSICM]))) //"ICMS NORMAL: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If lExist .and. (cArqTemp)->F3_OBSSOL>0 .And. lProcST .And. (nColuna == 1 .Or. nColuna == 3 .Or. ((cArqTemp)->F3_CREDST == '4' .And. lP1IcmST))
	   	If aSX6[MV_ESTADO] == "SP"
		   	cMensagem:=STR0040+Alltrim(TransForm(((cArqTemp)->F3_OBSSOL-(cArqTemp)->F3_VALANTI),Alltrim(aPict[PF3_OBSSOL]))) //"ICMS ST. INT.: "
		Elseif aSX6[MV_ESTADO] == "SE"
		   	cMensagem:="" //"ICMS ST. INT.: "
		Else
	   		cMensagem:=STR0040+Alltrim(TransForm((cArqTemp)->F3_OBSSOL,Alltrim(aPict[PF3_OBSSOL]))) //"ICMS ST. INT.: "
		Endif
		For xx:=1 to MlCount(cMensagem,nTamObs)
			AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   	Next xx
   Endif   
   If lF3Difal
	   If (cArqTemp)->F3_DIFAL>0 .And. !lF3NFCanc
		   cMensagem:=STR0088+Alltrim(TransForm((cArqTemp)->F3_DIFAL,Alltrim(aPict[PF3_DIFAL]))) //"ICMS DIFAL DEST: "
		   For xx:=1 to MlCount(cMensagem,nTamObs)
		   		AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		   Next xx
	   Endif
   Endif
   If lF3FCDifal
	   If (cArqTemp)->F3_VFCPDIF>0 .And. !lF3NFCanc
		   cMensagem:=STR0089+Alltrim(TransForm((cArqTemp)->F3_VFCPDIF,Alltrim(aPict[PF3_VFCPDIF]))) //"ICMS FCP.DEST:"
		   For xx:=1 to MlCount(cMensagem,nTamObs)
		   		AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		   Next xx
	   Endif
   Endif      
Else
   dbSelectArea(cArqTemp)
   If (aArray[ColF3("F3_VALOBSE")]>0 .And. aArray[ColF3("F3_VALCONT")]>0) .And. (((cArqTemp)->F3_VALOBSE+(cArqTemp)->F3_VALCONT>0) .Or. (cArqTemp)->(EOF()))   
      cMensagem:=STR0028+Alltrim(TransForm(aArray[ColF3("F3_VALOBSE")],Alltrim(aPict[PF3_VALOBSE]))) //"DESCONTO.....: "
	  //
	  For xx:=1 to MlCount(cMensagem,nTamObs)
	  	 AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	  Next xx
   else
	    If (aArray[ColF3("F3_DS43080")]>0)
	        cMensagem:=STR0028+Alltrim(TransForm(aArray[ColF3("F3_DS43080")],Alltrim(aPict[PF3_DS43080]))) //"DESCONTO.....: "
	        For xx:=1 to MlCount(cMensagem,nTamObs)
		        AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		    Next xx
	    EndIf
   Endif
   If aArray[ColF3("F3_IPIOBS")]>0 
	   cMensagem:=STR0029+Alltrim(TransForm(aArray[ColF3("F3_IPIOBS")],Alltrim(aPict[PF3_IPIOBS]))) //"IPI..........: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   
	If lObsFecp
		If aArray[ColF3("F3_VALFECP")]>0
			cMensagem:=STR0090+Alltrim(TransForm(aArray[ColF3("F3_VALFECP")],Alltrim(aPict[PF3_VALFECP]))) //"FECP: "
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif
		
		If aArray[ColF3("F3_VFECPST")]>0
			cMensagem:=STR0091+Alltrim(TransForm(aArray[ColF3("F3_VFECPST")],Alltrim(aPict[PF3_VFECPST]))) //"FECP-ST: "
			For xx:=1 to MlCount(cMensagem,nTamObs)
				AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
			Next xx
		Endif
	Endif

   If Empty(cTitLivro).and.aArray[ColF3("F3_ICMSRET")]-IIF(lExist,aArray[ColF3("F3_OBSSOL")],0) >0  .and. (nColuna == 1 .Or. nColuna == 3 .Or. (!(Valtype(aTotObs[ColF3("F3_ICMSRET")])=="U").And. aTotObs[ColF3("F3_ICMSRET")]>0 .And. lP1IcmST))   .And. lProcST
	    
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Conforme alinhado com a equipe de legislacao, mesmo se o campo  ³
		//³F3_OBSSOL estiver > 0, deve-se imprimir a Base do Icms Ret nos  ³
		//³totalizadores do relatorio, pois esta informacao eh impressa nos³
		//³documentos fiscais                                              ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If !(Valtype(aTotObs[ColF3("F3_ICMSRET")])=="U").And. aTotObs[ColF3("F3_ICMSRET")]>0 .And. lP1IcmST .And.  nColuna = 2 
	   		cMensagem:=STR0030+Alltrim(TransForm(aTotObs[ColF3("F3_BASERET")],Alltrim(aPict[PF3_BASERET]))) //"BASE ICMS RET: "
			For xx:=1 to MlCount(cMensagem,nTamObs)
			   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		 	Next xx
		   cMensagem:=STR0031+Alltrim(TransForm(aTotObs[ColF3("F3_ICMSRET")],Alltrim(aPict[PF3_ICMSRET]))) //"ICMS RETIDO..: "
		   For xx:=1 to MlCount(cMensagem,nTamObs)
		 	  AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  		   Next xx	   
	   	Else
			cMensagem:=STR0030+Alltrim(TransForm(aArray[ColF3("F3_BASERET")],Alltrim(aPict[PF3_BASERET]))) //"BASE ICMS RET: "
			For xx:=1 to MlCount(cMensagem,nTamObs)
			   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
		 	Next xx
		   cMensagem:=STR0031+Alltrim(TransForm(aArray[ColF3("F3_ICMSRET")]-aArray[ColF3("F3_OBSSOL")],Alltrim(aPict[PF3_ICMSRET]))) //"ICMS RETIDO..: "
		   For xx:=1 to MlCount(cMensagem,nTamObs)
		 	  AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  		   Next xx
	   	Endif
		If aArray[ColF3("F3_CRPRST")]>0
	   		cMensagem	:=	STR0042+Alltrim (TransForm (aArray[ColF3("F3_CRPRST")], Alltrim(aPict[PF3_CRPRST]))) //"CRED. PRES. ST: "
		   	For xx:=1 to MlCount (cMensagem, nTamObs)
			   AADD (aColObs, {MemoLine (cMensagem, nTamObs, xx), .T.})
		   	Next xx
		EndIf  
  Endif
   If aArray[ColF3("F3_ICMSCOM")]>0
	   cMensagem:=STR0032+Alltrim(TransForm(aArray[ColF3("F3_ICMSCOM")],Alltrim(aPict[PF3_ICMSCOM]))) //"ICMS DIF.ALIQ: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
 	   Next xx
   Endif
   If aArray[ColF3("F3_VALANTI")]>0 
	   cMensagem:=STR0075+Alltrim(TransForm(aArray[ColF3("F3_VALANTI")],Alltrim(aPict[PF3_VALANTI]))) //"ANTECI.ICMS:"
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
 	   Next xx
   EndIf
   If aArray[ColF3("F3_ICMAUTO")]>0 .And. lIcmAuto
	   cMensagem:=STR0033+Alltrim(TransForm(aArray[ColF3("F3_ICMAUTO")],Alltrim(aPict[PF3_ICMAUTO]))) //"ICMS FRET.AUT: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If aArray[ColF3("F3_VALTST")]>0 .And. lIcmAuto
	   cMensagem:=STR0074+Alltrim(TransForm(aArray[ColF3("F3_VALTST")],Alltrim(aPict[PF3_VALTST]))) //"ICMSST FR.AUT: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif
   If aArray[ColF3("F3_OBSICM")]>0
	   cMensagem:=STR0039+Alltrim(TransForm(aArray[ColF3("F3_OBSICM")],Alltrim(aPict[PF3_OBSICM]))) //"ICMS NORMAL: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   Next xx
   Endif   
   If lExist .and. aArray[ColF3("F3_OBSSOL")]>0 .And. lProcST .And. (nColuna == 1 .Or. nColuna == 3 .Or. (SF4->F4_CREDST == '4' .And. lP1IcmST))
		If aSX6[MV_ESTADO] == "SP"
			cMensagem:=STR0040+Alltrim(TransForm((aArray[ColF3("F3_OBSSOL")]-aArray[ColF3("F3_VALANTI")]),Alltrim(aPict[PF3_OBSSOL]))) //"ICMS ST. INT.: "
		Elseif aSX6[MV_ESTADO] == "SE"
			cMensagem:="" //"ICMS ST. INT.: "
		Else
			cMensagem:=STR0040+Alltrim(TransForm(aArray[ColF3("F3_OBSSOL")],Alltrim(aPict[PF3_OBSSOL]))) //"ICMS ST. INT.: "
		Endif
	   
		For xx:=1 to MlCount(cMensagem,nTamObs)
			AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
	   	Next xx

   Endif
   If aArray[ColF3("F3_DIFAL")]>0
	   cMensagem:=STR0088+Alltrim(TransForm(aArray[ColF3("F3_DIFAL")],Alltrim(aPict[PF3_DIFAL]))) //"ICM DIFAL DEST: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
 	   Next xx
   Endif
      If aArray[ColF3("F3_VFCPDIF")]>0
	   cMensagem:=STR0089+Alltrim(TransForm(aArray[ColF3("F3_VFCPDIF")],Alltrim(aPict[PF3_VFCPDIF]))) //"ICM FCP.DEST: "
	   For xx:=1 to MlCount(cMensagem,nTamObs)
		   AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
 	   Next xx
   Endif

   If (nModelo==1 .Or. nModelo==2) .And. lF3BASNDES .And. lICMSNDES
      If aArray[ColF3("F3_BASNDES")]>0 .And. aArray[ColF3("F3_ICMNDES")]>0
         cMensagem:="B.ICMS ST An.: "+Alltrim(TransForm(aArray[ColF3("F3_BASNDES")],Alltrim(aPict[PF3_BASNDES])))+"   ICMS ST Ant.: "+Alltrim(TransForm(aArray[ColF3("F3_ICMNDES")],Alltrim(aPict[PF3_ICMNDES])))
         For xx:=1 to MlCount(cMensagem,nTamObs)
	  		AADD(aColObs,{MemoLine(cMensagem,nTamObs,xx),.T.})
  	  	  Next xx	
      Endif	    
   Endif
Endif 

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Restaura a filial e area corrente ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)

IF lposF3
	RestArea(aSF3)
	dbSelectArea(aSave[1])
	dbSetOrder(aSave[2])
	dbGoto(aSave[3])
Endif

If lMatr930A
	aAreaPe := getArea()
	aColObs := ExecBlock("MATR930A", .F., .F.,{aColObs})
	RestArea(aAreaPe)
Endif

For nI := 1 to Len(aColObs)	
	aColObs[nI][1] := aColObs[nI][1] + "|"
Next nI

Return (aColObs)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ DefPeriodo   ³Autor ³ Juan Jose Pereira    ³Data³ 17/02/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Define Periodo de Apuracao                                 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION DefPeriodo(dData,nApuracao)

Local nPeriodo
Local nMes	:=	Month(dData)
Local nAno	:=	Year(dData)
Local dIniMes
Local dFimMes
Local aPeriodos:={}

dIniMes :=  CTOD("01/"+StrZero(nMes,2)+"/"+Substr(StrZero(nAno,4),3),"ddmmyy")
dFimMes	:=	UltimoDia(dIniMes)
Do Case
	Case nApuracao==1 // Decendial
		AADD(aPeriodos,{dIniMes,dIniMes+9})
		AADD(aPeriodos,{dIniMes+10,dIniMes+19})
		AADD(aPeriodos,{dIniMes+20,dFimMes})
	Case nApuracao==2 // Quinzenal
		AADD(aPeriodos,{dIniMes,dIniMes+14})
		AADD(aPeriodos,{dIniMes+15,dFimMes})
	Otherwise // Mensal
		AADD(aPeriodos,{dIniMes,dFimMes})
EndCase
If dData==CTOD("  /  /  ")
	nPeriodo:=0
Else
	nPeriodo:=Ascan(aPeriodos,{|x|x[1]<=dData.and.x[2]>=dData})
Endif

Return (nPeriodo)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ ColSF3       ³Autor ³ Juan Jose Pereira    ³Data³ 17/02/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Armazena e devolve colunas do SF3                          ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION ColF3(cColuna)
Local cAToHM := 'AToHM'
Local cGet   := "HMGet"
Local i      := 0
Local aRet   := {}

If cColuna==NIL
	aColunas:={}
	For i:=1 to FCount()
		AADD(aColunas,{FieldName(i),i})
	Next i

	// Cria o Objeto de HASH a partir do Array
	IF lBuild
		oHashColF3 := &cAToHM.(aColunas)
	Endif
Else
	IF lBuild

		IF &cGet.( oHashColF3 , cColuna  , @aRet )
			i := aRet[1][2]		
		Endif
	Else
		i := Ascan(aColunas,Trim(cColuna))
	Endif
Endif

Return(i)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ CtrlPg() ³ Autor ³ Juan Jose Pereira     ³ Data ³02/02/1996³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Controla numeracao de paginas dos livros fiscais           ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION CtrlPg(nPagina,nQtdPag,lReiniPg)

Local lFeixe:=.f.
Local aPaginas:={0,0}

lReiniPg	:=	IIF(lReiniPg==NIL,.f.,lReiniPg)
nQtdPag	:=	IIf(Empty(nQtdPag) .or. nQtdPag<=0,500,nQtdPag)

If nPagAnt <> 0
	nPagina	:=	If(nPagina==1,0,nPagina)
Endif
If (nPagina%nQtdPag==0)
	If lReiniPg
		nPagina:=0
	Endif
	aPaginas[1]:=nPagina
	aPaginas[2]:=nPagina+1
	nPagina:=nPagina+IIf(nPagAnt<>0,2,1)
	lFeixe:=.t.
Else
	nPagina++
	If (nPagina%nQtdPag==0)
		If lReiniPg
			nPagina:=0
		Endif
		aPaginas[1]:=nPagina
		aPaginas[2]:=nPagina+1
		nPagina:=nPagina+IIf(nPagAnt<>0,2,1)
		lFeixe:=.t.
	Endif
Endif
Return(aPaginas)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ImprimeTermo³Autor³ Juan Jose Pereira     ³ Data ³02/02/1996³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Imprime termos de abertura e encerramento dos livros fiscais³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION ImprimeTermo(nPagina,nPagIni,nQuebra,cArqTerm,nLargMax,cPerg)

Local	cSvAlias	:=	Alias()
Local	i
Local	aVariaveis:={}
Local w
Local j
Local cCaracter
Local cLinha
Local nPosAcento
Local	cAcentos:="€ú\‡ú\ú\?ú\…ú\†ú\„ú\ ú\?ú\ˆú\Šú\‚ú\¡ú\“ú\”ú\•ú\¢ú\£ú"
Local cTexto
Local uConteudo
Local cConteudo
Local oFwSX1Util
Local aPergunte := {}
Local nI		:= 0
Local nTamAperg	:= 0

If nPagina==0.or.!File(cArqTerm)
	Return
Endif
aadd(aVariaveis,{"VAR_IXB",VAR_IXB})
dbSelectArea("SM0")
For i:=1 to FCount()
	If FieldName(i)=="M0_CGC"
		AADD(aVariaveis,{FieldName(i),Transform(FieldGet(i),"@R! NN.NNN.NNN/NNNN-99")})
	ElseIf FieldName(i)=="M0_INSC"
		AADD(aVariaveis,{FieldName(i),AllTrim(InscrEst())})
	ElseIf 	FieldName(i)=="M0_DTRE"
		AADD(aVariaveis,{FieldName(i),FieldGet(i)})
	Else
		If FieldName(i)=="M0_NOME"
			Loop
		Endif
		AADD(aVariaveis,{FieldName(i),Alltrim(FieldGet(i))})
	Endif
Next

dbSelectArea( "CVB" )
CVB->(MSSeek( xFilial( "CVB" ) ))
For i:=1 to FCount()
	If FieldName(i)=="CVB_CGC"
		AADD(aVariaveis,{FieldName(i),Transform(FieldGet(i),"@R! NN.NNN.NNN/NNNN-99")})
	ElseIf FieldName(i)=="CVB_CPF"
		AADD(aVariaveis,{FieldName(i),Transform(FieldGet(i),"@R 999.999.999-99")})
	Else
		AADD(aVariaveis,{FieldName(i),FieldGet(i)})
	Endif
Next

oFwSX1Util:= FwSX1Util():New()
oFwSX1Util:AddGroup(cPerg)
oFwSX1Util:SearchGroup()
aPergunte := oFwSX1Util:GetGroup(cPerg)[2] // Retorna o con teudo de cada um dos parametros do pergunte
nTamAperg := Len(aPergunte) //Quantidade de parametros

For nI := 1 to nTamAperg
	uConteudo	:=	&(aPergunte[nI]:CX1_VAR01)
	If Valtype(uConteudo)=="N"
		cConteudo	:=	Alltrim(Str(uConteudo))
	Elseif Valtype(uConteudo)=="D"
		cConteudo	:=	Alltrim(dToc(uConteudo))
	Else
		cConteudo	:=	Alltrim(uConteudo)
	Endif
	AADD(aVariaveis,{Rtrim(Upper(aPergunte[nI]:CX1_VAR01)),cConteudo})

Next nI

FwFreeArray(aPergunte)
oFwSX1Util:= Nil
                        
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ordena os arrays colocando primeiro a variavel de tamanho    ³
//³ maior para que a rotina nao pegue uma variavel menor         ³
//³ primeiro ( exemplo M0_TEL e M0_TEL_IMP )                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
ASort( aVariaveis,,, { |x,y| Len( x[1] ) > Len( y[1] ) } ) 

AADD(aVariaveis,{"__PAGINAINICIAL",Transform(StrZero(nPagIni,6),"@R 999.999")})
AADD(aVariaveis,{"__PAGINAFINAL",Transform(StrZero(nPagina,6),"@R 999.999")})
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Inclusao de variaveis especificas                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aVariaveis,{"M_DIA",StrZero(Day(dDataBase),2)})
AADD(aVariaveis,{"M_MES",MesExtenso()})
AADD(aVariaveis,{"M_ANO",StrZero(Year(dDataBase),4)})

cTexto:=MemoRead(cArqTerm)
For w:=1 to len(aVariaveis)
	cTexto	:=	StrTran(cTexto,aVariaveis[w,1],if(valtype(aVariaveis[w,2])<>"C" .and. valtype(aVariaveis[w,2])<>"U",if(valtype(avariaveis[w,2])="D",dtoc(aVariaveis[w,2]),str(aVariaveis[w,2])),aVariaveis[w,2]))
Next
@ 0,0 PSAY AvalImp(nLargMax)

For i:=1 to Mlcount(cTexto,nLargMax)
	
	SysRefresh()
	If Interrupcao(@lAbortPrint)
		Exit
	Endif
	cLinha	:=	MemoLine(cTexto,nLargMax,i)
	cLinha	:=	Strtran(cLinha,chr(13)+chr(10))
	For j:=1 to Len(cLinha)
		cCaracter	:=	Substr(cLinha,j,1)
		nPosAcento	:=	Rat(cAcentos,cCaracter)
		If nPosAcento>0
			cCaracter:=Substr(AcSubst,nPosAcento,2)
			@ i,j PSAY Substr(cCaracter,1,1)
			@ i,j PSAY Substr(cCaracter,2,1)
		Else
			@ i,j PSAY cCaracter
		Endif
	Next j
Next i

dbSelectArea(cSvAlias)

Return (nPagina)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ R930CFOTra ³Autor³    Marcos Simidu      ³ Data ³23/04/1997³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa CFO de Servicos de Transporte.                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION R930CFOTra(cCFO,cSerie)

Local cAllCFO := "161/162/163/164/165/261/262/263/264/351/352/353/354/561/562/563/661/662/663/1351/1352/1353/1354/1355/1356/2351/2352/2353/2354/3351/3352/3353/3354/5351/5352/5357/6351/6352/6357"
Local cEspecie:= If( At(cCFO,cAllCFO) > 0, "CT" , "NF" )

If ( substr(cCFO,1,3) == "999" ) //Notas Canceladas
	cEspecie := a460Especie(cSerie)
EndIf

Return(cEspecie)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³  ExistNF   ³Autor³    Marcos Simidu      ³ Data ³09/12/1997³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Verifica se existe NF em outro livro.                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ExistNF(cNota,cSerNF,cNumero,cLivros,cFilCorr)
Local cAlias	 := Alias()                               
Local aAreaSM0   := {}
Local lRet       := .F.
Local lProcessa  := .T.
Local cChave	 := cSerNF+cNota
Local cRecno 	 :=	""

Default cFilCorr := ""

dbSelectArea("SF3")

IF lBuildjS .and. Valtype(oNotasjS) =='J'
	
	cRecno :=	oNotasjS[cChave]
	IF cRecno == Nil
	
		lRet:= .F.
		lProcessa := .T.
	Else
	
		lRet:= .T.		
		lProcessa := .F.
		SF3->( DbGoTo( cRecno ) )
	Endif

Endif

IF lProcessa
	
	aAreaSM0   := SM0->(GetArea())

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Posiciona na filial em que foi processado o registro	³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Mtr930Fil(aAreaSM0,cFilCorr,1)

	//dbSelectArea("SF3")
	dbSetOrder(5)
	SF3->(MSSeek(xFilial("SF3")+cSerNF+cNota,.F.) )


	while !SF3->(Eof())
		If SF3->F3_FORMUL =="S" .And. Substr(SF3->F3_CFO,1,1) < '5'
			lRet:= .T.
			Exit
		ElseIf Val(substr(SF3->F3_CFO,1,1))>=5 
			lRet:= .T.
			Exit      
		EndIf
		dbSkip()
	EndDo
	

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Restaura a filial e area corrente ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Mtr930Fil(aAreaSM0,cFilCorr,2)


	dbSelectArea(cAlias)
Endif	

Return(lRet)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³  GravaTemp   ³Autor ³  Edstron             ³Data³ 06/04/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Grava Registro no Arquivo Temporario                       ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function GravaTemp(cNFIni,cNFFim,aFixos,aLivro,dData,cEst,cEsp,cCliente,cLoja,dDtCan1,cMov,lDesconto,nAliq,cSer,cCFO,cFormula,lSemMov,cFilProc,cAliasSf3)
Local i:=0
Default cFormula	:=SPACE(03)
Default lSemMov		:=.F.
Default cFilProc	:= xFilial("SF3")
Default cAliasSf3   := "SF3"


If !lSemMov
	dbSelectArea(cArqTemp)
	MSSeek(cFilProc+cSer+STRZERO(VAL(cNFIni),nTamF2DOC)+Str(nAliq,5,2)+Iif ("S"$F3_TIPO, "999 ", cCFO)+cFormula,.F.)
	If !eof() 
		RecLock(cArqTemp,.F.)
		For i:=1 To Len(aFixos)
		    If aFixos[i,1]<>"XXX" .And. aFixos[i,1] $ cCampos
		       If !(ValType(aFixos[i,2])$"CD" .Or. aFixos[i,1] $ "F3_ALIQICM|_ALIQ") .And. !(!lAglutina .Or. nTipomov == 1)
			      Replace &(aFixos[i,1]) With &(aFixos[i,1])+aLivro[i]			      
			   Endif   
			Endif   
		Next
	Else
	   RecLock(cArqTemp,.T.)
	   For i:=1 To Len(aFixos)
		   Replace &(aFixos[i,1]) With aLivro[i]
	   Next
	   (cArqTemp)->F3_FILIAL 	:= cFilProc
	   (cArqTemp)->F3_ENTRADA	:= dData
	   (cArqTemp)->F3_EMISSAO	:= dData
	   (cArqTemp)->F3_NFISCAL	:= cNFIni
	   (cArqTemp)->F3_SERIE  	:= cSer
	   (cArqTemp)->F3_ESTADO	:= cEst
	   (cArqTemp)->F3_ESPECIE	:= cEsp
	   (cArqTemp)->F3_CLIEFOR	:= cCliente
	   (cArqTemp)->F3_LOJA  	:= cLoja
	Endif
	(cArqTemp)->F3_DOCOR	:= If(Empty(SF3->F3_DOCOR),cNFFim,SF3->F3_DOCOR)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Corrige numeracao da Nota                                    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cMov=="S"		//.and.lLacuna
	   (cArqTemp)->NUMNOTA := STRZERO(VAL(cNFIni),nTamF2DOC)
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Zera valor de desconto para nao ser escriturado              ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !lDesconto
	   (cArqTemp)->F3_VALOBSE := 0
	Endif	
	IF !EMPTY(dDtCan1)
	   (cArqTemp)->F3_DTCANC := dDtCan1
	ENDIF
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Altera registro de notas de Formulario Proprio na Saida e    ³
	//³ Notas fiscais de Servico                                     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If F3_FORMUL=="S" .or. F3_TIPO=="S" .or. !Empty(F3_DTCANC)
	   For i:=1 to FCount()
	       If Valtype(FieldGet(i))=="N"
		  	  FieldPut(i,0)
		   Endif
	   Next   
	   If F3_FORMUL=="S" .AND. Empty(F3_DTCANC)		
	 	 (cArqTemp)->F3_OBSERV := STR0021 //"NT.FISCAL DE ENTRADA"
	   ElseIf F3_FORMUL=="S" .AND. !Empty(F3_DTCANC)
           If (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"D"})
              (cArqTemp)->F3_OBSERV := "NF DENEGADA" //"NF DENEGADA"
           ElseIf (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I"}) //"NF INUTILIZADA"
	          (cArqTemp)->F3_OBSERV := "NF INUTILIZADA"						
           Else
			 (cArqTemp)->F3_OBSERV := STR0022 //"CANCELADA"
           EndIf
	   ElseIf !Empty(F3_DTCANC)
           If (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"D"})
              (cArqTemp)->F3_OBSERV := "NF DENEGADA" //"NF DENEGADA"
           ElseIf (cAliasSf3)->F3_CODRSEF$XFUNCodSef({"I"}) //"NF INUTILIZADA"
	          (cArqTemp)->F3_OBSERV := "NF INUTILIZADA"						
           Else
			 (cArqTemp)->F3_OBSERV := STR0022 //"CANCELADA"
           EndIf
	   Else
		 (cArqTemp)->F3_OBSERV := STR0023 + " " + (cArqTemp)->F3_OBSERV //"NT.FISCAL DE SERVICO"
	   EndIf
	   (cArqTemp)->F3_CFO	:= "999"
	   (cArqTemp)->F3_TIPO	:= SF3->F3_TIPO
	Endif 

	(cArqTemp)->F3_VL43080	:= Iif(lF3_VL43080, (cAliasSf3)->F3_VL43080, 0)                              
	(cArqTemp)->F3_DS43080	:= Iif(lF3_DS43080, (cAliasSf3)->F3_DS43080, 0)                              

    (cArqTemp)->F3_VLINCMG	:= (cAliasSf3)->F3_VLINCMG

	(cArqTemp)->FILCORR := cFilAnt	                                                
	(cArqTemp)->F3_SERSAT := Iif(lF3_SERSAT, (cAliasSf3)->F3_SERSAT, '')


	IF lEmiteCiap
		(cArqTemp)->LCIAP   := Iif((cAliasSf3)->QLCIAP    > 0, 1, 0)
	Else
		(cArqTemp)->LCIAP   := 0
	Endif				
	
	If nTipoMov==1
		IF (cAliasSf3)->F3_TIPO$"DB"
			(cArqTemp)->CONTRIB	:= (cAliasSf3)->A1_CONTRIB
			(cArqTemp)->INSCR	:= (cAliasSf3)->A1_INSCR
			(cArqTemp)->TIPO	:= (cAliasSf3)->A1_TIPO	
			(cArqTemp)->EST		:= (cAliasSf3)->A1_EST
			(cArqTemp)->CONTA	:= (cAliasSf3)->A1_CONTA
			(cArqTemp)->CGC		:= (cAliasSf3)->A1_CGC
			(cArqTemp)->COD		:= (cAliasSf3)->A1_COD
			(cArqTemp)->LOJA	:= (cAliasSf3)->A1_LOJA
		Else
			(cArqTemp)->CONTRIB	:= (cAliasSf3)->A2_CONTRIB
			(cArqTemp)->INSCR	:= (cAliasSf3)->A2_INSCR
			(cArqTemp)->TIPO	:= (cAliasSf3)->A2_TIPO	
			(cArqTemp)->EST		:= (cAliasSf3)->A2_EST
			(cArqTemp)->CONTA	:= (cAliasSf3)->A2_CONTA		
			(cArqTemp)->CGC		:= (cAliasSf3)->A2_CGC
			(cArqTemp)->COD		:= (cAliasSf3)->A2_COD
			(cArqTemp)->LOJA	:= (cAliasSf3)->A2_LOJA
		Endif
	Else
		IF (cAliasSf3)->F3_TIPO$"DB"					
			(cArqTemp)->CONTRIB	:= Iif(FisContr("F", (cAliasSf3)->A2_INSCR, (cAliasSf3)->A2_CONTRIB, "", "", (cAliasSf3)->A2_TIPO, "S", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
			(cArqTemp)->INSCR	:= (cAliasSf3)->A2_INSCR
			(cArqTemp)->TIPO	:= (cAliasSf3)->A2_TIPO	
			(cArqTemp)->EST		:= (cAliasSf3)->A2_EST
			(cArqTemp)->CONTA	:= (cAliasSf3)->A2_CONTA		
			(cArqTemp)->CGC		:= (cAliasSf3)->A2_CGC
			(cArqTemp)->COD		:= (cAliasSf3)->A2_COD
			(cArqTemp)->LOJA	:= (cAliasSf3)->A2_LOJA
		Else
			(cArqTemp)->CONTRIB	:= Iif(FisContr("C", (cAliasSf3)->A1_INSCR, (cAliasSf3)->A1_CONTRIB, (cAliasSf3)->A1_TPJ, (cAliasSf3)->A1_INSCRUR, (cAliasSf3)->A1_TIPO, "S", (cAliasSf3)->F3_TIPO, SM0->M0_INSC) == .T., "1", "2")
			(cArqTemp)->INSCR	:= (cAliasSf3)->A1_INSCR
			(cArqTemp)->TIPO	:= (cAliasSf3)->A1_TIPO	
			(cArqTemp)->EST		:= (cAliasSf3)->A1_EST
			(cArqTemp)->CONTA	:= (cAliasSf3)->A1_CONTA
			(cArqTemp)->CGC		:= (cAliasSf3)->A1_CGC
			(cArqTemp)->COD		:= (cAliasSf3)->A1_COD
			(cArqTemp)->LOJA	:= (cAliasSf3)->A1_LOJA
		Endif
	Endif				
		
	(cArqTemp)->CONTSOC := (cAliasSf3)->CONTSOC
	(cArqTemp)->VLSENAR	:= (cAliasSf3)->VLSENAR
	(cArqTemp)->INSS	:= (cAliasSf3)->INSS

	(cArqTemp)->RECNOSF3 := (cAliasSf3)->RECNOSF3
	(cArqTemp)->COUNTF3  := (cAliasSf3)->COUNTF3 //verifica se Existe apenas uma SF3 para esta nota, evitar fazer seek na sft


	MsUnlock()		
Else
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Grava o registro para impressão dos periodos sem movimento³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If len(aLivro) == 0
		RecLock(cArqTemp,.T.)
		(cArqTemp)->F3_FILIAL 	:= cFilProc
		(cArqTemp)->F3_ENTRADA	:= dData
		(cArqTemp)->F3_EMISSAO	:= dData
		(cArqTemp)->F3_NFISCAL	:= cNFIni
		(cArqTemp)->F3_SERIE  	:= cSer
		(cArqTemp)->F3_ESTADO	:= cEst
		(cArqTemp)->F3_ESPECIE	:= cEsp
		(cArqTemp)->F3_CLIEFOR	:= cCliente
		(cArqTemp)->F3_LOJA  	:= cLoja
		(cArqTemp)->SEMMOV 		:= .T.
		(cArqTemp)->FILCORR		:= cFilAnt	                                                              
		MsUnLock()
	EndIf
Endif
RETURN(.t.)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³MTR930ApurºAutor  ³Mary C. Hergert     º Data ³ 23/09/2004  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Verifica os dados da Apuracao de ICMS para impressao        º±±
±±º          ³do Resumo do Produtor Rural                                 º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Matr930                                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Mtr930Apur(nApurICM,nAno,nMes,cNrLivro)

	Local aArqApur	:= {}
	Local aCampos	:= {}                  
	Local aProdutor	:= {}
	Local nPeriodo	:= 0       
	Local nX		:= 0
	Local cArqApur	:= ""

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Valores adquiridos na apuracao (aProdutor):³
	//³001 - Estorno de Credito                   ³
	//³002 - Saldo Credor do Periodo Anterior     ³
	//³003 - Transferência de Crédito             ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AADD(aProdutor,{0,0,0,0})

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Tipos de Apuracao (nApurICM):³
	//³ 1 - Decendial                ³
	//³ 2 - Quinzenal                ³
	//³ 3 - Mensal                   ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Do Case
	Case nApurICM == 1 
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,1,cNrLivro))
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,2,cNrLivro))
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,3,cNrLivro))
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,4,cNrLivro))
	Case nApurICM == 2
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,1,cNrLivro))
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,2,cNrLivro))
	Case nApurICM == 3
		AADD(aArqApur,NmArqApur("IC",nAno,nMes,1,0,cNrLivro))
	EndCase
	
	For nX := 1 to Len(aArqApur)

		nPeriodo := nX
		cArqApur := aArqApur[nX]
	
		If (File(cArqApur))
			FT_FUse(cArqApur)
			FT_FGotop()
			aCampos		:=	{.f.,.f.,.f.,.f.,.f.}
			While (!FT_FEof()) 
				cLinha	:= AllTrim(FT_FReadLN())
                Do Case
                Case SubStr(cLinha,86,6) == "003.00" // Estorno de Credito
                	aProdutor[01][01] += Val(StrTran(StrTran(SubStr(cLinha,52,18),".",""),",","."))
                Case SubStr(cLinha,1,3) == "009" // Saldo Credor do Periodo Anterior
                	aProdutor[01][02] += Val(StrTran(StrTran(SubStr(cLinha,52,18),".",""),",","."))
                Case SubStr(cLinha,1,3) == "021" // Transferencia de Credito
	                aProdutor[01][03] += Val(StrTran(StrTran(SubStr(cLinha,52,18),".",""),",","."))
                Case SubStr(cLinha,1,3) == "001" // Por saidas com debito de imposto
	                aProdutor[01][04] += Val(StrTran(StrTran(SubStr(cLinha,52,18),".",""),",","."))
                EndCase
				FT_FSkip()
			Enddo
		EndIf
	Next
	FT_FUse()                   
	
Return(aProdutor)
	
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³Mtr930Fil ºAutor  ³Mary C. Hergert     º Data ³ 08/03/2006  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Posiciona a filial que esta sendo processada na filial      º±±
±±º          ³corrente do momento da gravacao do registro                 º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºParametros³aAreaSM0 = Area do SM0 posicionada no processamento         º±±
±±º          ³cFilCorr = Filial armazenada na gravacao do registro        º±±
±±º          ³nTipo    = 1 - posiciona filial, 2 = retorna na filial      º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Matr930                                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Mtr930Fil(aAreaSM0,cFilCorr,nTipo)
Local aArea := {}
Local cChave  := AllTrim(cEmpAnt+cFilCorr)


If !Empty(cFilCorr) .and. !(cFilCorr == FWCodFil())
	aArea := GetArea()	
	If nTipo == 1		
		//Verifica se já possui no hash	
		If cChave != AllTrim(SM0->M0_CODIGO+SM0->M0_CODFIL)
			MATR930Fil(cChave)
		EndIf

		cFilAnt	:= FWCodFil()
	Else
		RestArea(aAreaSM0)
		cFilAnt	:= FWCodFil()
	Endif

	RestArea(aArea)
Endif

Return



/*/{Protheus.doc} MATR930Fil
	(Função para se posicionar na filial SM0 )
	
	@type  MATR930Fil
	@author Rafael Oliveira
	@since 22/06/2021
	@version 12.1.30	
	/*/
Function MATR930Fil(cChave)
Local cHMSet := 'HMSet'
Local cGet   := "HMGet"
Local nRegEmp := 0

IF lBuild 
	IF cChave != AllTrim(SM0->M0_CODIGO+SM0->M0_CODFIL)
		IF &cGet.( oHashFil , cChave  , @nRegEmp )			
			SM0->(dbGoTo(nRegEmp))
		Else 
			SM0->(MsSeek(cChave,.T.))		
			&cHMSet.(oHashFil, cChave, SM0->( RecNo() ))
		Endif
	Endif
Else
	SM0->(MsSeek(cChave,.T.))	
Endif

Return


/*/{Protheus.doc} MATR930Part
	(Função para se posicionar nos participantes )
	
	@author Rafael Oliveira
	@since 22/06/2021
	@version 12.1.30

	cAlias		Nome tabela
	cClieFor	Participante
	lChavePes   Indica que foi passado chave completa
	/*/
Function MATR930Part(cAlias,cClieFor)
Local cChaveHash := ""
Local cChvPes    := ""
Local cGet       := "HMGet"
Local cHMSet     := 'HMSet'
Local nRegpar    := 0
Local lPesq		:= .F.


dbSelectArea(cAlias)

cChvPes := F3Filial(Alias())+cClieFor

cChaveHash := AllTrim(cAlias+cChvPes)

IF lBuild

	IF cAlias == "SA1" .and. cChvPes != AllTrim(A1_FILIAL+A1_COD+A1_LOJA)
		lPesq := .T.
	ElseIF cAlias == "SA2" .and. cChvPes != AllTrim(A2_FILIAL+A2_COD+A2_LOJA)
		lPesq := .T.
	Endif
	
	IF lPesq
		IF &cGet.( oHashPar , cChaveHash , @nRegpar )			
			dbGoTo(nRegpar)
		Else
			MSSeek(cChvPes)
			&cHMSet.(oHashPar, cChaveHash, RecNo() )
		Endif	
	Endif
Else

	MSSeek(cChvPes)
Endif

Return


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ImpParSX1 ³ Autor ³ Nereu Humberto Junior ³ Data ³ 01.08.05 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina de impressao da lista de parametros do SX1 sem cabec³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ImpListSX1(titulo,nomeprog,tamanho,char,lFirstPage)        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cTitulo - Titulo                                           ³±±
±±³          ³ cNomPrg - Nome do programa                                 ³±±
±±³          ³ nTamanho- Tamanho                                          ³±±
±±³          ³ nchar   - Codigo de caracter                               ³±±
±±³          ³ lFirstpage - Flag que indica se esta na primeira pagina    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function ImpParSX1 (cTitulo,cNomPrg,nTamanho,nChar,lFirstPage)

Local cAlias,nLargura,nLin:=0, aDriver := ReadDriver(),nCont:= 0, cVar
Local lWin:=.F.
Local oFwSX1Util
Local aPergunte := {}
Local nI		:= 0
Local nTamAperg	:= 0

PRIVATE cSuf:=""

lWin := "DEFAULT"$ FWSFUser(__cUserId,"PROTHEUSPRINTER","USR_DRIVEIMP")

nLargura   :=IIf(nTamanho=="P",80,IIf(nTamanho=="G",220,132))   
cTitulo    :=IIf(TYPE("NewHead")!="U",NewHead,cTitulo)
lFirstPage :=IIf(lFirstPage==Nil,.F.,lFirstPage)

If lFirstPage
	If aSX6[MV_SALTPAG] == "N"
		Setprc(0,0)
	EndIf	
	If nChar == NIL
		@ 0,0 PSAY AvalImp(nLargMax) 
	Else
		If nChar == 15
			@ 0,0 PSAY &(if(nTamanho=="P",aDriver[1],if(nTamanho=="G",aDriver[5],aDriver[3])))
		Else
			@ 0,0 PSAY &(if(nTamanho=="P",aDriver[2],if(nTamanho=="G",aDriver[6],aDriver[4])))
		EndIf
	EndIf
EndIf	

cFileLogo := "LGRL"+SM0->M0_CODIGO+SM0->M0_CODFIL+".BMP" // Empresa+Filial
If !File( cFileLogo )
	cFileLogo := "LGRL"+SM0->M0_CODIGO+".BMP" // Empresa
EndIf

__ChkBmpRlt( cFileLogo ) // Seta o bitmap, mesmo que seja o padrão da microsiga

If aSX6[MV_IMPSX1] == "S" .And. Substr(cAcesso,101,1) == "S"  // Imprime pergunta no cabecalho
	If npag == 1
		nLin   := 0
		nLin   := SendCabec(lWin, nLargura, cNomPrg, RptParam+" - "+Alltrim(cTitulo), "", "", .F.)
		cAlias := Alias()

		//Classe que retorna os campos do SX1 (Perguntas) cadastrados para o ID passado
		oFwSX1Util:= FwSX1Util():New()
		oFwSX1Util:AddGroup(cPerg)
		oFwSX1Util:SearchGroup()
		aPergunte := oFwSX1Util:GetGroup(cPerg)[2] // Retorna o con teudo de cada um dos parametros do pergunte
		nTamAperg := Len(aPergunte) //Quantidade de parametros

		For nI := 1 to nTamAperg

			cVar := "MV_PAR"+StrZero(Val(aPergunte[nI]:CX1_ORDEM),2,0)
			nLin += 1
			@ nLin,5 PSAY RptPerg+" "+ aPergunte[nI]:CX1_ORDEM + " : "+ ALLTRIM(aPergunte[nI]:CX1_PERGUNT)
			If aPergunte[nI]:CX1_GSC == "C"
				xStr:=StrZero(&(cVar),2)
			EndIf
			@ nLin,Pcol()+3 PSAY IIF(aPergunte[nI]:CX1_GSC!='C',&(cVar),IIF(&(cVar)>0,&('aPergunte[nI]:CX1_DEF' + xStr),""))

		Next nI

		FwFreeArray(aPergunte)
		oFwSX1Util:= Nil

		cFiltro := IIF(!Empty(aReturn[7]),MontDescr(cAlias,aReturn[7]),"")
		nCont := 1
		If !Empty(cFiltro)
			nLin += 2
			@ nLin,5  PSAY OemToAnsi(STR0032) + Substr(cFiltro,nCont,nLargura-19)  // "Filtro      : "
			While Len(Alltrim(Substr(cFiltro,nCont))) > (nLargura-19)
				nCont += nLargura - 19
				nLin++
				@ nLin,19  PSAY  Substr(cFiltro,nCont,nLargura-19)
			End	
			nLin++
		EndIf
		nLin++
		@ nLin,00  PSAY REPLI("*",nLargura)
		dbSelectArea(cAlias)
	EndIf
EndIf

npag++

If Subs(__cLogSiga,4,1) == "S"
	__LogPages()
EndIf

Return Nil
//-----------------------------------------------------------------------
/*/{Protheus.doc} RetObsFecp
Retorna mensagem de observacao referente ao FECP

@param  nValFecp  - Valor do FECP
		cCfop - Codigo de CFOP
		cEst - Estado origem ou destino da operacao
		lST - Indica se sao valores de ICMS/Fecp Retido

@author Luccas Curcio
@since 04/12/2012
@version 1.00      

@Return	cRet - Mensagem de observacao para o FECP

/*/
//-----------------------------------------------------------------------
Static Function RetObsFecp(nValFecp,cCfop,cEst,lST)
Local	cRet		:=	""
Local	cTitFecp	:=	"FECP"

//Caso seja um registro de Entrada, devo utilizar como referencia o Estado do parametro MV_ESTADO, pois
//o Fecp a ser utilizado sera o de estado destino
If Substr(Alltrim(cCfop),1,1) < "4"
	cEst	:=	cMV_ESTADO
Endif

If cEst $ "RJ|BA|MG|MT|DF|ES"
	cTitFecp	:=	"FECP"

Elseif cEst $ "AL"
	cTitFecp	:=	"FECOEP"

Elseif cEst $ "MA"
	cTitFecp	:=	"FUMACOP"

Elseif cEst $ "RN|CE|PI"
	cTitFecp	:=	"FECOP"

Elseif cEst $ "SE"
	cTitFecp	:=	"FUNPOBREZA"
	
Elseif cEst $ "MS"
	cTitFecp	:=	"FECOMP"
	
Elseif cEst $ "PB"
	cTitFecp	:=	"FUNCEP"
	
Elseif cEst $ "PE"
	cTitFecp	:=	"FECEP"

Endif

//Incremento texto do FECP (com ou sem "ST")
cRet	:=	cTitFecp + Iif(lST,"-ST: ",": ")	

//Incremento valor do FECP		
cRet	+=	Alltrim(TransForm(nValFecp,Alltrim(aPict[PF3_VALFECP]))) 
           
Return cRet

//-----------------------------------------------------------------------
/*/{Protheus.doc} VerICMRET
Retorna  Base ou  o Valor do ICSM Retido, porem eliminando valores que estejam com CREDST = 4 

@param  cCampo  - Campo a ser tratado
		nValor - Conteudo do Campo(Valor)
		lObsSol - Indica se ira utilizar o valor do OBSSOL 
		aDadSf3 - Valores dos campoos chave para o seek na SFT

@author Thiago Yoshiaki Miyabara Nascimento
@since 21/05/14
@version 1.00      

@Return	cRet - Mensagem de observacao para o FECP

/*/

//-----------------------------------------------------------------------
Static Function VerICMRET(cCampo,nValor,lObsSol,aDadSf3,lP1IcmST)

Local 	 cCREDST	:= aDadSf3[1,2]
Local 	 nBASERET	:= aDadSf3[1,3]
Local 	 nICMSRET	:= aDadSf3[1,4]
Local 	 nOBSSOL	:= aDadSf3[1,5]
Default lObsSol  	:= .T.

If cCREDST == "4" .And. !lP1IcmST
	Do Case
		Case cCampo == "F3_BASERET"
		nValor -= nBASERET
	Case cCampo == "F3_ICMSRET"
		nValor -= IIF(lObsSol,(nICMSRET+nOBSSOL),nICMSRET)
	EndCase
EndIF
		
Return nValor


//-----------------------------------------------------------------------
/*/{Protheus.doc} ValFecp
Função que irá tratar valores do FECP, verificando se a operação possui o valor
gravado no campo legado ou no campo genérico. 

- Se possuir valor somente no campo legado, então irá retornar o FECP do Legado
- Se possuir somente valor no campo genérico, então irá retornar o FECP genérico
- Se possuir valor em ambos (legado e genérico), então irá retornar o genérico
- Se não possuir valor em nenhum dos dois irá retornar valor zero

@param		nValLegado -	Valor do Campo correspondente ao FECP legado
@param		nValGener  - 	Valor do Campo correspondente ao FECP genérico		

@return		nValFEcp  -  FECP a ser utilizado nas obrigações acessórias

@author		Erick G Dias
@since		14/09/2017
@version	12.1.17
/*/
//-----------------------------------------------------------------------
Static Function RetValFecp(nValLegado,nValGener )

Local nValFEcp	:= 0

If nValGener > 0
	//Irá considerar o FECP genérico como prioridade
	nValFEcp	:= nValGener
ElseIf nValLegado > 0
	//Não possui o FECP genérico gravado e irá retornar então o FECP legado
	nValFEcp	:= nValLegado
EndIF 


Return nValFEcp

//-----------------------------------------------------------------------
/*/{Protheus.doc} RetFTCREDST
Função para verifica o campo FT_CREDST da tabela STF, pois pode haver produtos com FT_CREDST diferentes, 
assim não pode ser considerado da F3_CREDST

@return		cRet  -  FT_CREDST

@author		Bruno Akyo Kubagawa
@since		23/10/2017
@version	12.1.17
/*/
//-----------------------------------------------------------------------
function RetFTCREDST(cArqTemp)

Local cRet			:= ""
Local cQuery	 	:= ""
Local cMD5 			:= "" 
Local cAliasQry		:= ""
Local cEntSai		:= ""
Local nPosPrepared	:= 0 
	 
	cEntSai := IIf(Left((cArqTemp)->F3_CFO,1)<"5","E","S")

	//coloquei um A no campo FT_CREDST para representar a combinação perfeita SFT->FT_ICMSRET > 0 .And. alltrim(cRet) <> "4"
	//quando nao B que ja ajudara na ordenação dos registros que nao respeitam a combninação perfeita, por isso pego o ultimo 	
	cQuery := "SELECT (CASE WHEN SFT.FT_ICMSRET > 0 AND SFT.FT_CREDST != '4' THEN 'A' ELSE 'B' END) AS CREDSTFILTRADO, SFT.FT_CREDST "
	cQuery += " FROM " + RetSqlName("SFT") + " SFT "	
	cQuery += " WHERE SFT.FT_FILIAL = ? "
	cQuery += " AND SFT.FT_TIPOMOV  = ? "
	cQuery += " AND SFT.FT_NFISCAL  = ? "
	cQuery += " AND SFT.FT_SERIE    = ? "
	cQuery += " AND SFT.FT_CLIEFOR  = ? "
	cQuery += " AND SFT.FT_LOJA     = ? "
	cQuery += " AND SFT.D_E_L_E_T_  = ' ' "
	cQuery += " ORDER BY CREDSTFILTRADO, SFT.FT_ITEM

	cMD5 := MD5(cQuery)
	If (nPosPrepared := Ascan(__aPrepared,{|x| x[2] == cMD5})) == 0 
		Aadd(__aPrepared,{FWPreparedStatement():New(),cMD5})
		nPosPrepared := Len(__aPrepared)
		__aPrepared[nPosPrepared][1]:SetQuery(ChangeQuery(cQuery))
	EndIf 
	__aPrepared[nPosPrepared][1]:SetString(1, (cArqTemp)->(F3_FILIAL))
	__aPrepared[nPosPrepared][1]:SetString(2, cEntSai)
	__aPrepared[nPosPrepared][1]:SetString(3, (cArqTemp)->(F3_NFISCAL))
	__aPrepared[nPosPrepared][1]:SetString(4, (cArqTemp)->(F3_SERIE))
	__aPrepared[nPosPrepared][1]:SetString(5, (cArqTemp)->(F3_CLIEFOR))
	__aPrepared[nPosPrepared][1]:SetString(6, (cArqTemp)->(F3_LOJA))
	cQuery := __aPrepared[nPosPrepared][1]:getFixQuery()

	cAliasQry := GetNextAlias()
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasQry)

	If !(cAliasQry)->(Eof())

		If (cAliasQry)->CREDSTFILTRADO == "B" //Encontrei o caso da combinação perfeita SFT->FT_ICMSRET > 0 .And. alltrim(cRet) <> "4"			
			cRet := (cAliasQry)->FT_CREDST		
		EndIf
	EndIf

	If SELECT(cAliasQry) != 0
		(cAliasQry)->(DbCloseArea())
	EndIf
	
return cRet

//-------------------------------------------------------------------
/*/{Protheus.doc} RetIPIAta()
Verifica se a TES é para Atacadista não contribuinte de IPI para
carregar os valores corretos no relatório.

@param _cFiscal - numero da nota fiscal
@param _cSerie	- Série da nota fiscal
@param _cCliefor- Cliente/Fornecedor da nota fiscal
@param _cLoja   - Loja do Cliente/Fornecedor da nota fiscal
@param _cCfo    - CFOP da nota fiscal

@author Adilson Alves
@since 30/03/2020
@version 12.1.27
/*/
//-------------------------------------------------------------------
Function RetIPIAta(_cFiscal,_cSerie,_cCliefor,_cLoja,_cCfo,_nAliqICM,_cIdentFT)
Local cEntSai    := Iif(Left(_cCfo,1) < '5', 'E', 'S')
Local cChavePesq := (xFilial("SFT")+cEntSai+_cCliefor+_cLoja+_cSerie+_cFiscal+_cCfo)
Local nValBIPI   := 0
Local nValIPI    := 0
Local nValOIPI   := 0
Local cObsAtac   := ""
Local aRetorno   := {}

SF4->(DbSetOrder(1)) //---1	F4_FILIAL+F4_CODIGO                                                ---//
SFT->(DbSetOrder(4)) //---4	FT_FILIAL+FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_CFOP---//
SFT->(MSSeek(cChavePesq))
While !SFT->(Eof()) .And. cChavePesq == SFT->(FT_FILIAL+FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_CFOP)

	If _nAliqICM == SFT->(FT_ALIQICM) .And. _cIdentFT == SFT->(FT_IDENTF3)

		If SF4->(MSSeek(xFilial("SF4")+SFT->FT_TES))
			If SF4->F4_IPI == "R" .AND. SF4->F4_LFIPI == "O"
				nValOIPI += SFT->FT_BASEIPI + SFT->FT_OUTRIPI
				cObsAtac := SFT->FT_OBSERV
			Else
				nValIPI  += SFT->FT_VALIPI
				nValBIPI += SFT->FT_BASEIPI
			Endif
		EndIf
	EndIf

	SFT->(DbSkip())
Enddo
aRetorno := {nValBIPI, nValIPI, nValOIPI, cObsAtac}

Return aRetorno

//Grava temproario para LivrAcumula
//Acumula valores de operacoes interestaduais 
Static Function ExecStat(cAliasSf3, coArqSF3Na, lForce) 
Local cStatement  := ""
Local nTamInsert  := 38850//1048575	
Local nStatus 	  := 0
Local cDadosIns   := ""
Default lForce 	  := .F. 

IF cSGBD $ "ORACLE" .and. !lForce

	cStatement := "INSERT INTO " + coArqSF3Na + " (CHAVE, FILIAL, MES, ANO, RECNOF3) VALUES ( " +;
	"'" + (cAliasSf3)->(F3_FILIAL + DTOS(F3_ENTRADA) + F3_NFISCAL + F3_SERIE + F3_CLIEFOR + F3_LOJA + F3_CFO +STR(F3_ALIQICM, 5, 2) + F3_FORMULA) + "', " +; //CHAVE
	"'" + cFilAnt + "', " +; //FILIAL
	"'" + StrZero(Month((cAliasSf3)->F3_ENTRADA),2) + "', " +; //MES
	"'" + StrZero(Year((cAliasSf3)->F3_ENTRADA),4) + "', " +; //ANO
	"" + Alltrim(Str((cAliasSf3)->RECNOSF3)) + ")"  //RECNO SF3
	
    nStatus := TCSqlExec(cStatement)

    If (nStatus < 0)
        conout("TCSQLError() " + TCSQLError())
    EndIf

Else
	
	IF !lForce
		cDadosIns := "( " +;
		"'" + (cAliasSf3)->(F3_FILIAL + DTOS(F3_ENTRADA) + F3_NFISCAL + F3_SERIE + F3_CLIEFOR + F3_LOJA + F3_CFO +STR(F3_ALIQICM, 5, 2) + F3_FORMULA) + "', " +; //CHAVE
		"'" + cFilAnt + "', " +; //FILIAL
		"'" + StrZero(Month((cAliasSf3)->F3_ENTRADA),2) + "', " +; //MES
		"'" + StrZero(Year((cAliasSf3)->F3_ENTRADA),4) + "', " +; //ANO
		"" + Alltrim(Str((cAliasSf3)->RECNOSF3)) + ")"  //RECNO SF3
		
		If !Empty(cQryInsert)
			cQryInsert += ", " + cDadosIns
		Else
			cQryInsert := cDadosIns
		EndIf
		
	Endif	

	If (nTamInsert <= GetTamQry()) .Or. ;
	   (lForce .And.  GetTamQry() > 0)
		
		cStatement := " INSERT INTO " + coArqSF3Na + " (CHAVE, FILIAL, MES, ANO, RECNOF3) VALUES "
		cStatement += cQryInsert  + ";"

		If (TCSqlExec(cStatement)) >= 0 
			cQryInsert := ""
		Else
			conout("TCSQLError() " + TCSQLError())
		EndIf

	EndIf	
Endif

Return


//-------------------------------------------------------------------
/*/{Protheus.doc} GetTamQry
@description Retorna o tamanho da variavel cQryInsert para o caso de inserção em Lote na tabela temporaria.
@author Rafael Oliveira
@since 22/06/2021
@version 12.1.27
/*/
//-------------------------------------------------------------------
Static Function GetTamQry()
Return Len(cQryInsert)

//-------------------------------------------------------------------
/*/{Protheus.doc} R930LoadX6
Funcao responsavel por realizar o cache dos parametros (SX6)

@return aRet - Array com o cache do SX6.

@author Rafael Oliveira
/*/
//-------------------------------------------------------------------
Function R930LoadX6()

Local nX := 0
Local aRet := {}

Local aParam := {	{"MV_ESTADO",	 ""},;	//01					
					{"MV_CFOZER",    ""},;	//02
					{"MV_CAT21",    .F.},;	//03
					{"MV_LJLVFIS", 	 1 },;	//04					
					{"MV_R930SAT",  .F.},;	//05					
					{"MV_IMPCSS",   "N"},;	//06						
					{"MV_CFTR930",  " "},;	//07
					{"MV_VLCTBZL",  " "},;	//08
					{"MV_LFMD2DT",  .F.},;	//09
					{"MV_P1ICMST",  .F.},;	//10
					{"MV_OBSCFO",    ""},;	//11
					{"MV_NFCTEUF",  "0"},;	//12
					{"MV_FAUT930",  .T.},;	//13					
					{"MV_CTALFE",  IIF(!(SF3->F3_TIPO$"DB"),SA2->A2_CONTA,SA1->A1_CONTA)},;	//14
					{"MV_CTALFS ", IIF(!(SF3->F3_TIPO$"DB"),SA1->A1_CONTA,SA2->A2_CONTA)},;	//15
					{"MV_IMPSX1",  "S"},;	//16
					{"MV_LIVRESP",  "99"},;	//17
					{"MV_SALTPAG",  "S"},;	//18
					{"MV_P2ABER",  ""},;	//19
					{"MV_P1ABER",  ""},;	//20
					{"MV_LSAIAB",  "LSAIAB.TRM"},;	//21
					{"MV_LENTAB",  "LENTAB.TRM"},;	//22
					{"MV_LENTEN",  "LENTEN.TRM"},;	//23					
					{"MV_LSAIEN",  "LSAIEN.TRM"},;	//24					
					{"MV_LFISORD",  .F.},;	//25
					{"MV_IMPCABE",  .F.},;	//26
					{"MV_IMPPAGI",  .F.},;	//27
					{"MV_ESTCLI",  .F.},;	//28
					{"MV_PERCRJ",  0},;		//29
					{"MV_SPED55",  .F.},;	//30
					{"MV_ALIQSTN",  .T.},;	//31
					{"MV_IMPZNFC",  .F.},;	//32
					{"MV_ECFNOTA",  .F.},;  //33
					{"MV_SM0CONT",  " "}}	//34
					
					

For nX:=1 to Len(aParam)
	aAdd(aRet , GetNewPar((aParam[nX,1]),aParam[nX,2]))
Next nX


Return aRet
//-------------------------------------------------------------------
/*/{Protheus.doc} R930LoadX3
Funcao responsavel por realizar o cache dos parametros (SX6)

@return aRet - Array com o cache do SX6.

@author Rafael Oliveira
/*/
//-------------------------------------------------------------------
Function R930LoadX3()

Local nX := 0
Local nPos := 0
Local aAlias := {}
Local aRet := {}
Local bError
Local lErro	:= .F.
Local aFPCpo := {	{"SF3","F3_MSFIL"},;	//01
					{"SF3","F3_DIFAL"},;	//02
					{"SF3","F3_VFCPDIF"},;	//03
					{"SF3","F3_BASNDES"},;	//04
					{"SF3","F3_ICMNDES"},;	//05
					{"SF3","F3_VL43080"},;	//06
					{"SF3","F3_VLINCMG"},;	//07
					{"SF3","F3_CREDST"},;	//08
					{"SF3","F3_NUMINI"},;	//09
					{"SF3","F3_NUMFIM"},;	//10
					{"SF3","F3_VALANTI"},;	//11
					{"SF3","F3_CLIDVMC"},;	//12
					{"SF3","F3_DS43080"},;	//13
					{"SF3","F3_SERSAT"},;	//14							
					{"SF3","F3_CFO"},;		//15
					{"SF3","F3_ALIQICM"},;	//16
					{"SF3","F3_VALCONT"},;	//17
					{"SF3","F3_BASEICM"},;	//18
					{"SF3","F3_VALICM"},;	//19
					{"SF3","F3_ISENICM"},;	//20
					{"SF3","F3_OUTRICM"},;	//21
					{"SF3","F3_BASEIPI"},;	//22
					{"SF3","F3_VALIPI"},;	//23
					{"SF3","F3_ISENIPI"},;	//24
					{"SF3","F3_OUTRIPI"},;	//25
					{"SF3","F3_OBSERV"},;	//26
					{"SF3","F3_VALOBSE"},;	//27
					{"SF3","F3_ICMSRET"},;	//28
					{"SF3","F3_LANCAM"},;	//29
					{"SF3","F3_TIPO"},;		//30
					{"SF3","F3_ICMSCOM"},;	//31
					{"SF3","F3_CODISS"},;	//32
					{"SF3","F3_IPIOBS"},;	//33
					{"SF3","F3_NRLIVRO"},;	//34
					{"SF3","F3_ICMAUTO"},;	//35
					{"SF3","F3_BASERET"},;	//36
					{"SF3","F3_FORMUL"},;	//37
					{"SF3","F3_FORMULA"},;	//38
					{"SF3","F3_DESPESA"},;	//39
					{"SF3","F3_ICMSDIF"},;	//40
					{"SF3","F3_TRFICM"}}	//41

bError := ErrorBlock( {|| lErro := .T. } )

BEGIN SEQUENCE
	//Tentar executar alias indic
	FWAliasIndic("SA1")
END SEQUENCE

ErrorBlock( bError )

If !lErro
	For nX := 1 to Len(aFPCpo)
		nPos := aScan( aAlias , {|x| x[1] == aFPCpo[nX,01] } )
		If nPos == 0
			aAdd( aAlias , { aFPCpo[nX,01] , FWAliasIndic(aFPCpo[nX,01]) } )
			nPos := Len(aAlias)
		EndIf
		aAdd(aRet , IIf( aAlias[nPos,02] .And. (aFPCpo[nX,01])->(FieldPos(aFPCpo[nX,02])) > 0 , .T. , .F. ) )
	Next nX
EndIf

Return aRet

/*
Function R930Filtro
Descricao: Funcao que efetua filtros em tabelas, indregua em dbf e query em
           top. Ela deve ser chamada como 1 para criar e 2 para fechar a area
           criada. 
*/
Function R930Filtro(nOpc,cTabela,cAlias,aInsert,nRecCount) 
Local aSetField    := {}
Local cFrom        := ""
Local cMD5         := ""
local cOrderby     := ""
Local cSelect      := ""
Local cWhere       := ""
Local lCountReg    := nRecCount<>Nil
Local lRet         := .F.
Local nI           := 0
Local nLen         := 0
Local nPosPrepared := 0

If nOpc==1

	Do Case
		Case cTabela=="CARREGANF"
			If lCountReg
				cSelect	:=	"COUNT(*) COUNTREG"
			Else
				cSelect += "SF3.F3_NFISCAL, SF3.F3_SERIE, SF3.F3_EMISSAO, SF3.F3_CODRSEF, SF3.R_E_C_N_O_ SF3RECNO"
			Endif

			cFrom 		+= RetSqlName("SF3") + " SF3 "			
			cWhere		+= "SF3.F3_FILIAL='"+xFilial("SF3")+"' "			
			cWhere		+= "AND SF3.F3_EMISSAO >= ? "
			cWhere		+= "AND SF3.F3_EMISSAO <= ? "
			cWhere		+= "AND SF3.F3_SERIE = ? "
			cWhere		+= "AND SF3.F3_NFISCAL >= ? "			
			cWhere		+= "AND SF3.F3_NFISCAL <= ? "			
			cWhere		+= "AND ((SF3.F3_FORMUL = 'S' AND SF3.F3_CFO < '5') OR SF3.F3_CFO > '5') " //Entrada Formul. Proprio ou Saída
			cWhere		+= "AND SF3.D_E_L_E_T_ = ' ' "	
			cOrderby	+= "ORDER BY SF3.F3_NFISCAL"	
			
			aAdd(aSetField,{"F3_EMISSAO","D",8,0})
		Case cTabela=="ENT_N.F.ORIG"		

			If lCountReg
				cSelect	:=	"COUNT(*) COUNTREG"
			Else
				cSelect		:= "DISTINCT SD1.D1_NFORI, SD1.D1_SERIORI"
			Endif

			cFrom 		+= RetSqlName("SD1") + " SD1 "			
			cWhere		+= "SD1.D1_FILIAL='"+xFilial("SD1")+"' "			
			cWhere		+= "AND SD1.D1_DOC = ? "
			cWhere		+= "AND SD1.D1_SERIE = ? "
			cWhere		+= "AND SD1.D1_FORNECE = ? "
			cWhere		+= "AND SD1.D1_LOJA = ? "
			cWhere		+= "AND SD1.D1_CF = ? "
			cWhere		+= "AND SD1.D_E_L_E_T_ = ' ' "				
			cOrderby	+= "ORDER BY SD1.D1_NFORI, SD1.D1_SERIORI"
		
		Case cTabela=="SAI_N.F.ORIG"		

			If lCountReg
				cSelect	:=	"COUNT(*) COUNTREG"
			Else
				cSelect		:= "DISTINCT SD2.D2_NFORI, SD2.D2_SERIORI"
			Endif

			cFrom 		+= RetSqlName("SD2") + " SD2 "			
			cWhere		+= "SD2.D2_FILIAL='"+xFilial("SD2")+"' "
			cWhere		+= "AND SD2.D2_DOC = ? "
			cWhere		+= "AND SD2.D2_SERIE = ? "
			cWhere		+= "AND SD2.D2_CLIENTE = ? "
			cWhere		+= "AND SD2.D2_LOJA = ? "
			cWhere		+= "AND SD2.D2_CF = ? "			
			cWhere		+= "AND SD2.D_E_L_E_T_ = ' ' "				
			cOrderby	+= "ORDER BY SD2.D2_NFORI, SD2.D2_SERIORI"		
		
		Case cTabela=="FT_VALINS"		

			If lCountReg
				cSelect	:=	"COUNT(*) COUNTREG"
			Else
				cSelect		:= " SUM(SFT.FT_VALINS) FT_VALINS "
			Endif

			cFrom 		+= RetSqlName("SFT") + " SFT "			
			cWhere		+= "SFT.FT_FILIAL='"+xFilial("SFT")+"' "
			cWhere		+= "AND SFT.FT_TIPOMOV = ? "
			cWhere		+= "AND SFT.FT_CLIEFOR = ? "
			cWhere		+= "AND SFT.FT_LOJA = ? "
			cWhere		+= "AND SFT.FT_SERIE = ? "
			cWhere		+= "AND SFT.FT_NFISCAL = ? "			
			cWhere		+= "AND SFT.FT_IDENTF3 = ? "			
			cWhere		+= "AND SFT.D_E_L_E_T_ = ' ' "
	EndCase

	cQuery := " SELECT " + cSelect + " FROM " + cFrom + " WHERE " + cWhere + cOrderby
	nLen := Len(aInsert)
	cMD5 := MD5(cQuery)
	If (nPosPrepared := Ascan(__aPrepared,{|x| x[2] == cMD5})) == 0 
		Aadd(__aPrepared,{FWPreparedStatement():New(),cMD5})
		nPosPrepared := Len(__aPrepared)
		__aPrepared[nPosPrepared][1]:SetQuery(ChangeQuery(cQuery))
	EndIf 
	For nI := 1 to nLen
		IF aInsert[nI][1] =='C'
			__aPrepared[nPosPrepared][1]:SetString(nI,aInsert[nI][2])
		Elseif aInsert[nI][1] =='N'
			__aPrepared[nPosPrepared][1]:setNumeric(nI,aInsert[nI][2])
		Elseif aInsert[nI][1] =='D'
			__aPrepared[nPosPrepared][1]:setDate(nI,aInsert[nI][2])
		Elseif aInsert[nI][1] =='B'
			__aPrepared[nPosPrepared][1]:setBoolean(nI,aInsert[nI][2])		
		Endif
	Next 
	cQuery := __aPrepared[nPosPrepared][1]:getFixQuery()

	aInsert := aSize(aInsert,0)

	cAlias := R930GetAlias("SF3")

	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias)


	If !lCountReg
		For nI := 1 To Len(aSetField)
			TcSetField(cAlias,aSetField[nI,1],aSetField[nI,2],aSetField[nI,3],aSetField[nI,4])
		Next
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Se o retorno deve ser a quantidade de registros, armazeno em uma variavel para retornar³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lCountReg
		nRecCount := (cAlias)->COUNTREG
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Como jah armazenei em uma variavel o valor da quantidade de registros, ³
	//³  posso fechar a area. O retorno da quantidade eh atraves de um        ³
	//³  parametro passado por referencia. O retorno da funcao ainda continua ³
	//³  sendo .T. quando tiver registros ou .F. quando nao tiver.            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lCountReg
		R930Filtro(2,"",cAlias)
		lRet := nRecCount>0
	ElseIf !(cAlias)->(Eof())
		lRet := .T.
	Else
		R930Filtro(2,"",cAlias)
	EndIf

Else
	If Select(cAlias)<>0
		(cAlias)->(DbCloseArea())
	EndIf	
EndIf

Return lRet



//Aumenta limite de alias possiveis
Static Function R930GetAlias(cTabela)
Local	cArq		:=	"000000000"

Default	cTabela	:=	""

cTabela	:=	AllTrim(cTabela)
While Select("MR_"+cTabela+cArq)<>0
	cArq	:=	SOMA1(cArq)
End

Return "MR_"+cTabela+cArq


//Carrega dodas notas existentes para periodo 
//baseado no range de livro e filial
Static Function CarregaNF(cSerNF,nNfIni,nNfFim,cFilCorr,nTamNF3)
Local aAreaSM0  := SM0->(GetArea())
Local cAlias	:= Alias() 
Local aInsert   := {}
Local cAliasSF3 := ""
Local cNumnF	:= ""

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Posiciona na filial em que foi processado o registro	³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Mtr930Fil(aAreaSM0,cFilCorr,1)

Aadd(aInsert,{'C',DtoS(dDtIni)})
Aadd(aInsert,{'C',DtoS(dDtFim)})
Aadd(aInsert,{'C',cSerNF})
Aadd(aInsert,{'C',StrZero(nNfIni,nTamNF3)})
Aadd(aInsert,{'C',StrZero(nNfFim,nTamNF3)})

IF R930Filtro(1,"CARREGANF",@cAliasSF3,aInsert) //Verifica se encontra alguma nota com as caracteristicas passada
	oNotasjS := JsonObject():New()	
	conout(Alltrim(Str(ThreadID())) + " Inicio carga De canceladas - Time " + Time())
	While !(cAliasSF3)->(Eof())
		
		cNumnF 	:=	StrZero(Val((cAliasSF3)->F3_NFISCAL),nTamNF3)+Space(nTamF2DOC-nTamNF3)
		cChave 	:= (cAliasSF3)->(F3_SERIE)+cNumnF

		oNotasjS[cChave] := (cAliasSF3)->SF3RECNO		

		(cAliasSF3)->(DbSkip ())
	Enddo

	//fecha Alias
	R930Filtro(2,,cAliasSF3)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Restaura a filial e area corrente ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Mtr930Fil(aAreaSM0,cFilCorr,2)

//Limpa array
ASize(aInsert,0)

//retorna para alias da Temp
dbSelectArea(cAlias)

Return

//-------------------------------------------------------------------
/*/{Protheus.doc} R930Pict
Funcao responsavel por realizar o cache das pictures dos campos

@return aRet - Array com o cache do SX6.

@author Erich Buttner
/*/
//-------------------------------------------------------------------
Function R930Pict()

Local nX := 0
Local aRet := {}
Local aPICT := {{"F3_VALOBSE"},; //01
				{"F3_DESCZFR"},; //02
				{"F3_DS43080"},; //03
				{"F3_BASNDES"},; //04
				{"F3_ICMNDES"},; //05
				{"FT_PRINCMG"},; //06
				{"F3_BASEICM"},; //07
				{"F3_VALFECP"},; //08
				{"F3_VFECPST"},; //09
				{"F3_IPIOBS"},;  //10
				{"F3_BASERET"},; //11
				{"F3_ICMSRET"},; //12
				{"F3_CRPRST"},;  //13
				{"F3_ICMSCOM"},; //14
				{"F3_VALANTI"},; //15
				{"F3_ICMAUTO"},; //16
				{"F3_VALTST"},;  //17
				{"F3_OBSICM"},;  //18
				{"F3_OBSSOL"},;  //19
				{"F3_DIFAL"},;   //20
				{"F3_VFCPDIF"} } //21


For nX:=1 to Len(aPICT)
	aAdd(aRet , X3Picture(aPICT[nX,1]))
Next nX


Return aRet

/*/{Protheus.doc} FisContr
	Função responsavel por decidir se o participante é contribuinte ou não
	
	@author pereira.weslley
	@since 07/12/2022
	
	@param 
		cTipoclifor:char = C, F (Cliente ou Fornecedor)
		cInscricao:char  = 111111111111111111 (Inscrição estadual do participante)
		cContrib:char    = 1, 2 (A1_CONTRIB ou  A2_CONTRIB, 1 para Sim e 2 para Não)
		cTpj:char        = 1, 2, 3, 4 (1=ME - Micro Empresa;2=EPP - Empresas de Pequeno Porte;3=MEI - Microempreendedor Individual;4=Não Optante)
		cInscrur:char    = 111111111111111111 (Inscricao Produtor Rural)
		cTipo:char 		= F, L, R, S, X (Tipo do Cliente: F=Cons.Final;L=Produtor Rural;R=Revendedor;S=Solidario;X=Exportacao)
		cEntSai:char     = S, E (Entrada ou Saída)
		cTipomov:char    = B, D (Beneficiamento ou Devolução)
		cM0Insc:char     = 111111111111111111 (Incrição estadual da filial)
/*/
Function FisContr(cTipoclifor, cInscricao, cContrib, cTpj, cInscrur, cTipo, cEntSai, cTipomov, cM0Insc)

Local linscrito := .F.

Default cTipoclifor := ""
Default cInscricao  := ""
Default cContrib    := ""
Default cTpj        := ""
Default cInscrur    := ""
Default cTipo       := ""
Default cEntSai     := ""
Default cTipomov    := ""
Default cM0Insc     := ""

	If cTipoclifor $ "C" //Cliente
		If cContrib <> "2"
			If !(Empty(cInscricao) .Or. "ISENT" $ cInscricao)
				lInscrito := .T.
			EndIf

			//Caso seja MEI ou ME e a Inscrição estiver vazia ou Isenta, a decisão de é que o participante é contribuinte
			If (cTpj == "3" .Or. cTpj == "1") .And. (Empty(cInscricao) .Or. "ISENT" $ cInscricao)
				lInscrito := .T.
			EndIf

			//Tratamento para considerar como contribuinte do ICMS Produtor Rural com inscrição Rural
			If !Empty(cInscrur) .And. "L" $ cTipo
				lInscrito := .T.
			EndIf
		EndIf
	Else //Fornecedor
		lInscrito :=;
		IIf(cEntSai == "S" .And. cTipomov $ "B",;
			IIf((Empty(cInscricao) .Or. "ISENT" $ cInscricao .Or. "RG" $ cInscricao .Or. cContrib == "2"),;
				.F.,;
				.T.;
				),;
			IIf((Empty(cM0Insc) .Or. "ISENT" $ cM0Insc .Or. aSX6[MV_SM0CONT]=="2"),;
				.F.,;
				.T.;
				);
			)
	EndIf
	
Return linscrito

//-------------------------------------------------------------------
/*/{Protheus.doc} SendCabec
Funcao responsavel para imprimir um cabeçalho de relatório. 

Ela recebe parâmetros para personalizar o cabeçalho, incluindo o nome do programa, o título do relatório e duas linhas de texto. 
A função também imprime o nome da empresa, a versão do programa, a data e hora de emissão e, opcionalmente, o número da página.
O cabeçalho é delimitado por linhas de asteriscos.

@param lWin, lógico, Se verdadeiro, imprime o cabeçalho no modo janela
@param nLargura, numérico, Largura do relatório
@param cNomPrg, caractere, Nome do programa
@param cTitulo, caractere, Título do relatório
@param cCabec1, caractere, Linha 1 do cabeçalho
@param cCabec2, caractere, Linha 2 do cabeçalho
@param lPrtPagNum, lógico, Imprimir número da página
@param m_pag, numérico, Número da página
@param lSetCentury, lógico, Imprimir século na data (.T. ou “ON” para ativar a configuração do século (anos de 4 dígitos)
													(.F. ou “OFF” para desativar a configuração do século (anos de 2 dígitos)

@return nLin - Número de linhas impressas

@example

//Imprime um cabeçalho de relatório

SendCabec(.T.,80,"NOME DO PROGRAMA","TÍTULO DO RELATÓRIO","LINHA 1 DO CABEÇALHO","LINHA 2 DO CABEÇALHO",.F.,1,.T.)

lWin:logical = .T. (Imprimir cabeçalho no modo janela)
nLargura:int = 80 (Largura do relatório)
cNomPrg:char = "NOME DO PROGRAMA" (Nome do programa)
cTitulo:char = "TÍTULO DO RELATÓRIO" (Título do relatório)
cCabec1:char = "LINHA 1 DO CABEÇALHO" (Linha 1 do cabeçalho)
cCabec2:char = "LINHA 2 DO CABEÇALHO" (Linha 2 do cabeçalho)
lPrtPagNum:logical = .F. (Imprimir número da página)

@version 12.1.27
/*/
Static Function SendCabec(lWin, nLargura, cNomPrg, cTitulo, cCabec1, cCabec2, lPrtPagNum, m_pag, lSetCentury)
	Local nLin      := 0
	Local xStr      := 0
	Local nRecuo    := 20	
	Local INICABEC := Chr(27)+Chr(01)+Chr(01)
	Local FIMCABEC := Chr(27)+Chr(01)+Chr(02)
	Local INIFIELD := Chr(27)+Chr(02)+Chr(01)
	Local FIMFIELD := Chr(27)+Chr(02)+Chr(02)
	Local INILOGOESP := Chr(27)+Chr(17)+Chr(01)
	Local FIMLOGOESP := Chr(27)+Chr(17)+Chr(02)

	Default m_pag := 1
	Default lSetCentury := __SetCentury() // https://vivaclipper.wordpress.com/2014/01/19/__setcentury/

	@(nLin:=0),0 PSAY INICABEC //Token para identificar o inicio de uma cabec
	@(++nLin) ,0 PSAY Iif(!lWin,Chr(13),"")+REPLI("*",nLargura)

	// Nome da Empresa
	@(++nLin), 0 PSAY "*"+INIFIELD+AllTrim(SM0->M0_NOME)+" / "+AllTrim(SM0->M0_FILIAL)+INILOGOESP+__cFileLogo+FIMLOGOESP+FIMFIELD

	// Imprimir século na data
	If lSetCentury
		nRecuo := 20
	else
		nRecuo := 18
	endif

	If lPrtPagNum // Imprimir o numero da folha
		@nLin,nLargura-nRecuo  PSAY INIFIELD+RptFolha+" "+TRANSFORM(m_pag,'999999')+FIMFIELD
	Else
		@nLin,nLargura-nRecuo  PSAY INIFIELD+Space(Len(RptFolha)+7)+FIMFIELD // Manda espaşos em branco para compatibilizar
	Endif
	@nLin,nLargura-1	 PSAY "*"

	// VersÒo
	@(++nLin), 0 PSAY "*"+INIFIELD+"SIGA /"+cNomPrg+"/v."+cVersao+FIMFIELD

	// Tİtulo do relat¾rio
	@nLin,(xStr:=(Len(cNomPrg)+Len(cVersao)+10)) PSAY INIFIELD+PADC(Trim(cTitulo),nLargura-xStr-nRecuo)+FIMFIELD
	@nLin,(nLargura - (Len(RptDtRef+" "+DTOC(dDataBase)))-1) PSAY INIFIELD+RptDtRef+" "+DTOC(dDataBase)+FIMFIELD

	@nLin,nLargura-1	 PSAY "*"

	// Hora da emissÒo
	@(++nLin),0 PSAY "*"+INIFIELD+RptHora+" "+time() + ' - Grupo de empresa: ' + AllTrim(SM0->M0_NOME)+" / Filial: "+AllTrim(SM0->M0_FILIAL) + FIMFIELD

	// Data de emissÒo
	@nLin,nLargura-nRecuo PSAY INIFIELD+RptEmiss+" "+DToC(MsDate())+FIMFIELD

	@nLin,nLargura-1	 PSAY "*"
	LI:=6
	If LEN(Trim(cCabec1)) != 0
		LI:=8
		@(++nLin),00 PSAY __PrtFatLine()
		@(++nLin),00 PSAY INIFIELD+cCabec1+FIMFIELD

		If LEN(Trim(cCabec2)) != 0
			@(++nLin),00  PSAY INIFIELD+cCabec2+FIMFIELD
			LI:=9
		EndIf
		@(++nLin),00 PSAY __PrtFatLine()
	Else
		@(++nLin),00 PSAY __PrtFatLine()
	EndIf
	@nLin,0 PSAY FIMCABEC //Token para identificar o final de uma cabec

	PrnFlush()

Return nLin

// ------------------------------------------------------

//Por padrão RPCSetEnv é executado em modo Blind. Então, se quer forçar o sistema a apresentar as perguntas mesmo que nesse modo, altere o conteúdo da variável Pública __cInterNet de "Automatico" para __cInterNet := NIL.
//Quando via RPC o sistema entra em modo Blind (e por isso as perguntas dos relatórios não aparecem) a solução é bem simples. Após o PREPARE ENVIRONMENT altere o conteúdo da variável __cInternet de "AUTOMATICO" para NIL como em: __cInternet := NIL.
Static Function __ChkBmpRlt( cFileLogo )

__cFileLogo := cFileLogo

If !Empty(__cInternet)
	Return
Endif

ChkBmpRlt( cFileLogo )

Return
