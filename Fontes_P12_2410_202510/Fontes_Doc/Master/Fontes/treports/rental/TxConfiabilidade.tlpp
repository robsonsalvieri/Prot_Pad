#include "msobject.ch"
#include "TOTVS.ch"
#include "TopConn.ch"
#include "totvs.framework.treports.integratedprovider.th"

/*/{PROTHEUS.DOC} rental.sv.loc.analysisofmeasurement.tlpp
ITUP BUSINESS - TOTVS RENTAL
TAXA DE CONFIABILIADADE
@AUTHOR DENNIS CALABREZ
@SINCE 24/02/2025
/*/

namespace totvs.protheus.rental.manutencao.integratedprovider

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGALOC", tables="ST9,FPA,FP0,STJ", name="Rental", country="ALL", initialRelease="12.1.2210")
class TxConfiabilidadeTReportsBusinessObject from totvs.framework.treports.integratedprovider.integratedprovider
public method new() as object
public method getData() as object
public method getSchema() as object
endclass

/*/{PROTHEUS.DOC} TxConfiabilidadeTReportsBusinessObject
ITUP BUSINESS - TOTVS RENTAL
Declaração dos métodos
@AUTHOR DENNIS CALABREZ
@SINCE 24/02/2025
/*/

method new() class TxConfiabilidadeTReportsBusinessObject
    _Super:new()
    self:appendArea("Rental")

    self:setDisplayName("Manutenção")

    self:setDescription("Taxa de Confiabilidade")
return self

/*/{PROTHEUS.DOC} getData
ITUP BUSINESS - TOTVS RENTAL
Execução do relatório
@AUTHOR DENNIS CALABREZ
@SINCE 24/02/2025
/*/

method getData(nPage as numeric, oFilter as object) as object class TxConfiabilidadeTReportsBusinessObject
Local cQuery as character
Local lUseParams := .T.
Local aBind := {}
Local cLinha := ""
Local cComando := ""

    self:setPageSize(20)

    jParams := oFilter:getParameters() //metodo para retorno do json dos parâmetros

    If type("jParams['01'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['01'][1] := 0
	EndIf
	If empty(jParams['01'][1])
		jParams['01'][1] := 0
	EndIf

    If type("jParams['02'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['02'][1] := space(TamSx3("T9_CODBEM")[1])
	EndIf
	If empty(jParams['02'][1])
		jParams['02'][1] := space(TamSx3("T9_CODBEM")[1])
	EndIf

    If type("jParams['03'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['03'][1] := space(TamSx3("T9_CODBEM")[1])
	EndIf
	If empty(jParams['03'][1])
		jParams['03'][1] := space(TamSx3("T9_CODBEM")[1])
	EndIf

    If type("jParams['04'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['04'][1] := space(TamSx3("FPA_PROJET")[1])
	EndIf
	If empty(jParams['04'][1])
		jParams['04'][1] := space(TamSx3("FPA_PROJET")[1])
	EndIf

    If type("jParams['05'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['05'][1] := space(TamSx3("FPA_PROJET")[1])
	EndIf
	If empty(jParams['05'][1])
		jParams['05'][1] := space(TamSx3("FPA_PROJET")[1])
	EndIf

    If type("jParams['06'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['06'][1] := space(TamSx3("FPA_OBRA")[1])
	EndIf
	If empty(jParams['06'][1])
		jParams['06'][1] := space(TamSx3("FPA_OBRA")[1])
	EndIf

    If type("jParams['07'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['07'][1] := space(TamSx3("FPA_OBRA")[1])
	EndIf
	If empty(jParams['07'][1])
		jParams['07'][1] := space(TamSx3("FPA_OBRA")[1])
	EndIf

    If type("jParams['08'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['08'][1])
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf

    If type("jParams['09'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['09'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['09'][1])
		jParams['09'][1] := space(TamSx3("B1_COD")[1])
	EndIf

    jParams['10'][1] := StrTran(SubStr(jParams["10"][1],1,10),"-","") // "20000101"
	If empty(jParams['10'][1])
		jParams['10'][1] := space(8)
	EndIf

    jParams['11'][1] := StrTran(SubStr(jParams["11"][1],1,10),"-","") // "20000101"
	If empty(jParams['11'][1])
		jParams['11'][1] := space(8)
	EndIf

    If type("jParams['12'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['12'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['12'][1])
		jParams['12'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

    If type("jParams['13'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['13'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['13'][1])
		jParams['13'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

    If type("jParams['14'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['14'][1] := space(TamSx3("FP0_LOJA")[1])
	EndIf
	If empty(jParams['14'][1])
		jParams['14'][1] := space(TamSx3("FP0_LOJA")[1])
	EndIf

    If type("jParams['15'][1]") <> "C" .or. file("\SYSTEM\LOCSV005.TXT")
		jParams['15'][1] := space(TamSx3("FP0_LOJA")[1])
	EndIf
	If empty(jParams['15'][1])
		jParams['15'][1] := space(TamSx3("FP0_LOJA")[1])
	EndIf
    
    cQuery := "SELECT DISTINCT "
    cQuery += "T9_CODBEM,T9_NOME,T9_FILIAL,T9_CENTRAB,T9_CODFAMI,T6_NOME,T9_MODELO,T9_CODESTO,B1_DESC, "
    cQuery += " FPA_DTINI, FPA_DTFIM , FP0_CLI, FP0_LOJA,FP0_CLINOM, FPA_PROJET, FPA_OBRA, FPA_AS "
    cQuery += ",  TJ_ORDEM "
    cQuery += ", ? DIAS_CONFIAVEL "
    AAdd(aBind, {jParams['01'][1], "S"})
   
    cQuery += ", TJ_DTMRINI, TJ_HOMRINI "
    cQuery += ", CASE "
    
    cLinha := IIF(UPPER(Alltrim(TCGetDb()))=="ORACLE"," WHEN (FPA_DTINI - TJ_DTMRINI) < " + jParams['01'][1] +" THEN 0 "," WHEN (DATEDIFF(day,CONVERT(DATETIME, FPA_DTINI, 103) , CONVERT(DATETIME, TJ_DTMRINI, 103))) < " + jParams['01'][1] +" THEN 0 ")
    cComando := 'cQuery += cLinha '
    &(cComando)

    cQuery += "ELSE 100 "
    cQuery += "END TAXA_CONFIABILIDADE "
    cQuery += "FROM "+RetSqlName("FPA")+" FPA "
    cQuery += " INNER JOIN " + RetSQLName("ST9") + " ST9 ON "
    cQuery += " T9_FILIAL = '"+xFilial("ST9")+"' AND "
    cQuery += " FPA_GRUA = T9_CODBEM AND "
    cQuery += " T9_SITBEM = 'A' AND "
    cQuery += " ST9.D_E_L_E_T_ = ' ' "
    cQuery += " INNER JOIN " + RetSQLName("ST6") + " ST6 ON "
    cQuery += " T6_FILIAL = '"+xFilial("ST6")+"' AND "
    cQuery += " T9_CODFAMI = T6_CODFAMI AND "
    cQuery += " ST9.D_E_L_E_T_ = ' ' "
    cQuery += " INNER JOIN " + RetSQLName("SB1") + " SB1 ON "
    cQuery += " B1_COD = T9_CODESTO AND "
    cQuery += " SB1.D_E_L_E_T_ = ' ' "
    cQuery += " INNER JOIN " + RetSQLName("FP0") + " FP0 ON "
    cQuery += " FPA_FILIAL = FP0_FILIAL AND "
    cQuery += " FPA_PROJET = FP0_PROJET AND "
    cQuery += " FP0.D_E_L_E_T_ = ' ' "
    cQuery += " LEFT JOIN " + RetSQLName("STJ") + " STJ ON "
    cQuery += " T9_FILIAL = '"+xFilial("ST9")+"' AND "
    cQuery += " T9_CODBEM = TJ_CODBEM AND "
    cQuery += " ( "
    cQuery += " (TJ_DTMRINI > = FPA_DTINI AND "
    cQuery += " TJ_DTMRFIM <= FPA_DTFIM ) "
    cQuery += " ) AND "
    cQuery += " STJ.D_E_L_E_T_ = ' ' "
    cQuery += " WHERE FPA.D_E_L_E_T_ = ' ' "

    lUseParams := .T.

    jParams := oFilter:getParameters() //metodo para retorno do json dos parâmetros

    if !empty(jParams["02"][1]) .and. !empty(jParams["03"][1])
        cQuery += "AND T9_CODBEM BETWEEN ? AND ? "
        AAdd(aBind, {jParams['02'][1], "S"})
        AAdd(aBind, {jParams['03'][1], "S"})
    endif

    if !empty(jParams["04"][1]) .and. !empty(jParams["05"][1])
        cQuery += "AND FPA_PROJET BETWEEN ? AND ? "
        AAdd(aBind, {jParams['04'][1], "S"})
        AAdd(aBind, {jParams['05'][1], "S"})
    endif

    if !empty(jParams["06"][1]) .and. !empty(jParams["07"][1])
        cQuery += "AND FPA_OBRA BETWEEN ? AND ? "
        AAdd(aBind, {jParams['06'][1], "S"})
        AAdd(aBind, {jParams['07'][1], "S"})
    endif

    if !empty(jParams["08"][1]) .and. !empty(jParams["09"][1])
        cQuery += "AND B1_COD BETWEEN ? AND ? "
        AAdd(aBind, {jParams['08'][1], "S"})
        AAdd(aBind, {jParams['09'][1], "S"})
    endif

    if !empty(jParams["10"][1]) .and. !empty(jParams["11"][1])
        cQuery += "AND FPA_DTINI BETWEEN ? AND ? "
        AAdd(aBind, {jParams["10"][1], "D"})
        AAdd(aBind, {jParams["11"][1], "D"})
    endif

    if !empty(jParams["12"][1]) .and. !empty(jParams["13"][1])
        cQuery += "AND FP0_CLI BETWEEN ? AND ? "
        AAdd(aBind, {jParams['12'][1], "S"})
        AAdd(aBind, {jParams['13'][1], "S"})
    endif

    if !empty(jParams["14"][1]) .and. !empty(jParams["15"][1])
        cQuery += "AND FP0_LOJA BETWEEN ? AND ? "
        AAdd(aBind, {jParams['14'][1], "S"})
        AAdd(aBind, {jParams['15'][1], "S"})
    endif

    cQuery := CHANGEQUERY(cQuery)
    cQuery := JurTRepBin(cQuery, aBind)
    
    self:setQuery(cQuery)

return self:oData

/*/{PROTHEUS.DOC} getData
ITUP BUSINESS - TOTVS RENTAL
Declaração dos parâmetros
@AUTHOR DENNIS CALABREZ
@SINCE 24/02/2025
/*/

method getSchema() as object class TxConfiabilidadeTReportsBusinessObject

    self:addProperty("Filial",            "Filial",            "string", "Filial",            "T9_FILIAL")
    self:addProperty("Equipamento",       "Equipamento",       "string", "Equipamento",       "T9_CODBEM")
    self:addProperty("Desc Equipamento",  "Desc. Equipamento", "string", "Desc. Equipamento", "T9_NOME")
    self:addProperty("Centro de Trab",    "Centro de Trab",    "string", "Centro de Trab",    "T9_CENTRAB")
    self:addProperty("Familia",           "Familia",           "string", "Familia",           "T9_CODFAMI")
    self:addProperty("Nome Familia",      "Nome Familia",      "string", "Nome Familia",      "T6_NOME")
    self:addProperty("Modelo",            "Modelo",            "string", "Modelo",            "T9_MODELO")
    self:addProperty("Produto",           "Produto",           "string", "Produto",           "T9_CODESTO")
    self:addProperty("Descricao",         "Descricao",         "string", "Descricao",         "B1_DESC")
    self:addProperty("Dt Inicio",         "Dt Inicio",         "date",   "Dt Inicio",         "FPA_DTINI")
    self:addProperty("Dt Fim",            "Dt Fim",            "date",   "Dt Fim",            "FPA_DTFIM")
    self:addProperty("Cliente",           "Cliente",           "string", "Cliente",           "FP0_CLI")
    self:addProperty("Loja",              "Loja",              "string", "Loja",              "FP0_LOJA")
    self:addProperty("Nome Cliente",      "Nome Cliente",      "string", "Nome Cliente",      "FP0_CLINOM")
    self:addProperty("Projeto",           "Projeto",           "string", "Projeto",           "FPA_PROJET")
    self:addProperty("Obra",              "Obra",              "string", "Obra",              "FPA_OBRA")
    self:addProperty("AS",                "AS",                "string", "AS",                "FPA_AS")
    self:addProperty("OS",                "OS",                "string", "OS",                "TJ_ORDEM")
    self:addProperty("Dias Confiavel",    "Dias Confiavel",    "number", "Dias Confiavel",    "DIAS_CONFIAVEL")
    self:addProperty("Dt Ini OS",         "Dt Ini OSl",        "date",   "Dt Ini OS",         "TJ_DTMRINI")
    self:addProperty("Hr Ini OS",         "Hr Ini OSl",        "string", "Hr Ini OS",         "TJ_HOMRINI")
    self:addProperty("Tx Confiabilidade", "Tx Confiabilidade", "number", "Tx Confiabilidade", "TAXA_CONFIABILIDADE")

    self:addParameter("01", "Dias Confiável",  "string", .F., "", .F., .F., "",       "MV_PAR01",,.F.,{"7"})
    self:addParameter("02", "Equipamento de",  "string", .F., "", .F., .T., "ST9FPA", "MV_PAR02")
    self:addParameter("03", "Equipamento até", "string", .F., "", .F., .T., "ST9FPA", "MV_PAR03")
    self:addParameter("04", "Projeto de",      "string", .F., "", .F., .T., "FP0T",   "MV_PAR04")
    self:addParameter("05", "Projeto até",     "string", .F., "", .F., .T., "FP0T",   "MV_PAR05")
    self:addParameter("06", "Obra de",         "string", .F., "", .F., .F., "",       "MV_PAR06")
    self:addParameter("07", "Obra até",        "string", .F., "", .F., .F., "",       "MV_PAR07")
    self:addParameter("08", "Produto de",      "string", .F., "", .F., .T., "SB1",    "MV_PAR08")
    self:addParameter("09", "Produto até",     "string", .F., "", .F., .T., "SB1",    "MV_PAR09")
    self:addParameter("10", "Data Inicio",     "date",   .F., "", .F., .F., "",       "MV_PAR10")
    self:addParameter("11", "Data Fim",        "date",   .F., "", .F., .F., "",       "MV_PAR11")
    self:addParameter("12", "Cliente de",      "string", .F., "", .F., .T., "SA1",    "MV_PAR12")
    self:addParameter("13", "Cliente até",     "string", .F., "", .F., .T., "SA1",    "MV_PAR13")
    self:addParameter("14", "Loja de",         "string", .F., "", .F., .F., "",       "MV_PAR14")
    self:addParameter("15", "Loja até",        "string", .F., "", .F., .F., "",       "MV_PAR15")

return self:oSchema
