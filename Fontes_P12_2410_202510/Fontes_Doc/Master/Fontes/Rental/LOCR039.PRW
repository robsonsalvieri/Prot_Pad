#INCLUDE 'LOCR039.CH'
#INCLUDE "PROTHEUS.CH"

/*/{Protheus.doc} LOCR039
Reletorio de Previsão de Faturamento
@type function?
@version
@author aleci
@since 7/8/2024
@return variant, return_description
/*/
FUNCTION LOCR039()
Local nX
PRIVATE OREPORT
PRIVATE CTITULO := STR0001 //"Previsão de Faturamento"
PRIVATE OBREAK
PRIVATE OBREAK2
PRIVATE OBREAK3
PRIVATE OBREAK4
Private LOBRNFREM 	:= SUPERGETMV("MV_LOCX067",.F.,.T.)  		// --> OBRIGA OU NAO UMA NOTA FISCAL DE REMESSA PARA GERACAO DA NOTA DE FATURAMENTO AUTOMATICO.            PADRÃO: .T.


	IF TREPINUSE()
		IF  PERGPARAM("LOCR039")
			OREPORT := REPORTDEF()

			//OREPORT:SETDEVICE(4)    // MODO DEFAULT DE IMPRESS???O  4 = PLANILHA
			OREPORT:PRINTDIALOG()
		ENDIF
	ENDIF

RETURN

/*?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????FUNCAO    ??? REPORTDEF??? AUTOR ??? MIGUEL GONTIJO        ??? DATA ???09/02/2017?????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????DESCRICAO ??? DEFINICAO DO LAYOUT DO RELATORIO                           ?????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????±???
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????*/
STATIC FUNCTION REPORTDEF()

LOCAL OSECTION1
LOCAL OSECTION2

PRIVATE CFILBRK := CFILANT

	//??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
	//???CRIACAO DO COMPONENTE DE IMPRESSAO                                      ???
	//???                                                                        ???
	//???TREPORT():NEW                                                           ???
	//???EXPC1 : NOME DO RELATORIO                                               ???
	//???EXPC2 : TITULO                                                           ???
	//???EXPC3 : PERGUNTE                                                        ???
	//???EXPB4 : BLOCO DE CODIGO QUE SERA EXECUTADO NA CONFIRMACAO DA IMPRESSAO  ???
	//???EXPC5 : DESCRICAO                                                       ???
	//??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
	OREPORT  := TREPORT():NEW("LOCR039",STR0002,"LOCR039",{|OREPORT| PRINTREPORT(OREPORT)},STR0003) //"PREVISAO DE FATURAMENTO" //"PREVISÂO DE FATURAMENTO"
	//OREPORT:NFONTBODY    := 10
	//OREPORT:CFONTBODY    := "CALIBRIrP
	//OREPORT:LUNDERLINE := .F.
	OREPORT:TOTALINLINE(.F.)	// IMPRIME TOTAL EM LINHA OU COLUNA (DEFAULT .T. - LINHA )
	//SETBORDER(UBORDER,NWEIGHT,NCOLOR,LHEADER)
	OREPORT:LPARAMPAGE := .F.
	OREPORT:LPRTPARAMPAGE := .F.
	OREPORT:UPARAM := {|| PERGPARAM("LOCR039") }


		// Cabeçalho
		OSECTION1 := TRSECTION():NEW(OREPORT,STR0004,{"TRB1"}, , , , , .F.) //,"PROJETOS",{"ST9","SHB"}) //"Centro Trab." //"PROJETO \ OBRA"
		TRCELL():NEW(OSECTION1,"FP0_PROJET"	,"TRB1",STR0005, ,		) //"CONTRATO"
		TRCELL():NEW(OSECTION1,"FP0_CLI"	,"TRB1",, , 		)
		TRCELL():NEW(OSECTION1,"FP0_LOJA"	,"TRB1",, ,		)
		TRCELL():NEW(OSECTION1,"FP0_CLINOM"	,"TRB1",, ,		)
		TRCELL():NEW(OSECTION1,"FP1_OBRA"	,"TRB1",STR0006, , 	) //"OBRA"
		TRCELL():NEW(OSECTION1,"FP1_CLIORI"	,"TRB1",, , 		)
		TRCELL():NEW(OSECTION1,"FP1_NOMORI"	,"TRB1",, ,		)
		TRCELL():NEW(OSECTION1,"SALDO",,STR0007, "@E 999,999,999,999.99" , ,) //"Valor Total"
		OSECTION1:SetPageBreak( .T. )

		//OBREAK := TRBREAK():NEW(OSECTION1, {|| TRB1->FP0_PROJET+TRB1->FP1_OBRA},"Total Obra",.T.,,.T.) //"SUB TOTAIS"

		// Itens da FPA
		OSECTION2 := TRSECTION():NEW(OSECTION1 ,STR0008,{"FPA"},,,,,.F.) //"Recorrente"
		TRCELL():NEW(OSECTION2,"FPA_OBRA"	,"TRB2",STR0006,  ,  , /*LPIXEL*/, /*{|| BLOCK } */ ) //"OBRA"
		TRCELL():NEW(OSECTION2,"FPA_PRODUT"	,"TRB2", STR0009,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Produto"
		TRCELL():NEW(OSECTION2,"B1_DESC"	,"TRB2", STR0010,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Descricao"

		TRCELL():NEW(OSECTION2,"FPA_QUANT"	,"TRB2", STR0011, , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Quantidade"
		TRCELL():NEW(OSECTION2,"FPA_VRHOR"	,"TRB2", , , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ )
		TRCELL():NEW(OSECTION2,"VLRPED"	    ,"TRB2", STR0012, "@E 999,999,999,999.99" , /*SIZE*/ , /*LPIXEL*/, {|| ValFat() } ) //"Valor Pedido"
		TRCELL():NEW(OSECTION2,"FPA_INICIO"	,"TRB2", STR0013,  ,  , /*LPIXEL*/, {|| Stod(TRB2->FPA_INICIO) + TRB2->SOMA_DATA}  ) //"Inicio/Ult Fat"
		TRCELL():NEW(OSECTION2,"FPA_GERAEM"	,"TRB2", STR0014,  ,  , /*LPIXEL*/, ) //"Gera Em"
		TRCELL():NEW(OSECTION2,"FPA_DTFIM"	,"TRB2", STR0015,  ,  , /*LPIXEL*/,  ) //"Dt.Prox.Fat "
		OSECTION2:SetLineCondition({|| ValFat() >= 0})
		// Pro-Rata de Retorno

		OSECTION3 := TRSECTION():NEW(OSECTION1 ,STR0016,{"FQZ"},,,,,.F.) //"PRO RATA"
		TRCELL():NEW(OSECTION3,"FQZ_OBRA"	,"TRB3",STR0006,  ,  , /*LPIXEL*/, /*{|| BLOCK } */ ) //"OBRA"
		TRCELL():NEW(OSECTION3,"FQZ_COD"	,"TRB3", STR0009,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Produto"
		TRCELL():NEW(OSECTION3,"B1_DESC"	,"TRB3", STR0010,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Descricao"
		TRCELL():NEW(OSECTION3,"FQZ_QTD"	,"TRB3", STR0011, , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Quantidade"
//		//TRCELL():NEW(OSECTION2,"T9_XSUBLOC"	,"FQ4",RETTITLE("T9_XSUBLOC") , PESQPICT("ST9","T9_XSUBLOC"	) , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ )
 		TRCELL():NEW(OSECTION3,"FQZ_VLRTOT"	,"TRB3",STR0017, , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Valor Base"
		TRCELL():NEW(OSECTION3,"FQZ_INICIO"	,"TRB3", STR0018,  , /*SIZE*/ , /*LPIXEL*/, {|| TRB3->FQZ_RETIRA - TRB3->FQZ_PERPRO }  ) //"Data Inicio"
		TRCELL():NEW(OSECTION3,"FQZ_RETIRA"	,"TRB3", STR0019,  , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Devolução"
		TRCELL():NEW(OSECTION3,"FQZ_PERPRO"	,"TRB3", STR0020,  , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Pro rata"
		TRCELL():NEW(OSECTION3,"FQZ_VLRPRO"	,"TRB3", STR0021,  , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Valor Pro Rata"
		// Custo Extra
		if MV_PAR05 = 1
			OSECTION4 := TRSECTION():NEW(OSECTION1 ,STR0022,{"FPG"},,,,,.F.) //"CUSTO EXTRA"
			TRCELL():NEW(OSECTION4,"FPG_OBRA"	,"TRB4",STR0006,  ,  , /*LPIXEL*/, /*{|| BLOCK } */ ) //"OBRA"
			TRCELL():NEW(OSECTION4,"FPG_PRODUT"	,"TRB4", STR0009,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Produto"
			TRCELL():NEW(OSECTION4,"B1_DESC"	,"TRB4", STR0010,  , , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Descricao"
			TRCELL():NEW(OSECTION4,"FPG_QUANT"	,"TRB4", STR0011, , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Quantidade"
			TRCELL():NEW(OSECTION4,"FPG_TAXAV"	,"TRB4", STR0023,  , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Taxa"
			TRCELL():NEW(OSECTION4,"FPG_VALTOT"	,"TRB4", STR0024,  , /*SIZE*/ , /*LPIXEL*/, /*{|| BLOCK } */ ) //"Total"
		endif
      	//oSection1:Cell("SALDO"):SetSize(0)
 		//oSection1:Cell("SALDO"):Disable()

RETURN OREPORT
/*???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????FUNCAO    ??? PRINTREPORT??? AUTOR ??? MIGUEL GONTIJO        ??? DATA ???09/02/2017?????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????DESCRICAO ??? IMPRIME RELATORIO                                            ?????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????±???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????*/
STATIC FUNCTION PRINTREPORT(OREPORT)
LOCAL OSECTION1 := OREPORT:SECTION(1)
LOCAL OSECTION2 := OSECTION1:Section(1)
LOCAL OSECTION3 := OSECTION1:SECTION(2)
LOCAL OSECTION4 := OSECTION1:SECTION(3)

Local cAlias1 := "TRB1"
Local cAlias2 := "TRB2"
Local cAlias3 := "TRB3"
Local cAlias4 := "TRB4"
Local cQuery  := ""
Local aBindParam := {}

Local oTotReco
Local oTotPro
Local oTotCEXT
Local oTotObra

Local cFilUserFPA := oSection1:GetSQLExp("FPA") // Filtro de usuário
Local cTemp := ""

    	oTotReco := TRFUNCTION():NEW(OSECTION2:CELL("VLRPED") ,STR0025,"SUM",oBreak2,,,, .T., .F.,.F. ) //"TOTAL  "
		oTotPro  := TRFUNCTION():NEW(OSECTION3:CELL("FQZ_VLRPRO") ,STR0026,"SUM",oBreak3,,,, .T., .F.,.F. ) //"TOTAL "
		if MV_PAR05 = 1
			oTotCEXT := TRFUNCTION():NEW(OSECTION4:CELL("FPG_VALTOT") ,STR0026,"SUM",oBreak4,,,, .T., .F.,.F. ) //"TOTAL "
			oTotObra :=   TRFunction():New(oSection1:Cell("SALDO"),,"ONPRINT",OBREAK/*oBreak*/,/*Titulo*/,/*cPicture*/,;
	  		{ || oTotReco:GetLastValue()+oTotPro:GetLastValue()+oTotCEXT:GetLastValue()  },.T.,.F.,.F.,oSection1)
		else
			oTotObra :=   TRFunction():New(oSection1:Cell("SALDO"),,"ONPRINT",OBREAK/*oBreak*/,/*Titulo*/,/*cPicture*/,;
	  		{ || oTotReco:GetLastValue()+oTotPro:GetLastValue() },.T.,.F.,.F.,oSection1)
		endif

/*
    BEGIN REPORT QUERY OSECTION1

        BeginSql alias cAlias1
            SELECT FP0_PROJET, FP0_CLI, FP0_LOJA, FP0_CLINOM, FP1_OBRA, FP1_TPMES, FP1_NOMORI, FP0_CLI, FP0_LOJA, FP1_CLIORI, FP1_LOJORI
            FROM %table:FP0% FP0
            inner JOIN  %table:FP1% FP1
            ON FP1_FILIAL = %xfilial:FP1%
			AND FP1_PROJET = FP0_PROJET
			AND FP1_OBRA >= %Exp:MV_PAR03%
            AND FP1_OBRA <= %Exp:MV_PAR04%
            AND FP1.%notDel%
            WHERE FP0_FILIAL = %xfilial:FP0%
			AND FP0_PROJET >= %Exp:MV_PAR01%
			AND FP0_PROJET <= %Exp:MV_PAR02%
			AND (FP0_STATUS = '1' OR FP0_STATUS = '5')
            AND FP0.%notDel%
			AND EXISTS ( Select FPA_AS
				FROM %table:FPA% FPA
				WHERE FPA_FILIAL = %xfilial:FPA%
				AND  FPA_PROJET = FP0_PROJET
            	AND FPA_NFREM <> ' '
          	  	AND ((FPA_ULTFAT <= FPA_DTSCRT OR FPA_DTSCRT = '') OR FPA_ULTFAT = ' ')
          		AND FPA_PRCUNI > 0
            	AND FPA_OBRA =  FP1_OBRA
            	AND FPA.%notDel% )
            ORDER BY FP0_PROJET, FP1_OBRA
        EndSql

    END REPORT QUERY oSection1
*/
	cQuery += " SELECT FP0_PROJET, FP0_CLI, FP0_LOJA, FP0_CLINOM, FP1_OBRA, FP1_TPMES, FP1_NOMORI, FP0_CLI, FP0_LOJA, FP1_CLIORI, FP1_LOJORI"
    cQuery += " FROM "+RetSqlName("FP0")+ " FP0"
    cQuery += " inner JOIN  "+RetSqlName("FP1")+ " FP1"
    cQuery += " ON FP1_FILIAL = '"+xFilial("FP1")+"'"
	cQuery += " AND FP1_PROJET = FP0_PROJET"
	cQuery += " AND FP1_OBRA >= ?"
	Aadd(aBindParam, MV_PAR03 )
    cQuery += " AND FP1_OBRA <= ?"
	Aadd(aBindParam, MV_PAR04 )
    cQuery += " AND FP1.D_E_L_E_T_ = ' '"
    cQuery += " WHERE FP0_FILIAL =  '"+xFilial("FP0")+"'"
	cQuery += " AND FP0_PROJET >= ?"
	Aadd(aBindParam, MV_PAR01)
	cQuery += " AND FP0_PROJET <= ?"
	Aadd(aBindParam, MV_PAR02)
	cQuery += " AND (FP0_STATUS = '1' OR FP0_STATUS = '5')"
    cQuery += " AND FP0.D_E_L_E_T_ = ' '"
	cQuery += " AND EXISTS ( Select FPA_AS"
	cQuery += " 	FROM "+RetSqlName("FPA")+" FPA"
	cQuery += " 	WHERE FPA_FILIAL = '"+xFilial("FPA")+"'"
	cQuery += " 	AND  FPA_PROJET = FP0_PROJET"
	IF LOBRNFREM  			// --> MV_LOCX067 - OBRIGA OU NAO UMA NOTA FISCAL DE REMESSA PARA GERACAO DA NOTA DE FATURAMENTO AUTOMATICO.            PADRÃO: .T.
	    cQuery += " 	AND FPA_NFREM <> ' '"
	EndIf
    cQuery += "   	AND ((FPA_ULTFAT <= FPA_DTSCRT OR FPA_DTSCRT = '') OR FPA_ULTFAT = ' ') "
    cQuery += " 	AND FPA_TIPOSE <> 'S' "
    cQuery += " 	AND FPA_PRCUNI > 0 "
    cQuery += " 	AND FPA_OBRA =  FP1_OBRA "
	If !Empty(cFilUserFPA)
		cTemp := '" AND ' + cFilUserFPA + '"'
		cTemp := " cQuery += " + cTemp
    	&(cTemp)
	EndIf
    cQuery += " 	AND FPA.D_E_L_E_T_ = ' ' )"
    cQuery += " ORDER BY FP0_PROJET, FP1_OBRA"

	cQuery := ChangeQuery(cQuery)

	MPSysOpenQuery(cQuery,"TRB1",,,aBindParam)

	OSECTION1:BeginQuery()

	IF LOBRNFREM  			// --> MV_LOCX067 - OBRIGA OU NAO UMA NOTA FISCAL DE REMESSA PARA GERACAO DA NOTA DE FATURAMENTO AUTOMATICO.            PADRÃO: .T.

		BEGIN REPORT QUERY OSECTION2
		 	BeginSql alias cAlias2
				Select  FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC, Sum(FPA_QUANT) FPA_QUANT
	            , Sum(FPA_VRHOR) FPA_VRHOR, FPA_INICIO, FPA_TPBASE,FPA_LOCDIA
				, FPA_GERAEM, FPA_DTFIM , SOMA_DATA From (
        	    SELECT FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC, FPA_QUANT
            	, FPA_VRHOR,  CASE WHEN FPA_ULTFAT = '' THEN FPA_DTINI ELSE FPA_ULTFAT END FPA_INICIO
				, FPA_GERAEM
				, CASE WHEN FPA_DTSCRT <> '' and FPA_DTSCRT < FPA_DTFIM THEN FPA_DTSCRT ELSE FPA_DTFIM END FPA_DTFIM
				, FPA_TPBASE,FPA_LOCDIA, CASE WHEN FPA_ULTFAT = '' THEN 0 ELSE 1 END SOMA_DATA
	            FROM %table:FPA% FPA
    	        inner JOIN  %table:SB1% SB1
        	    ON B1_COD = FPA_PRODUT
				AND B1_FILIAL = %xfilial:SB1%
    	        AND SB1.%notDel%
        	    WHERE FPA_FILIAL = %xfilial:FPA%
				AND  FPA_PROJET =%report_param: (cAlias1)-> FP0_PROJET %
    	        AND ((FPA_ULTFAT <= FPA_DTSCRT OR FPA_DTSCRT = '') OR FPA_ULTFAT = ' ')
	    	    AND FPA_PRCUNI > 0
				AND FPA_NFREM <> ' '
				AND FPA_TIPOSE <> 'S'
    	        AND FPA_OBRA =  %report_param: (cAlias1)-> FP1_OBRA %
        	    AND FPA.%notDel%) X
				GROUP BY FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC,FPA_INICIO, FPA_GERAEM, FPA_DTFIM, FPA_TPBASE, FPA_LOCDIA, SOMA_DATA
 	           ORDER BY FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC,FPA_INICIO, FPA_GERAEM, FPA_DTFIM, FPA_TPBASE, FPA_LOCDIA, SOMA_DATA

	        EndSql
		END REPORT QUERY oSection2
	ELSE
		BEGIN REPORT QUERY OSECTION2
		 	BeginSql alias cAlias2
				Select  FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC, Sum(FPA_QUANT) FPA_QUANT
	            , Sum(FPA_VRHOR) FPA_VRHOR, FPA_INICIO, FPA_TPBASE,FPA_LOCDIA
				, FPA_GERAEM, FPA_DTFIM , SOMA_DATA From (
        	    SELECT FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC, FPA_QUANT
            	, FPA_VRHOR,  CASE WHEN FPA_ULTFAT = '' THEN FPA_DTINI ELSE FPA_ULTFAT END FPA_INICIO
				, FPA_GERAEM
				, CASE WHEN FPA_DTSCRT <> '' and FPA_DTSCRT < FPA_DTFIM THEN FPA_DTSCRT ELSE FPA_DTFIM END FPA_DTFIM
				, FPA_TPBASE,FPA_LOCDIA, CASE WHEN FPA_ULTFAT = '' THEN 0 ELSE 1 END SOMA_DATA
	            FROM %table:FPA% FPA
    	        inner JOIN  %table:SB1% SB1
        	    ON B1_COD = FPA_PRODUT
				AND B1_FILIAL = %xfilial:SB1%
    	        AND SB1.%notDel%
        	    WHERE FPA_FILIAL = %xfilial:FPA%
				AND  FPA_PROJET =%report_param: (cAlias1)-> FP0_PROJET %
    	        AND ((FPA_ULTFAT <= FPA_DTSCRT OR FPA_DTSCRT = '') OR FPA_ULTFAT = ' ')
	    	    AND FPA_PRCUNI > 0
				AND FPA_TIPOSE <> 'S'
    	        AND FPA_OBRA =  %report_param: (cAlias1)-> FP1_OBRA %
        	    AND FPA.%notDel%) X
				GROUP BY FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC,FPA_INICIO, FPA_GERAEM, FPA_DTFIM, FPA_TPBASE, FPA_LOCDIA, SOMA_DATA
 	           ORDER BY FPA_PROJET, FPA_OBRA, FPA_PRODUT, B1_DESC,FPA_INICIO, FPA_GERAEM, FPA_DTFIM, FPA_TPBASE, FPA_LOCDIA, SOMA_DATA

	        EndSql
		END REPORT QUERY oSection2
	ENDIF

//	while !TRB2->(Eof())
//		oSection2:PrintLine()
//		TRB2->(dbSkip())
//	enddo

	BEGIN REPORT QUERY OSECTION3
	 	BeginSql alias cAlias3
           SELECT FQZ_PROJET, FQZ_OBRA, FQZ_COD, B1_DESC, Sum(FQZ_QTD) FQZ_QTD
            , SUM(FQZ_VLRPRO) FQZ_VLRPRO, FQZ_RETIRA, FQZ_PERPRO, Sum(FQZ_VLRTOT) FQZ_VLRTOT
            FROM %table:FQZ% FQZ
            inner JOIN  %table:SB1% SB1
            ON B1_FILIAL = %xfilial:SB1%
			AND B1_COD = FQZ_COD
            AND SB1.%notDel%
            WHERE FQZ_FILIAL = %xfilial:FQZ%
			AND  FQZ_PROJET = %report_param: (cAlias1)-> FP0_PROJET %
			AND FQZ_PV = ' '
			AND FQZ_PERPRO > 0
			AND FQZ_MSBLQL <> '1'
            AND FQZ_OBRA =  %report_param: (cAlias1)-> FP1_OBRA %
			AND FQZ.%notDel%
			GROUP BY FQZ_PROJET, FQZ_OBRA, FQZ_COD, B1_DESC,FQZ_RETIRA, FQZ_PERPRO
            ORDER BY FQZ_PROJET, FQZ_OBRA, FQZ_COD, B1_DESC,FQZ_RETIRA, FQZ_PERPRO

        EndSql
	END REPORT QUERY oSection3

	if MV_PAR05 = 1

		BEGIN REPORT QUERY OSECTION4
			BeginSql alias cAlias4
				SELECT FPG_PROJET, FPG_OBRA, FPG_PRODUT, B1_DESC, FPG_NRAS, FPG_VLUNIT,FPG_QUANT, FPG_TAXAV
				, FPG_VALTOT
				FROM %table:FPG% FPG
				inner JOIN  %table:SB1% SB1
				ON B1_FILIAL = %xfilial:SB1%
				AND B1_COD = FPG_PRODUT
				AND SB1.%notDel%
				WHERE FPG_FILIAL = %xfilial:FPG%
				AND  FPG_PROJET = %report_param: (cAlias1)-> FP0_PROJET %
				AND FPG_COBRA = 'S'
				AND FPG_STATUS = '1'
				AND FPG_OBRA =  %report_param: (cAlias1)-> FP1_OBRA %
				AND FPG.%notDel%
				ORDER BY FPG_PROJET, FPG_OBRA, FPG_PRODUT
			EndSql
		END REPORT QUERY oSection4

	endif

//oReport:Section(1):Section(1):SetParentQuery()a
//oReport:Section(1):Section(1):Section(1):SetParentQuery()

oSection1:Print()

//oTotReco:Reset()
//oTotPro:Reset()
//oTotCEXT:Reset()
//oTotObra:Reset()

Return
/*?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????»??????
?????????PROGRAMA  ??? PERGPARAM???AUTOR  ??? MIGUEL GONTIJO     ??? DATA ???  09/02/2017 ?????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????DESC.     ??? PERGUNTA DO RELAT???RIO.                                     ?????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????±???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????*/
STATIC FUNCTION PERGPARAM(CPERG)
LOCAL APERGS  := {}
LOCAL ARET    := {}
LOCAL LRET    := .F.
LOCAL NX

LOCAL cContrDe  := If(FUNNAME()="LOCA001", FP0->FP0_PROJET, Criavar("FPA_PROJET",.T.))
LOCAL cContrAte := If(FUNNAME()="LOCA001", FP0->FP0_PROJET, Criavar("FPA_PROJET",.T.))
LOCAL cObraDe   := Criavar("FPA_OBRA",.T.)
LOCAL cObraAte  := If(FUNNAME()="LOCA001", "zzz",Criavar("FPA_OBRA",.T.))


	AADD( APERGS ,{1,STR0027,cContrDe , ,'.T.',"FP0",'.T.', 50 ,.F.}) //"Contrato de "
	AADD( APERGS ,{1,STR0028,cContrAte, ,'.T.',"FP0",'.T.', 50 ,.F.}) //"Contrato ate"
	AADD( APERGS ,{1,STR0029,cObraDe , ,'.T.',"",'.T.', 50 ,.F.}) //"Obra de "
	AADD( APERGS ,{1,STR0030,cObraAte, ,'.T.',"",'.T.', 50 ,.F.}) //"Obra ate"
	aAdd( APERGS ,{3,STR0033,1,{STR0032,STR0031},50,"",.F.}) //"Não" //"Sim" //"Imprimir Custo Extra"

	IF PARAMBOX(APERGS ,STR0034,ARET, /*< BOK >*/, /*< ABUTTONS >*/, .T. , /*7 < NPOSX >*/, /*8 < NPOSY >*/, /*9 < ODLGWIZARD >*/, /*10 < CLOAD > */,!( FUNNAME()="LOCA001") , .T. ) //"PARAMETROS " //"Parametros"

		FOR NX := 1 TO LEN(ARET)
			&("MV_PAR"+STRZERO(NX,2)) := ARET[NX]
		NEXT
		LRET := .T.
    endif

RETURN (LRET)


Static function ValFat()
Local NVALLOC :=  0
Local _dDtIni := Stod(TRB2->FPA_INICIO)+TRB2->SOMA_DATA
Local _dDtFim := TRB2->FPA_DTFIM
Local NDIASTRB
Local _nDiasX

	//	FP1_TPMES --- "0" = FECHADO  E  "1" = ABERTO e Mes Fixo
	NVALLOC := TRB2->FPA_VRHOR

	IF TRB1->FP1_TPMES == "0"				// MES FECHADO
		NDIASTRB := 30 // quantidade de dias do mês fechado que foi usado
		_nDiasX  := 30 // quantidade de dias do fator do periodo

		// ATENCAO: se alterar a forma de encontrar o _dDtFim e DUltFat e dProcFat
		// precisa ser replicado para o mes fixo TPMES = 2
		// Frank em 20/07/22 - somente quando for segundo faturamento em diante
		// considerar os dias corretos para o calculo
		NDIASTRB := _DDTFIM - _DDTINI + 1
		NVALLOC := (NVALLOC * NDIASTRB) / _nDiasX

	ELSEIF TRB1->FP1_TPMES == "1"				// MES ABERTO
		if Empty(TRB2->FPA_LOCDIA)
			NVALLOC  := NVALLOC * (_DDTFIM - _DDTINI + 1) / 30
		else
			NVALLOC  := NVALLOC * (_DDTFIM - _DDTINI + 1) / TRB2->FPA_LOCDIA
		endif
	ELSE // mes fixo

		nDias :=  _DDTFIM - _DDTINI + 1

		NVALLOC := TRB2->FPA_VRHOR / 30 // Calculo do valor por dia
		NVALLOC := NVALLOC * nDias  // (30 - 31 = -1 dia 30 - 29 = 1 dia)

	ENDIF

Return ROUND(nValLoc,GETSX3CACHE("C6_VALOR","X3_DECIMAL"))


