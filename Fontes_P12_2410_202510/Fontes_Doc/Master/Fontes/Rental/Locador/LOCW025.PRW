#include "Totvs.ch"
#include "TopConn.ch"
#include "TbiConn.ch"
#include "Restful.ch"
#include "fileio.ch"

/*

Ŀ
Funcao     EncerraOs    Autor  Rafael P Goncalves  Data 11.05.2021
Ĵ
           Metodo encerra a os feita pelo fornecedor/portal           
Descricao  															  
ٱ

*/
WSRESTFUL EncerraOs DESCRIPTION "Encerra O.S do fornecedor"

	WSMETHOD POST DESCRIPTION "<h2>Metodo encerra O.S do fornecedor.</h2>" WSSYNTAX "/EncerraOs"

END WSRESTFUL

WSMETHOD POST WSSERVICE EncerraOs
	
Local cDtIni		:= DtoC(Date())
Local cHrIni		:= Time()
Local cEnvLog  		:= ""
Local bError    	:= {||}
Local cBody			:= DecodeUtf8(::GetContent())
Local oJson			:= Nil
Local cRet          := ""

	
	::SetContentType("application/json; charset=iso-8859-1")
	
	// Salva bloco de cdigo do tratamento de erro	
	bError := ErrorBlock( { |oError| xTrataError( oError,@cEnvLog ) } )
			
	Begin Sequence	
		If FWJsonDeserialize(cBody,@oJson)
			aEmp := xVerEmp5(Replace(Replace(Replace(oJson:cnpj_empresa,".",""),"/",""),"-",""))
			If (aEmp[3] == "Empresa j existente.")
                 cRet := xAbreEnv5(aEmp[1],aEmp[2])
            endif
           
			If Empty(cRet)
                FH1->(DbSetOrder(1))
                FH1->(DbGoTop())
                If FH1->(DbSeek(xFilial("FH1")+oJson:Ordem))
                    While FH1->(!EoF()) .AND. FH1->FH1_ORDEM == oJson:Ordem
                        If Empty(FH1->FH1_DTENC)
                            If RecLock("FH1",.F.)
                                FH1->FH1_DTENC  := Date()
                                FH1->FH1_HRENC  := Time()
                                FH1->(MsUnLocK())
                            EndIf
                        Else
                            cRet := "ERRO-O.S j se encontra encerrada em "+DtoC(FH1->FH1_DTENC)+" s "+FH1->FH1_HRENC+"."
                        EndIf
                        FH1->(DbSkip())
                    End     
                EndIf
			EndIf
		EndIf
	End Sequence

	ErrorBlock(bError)

	If Empty(cRet)
		cRet := "OK"
	EndIf                              
    
	::SetResponse(Alltrim(FWhttpEncode('{"Retorno":"'+cRet+'" }')) )
	
	//conout("TERMINO-Consumido o WebService EncerraOs - Data e Hora Termino "+DtoC(Date())+" - "+Time()+" / Data e Hora Inicial "+cDtIni+" - "+cHrIni)
Return .T.
