#include "msobject.ch"
#include "TOTVS.ch"
#include "totvs.framework.treports.integratedprovider.th"

/*/{PROTHEUS.DOC} sigaloc.sv.loc.retorno.tlpp
ITUP BUSINESS - TOTVS RENTAL
Relatório de retorno
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 23/06/2025
/*/
namespace totvs.protheus.rental.manutencao.integratedprovider

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGALOC", tables="FPA,FP0,FQZ,SB1", name="Rental", country="ALL", initialRelease="12.1.2210")
class retorno from totvs.framework.treports.integratedprovider.integratedprovider
public method new() as object
public method getData() as object
public method getSchema() as object 
endclass

/*/{PROTHEUS.DOC} retorno
ITUP BUSINESS - TOTVS RENTAL
Declaração das classes
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 23/06/2025
/*/
method new() class retorno
	_Super:new()
	//Define a Área
	self:appendArea("Rental")

	//Define o nome do Objeto de Negócio
	self:setDisplayName("retorno")

	//Define a descrição do Objeto de Negócio
	self:setDescription("retorno")
return self

/*/{PROTHEUS.DOC} getData
ITUP BUSINESS - TOTVS RENTAL
Execução do relatório
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 23/06/2025
/*/
method getData(nPage as numeric, oFilter as object) as object class retorno
Local cQuery as character
Local cAlias as character
Local oExec as object
Local cComando
Local cLinha

	//Define a quantidade máxima por página (Default 100)
	self:setPageSize(20)

	jParams := oFilter:getParameters() //metodo para retorno do json dos parâmetros

	If type("jParams['01'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['01'][1] := space(TamSx3("FQZ_PROJET")[1])
	EndIf
	If empty(jParams['01'][1])
		jParams['01'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf

	If type("jParams['02'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['02'][1] := space(TamSx3("FQZ_PROJET")[1])
	EndIf
	If empty(jParams['02'][1])
		jParams['02'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf

	If type("jParams['03'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['03'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['03'][1])
		jParams['03'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

	If type("jParams['04'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['04'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['04'][1])
		jParams['04'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

	If type("jParams['05'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['05'][1] := space(TamSx3("FQZ_OBRA")[1])
	EndIf
	If empty(jParams['05'][1])
		jParams['05'][1] := space(TamSx3("FQZ_OBRA")[1])
	EndIf

	If type("jParams['06'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['06'][1] := space(TamSx3("FQZ_OBRA")[1])
	EndIf
	If empty(jParams['06'][1])
		jParams['06'][1] := space(TamSx3("FQZ_OBRA")[1])
	EndIf

	If type("jParams['07'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['07'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['07'][1])
		jParams['07'][1] := space(TamSx3("B1_COD")[1])
	EndIf

	If type("jParams['08'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['08'][1])
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf

	If type("jParams['09'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['09'][1] := space(TamSx3("FPA_GRUA")[1])
	EndIf
	If empty(jParams['09'][1])
		jParams['09'][1] := space(TamSx3("FPA_GRUA")[1])
	EndIf

	If type("jParams['10'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['10'][1] := space(TamSx3("FPA_GRUA")[1])
	EndIf
	If empty(jParams['10'][1])
		jParams['10'][1] := space(TamSx3("FPA_GRUA")[1])
	EndIf

	jParams['11'][1] := StrTran(SubStr(jParams["11"][1],1,10),"-","") // "20000101"
	If empty(jParams['11'][1])
		jParams['11'][1] := space(8)
	EndIf

	jParams['12'][1] := StrTran(SubStr(jParams["12"][1],1,10),"-","") // "20000101"
	If empty(jParams['12'][1])
		jParams['12'][1] := space(8)
	EndIf

	cQuery := " SELECT "
	cQuery += " FQZ.FQZ_SERIE, FQZ.FQZ_ITEM, FQZ.FQZ_FORNE, FQZ.FQZ_LOJA, FQZ.FQZ_NOME, FQZ.FQZ_EMISS, "
	cQuery += " COALESCE(SB1.B1_COD,'SEM PRODUTO') B1_COD, "
	cQuery += " COALESCE(SB1.B1_DESC,'SEM PRODUTO') B1_DESC, "
	cQuery += " FQZ.FQZ_QTD, FQZ.FQZ_AS, FQZ.FQZ_DTCANC, FQZ.FQZ_PROJET, FQZ.FQZ_VLRUNI, FQZ.FQZ_DTINI, FQZ.FQZ_DTFIM, FQZ.FQZ_VLRTOT, "
	cQuery += " FQZ.FQZ_SOLRET, FQZ.FQZ_PERPRO, FQZ.FQZ_VLRPRO, FQZ.FQZ_ULTFAT, FQZ.FQZ_RETIRA, FQZ.FQZ_PV, FQZ.FQZ_OBRA, FQZ.FQZ_SEQGUI, FQZ.FQZ_ZUCI, FQZ.FQZ_FORMUL, "
	cQuery += " FPA.FPA_DTENRE, FPA.FPA_DTFIM, FPA.FPA_DTINI, FPA.FPA_FILEMI, FPA.FPA_FILREM, FPA.FPA_GUIDES, FPA.FPA_HRFIM, FPA.FPA_HRINI, FPA.FPA_DTSCRT, FPA.FPA_DTPRRT, "
	cQuery += " FPA.FPA_MOTRET, FPA.FPA_PRCUNI, FPA.FPA_PREDIA, FPA.FPA_QUANT, FPA.FPA_TPGUID, FPA.FPA_VLBRUT, FPA.FPA_VRHOR, FPA.FPA_GRUA, FPA.FPA_DESGRU, "
	cQuery += " FP0.FP0_CLI, FP0.FP0_CLINOM "
	cQuery += "FROM "+RetSqlName("FQZ")+" FQZ "
	cQuery += " INNER JOIN " + RetSQLName("FP0") + " FP0 ON "
	cQuery += " FP0.FP0_FILIAL = '"+xFilial("FP0")+"' "
	cQuery += " AND FP0.FP0_PROJET = FQZ.FQZ_PROJET "
	cLinha := " AND FP0.FP0_CLI >= '"+jParams['03'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FP0.FP0_CLI <= '"+jParams['04'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cQuery += " AND FP0.D_E_L_E_T_ = ' ' "
	cQuery += " INNER JOIN " + RetSQLName("FPA") + " FPA ON "
	cQuery += " FPA.FPA_FILIAL = '"+xFilial("FPA")+"' "
	cQuery += " AND FPA.FPA_PROJET = FQZ.FQZ_PROJET "
	cLinha := " AND FPA.FPA_PROJET >= '"+jParams['01'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FPA.FPA_PROJET <= '"+jParams['02'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FPA.FPA_GRUA >= '"+jParams['09'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FPA.FPA_GRUA <= '"+jParams['10'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cQuery += " AND FPA.D_E_L_E_T_ = ' ' "
	cQuery += " LEFT JOIN " + RetSQLName("SB1") + " SB1 ON "
	cQuery += " SB1.B1_FILIAL = '"+xFilial("SB1")+"' "
	cQuery += " AND SB1.B1_COD = FQZ.FQZ_COD "
	cLinha := " AND SB1.B1_COD >= '"+jParams['07'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND SB1.B1_COD <= '"+jParams['08'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cQuery += " AND SB1.D_E_L_E_T_ = ' ' "
	cQuery += " WHERE FQZ.FQZ_FILIAL = '"+xFilial("FQZ")+ "' AND FQZ.D_E_L_E_T_ = ' ' "
	cLinha := " AND FQZ.FQZ_OBRA >= '"+jParams['05'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FQZ.FQZ_OBRA <= '"+jParams['06'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FQZ.FQZ_DTINI >= '"+jParams['11'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " AND FQZ.FQZ_DTINI <= '"+jParams['12'][1]+"' "
    cComando := 'cQuery += cLinha '
    &(cComando)

	oExec  := FwExecStatement():New(ChangeQuery(cQuery))
	cAlias := oExec:OpenAlias()

	(cAlias)->(DBCloseArea())
	self:setQuery(cQuery)

	//Define o campo de ordenação da query
	self:setOrder("FQZ.FQZ_PROJET")

return self:oData

/*/{PROTHEUS.DOC} getSchema
ITUP BUSINESS - TOTVS RENTAL
Declaração dos parâmetros
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 23/06/2025
/*/
method getSchema() as object class retorno

	self:addProperty("Serie",            "Serie",                "string", "Serie",                "FQZ_SERIE")
	self:addProperty("Item",             "Item",                 "string", "Item",                 "FQZ_ITEM")
	self:addProperty("Fornecedor",       "Fornecedor",           "string", "Fornecedor",           "FQZ_FORNE")
	self:addProperty("Nome",             "Nome",                 "string", "Nome",                 "FQZ_NOME")
	self:addProperty("Loja",             "Loja",                 "string", "Loja",                 "FQZ_LOJA")
	self:addProperty("Emissao",          "Emissão",              "date",   "Emissão",              "FQZ_EMISS")
	self:addProperty("Produto",          "Produto do Contrato",  "string", "Produto do Contrato",  "B1_COD")
	self:addProperty("DescricaoProduto", "Descricao do Produto", "string", "Descricao do Produto", "B1_DESC")
	self:addProperty("Equipamento",      "Equipamento",          "string", "Equipamento",          "FPA_GRUA")
	self:addProperty("DescEquip",        "Desc. Equip.",         "string", "Desc. Equip.",         "FPA_DESGRU")
	self:addProperty("Quantidade",       "Quantidade",           "number", "Quantidade",           "FQZ_QTD")
	self:addProperty("NrAS",             "Nr. A.S.",             "string", "Nr. A.S.",             "FQZ_AS")
	self:addProperty("Cancelamento",     "Cancelamento",         "string", "Cancelamento",         "FQZ_DTCANC")
	self:addProperty("Projeto",          "Projeto",              "string", "Projeto",              "FQZ_PROJET")
	self:addProperty("VlrUnitario",      "Vlr.Unitário",         "number", "Vlr.Unitário",         "FQZ_VLRUNI")
	self:addProperty("DtInicial",        "Dt.Inicial",           "date",   "Dt.Inicial",           "FQZ_DTINI")
	self:addProperty("DtFinal",          "Dt.Final",             "date",   "Dt.Final",             "FQZ_DTFIM")
	self:addProperty("VlrTotal",         "Vlr.Total",            "number", "Vlr.Total",            "FQZ_VLRTOT")
	self:addProperty("SolRetirada",      "Sol.Retirada",         "date",   "Sol.Retirada",         "FQZ_SOLRET")
	self:addProperty("Prorata",          "Pro rata",             "number", "Pro rata",             "FQZ_PERPRO")
	self:addProperty("VlrProRata",       "Vlr.Pro Rata",         "number", "Vlr.Pro Rata",         "FQZ_VLRPRO")
	self:addProperty("UltimoFat",        "Ultimo Fat.",          "date",   "Ultimo Fat.",          "FQZ_ULTFAT")
	self:addProperty("DtRetirada",       "Dt.Retirada",          "date",   "Dt.Retirada",          "FQZ_RETIRA")
	self:addProperty("PedidoDeVenda",    "Pedido de Venda",      "string", "Pedido de Venda",      "FQZ_PV")
	self:addProperty("Obra",             "Obra",                 "string", "Obra",                 "FQZ_OBRA")
	self:addProperty("Locacao",          "Locacao",              "string", "Locacao",              "FQZ_SEQGUI")
	self:addProperty("Itemcoleta",       "Item coleta",          "string", "Item coleta",          "FQZ_ZUCI")
	self:addProperty("FormProp",         "Form. Prop.",          "string", "Form. Prop.",          "FQZ_FORMUL")
	self:addProperty("DtFimLoc",         "Dt.Fim Loc.",          "date",   "Dt.Fim Loc.",          "FPA_DTENRE")
	self:addProperty("DtProxFat",        "Dt.Prox.Fat ",         "date",   "Dt.Prox.Fat",          "FPA_DTFIM")
	self:addProperty("DtInicio",         "Dt.Inicio",            "date",   "Dt.Inicio",            "FPA_DTINI")
	self:addProperty("FilRemessa",       "Fil.Remessa",          "string", "Fil.Remessa",          "FPA_FILEMI")
	self:addProperty("FilialRemes",      "Filial Remes",         "string", "Filial Remes",         "FPA_FILREM")
	self:addProperty("VlFrVolta",        "Vl. Fr Volta",         "number", "Vl. Fr Volta",         "FPA_GUIDES")
	self:addProperty("HoraFim",          "Hora Fim",             "string", "Hora Fim",             "FPA_HRFIM")
	self:addProperty("HrInicio",         "Hr.Inicio",            "string", "Hr.Inicio",            "FPA_HRINI")
	self:addProperty("DatSolicRetirada", "Dat. Solic. Retirada", "date",   "Dat. Solic. Retirada", "FPA_DTSCRT")
	self:addProperty("PrevRetira",       "Prev. Retira",         "date",   "Prev. Retira",         "FPA_DTPRRT")
	self:addProperty("MotorRetir",       "MotorRetir",           "string", "Motor. Retir",         "FPA_MOTRET")
	self:addProperty("QtdBase",          "Qtd.Base",             "number", "Qtd.Base",             "FPA_PREDIA")
	self:addProperty("RespFVolta",       "Resp. F Volta",        "string", "Resp. F Volta",        "FPA_TPGUID")
	self:addProperty("ValorBruto",       "Valor Bruto ",         "number", "Valor Bruto ",         "FPA_VLBRUT")
	self:addProperty("VrBase",           "Vr.Base",              "number", "Vr.Base",              "FPA_VRHOR")	

	self:addParameter("01", "Projeto de",      "string", .F., "", .F., .T., "FP0", "MV_PAR01")
	self:addParameter("02", "Projeto até",     "string", .F., "", .F., .T., "FP0", "MV_PAR02")
	self:addParameter("03", "Cliente de",      "string", .F., "", .F., .T., "SA1", "MV_PAR03")
	self:addParameter("04", "Cliente até",     "string", .F., "", .F., .T., "SA1", "MV_PAR04")
	self:addParameter("05", "Obra de",         "string", .F., "", .F., .F., "",    "MV_PAR05")
	self:addParameter("06", "Obra até",        "string", .F., "", .F., .F., "",    "MV_PAR06")
	self:addParameter("07", "Produto de",      "string", .F., "", .F., .T., "SB1", "MV_PAR07")
	self:addParameter("08", "Produto até",     "string", .F., "", .F., .T., "SB1", "MV_PAR08")
	self:addParameter("09", "Equipamento de",  "string", .F., "", .F., .T., "ST9", "MV_PAR09")
	self:addParameter("10", "Equipamento até", "string", .F., "", .F., .T., "ST9", "MV_PAR10")
	self:addParameter("11", "DT Inicio",       "date",   .F., "", .F., .F., "",    "MV_PAR11")
	self:addParameter("12", "DT Inicio",       "date",   .F., "", .F., .F., "",    "MV_PAR12")

return self:oSchema
