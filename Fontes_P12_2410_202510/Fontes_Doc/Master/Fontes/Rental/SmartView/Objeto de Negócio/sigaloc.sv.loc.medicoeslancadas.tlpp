#include "msobject.ch"
#include "TOTVS.ch"
#include "totvs.framework.treports.integratedprovider.th"

/*/{PROTHEUS.DOC} sigaloc.sv.loc.medicoeslancadas.tlpp
ITUP BUSINESS - TOTVS RENTAL
Medições Lançadas
@TYPE FUNCTION
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 29/05/2025
/*/

namespace totvs.protheus.rental.manutencao.integratedprovider

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGALOC", tables="FQK,SED,SE4", name="Rental", country="ALL", initialRelease="12.1.2210")
class medicao from totvs.framework.treports.integratedprovider.integratedprovider
public method new() as object
public method getData() as object
public method getSchema() as object 
endclass


/*/{PROTHEUS.DOC} sigaloc.sv.loc.medicoeslancadas.tlpp
ITUP BUSINESS - TOTVS RENTAL
METODO NEW PARA INCLUSÃO DA CONSULTA NO SMART VIEW
@TYPE METHOD
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 29/05/2025
/*/
method new() class medicao
	_Super:new()
	//Define a Área
	self:appendArea("Rental")

	//Define o nome do Objeto de Negócio
	self:setDisplayName("Medicoes Lancadas")

	//Define a descrição do Objeto de Negócio
	self:setDescription("Medicoes Lancadas v23")
return self


/*/{PROTHEUS.DOC} sigaloc.sv.loc.medicoeslancadas.tlpp
ITUP BUSINESS - TOTVS RENTAL
METODO PARA CONSTRUÇÃO DA QUERY
@TYPE METHOD
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 29/05/2025
/*/
method getData(nPage as numeric, oFilter as object) as object class medicao
local cQuery as character
local lUseParams  := .T.
local aBind       := {}
local oJsDados    := Nil
local cAlias as character
local nSkip as numeric
local nEnd as numeric
local nCount as numeric
local oExec as object
local jParams := Nil
local dDtIni1 := ''
local dDtFim2 := ''
local dDtIni3 := ''
local dDtFim4 := ''

	//Define a quantidade máxima por página (Default 100)
	self:setPageSize(20)

	jParams := oFilter:getParameters() //metodo para retorno do json dos parâmetros

	if !empty(jParams["11"][1]) .and. !empty(jParams["12"][1])
		dDtIni1 := StrTran(SubStr(jParams["11"][1],1,10),"-","")
		dDtFim2 := StrTran(SubStr(jParams["12"][1],1,10),"-","")
	endif

	if !empty(jParams["13"][1]) .and. !empty(jParams["14"][1])
		dDtIni3 := StrTran(SubStr(jParams["13"][1],1,10),"-","")
		dDtFim4 := StrTran(SubStr(jParams["14"][1],1,10),"-","")
	endif
	//Define a query do Objeto de Negócio
	//cQuery := "SELECT #QueryFields# FROM " + RetSQLName("SB1") + " WHERE #QueryWhere#"

	cQuery := " SELECT "

	cQuery += " FQK.FQK_FILIAL, FQK.FQK_TPMED, FQK.FQK_GRPMD, FQK.FQK_AS, FQK.FQK_PMEDI, FQK.FQK_COD, "
	cQuery += " FQK.FQK_MEDSEQ, FQK.FQK_CLIENT, FQK.FQK_LOJA, "

	cQuery += " FQK.FQK_PROJET, "

	cQuery += " FQK.FQK_DTINIC, FQK.FQK_DTFIM, "

	cQuery += " CASE WHEN SA1.A1_NOME = '' "
	cQuery += " THEN 'SEM CLIENTE' ELSE SA1.A1_NOME END FQK_NOMAGE, "
	
	cQuery += " FQK.FQK_CONDPA, FQK.FQK_NATUR, "

	cQuery += " CASE WHEN SA3.A3_NOME = '' "
	cQuery += " THEN 'SEM NOM.VENDEDOR' ELSE SA3.A3_NOME END FQK_NOMVEM, "
	
	cQuery += " FQK.FQK_CLIFAT, FQK.FQK_LOJFAT, FQK.FQK_VLARRE, FQK.FQK_CODVEN, FQK.FQK_SITUAC, "

	cQuery += " CASE WHEN SA1.A1_NOME = '' "
	cQuery += " THEN 'SEM CLIENTE' ELSE SA1.A1_NOME END FQK_NOMFAT, "
	
	cQuery += " FQK.FQK_INTCON, FQK.FQK_TPFRAN, FQK.FQK_NUMPV, FQK.FQK_OBRA, FQK.FQK_MINMES, FQK.FQK_VLRFRA, FQK.FQK_QTDKM, "
	
	cQuery += " FQK.FQK_DUBASE, FQK.FQK_QTDTOT, FQK.FQK_QTDHR, FQK.FQK_VALTOT, FQK.FQK_VLRTOT, FQK.FQK_VLRDES, "
	
	cQuery += " FQK.FQK_VLRACR, FQK.FQK_VLRMOB, FQK.FQK_VALSEG, FQK.FQK_VLAISS, FQK.FQK_VALSER, FQK.FQK_VLTOTM, "
	
	cQuery += " FQK.FQK_VREXTR, FQK.FQK_VLMAQ, "

	cQuery += " CASE WHEN SED.ED_DESCRIC = '' "
	cQuery += " THEN 'SEM NATUREZA' ELSE SED.ED_DESCRIC END ED_DESCRIC, "

	cQuery += " CASE WHEN SE4.E4_DESCRI = '' "
	cQuery += " THEN 'SEM COND. PAG' ELSE SE4.E4_DESCRI END E4_DESCRI, "
		
	cQuery += " CASE WHEN SE4.E4_CODIGO = '' "
	cQuery += " THEN 'SEM COND. PAG' ELSE SE4.E4_CODIGO END E4_CODIGO, "

	cQuery += " CASE WHEN SED.ED_CODIGO = '' "
	cQuery += " THEN 'SEM NATUREZA' ELSE SED.ED_CODIGO END ED_CODIGO "


	cQuery += " FROM "+RetSqlName("FQK")+" FQK "

	cQuery += " LEFT JOIN " + RetSQLName("SED") + " SED ON "
	cQuery += " SED.ED_FILIAL = '"+xFilial("SED")+ "' AND "
	cQuery += " SED.ED_CODIGO = FQK.FQK_NATUR AND "
	cQuery += " SED.D_E_L_E_T_ = ' ' "

	cQuery += " LEFT JOIN " + RetSQLName("SE4") + " SE4 ON "
	cQuery += " SE4.E4_FILIAL = '"+xFilial("SE4")+ "' AND "
	cQuery += " SE4.E4_CODIGO = FQK.FQK_CONDPA AND "
	cQuery += " SE4.D_E_L_E_T_ = ' ' "

	cQuery += " LEFT JOIN " + RetSQLName("SA1") + " SA1 ON "
	cQuery += " SA1.A1_FILIAL = '"+xFilial("SA1")+ "' AND "
	cQuery += " SA1.A1_COD = FQK.FQK_CLIFAT AND "
	cQuery += " SA1.A1_LOJA = FQK.FQK_LOJFAT AND "
	cQuery += " SA1.D_E_L_E_T_ = ' ' "

	cQuery += " LEFT JOIN " + RetSQLName("SA3") + " SA3 ON "
	cQuery += " SA3.A3_FILIAL = '"+xFilial("SA3")+ "' AND "
	cQuery += " SA3.A3_COD = FQK.FQK_CODVEN AND "
	cQuery += " SA3.D_E_L_E_T_ = ' ' "

	cQuery += " WHERE FQK.FQK_FILIAL = '"+xFilial("FQK")+ "' AND FQK.D_E_L_E_T_ = ' ' " 

	lUseParams := .T.

	If lUseParams
		
		if !empty(jParams["01"][1]) .and. !empty(jParams["02"][1])
			cQuery += " AND FQK.FQK_PROJET BETWEEN '"+{jParams['01'][1]}[1]+"' AND '"+{jParams['02'][1]}[1]+"' "
		EndIf

		if !empty(jParams["03"][1]) .and. !empty(jParams["04"][1])
			cQuery += " AND FQK.FQK_OBRA BETWEEN '"+{jParams['03'][1]}[1]+"' AND '"+{jParams['04'][1]}[1]+"' "
		EndIf
		
		if !empty(jParams["05"][1]) .and. !empty(jParams["06"][1])
			cQuery += " AND FQK.FQK_CLIENT BETWEEN '"+{jParams['05'][1]}[1]+"' AND '"+{jParams['06'][1]}[1]+"' "
		EndIf
		
		if !empty(jParams["07"][1]) .and. !empty(jParams["08"][1])
			cQuery += " AND FQK.FQK_LOJA BETWEEN '"+{jParams['07'][1]}[1]+"' AND '"+{jParams['08'][1]}[1]+"' "
		EndIf

		if !empty(jParams["09"][1]) .and. !empty(jParams["10"][1])
			cQuery += " AND FQK.FQK_CODVEN BETWEEN '"+{jParams['09'][1]}[1]+"' AND '"+{jParams['10'][1]}[1]+"' "
		EndIf

		if !empty(jParams["11"][1]) .and. !empty(jParams["12"][1])
			cQuery += " AND FQK.FQK_DTINIC BETWEEN '"+dDtIni1+"' AND '"+dDtFim2+"' "
		EndIf

		if !empty(jParams["13"][1]) .and. !empty(jParams["14"][1])
			cQuery += " AND FQK.FQK_DTFIM BETWEEN '"+dDtIni3+"' AND '"+dDtFim4+"' "
		EndIf

		if !empty(jParams["15"][1]) .and. !empty(jParams["16"][1])
			cQuery += " AND FQK.FQK_MEDSEQ BETWEEN '"+{jParams['15'][1]}[1]+"' AND '"+{jParams['16'][1]}[1]+"' "
		EndIf

		if !empty(jParams["17"][1]) .and. !empty(jParams["18"][1])
			cQuery += " AND FQK.FQK_GRPMD BETWEEN '"+{jParams['17'][1]}[1]+"' AND '"+{jParams['18'][1]}[1]+"' "
		EndIf
	endif

	//Os filtros serão setados na interface do novo TReports
	//if oFilter:hasFilter()
	//	cQuery += " AND " + oFilter:getSQLExpression()
	//endif

	oExec  := FwExecStatement():New(ChangeQuery(cQuery))
	oExec:SetQuery(cQuery)

	cAlias := oExec:OpenAlias()

	(cAlias)->(DBCloseArea())
	self:setQuery(cQuery)

	//Define o campo de ordenação da query
	self:setOrder("FQK.FQK_PROJET")

return self:oData

/*/{PROTHEUS.DOC} sigaloc.sv.loc.medicoeslancadas.tlpp
ITUP BUSINESS - TOTVS RENTAL
METODO PARA GERAÇÃO DE PARAMETROS E COLUNAS DE DADOS
@TYPE METHOD
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 29/05/2025
/*/
method getSchema() as object class medicao
 
	self:addProperty("Filial",               "Filial",                       "string", "Filial",                       "FQK_FILIAL")
	self:addProperty("TpMedicao",            "Tp.Medicao",                   "string", "Tp.Medicao",                   "FQK_TPMED")
	self:addProperty("Projeto",              "Projeto",                      "string", "Projeto",                      "FQK_PROJET")
	self:addProperty("Natureza",             "Natureza",                     "string", "Natureza",                     "ED_CODIGO")
	self:addProperty("NomeCliente",          "Nome Cliente",                 "string", "Nome Cliente",                 "FQK_NOMAGE")
	self:addProperty("NomVendedor",          "Nom.Vendedor",                 "string", "Nom.Vendedor",                 "FQK_NOMVEM")
	self:addProperty("CondPgto",             "Cond.Pgto",                    "string", "Cond.Pgto",                    "E4_CODIGO")
	self:addProperty("GrpMedicao",           "Grp. Medicao",                 "string", "Grp. Medicao",                 "FQK_GRPMD") 
	self:addProperty("AS",                   "A.S.",                         "string", "A.S.",                         "FQK_AS")
	self:addProperty("PerMedicao",           "Per. Medicao",                 "string", "Per. Medicao",                 "FQK_PMEDI")
	self:addProperty("NroMedicao",           "Nro.Medicao",                  "string", "Nro.Medicao ",                 "FQK_COD")
	self:addProperty("SeqMedicao",           "Seq. Medicao",                 "string", "Seq. Medicao",                 "FQK_MEDSEQ")
	self:addProperty("DtInicio",             "Dt. Inicio",                   "date",   "Dt. Inicio",                   "FQK_DTINIC")
	self:addProperty("DtFim",                "Dt. Fim",                      "date",   "Dt. Fim",                      "FQK_DTFIM")
	self:addProperty("Cliente",              "Cliente",                      "string", "Cliente",                      "FQK_CLIENT")
	self:addProperty("Loja",                 "Loja",                         "string", "Loja",                         "FQK_LOJA")
	self:addProperty("DescCondPgto",         "Desc.Cond.Pgto",               "string", "Desc.Cond.Pgto",               "E4_DESCRI")
	self:addProperty("Situacao",             "Situacao",                     "string", "Situacao",                     "FQK_SITUAC")
	self:addProperty("Arredonda",            "Arredonda",                    "number", "Arredonda",                    "FQK_VLARRE")
	self:addProperty("DescNatureza",         "Desc.Natureza",                "string", "Desc.Natureza",                "ED_DESCRIC")
	self:addProperty("CodVendedor",          "Cod.Vendedor",                 "string", "Cod.Vendedor",                 "FQK_CODVEN")
	self:addProperty("CliFat",               "Cli.Fat.",                     "string", "Cli.Fat.",                     "FQK_CLIFAT")
	self:addProperty("LojCliFat",            "Loj.Cli.Fat.",                 "string", "Loj.Cli.Fat.",                 "FQK_LOJFAT")
	self:addProperty("NomCliFat",            "Nom.Cli.Fat.",                 "string", "Nom.Cli.Fat.",                 "FQK_NOMFAT")
	self:addProperty("IntContador",          "Int.Contador",                 "string", "Int.Contador",                 "FQK_INTCON")
	self:addProperty("TpConsFran",           "Tp.Cons.Fran",                 "string", "Tp.Cons.Fran",                 "FQK_TPFRAN")
	self:addProperty("PedidoDeVenda",        "Pedido De Venda",              "string", "Pedido De Venda",              "FQK_NUMPV")
	self:addProperty("Obra",                 "Obra",                         "string", "Obra",                         "FQK_OBRA")
	self:addProperty("MinHrsMes",            "Min. Hrs.Mes",                 "number", "Min. Hrs.Mes",                 "FQK_MINMES")
	self:addProperty("FranqCalc",            "Franq.Calc.",                  "number", "Franq.Calc.",                  "FQK_VLRFRA")
	self:addProperty("QtdTotal",             "Qtd.Total",                    "number", "Qtd.Total",                    "FQK_QTDKM")
	self:addProperty("TotalBase",            "Total Base",                   "number", "Total Base",                   "FQK_DUBASE")
	self:addProperty("QtdTotBase",           "Qtd.Tot.Base",                 "number", "Qtd.Tot.Base",                 "FQK_QTDTOT")
	self:addProperty("TotCobBase",           "Tot.Cob.Base",                 "number", "Tot.Cob.Base",                 "FQK_QTDHR")
	self:addProperty("VlrTotItem",           "Vlr.Tot.Item",                 "number", "Vlr.Tot.Item",                 "FQK_VALTOT")
	self:addProperty("VlrTotMedi",           "Vlr.Tot.Medi",                 "number", "Vlr.Tot.Medi",                 "FQK_VLRTOT")
	self:addProperty("VlrDesconto",          "Vlr.Desconto",                 "number", "Vlr.Desconto",                 "FQK_VLRDES")
	self:addProperty("VlrAcresc",            "Vlr.Acresc.",                  "number", "Vlr.Acresc.",                  "FQK_VLRACR")
	self:addProperty("VlrFrete",             "Vlr.Frete",                    "number", "Vlr.Frete",                    "FQK_VLRMOB")
	self:addProperty("VlrSeguro",            "Vlr.Seguro",                   "number", "Vlr.Seguro",                   "FQK_VALSEG")
	self:addProperty("VlrISS",               "Vlr.ISS",                      "number", "Vlr.ISS",                      "FQK_VLAISS")
	self:addProperty("VlrServico",           "Vlr.Serviço",                  "number", "Vlr.Serviço",                  "FQK_VALSER")
	self:addProperty("TotMaoObra",           "Tot.Mão Obra",                 "number", "Tot.Mão Obra",                 "FQK_VLTOTM")
	self:addProperty("VlrExtra",             "Vlr.Extra",                    "number", "Vlr.Extra",                    "FQK_VREXTR")
	self:addProperty("TotMaquina",           "Tot.Máquina",                  "number", "Tot.Máquina",                  "FQK_VLMAQ")


	self:addParameter("01"  , "Projeto de"           , "string"  , .F., "", .F.,.T.,"FP0"      , "MV_PAR01")
	self:addParameter("02"  , "Projeto até"          , "string"  , .F., "", .F.,.T.,"FP0"      , "MV_PAR02")
	self:addParameter("03"  , "Obra de"              , "string"  , .F., "", .F.,.F.,""         , "MV_PAR03")
	self:addParameter("04"  , "Obra até"             , "string"  , .F., "", .F.,.F.,""         , "MV_PAR04")
	self:addParameter("05"  , "Cliente de"           , "string"  , .F., "", .F.,.T.,"SA1"      , "MV_PAR05")
	self:addParameter("06"  , "Cliente até"          , "string"  , .F., "", .F.,.T.,"SA1"      , "MV_PAR06")
	self:addParameter("07"  , "Loja de"              , "string"  , .F., "", .F.,.F.,""         , "MV_PAR07")
	self:addParameter("08"  , "Loja até"             , "string"  , .F., "", .F.,.F.,""         , "MV_PAR08")
	self:addParameter("09"  , "Vendedor de"          , "string"  , .F., "", .F.,.T.,"SA3"      , "MV_PAR09")
	self:addParameter("10"  , "Vendedor até"         , "string"  , .F., "", .F.,.T.,"SA3"      , "MV_PAR10")
	self:addParameter("11"  , "Dt inicio de"         , "date"    , .F., "", .F.,.F.,""         , "MV_PAR11")
	self:addParameter("12"  , "Dt inicio até"        , "date"    , .F., "", .F.,.F.,""         , "MV_PAR12")
	self:addParameter("13"  , "Dt Fim de"            , "date"    , .F., "", .F.,.F.,""         , "MV_PAR13")
	self:addParameter("14"  , "Dt Fim até"           , "date"    , .F., "", .F.,.F.,""         , "MV_PAR14")
	self:addParameter("15"  , "Seq. Medicao de"      , "string"  , .F., "", .F.,.F.,""         , "MV_PAR15")
	self:addParameter("16"  , "Seq. Medicao até"     , "string"  , .F., "", .F.,.F.,""         , "MV_PAR16")
	self:addParameter("17"  , "Grp. Medicao de"      , "string"  , .F., "", .F.,.F.,""         , "MV_PAR17")
	self:addParameter("18"  , "Grp. Medicao até"     , "string"  , .F., "", .F.,.F.,""         , "MV_PAR18")
	
return self:oSchema
