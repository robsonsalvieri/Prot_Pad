#INCLUDE "HHMOBEXP.ch"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "TBICONN.CH"
#DEFINE VM_INSERT 08192   // Inclusao de Registro
#DEFINE VM_UPDATE 16384   // Alteracao de Registro
#DEFINE VM_DELETE 32768   // Exclusao de Registro

#DEFINE KB_ENTER Chr(13)+Chr(10)

Static __HHLog     := Val(GetSrvProfString("HHTriggerLog","0"))
Static __HHLogMsg  := ""
Static __HHLogTime := 0
Static __HHLogTab  := 9
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSM0  Ё Autor ЁEduardo Riera          Ё Data Ё06/01/2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁSincronizaГЦo do HandHeld - SM0 - Tabela de Empresas        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSM0(cCpo,nOper)

Local cId     :=  ""
Local cIntr   := "I"
Local nVersao := 1
DEFAULT cCpo  := ""
DEFAULT nOper := 0

dbSelectArea("SM0")
dbSetOrder(1)
If MsSeek(AllTrim((PGALIAS)->HHG_EMPFIL))
	cId := HHCheckID("HM0","SM0")
	If !cId == "0" .And. nOper >= 0
		Begin Transaction	
			dbSelectArea("HM0")
			dbSetOrder(1)
			If !MsSeek(cId + SM0->M0_CODIGO + SM0->M0_CODFIL)
				RecLock("HM0", .T.)
			Else
				RecLock("HM0", .F.)
			EndIf
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁAnalisa a instrucao e versao do registro                                         Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cIntr := HHChkIntr(nOper,"HM0",HM0->(Found()))
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁObtem a prСxima versao do registro                                               Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
			If nOper <> 0
				nVersao := HHNextVer(cID,"HM0")	
			EndIf
			HM0->HM0_ID      := cId
			HM0->HM0_FILIAL  := SM0->M0_CODFIL
			HM0->HM0_COD     := SM0->M0_CODIGO
			HM0->HM0_NOME    := SM0->M0_NOME
			HM0->HM0_NOMCOM  := SM0->M0_NOMECOM
			HM0->HM0_ENDCOB  := SM0->M0_ENDCOB
			HM0->HM0_BAICOB  := SM0->M0_BAIRCOB
			HM0->HM0_CIDCOB  := SM0->M0_CIDCOB
			HM0->HM0_ESTCOB  := SM0->M0_ESTCOB
			HM0->HM0_CEPCOB  := SM0->M0_CEPCOB
			HM0->HM0_CGC     := SM0->M0_CGC
			HM0->HM0_INSC    := SM0->M0_INSC
			HM0->HM0_TEL     := SM0->M0_TEL
			HM0->HM0_INTR    := cIntr
			HM0->HM0_VER     := nVersao
			HM0->HM0_MCSIP   := SuperGetMV("MV_MCSIP",,"")
			HM0->HM0_MCSPRT  := SuperGetMV("MV_MCSPRT",,0)
			HM0->HM0_MCSTO   := SuperGetMV("MV_MCSTO",,0)
			HM0->HM0_MCSSER  := HGU->HGU_SERIE
			HM0->HM0_SUFIXO  := (PGALIAS)->HHG_SUFIXO
			HM0->HM0_EMP     := SM0->M0_CODIGO
			HM0->(MsUnlock())
            
			HHExcGenDel("HM0")
			HHUpdCtr(cID,"HM0")
		End transaction
	EndIf
EndIf
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSA3  Ё Autor ЁEduardo Riera          Ё Data Ё06/01/2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁSincronizaГЦo do HandHeld - SA3 - Vendedores                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSA3(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSA3    := SA3->(GetArea())
Local cId         := HHCheckID("HA3","SA3")
Local cIntr       := "I"
Local nVersao     := 1
DEFAULT cCpo      := ""
DEFAULT nOper     := 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0
	dbSelectArea("SA3")
	dbSetOrder(1)
	If MsSeek(xFilial("SA3")+cId)
		Begin Transaction
			dbSelectArea("HA3")
			dbSetOrder(1)
			If !MsSeek(xFilial("HA3") + cId + cId)
				RecLock("HA3", .T.)
			Else
				RecLock("HA3", .F.)
			EndIf
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁAnalisa a instrucao e versao do registro                                         Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cIntr := HHChkIntr(nOper,"HA3",HA3->(Found()))
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁObtem a prСxima versao do registro                                               Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
			If nOper <> 0
				nVersao := HHNextVer(cID,"HM0")	
			EndIf
			HA3->HA3_FILIAL := xFilial("SA3")
			HA3->HA3_ID     := cId
			HA3->HA3_COD    := SA3->A3_COD
			HA3->HA3_NREDUZ := SA3->A3_NREDUZ
			HA3->HA3_COMISS := SA3->A3_COMIS
			HA3->HA3_SENHA  := SA3->A3_SENHA
			HA3->HA3_PEDINI := If(Empty(SA3->A3_PEDINI), "000000", SA3->A3_PEDINI)
			HA3->HA3_PEDFIM := If(Empty(SA3->A3_PEDFIM), "999999", SA3->A3_PEDFIM)
			HA3->HA3_CLIINI := If(Empty(SA3->A3_CLIINI), "000000", SA3->A3_CLIINI)
			HA3->HA3_CLIFIM := If(Empty(SA3->A3_CLIFIM), "999999", SA3->A3_CLIFIM)
			HA3->HA3_PROPED := SA3->A3_PROXPED
			HA3->HA3_PROCLI := SA3->A3_PROXCLI
			If SA3->(FieldPos("A3_CON")) > 0 .And. HA3->(FieldPos("HA3_CON")) > 0
				HA3->HA3_CON := SA3->A3_CON
			Endif
			If SA3->(FieldPos("A3_USR")) > 0 .And. HA3->(FieldPos("HA3_USR")) > 0
				HA3->HA3_USR := SA3->A3_USR
			EndIf
			If SA3->(FieldPos("A3_PSW")) > 0 .And. HA3->(FieldPos("HA3_PSW")) > 0
				HA3->HA3_PSW := SA3->A3_PSW
			EndIf
			If SA3->(FieldPos("A3_CONVPN")) > 0 .And. HA3->(FieldPos("HA3_CONVPN")) > 0
				HA3->HA3_CONVPN := SA3->A3_CONVPN
			Endif
			If SA3->(FieldPos("A3_USRVPN")) > 0 .And. HA3->(FieldPos("HA3_USRVPN")) > 0
				HA3->HA3_USRVPN := SA3->A3_USRVPN
			EndIf
			If SA3->(FieldPos("A3_PSWVPN")) > 0 .And. HA3->(FieldPos("HA3_PSWVPN")) > 0
				HA3->HA3_PSWVPN := SA3->A3_PSWVPN
			EndIf
			HA3->HA3_VER    := nVersao
			HA3->HA3_INTR   := cIntr
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁPonto de Entrada para efetuar a gravacao de campos extrar Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If ExistBlock("HEXPSA3A")
				ExecBlock("HEXPSA3A", .F., .F.)
			EndIf
			HA3->(MsUnlock())
			HHExcGenDel("HA3")
			HHUpdCtr(cID,"HA3")	
		End Transaction	
	EndIf
EndIf
RestArea(aAreaSA3)
RestArea(aArea)
Return(cID)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSA1  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SA1                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSA1(cCpo,nOper)

Local aArea		:= GetArea()
Local aAreaSA1	:= SA1->(GetArea())
Local aAreaHA1	:= HA1->(GetArea())
Local nX		:= 1
Local cInsert	:= ""
Local cDelete	:= ""
Local cSelect	:= ""
Local cQuery	:= ""
Local cUpdate	:= ""
Local cNoQuery	:= ""
Local cDelUpd	:= ""
Local cId		:= HHCheckID("HA1","SA1")
Local cAliasSA1	:= "SA1"
Local aDados	:= {}
Local cIntr		:= "I"
Local nVersao	:= 1
Local nRetSql  	:= 0
Local cFuncName	:= ProcName()
Local cA1bloq	:= SuperGetMv("MV_SFA1BLQ",,"S")
DEFAULT cCpo 	:= ""
DEFAULT nOper	:= 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica o relacionamento dos campos e tabelas        Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aadd(aDados,{"HA1_FILIAL ","A1_FILIAL"})
	aadd(aDados,{"HA1_COD    ","A1_COD"})
	aadd(aDados,{"HA1_LOJA   ","A1_LOJA"})
	aadd(aDados,{"HA1_CGC    ","A1_CGC"})
	aadd(aDados,{"HA1_NOME   ","A1_NOME"})
	aadd(aDados,{"HA1_NREDUZ ","A1_NREDUZ"})
	aadd(aDados,{"HA1_TIPO   ","A1_TIPO"})
	aadd(aDados,{"HA1_END    ","A1_END"})
	aadd(aDados,{"HA1_MUN    ","A1_MUN"})
	aadd(aDados,{"HA1_EST    ","A1_EST"})
	aadd(aDados,{"HA1_BAIRRO ","A1_BAIRRO"})
	aadd(aDados,{"HA1_CEP    ","A1_CEP"})
	aadd(aDados,{"HA1_TEL    ","A1_TEL"})
	aadd(aDados,{"HA1_FAX    ","A1_FAX"})
	aadd(aDados,{"HA1_INSCR  ","A1_INSCR"})
	aadd(aDados,{"HA1_INSCRM ","A1_INSCRM"})
	aadd(aDados,{"HA1_VEND   ","A1_VEND"})
	aadd(aDados,{"HA1_REGIAO ","A1_REGIAO"})
	aadd(aDados,{"HA1_TRANSP ","A1_TRANSP"})
	aadd(aDados,{"HA1_TPFRET ","A1_TPFRET"})
	aadd(aDados,{"HA1_COND   ","A1_COND"})
	aadd(aDados,{"HA1_RISCO  ","A1_RISCO"})
	aadd(aDados,{"HA1_LC     ","A1_LC"})
	aadd(aDados,{"HA1_VENCLC ","A1_VENCLC"})
	aadd(aDados,{"HA1_MCOMPR ","A1_MCOMPRA"})
	aadd(aDados,{"HA1_METR   ","A1_METR"})
	aadd(aDados,{"HA1_MSALDO ","A1_MSALDO"})
	aadd(aDados,{"HA1_NROCOM ","A1_NROCOM"})
	aadd(aDados,{"HA1_PRICOM ","A1_PRICOM"})
	aadd(aDados,{"HA1_ULTCOM ","A1_ULTCOM"})
	aadd(aDados,{"HA1_ULTVIS ","A1_ULTVIS"})
	aadd(aDados,{"HA1_NROPAG ","A1_NROPAG"})
	aadd(aDados,{"HA1_SALDUP ","A1_SALDUP"})
	aadd(aDados,{"HA1_SALPDL ","A1_SALPEDL"})
	aadd(aDados,{"HA1_ATR    ","A1_ATR"})
	aadd(aDados,{"HA1_VACUM  ","A1_VACUM"})
	aadd(aDados,{"HA1_SALPED ","A1_SALPED"})
	aadd(aDados,{"HA1_TITPRO ","A1_TITPROT"})
	aadd(aDados,{"HA1_DTULTI ","A1_DTULTIT"})
	aadd(aDados,{"HA1_CHQDEV ","A1_CHQDEVO"})
	aadd(aDados,{"HA1_DTULCH ","A1_DTULCHQ"})
	aadd(aDados,{"HA1_MATR   ","A1_MATR"})
	aadd(aDados,{"HA1_MAIDUP ","A1_MAIDUPL"})
	aadd(aDados,{"HA1_TABELA ","A1_TABELA"})
	aadd(aDados,{"HA1_PAGATR ","A1_PAGATR"})
	aadd(aDados,{"HA1_RG     ","A1_RG"})
	aadd(aDados,{"HA1_DTNASC ","A1_DTNASC"})
	aadd(aDados,{"HA1_EMAIL  ","A1_EMAIL"})
	aadd(aDados,{"HA1_GRPVEN ","A1_GRPVEN"})
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁCaso seja necessАrio trabalhar com condicao de pagamento fixa o campo A1_CNDFIX, Ё
	//Ёdeve ser criado no dicionАrio                                                    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If SA1->(FieldPos("A1_CNDFIX")>0) .And. HA1->(FieldPos("HA1_CNDFIX")>0)
		aadd(aDados,{"HA1_CNDFIX ", "A1_CNDFIX"})
	EndIf
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁCaso seja necessАrio trabalhar com escolha de forma de pagamento pelo cliente    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If SA1->(FieldPos("A1_FORPAG")>0) .And. HA1->(FieldPos("HA1_FORPAG")>0)
		aadd(aDados,{"HA1_FORPAG ","A1_FORPAG"})
	EndIf

	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para alteraГЦo dos Campos para exportaГЦo/ImportaГЦo da tabela de clientes   Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSA101")
		aDados := ExecBlock("HEXPSA101", .F., .F., {aDados})
		If __HHLog >= 1
			__HHLogMsg := STR0001 
			GravaHHLog(__HHLogMsg)
		EndIf
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁExportaГЦo da tabela de Clientes                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SA1")
	dbSetOrder(1)
	dbSelectArea("HA1")
	dbSetOrder(1)
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁExportaГЦo da tabela de clientes.                     Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If LockByName("HHEXP_SA1"+cID,.T.,!Empty(xFilial("HA1")),.T.)	
				dbSelectArea("SA1")
				dbCommit()

				cQuery := "FROM "+RetSqlName("SA1")+" SA1 "
				cQuery += "WHERE "
				cQuery += "SA1.A1_FILIAL='" + xFilial("SA1") + "' AND "
				If !Empty(cId)
					cQuery += "SA1.A1_VEND = '" + cId + "' AND "
				EndIf
				If cA1bloq == "N"
					cQuery += "SA1.A1_MSBLQL <> '1' AND "
				EndIf
				cQuery += "SA1.D_E_L_E_T_ = ' ' "
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSA1B")
					cQuery := ExecBlock("HEXPSA1B", .F., .F., {cQuery})
				EndIf
				
				cNoQuery := " AND "
				cNoQuery += "SA1.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HA1.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HA1")+" HA1 "
				cNoQuery += "WHERE "
				cNoQuery += "HA1_FILIAL='"+xFilial("HA1")+"' AND "
				cNoQuery += "HA1.D_E_L_E_T_ = ' ' ) "

				If nOper <> 0

					cQryAltVend := "SELECT "
					//For nX := 1 To Len(aDados)
					//	cQryAltVend += aDados[nX][1] + "," + aDados[nX][2] + ","
					//Next nX
					cQryAltVend +=  "HA1.HA1_VEND OLDVEND, SA1.A1_VEND NEWVEND,HA1.HA1_COD CLIENTE, HA1.HA1_LOJA LOJA "
					cQryAltVend += "FROM "+RetSqlName("SA1")+" SA1, "+RetSqlName("HA1")+" HA1 "
					cQryAltVend += "WHERE "
					cQryAltVend += "SA1.A1_FILIAL='" + xFilial("SA1") + "' AND "
					cQryAltVend += "HA1.HA1_FILIAL='" + xFilial("HA1") + "' AND "
					cQryAltVend += "SA1.A1_COD = HA1.HA1_COD AND "
					cQryAltVend += "SA1.A1_LOJA = HA1.HA1_LOJA AND "
					cQryAltVend += "SA1.A1_VEND <> HA1.HA1_VEND AND "
					cQryAltVend += "HA1.HA1_INTR NOT IN ('N','X','E') AND "
					cQryAltVend += "SA1.D_E_L_E_T_ = ' ' AND " 
					cQryAltVend += "HA1.D_E_L_E_T_ = ' ' "				
					
					
					cQryAltVend := ChangeQuery(cQryAltVend)
					cCursor    := GetNextAlias()
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQryAltVend),cCursor)
	                cAliasQry := Alias()

	    			If __HHLog >= 1
						__HHLogMsg := "PALMJOB: Execucao da Query cQryAltVend: " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cQryAltVend + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

		            While !(cAliasQry)->(EOF())
						Begin Transaction
							dbSelectArea("HA1")
							HA1->(dbSetOrder(1))
						    If HA1->(dbSeek( xFilial("HA1") + (cAliasQry)->OLDVEND + (cAliasQry)->CLIENTE + (cAliasQry)->LOJA ))
							    Reclock("HA1",.F.)
									HA1_ID := cId
									HA1_vend := cId		
							    HA1->(MsUnlock())
								HHAtuVendClie((cAliasQry)->NEWVEND,(cAliasQry)->OLDVEND,(cAliasQry)->CLIENTE,(cAliasQry)->LOJA)
							EndIf
							(cAliasQry)->(dbSkip())	
						End Transaction
					EndDo					
	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HA1",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HA1")	

					cUpdate := "FROM "+RetSqlName("SA1")+" SA1 "
					cUpdate += "WHERE "
					cUpdate += "SA1.A1_FILIAL='" + xFilial("SA1") + "' AND "
					If !Empty(cId)
						cUpdate += "SA1.A1_VEND = '" + cId + "' AND "
					EndIf
					cUpdate += "SA1.D_E_L_E_T_ = ' ' AND "
					cUpdate += "HA1_FILIAL='" + xFilial("HA1") + "' AND "
					cUpdate += "HA1_ID = '" + cID + "' AND "
					cUpdate += "HA1_COD = SA1.A1_COD AND "
					cUpdate += "HA1_LOJA = SA1.A1_LOJA AND "
					cUpdate += "("
					For nX := 1 To Len(aDados)-1
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
					Next nX
					cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

				EndIf

				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX		
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "R_E_C_N_O_ "

				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HA1")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ") AND "
					cDelete += "HA1_STATUS NOT IN ('N','A') AND "
					cDelete += "(HA1_INTR <> 'N' OR (HA1_INTR = 'N' AND HA1_STATUS = ' ')) "

				Else

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HA1")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT SA1.R_E_C_N_O_ "
					cDelete += cUpdate
					cDelete += ") AND "
					cDelete += "HA1_STATUS NOT IN ('N','A') AND "
					cDelete += "(HA1_INTR <> 'N' OR (HA1_INTR = 'N' AND HA1_STATUS = ' ')) "


				EndIf

				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cDelete)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HA1")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","	
				Next nX
				cInsert += "HA1_INTR,"
				cInsert += "HA1_VER,"
				cInsert += "HA1_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery
 
				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cInsert)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If nOper <> 0
					cDelUpd  := "UPDATE "+RetSqlName("HA1")+" "
					cDelUpd  += "SET HA1_INTR = 'E',HA1_VER="+Str(nVersao,10)+" "
					cDelUpd  += "WHERE "
					cDelUpd  += "R_E_C_N_O_ NOT IN ("
					cDelUpd  += "SELECT SA1.R_E_C_N_O_ "
					cDelUpd  += cQuery
					cDelUpd  += ") AND "
					cDelUpd  += "HA1_STATUS NOT IN ('N','A') AND "
					cDelUpd  += "HA1_INTR <> 'N' AND "					
					cDelUpd  += "HA1_ID = '"+cID+"' AND HA1_INTR <> 'E' "

					__HHLogTime := PText2Sec(Time())
					nRetSql := TcSqlExec(cDelUpd)
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
				EndIf
				Begin Transaction
					HHExcGenDel("HA1")
					HHUpdCtr(cID,"HA1")	
				End Transaction			
				UnLockByName("HHEXP_SA1"+cID,.T.,!Empty(xFilial("HA1")),.T.)
			EndIf			
		Else
	#ENDIF
		If nOper == 0
			dbSelectArea(cAliasSA1)
			cQuery := "A1_VEND $ '" + cId + "'"
			MsSeek(xFilial("SA1"))
			While !SA1->(Eof()) .And. SA1->A1_FILIAL == xFilial("SA1")
				Begin Transaction
					If SA1->(&(cQuery))
						dbSelectArea("HA1")
						dbSetOrder(1)
						If !dbSeek(xFilial("HA1") + cId + SA1->A1_COD+SA1->A1_LOJA)
							RecLock("HA1", .T.)
						Else
							RecLock("HA1", .F.)
						EndIf
						HA1->HA1_FILIAL := xFilial("SA1")
						HA1->HA1_ID     := cId
						For nX := 1 To Len(aDados)
							HA1->(FieldPut(HA1->(FieldPos(aDados[nX][1])),SA1->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HA1->HA1_STATUS := "P"
						HA1->HA1_FLGVIS := "0"
						HA1->HA1_OCO    := ""
						HA1->HA1_VER     := nVersao
						HA1->HA1_INTR   := cIntr
					EndIf
				End Transaction
				dbSelectArea(cAliasSA1)
				dbSkip()
			EndDo
			HHUpdCtr(cID,"HA1")	
		Else 	
			Begin Transaction
				dbSelectArea("HA1")
				dbSetOrder(1)
				If !dbSeek(xFilial("SA1") + cId + SA1->A1_COD+SA1->A1_LOJA)
					RecLock("HA1", .T.)
				Else
					RecLock("HA1", .F.)
				EndIf
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁAnalisa a instrucao e versao do registro                                         Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				cIntr := HHChkIntr(nOper,"HA1",HA1->(Found()))
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁObtem a prСxima versao do registro                                               Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
				If nOper <> 0
					nVersao := HHNextVer(cID,"HA1")	
				EndIf		 			
				HA1->HA1_FILIAL := xFilial("SA1")
				HA1->HA1_ID     := cId
				For nX := 1 To Len(aDados)
					HA1->(FieldPut(HA1->(FieldPos(aDados[nX][1])),SA1->(FieldGet(FieldPos(aDados[nX][2])))))
				Next nX
				HA1->HA1_STATUS := "P"
				HA1->HA1_FLGVIS := "0"
				HA1->HA1_OCO    := ""
				HA1->HA1_VER    := nVersao
				HA1->HA1_INTR   := cIntr

				HHUpdCtr(cID,"HA1")	
			End Transaction
		EndIf
		#IFDEF TOP
		EndIf
		#ENDIF
EndIf
RestArea(aAreaHA1)
RestArea(aAreaSA1)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSBM  Ё Autor ЁEduardo Riera          Ё Data Ё07.12.05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SBM                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSBM(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSBM    := SBM->(GetArea())
Local cLista      := ""
Local cTipProd    := SuperGetMv("MV_PLMTPPR",,"PA") // Define filtro para o campo do parametro MV_SFCPOPR
Local cCpoTipo    := SuperGetMv("MV_SFCPOPR",,"B1_TIPO") // Indica o campo a ser filtado com o parametro MV_PLMTPPR
Local cB1bloq     := SuperGetMv("MV_SFB1BLQ",,"S") // Indica se deve exportar produtos bloqueados
Local cId         := HHCheckID("HBM","SBM")
Local cTpProduto  := ""
Local nX          := 0
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cUpdate     := ""
Local cNoQuery    := ""
Local cQuery      := ""
Local cDelUpd     := ""
Local cQryDelHH   := ""
Local aDados      := {}
Local aJobGlobal := {}
Local cIntr   := "I"
Local nVersao := 1
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()
DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSBM")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDados,{"HBM_FILIAL ","BM_FILIAL"})
		aadd(aDados,{"HBM_GRUPO  ","BM_GRUPO" })
		aadd(aDados,{"HBM_DESC   ","BM_DESC"  })
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSBMA")
			aDados := ExecBlock("HEXPSBMA", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica os tipos validos                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cLista     := "'"
		cTpProduto := AllTrim(cTipProd) + ","
		nX       := At(",", cTpProduto)
		While nX > 0
			cLista   += Substr(cTpProduto, 1, nX - 1) + "','"
			cTpProduto := Substr(cTpProduto, nX + 1, Len(cTpProduto))
			nX := At(",", cTpProduto)
		EndDo
		cLista := Subs(cLista, 1, Len(cLista)-2)
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de grupo de produtos.            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SBM")
		dbSetOrder(1)

		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de grupo de produtos.            Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SBM"+cID,.T.,!Empty(xFilial("HBM")),.T.)	
					cQuery := "FROM " + RetSqlName("SBM") + " SBM "
					cQuery += "WHERE "
					cQuery += "SBM.BM_FILIAL='" + xFilial("SBM") + "' AND "
					cQuery += "SBM.D_E_L_E_T_ = ' ' AND "
					cQuery += "EXISTS ("
					cQuery += "SELECT B1_FILIAL "
					cQuery += "FROM "+RetSqlName("SB1")+ " SB1 "
					cQuery += "WHERE "
					cQuery += "SB1.B1_FILIAL='" + xFilial("SB1") + "' AND "
					cQuery += "SB1.B1_GRUPO = SBM.BM_GRUPO AND "
					cQuery += "SB1." + cCpoTipo +" IN (" + cLista + ") AND "
					If cB1bloq == "N"
						cQuery += "SB1.B1_MSBLQL <> '1' AND "
					EndIf
					cQuery += "SB1.D_E_L_E_T_ = ' ' ) "				
					
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSBMB")
						cQuery := ExecBlock("HEXPSBMB", .F., .F., {cQuery})
					EndIf					

					cNoQuery := " AND "
					cNoQuery += "SBM.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HBM.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HBM")+" HBM "
					cNoQuery += "WHERE "
					cNoQuery += "HBM_FILIAL='"+xFilial("HBM")+"' AND "
					cNoQuery += "HBM.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HBM",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HBM")	

						cUpdate := "FROM "+RetSqlName("SBM")+" SBM "
						cUpdate += "WHERE "
						cUpdate += "SBM.BM_FILIAL='" + xFilial("SBM") + "' AND "
						cUpdate += "SBM.D_E_L_E_T_ = ' ' AND "
						cUpdate += "HBM_FILIAL='" + xFilial("HBM") + "' AND "
						cUpdate += "HBM_GRUPO = SBM.BM_GRUPO AND "
						cUpdate += "("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "				


					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HBM")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HBM")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf				
					
					__HHLogTime := PText2Sec(Time())
					nRetSql := TcSqlExec(cDelete)
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HBM")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HBM_INTR,"
					cInsert += "HBM_VER,"
					cInsert += "HBM_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "

					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper<>0
						cDelUpd  := "UPDATE "+RetSqlName("HBM")+" "
						cDelUpd  += "SET HBM_INTR = 'E',HBM_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SBM.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SBM")+" SBM "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SBM.R_E_C_N_O_ AND "
						cDelUpd  += "SBM.D_E_L_E_T_=' ' ) AND HBM_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

					EndIf							
					cQryDelHH := "UPDATE "+RetSqlName("HBM")+" "
					cQryDelHH += "SET HBM_INTR = 'E',HBM_VER="+Str(nVersao,10)+" "
					cQryDelHH += "WHERE "
					cQryDelHH += "R_E_C_N_O_ IN ("
					cQryDelHH += "SELECT R_E_C_N_O_ "
					cQryDelHH += "FROM " + RetSqlName("SBM") + " SBM "
					cQryDelHH += "WHERE "
					cQryDelHH += "SBM.BM_FILIAL='" + xFilial("SBM") + "' AND "
					cQryDelHH += "SBM.D_E_L_E_T_ = ' ' AND "
					cQryDelHH += "NOT EXISTS ("
					cQryDelHH += "SELECT B1_FILIAL "
					cQryDelHH += "FROM "+RetSqlName("SB1")+ " SB1 "
					cQryDelHH += "WHERE "
					cQryDelHH += "SB1.B1_FILIAL='" + xFilial("SB1") + "' AND "
					cQryDelHH += "SB1.B1_GRUPO = SBM.BM_GRUPO AND "
					cQryDelHH += "SB1." + cCpoTipo +" IN (" + cLista + ") AND "
					cQryDelHH += "SB1.D_E_L_E_T_ = ' ' ) "	
					cQryDelHH += ")"
					
					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cQryDelHH)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cQryDelHH + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					Begin Transaction
						HHExcGenDel("HBM")
						HHUpdCtr(cID,"HBM")	
					End Transaction		
					UnLockByName("HHEXP_SBM"+cID,.T.,!Empty(xFilial("HBM")),.T.)
				EndIf				
			Else
		#ENDIF
		

			cQuery := "SB1->" + cCpoTipo +" $ '" + cTipProd + "'"	
			
			If nOper == 0
				dbSelectArea("SBM")
				MsSeek(xFilial("SBM"))
				While !SBM->(Eof())  .And. xFilial("SBM") == SBM->BM_FILIAL
					dbSelectArea("SB1")
					dbSetOrder(4)
					MsSeek(xFilial("SB1")+SBM->BM_GRUPO)
					If (SB1->(Found()) .And. &(cQuery))
						Begin Transaction
							dbSelectArea("HBM")
							dbSetOrder(1)
							If !MsSeek(SBM->BM_FILIAL + cID + SBM->BM_GRUPO)
								RecLock("HBM", .T.)
							Else
								RecLock("HBM", .F.)
							EndIf
							HBM->HBM_FILIAL := SBM->BM_FILIAL
							HBM->HBM_ID     := cId
							For nX := 1 To Len(aDados)
								HBM->(FieldPut(HBM->(FieldPos(aDados[nX][1])),SBM->(FieldGet(FieldPos(aDados[nX][2])))))
							Next nX
							HBM->HBM_INTR   := cIntr
							HBM->HBM_VER    := nVersao
						End Transaction
					EndIf
					dbSelectArea("SBM")
					dbSkip()
				EndDo
			Else
				dbSelectArea("SB1")
				dbSetOrder(4)
				MsSeek(xFilial("SB1")+SBM->BM_GRUPO)
				If (SB1->(Found()) .And. &(cQuery))
					Begin Transaction
						dbSelectArea("HBM")
						dbSetOrder(1)
						If !MsSeek(SBM->HBM_FILIAL + cID + SBM->BM_GRUPO)
							RecLock("HBM", .T.)
						Else
							RecLock("HBM", .F.)
						EndIf
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HBM",HBM->(Found()))
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						If nOper <> 0
							nVersao := HHNextVer(cID,"HBM")	
						EndIf						
						HBM->HBM_FILIAL := SBM->BM_FILIAL
						HBM->HBM_ID     := cId
						For nX := 1 To Len(aDados)
							HBM->(FieldPut(HBM->(FieldPos(aDados[nX][1])),SBM->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HBM->HBM_INTR   := cIntr
						HBM->HBM_VER    := nVersao
					End Transaction
				EndIf			
			EndIf
			HHUpdCtr(cID,"HBM")
			#IFDEF TOP
			EndIf	
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSBM")==0
		aadd(aJobGlobal,"HHEXPSBM")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSBM)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSB1  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SB1                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSB1(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSB1    := SB1->(GetArea())
Local cLista      := ""
Local cTipProd    := SuperGetMv("MV_PLMTPPR",,"PA")
Local cCpoTipo    := SuperGetMv("MV_SFCPOPR",,"B1_TIPO")
Local cB1bloq     := SuperGetMv("MV_SFB1BLQ",,"S")
Local cId         := HHCheckID("HB1","SB1")
Local cTpProduto  := ""
Local nX          := 1
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cUpdate     := ""
Local cNoQuery    := ""
Local cQuery      := ""
Local cDelUpd     := ""
Local aDados      := {}
Local aJobGlobal  := {}
Local cIntr		  := "I"
Local nVersao	  := 1
Local nStatusTrg  := Val(GetSrvProfString("HHTriggerOn","0"))
Local lHExpSB1a	  := ExistBlock("HEXPSB1A")
Local nRetSql  	  := 0
Local cFuncName   := ProcName()
Local cInUpd      := ""

DEFAULT cCpo	  := ""
DEFAULT nOper	  := 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSB1")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDados,{"HB1_FILIAL ","B1_FILIAL"})
		aadd(aDados,{"HB1_GRUPO  ","B1_GRUPO"})
		aadd(aDados,{"HB1_COD    ","B1_COD"})
		aadd(aDados,{"HB1_DESC   ","B1_DESC"})
		aadd(aDados,{"HB1_UM     ","B1_UM"})
		aadd(aDados,{"HB1_PICM   ","B1_PICM"})
		aadd(aDados,{"HB1_IPI    ","B1_IPI"})
		aadd(aDados,{"HB1_ALQISS ","B1_ALIQISS"})
		aadd(aDados,{"HB1_QE     ","B1_QE"})
		aadd(aDados,{"HB1_COMIS  ","B1_COMIS"})
		aadd(aDados,{"HB1_CODBAR ","B1_CODBAR"})
		aadd(aDados,{"HB1_LOCPAD ","B1_LOCPAD"})
		aadd(aDados,{"HB1_TS     ","B1_TS"})
		aadd(aDados,{"HB1_PRV1   ","B1_PRV1"})
		aadd(aDados,{"HB1_SEGUM  ","B1_SEGUM"})
		aadd(aDados,{"HB1_PBRUTO ","B1_PESBRU"})
		aadd(aDados,{"HB1_TIPCON ","B1_TIPCONV"})
		aadd(aDados,{"HB1_CONV   ","B1_CONV"})
		
		If SB1->(FieldPos("B1_DESCMAX")) > 0 .And. HB1->(FieldPos("HB1_DESMAX")) > 0
			aadd(aDados,{"HB1_DESMAX ","B1_DESCMAX"})
		EndIf		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para alteraГЦo dos Campos para exportaГЦo/ImportaГЦo da tabela de clientes   Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSB101")
			aDados := ExecBlock("HEXPSB101", .F., .F., {aDados})
		EndIf
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica os tipos validos                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cLista     := "'"
		cTpProduto := AllTrim(cTipProd) + ","
		nX       := At(",", cTpProduto)
		While nX > 0
			cLista   += Substr(cTpProduto, 1, nX - 1) + "','"
			cTpProduto := Substr(cTpProduto, nX + 1, Len(cTpProduto))
			nX := At(",", cTpProduto)
		EndDo
		cLista := Subs(cLista, 1, Len(cLista)-2)

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de produtos                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SB1")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de grupo de produtos.            Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SB1"+cID,.T.,!Empty(xFilial("HB1")),.T.)	
					dbSelectArea("SB1")		

					cQuery := "FROM "+RetSqlName("SB1")+" SB1 "
					cQuery += "WHERE "
					cQuery += "SB1.B1_FILIAL='" + xFilial("SB1") + "' AND "
					cQuery += "SB1." + cCpoTipo +" IN (" + cLista + ") AND "
					cQuery += "SB1.D_E_L_E_T_ = ' ' "
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para filtro das tabelas de preГo
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If lHExpSB1a
						cQuery := ExecBlock("HEXPSB1A", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "SB1.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HB1.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HB1")+" HB1 "
					cNoQuery += "WHERE "
					cNoQuery += "HB1_FILIAL='"+xFilial("HB1")+"' AND "
					//					cNoQuery += "HB1_COD = SB1.B1_COD AND "
					cNoQuery += "HB1.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HB1",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HB1")	

						cUpdate := "FROM "+RetSqlName("SB1")+" SB1, " + RetSqlName("HB1")+" HB1 "
						cUpdate += "WHERE "
						cUpdate += "SB1.B1_FILIAL='" + xFilial("SB1") + "' AND "
						cUpdate += "SB1.D_E_L_E_T_ = ' ' AND "
						cUpdate += "HB1_FILIAL='" + xFilial("HB1") + "' AND "
						cUpdate += "HB1_COD = SB1.B1_COD AND "
						cUpdate += "( ("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" AND "
						cUpdate += "SB1." + cCpoTipo +" IN (" + cLista + ") AND "
						cUpdate += " HB1_INTR = 'E') ) "						
					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "

					If nOper == 0                     

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HB1")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						If cB1bloq == "N"
					     cDelete += " AND SB1.B1_MSBLQL = '1'"
					    EndIf
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HB1")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SB1.R_E_C_N_O_ "
						cDelete += cUpdate 
						cDelete += ")"

					EndIf				

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HB1")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
 						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HB1_INTR,"
					cInsert += "HB1_VER,"
					cInsert += "HB1_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					If cB1bloq == "N"
					   cInsert += " AND SB1.B1_MSBLQL = '2'"
					EndIf
					cInsert += cNoQuery
                               
					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HB1")+" "
						cDelUpd  += "SET HB1_INTR = 'E',HB1_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SB1.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SB1")+" SB1, "
						cDelUpd  += RetSqlName("HB1")+" HB1 "
						cDelUpd  += "WHERE "
						cDelUpd  += "HB1.R_E_C_N_O_ = SB1.R_E_C_N_O_ AND "
						cDelUpd  += "SB1.D_E_L_E_T_ = ' ' AND HB1_INTR <> 'E' "
						If cB1bloq == "N"
							cDelUpd += "AND SB1.B1_MSBLQL = '2' "
						EndIf
						cDelUpd  += " )"

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

						cDelUpd  := "UPDATE "+RetSqlName("HB1")+" "
						cDelUpd  += "SET HB1_INTR = 'E',HB1_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ IN ("
						cDelUpd  += "SELECT SB1.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SB1")+" SB1, "
						cDelUpd  += RetSqlName("HB1")+" HB1 "
						cDelUpd  += "WHERE "
						cDelUpd  += "SB1." + cCpoTipo +" IN (" + cLista + ") AND  HB1.HB1_INTR <> 'E'"
						If cB1bloq == "N"
							cDelUpd += "AND SB1.B1_MSBLQL = '1' "
						EndIf
						cDelUpd  += " )"

						__HHLogTime := PText2Sec(Time())
 						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf 
						
					    //здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					    //ЁAtiva o registro quando altera o produto para desbloqueado - SB1->B1_MSBLQL = '2' Ё
				  	    //юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					 	If cB1bloq == "N"
						   cInUpd  := "UPDATE "+RetSqlName("HB1")+" "
						   cInUpd  += "SET HB1_INTR = 'I',HB1_VER="+Str(nVersao,10)+" "
						   cInUpd  += "WHERE "
						   cInUpd  += "R_E_C_N_O_ IN ("
						   cInUpd  += "SELECT SB1.R_E_C_N_O_ "
						   cInUpd  += "FROM "+RetSqlName("SB1")+" SB1, "
						   cInUpd  += RetSqlName("HB1")+" HB1 "
						   cInUpd  += "WHERE "
						   cInUpd  += "HB1.R_E_C_N_O_ = SB1.R_E_C_N_O_ AND "
						   cInUpd  += "SB1.D_E_L_E_T_ = ' ' AND HB1_INTR = 'E' "
						   cInUpd += "AND SB1.B1_MSBLQL = '2' "
						   cInUpd  += " )"
                         
                           __HHLogTime := PText2Sec(Time())
						   nRetSql := 	TcSqlExec(cInUpd)
	
						   If __HHLog >= 1
							  __HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							  __HHLogMsg += Space(__HHLogTab) + cInUpd + KB_ENTER
							  If nRetSql != 0 .And. __HHLog == 9
								 __HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							  EndIf
							  __HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							  GravaHHLog(__HHLogMsg)
						   EndIf
	                    EndIf

						If lHExpSB1a
							cDelUpd  := "UPDATE "+RetSqlName("HB1")+" "
							cDelUpd  += "SET HB1_INTR = 'E',HB1_VER="+Str(nVersao,10)+" "
							cDelUpd  += "WHERE "
							cDelUpd  += "R_E_C_N_O_ NOT IN ("
							cDelUpd  += "SELECT SB1.R_E_C_N_O_ "
							cDelUpd  += cQuery +" ) "
							cDelUpd  += " AND HB1_INTR <> 'E' "

							__HHLogTime := PText2Sec(Time())
							nRetSql := 	TcSqlExec(cDelUpd)
		
							If __HHLog >= 1
								__HHLogMsg := STR0002 + cFuncName + "-5): " + KB_ENTER
								__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
								If nRetSql != 0 .And. __HHLog == 9
									__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
								EndIf
								__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
								GravaHHLog(__HHLogMsg)
							EndIf
						EndIf
					Else
						If lHExpSB1a
							cDelUpd  := "DELETE FROM "+RetSqlName("HB1")+" "
							cDelUpd  += "WHERE "
							cDelUpd  += "R_E_C_N_O_ NOT IN ("
							cDelUpd  += "SELECT SB1.R_E_C_N_O_ "
							cDelUpd  += cQuery +" ) "
							cDelUpd  += " AND HB1_INTR <> 'E' "

							__HHLogTime := PText2Sec(Time())
							nRetSql := 	TcSqlExec(cDelUpd)
		
							If __HHLog >= 1
								__HHLogMsg := STR0002 + cFuncName + "-6): " + KB_ENTER
								__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
								If nRetSql != 0 .And. __HHLog == 9
									__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
								EndIf
								__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
								GravaHHLog(__HHLogMsg)
							EndIf
							
						EndIf
					EndIf


					Begin Transaction
						HHExcGenDel("HB1")
						HHUpdCtr(cID,"HB1")	
					End Transaction		
					UnLockByName("HHEXP_SB1"+cID,.T.,!Empty(xFilial("HB1")),.T.)
				EndIf				
			Else
		#ENDIF		

			cQuery := cCpoTipo +" $ '" + cTipProd + "'"	
			
			If nOper == 0
				dbSelectArea("SB1")
				MsSeek(xFilial("SB1"))
				While !SB1->(Eof()) .And. SB1->B1_FILIAL == xFilial("SB1")
					If SB1->(&(cQuery))
						dbSelectArea("HB1")
						dbSetOrder(1)
						If !dbSeek(xFilial("SB1") + cId + SB1->B1_COD)
							RecLock("HB1", .T.)
						Else
							RecLock("HB1", .F.)
						EndIf
						HB1->HB1_FILIAL := xFilial("SB1")
						HB1->HB1_ID     := cId
						For nX := 1 To Len(aDados)
							HB1->(FieldPut(HB1->(FieldPos(aDados[nX][1])),SB1->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HB1->HB1_INTR   := cIntr
						HB1->HB1_VER    := nVersao
						HB1->(MsUnlock())
					EndIf
					dbSelectArea("SB1")
					dbSkip()
				EndDo
			Else
				If SB1->(&(cQuery))
					dbSelectArea("HB1")
					dbSetOrder(1)
					If !dbSeek(xFilial("SB1") + cId + SB1->B1_COD)
						RecLock("HB1", .T.)
					Else
						RecLock("HB1", .F.)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HB1",HB1->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					If nOper <> 0
						nVersao := HHNextVer(cID,"HB1")	
					EndIf											
					HB1->HB1_FILIAL := xFilial("SB1")
					HB1->HB1_ID     := cId
					For nX := 1 To Len(aDados)
						HB1->(FieldPut(HB1->(FieldPos(aDados[nX][1])),SB1->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HB1->HB1_INTR   := cIntr
					HB1->HB1_VER    := nVersao
					HB1->(MsUnlock())
				EndIf		
			EndIf
			HHUpdCtr(cID,"HB1")	
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSB1")==0
		aadd(aJobGlobal,"HHEXPSB1")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf	
EndIf
RestArea(aAreaSB1)
RestArea(aArea)
Return(cID)
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPDA0  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - DA0                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPDA0(cCpo,nOper)

Local aArea     := GetArea()
Local aAreaDA0  := DA0->(GetArea())
Local aAreaDA1  := DA1->(GetArea())
Local nX        := 1
Local cID       := HHCheckID("HTC","DA0")
Local cDelUpd   := ""
Local cUpdate   := ""
Local cNoQuery  := ""
Local cQuery    := ""
Local cMaxQry   := ""
Local cMaxAlias := ""
Local aDadosCab := {}
Local aDadosIte := {}
Local cIntr     := "I"
Local nVersao   := 1
Local aJobGlobal := {}
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local cTipProd    := SuperGetMv("MV_PLMTPPR",,"PA")	 // Tipo de Produto Enviado ao SFA
Local cCpoTipo    := SuperGetMv("MV_SFCPOPR",,"B1_TIPO")
Local cB1bloq     := SuperGetMv("MV_SFB1BLQ",,"S")
Local cLista := ""
Local nRetSql 	  := 0
Local cFuncName  := ProcName()

DEFAULT cCpo     := ""
DEFAULT nOper    := 0

dbSelectArea("DA0")
dbSelectArea("DA1")
dbSelectArea("HTC")
dbSelectArea("HPR")
dbSelectArea("SB1")

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPDA0")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//| Cabec da tabela de precos                            |
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDadosCab,{"HTC_FILIAL" ,"DA0_FILIAL"})
		aadd(aDadosCab,{"HTC_TAB   " ,"DA0_CODTAB"})
		aadd(aDadosCab,{"HTC_DESCRI" ,"DA0_DESCRI"})
		aadd(aDadosCab,{"HTC_COND  " ,"DA0_CONDPG"})
		If DA0->(FieldPos("DA0_DATATE")) > 0 .And. HTC->(FieldPos("HTC_DATATE")) > 0
			aadd(aDadosCab,{"HTC_DATATE" ,"DA0_DATATE"})
		EndIf
		If DA0->(FieldPos("DA0_HORATE")) > 0 .And. HTC->(FieldPos("HTC_HORATE")) > 0
			aadd(aDadosCab,{"HTC_HORATE" ,"DA0_HORATE"})
		EndIf
		If DA0->(FieldPos("DA0_DATDE")) > 0 .And. HTC->(FieldPos("HTC_DATADE")) > 0
			aadd(aDadosCab,{"HTC_DATADE" ,"DA0_DATDE"})
		EndIf
		If DA0->(FieldPos("DA0_HORADE")) > 0 .And. HTC->(FieldPos("HTC_HORADE")) > 0
			aadd(aDadosCab,{"HTC_HORADE" ,"DA0_HORADE"})
		EndIf
		If DA0->(FieldPos("DA0_TPHORA")) > 0 .And. HTC->(FieldPos("HTC_TPHORA")) > 0
			aadd(aDadosCab,{"HTC_TPHORA" ,"DA0_TPHORA"})
		EndIf
		
		If ExistBlock("HEXPDA0C")
			aDadosCab := ExecBlock("HEXPDA0C", .F., .F., {aDadosCab})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//|Itens da tabela de precos                             |
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDadosIte,{"HPR_FILIAL","DA1_FILIAL" })
	    aadd(aDadosIte,{"HPR_GRUPO ","B1_GRUPO"   })
		aadd(aDadosIte,{"HPR_PROD  ","DA1_CODPRO" })
		aadd(aDadosIte,{"HPR_TAB   ","DA1_CODTAB" })
		aadd(aDadosIte,{"HPR_ITEM  ","DA1_ITEM  " })	
		aadd(aDadosIte,{"HPR_UNI   ","DA1_PRCVEN" })
		If DA1->(FieldPos("DA1_QTDLOT")) > 0 .And. HPR->(FieldPos("HPR_QTDLOT")) > 0
			aadd(aDadosIte,{"HPR_QTDLOT","DA1_QTDLOT" })
		EndIf
		If DA1->(FieldPos("DA1_INDLOT")) > 0 .And. HPR->(FieldPos("HPR_INDLOT")) > 0
			aadd(aDadosIte,{"HPR_INDLOT","DA1_INDLOT" })
		EndIF	
		If DA1->(FieldPos("DA1_DESMAX")) > 0 .And. HPR->(FieldPos("HPR_DESMAX")) > 0
			aadd(aDadosIte,{"HPR_DESMAX ","DA1_DESMAX"})
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica os tipos validos                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cLista     := "'"
		cTpProduto := AllTrim(cTipProd) + ","
		nX       := At(",", cTpProduto)
		While nX > 0
			cLista   += Substr(cTpProduto, 1, nX - 1) + "','"
			cTpProduto := Substr(cTpProduto, nX + 1, Len(cTpProduto))
			nX := At(",", cTpProduto)
		EndDo
		cLista := Subs(cLista, 1, Len(cLista)-2)
		

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para filtro das tabelas de preГo
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPDA0A")
			aDadosIte := ExecBlock("HEXPDA0A", .F., .F., {aDadosIte})
		EndIf


		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Precos ( Cabecalho )          Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("DA0")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁCabecalho da Tabela de Preco  				         Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_DA0"+cID,.T.,!Empty(xFilial("DA0")),.T.)	

					dbSelectArea("DA0")

					cQuery := "FROM " +  RetSqlName("DA0") + " DA0 "
					cQuery += "WHERE DA0.DA0_FILIAL = '" + xFilial("DA0") + "' "
					cQuery += "AND DA0.DA0_ATIVO = '1' "
					cQuery += "AND (DA0.DA0_DATDE <= '" + DTOS(dDatabase) + "' OR DA0.DA0_DATDE = '' ) "
					cQuery += "AND (DA0.DA0_DATATE >= '" + DTOS(dDatabase) + "' OR DA0.DA0_DATATE = '' ) "
					cQuery += "AND DA0.D_E_L_E_T_ =' ' "
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para filtro das tabelas de preГo
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPDA0B")
						cQuery := ExecBlock("HEXPDA0B", .F., .F., {cQuery,cId})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "DA0.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HTC.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HTC")+" HTC "
					cNoQuery += "WHERE "
					cNoQuery += "HTC_FILIAL='"+xFilial("HTC")+"' AND "
					cNoQuery += "HTC_TAB = DA0.DA0_CODTAB AND "
					cNoQuery += "HTC.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HTC")
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HTC")	

						cUpdate := "FROM "+RetSqlName("DA0")+" DA0 "
						cUpdate += "WHERE "
						cUpdate += "DA0.DA0_FILIAL='" + xFilial("DA0") + "' AND "
						cUpdate += "DA0.D_E_L_E_T_ = ' ' AND "
						cUpdate += "HTC_FILIAL='" + xFilial("HTC") + "' AND "
						cUpdate += "HTC_TAB = DA0.DA0_CODTAB AND "
						cUpdate += "("
						For nX := 1 To Len(aDadosCab)-1
							cUpdate += aDadosCab[nX][1]+" <> "+aDadosCab[nX][2]+" OR "
						Next nX
						cUpdate += aDadosCab[nX][1]+" <> "+aDadosCab[nX][2]+" OR "
						cUpdate += " DA0.DA0_DATATE < '"+DtoS(dDataBase)+"') "
					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDadosCab)
						cSelect += aDadosCab[nX][2]+","
					Next nX
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HTC")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HTC")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					
					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					                              			
					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HTC")+" "
					cInsert += "("
					For nX := 1 To Len(aDadosCab)
						cInsert += aDadosCab[nX][1]+","	
					Next nX
					cInsert += "HTC_INTR,"
					cInsert += "HTC_VER,"
					cInsert += "HTC_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					If nOper == 0
						cInsert += " AND (DA0.DA0_DATATE = '' OR DA0.DA0_DATATE >= '" + DtoS(dDataBase) + "') "					
					EndIf
					cInsert += cNoQuery
					
					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HTC")+" "
						cDelUpd  += "SET HTC_INTR = 'E',HTC_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT DA0.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("DA0")+" DA0 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = DA0.R_E_C_N_O_ AND "
						cDelUpd  += "DA0.D_E_L_E_T_=' ' ) AND HTC_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf


						cDelUpd  := "UPDATE "+RetSqlName("HTC")+" "
						cDelUpd  += "SET HTC_INTR = 'E',HTC_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT DA0.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("DA0")+" DA0 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = DA0.R_E_C_N_O_ AND "
						cDelUpd  += "(DA0.DA0_DATATE = '' OR DA0.DA0_DATATE >= '" + DtoS(dDataBase) + "') AND "	
						cDelUpd  += "DA0.DA0_ATIVO = '1'  "
										
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁPonto de Entrada para filtro das tabelas de preГo
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If ExistBlock("HEXPDA0E")
							cDelUpd := ExecBlock("HEXPDA0E", .F., .F., {cDelUpd})
						EndIf
						
						cDelUpd  += " ) AND HTC_INTR <> 'E'"
						
						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
                        
						cDelUpd  := "UPDATE "+RetSqlName("HPR")+" "
						cDelUpd  += "SET HPR_INTR = 'E',HPR_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "HPR_FILIAL='"+xFilial("HPR")+"' AND "
						cDelUpd  += "HPR_TAB IN ( "
						cDelUpd  += "SELECT DA0.DA0_CODTAB "
						cDelUpd  += "FROM "+RetSqlName("DA0")+" DA0 "
						cDelUpd  += "WHERE "
						cDelUpd  += "DA0.DA0_FILIAL='"+xFilial("DA0")+"' AND "
						cDelUpd  += "NOT ((DA0.DA0_DATATE = '' OR DA0.DA0_DATATE >= '" + DtoS(dDataBase) + "' ) AND "
						cDelUpd  += "DA0.DA0_ATIVO = '1' )) AND HPR_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-5): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

					EndIf
					UnLockByName("HHEXP_DA0"+cID,.T.,!Empty(xFilial("DA0")),.T.)	
				EndIf
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Precos ( ITENS )              Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea("DA1")
				dbSetOrder(1)
				cId := HHCheckID("HPR","DA1")
				If LockByName("HHEXP_DA1"+cID,.T.,!Empty(xFilial("DA1")),.T.)	

					cQuery := "FROM " +  RetSqlName("DA1") + " DA1,"
					cQuery += RetSqlName("SB1") + " SB1 "
					cQuery += "WHERE DA1.DA1_FILIAL = '" + xFilial("DA1") + "' AND "
					cQuery += "DA1.D_E_L_E_T_ =' ' AND "
					cQuery += "SB1.B1_FILIAL = '" + xFilial("SB1") + "' AND "
					cQuery += "SB1.B1_COD = DA1.DA1_CODPRO AND "
					cQuery += "SB1." + cCpoTipo +" IN (" + cLista + ") AND "
					If cB1bloq == "N"
						cQuery += "SB1.B1_MSBLQL = '2' AND "
					EndIf
					cQuery += "SB1.D_E_L_E_T_ =' ' "
   					
					If ExistBlock("HEXPDA0D")
						cQuery := ExecBlock("HEXPDA0D", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "DA1.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HPR.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HPR")+" HPR "
					cNoQuery += "WHERE "
					cNoQuery += "HPR.HPR_FILIAL='"+xFilial("HPR")+"' AND "
					cNoQuery += "HPR_TAB = DA1.DA1_CODTAB AND "
					cNoQuery += "HPR.D_E_L_E_T_ = ' ' AND HPR_INTR <> 'E') "

					If nOper <> 0
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HPR",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HPR")	

						cUpdate := "FROM "+RetSqlName("DA1")+" DA1,"
						cUpdate += RetSqlName("SB1")+" SB1 "
						cUpdate += "WHERE "
						cUpdate += "DA1.DA1_FILIAL='" + xFilial("DA1") + "' AND "
						cUpdate += "DA1.D_E_L_E_T_ = ' ' AND "
						cUpdate += "SB1.B1_FILIAL = '" + xFilial("SB1") + "' AND "
						cUpdate += "SB1.B1_COD = DA1.DA1_CODPRO AND "
						cUpdate += "SB1.D_E_L_E_T_ =' ' AND "
						cUpdate += "HPR_FILIAL='" + xFilial("HPR") + "' AND "
						cUpdate += "HPR_TAB = DA1.DA1_CODTAB AND "
						//cUpdate += "HPR_ITEM = DA1.DA1_ITEM AND " 
						cUpdate += "("
						For nX := 1 To Len(aDadosIte)
							cUpdate += aDadosIte[nX][1]+" <> "+aDadosIte[nX][2]+" OR "
						Next nX
						cUpdate += " HPR_INTR ='E') "
					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDadosIte)
						cSelect += aDadosIte[nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "DA1.R_E_C_N_O_ "

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁCalcula a faixa de registro para proteger o log do SBGD  Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cMaxQry := "SELECT HTC_TAB "
					cMaxQry += "FROM "+RetSqlName("HTC")+" "
					cMaxQry += "WHERE HTC_FILIAL='"+xFilial("HTC")+"' AND "
					cMaxQry += "D_E_L_E_T_=' ' AND HTC_INTR <> 'E'"

					cMaxQry   := ChangeQuery(cMaxQry)
					cMaxAlias := GetNextAlias()

					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cMaxQry),cMaxAlias)
					dbSelectArea(cMaxAlias)

					While !Eof()

						If nOper == 0
							cDelete := "DELETE "
							cDelete += "FROM "+RetSqlName("HPR")+" "
							cDelete += "WHERE "
							cDelete += "R_E_C_N_O_ IN ("
							cDelete += "SELECT DA1.R_E_C_N_O_ "
							cDelete += cQuery
							cDelete += " AND DA1.DA1_CODTAB='"+(cMaxAlias)->HTC_TAB+"' "
							cDelete += ")"
						Else
							cDelete := "DELETE "
							cDelete += "FROM "+RetSqlName("HPR")+" "
							cDelete += "WHERE "
							cDelete += "R_E_C_N_O_ IN ("
							cDelete += "SELECT DA1.R_E_C_N_O_ "
							cDelete += cUpdate
							cDelete += " AND DA1.DA1_CODTAB='"+(cMaxAlias)->HTC_TAB+"' "
							cDelete += ")"						
						EndIf

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelete)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-6): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
						
						cInsert := "INSERT INTO "
						cInsert += RetSqlName("HPR")+" "
						cInsert += "("
						For nX := 1 To Len(aDadosIte)
							cInsert += aDadosIte[nX][1]+","	
						Next nX
						cInsert += "HPR_INTR,"
						cInsert += "HPR_VER,"
						cInsert += "HPR_ID,"
						cInsert += "R_E_C_N_O_"
						cInsert += ") "
						cInsert += cSelect
						cInsert += cQuery
						cInsert += " AND DA1.DA1_CODTAB='"+(cMaxAlias)->HTC_TAB+"' "
						If nOper <> 0
							cInsert += cNoQuery
						EndIf
						
						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cInsert)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-7): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If nOper <> 0
							cDelUpd  := "UPDATE "+RetSqlName("HPR")+" "
							cDelUpd  += "SET HPR_INTR = 'E',HPR_VER="+Str(nVersao,10)+" "
							cDelUpd  += "WHERE "
							cDelUpd  += "R_E_C_N_O_ NOT IN ("
							cDelUpd  += "SELECT DA1.R_E_C_N_O_ "
							cDelUpd  += "FROM "+RetSqlName("DA1")+" DA1 "
							cDelUpd  += "WHERE "
							cDelUpd  += "R_E_C_N_O_ = DA1.R_E_C_N_O_ AND "
							cDelUpd  += "DA1.D_E_L_E_T_=' ' ) AND HPR_INTR <> 'E' "

							__HHLogTime := PText2Sec(Time())
							nRetSql := 	TcSqlExec(cDelUpd)
		
							If __HHLog >= 1
								__HHLogMsg := STR0002 + cFuncName + "-8): " + KB_ENTER
								__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
								If nRetSql != 0 .And. __HHLog == 9
									__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
								EndIf
								__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
								GravaHHLog(__HHLogMsg)
							EndIf
						EndIf

						dbSelectArea(cMaxAlias)
						dbSkip()
					EndDo
					dbSelectArea(cMaxAlias)
					dbCloseArea()
					dbSelectArea("HPR")
					Begin Transaction				
						HHExcGenDel("HPR")
						HHUpdCtr(cID,"HPR")
						HHExcGenDel("HTC")
						HHUpdCtr(cID,"HTC")				
					End Transaction				
					UnLockByName("HHEXP_DA1"+cID,.T.,!Empty(xFilial("DA1")),.T.)		
				EndIf
			Else
		#ENDIF
			If "DA0"$cCpo .Or. Empty(cCpo)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁCabecalho da Tabela de Preco  				         Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				cQuery := "(DTOS(DA0_DATATE) == '"+Dtos(Ctod(""))+"' .OR. Dtos(DA0_DATATE) > '" + DtoS(dDataBase) + "') .And."
				cQuery += "DA0_ATIVO = '1' "
				If nOper == 0
					dbSelectArea("DA0")
					MsSeek(xFilial("DA0"))
					While !DA0->(Eof()) .And. DA0->DA0_FILIAL == xFilial("DA0")
						If DA0->(&(cQuery))
							dbSelectArea("HTC")
							dbSetOrder(1)
							If !dbSeek(xFilial("HTC") + cId + DA0->DA0_CODTAB)
								RecLock("HTC", .T.)
							Else
								RecLock("HTC", .F.)
							EndIf
							HTC->HTC_FILIAL := xFilial("HTC")
							HTC->HTC_ID     := cID
							For nX := 1 To Len(aDadosCab)
								HTC->(FieldPut(HTC->(FieldPos(aDadosCab[nX][1])),DA0->(FieldGet(FieldPos(aDadosCab[nX][2])))))
							Next nX
							HTC->HTC_INTR   := cIntr
							HTC->HTC_VER    := nVersao
							HTC->(MsUnlock())
						EndIf
						dbSelectArea("DA0")
						DA0->(dbSkip())
					EndDo			
				Else
					If DA0->(&(cQuery))
						dbSelectArea("HTC")
						dbSetOrder(1)
						If !dbSeek(xFilial("HTC") + cId + DA0->DA0_CODTAB)
							RecLock("HTC", .T.)
						Else
							RecLock("HTC", .F.)
						EndIf
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HTC",HTC->(Found()))
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						If nOper <> 0
							nVersao := HHNextVer(cID,"HTC")	
						EndIf
						HTC->HTC_FILIAL := xFilial("HTC")
						HTC->HTC_ID     := cID
						For nX := 1 To Len(aDadosCab)
							HTC->(FieldPut(HTC->(FieldPos(aDadosCab[nX][1])),DA0->(FieldGet(FieldPos(aDadosCab[nX][2])))))
						Next nX
						HTC->HTC_INTR   := cIntr
						HTC->HTC_VER    := nVersao
						HTC->(MsUnlock())
					EndIf
				EndIf
				HHUpdCtr(cID,"HTC")	
			EndIf
			If "DA1"$cCpo .Or. Empty(cCpo)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁCabecalho da Tabela de Preco  				         Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды		
				If nOper == 0
					dbSelectArea("DA1")
					MsSeek(xFilial("DA1"))
					While !DA1->(Eof()) .And. DA1->DA1_FILIAL == xFilial("DA1")
						dbSelectArea("HTC")
						dbSetOrder(1)
						If MsSeek(xFilial("HTC") + cId + DA1->DA1_CODTAB)
							dbSelectArea("HPR")
							dbSetOrder(1)
							If !dbSeek(xFilial("HPR") + cId + DA1->DA1_CODPRO + DA1->DA1_CODTAB + DA1->DA1_INDLOT + DA1->DA1_ITEM)
								RecLock("HPR", .T.)
							Else
								RecLock("HPR", .F.)
							EndIf
							HPR->HPR_FILIAL := xFilial("HPR")
							HPR->HPR_ID     := cID
							For nX := 1 To Len(aDadosIte)
								HPR->(FieldPut(HPR->(FieldPos(aDadosIte[nX][1])),(Iif(At("_",aDadosIte[nX][2])==4,"","S")+IiF( Substr(aDadosIte[nX][2],1,3)=="DA1","DA1",Substr(aDadosIte[nX][2],1,At("_",aDadosIte[nX][2])-1) ))->(FieldGet(FieldPos(aDadosIte[nX][2])))))
							Next nX
							HPR->HPR_INTR   := cIntr
							HPR->HPR_VER    := nVersao
							HPR->(MsUnlock())
						EndIf
						dbSelectArea("DA1")
						dbSkip()
					EndDo
				Else
					dbSelectArea("HTC")
					dbSetOrder(1)
					If MsSeek(xFilial("HTC") + cId + DA1->DA1_CODTAB)
						dbSelectArea("HPR")
						dbSetOrder(1)
						If !dbSeek(xFilial("HPR") + cId + DA1->DA1_CODTAB)
							RecLock("HPR", .T.)
						Else
							RecLock("HPR", .F.)
						EndIf
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HPR",HPR->(Found()))
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						If nOper <> 0
							nVersao := HHNextVer(cID,"HPR")	
						EndIf
						HPR->HPR_FILIAL := xFilial("HPR")
						HPR->HPR_ID     := cID					
						For nX := 1 To Len(aDadosIte)
							HPR->(FieldPut(HPR->(FieldPos(aDadosIte[nX][1])),DA0->(FieldGet(FieldPos(aDadosIte[nX][2])))))
						Next nX
						HPR->HPR_INTR   := cIntr
						HPR->HPR_VER    := nVersao
						HPR->(MsUnlock())
					EndIf
				EndIf
				HHUpdCtr(cID,"HPR")	
			EndIf		
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPDA0")==0
		aadd(aJobGlobal,"HHEXPDA0")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf

// Ponto de Entrada no Final dos Procedimentos de GravaГЦo do HTC e HPR
If ExistBlock("HEXPDA0F")
	ExecBlock("HEXPDA0F", .F., .F.)
EndIf

RestArea(aAreaDA1)
RestArea(aAreaDA0)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPDA1  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - DA1                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPDA1(cCpo,nOper)

DEFAULT cCpo    := ""
DEFAULT nOper   := 0

Return HHEXPDA0(cCpo,nOper)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSB2  Ё Autor ЁEduardo Riera          Ё Data Ё14.12.05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - HB2                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSB2(cCpo,nOper)

Local aArea     := GetArea()
Local aAreaSB1  := SB1->(GetArea())
Local aAreaSB2  := SB2->(GetArea())
Local aDados    := {}
Local cID       := HHCheckID("HB2","SB2")
Local nX        := 1
Local cIntr     := "I"
Local nVersao   := 1
#IFDEF TOP
	Local cDelete   := ""
	Local cInsert   := ""
	Local cNoQuery  := ""
	Local cQuery    := ""
	Local cSelect   := ""
	Local cUpdate   := ""
	Local cDelUpd   := ""
#ENDIF
Local aJobGlobal := {}
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql    := 0
Local cFuncName  := ProcName()

DEFAULT cCpo     := ""
DEFAULT nOper    := 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSB2")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabela         Ё
		//| ESTOQUES HB2                                         |
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDados,{"HB2_FILIAL" ,"B2_FILIAL"})
		aadd(aDados,{"HB2_COD   " ,"B2_COD"})
		aadd(aDados,{"HB2_LOCAL " ,"B2_LOCAL"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSB2A")
			aDados := ExecBlock("HEXPSB2A", .F., .F., {aDados})
		EndIf
		
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Estoques ( HB2 )              Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea("SB2")
				dbSetOrder(1)
				If LockByName("HHEXP_HB2"+cID,.T.,!Empty(xFilial("SB2")),.T.)	
					dbSelectArea("SB2")
					cQuery := "FROM " +  RetSqlName("SB2") + " SB2, "
					cQuery += RetSqlName("HB1") + " HB1 "
					cQuery += "WHERE "
					cQuery += "SB2.B2_FILIAL = '" + xFilial("SB2") + "' AND "
					cQuery += "SB2.D_E_L_E_T_ =' ' AND "
					cQuery += "HB1.HB1_FILIAL = '" + xFilial("HB1") + "' AND "
					cQuery += "HB1.HB1_COD = SB2.B2_COD AND "
					If GetNewPar("MV_PLLCEST","T") <> "T"
						cQuery += "HB1.HB1_LOCPAD = SB2.B2_LOCAL AND "
					EndIf					
					cQuery += "HB1.D_E_L_E_T_ =' ' "
               
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSB2B")
						cQuery := ExecBlock("HEXPSB2B", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "SB2.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HB2.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HB2")+" HB2 "
					cNoQuery += "WHERE "
					cNoQuery += "HB2.HB2_FILIAL='"+xFilial("HB2")+"' AND "
					cNoQuery += "HB2.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HB2",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HB2")	

						cUpdate := "FROM "+RetSqlName("SB2")+" SB2 "
						cUpdate += "WHERE "
						cUpdate += "SB2.B2_FILIAL='" + xFilial("SB2") + "' AND "
						cUpdate += "SB2.D_E_L_E_T_ = ' ' AND "
						cUpdate += "HB2_FILIAL='" + xFilial("HB2") + "' AND "
						cUpdate += "HB2_COD = SB2.B2_COD AND "
						cUpdate += "HB2_LOCAL = SB2.B2_LOCAL AND "
						cUpdate += "("
						For nX := 1 To Len(aDados)
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += "HB2_QTD <> (SB2.B2_QATU-SB2.B2_RESERVA-SB2.B2_QACLASS-SB2.B2_QEMPSA) ) "
					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX
					cSelect += "'"+DTOS(dDataBase)+"'," 	//  data da geracao do estoque
					cSelect += "(B2_QATU-B2_RESERVA-B2_QACLASS-B2_QEMPSA)," //	Saldo do SB2
					cSelect += "'"+cIntr+"',"			
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "SB2.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HB2")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SB2.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HB2")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SB2.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf


					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HB2")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HB2_DATA,"
					cInsert += "HB2_QTD,"
					cInsert += "HB2_INTR,"
					cInsert += "HB2_VER,"
					cInsert += "HB2_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HB2")+" "
						cDelUpd  += "SET HB2_INTR = 'E',HB2_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SB2.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SB2")+" SB2 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SB2.R_E_C_N_O_ AND "
						cDelUpd  += "SB2.D_E_L_E_T_=' ' ) AND HB2_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf
					Begin Transaction
						HHExcGenDel("HB2")
						HHUpdCtr(cID,"HB2")
					End Transaction
					UnLockByName("HHEXP_SB2"+cID,.T.,!Empty(xFilial("SB2")),.T.)	
				EndIf
			Else
		#ENDIF
			If nOper == 0
				dbSelectArea("SB2")
				dbSetOrder(1)
				MsSeek(xFilial("SB2"))
				While !SB2->(Eof())  .And. xFilial("SB2") == SB2->B2_FILIAL
					dbSelectArea("SB1")
					dbSetOrder(1)
					MsSeek(xFilial("SB1")+SB2->B2_COD)
					If GetNewPar("MV_PLLCEST","T") ==  "T" .Or. SB1->B1_LOCPAD == SB2->B2_LOCAL
						Begin Transaction 		
							dbSelectArea("HB2")
							dbSetOrder(1)
							If !MsSeek(SB2->B2_FILIAL + cID + SB2->B2_COD + SB2->B2_LOCAL)
								RecLock("HB2", .T.)
							Else
								RecLock("HB2", .F.)
							EndIf
							HB2->HB2_FILIAL := SB2->B2_FILIAL
							HB2->HB2_ID     := cId
							For nX := 1 To Len(aDados)
								HB2->(FieldPut(HB2->(FieldPos(aDados[nX][1])),SB2->(FieldGet(FieldPos(aDados[nX][2])))))
							Next nX
							HB2->HB2_QTD     := SaldoSb2()
							HB2->HB2_INTR   := cIntr
							HB2->HB2_VER    := nVersao
						End Transaction
					EndIf
					dbSelectArea("SB2")
					dbSkip()
				EndDo
			Else
				Begin Transaction
					dbSelectArea("SB1")
					dbSetOrder(1)
					MsSeek(xFilial("SB1")+SB2->B2_COD)
					If GetNewPar("MV_PLLCEST","T") ==  "T" .Or. SB1->B1_LOCPAD == SB2->B2_LOCAL			
						dbSelectArea("HB2")
						dbSetOrder(1)
						If !MsSeek(SB2->B2_FILIAL + cID + SB2->B2_COD + SB2->B2_LOCAL )
							RecLock("HB2", .T.)
						Else
							RecLock("HB2", .F.)
						EndIf
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HB2",HB2->(Found()))
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						If nOper <> 0
							nVersao := HHNextVer(cID,"HB2")	
						EndIf						
						HB2->HB2_FILIAL := SB2->B2_FILIAL
						HB2->HB2_ID     := cId
						For nX := 1 To Len(aDados)
							HB2->(FieldPut(HB2->(FieldPos(aDados[nX][1])),SB2->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HB2->HB2_INTR   := cIntr
						HB2->HB2_VER    := nVersao
					EndIf
				End Transaction
			EndIf
			HHUpdCtr(cID,"HB2")
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSB2")==0
		aadd(aJobGlobal,"HHEXPSB2")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁPonto de Entrada no final do processo de exportacao do SB2Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock("HEXPSB2C")
	ExecBlock("HEXPSB2C", .F., .F.)
EndIf
RestArea(aAreaSB2)
RestArea(aAreaSB1)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSE4  Ё Autor ЁEduardo Riera          Ё Data Ё10.12.2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SE4                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSE4(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSE4    := SE4->(GetArea())
Local cId         := HHCheckID("HE4","SE4")
Local nX          := 0
Local aDados      := {}
Local cIntr   := "I"
Local nVersao := 1
#IFDEF TOP
	Local cDelUpd     := ""
	Local cDelete   := ""
	Local cInsert   := ""
	Local cNoQuery  := ""
	Local cQuery    := ""
	Local cSelect   := ""
	Local cUpdate   := ""
#ENDIF
Local aJobGlobal := {}
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql    := 0
Local cFuncName  := ProcName()

DEFAULT cCpo  	  := ""
DEFAULT nOper 	  := 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSE4")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0

	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		aadd(aDados,{"HE4_FILIAL ","E4_FILIAL"})
		aadd(aDados,{"HE4_CODIGO ","E4_CODIGO"})
		aadd(aDados,{"HE4_DESCRI ","E4_DESCRI"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSE4A")
			aDados := ExecBlock("HEXPSE4A", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de grupo de produtos.            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SE4")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de grupo de produtos.            Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SE4"+cID,.T.,!Empty(xFilial("HE4")),.T.)	
					cQuery := "FROM " + RetSqlName("SE4") + " SE4 "
					cQuery += "WHERE "
					cQuery += "SE4.E4_FILIAL='" + xFilial("SE4") + "' AND "
					cQuery += "SE4.D_E_L_E_T_ = ' ' "
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para alteraГЦo dos Campos para exportaГЦo/ImportaГЦo da tabela de clientes   Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSE4B")
						cQuery := ExecBlock("HEXPSE4B", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "SE4.R_E_C_N_O_ NOT IN  ("
					cNoQuery += "SELECT HE4.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HE4")+" HE4 "
					cNoQuery += "WHERE "
					cNoQuery += "HE4.HE4_FILIAL='" + xFilial("HE4") + "' AND "
					cNoQuery += "HE4.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HE4",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HE4")	

						cUpdate := "FROM "+RetSqlName("SE4")+" SE4 "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = SE4.R_E_C_N_O_ AND "
						cUpdate += "("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "				

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HE4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HE4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf				

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HE4")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HE4_INTR,"
					cInsert += "HE4_VER,"
					cInsert += "HE4_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "

					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HE4")+" "
						cDelUpd  += "SET HE4_INTR = 'E',HE4_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SE4.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SE4")+" SE4 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SE4.R_E_C_N_O_ AND "
						cDelUpd  += "SE4.D_E_L_E_T_=' '  "
						
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁPonto de Entrada para alteraГЦo dos Campos para exportaГЦo/ImportaГЦo da tabela de clientes   Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						If ExistBlock("HEXPSE4C")
							cDelUpd := ExecBlock("HEXPSE4C", .F., .F., {cDelUpd})
						EndIf                                             
						
						cDelUpd  += " ) AND HE4_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf

					Begin Transaction
						HHExcGenDel("HE4")
						HHUpdCtr(cID,"HE4")	
					End Transaction
					UnLockByName("HHEXP_SE4"+cID,.T.,!Empty(xFilial("HE4")),.T.)	
				EndIf				
			Else
		#ENDIF
			If nOper == 0
				dbSelectArea("SE4")
				MsSeek(xFilial("SE4"))
				While !SE4->(Eof())  .And. xFilial("SE4") == SE4->E4_FILIAL
					Begin Transaction
						dbSelectArea("HE4")
						dbSetOrder(1)
						If !MsSeek(SE4->E4_FILIAL + cID + SE4->E4_CODIGO)
							RecLock("HE4", .T.)
						Else
							RecLock("HE4", .F.)
						EndIf
						HE4->HE4_FILIAL := SE4->E4_FILIAL
						HE4->HE4_ID     := cId
						For nX := 1 To Len(aDados)
							HE4->(FieldPut(HE4->(FieldPos(aDados[nX][1])),SE4->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HE4->HE4_INTR   := cIntr
						HE4->HE4_VER    := nVersao
					End Transaction
					dbSelectArea("SE4")
					dbSkip()
				EndDo
			Else
				Begin Transaction
					dbSelectArea("HE4")
					dbSetOrder(1)
					If !MsSeek(SE4->E4_FILIAL + cID + SE4->E4_CODIGO)
						RecLock("HE4", .T.)
					Else
						RecLock("HE4", .F.)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HE4",HE4->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					If nOper <> 0
						nVersao := HHNextVer(cID,"HE4")	
					EndIf						
					HE4->HE4_FILIAL := SE4->E4_FILIAL
					HE4->HE4_ID     := cId
					For nX := 1 To Len(aDados)
						HE4->(FieldPut(HE4->(FieldPos(aDados[nX][1])),SE4->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HE4->HE4_INTR   := cIntr
					HE4->HE4_VER    := nVersao
				End Transaction
			EndIf
			HHUpdCtr(cID,"HE4")
			#IFDEF TOP
			EndIf	
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSE4")==0
		aadd(aJobGlobal,"HHEXPSE4")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSE4)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSF4  Ё Autor ЁEduardo Riera          Ё Data Ё10.12.2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SF4                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSF4(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSF4    := SF4->(GetArea())
Local cId         := HHCheckID("HF4","SF4")
Local nX          := 0
Local aDados      := {}
Local cIntr   := "I"
Local nVersao := 1
#IFDEF TOP
	Local cInsert     := ""
	Local cDelete     := ""
	Local cSelect     := ""
	Local cUpdate     := ""
	Local cDelUpd     := ""
	Local cNoQuery    := ""
	Local cQuery      := ""
#ENDIF
Local aJobGlobal := {}
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql     := 0
Local cFuncName   := ProcName()

DEFAULT cCpo      := ""
DEFAULT nOper 	   := 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSF4")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0

	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		aadd(aDados,{"HF4_FILIAL ","F4_FILIAL"})
		aadd(aDados,{"HF4_CODIGO ","F4_CODIGO"})
		aadd(aDados,{"HF4_TEXTO  ","F4_TEXTO"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSF4A")
			aDados := ExecBlock("HEXPSF4A", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de grupo de produtos.            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SF4")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de grupo de produtos.            Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SF4"+cID,.T.,!Empty(xFilial("HF4")),.T.)	

					cQuery := "FROM " + RetSqlName("SF4") + " SF4 "
					cQuery += "WHERE "
					cQuery += "SF4.F4_FILIAL='" + xFilial("SF4") + "' AND "
					cQuery += "SF4.F4_CODIGO > '500' AND " // No SFA apenas os TES de saМda
					cQuery += "SF4.D_E_L_E_T_ = ' ' "
                                     
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSF4B")
						cQuery := ExecBlock("HEXPSF4B", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "SF4.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HF4.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HF4")+" HF4 "
					cNoQuery += "WHERE "
					cNoQuery += "HF4.HF4_FILIAL='" + xFilial("HF4") + "' AND "					
					//					cNoQuery += "HF4.R_E_C_N_O_ = SF4.R_E_C_N_O_ AND "
					cNoQuery += "HF4.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HF4",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HF4")	

						cUpdate := "FROM "+RetSqlName("SF4")+" SF4 "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = SF4.R_E_C_N_O_ AND  "
						cUpdate += "("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "				

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HF4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HF4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf				

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HF4")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HF4_INTR,"
					cInsert += "HF4_VER,"
					cInsert += "HF4_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "

					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deletados para atualizacao no hand held                       Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HF4")+" "
						cDelUpd  += "SET HF4_INTR = 'E',HF4_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SF4.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SF4")+" SF4 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SF4.R_E_C_N_O_ AND "
						cDelUpd  += "SF4.D_E_L_E_T_ = ' ' ) AND HF4_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf

					Begin Transaction
						HHExcGenDel("HF4")
						HHUpdCtr(cID,"HF4")	
					End Transaction
					UnLockByName("HHEXP_SF4"+cID,.T.,!Empty(xFilial("HF4")),.T.)
				EndIf				
			Else
		#ENDIF
			If nOper == 0
				dbSelectArea("SF4")
				MsSeek(xFilial("SF4"))
				While !SF4->(Eof())  .And. xFilial("SF4") == SF4->F4_FILIAL
					Begin Transaction
						dbSelectArea("HF4")
						dbSetOrder(1)
						If !MsSeek(SF4->F4_FILIAL + cID + SF4->F4_CODIGO)
							RecLock("HF4", .T.)
						Else
							RecLock("HF4", .F.)
						EndIf
						HF4->HF4_FILIAL := SF4->F4_FILIAL
						HF4->HF4_ID     := cId
						For nX := 1 To Len(aDados)
							HF4->(FieldPut(HF4->(FieldPos(aDados[nX][1])),SF4->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HF4->HF4_INTR   := cIntr
						HF4->HF4_VER    := nVersao
					End Transaction
					dbSelectArea("SF4")
					dbSkip()
				EndDo
			Else
				Begin Transaction
					dbSelectArea("HF4")
					dbSetOrder(1)
					If !MsSeek(SF4->F4_FILIAL + cID + SF4->F4_CODIGO)
						RecLock("HF4", .T.)
					Else
						RecLock("HF4", .F.)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HF4",HF4->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					If nOper <> 0
						nVersao := HHNextVer(cID,"HF4")	
					EndIf						
					HF4->HF4_FILIAL := SF4->F4_FILIAL
					HF4->HF4_ID     := cId
					For nX := 1 To Len(aDados)
						HF4->(FieldPut(HF4->(FieldPos(aDados[nX][1])),SF4->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HF4->HF4_INTR   := cIntr
					HF4->HF4_VER    := nVersao
				End Transaction
			EndIf
			HHUpdCtr(cID,"HF4")
			#IFDEF TOP
			EndIf	
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSF4")==0
		aadd(aJobGlobal,"HHEXPSF4")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSF4)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSA4  Ё Autor ЁEduardo Riera          Ё Data Ё10.12.2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SA4                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSA4(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSA4    := SA4->(GetArea())
Local cId         := HHCheckID("HA4","SA4")
Local nX          := 0
Local aDados      := {}
Local cIntr   := "I"
Local nVersao := 1
#IFDEF TOP
	Local cInsert     := ""
	Local cDelete     := ""
	Local cSelect     := ""
	Local cUpdate     := ""
	Local cDelUpd     := ""
	Local cNoQuery    := ""
	Local cQuery      := ""
#ENDIF
Local aJobGlobal := {}
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql     := 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSA4")==0 .Or. nOper <> 0 .Or. nStatusTrg == 0) .And. nOper >= 0

	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		aadd(aDados,{"HA4_FILIAL" ,"A4_FILIAL"})
		aadd(aDados,{"HA4_COD "   ,"A4_COD"})
		aadd(aDados,{"HA4_NOME"   ,"A4_NOME"}) 
		If SA4->(FieldPos("A4_CGC")) > 0 .And. HA4->(FieldPos("HA4_CGC")) > 0
		   aadd(aDados,{"HA4_CGC","A4_CGC"})
	    EndIf
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSA4A")
			aDados := ExecBlock("HEXPSA4A", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de grupo de produtos.            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SA4")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de grupo de produtos.            Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SA4"+cID,.T.,!Empty(xFilial("HA4")),.T.)	

					cQuery := "FROM " + RetSqlName("SA4") + " SA4 "
					cQuery += "WHERE "
					cQuery += "SA4.A4_FILIAL='" + xFilial("SA4") + "' AND "
					cQuery += "SA4.D_E_L_E_T_ = ' ' "

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSA4B")
						cQuery := ExecBlock("HEXPSA4B", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "SA4.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HA4.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HA4")+" HA4 "
					cNoQuery += "WHERE "
					cNoQuery += "HA4.HA4_FILIAL='" + xFilial("HA4") + "' AND "					
					cNoQuery += "HA4.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HA4",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HA4")	

						cUpdate := "FROM "+RetSqlName("SA4")+" SA4 "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = SA4.R_E_C_N_O_ AND  "
						cUpdate += "("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "R_E_C_N_O_ "				

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HA4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HA4")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf				

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HA4")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HA4_INTR,"
					cInsert += "HA4_VER,"
					cInsert += "HA4_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "

					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)

					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HA4")+" "
						cDelUpd  += "SET HA4_INTR = 'E',HA4_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SA4.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SA4")+" SA4 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SA4.R_E_C_N_O_ AND "
						cDelUpd  += "SA4.D_E_L_E_T_=' ' ) AND HA4_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
	
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf
					Begin Transaction
						HHExcGenDel("HA4")
						HHUpdCtr(cID,"HA4")	
					End Transaction		
					UnLockByName("HHEXP_SA4"+cID,.T.,!Empty(xFilial("HA4")),.T.)	
				EndIf				
			Else
		#ENDIF
			If nOper == 0
				dbSelectArea("SA4")
				dbSetOrder(1)
				MsSeek(xFilial("SA4"))
				While !SA4->(Eof())  .And. xFilial("SA4") == SA4->A4_FILIAL
					Begin Transaction
						dbSelectArea("HA4")
						dbSetOrder(1)
						If !MsSeek(SA4->HA4_FILIAL + cID + SA4->A4_COD)
							RecLock("HA4", .T.)
						Else
							RecLock("HA4", .F.)
						EndIf
						HA4->HA4_FILIAL := SA4->A4_FILIAL
						HA4->HA4_ID     := cId
						For nX := 1 To Len(aDados)
							HA4->(FieldPut(HA4->(FieldPos(aDados[nX][1])),SA4->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HA4->HA4_INTR   := cIntr
						HA4->HA4_VER    := nVersao
					End Transaction
					dbSelectArea("SA4")
					dbSkip()
				EndDo
			Else
				Begin Transaction
					dbSelectArea("HA4")
					dbSetOrder(1)
					If !MsSeek(SA4->A4_FILIAL + cID + SA4->A4_COD)
						RecLock("HA4", .T.)
					Else
						RecLock("HA4", .F.)
					EndIf
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HA4",HA4->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					If nOper <> 0
						nVersao := HHNextVer(cID,"HA4")	
					EndIf						
					HA4->HA4_FILIAL := SA4->A4_FILIAL
					HA4->HA4_ID     := cId
					For nX := 1 To Len(aDados)
						HA4->(FieldPut(HA4->(FieldPos(aDados[nX][1])),SA4->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HA4->HA4_INTR   := cIntr
					HA4->HA4_VER    := nVersao
				End Transaction
			EndIf
			HHUpdCtr(cID,"HA4")
			#IFDEF TOP
			EndIf	
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSA4")==0
		aadd(aJobGlobal,"HHEXPSA4")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSA4)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSC5  Ё Autor ЁEduardo Riera          Ё Data Ё10.12.2005Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SC5                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSC5(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSC5    := SC5->(GetArea())
Local aAreaSC6    := SC6->(GetArea())
Local cId         := HHCheckID("HC5","SC5")
Local nX          := 0
Local aDados      := {}
Local aDados1     := {}
Local cIntr       := "I"
Local nVersao     := 1
Local nQtdPed     := 0
Local cChave      := ""
Local cArqInd     := ""
Local cQuery      := ""
Local nDaysSC5	  := SuperGetMV("MV_SFDSC5",,180)
#IFDEF TOP
	Local cInsert     := ""
	Local cDelete     := ""
	Local cSelect     := ""
	Local cUpdate     := ""
	Local cNoQuery    := ""
	Local cCursor     := ""
	Local cQryCursor  := ""
#ENDIF
Local nRetSql	:= 0
Local cFuncName	:= ProcName()
Local lDelHC5X	:= SuperGetMv("MV_DELHC5X",,.T.) // Indica se os registros devem ser deletados do HC5/HC6 quando encontrado com status X (apos serem importados)

If !lDelHC5X
	If __HHLog >= 1
		__HHLogMsg := STR0005 + KB_ENTER
		GravaHHLog(__HHLogMsg)
	EndIf
	Conout(STR0005) // "Parametro MV_DELHC5X configrado para .F."
EndIf

DEFAULT cCpo        := ""
DEFAULT nOper       := 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0
	aadd(aDados,{"HC5_FILIAL" ,"C5_FILIAL"})
	aadd(aDados,{"HC5_COTAC " ,"C5_NUM"})
	aadd(aDados,{"HC5_CLI"    ,"C5_CLIENTE"})
	aadd(aDados,{"HC5_LOJA"   ,"C5_LOJACLI"})
	aadd(aDados,{"HC5_TRANSP" ,"C5_TRANSP"})
	aadd(aDados,{"HC5_TIPO"   ,"C5_TIPO"})
	aadd(aDados,{"HC5_COND"   ,"C5_CONDPAG"})
	//aadd(aDados,{"HC5_VEND1"  ,"C5_VEND1"})	
	aadd(aDados,{"HC5_MENOTA" ,"C5_MENNOTA"})
	aadd(aDados,{"HC5_EMISS"  ,"C5_EMISSAO"})
	aadd(aDados,{"HC5_TAB"    ,"C5_TABELA"})
	aadd(aDados,{"HC5_TIPOCL" ,"C5_TIPOCLI"})
	aadd(aDados,{"HC5_TPFRET" ,"C5_TPFRETE"})
	aadd(aDados,{"HC5_NUM"    ,"C5_NUM"})

	aadd(aDados1,{"HC6_FILIAL","C6_FILIAL"})
	aadd(aDados1,{"HC6_COTAC" ,"C6_NUM"})
	aadd(aDados1,{"HC6_NUM"   ,"C6_NUM"})
	aadd(aDados1,{"HC6_ITEM"  ,"C6_ITEM"})
	aadd(aDados1,{"HC6_PROD"  ,"C6_PRODUTO"})
	aadd(aDados1,{"HC6_QTDVEN","C6_QTDVEN"})	
	aadd(aDados1,{"HC6_PRCVEN","C6_PRCVEN"})	
	aadd(aDados1,{"HC6_VALOR" ,"C6_VALOR"})
	aadd(aDados1,{"HC6_QTDLIB","C6_QTDEMP"})
	aadd(aDados1,{"HC6_ENTREG","C6_ENTREG"})
	aadd(aDados1,{"HC6_UM"    ,"C6_UM"})
	aadd(aDados1,{"HC6_TES"   ,"C6_TES"})
	aadd(aDados1,{"HC6_LOCAL" ,"C6_LOCAL"})	
	aadd(aDados1,{"HC6_QTDENT","C6_QTDENT"})	
	aadd(aDados1,{"HC6_DESC"  ,"C6_DESCONT"})	
	If SC6->(FieldPos("C6_PRUNIT")) > 0 .And. HC6->(FieldPos("HC6_PRUNIT")) > 0
		aadd(aDados1,{"HC6_PRUNIT","C6_PRUNIT"})
	EndIf
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para inclusao de campos no servico    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSC5A")
		aDados := ExecBlock("HEXPSC5A", .F., .F., {aDados})
	EndIf
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para inclusao de campos no servico    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSC6A")
		aDados1 := ExecBlock("HEXPSC6A", .F., .F., {aDados1})
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁExportaГЦo da tabela de pedidos de venda              Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SC5")
	dbSetOrder(1)
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			If LockByName("HHEXP_SC5"+cID,.T.,!Empty(xFilial("HC5")),.T.)	
				cQuery := "FROM " + RetSqlName("SC5") + " SC5,"+ RetSqlName("SA1") + " SA1 "
				cQuery += "WHERE "
				cQuery += "SC5.C5_FILIAL='" + xFilial("SC5") + "' AND "
				cQuery += "SC5.C5_EMISSAO>='"+Dtos(dDatabase-nDaysSC5)+"' AND "
				cQuery += "SA1.A1_FILIAL='" + xFilial("SA1") + "' AND "
				cQuery += "SA1.A1_VEND = '" + cId + "' AND "
				cQuery += "SC5.C5_CLIENTE = SA1.A1_COD AND "
				cQuery += "SC5.C5_LOJACLI = SA1.A1_LOJA AND "
				cQuery += "SC5.D_E_L_E_T_ = ' ' "
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSC5B")
					cQuery := ExecBlock("HEXPSC5B", .F., .F., {cQuery})
				EndIf

				If nOper <> 0

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HC5",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HC5")	

				EndIf

				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX
				cSelect += "'"+cId+"',"
				cSelect += "'P',"
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "SC5.R_E_C_N_O_ SC5RECNO "

				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HC5")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT SC5.R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ") AND "
					cDelete += "HC5_STATUS NOT IN ('N','A') AND "
					cDelete += "HC5_INTR <> 'N' "

				Else

					cDelete := "UPDATE "
					cDelete += RetSqlName("HC5")+" "
					cDelete += "SET HC5_INTR = 'E',HC5_VER="+Str(nVersao,10)+" "
					cDelete += "WHERE "
					cDelete += "HC5_FILIAL='"+xFilial("HC5")+"' AND "
					cDelete += "HC5_ID='"+cID+"' AND "
					cDelete += "HC5_STATUS NOT IN ('N','A') AND "
					cDelete += "HC5_INTR <> 'N' "

				EndIf				

				__HHLogTime := PText2Sec(Time())
				If lDelHC5X .Or. nOper > 0
					nRetSql := 	TcSqlExec(cDelete)
				EndIf

				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				cNoQuery := " AND "
				cNoQuery += "SC5.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HC5.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HC5")+" HC5 "
				cNoQuery += "WHERE "
				cNoQuery += "HC5.R_E_C_N_O_ = SC5.R_E_C_N_O_ AND "
				cNoQuery += "HC5.D_E_L_E_T_=' ' ) "

				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HC5")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","	
				Next nX
				cInsert += "HC5_VEND1,"
				cInsert += "HC5_STATUS,"
				cInsert += "HC5_INTR,"
				cInsert += "HC5_VER,"
				cInsert += "HC5_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery
				
				cQryCursor := cSelect
				cQryCursor += cQuery
				cQryCursor += "ORDER BY C5_FILIAL,C5_CLIENTE,C5_LOJACLI,SC5.R_E_C_N_O_ DESC "

				cQryCursor := ChangeQuery(cQryCursor)

				cCursor    := GetNextAlias()

				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQryCursor),cCursor)

				__HHLogTime := PText2Sec(Time())
				
				While !Eof()
					nQtdPed	++
					If nQtdPed <= SuperGetMv("MV_QTPEDPM",,1)
						TcSqlExec("DELETE FROM "+RetSqlName("HC5")+" WHERE R_E_C_N_O_="+Str((cCursor)->SC5RECNO,18) + " AND HC5_INTR <> 'N' ")
						TcSqlExec(cInsert+" AND SC5.R_E_C_N_O_="+Str((cCursor)->SC5RECNO,18))
						
					EndIf

					cChave := (cCursor)->C5_FILIAL+(cCursor)->C5_CLIENTE+(cCursor)->C5_LOJACLI

					dbSelectArea(cCursor)
					dbSkip()

					If cChave <> (cCursor)->C5_FILIAL+(cCursor)->C5_CLIENTE+(cCursor)->C5_LOJACLI
						nQtdPed := 0
					EndIf
				EndDo
				dbSelectArea(cCursor)
				dbCloseArea()
				dbSelectArea("SC5")

				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cQryCursor + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
				
				cQuery := "FROM " + RetSqlName("SC6") + " SC6,"
				cQuery += RetSqlName("HC5") + " HC5, " + RetSqlName("SA1") + " SA1 "
				cQuery += "WHERE "
				cQuery += "HC5.HC5_FILIAL='" + xFilial("HC5") + "' AND "
				cQuery += "SA1.A1_FILIAL='" + xFilial("HA1") + "' AND "
				cQuery += "SA1.A1_VEND = '" + cId + "' AND "
				cQuery += "HC5.HC5_CLI = SA1.A1_COD AND "
				cQuery += "HC5.HC5_LOJA = SA1.A1_LOJA AND "
				cQuery += "HC5.HC5_VER="+Str(nVersao)+" AND "
				cQuery += "HC5.D_E_L_E_T_ = ' ' AND "
				
				cQuery += "SC6.C6_FILIAL='" + xFilial("SC6") + "' AND "
				cQuery += "SC6.C6_NUM=HC5.HC5_NUM AND "
				cQuery += "SC6.D_E_L_E_T_ = ' ' "

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSC6B")
					cQuery := ExecBlock("HEXPSC6B", .F., .F., {cQuery})
				EndIf

				cNoQuery := " AND "
				cNoQuery += "SC6.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HC6.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HC6")+" HC6 "
				cNoQuery += "WHERE "
				cNoQuery += "HC6.R_E_C_N_O_ = SC6.R_E_C_N_O_ AND "
				cNoQuery += "HC6.D_E_L_E_T_=' ' ) "

				cUpdate := "FROM "+RetSqlName("SC6")+" SC6 "
				cUpdate += "WHERE "
				cUpdate += "R_E_C_N_O_ = SC6.R_E_C_N_O_ AND  "
				cUpdate += "SC6.D_E_L_E_T_=' ' "
				If nOper <> 0
					cUpdate += " AND ("
					For nX := 1 To Len(aDados1)-1
						cUpdate += aDados1[nX][1]+" <> "+aDados1[nX][2]+" OR "
					Next nX
					cUpdate += aDados1[nX][1]+" <> "+aDados1[nX][2]+" ) "				
                EndIf
				cSelect := "SELECT "
				For nX := 1 To Len(aDados1)
					cSelect += aDados1[nX][2]+","
				Next nX
				cSelect += "HC5_STATUS,"
				cSelect += "HC5_INTR,"
				cSelect += "HC5_VER,"
				cSelect += "HC5_ID,"
				cSelect += "SC6.R_E_C_N_O_ "

				cQryCursor := "SELECT HC5_INTR,HC5_NUM "
				cQryCursor += "FROM "+RetSqlName("HC5")+" HC5 "
				cQryCursor += "WHERE HC5_FILIAL='"+xFilial("HC5")+"' AND "
				cQryCursor += "HC5_ID='"+cID+"' AND "
				cQryCursor += "HC5.HC5_VER="+Str(nVersao)+" AND "
				cQryCursor += "HC5_STATUS NOT IN ('N','A') AND "
				cQryCursor += "HC5.D_E_L_E_T_ = ' '  "

				cQryCursor := ChangeQuery(cQryCursor)
				cCursor    := GetNextAlias()
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQryCursor),cCursor)
				
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cQryCursor + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
				
				While !Eof()

					If (cCursor)->HC5_INTR <> 'E'
						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HC6")+" "
						cDelete += "WHERE HC6_FILIAL='"+xFilial("HC6")+"' AND "	
						cDelete += "HC6_NUM='"+(cCursor)->HC5_NUM+"' AND "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SC6.R_E_C_N_O_ "
						cDelete += cUpdate+" AND "
						cDelete += "C6_FILIAL='"+xFilial("HC6")+"' AND "
						cDelete += "C6_NUM='"+(cCursor)->HC5_NUM+"' "
						cDelete += ") AND HC6_STATUS NOT IN ('N','A') AND "
						cDelete += "HC6_INTR <> 'N' "

						__HHLogTime := PText2Sec(Time())
						If lDelHC5X
							nRetSql := 	TcSqlExec(cDelete)
						EndIf
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

						cInsert := "INSERT INTO "
						cInsert += RetSqlName("HC6")+" "
						cInsert += "("
						For nX := 1 To Len(aDados1)
							cInsert += aDados1[nX][1]+","	
						Next nX
						cInsert += "HC6_STATUS,"
						cInsert += "HC6_INTR,"
						cInsert += "HC6_VER,"
						cInsert += "HC6_ID,"
						cInsert += "R_E_C_N_O_"
						cInsert += ") "
						cInsert += cSelect
						cInsert += cQuery
						cInsert += "AND SC6.C6_NUM='"+(cCursor)->HC5_NUM+"' "
						cInsert += cNoQuery

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cInsert)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-5): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf


						cDelete := "UPDATE "
						cDelete += RetSqlName("HC6")+" "
						cDelete += "SET HC6_INTR = 'E',HC6_VER="+Str(nVersao,10)+" "
						cDelete += "WHERE "
						cDelete += "HC6_FILIAL='"+xFilial("HC6")+"' AND "
						cDelete += "HC6_NUM='"+(cCursor)->HC5_NUM+"' AND "
						cDelete += "HC6_ID='"+cID+"' AND "
						cDelete += "HC6_STATUS NOT IN ('N','A') AND "
						cDelete += "HC6_INTR <> 'N' AND "
						cDelete += "R_E_C_N_O_ NOT IN ("
						cDelete += "SELECT SC6.R_E_C_N_O_ "
						cDelete += "FROM "+RetSqlName("SC6")+" SC6 "
						cDelete += "WHERE "
						cDelete += "SC6.C6_FILIAL='"+xFilial("SC6")+"' AND "
						cDelete += "SC6.C6_NUM='"+(cCursor)->HC5_NUM+"' AND "
						cDelete += "R_E_C_N_O_ = SC6.R_E_C_N_O_ AND "
						cDelete += "SC6.D_E_L_E_T_=' ' ) "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelete)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-6): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					Else

						cDelete := "UPDATE "
						cDelete += RetSqlName("HC6")+" "
						cDelete += "SET HC6_INTR = 'E',HC6_VER="+Str(nVersao,10)+" "
						cDelete += "WHERE "
						cDelete += "HC6_FILIAL='"+xFilial("HC6")+"' AND "
						cDelete += "HC6_ID='"+cID+"' AND "
						cDelete += "HC6_STATUS NOT IN ('N','A') AND "
						cDelete += "HC6_INTR <> 'N' AND "
						cDelete += "HC6_NUM='"+(cCursor)->HC5_NUM+"' "
						
						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelete)
						
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-7): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf

					dbSelectArea(cCursor)
					dbSkip()
				EndDo
				dbSelectArea(cCursor)
				dbCloseArea()
				dbSelectArea("SC6")	

				Begin Transaction
 					HHComplHC5(cID)
					HHExcGenDel("HC5")
					HHUpdCtr(cID,"HC5")
					HHExcGenDel("HC6")
					HHUpdCtr(cID,"HC6")	
				End Transaction		
				UnLockByName("HHEXP_SC5"+cID,.T.,!Empty(xFilial("HC5")),.T.)
			EndIf
		Else
	#ENDIF
		If nOper <> 0
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁAnalisa a instrucao e versao do registro                                         Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cIntr := HHChkIntr(nOper,"HC5",.T.)
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁObtem a prСxima versao do registro                                               Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
			nVersao := HHNextVer(cID,"HC5")	
		EndIf		
		cQuery := "C5_FILIAL='"+xFilial("SC5")+"' .AND. "
		cQuery += "C5_VEND1='"+cId+"' "
		dbSelectArea("SC5")
		cArqInd := CriaTrab(nil, .F.)
		IndRegua("SC5",cArqInd,"C5_FILIAL+C5_CLIENTE+C5_LOJACLI+C5_NUM","D",cQuery)
		MsSeek(xFilial("SC5"))
		Begin Transaction		
			While !SC5->(Eof())  .And. xFilial("SC5") == SC5->C5_FILIAL
				nQtdPed	++
				If nQtdPed <= SuperGetMv("MV_QTPEDPM",,1)
					dbSelectArea("HC5")
					dbSetOrder(1)
					If !MsSeek(SC5->C5_FILIAL + cID + SC5->C5_NUM)
						RecLock("HC5", .T.)
					Else
						RecLock("HC5", .F.)
					EndIf
					HC5->HC5_FILIAL := SC5->C5_FILIAL
					HC5->HC5_ID     := cId
					For nX := 1 To Len(aDados)
						HC5->(FieldPut(HC5->(FieldPos(aDados[nX][1])),SC5->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HC5->HC5_INTR   := cIntr
					HC5->HC5_VER    := nVersao

					dbSelectArea("SC6")
					dbSetOrder(1)
					MsSeek(xFilial("SC6")+SC5->C5_NUM)
					While !Eof() .And. xFilial("SC6") == SC6->C6_FILIAL .And.;
							SC5->C5_NUM == SC6->C6_NUM

						dbSelectArea("HC6")
						dbSetOrder(1)
						If !MsSeek(SC6->C6_FILIAL + cID + SC6->C6_NUM+SC6->C6_ITEM+SC6->C6_PRODUTO)
							RecLock("HC6", .T.)
						Else
							RecLock("HC6", .F.)
						EndIf
						HC6->HC6_FILIAL := SC6->C6_FILIAL
						HC6->HC6_ID     := cId
						For nX := 1 To Len(aDados1)
							HC6->(FieldPut(HC6->(FieldPos(aDados1[nX][1])),SC6->(FieldGet(FieldPos(aDados1[nX][2])))))
						Next nX
						HC6->HC6_INTR   := cIntr
						HC6->HC6_VER    := nVersao

						dbSelectArea("SC6")
						dbSkip()
					EndDo
				EndIf

				cChave := SC5->C5_FILIAL+SC5->C5_CLIENTE+SC5->C5_LOJACLI

				dbSelectArea("SC5")
				dbSkip()

				If cChave <> SC5->C5_FILIAL+SC5->C5_CLIENTE+SC5->C5_LOJACLI
					nQtdPed := 0
				EndIf

			EndDo
			dbSelectArea("HC5")
			dbSetOrder(1)
			MsSeek(xFilial("HC5")+cID)
			While !Eof() .And. xFilial("HC5") == HC5->HC5_FILIAL .And. ;
					cID == HC5->HC5_ID

				If HC5->HC5_VER <> nVersao
					RecLock("HC5")			
					HC5->HC5_INTR   := "E"
					HC5->HC5_VER    := nVersao
				EndIf

				dbSelectArea("HC5")
				dbSkip()
			EndDo

			dbSelectArea("HC6")
			dbSetOrder(1)
			MsSeek(xFilial("HC6")+cID)
			While !Eof() .And. xFilial("HC6") == HC6->HC6_FILIAL .And. ;
					cID == HC6->HC6_ID
				If HC6->HC6_VER <> nVersao
					RecLock("HC6")			
					HC6->HC6_INTR   := "E"
					HC6->HC6_VER    := nVersao
				EndIf
				dbSelectArea("HC6")
				dbSkip()
			EndDo			
			HHUpdCtr(cID,"HC5")
			HHUpdCtr(cID,"HC6")		
		End Transaction		
		#IFDEF TOP
		EndIf	
		#ENDIF
EndIf
RestArea(aAreaSC5)
RestArea(aAreaSC6)
RestArea(aArea)
#IFNDEF TOP
	dbSelectArea("SC5")
    dbClearFilter()
    RetIndex("SC5")
	FErase(cArqInd + OrdBagExt())
#ENDIF

// Ponto de Entrada no Final da Exportacao do SC5 e SC6 para o HC5 e HC6
// Onde poderemos, atraves do mesmo efetuar intervencoes nos ja gravados HC5 e HC6
If ExistBlock("HEXPSC6C")
	ExecBlock("HEXPSC6C", .F., .F.,{cId, cCpo, nOper})
EndIf

Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSE1  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SE1                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSE1(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSE1    := SE1->(GetArea())
Local aAreaSA1    := SA1->(GetArea())
Local nX          := 1
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cQuery      := ""
Local cUpdate     := ""
Local cNoQuery    := ""
Local cId         := HHCheckID("HE1","SE1")
Local cAliasSA1   := "SA1"
Local cAliasSE1   := "SE1"
Local aDados      := {}
Local cIntr       := "I"
Local cDelUpd     := ""
Local cOpConcat	  := Iif("MSSQL"$Upper(TCGetDB()),"+","||")

Local nVersao := 1
#IFDEF TOP
	Local cSepAba   := If("|"$MVABATIM,"|",",")
	Local cSepAnt   := If("|"$MVPAGANT,"|",",")	
	Local cSepNeg   := If("|"$MV_CRNEG,"|",",")
	Local cSepProv  := If("|"$MVPROVIS,"|",",")
	Local cSepRec   := If("|"$MVRECANT,"|",",")
#ENDIF 
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica o relacionamento dos campos e tabelas        Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aadd(aDados,{"HE1_FILIAL","E1_FILIAL "})
	aadd(aDados,{"HE1_CLI   ","E1_CLIENTE"})
	aadd(aDados,{"HE1_LOJA  ","E1_LOJA   "})
	aadd(aDados,{"HE1_TIPO  ","E1_TIPO   "})
	aadd(aDados,{"HE1_EMISS ","E1_EMISSAO"})
	aadd(aDados,{"HE1_VENCTO","E1_VENCTO "})
	aadd(aDados,{"HE1_SALDO ","E1_SALDO  "})
	aadd(aDados,{"HE1_NUM   ","E1_NUM    "})
	aadd(aDados,{"HE1_PARCEL","E1_PARCELA"})
	
	If SE1->(FieldPos("E1_STATUS")>0) .And. HE1->(FieldPos("HE1_STATUS")>0)
		aadd(aDados,{"HE1_STATUS","E1_STATUS"})
	EndIf
	
	If SE1->(FieldPos("E1_PREFIXO")) > 0 .And. HE1->(FieldPos("HE1_PREFIX")) > 0
		aadd(aDados,{"HE1_PREFIX","E1_PREFIXO"})		
	Endif

	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para inclusao de campos no servico    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSE1A")
		aDados := ExecBlock("HEXPSE1A", .F., .F., {aDados})
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁExportaГЦo da tabela de Clientes                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SE1")
	dbSetOrder(1)
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁExportaГЦo da tabela de duplicatas.                   Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If LockByName("HHEXP_SE1"+cID,.T.,!Empty(xFilial("HE1")),.T.)	
				dbSelectArea("SE1")
				dbCommit()

				
				cQuery += "FROM " + RetSqlName("SE1") + " SE1 "
				cQuery += "WHERE "
				cQuery += "SE1.E1_FILIAL = '" + xFilial("SE1") + "' AND "
				cQuery += "SE1.E1_CLIENTE"+cOpConcat+"SE1.E1_LOJA IN (SELECT A1_COD"+cOpConcat+"A1_LOJA FROM " + RetSqlName("SA1") + " SA1 "
				cQuery += "WHERE SA1.A1_VEND = '" + cId + "' AND SA1.A1_FILIAL = '" + xFilial("SA1") + "' AND "
				cQuery += "SA1.D_E_L_E_T_ = ' ' ) AND "
				cQuery += "SE1.E1_SALDO > 0 AND "
				cQuery += "SE1.E1_TIPO NOT IN " + FormatIn(MVABATIM,cSepAba)  + " AND "
				cQuery += "SE1.E1_TIPO NOT IN " + FormatIn(MV_CRNEG,cSepNeg)  + " AND "
				cQuery += "SE1.E1_TIPO NOT IN " + FormatIn(MVPROVIS,cSepProv) + " AND "
				cQuery += "SE1.E1_TIPO NOT IN " + FormatIn(MVRECANT,cSepRec)  + " AND "
				cQuery += "SE1.E1_TIPO NOT IN " + FormatIn(MVTAXA,,3)  + " AND "
				cQuery += "SE1.D_E_L_E_T_ = ' ' "
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSE1B")
					cQuery := ExecBlock("HEXPSE1B", .F., .F., {cQuery})
				EndIf

				cNoQuery := " AND "
				cNoQuery += "SE1.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HE1.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HE1")+" HE1 "
				cNoQuery += "WHERE "
				cNoQuery += "HE1.HE1_FILIAL='" + xFilial("HE1") + "' AND "
				//				cNoQuery += "HE1.R_E_C_N_O_ = SE1.R_E_C_N_O_ AND  "
				cNoQuery += "HE1.D_E_L_E_T_=' ' ) "

				If nOper <> 0

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HE1",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HE1")	
					
					cUpdate := "FROM " + RetSqlName("SE1") + " SE1, " + RetSqlName("SA1") + " SA1, " + RetSqlName("HE1") + " HE1 "
					cUpdate += "WHERE "
					cUpdate += "SE1.E1_FILIAL = '" + xFilial("SE1") + "' AND SA1.A1_FILIAL = '" + xFilial("SA1") + "' AND "
					cUpdate += "SA1.A1_VEND = '" + cId + "' AND "
					cUpdate += "SE1.E1_CLIENTE = SA1.A1_COD AND "
					cUpdate += "SE1.E1_LOJA = SA1.A1_LOJA AND "
					cUpdate += "HE1.R_E_C_N_O_ = SE1.R_E_C_N_O_ AND "
					cUpdate += "("
					For nX := 1 To Len(aDados)-1
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
					Next nX
					cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) AND "
					cUpdate += "SE1.E1_SALDO > 0 "
					
				EndIf

				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "SE1.R_E_C_N_O_ "

				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HE1")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT SE1.R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ")"

				Else

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HE1")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT SE1.R_E_C_N_O_ "
					cDelete += cUpdate
					cDelete += ")"

				EndIf

				__HHLogTime := PText2Sec(Time())
				nRetSql := 	TcSqlExec(cDelete)

				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HE1")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","	
				Next nX
				cInsert += "HE1_INTR,"
				cInsert += "HE1_VER,"
				cInsert += "HE1_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery
				
				__HHLogTime := PText2Sec(Time())
				nRetSql := 	TcSqlExec(cInsert)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If nOper <> 0
					cDelUpd  := "UPDATE "+RetSqlName("HE1")+" "
					cDelUpd  += "SET HE1_INTR = 'E',HE1_VER="+Str(nVersao,10)+" "
					cDelUpd  += "WHERE "
					cDelUpd  += "R_E_C_N_O_ NOT IN ("
					cDelUpd  += "SELECT SE1.R_E_C_N_O_ "
					cDelUpd  += "FROM " + RetSqlName("SE1") + " SE1," + RetSqlName("SA1") + " SA1, " + RetSqlName("HE1") + " HE1 "
					cDelUpd  += "WHERE "
					cDelUpd  += "SE1.E1_FILIAL = '" + xFilial("SE1") + "' AND SA1.A1_FILIAL = '" + xFilial("SA1") + "' AND "
					cDelUpd  += "SA1.A1_VEND = '" + cId + "' AND "
					cDelUpd  += "SE1.E1_CLIENTE = SA1.A1_COD AND "
					cDelUpd  += "SE1.E1_LOJA = SA1.A1_LOJA AND "
					cDelUpd  += "HE1.R_E_C_N_O_ = SE1.R_E_C_N_O_ AND "
					cDelUpd  += "SE1.D_E_L_E_T_=' ' AND SE1.E1_SALDO > 0 AND "
					cDelUpd  += "SE1.E1_BAIXA <> '" + DTOS(dDataBase)  + "')  AND "
 	                cDelUpd  += "HE1_ID = '" +cID+ "' AND HE1_INTR <> 'E'"
					nRetSql := TcSqlExec(cDelUpd)
					
				EndIf
				Begin Transaction
					HHExcGenDel("HE1")
					HHUpdCtr(cID,"HE1")	
				End Transaction			
				UnLockByName("HHEXP_SE1"+cID,.T.,!Empty(xFilial("HE1")),.T.)
			EndIf			
		Else
	#ENDIF
		dbSelectArea(cAliasSE1)
		(cAliasSE1)->(dbSetOrder(1))
		dbSelectArea(cAliasSA1)
		(cAliasSA1)->(dbSetOrder(1))
		If nOper == 0
			cQuery := "A1_VEND $ '" + cId + "' .And. "
			cQuery += '!(SE1->E1_TIPO$MVTAXA+"/"+MVPROVIS+"/"+MVRECANT+"/"+MVABATIM+"/"+MV_CRNEG)' 
			MsSeek(xFilial("SE1"))
			While !(cAliasSE1)->(Eof()) .And. (cAliasSE1)->E1_FILIAL == xFilial("SE1")
				Begin Transaction
					If (cAliasSA1)->(dbSeek( xFilial("SA1")+(cAliasSE1)->E1_CLIENTE+(cAliasSE1)->E1_LOJA ))
						If (cAliasSA1)->(&(cQuery))
							dbSelectArea("HE1")
							dbSetOrder(1)
							If !dbSeek(xFilial("SE1") + cId + SA1->A1_COD+SA1->A1_LOJA)
								RecLock("HE1", .T.)
							Else
								RecLock("HE1", .F.)
							EndIf
							For nX := 1 To Len(aDados)
								HE1->(FieldPut(HE1->(FieldPos(aDados[nX][1])),(cAliasSE1)->(FieldGet(FieldPos(aDados[nX][2])))))
							Next nX
							HE1->HE1_ID     := cId
							HE1->HE1_VER    := nVersao
							HE1->HE1_INTR   := cIntr
						EndIf
					EndIf
				End Transaction
				(cAliasSE1)->(dbSkip())
			EndDo
			HHUpdCtr(cID,"HE1")	
		Else 	
			Begin Transaction
				dbSelectArea("HE1")
				dbSetOrder(1)
				If !dbSeek(xFilial("SE1") + cId + SA1->A1_COD+SA1->A1_LOJA)
					RecLock("HE1", .T.)
				Else
					RecLock("HE1", .F.)
				EndIf
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁAnalisa a instrucao e versao do registro                                         Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				cIntr := HHChkIntr(nOper,"HE1",HE1->(Found()))
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁObtem a prСxima versao do registro                                               Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
				If nOper <> 0
					nVersao := HHNextVer(cID,"HE1")	
				EndIf		 			
				For nX := 1 To Len(aDados)
					HE1->(FieldPut(HE1->(FieldPos(aDados[nX][1])),(cAliasSE1)->(FieldGet(FieldPos(aDados[nX][2])))))
				Next nX
				HE1->HE1_ID     := cId
				HE1->HE1_VER    := nVersao
				HE1->HE1_INTR   := cIntr

				HHUpdCtr(cID,"HE1")	
			End Transaction
		EndIf
		#IFDEF TOP
		EndIf
		#ENDIF
EndIf
RestArea(aAreaSE1)
RestArea(aAreaSA1)
RestArea(aArea)
Return(cID)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSX5  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SX5 - TABELA 24       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSX5(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSX5    := SX5->(GetArea())
Local nX          := 1
Local cTabela     := "24"
Local cId         := HHCheckID("HTP")
Local cAliasSX5   := "SX5"
Local aDados      := {}
Local aJobGlobal  := {}
Local cIntr       := "I"
Local nVersao     := 1
#IFDEF TOP
Local cInsert     := ""
Local cDelete     := ""
Local cQuery      := ""
Local cNoQuery    := ""
Local cSelect     := ""
Local cUpdate     := ""
#ENDIF
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSX5")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf

	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDados,{"HTP_FILIAL","X5_FILIAL "})
		aadd(aDados,{"HTP_CHAVE ","X5_CHAVE  "})
		aadd(aDados,{"HTP_DESCRI","X5_DESCRI "})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSX5A")
			aDados := ExecBlock("HEXPSX5A", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Clientes                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("HTP")
		dbSelectArea("SX5")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de duplicatas.                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SX5"+cID,.T.,!Empty(xFilial("HTP")),.T.)	
					
					dbSelectArea("SX5")
					dbCommit()

					cQuery += "FROM " + RetSqlName("SX5") + " SX5 "
					cQuery += "WHERE "
					cQuery += "SX5.X5_FILIAL = '" + xFilial("SX5") + "' AND "
					cQuery += "SX5.X5_TABELA = '" + cTabela + "' AND "
					cQuery += "SX5.D_E_L_E_T_ = ' ' "

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSX5B")
						cQuery := ExecBlock("HEXPSX5B", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "SX5.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HTP.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HTP")+" HTP "
					cNoQuery += "WHERE "
					cNoQuery += "HTP.HTP_FILIAL='" + xFilial("HTP") + "' AND "
					//				cNoQuery += "HTP.R_E_C_N_O_ = SX5.R_E_C_N_O_ AND "
					cNoQuery += "HTP.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HTP",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HTP")	

						cUpdate := "FROM "+RetSqlName("SX5")+" SX5 "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = SX5.R_E_C_N_O_ AND  "
						cUpdate += "("
						For nX := 1 To Len(aDados)-1
							cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
						Next nX
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "SX5.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HTP")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SX5.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HTP")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT SX5.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HTP")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HTP_INTR,"
					cInsert += "HTP_VER,"
					cInsert += "HTP_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					Begin Transaction
						HHExcGenDel("HTP")
						HHUpdCtr(cID,"HTP")	
					End Transaction
					UnLockByName("HHEXP_SX5"+cID,.T.,!Empty(xFilial("HTP")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasSX5)
			(cAliasSX5)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("SX5")+cTabela)
				While !(cAliasSX5)->(Eof()) .And. (cAliasSX5)->X5_FILIAL == xFilial("SX5") .And. (cAliasSX5)->X5_TABELA == cTabela
					Begin Transaction
						dbSelectArea("HTP")
						dbSetOrder(1)
						If !dbSeek(xFilial("SX5") + cId + (cAliasSX5)->X5_CHAVE)
							RecLock("HTP", .T.)
						Else
							RecLock("HTP", .F.)
						EndIf  	
						For nX := 1 To Len(aDados)
							HTP->(FieldPut(HTP->(FieldPos(aDados[nX][1])),(cAliasSX5)->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HTP->HTP_ID     := cId
						HTP->HTP_INTR   := cIntr
						HTP->HTP_VER    := 1
					End Transaction
					(cAliasSX5)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HTP")	
			Else 	
				Begin Transaction
					dbSelectArea("HTP")
					dbSetOrder(1)
					If !dbSeek(xFilial("SX5") + cId + (cAliasSX5)->X5_CHAVE)
						RecLock("HTP", .T.)
					Else
						RecLock("HTP", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HTP",HTP->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HTP")	
					For nX := 1 To Len(aDados)
						HTP->(FieldPut(HTP->(FieldPos(aDados[nX][1])),(cAliasSX5)->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HTP->HTP_ID     := cId
					HTP->HTP_VER    := nVersao
					HTP->HTP_INTR   := cIntr

					HHUpdCtr(cID,"HTP")	
				End Transaction
			EndIf		
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSX5")==0
		aadd(aJobGlobal,"HHEXPSX5")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSX5)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPAC8  Ё Autor ЁEduardo Riera          Ё Data Ё17/03/06  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SU5                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPAC8(cCpo,nOper)

dbSelectArea("SU5")
dbSetOrder(1)
MsSeek(xFilial("SU5")+AC8->AC8_CODCON)

Return(HHEXPSU5(cCpo,nOper))


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSU5  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SU5                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSU5(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSU5    := SU5->(GetArea())
Local aAreaSA1    := SA1->(GetArea())
Local aAreaAC8    := AC8->(GetArea())
Local nX          := 1
Local cId         := ""
Local cAliasSU5   := "SU5"
Local cAliasSA1   := "SA1"
Local cAliasAC8   := "AC8"
Local cEntidade   := "SA1"
Local aDados      := {}
Local cIntr   	  := "I"
Local nVersao 	  := 1
Local cOpConcat	  := Iif("MSSQL"$Upper(TCGetDB()),"+","||")
#IFDEF TOP
	Local cDelete     := ""
	Local cInsert     := ""
	Local cNoQuery    := ""
	Local cSelect     := ""
	Local cQuery      := ""
	Local cUpdate     := ""
	Local cDelUpd     := ""
#ENDIF
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

If Empty(cCpo)
	cId := HGU->HGU_CODBAS
Else
	dbSelectArea("AC8")
	dbSetOrder(1)
	MsSeek(xFilial("AC8")+SU5->U5_CODCONT+"SA1")
	
	dbSelectArea("SA1")
	dbSetOrder(1)
	MsSeek(AC8->AC8_FILENT+AC8->AC8_CODENT)
	
	cId := HHCheckID("HA1","SA1")
EndIf
If !cId == "0" .And. nOper >= 0
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica o relacionamento dos campos e tabelas        Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aadd(aDados,{"HU5_FILIAL","U5_FILIAL "})
	aadd(aDados,{"HU5_CLIENT","A1_COD    "})
	aadd(aDados,{"HU5_LOJA  ","A1_LOJA   "})
	aadd(aDados,{"HU5_CODCON","U5_CODCONT"})
	aadd(aDados,{"HU5_CONTAT","U5_CONTAT "})
	aadd(aDados,{"HU5_CPF   ","U5_CPF    "})
	aadd(aDados,{"HU5_FUNCAO","U5_FUNCAO "})
	aadd(aDados,{"HU5_FONE  ","U5_FONE   "})
	aadd(aDados,{"HU5_CEL   ","U5_CELULAR"})
	aadd(aDados,{"HU5_DTNASC","U5_NIVER"  })
	aadd(aDados,{"HU5_EMAIL ","U5_EMAIL  "})
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para inclusao de campos no servico    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSU5A")
		aDados := ExecBlock("HEXPSU5A", .F., .F., {aDados})
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁExportaГЦo da tabela de Clientes                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SU5")
	dbSetOrder(1)
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁExportaГЦo da tabela de duplicatas.                   Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If LockByName("HHEXP_SU5"+cID,.T.,!Empty(xFilial("HU5")),.T.)	
				dbSelectArea("SU5")
				dbCommit()

				cQuery += "FROM " + RetSqlName("SA1")+" SA1,"
				cQuery += RetSqlName("AC8") + " AC8,"
				cQuery += RetSqlName("SU5") + " SU5 "
				cQuery += "WHERE "
				cQuery += "AC8.AC8_FILIAL = '" + xFilial("AC8") + "' AND "
				cQuery += "AC8.AC8_ENTIDA = '" + cEntidade + "' AND "
				cQuery += "AC8.AC8_FILENT = '" + xFilial("SA1") + "' AND "
				cQuery += "AC8.AC8_CODENT = (SA1.A1_COD"+cOpConcat+"SA1.A1_LOJA)  AND "
				cQuery += "AC8.D_E_L_E_T_ = ' ' AND "
				cQuery += "SA1.A1_FILIAL = '" + xFilial("SA1") + "' AND "
				cQuery += "SA1.A1_VEND = '" + cId + "' AND "
				cQuery += "SA1.D_E_L_E_T_ = ' ' AND "
				cQuery += "SU5.U5_FILIAL = '" + xFilial("SU5") + "' AND "
				cQuery += "SU5.U5_CODCONT = AC8.AC8_CODCON AND "				
				cQuery += "SU5.D_E_L_E_T_ = ' ' "
				
//				cQuery := ChangeQuery(cQuery)
//				cQuery := SubStr(cQuery,8)

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSU5B")
					cQuery := ExecBlock("HEXPSU5B", .F., .F., {cQuery})
				EndIf

				cNoQuery := " AND "
				cNoQuery += "AC8.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HU5.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HU5")+" HU5 "
				cNoQuery += "WHERE "
				cNoQuery += "HU5.HU5_FILIAL='" + xFilial("HU5") + "' AND "
				cNoQuery += "HU5.D_E_L_E_T_=' ' ) "

				If nOper <> 0

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HU5",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HU5")	

					cUpdate := "FROM "+RetSqlName("SU5")+" SU5,"
					cUpdate += RetSqlName("AC8")+" AC8,"
					cUpdate += RetSqlName("SA1")+" SA1 "
					cUpdate += "WHERE "
					cUpdate += RetSqlName("HU5")+".R_E_C_N_O_ = AC8.R_E_C_N_O_  AND  "
					cUpdate += RetSqlName("HU5")+".HU5_ID = '"+cID+"' AND "
					cUpdate += "SU5.U5_FILIAL = '" + xFilial("SU5") + "' AND "
					cUpdate += "SU5.U5_CODCONT = AC8.AC8_CODCON AND "
					cUpdate += "SU5.D_E_L_E_T_ = ' ' AND "
					cUpdate += "AC8.AC8_FILENT = SA1.A1_FILIAL AND "
					cUpdate += "AC8.AC8_CODENT = (SA1.A1_COD"+cOpConcat+"SA1.A1_LOJA) AND "
					cUpdate += "AC8.D_E_L_E_T_ = ' ' AND "					
					cUpdate += "("
					For nX := 1 To Len(aDados)-1
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
					Next nX
					cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "
					
//					cUpdate := ChangeQuery(cUpdate)
//					cUpdate := SubStr(cUpdate,8)

				EndIf

				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX		
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "AC8.R_E_C_N_O_ "

				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HU5")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT AC8.R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ")"

				Else

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HU5")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT AC8.R_E_C_N_O_ "
					cDelete += cUpdate
					cDelete += ")"

				EndIf

				__HHLogTime := PText2Sec(Time())
				nRetSql := 	TcSqlExec(cDelete)

				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HU5")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","	
				Next nX
				cInsert += "HU5_INTR,"
				cInsert += "HU5_VER,"
				cInsert += "HU5_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery

				__HHLogTime := PText2Sec(Time())
				nRetSql := 	TcSqlExec(cInsert)

				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If nOper <> 0
					cDelUpd  := "UPDATE "+RetSqlName("HU5")+" "
					cDelUpd  += "SET HU5_INTR = 'E',HU5_VER="+Str(nVersao,10)+" "
					cDelUpd  += "WHERE "
					cDelUpd  += "R_E_C_N_O_ NOT IN ("
					cDelUpd  += "SELECT AC8.R_E_C_N_O_ "
					cDelUpd  += cQuery
					cDelUpd  += ") AND "
					cDelUpd  += "HU5_STATUS NOT IN ('N','A') AND "
					cDelUpd  += "HU5_INTR <> 'N' AND "
					cDelUpd  += "HU5_ID = '"+cID+"' AND HU5_INTR <> 'E' "

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelUpd)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
				EndIf
				
				Begin Transaction
					HHExcGenDel("HU5")
					HHUpdCtr(cID,"HU5")	
				End Transaction			
				UnLockByName("HHEXP_SU5"+cID,.T.,!Empty(xFilial("HU5")),.T.)
			EndIf			
		Else
	#ENDIF
		dbSelectArea(cAliasAC8)
		(cAliasAC8)->(dbSetOrder(2))
		If nOper == 0
			(cAliasAC8)->(dbSeek(xFilial("AC8")+cEntidade))
			While !(cAliasAC8)->(Eof()) .And. (cAliasAC8)->AC8_FILIAL == xFilial("AC8") .And. (cAliasAC8)->AC8_ENTIDA == cEntidade
				dbSelectArea(cAliasSA1)
				(cAliasSA1)->(dbSetOrder(1))
				If (cAliasSA1)->(dbSeek(xFilial("SA1")+(cAliasAC8)->AC8_CODENT))
					If (cAliasSA1)->A1_VEND == cId							
						dbSelectArea(cAliasSU5)
						(cAliasSU5)->(dbSetOrder(1))
						If (cAliasSU5)->( dbSeek( xFilial("SU5")+(cAliasAC8)->AC8_CODCON ) )
							If (cAliasSU5)->U5_ATIVO == "1"
								dbSelectArea("HU5")
								HU5->(dbSetOrder(1))
								Begin Transaction
									If !dbSeek(xFilial("SU5") + cId + (cAliasSA1)->A1_COD + (cAliasSA1)->A1_LOJA + SU5->U5_CODCONT)
										RecLock("HU5", .T.)
									Else
										RecLock("HU5", .F.)
									EndIf
									For nX := 1 To Len(aDados)
										HU5->(FieldPut(HU5->(FieldPos(aDados[nX][1])),(cAliasSU5)->(FieldGet(FieldPos(aDados[nX][2])))))
									Next nX
									HU5->HU5_ID     := cId
									HU5->HU5_INTR   := cIntr
									HU5->HU5_VER    := 1
								End Transaction
							EndIf	
						EndIf
					Endif
				EndIf
				(cAliasAC8)->(dbSkip())
			EndDo
			HHUpdCtr(cID,"HU5")	
		Else 	
			If SU5->U5_ATIVO == "1"
				Begin Transaction
					dbSelectArea(cAliasAC8)
					(cAliasAC8)->(dbSetOrder(1))
					If (cAliasAC8)->(dbSeek(xFilial("AC8")+SU5->U5_CODCONT+"SA1"+xFilial("SA1")))
						dbSelectArea(cAliasSA1)
						(cAliasSA1)->(dbSetOrder(1))
						If (cAliasSA1)->(dbSeek(xFilial("SA1")+(cAliasAC8)->AC8_CODENT))						
							dbSelectArea("HU5")
							dbSetOrder(1)
							If !dbSeek(xFilial("SU5") + cId + (cAliasAC8)->AC8_CODENT + (cAliasAC8)->AC8_CODCON)
								RecLock("HU5", .T.)
							Else
								RecLock("HU5", .F.)
							EndIf  	
							//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							//ЁAnalisa a instrucao e versao do registro                                         Ё
							//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
							cIntr := HHChkIntr(nOper,"HU5",HU5->(Found()))
							//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							//ЁObtem a prСxima versao do registro                                               Ё
							//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
							nVersao := HHNextVer(cID,"HU5")	
							For nX := 1 To Len(aDados)
								HU5->(FieldPut(HU5->(FieldPos(aDados[nX][1])),(cAliasSU5)->(FieldGet(FieldPos(aDados[nX][2])))))
							Next nX
							HU5->HU5_ID     := cId
							HU5->HU5_VER    := nVersao
							HU5->HU5_INTR   := cIntr

							HHUpdCtr(cID,"HU5")	
						EndIf
					EndIf
				End Transaction
			EndIf		
		EndIf
		#IFDEF TOP
		EndIf
		#ENDIF
EndIf
RestArea(aAreaSU5)
RestArea(aAreaSA1)
RestArea(aAreaAC8)
RestArea(aArea)
Return(cID)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACO  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACO                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACO(cCpo,nOper)

Local aArea       	:= GetArea()
Local aAreaACO    	:= ACO->(GetArea())
Local aAreaACP    	:= ACP->(GetArea())
Local nX          	:= 1
Local cId         	:= HHCheckID("HCO","ACO")
Local cAliasACO   	:= "ACO"
Local cAliasACP   	:= "ACP"
Local aDados      	:= Array(2)
Local aJobGlobal  	:= {}
Local cIntr   		:= "I"
Local nVersao 		:= 1
Local cDelUpd 		:= ""
#IFDEF TOP
Local cInsert     	:= ""
Local cDelete     	:= ""
Local cSelect     	:= ""
Local cQuery      	:= ""
Local cUpdate     	:= ""
Local cNoQuery    	:= ""
#ENDIF
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  		:= 0
Local cFuncName   	:= ProcName()

DEFAULT cCpo			:= ""
DEFAULT nOper			:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPACO")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0

	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		//Cabecalhos das Regras de Desconto
		aDados[01] := {}
		aadd(aDados[01],{"HCO_FILIAL","ACO_FILIAL"})
		aadd(aDados[01],{"HCO_CODREG","ACO_CODREG"})
		aadd(aDados[01],{"HCO_DESCRI","ACO_DESCRI"})
		aadd(aDados[01],{"HCO_CODCLI","ACO_CODCLI"})
		aadd(aDados[01],{"HCO_LOJA  ","ACO_LOJA  "})
		aadd(aDados[01],{"HCO_CODTAB","ACO_CODTAB"})
		aadd(aDados[01],{"HCO_CONDPG","ACO_CONDPG"})
		aadd(aDados[01],{"HCO_FORMPG","ACO_FORMPG"})
		aadd(aDados[01],{"HCO_MOEDA ","ACO_MOEDA "})
		aadd(aDados[01],{"HCO_PERDES","ACO_PERDES"})
		aadd(aDados[01],{"HCO_CFAIXA","ACO_CFAIXA"})
		aadd(aDados[01],{"HCO_FAIXA" ,"ACO_FAIXA "})
		
		If ACO->(FieldPos("ACO_GRPVEN")) > 0 .And. HCO->(FieldPos("HCO_GRPVEN")) > 0
			aadd(aDados[01],{"HCO_GRPVEN","ACO_GRPVEN"})
		EndIf
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACOA")
			aDados[01] := ExecBlock("HEXPACOA", .F., .F., {aDados[01]})
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("ACO")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACO"+cID,.T.,!Empty(xFilial("ACO")),.T.)	
					dbSelectArea("ACO")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACO") + " ACO "
					cQuery += "WHERE "
					cQuery += "ACO.ACO_FILIAL = '" + xFilial("ACO") + "' AND "
					//Validacao caso queira filtrar as regras para os clientes de um vendedor especifico.
					//				cQuery += "(ACO_CODCLI IN (SELECT A1_COD FROM SA1010 SA1 WHERE "
					//				cQuery += "A1_FILIAL =  '" + xFilial("SA1") + "' AND A1_VEND = '" + cId + "' AND SA1.D_E_L_E_T_ = ' ' ) "
					//				cQuery += "OR ACO_CODCLI = '" + Space(Len(SA1->A1_COD)) + "'	) AND "
					cQuery += "ACO.D_E_L_E_T_ = ' ' "
					
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACOB")
						cQuery := ExecBlock("HEXPACOB", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "ACO.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCO.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCO")+" HCO "
					cNoQuery += "WHERE "
					cNoQuery += "HCO.R_E_C_N_O_ = ACO.R_E_C_N_O_ AND "
					cNoQuery += "HCO.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCO",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCO")	

						cUpdate := "FROM "+RetSqlName("ACO")+" ACO "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = ACO.R_E_C_N_O_ AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[01])-1
							cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" OR "
						Next nX
						cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[01])
						cSelect += aDados[01][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACO.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCO")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACO.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCO")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACO.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCO")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[01])
						cInsert += aDados[01][nX][1]+","	
					Next nX
					cInsert += "HCO_INTR,"
					cInsert += "HCO_VER,"
					cInsert += "HCO_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
                    
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCO")+" "
						cDelUpd  += "SET HCO_INTR = 'E',HCO_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACO.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACO")+" ACO "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACO.R_E_C_N_O_ AND "
						cDelUpd  += "ACO.D_E_L_E_T_=' ' ) AND HCO_INTR <> 'E' "
						
						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf
					Begin Transaction
						HHExcGenDel("HCO")
						HHUpdCtr(cID,"HCO")	
					End Transaction
					UnLockByName("HHEXP_ACO"+cID,.T.,!Empty(xFilial("HCO")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACO)
			(cAliasACO)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACO"))
				While !(cAliasACO)->(Eof()) .And. (cAliasACO)->ACO_FILIAL == xFilial("ACO")
					Begin Transaction
						dbSelectArea("HCO")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACO") + cId + (cAliasACO)->ACO_CODREG)
							RecLock("HCO", .T.)
						Else
							RecLock("HCO", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[01])
							HCO->(FieldPut(HCO->(FieldPos(aDados[01][nX][1])),(cAliasACO)->(FieldGet(FieldPos(aDados[01][nX][2])))))
						Next nX
						HCO->HCO_ID     := cId
						HCO->HCO_INTR   := cIntr
						HCO->HCO_VER    := 1
					End Transaction
					(cAliasACO)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCO")	
			Else 	
				Begin Transaction
					dbSelectArea("HCO")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACO") + cId + ACO->ACO_CODREG)
						RecLock("HCO", .T.)
					Else
						RecLock("HCO", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCO",HCO->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCO")	
					For nX := 1 To Len(aDados[01])
						HCO->(FieldPut(HCO->(FieldPos(aDados[01][nX][1])),(cAliasACO)->(FieldGet(FieldPos(aDados[01][nX][2])))))
					Next nX
					HCO->HCO_ID     := cId
					HCO->HCO_VER    := nVersao
					HCO->HCO_INTR   := cIntr

					HHUpdCtr(cID,"HCO")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды

		//Itens das Regras de Desconto
		aDados[02] := {}
		aadd(aDados[02],{"HCP_FILIAL","ACP_FILIAL"})
		aadd(aDados[02],{"HCP_CODREG","ACP_CODREG"})
		aadd(aDados[02],{"HCP_ITEM  ","ACP_ITEM  "})
		aadd(aDados[02],{"HCP_CODPRO","ACP_CODPRO"})
		aadd(aDados[02],{"HCP_GRUPO ","ACP_GRUPO "})
		aadd(aDados[02],{"HCP_PERDES","ACP_PERDES"})
		aadd(aDados[02],{"HCP_FAIXA ","ACP_FAIXA "})
		aadd(aDados[02],{"HCP_CFAIXA","ACP_CFAIXA"})

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACPA")
			aDados[02] := ExecBlock("HEXPACPA", .F., .F., {aDados[02]})
		EndIf

		dbSelectArea("ACP")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACP"+cID,.T.,!Empty(xFilial("ACP")),.T.)	
					dbSelectArea("ACP")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACO") + " ACO , " + RetSqlName("ACP") + " ACP "
					cQuery += "WHERE "
					cQuery += "ACO.ACO_FILIAL = '" + xFilial("ACO") + "' AND "
					cQuery += "ACP.ACP_FILIAL = '" + xFilial("ACP") + "' AND "
					cQuery += "ACO_CODREG = ACP_CODREG AND "
					//Validacao caso queira filtrar as regras para os clientes de um vendedor especifico.
					//				cQuery += "(ACO_CODCLI IN (SELECT A1_COD FROM SA1010 SA1 WHERE "
					//				cQuery += "A1_FILIAL =  '" + xFilial("SA1") + "' AND A1_VEND = '" + cId + "' AND SA1.D_E_L_E_T_ = ' ' ) "
					//				cQuery += "OR ACO_CODCLI = '" + Space(Len(SA1->A1_COD)) + "'	) AND "
					cQuery += "ACO.D_E_L_E_T_ = ' '  AND ACP.D_E_L_E_T_ = ' '"
					
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACPB")
						cQuery := ExecBlock("HEXPACPB", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "ACP.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCP.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCP")+" HCP "
					cNoQuery += "WHERE "
					cNoQuery += "HCP.R_E_C_N_O_ = ACP.R_E_C_N_O_ AND "
					cNoQuery += "HCP.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCP",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCP")	

						cUpdate := "FROM "+RetSqlName("ACP")+" ACP "
						cUpdate += "WHERE "
						cUpdate += "HCP_FILIAL = ACP.ACP_FILIAL AND "
						cUpdate += "HCP_ID = '" + cId + "' AND "
						cUpdate += "HCP_CODREG = ACP.ACP_CODREG AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[02])-1
							cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" OR "
						Next nX
						cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[02])
						cSelect += aDados[02][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACP.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCP")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACP.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCP")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACP.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCP")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[02])
						cInsert += aDados[02][nX][1]+","	
					Next nX
					cInsert += "HCP_INTR,"
					cInsert += "HCP_VER,"
					cInsert += "HCP_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCP")+" "
						cDelUpd  += "SET HCP_INTR = 'E',HCP_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACP.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACP")+" ACP "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACP.R_E_C_N_O_ AND "
						cDelUpd  += "ACP.D_E_L_E_T_=' ' ) AND HCP_INTR <> 'E' "
						
						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf					
					Begin Transaction
						HHExcGenDel("HCP")
						HHUpdCtr(cID,"HCP")	
					End Transaction			
					UnLockByName("HHEXP_ACP"+cID,.T.,!Empty(xFilial("HCP")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACP)
			(cAliasACP)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACP"))
				While !(cAliasACP)->(Eof()) .And. (cAliasACP)->ACP_FILIAL == xFilial("ACP")
					Begin Transaction
						dbSelectArea("HCP")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACP") + cId + (cAliasACP)->ACP_CODREG + (cAliasACP)->ACP_ITEM)
							RecLock("HCP", .T.)
						Else
							RecLock("HCP", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[02])
							HCP->(FieldPut(HCP->(FieldPos(aDados[02][nX][1])),(cAliasACP)->(FieldGet(FieldPos(aDados[02][nX][2])))))
						Next nX
						HCP->HCP_ID     := cId
						HCP->HCP_INTR   := cIntr
						HCP->HCP_VER    := 1
					End Transaction
					(cAliasACP)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCP")	
			Else 	
				Begin Transaction
					dbSelectArea("HCP")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACP") + cId + ACP->ACP_CODREG + (cAliasACP)->ACP_ITEM)
						RecLock("HCP", .T.)
					Else
						RecLock("HCP", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCP",HCP->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCP")	
					For nX := 1 To Len(aDados[02])
						HCP->(FieldPut(HCP->(FieldPos(aDados[02][nX][1])),ACP->(FieldGet(FieldPos(aDados[02][nX][2])))))
					Next nX
					HCP->HCP_ID     := cId
					HCP->HCP_VER    := nVersao
					HCP->HCP_INTR   := cIntr	
					HHUpdCtr(cID,"HCP")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPACO")==0
		aadd(aJobGlobal,"HHEXPACO")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaACO)
RestArea(aAreaACP)
RestArea(aArea)
Return(cID)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACP  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACP                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACP(cCpo,nOper)

DEFAULT cCpo    := ""
DEFAULT nOper   := 0

Return HHEXPACO(cCpo,nOper)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACQ  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACQ                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACQ(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaACQ    := ACQ->(GetArea())
Local aAreaACR    := ACR->(GetArea())
Local nX          := 1
Local cId         := HHCheckID("HCQ","ACQ")
Local cAliasACQ   := "ACQ"
Local cAliasACR   := "ACR"
Local aJobGlobal  := {}
Local aDados      := Array(2)
Local cIntr   := "I"
Local nVersao := 1
Local cDelUpd	:= ""
#IFDEF TOP
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cQuery      := ""
Local cUpdate     := ""
Local cNoQuery    := ""
#ENDIF                           
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPACQ")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0

	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf

	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		//Cabecalhos das Regras de Bonificacao
		aDados[01] := {}
		aadd(aDados[01],{"HCQ_FILIAL","ACQ_FILIAL"})
		aadd(aDados[01],{"HCQ_CODREG","ACQ_CODREG"})
		aadd(aDados[01],{"HCQ_DESCRI","ACQ_DESCRI"})
		aadd(aDados[01],{"HCQ_CODCLI","ACQ_CODCLI"})
		aadd(aDados[01],{"HCQ_LOJA  ","ACQ_LOJA  "})
		aadd(aDados[01],{"HCQ_CODTAB","ACQ_CODTAB"})
		aadd(aDados[01],{"HCQ_CONDPG","ACQ_CONDPG"})
		aadd(aDados[01],{"HCQ_FORMPG","ACQ_FORMPG"})
		aadd(aDados[01],{"HCQ_CODPRO","ACQ_CODPRO"})
		aadd(aDados[01],{"HCQ_QUANT ","ACQ_QUANT "})
		aadd(aDados[01],{"HCQ_TPRGBN","ACQ_TPRGBN"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACQA")
			aDados[01] := ExecBlock("HEXPACQA", .F., .F., {aDados[01]})
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("ACQ")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACQ"+cID,.T.,!Empty(xFilial("ACQ")),.T.)	
					dbSelectArea("ACQ")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACQ") + " ACQ "
					cQuery += "WHERE "
					cQuery += "ACQ.ACQ_FILIAL = '" + xFilial("ACQ") + "' AND "
					//Validacao caso queira filtrar as regras para os clientes de um vendedor especifico.
					//				cQuery += "(ACQ_CODCLI IN (SELECT A1_COD FROM SA1010 SA1 WHERE "
					//				cQuery += "A1_FILIAL =  '" + xFilial("SA1") + "' AND A1_VEND = '" + cId + "' AND SA1.D_E_L_E_T_ = ' ' ) "
					//				cQuery += "OR ACQ_CODCLI = '" + Space(Len(SA1->A1_COD)) + "'	) AND "
					cQuery += "ACQ.D_E_L_E_T_ = ' ' "

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACQB")
						cQuery := ExecBlock("HEXPACQB", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "ACQ.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCQ.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCQ")+" HCQ "
					cNoQuery += "WHERE "
					cNoQuery += "HCQ.R_E_C_N_O_ = ACQ.R_E_C_N_O_ AND "
					cNoQuery += "HCQ.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCQ",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCQ")	

						cUpdate := "FROM "+RetSqlName("ACQ")+" ACQ "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = ACQ.R_E_C_N_O_ AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[01])-1
							cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" OR "
						Next nX
						cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[01])
						cSelect += aDados[01][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACQ.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCQ")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACQ.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCQ")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACQ.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCQ")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[01])
						cInsert += aDados[01][nX][1]+","	
					Next nX
					cInsert += "HCQ_INTR,"
					cInsert += "HCQ_VER,"
					cInsert += "HCQ_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCQ")+" "
						cDelUpd  += "SET HCQ_INTR = 'E',HCQ_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACQ.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACQ")+" ACQ "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACQ.R_E_C_N_O_ AND "
						cDelUpd  += "ACQ.D_E_L_E_T_=' ' ) AND HCQ_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf					
					Begin Transaction
						HHExcGenDel("HCQ")
						HHUpdCtr(cID,"HCQ")	
					End Transaction
					UnLockByName("HHEXP_ACQ"+cID,.T.,!Empty(xFilial("HCQ")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACQ)
			(cAliasACQ)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACQ"))
				While !(cAliasACQ)->(Eof()) .And. (cAliasACQ)->ACQ_FILIAL == xFilial("ACQ")
					Begin Transaction
						dbSelectArea("HCQ")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACQ") + cId + (cAliasACQ)->ACQ_CODREG)
							RecLock("HCQ", .T.)
						Else
							RecLock("HCQ", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[01])
							HCQ->(FieldPut(HCQ->(FieldPos(aDados[01][nX][1])),(cAliasACQ)->(FieldGet(FieldPos(aDados[01][nX][2])))))
						Next nX
						HCQ->HCQ_ID     := cId
						HCQ->HCQ_INTR   := cIntr
						HCQ->HCQ_VER    := 1
					End Transaction
					(cAliasACQ)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCQ")	
			Else 	
				Begin Transaction
					dbSelectArea("HCQ")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACQ") + cId + ACQ->ACQ_CODREG)
						RecLock("HCQ", .T.)
					Else
						RecLock("HCQ", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCQ",HCQ->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCQ")	
					For nX := 1 To Len(aDados[01])
						HCQ->(FieldPut(HCQ->(FieldPos(aDados[01][nX][1])),(cAliasACQ)->(FieldGet(FieldPos(aDados[01][nX][2])))))
					Next nX
					HCQ->HCQ_ID     := cId
					HCQ->HCQ_VER    := nVersao
					HCQ->HCQ_INTR   := cIntr

					HHUpdCtr(cID,"HCQ")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды

		//Itens das Regras de Bonificacao
		aDados[02] := {}
		aadd(aDados[02],{"HCR_FILIAL","ACR_FILIAL"})
		aadd(aDados[02],{"HCR_CODREG","ACR_CODREG"})
		aadd(aDados[02],{"HCR_ITEM  ","ACR_ITEM  "})
		aadd(aDados[02],{"HCR_CODPRO","ACR_CODPRO"})
		aadd(aDados[02],{"HCR_GRUPO ","ACR_GRUPO "})
		aadd(aDados[02],{"HCR_LOTE  ","ACR_LOTE  "})	
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACRA")
			aDados[02] := ExecBlock("HEXPACRA", .F., .F., {aDados[02]})
		EndIf	

		dbSelectArea("ACR")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACR"+cID,.T.,!Empty(xFilial("ACR")),.T.)	
					dbSelectArea("ACR")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACQ") + " ACQ , " + RetSqlName("ACR") + " ACR "
					cQuery += "WHERE "
					cQuery += "ACQ.ACQ_FILIAL = '" + xFilial("ACQ") + "' AND "
					cQuery += "ACR.ACR_FILIAL = '" + xFilial("ACR") + "' AND "
					cQuery += "ACQ_CODREG = ACR_CODREG AND "
					cQuery += "ACQ.D_E_L_E_T_ = ' '  AND ACR.D_E_L_E_T_ = ' '"

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACRB")
						cQuery := ExecBlock("HEXPACRB", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "ACR.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCR.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCR")+" HCR "
					cNoQuery += "WHERE "
					cNoQuery += "HCR.R_E_C_N_O_ = ACR.R_E_C_N_O_ AND "
					cNoQuery += "HCR.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCR",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCR")	

						cUpdate := "FROM "+RetSqlName("ACR")+" ACR "
						cUpdate += "WHERE "
						cUpdate += "HCR_FILIAL = ACR.ACR_FILIAL AND "
						cUpdate += "HCR_ID = '" + cId + "' AND "
						cUpdate += "HCR_CODREG = ACR.ACR_CODREG AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[02])-1
							cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" OR "
						Next nX
						cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[02])
						cSelect += aDados[02][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACR.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCR")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACR.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCR")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACR.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCR")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[02])
						cInsert += aDados[02][nX][1]+","	
					Next nX
					cInsert += "HCR_INTR,"
					cInsert += "HCR_VER,"
					cInsert += "HCR_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCR")+" "
						cDelUpd  += "SET HCR_INTR = 'E',HCR_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACR.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACR")+" ACR "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACR.R_E_C_N_O_ AND "
						cDelUpd  += "ACR.D_E_L_E_T_=' ' ) AND HCR_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
	
					EndIf					
					Begin Transaction
						HHExcGenDel("HCR")
						HHUpdCtr(cID,"HCR")	
					End Transaction			
					UnLockByName("HHEXP_ACR"+cID,.T.,!Empty(xFilial("HCR")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACR)
			(cAliasACR)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACR"))
				While !(cAliasACR)->(Eof()) .And. (cAliasACR)->ACR_FILIAL == xFilial("ACR")
					Begin Transaction
						dbSelectArea("HCR")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACR") + cId + (cAliasACR)->ACR_CODREG + (cAliasACR)->ACR_ITEM)
							RecLock("HCR", .T.)
						Else
							RecLock("HCR", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[02])
							HCR->(FieldPut(HCR->(FieldPos(aDados[02][nX][1])),(cAliasACR)->(FieldGet(FieldPos(aDados[02][nX][2])))))
						Next nX
						HCR->HCR_ID     := cId
						HCR->HCR_INTR   := cIntr
						HCR->HCR_VER    := 1
					End Transaction
					(cAliasACR)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCR")	
			Else 	
				Begin Transaction
					dbSelectArea("HCR")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACR") + cId + ACR->ACR_CODREG + (cAliasACR)->ACR_ITEM)
						RecLock("HCR", .T.)
					Else
						RecLock("HCR", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCR",HCR->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCR")	
					For nX := 1 To Len(aDados[02])
						HCR->(FieldPut(HCR->(FieldPos(aDados[02][nX][1])),(cAliasACR)->(FieldGet(FieldPos(aDados[02][nX][2])))))
					Next nX
					HCR->HCR_ID     := cId
					HCR->HCR_VER    := nVersao
					HCR->HCR_INTR   := cIntr	
					HHUpdCtr(cID,"HCR")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPACQ")==0
		aadd(aJobGlobal,"HHEXPACQ")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaACQ)
RestArea(aAreaACR)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACR  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACR                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACR(cCpo,nOper)

DEFAULT cCpo    := ""
DEFAULT nOper   := 0

Return HHEXPACQ(cCpo,nOper)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACS  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACS                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACS(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaACS    := ACS->(GetArea())
Local aAreaACT    := ACT->(GetArea())
Local nX          := 1
Local cId         := HHCheckID("HCS","ACS")
Local cAliasACS   := "ACS"
Local cAliasACT   := "ACT"
Local aJobGlobal  := {}
Local aDados      := Array(2)
Local cIntr   := "I"
Local nVersao := 1
Local cDelUpd	:= ""
#IFDEF TOP
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cQuery      := ""
Local cUpdate     := ""
Local cNoQuery    := ""
#ENDIF
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPACS")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		//Cabecalhos das Regras de Negocio
		aDados[01] := {}
		aadd(aDados[01],{"HCS_FILIAL","ACS_FILIAL"})
		aadd(aDados[01],{"HCS_CODREG","ACS_CODREG"})
		aadd(aDados[01],{"HCS_DESCRI","ACS_DESCRI"})
		aadd(aDados[01],{"HCS_CODCLI","ACS_CODCLI"})
		aadd(aDados[01],{"HCS_LOJA  ","ACS_LOJA  "})
		aadd(aDados[01],{"HCS_GRPVEN","ACS_GRPVEN"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACSA")
			aDados[01] := ExecBlock("HEXPACSA", .F., .F., {aDados[01]})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("ACS")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACS"+cID,.T.,!Empty(xFilial("ACS")),.T.)	
					dbSelectArea("ACS")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACS") + " ACS "
					cQuery += "WHERE "
					cQuery += "ACS.ACS_FILIAL = '" + xFilial("ACS") + "' AND "
					//Validacao caso queira filtrar as regras para os clientes de um vendedor especifico.
					//				cQuery += "(ACS_CODCLI IN (SELECT A1_COD FROM SA1010 SA1 WHERE "
					//				cQuery += "A1_FILIAL =  '" + xFilial("SA1") + "' AND A1_VEND = '" + cId + "' AND SA1.D_E_L_E_T_ = ' ' ) "
					//				cQuery += "OR ACS_CODCLI = '" + Space(Len(SA1->A1_COD)) + "'	) AND "
					cQuery += "ACS.D_E_L_E_T_ = ' ' "
					
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACSB")
						cQuery := ExecBlock("HEXPACSB", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "ACS.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCS.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCS")+" HCS "
					cNoQuery += "WHERE "
					cNoQuery += "HCS.R_E_C_N_O_ = ACS.R_E_C_N_O_ AND "
					cNoQuery += "HCS.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCS",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCS")	

						cUpdate := "FROM "+RetSqlName("ACS")+" ACS "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = ACS.R_E_C_N_O_  AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[01])-1
							cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" OR "
						Next nX
						cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[01])
						cSelect += aDados[01][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACS.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCS")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACS.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCS")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACS.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCS")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[01])
						cInsert += aDados[01][nX][1]+","	
					Next nX
					cInsert += "HCS_INTR,"
					cInsert += "HCS_VER,"
					cInsert += "HCS_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCS")+" "
						cDelUpd  += "SET HCS_INTR = 'E',HCS_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACS.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACS")+" ACS "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACS.R_E_C_N_O_ AND "
						cDelUpd  += "ACS.D_E_L_E_T_=' ' ) AND HCS_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

					EndIf
					Begin Transaction
						HHExcGenDel("HCS")
						HHUpdCtr(cID,"HCS")	
					End Transaction
					UnLockByName("HHEXP_ACS"+cID,.T.,!Empty(xFilial("HCS")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACS)
			(cAliasACS)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACS"))
				While !(cAliasACS)->(Eof()) .And. (cAliasACS)->ACS_FILIAL == xFilial("ACS")
					Begin Transaction
						dbSelectArea("HCS")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACS") + cId + (cAliasACS)->ACS_CODREG)
							RecLock("HCS", .T.)
						Else
							RecLock("HCS", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[01])
							HCS->(FieldPut(HCS->(FieldPos(aDados[01][nX][1])),(cAliasACS)->(FieldGet(FieldPos(aDados[01][nX][2])))))
						Next nX
						HCS->HCS_ID     := cId
						HCS->HCS_INTR   := cIntr
						HCS->HCS_VER    := 1
					End Transaction
					(cAliasACS)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCS")	
			Else 	
				Begin Transaction
					dbSelectArea("HCS")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACS") + cId + ACS->ACS_CODREG)
						RecLock("HCS", .T.)
					Else
						RecLock("HCS", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCS",HCS->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCS")	
					For nX := 1 To Len(aDados[01])
						HCS->(FieldPut(HCS->(FieldPos(aDados[01][nX][1])),(cAliasACS)->(FieldGet(FieldPos(aDados[01][nX][2])))))
					Next nX
					HCS->HCS_ID     := cId
					HCS->HCS_VER    := nVersao
					HCS->HCS_INTR   := cIntr

					HHUpdCtr(cID,"HCS")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды

		//Itens das Regras de Negocio
		aDados[02] := {}
		aadd(aDados[02],{"HCT_FILIAL","ACT_FILIAL"})
		aadd(aDados[02],{"HCT_CODREG","ACT_CODREG"})
		aadd(aDados[02],{"HCT_ITEM  ","ACT_ITEM  "})
		aadd(aDados[02],{"HCT_CODTAB","ACT_CODTAB"})
		aadd(aDados[02],{"HCT_CONDPG","ACT_CONDPG"})
		aadd(aDados[02],{"HCT_FORMPG","ACT_FORMPG"})
		aadd(aDados[02],{"HCT_TPRGNG","ACT_TPRGNG"})

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACTA")
			aDados[02] := ExecBlock("HEXPACTA", .F., .F., {aDados[02]})
		EndIf

		dbSelectArea("ACT")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACT"+cID,.T.,!Empty(xFilial("ACT")),.T.)	
					dbSelectArea("ACT")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACS") + " ACS , " + RetSqlName("ACT") + " ACT "
					cQuery += "WHERE "
					cQuery += "ACS.ACS_FILIAL = '" + xFilial("ACS") + "' AND "
					cQuery += "ACT.ACT_FILIAL = '" + xFilial("ACT") + "' AND "
					cQuery += "ACS_CODREG = ACT_CODREG AND "
					//Validacao caso queira filtrar as regras para os clientes de um vendedor especifico.
					//				cQuery += "(ACS_CODCLI IN (SELECT A1_COD FROM SA1010 SA1 WHERE "
					//				cQuery += "A1_FILIAL =  '" + xFilial("SA1") + "' AND A1_VEND = '" + cId + "' AND SA1.D_E_L_E_T_ = ' ' ) "
					//				cQuery += "OR ACS_CODCLI = '" + Space(Len(SA1->A1_COD)) + "'	) AND "
					cQuery += "ACS.D_E_L_E_T_ = ' '  AND ACT.D_E_L_E_T_ = ' '"

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACTB")
						cQuery := ExecBlock("HEXPACTB", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "ACT.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCT.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCT")+" HCT "
					cNoQuery += "WHERE "
					cNoQuery += "HCT.R_E_C_N_O_ = ACT.R_E_C_N_O_ AND "
					cNoQuery += "HCT.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCT",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCT")	

						cUpdate := "FROM "+RetSqlName("ACT")+" ACT "
						cUpdate += "WHERE "
						cUpdate += "HCT_FILIAL = ACT.ACT_FILIAL AND "
						cUpdate += "HCT_ID = '" + cId + "' AND "
						cUpdate += "HCT_CODREG = ACT.ACT_CODREG AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[02])-1
							cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" OR "
						Next nX
						cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[02])
						cSelect += aDados[02][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACT.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCT")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACT.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCT")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACT.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCT")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[02])
						cInsert += aDados[02][nX][1]+","	
					Next nX
					cInsert += "HCT_INTR,"
					cInsert += "HCT_VER,"
					cInsert += "HCT_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery
					
					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-5): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
					
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HCT")+" "
						cDelUpd  += "SET HCT_INTR = 'E',HCT_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT ACT.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("ACT")+" ACT "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = ACT.R_E_C_N_O_ AND "
						cDelUpd  += "ACT.D_E_L_E_T_=' ' ) AND HCT_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-6): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf

					EndIf
					Begin Transaction
						HHExcGenDel("HCT")
						HHUpdCtr(cID,"HCT")	
					End Transaction			
					UnLockByName("HHEXP_ACT"+cID,.T.,!Empty(xFilial("HCT")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACT)
			(cAliasACT)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACT"))
				While !(cAliasACT)->(Eof()) .And. (cAliasACT)->ACT_FILIAL == xFilial("ACT")
					Begin Transaction
						dbSelectArea("HCT")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACT") + cId + (cAliasACT)->ACT_CODREG + (cAliasACT)->ACT_ITEM)
							RecLock("HCT", .T.)
						Else
							RecLock("HCT", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[02])
							HCT->(FieldPut(HCT->(FieldPos(aDados[02][nX][1])),(cAliasACT)->(FieldGet(FieldPos(aDados[02][nX][2])))))
						Next nX
						HCT->HCT_ID     := cId
						HCT->HCT_INTR   := cIntr
						HCT->HCT_VER    := 1
					End Transaction
					(cAliasACT)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCT")	
			Else 	
				Begin Transaction
					dbSelectArea("HCT")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACT") + cId + ACT->ACT_CODREG + (cAliasACT)->ACT_ITEM)
						RecLock("HCT", .T.)
					Else
						RecLock("HCT", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCT",HCT->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCT")	
					For nX := 1 To Len(aDados[02])
						HCT->(FieldPut(HCT->(FieldPos(aDados[02][nX][1])),(cAliasACT)->(FieldGet(FieldPos(aDados[02][nX][2])))))
					Next nX
					HCT->HCT_ID     := cId
					HCT->HCT_VER    := nVersao
					HCT->HCT_INTR   := cIntr	
					HHUpdCtr(cID,"HCT")	
				End Transaction
			EndIf		
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPACS")==0
		aadd(aJobGlobal,"HHEXPACS")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaACS)
RestArea(aAreaACT)
RestArea(aArea)
Return(cID)
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACT  Ё Autor ЁEduardo Riera          Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACT                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACT(cCpo,nOper)

DEFAULT cCpo    := ""
DEFAULT nOper   := 0

Return HHEXPACS(cCpo,nOper)


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPSA5  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - SA5                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPSA5(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaSA5    := SA5->(GetArea())
Local nX          := 1
Local cId         := HHCheckID("HA5")
Local cAliasSA5   := "HA5"
Local aDados      := {}
Local aJobGlobal  := {}
Local cIntr   := "I"
Local nVersao := 1
#IFDEF TOP
Local cInsert     := ""
Local cDelete     := ""
Local cQuery      := ""
Local cNoQuery    := ""
Local cSelect     := ""
Local cUpdate     := ""
Local cOpConcat	  := Iif("MSSQL"$Upper(TCGetDB()),"+","||")

#ENDIF                           
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPSA5")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf

	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aadd(aDados,{"HA5_FILIAL","A5_FILIAL "})
		aadd(aDados,{"HA5_PRODUT","A5_PRODUTO"})
		aadd(aDados,{"HA5_CODPRF","A5_CODPRF "})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPSA5A")
			aDados := ExecBlock("HEXPSA5A", .F., .F., {aDados})
		EndIf
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Clientes                      Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SA5")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de duplicatas.                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_SA5"+cID,.T.,!Empty(xFilial("HA5")),.T.)	
					dbSelectArea("SA5")
					dbCommit()

					cQuery += "FROM " + RetSqlName("SA5") + " SA5 "
					cQuery += "WHERE "
					cQuery += "SA5.A5_FILIAL = '" + xFilial("SA5") + "' AND "
					cQuery += "A5_CODPRF <> '"+Space(Len(SA5->A5_CODPRF))+"' AND "
					cQuery += "SA5.D_E_L_E_T_ = ' ' "

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPSA5B")
						cQuery := ExecBlock("HEXPSA5B", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "SA5.A5_FILIAL"+cOpConcat+"SA5.A5_CODPRF"+cOpConcat+"SA5.A5_PRODUTO NOT IN ("
					cNoQuery += "SELECT HA5.HA5_FILIAL"+cOpConcat+"HA5.HA5_CODPRF"+cOpConcat+"HA5.HA5_PRODUT "
					cNoQuery += "FROM "+RetSqlName("HA5")+" HA5 "
					cNoQuery += "WHERE "
					cNoQuery += "HA5.HA5_FILIAL='" + xFilial("HA5") + "' AND "
					cNoQuery += "HA5.D_E_L_E_T_ = ' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HA5",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HA5")	

						cUpdate := "FROM "+RetSqlName("SA5")+" SA5 "
						cUpdate += "WHERE "
						cUpdate += "HA5_FILIAL = SA5.A5_FILIAL AND  "
						cUpdate += "HA5_PRODUT = SA5.A5_PRODUTO AND "
						cUpdate += "HA5_CODPRF <> SA5.A5_CODPRF AND  "
						cUpdate += "SA5.A5_CODPRF <> '' "						

					EndIf

					cSelect := "SELECT DISTINCT "
					For nX := 1 To Len(aDados)
						cSelect += aDados[nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "( SELECT MAX(SA5MAX.R_E_C_N_O_) "
					cSelect += "FROM " + RetSqlName("SA5") + " SA5MAX "
					cSelect += "WHERE SA5.A5_FILIAL = SA5MAX.A5_FILIAL AND "
					cSelect += "SA5.A5_CODPRF = SA5MAX.A5_CODPRF AND "
					cSelect += "SA5.A5_PRODUTO = SA5MAX.A5_PRODUTO ) "
					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HA5")+" "
						cDelete += "WHERE "
						cDelete += "HA5_FILIAL"+cOpConcat+"HA5_PRODUT IN( "
						cDelete += "SELECT A5_FILIAL"+cOpConcat+"A5_PRODUTO "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HA5")+" "
						cDelete += "WHERE "
						cDelete += "HA5_FILIAL"+cOpConcat+"HA5_PRODUT IN( "
						cDelete += "SELECT A5_FILIAL"+cOpConcat+"A5_PRODUTO "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HA5")+" "
					cInsert += "("
					For nX := 1 To Len(aDados)
						cInsert += aDados[nX][1]+","	
					Next nX
					cInsert += "HA5_INTR,"
					cInsert += "HA5_VER,"
					cInsert += "HA5_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
                    
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nOper <> 0
						cDelUpd  := "UPDATE "+RetSqlName("HA5")+" "
						cDelUpd  += "SET HA5_INTR = 'E',HA5_VER="+Str(nVersao,10)+" "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ NOT IN ("
						cDelUpd  += "SELECT SA5.R_E_C_N_O_ "
						cDelUpd  += "FROM "+RetSqlName("SA5")+" SA5 "
						cDelUpd  += "WHERE "
						cDelUpd  += "R_E_C_N_O_ = SA5.R_E_C_N_O_ AND "
						cDelUpd  += "SA5.D_E_L_E_T_ = ' ' ) AND HA5_INTR <> 'E' "

						__HHLogTime := PText2Sec(Time())
						nRetSql := 	TcSqlExec(cDelUpd)
		
						If __HHLog >= 1
							__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
							__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
							If nRetSql != 0 .And. __HHLog == 9
								__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
							EndIf
							__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
							GravaHHLog(__HHLogMsg)
						EndIf
					EndIf
					Begin Transaction
						HHExcGenDel("HA5")
						HHUpdCtr(cID,"HA5")	
					End Transaction			
					UnLockByName("HHEXP_SA5"+cID,.T.,!Empty(xFilial("HA5")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasSA5)
			(cAliasSA5)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("SA5")+cTabela)
				While !(cAliasSA5)->(Eof()) .And. (cAliasSA5)->A5_FILIAL == xFilial("SA5")
					Begin Transaction
						dbSelectArea("HA5")
						dbSetOrder(1)
						If !dbSeek(xFilial("SA5") + cId + (cAliasSA5)->A5_COD + (cAliasSA5)->A5_LOJA)
							RecLock("HA5", .T.)
						Else
							RecLock("HA5", .F.)
						EndIf  	
						For nX := 1 To Len(aDados)
							HA5->(FieldPut(HA5->(FieldPos(aDados[nX][1])),(cAliasSA5)->(FieldGet(FieldPos(aDados[nX][2])))))
						Next nX
						HA5->HA5_ID     := cId
						HA5->HA5_INTR   := cIntr
						HA5->HA5_VER    := 1
					End Transaction
					(cAliasSA5)->(dbSkip())
				EndDo
				HHUpdCA5(cID,"HA5")	
			Else 	
				Begin Transaction
					dbSelectArea("HA5")
					dbSetOrder(1)
					If !dbSeek(xFilial("SA5") + cId + (cAliasSA5)->A5_COD + (cAliasSA5))
						RecLock("HA5", .T.)
					Else
						RecLock("HA5", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HA5",HA5->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HA5")	
					For nX := 1 To Len(aDados)
						HA5->(FieldPut(HA5->(FieldPos(aDados[nX][1])),(cAliasSA5)->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HA5->HA5_ID     := cId
					HA5->HA5_VER    := nVersao
					HA5->HA5_INTR   := cIntr

					HHUpdCtr(cID,"HA5")	
				End Transaction
			EndIf		
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPSA5")==0
		aadd(aJobGlobal,"HHEXPSA5")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaSA5)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPACU  Ё Autor ЁRodrigo de A. Godinho  Ё Data Ё08/12/05  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - ACU                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPACU(cCpo,nOper)

Local aArea       := GetArea()
Local aAreaACU    := ACU->(GetArea())
Local aAreaACV    := ACV->(GetArea())
Local nX          := 1
Local cId         := HHCheckID("HCU","ACU")
Local cAliasACU   := "ACU"
Local cAliasACV   := "ACV"
Local aJobGlobal  := {}
Local aDados      := Array(2)
Local cIntr   := "I"
Local nVersao := 1
#IFDEF TOP
Local cInsert     := ""
Local cDelete     := ""
Local cSelect     := ""
Local cQuery      := ""
Local cUpdate     := ""
Local cNoQuery    := ""
#ENDIF                    
Local nStatusTrg := Val(GetSrvProfString("HHTriggerOn","0"))
Local nRetSql  	:= 0
Local cFuncName   := ProcName()

DEFAULT cCpo  		:= ""
DEFAULT nOper 		:= 0

GetGlbVars("HHJOBPVAR",aJobGlobal)
DEFAULT aJobGlobal := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se a execucao ja foi realizada no job.                                  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( aScan(aJobGlobal,"HHEXPACU")==0 .Or. nOper > 0 .Or. nStatusTrg == 0) .And. nOper >= 0
	If Empty(cCpo) .And. !Empty(cId)
		cId := HGU->HGU_CODBAS
	EndIf
	If !cId == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o relacionamento dos campos e tabelas        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		//Cabecalhos das Regras de Negocio
		aDados[01] := {}
		aadd(aDados[01],{"HCU_FILIAL","ACU_FILIAL"})
		aadd(aDados[01],{"HCU_COD   ","ACU_COD   "})
		aadd(aDados[01],{"HCU_DESC  ","ACU_DESC  "})
		aadd(aDados[01],{"HCU_CODPAI","ACU_CODPAI"})

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACUA")
			aDados[01] := ExecBlock("HEXPACUA", .F., .F., {aDados[01]})
		EndIf

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("ACU")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACU"+cID,.T.,!Empty(xFilial("ACU")),.T.)	
					dbSelectArea("ACU")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACU") + " ACU "
					cQuery += "WHERE "
					cQuery += "ACU.ACU_FILIAL = '" + xFilial("ACU") + "' AND "
					cQuery += "ACU.D_E_L_E_T_ = ' ' "
					
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACUB")
						cQuery := ExecBlock("HEXPACUB", .F., .F., {cQuery})
					EndIf

					cNoQuery := " AND "
					cNoQuery += "ACU.R_E_C_N_O_ NOT IN ("
					cNoQuery += "SELECT HCU.R_E_C_N_O_ "
					cNoQuery += "FROM "+RetSqlName("HCU")+" HCU "
					cNoQuery += "WHERE "
					cNoQuery += "HCU.HCU_FILIAL='" + xFilial("HCU") + "' AND "
					cNoQuery += "HCU.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCU",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCU")	

						cUpdate := "FROM "+RetSqlName("ACU")+" ACU "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = ACU.R_E_C_N_O_ AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[01])-1
							cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" OR "
						Next nX
						cUpdate += aDados[01][nX][1]+" <> "+aDados[01][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[01])
						cSelect += aDados[01][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACU.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCU")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACU.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCU")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACU.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCU")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[01])
						cInsert += aDados[01][nX][1]+","	
					Next nX
					cInsert += "HCU_INTR,"
					cInsert += "HCU_VER,"
					cInsert += "HCU_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					Begin Transaction
						HHExcGenDel("HCU")
						HHUpdCtr(cID,"HCU")	
					End Transaction			
					UnLockByName("HHEXP_ACU"+cID,.T.,!Empty(xFilial("HCU")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACU)
			(cAliasACU)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACU"))
				While !(cAliasACU)->(Eof()) .And. (cAliasACU)->ACU_FILIAL == xFilial("ACU")
					Begin Transaction
						dbSelectArea("HCU")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACU") + cId + (cAliasACU)->ACU_COD)
							RecLock("HCU", .T.)
						Else
							RecLock("HCU", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[01])
							HCU->(FieldPut(HCU->(FieldPos(aDados[01][nX][1])),(cAliasACU)->(FieldGet(FieldPos(aDados[01][nX][2])))))
						Next nX
						HCU->HCU_ID     := cId
						HCU->HCU_INTR   := cIntr
						HCU->HCU_VER    := 1
					End Transaction
					(cAliasACU)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCU")	
			Else 	
				Begin Transaction
					dbSelectArea("HCU")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACU") + cId + ACU->ACU_CODREG)
						RecLock("HCU", .T.)
					Else
						RecLock("HCU", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCU",HCU->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCU")	
					For nX := 1 To Len(aDados[01])
						HCU->(FieldPut(HCU->(FieldPos(aDados[01][nX][1])),(cAliasACU)->(FieldGet(FieldPos(aDados[01][nX][2])))))
					Next nX
					HCU->HCU_ID     := cId
					HCU->HCU_VER    := nVersao
					HCU->HCU_INTR   := cIntr

					HHUpdCtr(cID,"HCU")	
				End Transaction
			EndIf
			#IFDEF TOP
			EndIf
			#ENDIF

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁExportaГЦo da tabela de Regras                        Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aDados[02] := {}
		aadd(aDados[02],{"HCV_FILIAL","ACV_FILIAL"})
		aadd(aDados[02],{"HCV_CATEGO","ACV_CATEGO"})
		aadd(aDados[02],{"HCV_GRUPO ","ACV_GRUPO "})
		aadd(aDados[02],{"HCV_CODPRO","ACV_CODPRO"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPonto de Entrada para inclusao de campos no servico    Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If ExistBlock("HEXPACVA")
			aDados[02] := ExecBlock("HEXPACVA", .F., .F., {aDados[02]})
		EndIf

		dbSelectArea("ACV")
		dbSetOrder(1)
		#IFDEF TOP
			If GetNewPar("MV_HHOPT",.T.)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁExportaГЦo da tabela de Regras    .                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If LockByName("HHEXP_ACV"+cID,.T.,!Empty(xFilial("ACV")),.T.)	
					dbSelectArea("ACV")
					dbCommit()

					cQuery := "FROM " + RetSqlName("ACU") + " ACU , " + RetSqlName("ACV") + " ACV "
					cQuery += "WHERE "
					cQuery += "ACU.ACU_FILIAL = '" + xFilial("ACU") + "' AND "
					cQuery += "ACV.ACV_FILIAL = '" + xFilial("ACV") + "' AND "
					cQuery += "ACU_COD = ACV_CATEGO AND "
					cQuery += "ACU.D_E_L_E_T_ = ' '  AND ACV.D_E_L_E_T_ = ' '"

					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁPonto de Entrada para complementar o filtro do servico    Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If ExistBlock("HEXPACVB")
						cQuery := ExecBlock("HEXPACVB", .F., .F., {cQuery})
					EndIf
					
					cNoQuery := " AND "
					cNoQuery += "NOT EXISTS ("
					cNoQuery += "SELECT HCV_FILIAL "
					cNoQuery += "FROM "+RetSqlName("HCV")+" HCV "
					cNoQuery += "WHERE "
					cNoQuery += "HCV.HCV_FILIAL='" + xFilial("HCV") + "' AND "
					cNoQuery += "HCV.D_E_L_E_T_=' ' ) "

					If nOper <> 0

						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁAnalisa a instrucao e versao do registro                                         Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						cIntr := HHChkIntr(nOper,"HCV",.T.)
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//ЁObtem a prСxima versao do registro                                               Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
						nVersao := HHNextVer(cID,"HCV")	

						cUpdate := "FROM "+RetSqlName("ACV")+" ACV "
						cUpdate += "WHERE "
						cUpdate += "R_E_C_N_O_ = ACV.R_E_C_N_O_ AND "
						cUpdate += "("
						For nX := 1 To Len(aDados[02])-1
							cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" OR "
						Next nX
						cUpdate += aDados[02][nX][1]+" <> "+aDados[02][nX][2]+" ) "

					EndIf

					cSelect := "SELECT "
					For nX := 1 To Len(aDados[02])
						cSelect += aDados[02][nX][2]+","
					Next nX		
					cSelect += "'"+cIntr+"',"
					cSelect += Str(nVersao,10)+","
					cSelect += "'"+cId+"',"
					cSelect += "ACV.R_E_C_N_O_ "

					If nOper == 0

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCV")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACV.R_E_C_N_O_ "
						cDelete += cQuery
						cDelete += ")"

					Else

						cDelete := "DELETE "
						cDelete += "FROM "+RetSqlName("HCV")+" "
						cDelete += "WHERE "
						cDelete += "R_E_C_N_O_ IN ("
						cDelete += "SELECT ACV.R_E_C_N_O_ "
						cDelete += cUpdate
						cDelete += ")"

					EndIf

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cDelete)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					cInsert := "INSERT INTO "
					cInsert += RetSqlName("HCV")+" "
					cInsert += "("
					For nX := 1 To Len(aDados[02])
						cInsert += aDados[02][nX][1]+","	
					Next nX
					cInsert += "HCV_INTR,"
					cInsert += "HCV_VER,"
					cInsert += "HCV_ID,"
					cInsert += "R_E_C_N_O_"
					cInsert += ") "
					cInsert += cSelect
					cInsert += cQuery
					cInsert += cNoQuery

					__HHLogTime := PText2Sec(Time())
					nRetSql := 	TcSqlExec(cInsert)
	
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-4): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf

					Begin Transaction
						HHExcGenDel("HCV")
						HHUpdCtr(cID,"HCV")	
					End Transaction
					UnLockByName("HHEXP_ACV"+cID,.T.,!Empty(xFilial("HCV")),.T.)
				EndIf				
			Else
		#ENDIF
			dbSelectArea(cAliasACT)
			(cAliasACT)->(dbSetOrder(1))
			If nOper == 0
				MsSeek(xFilial("ACV"))
				While !(cAliasACT)->(Eof()) .And. (cAliasACT)->ACT_FILIAL == xFilial("ACV")
					Begin Transaction
						dbSelectArea("HCV")
						dbSetOrder(1)
						If !dbSeek(xFilial("ACV") + cId + (cAliasACV)->ACV_COD + (cAliasACT)->ACT_ITEM)
							RecLock("HCV", .T.)
						Else
							RecLock("HCV", .F.)
						EndIf  	
						For nX := 1 To Len(aDados[02])
							HCV->(FieldPut(HCV->(FieldPos(aDados[02][nX][1])),(cAliasACV)->(FieldGet(FieldPos(aDados[02][nX][2])))))
						Next nX
						HCV->HCV_ID     := cId
						HCV->HCV_INTR   := cIntr
						HCV->HCV_VER    := 1
					End Transaction
					(cAliasACV)->(dbSkip())
				EndDo
				HHUpdCtr(cID,"HCV")	
			Else 	
				Begin Transaction
					dbSelectArea("HCV")
					dbSetOrder(1)
					If !dbSeek(xFilial("ACV") + cId + ACT->ACT_CODREG + (cAliasACT)->ACT_ITEM)
						RecLock("HCV", .T.)
					Else
						RecLock("HCV", .F.)
					EndIf  	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HCV",HCT->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HCV")	
					For nX := 1 To Len(aDados[02])
						HCV->(FieldPut(HCV->(FieldPos(aDados[02][nX][1])),(cAliasACV)->(FieldGet(FieldPos(aDados[02][nX][2])))))
					Next nX
					HCV->HCV_ID     := cId
					HCV->HCV_VER    := nVersao
					HCV->HCV_INTR   := cIntr	
					HHUpdCtr(cID,"HCV")	
				End Transaction
			EndIf		
			#IFDEF TOP
			EndIf
			#ENDIF
	EndIf
	If aScan(aJobGlobal,"HHEXPACU")==0
		aadd(aJobGlobal,"HHEXPACU")
		PutGlbVars("HHJOBPVAR",aJobGlobal)
	EndIf
EndIf
RestArea(aAreaACU)
RestArea(aAreaACV)
RestArea(aArea)
Return(cID)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммяммммммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨FuncaoЁHHAtuVendClie ╨Autor  ЁRodrigo de A Godinho╨ Data Ё  03/31/06   ╨╠╠
╠╠лммммммьммммммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc. ЁEsta funcao vai recuperar o hustorico do cliente quando houver  ╨╠╠
╠╠╨      Ёalteracao de vendedor do cliente.                               ╨╠╠
╠╠лммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso   Ё                                                                ╨╠╠
╠╠хммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function HHAtuVendClie(cVendNovo,cVendAnt,cCliente,cLoja)

Local nI		:=	0
Local nJ		:=	0
Local aArea		:=	GetArea()
Local aAreaHGU	:=	HGU->(GetArea())
Local aVend		:=	{cVendAnt,cVendNovo}
Local aTabelas	:=	{"HA1","HC5","HC6","HE1"}
Local cTabela	:=	""
Local cEmpresa	:=	""
Local cAliasDel	:=	""
Local cQueryDel	:=	""
Local cFuncName := ProcName()
Local nRetSql   := 0

cEmpresa 		 := cEmpAnt
cAliasDel 		 := "HHCTR"

For nI := 1 to Len(aVend)

	dbSelectArea("HGU")
	HGU->(dbSetOrder(3))

    // Somente devera ser processado se o vendedor for localizado na tabela HGU (Grupo x HandHeld)
	If HGU->(dbSeek(aVend[nI]))
		For nJ := 1 to Len(aTabelas)
			cTabela  := RetSqlName(aTabelas[nJ])
			If MsFile(cTabela,,__cRdd)
				cQueryDel    := "DELETE FROM " + cTabela + " WHERE " + AllTrim(aTabelas[nJ]) + "_ID = '" + aVend[nI] + "'"
				//If HHT->HHT_FILEMP = "T"
				//	cQueryDel += " AND " + AllTrim(aTabelas[nJ]) + "_EMP = '" + cEmpresa + "'"
				//EndIf
				__HHLogTime := PText2Sec(Time())
				nRetSql := 	TcSqlExec(cQueryDel)
	
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cQueryDel + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
			EndIf
		Next

		HHExpSE1()
		HHExpSC5()
		HHEXPSA1()
		 
		For nJ := 1 to Len(aTabelas)
			cTabela  := RetSqlName(aTabelas[nJ])
			If MsFile(cTabela,,__cRdd)	
				//Query para deletar dados da HHCTR
				cQueryDel := "DELETE FROM " + cAliasDel + " WHERE USERID = '" + aVend[nI] + "' AND TABLENAME = '" + cTabela + "'"
				cQueryDel += " AND " + "EMP = '" + cEmpresa + "'"
				TCSqlExec(cQueryDel)
				//Recria os registros da tabela HHCTR
				PUpdHHCtr(aVend[nI], aTabelas[nJ], 0)
			EndIf
		Next
	Endif
Next
  
//Esse procedimento ja esta sendo feito na funcao PUpdHHCtr(funcao utilizada acima)
/*
For nI := 1 to Len(aTabelas)
	cTabela := RetSqlName(aTabelas[nI])
	dbSelectArea("HHT")
	dbSetOrder(2)
	If MsSeek(aTabelas[nI])
		If HHT->HHT_GEN == "2" // Tabela Nao Generica
			cSeek := cVendAnt + Space(Len(HHCTR->USERID)-Len(cVendAnt))+cTabela
			dbSelectArea("HHCTR")
			dbSetOrder(1)
		Else				  // Tabela Generica
			cSeek := cTabela
			dbSelectArea("HHCTR")
			dbSetOrder(2)
		EndIf			
		dbSelectArea("HHCTR")
		If MsSeek(cSeek)
			While !Eof() .And. IIf(HHT->HHT_GEN=="2",AllTrim(HHCTR->USERID) == AllTrim(cVendAnt),.T.) .And. AllTrim(HHCTR->TABLENAME) == AllTrim(cTabela)
				Begin Transaction
					RecLock("HHCTR")
					HHCTR->OPER       := "T"
					MsUnLock()
				End Transaction
				dbSelectArea("HHCTR")
				dbSkip()					
			EndDo
		EndIf
	EndIf 
Next
*/

HGU->(RestArea(aAreaHGU))
RestArea(aArea)

Return nil

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммяммммммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨FuncaoЁHHRstMobExp   ╨Autor  ЁRodrigo de A Godinho╨ Data Ё  03/31/06   ╨╠╠
╠╠лммммммьммммммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc. ЁEsta funcao vai limpar o array de controle das funcoes          ╨╠╠
╠╠╨      Ёexecutadas pelos servicos.                                      ╨╠╠
╠╠лммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso   Ё                                                                ╨╠╠
╠╠хммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function HHRstMobExp()
	PutGlbVars("HHJOBPVAR",nil)	
Return nil

/*

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммяммммммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨FuncaoЁHHExcGenDel   ╨Autor  ЁRodrigo de A Godinho╨ Data Ё  03/31/06   ╨╠╠
╠╠лммммммьммммммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc. ЁEsta funcao vai limpar os registros das tabelas espelho que     ╨╠╠
╠╠╨      Ёregistros com campo xxx_INTR = 'E' e ja foram sincronizados.    ╨╠╠
╠╠лммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso   ЁSFA                                                             ╨╠╠
╠╠хммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function HHExcGenDel(cAlias)

Local cQuery	:=	""
Local cTable	:= RetSqlName(cAlias)

Default cAlias	:=	""

#IFDEF TOP
	If GetNewPar("MV_HHOPT",.T.)
		cQuery := "DELETE FROM " + cTable + " "
		cQuery += "WHERE " + cAlias + "_VER <= "
		cQuery += "(SELECT MIN(VERSION) FROM HHCTR "
		cQuery += "WHERE TABLENAME = '" + cTable + "') AND "
		cQuery += cAlias + "_INTR = 'E' "
		TCSqlExec(cQuery)		
	Else
#ENDIF	
//Fazer em DBF
#IFDEF TOP
	EndIf
#ENDIF 

Return nil

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    ЁHHEXPAD7  Ё Autor Ё Liber De Esteban      Ё Data Ё02/01/07  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFuncao de sincronizaГЦo do HandHeld - AD7 - Roteirizacao    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁNenhum                                                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠Ё          Ё       [000] Update completo                                Ё╠╠
╠╠Ё          Ё       [064] Inclusao de registros                          Ё╠╠
╠╠Ё          Ё       [128] Alteracao de registros                         Ё╠╠
╠╠Ё          Ё       [256] Exclusao de registro                           Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function HHEXPAD7(cCpo,nOper)

Local aDow		:= {"Dom","Seg","Ter","Qua","Qui","Sex","Sab"}
Local dDataAnt	:= Date()
Local aArea		:= GetArea()
Local aAreaAD7	:= AD7->(GetArea())
Local aAreaHD7	:= HD7->(GetArea())
Local nX		:= 1
Local cId		:= HHCheckID("HD7","AD7")
Local cAliasAD7	:= "AD7"
Local cAliasHD7	:= "HD7"
Local cAliasHRT	:= "HRT"
Local aDados	:= {}
Local cIntr		:= HHChkIntr(nOper,"HD7",.T.)
Local nVersaoHD7	:= HHNextVer(cID,"HD7")
Local nVersaoHRT	:= HHNextVer(cID,"HRT")
Local cRota		:= ""
Local nVisAtu	:= 1
Local lApagaHRT:= .F.

DEFAULT cCpo 	:= ""
DEFAULT nOper	:= 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0 .And. !Empty((cAliasAD7)->AD7_CODCLI)

	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica o relacionamento dos campos e tabelas        Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aadd(aDados,{"HD7_FILIAL ","AD7_FILIAL"})
	aadd(aDados,{"HD7_CLI    ","AD7_CODCLI"})
	aadd(aDados,{"HD7_LOJA   ","AD7_LOJA"})
	aadd(aDados,{"HD7_DATA   ","AD7_DATA"})
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para inclusao de campos no servico    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPAD7A")
		aDados := ExecBlock("HEXPAD7A", .F., .F., {aDados})
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁExportaГЦo da tabela de Roteiro                       Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("AD7")
	dbSetOrder(1)
	dbSelectArea("HD7")
	dbSetOrder(1)
	/*
	Insercao via query sera implementada posteriormente
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁExportaГЦo da tabela de Roteiro.                      Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If LockByName("HHEXP_AD7",.T.,!Empty(xFilial("HD7")),.T.)
				dbSelectArea("AD7")
				dbCommit()

				cQuery := "FROM "+RetSqlName("AD7")+" AD7 "
				cQuery += "WHERE "
				cQuery += "AD7.AD7_FILIAL='" + xFilial("AD7") + "' AND "
				cQuery += "AD7.AD7_VEND = '" + cId + "' AND "
				cQuery += "AD7.AD7_CODCLI <> ' ' AND "
				cQuery += "AD7.D_E_L_E_T_ = ' ' "
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPAD7B")
					cQuery := ExecBlock("HEXPAD7B", .F., .F., {cQuery})
				EndIf
				
				cNoQuery := " AND "
				cNoQuery += "AD7.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HD7.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HD7")+" HD7 "
				cNoQuery += "WHERE "
				cNoQuery += "HD7_FILIAL='"+xFilial("HD7")+"' AND "
				cNoQuery += "HD7.D_E_L_E_T_ = ' ' ) "

				If nOper <> 0

					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HD7",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HD7")	

					cUpdate := "FROM "+RetSqlName("AD7")+" AD7 "
					cUpdate += "WHERE "
					cUpdate += "AD7.AD7_FILIAL='" + xFilial("AD7") + "' AND "
					cUpdate += "AD7.AD7_VEND = '" + cId + "' AND "
					cUpdate += "AD7.D_E_L_E_T_ = ' ' AND "
					cUpdate += "HD7_FILIAL='" + xFilial("HD7") + "' AND "
					cUpdate += "HD7_ID = '" + cID + "' AND "
					cUpdate += "HD7_DATA = AD7.AD7_DATA AND "
					cUpdate += "("
					For nX := 1 To Len(aDados)-1
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
					Next nX
					cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

				EndIf
				
				//Verifica Rota e grava HRT se necessario
				
				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX		
				cSelect += "'"+StrZero(nRotaAtu,6)+"',"
				cSelect += "'"+StrZero(nRotaAtu,6)+"',"
				cSelect += "'"+StrZero(nVisAtu,6)+"',"
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "R_E_C_N_O_ "

				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HD7")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ")

				Else

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HD7")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT AD7.R_E_C_N_O_ "
					cDelete += cUpdate
					cDelete += ")

				EndIf

				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cDelete)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HD7")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","	
				Next nX
				cInsert += "HD7_ROTA"
				cInsert += "HD7_PERCUR"
				cInsert += "HD7_ORDEM"
				cInsert += "HD7_INTR,"
				cInsert += "HD7_VER,"
				cInsert += "HD7_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery
 
				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cInsert)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If nOper <> 0
					cDelUpd  := "UPDATE "+RetSqlName("HD7")+" "
					cDelUpd  += "SET HD7_INTR = 'E',HD7_VER="+Str(nVersao,10)+" "
					cDelUpd  += "WHERE "
					cDelUpd  += "R_E_C_N_O_ NOT IN ("
					cDelUpd  += "SELECT AD7.R_E_C_N_O_ "
					cDelUpd  += cQuery
					cDelUpd  += ") AND "
					cDelUpd  += "HD7_ID = '"+cID+"' AND HD7_INTR <> 'E' "

					__HHLogTime := PText2Sec(Time())
					nRetSql := TcSqlExec(cDelUpd)
					If __HHLog >= 1
						__HHLogMsg := STR0002 + cFuncName + "-3): " + KB_ENTER
						__HHLogMsg += Space(__HHLogTab) + cDelUpd + KB_ENTER
						If nRetSql != 0 .And. __HHLog == 9
							__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
						EndIf
						__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
						GravaHHLog(__HHLogMsg)
					EndIf
				EndIf
				Begin Transaction
					HHExcGenDel("HD7")
					HHUpdCtr(cID,"HD7")	
				End Transaction			
			EndIf
			UnLockByName("HHEXP_AD7",.T.,!Empty(xFilial("HD7")),.T.)
		Else
	#ENDIF
	*/
		If nOper == 0
			dbSelectArea(cAliasAD7)
			(cAliasAD7)->(dbSetOrder(1))
			MsSeek(xFilial("AD7")+cId)
			nRota 	 := 0
			dDataAnt := STOD("")
			While !(cAliasAD7)->(Eof()) .And. (cAliasAD7)->AD7_FILIAL == xFilial("AD7") .And. (cAliasAD7)->AD7_VEND $ cId
				Begin Transaction
					If (cAliasAD7)->AD7_DATA <> dDataAnt  
						dbSelectArea("HRT")
						nRota++
						cRota := StrZero(nRota,6)
						nVisAtu  := 1
						dDataAnt := (cAliasAD7)->AD7_DATA
						RecLock("HRT",.T.)
						HRT->HRT_FILIAL	:= xFilial("AD7")
						HRT->HRT_ID		:= cId
						HRT->HRT_PERCUR	:= cRota
						HRT->HRT_ROTA	:= cRota
						HRT->HRT_DESCR	:= Dtoc(dDataAnt) + " - " +  aDow[Dow(dDataAnt)]
						HRT->HRT_VER	:= nVersaoHRT
						HRT->HRT_INTR	:= cIntr
						HRT->(MsUnlock())
					EndIf
					
					dbSelectArea("HD7")
					dbSetOrder(1)
					If !dbSeek(xFilial("HD7") + cId + cRota + cRota + StrZero(nVisAtu,6))
						RecLock("HD7", .T.)
					Else
						RecLock("HD7", .F.)
					EndIf
					HD7->HD7_FILIAL := xFilial("AD7")
					HD7->HD7_ID     := cId
					For nX := 1 To Len(aDados)
						HD7->(FieldPut(HD7->(FieldPos(aDados[nX][1])),(cAliasAD7)->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HD7->HD7_ROTA	:= cRota
					HD7->HD7_PERCUR	:= cRota
					HD7->HD7_DESPER	:= ""
					HD7->HD7_ORDEM	:= StrZero(nVisAtu,6)
					HD7->HD7_FLGVIS	:= "0"
					HD7->HD7_OCO	:= ""
					HD7->HD7_VER	:= nVersaoHD7
					HD7->HD7_INTR	:= cIntr
					HD7->(MsUnlock())
					nVisAtu += 1
					
					dbSelectArea(cAliasAD7)
					dbSkip()
					
				End Transaction
			EndDo
		ElseIf nOper == VM_DELETE
			(cAliasHD7)->(dbSetOrder(1))
			(cAliasHD7)->(dbGoTop())
			(cAliasAD7)->(dbSetOrder(2))
			While !(cAliasHD7)->(EOF()) .And. (cAliasHD7)->HD7_FILIAL == xFilial("HD7") .And. (cAliasHD7)->HD7_ID $ cId
				If !(cAliasAD7)->(dbSeek(xFilial("AD7")+(cAliasHD7)->HD7_CLI+(cAliasHD7)->HD7_LOJA+DToS((cAliasHD7)->HD7_DATA)))
			   	RecLock("HD7", .F.)
					HD7->HD7_INTR	:= cIntr
					HD7->HD7_VER	:= nVersaoHD7
					HD7->(MsUnlock())			   	
			   EndIf
				(cAliasHD7)->(dbSkip())
			End
			
			(cAliasHRT)->(dbSetOrder(1))
			(cAliasHRT)->(dbGoTop())
			While !(cAliasHRT)->(EOF()) .And. (cAliasHRT)->HRT_FILIAL == xFilial("HRT") .And. (cAliasHRT)->HRT_ID $ cId
				lApagaHRT := .T.
				If (cAliasHD7)->(dbSeek( xFilial("HD7")+cId+(cAliasHRT)->HRT_PERCUR+(cAliasHRT)->HRT_ROTA ))
					cRota := (cAliasHRT)->HRT_ROTA
					While !(cAliasHD7)->(EOF()) .And. (cAliasHD7)->HD7_FILIAL == xFilial("HD7") .And. (cAliasHD7)->HD7_ID $ cId .And. (cAliasHD7)->HD7_ROTA == cRota
						If HD7_INTR <> "E"
							lApagaHRT := .F.
							Exit
						EndIf
						(cAliasHD7)->(dbSkip())
					End
				EndIf
				If lApagaHRT
					RecLock("HRT", .F.)
					HRT->HRT_INTR	:= cIntr
					HRT->HRT_VER	:= nVersaoHRT
					HRT->(MsUnlock())
		   	EndIF
		   	(cAliasHRT)->(dbSkip())
			End
		Else
			dbSelectArea(cAliasAD7)
			(cAliasAD7)->(dbSetOrder(1))
			MsSeek(xFilial("AD7")+cId)
			nRota 	 := 0
			dDataAnt := STOD("")
			While !(cAliasAD7)->(Eof()) .And. (cAliasAD7)->AD7_FILIAL == xFilial("AD7") .And. (cAliasAD7)->AD7_VEND $ cId
				If Date() > (cAliasAD7)->AD7_DATA
					dbSkip()
					Loop
				EndIf
				Begin Transaction
					dData := (cAliasAD7)->AD7_DATA
					dbSelectArea("HD7")
					HD7->(dbSetOrder(3))
					If !dbSeek(xFilial("HD7")+cId+DTOS(dData)+(cAliasAD7)->AD7_CODCLI+(cAliasAD7)->AD7_LOJA) 
						If dbSeek(xFilial("HD7")+cId+DTOS(dData))
							cRota := HD7->HD7_ROTA
							While !HD7->(Eof()) .And. xFilial("HD7") == HD7->HD7_FILIAL .And. HD7->HD7_ID == cId .And. Dtos(HD7->HD7_DATA) == DTOS(dData)
								cOrdem	:= SOMA1(HD7->HD7_ORDEM)
								HD7->(dbSkip())
							End
						Else
							HD7->(dbSetOrder(1))
							HD7->(dbGobottom())
							cRota	:= SOMA1(HD7->HD7_ROTA)
							cOrdem	:= "000001"
							
						EndIf
						
						RecLock("HD7", .T.)
						lInclui := .T.
						
					Else
						cRota	:= HD7->HD7_ROTA
						cOrdem	:= HD7->HD7_ORDEM
						RecLock("HD7", .F.)
						lInclui := .F.
					EndIf
				//Grava HRT
					dbSelectArea("HRT")
					HRT->(dbSetOrder(1))
					If !dbSeek(xFilial("HRT")+cId+cRota)
						RecLock("HRT",.T.)
					Else
						RecLock("HRT",.F.)
					EndIf
					HRT->HRT_FILIAL	:= xFilial("AD7")
					HRT->HRT_ID		:= cId
					HRT->HRT_PERCUR	:= cRota
					HRT->HRT_ROTA	:= cRota
					HRT->HRT_DESCR	:= Dtoc(dData) + " - " +  aDow[Dow(dData)]
					HRT->HRT_VER	:= nVersaoHRT
					HRT->HRT_INTR	:= "I"
					HRT->(MsUnlock())
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HD7",HD7->(Found()))
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					HD7->HD7_FILIAL := xFilial("AD7")
					HD7->HD7_ID     := cId
					For nX := 1 To Len(aDados)
						HD7->(FieldPut(HD7->(FieldPos(aDados[nX][1])),(cAliasAD7)->(FieldGet(FieldPos(aDados[nX][2])))))
					Next nX
					HD7->HD7_ROTA	:= cRota
					HD7->HD7_PERCUR	:= cRota
					HD7->HD7_DESPER	:= ""
					HD7->HD7_ORDEM	:= cOrdem
					HD7->HD7_FLGVIS	:= "0"
					HD7->HD7_OCO	:= ""
					HD7->HD7_VER	:= nVersaoHD7
					HD7->HD7_INTR	:= cIntr
					HD7->(MsUnlock())                                          	 	
		
					dbSelectArea(cAliasAD7)
					dbSkip()

				End Transaction
		   
		   EndDo
		   (cAliasHD7)->(dbSetOrder(1))
			(cAliasHD7)->(dbGoTop())
			(cAliasAD7)->(dbSetOrder(2))
			While !(cAliasHD7)->(EOF()) .And. (cAliasHD7)->HD7_FILIAL == xFilial("HD7") .And. (cAliasHD7)->HD7_ID $ cId
				If !(cAliasAD7)->(dbSeek(xFilial("AD7")+(cAliasHD7)->HD7_CLI+(cAliasHD7)->HD7_LOJA+DToS((cAliasHD7)->HD7_DATA)))
			   	RecLock("HD7", .F.)
					HD7->HD7_INTR	:= "E"
					HD7->HD7_VER	:= nVersaoHD7
					HD7->(MsUnlock())			   	
			   EndIf
				(cAliasHD7)->(dbSkip())
			End
		EndIf
EndIf

HHUpdCtr(cID,"HD7")	
HHUpdCtr(cID,"HRT")	

RestArea(aAreaHD7)
RestArea(aAreaAD7)
RestArea(aArea)
Return(cID)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤ao    Ё XExpHMV  | Autor Ё Marcelo Vieira        Ё Data Ё 07/08/01 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤ao Ё Enviar mensagem da retaguarda para vendedor                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Integracao Palm                                            Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.             Ё╠╠
╠╠цддддддддддддбддддддддбддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁAnalista    Ё Data   ЁMotivo da Alteracao                              Ё╠╠
╠╠цддддддддддддеддддддддеддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё            Ё        Ё                                                 Ё╠╠
╠╠юддддддддддддаддддддддаддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function XEXPHMV()
Local cIntr		:= "I"
Local cId		:= HGU->HGU_CODBAS
Local cGrupo	:= HGU->HGU_GRUPO
Local cAliasMsg	:= GetMv("MV_TBLMSG",,"") 
Local cAliasHmv	:= cAliasMsg
Local cPrefixCpo := Subs(cAliasMsg,2,2)+"_"
Local aAreaHGU	:= HGU->(GetArea())
Local cQuery	:= ""
Local aStruTbl	:= {}
Local nX		:= 0
Local lQuery	:= .F.

If !Empty( cAliasMsg )
	dbSelectArea( cAliasMsg )
	dbGotop()
Else
	HMV->(dbCloseArea())
	ConOut(STR0006) // "PALMJOB: Servico de Mensagens, Alias de origem nЦo configurado. Verifica parБmetro MV_TBLMSG."
	Return
EndIf

#IFDEF TOP
	lQuery	  := .T.
	aStruTbl  := (cAliasMsg)->(dbStruct())
	cAliasHmv := "HHMSG"
	
	cQuery := "SELECT * FROM " + RetSqlName(cAliasMsg) + " WHERE "
	cQuery += cPrefixCpo + "ORIMSG = '1' AND "
	cQuery += "(" + cPrefixCpo + "DATAVIG = '" + Space(6) + "' OR " + cPrefixCpo + "DATAVIG >= '" + DtoS(dDataBase) + "') AND "
	cQuery += "(" + cPrefixCpo + "CODVEND = '" + Space(6) + "' OR " + cPrefixCpo + "CODVEND = '" + Alltrim(cId) + "')"
	
	cQuery += "ORDER BY " + SqlOrder((cAliasMsg)->(IndexKey()))
	
	cQuery := ChangeQuery(cQuery)
	
	Memowrite("HHmsg.txt", cQuery)	
	
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasHmv,.T.,.T.)
	
	For nX := 1 To Len(aStruTbl)
		If aStruTbl[nX][2]<>"C" .And. (cAliasMsg)->(FieldPos(aStruTbl[nX][1])>0)
			TcSetField(cAliasHmv,aStruTbl[nX][1],aStruTbl[nX][2],aStruTbl[nX][3],aStruTbl[nX][4])
	    EndIf
	Next nX
	
#ELSE

	cQuery += cPrefixCpo + "ORIMSG = '1' .AND. "
	cQuery += "(" + cPrefixCpo + "DATAVIG = '" + Space(6) + "' .OR. " + cPrefixCpo + "DATAVIG >= '" + DtoS(dDataBase) + "') .AND. "
	cQuery += "(" + cPrefixCpo + "CODVEND = '" + Space(6) + "' .OR. " + cPrefixCpo + "CODVEND = '" + Alltrim(cId) + "')"
	Set Filter To &cQuery
#ENDIF

While (cAliasHmv)->(!Eof())
	//Mensagem para todos os vendedores
	If Empty( (cAliasHmv)->&(cPrefixCpo+"CODVEND") )
		HGU->(dbSetOrder(1))
		HGU->(dbSeek(cGrupo))
		cId := HGU->HGU_CODBAS
	EndIf
	
	While !HGU->(EOF()) .And. cGrupo == HGU->HGU_GRUPO
	
		dbSelectArea("HMV")
		dbSetOrder(1)
		If !dbSeek(xFilial(cAliasHmv) + cId + (cAliasHmv)->&(cPrefixCpo+"CODMSG"))
			RecLock("HMV",.T.)
		Else
			RecLock("HMV",.F.)
		EndIf
		HMV->HMV_FILIAL := xFilial(cAliasHmv)
		HMV->HMV_ID		:= cId
		HMV->HMV_VEND	:= IiF(Empty( (cAliasHmv)->&(cPrefixCpo+"CODVEND") ), cId, (cAliasHmv)->&(cPrefixCpo+"CODVEND"))
		HMV->HMV_COD    := (cAliasHmv)->&(cPrefixCpo+"CODMSG")
		HMV->HMV_MSG    := (cAliasHmv)->&(cPrefixCpo+"MENSAGE")
		HMV->HMV_ORI    := (cAliasHmv)->&(cPrefixCpo+"ORIMSG")
		HMV->HMV_DATA   := (cAliasHmv)->&(cPrefixCpo+"DATAMSG")
		HMV->HMV_DTVIG  := (cAliasHmv)->&(cPrefixCpo+"DATAVIG")
		HMV->HMV_STATUS := ""
		HMV->HMV_INTR   := cIntr
		HMV->HMV_VER  	:= HHNextVer(cID,"HMV")	
		HMV->(MsUnlock())
		If !Empty( (cAliasHmv)->&(cPrefixCpo+"CODVEND") )
			Exit	
		EndIf
		HGU->(dbSkip())
		cId := HGU->HGU_CODBAS	
	End
	dbSelectArea(cAliasHmv)
	dbSkip()
EndDo
If lQuery
	(cAliasHmv)->(dbCloseArea())
EndIf
HGU->(RestArea(aAreaHGU))
Return

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤ao    Ё XExpHCF  Ё Autor Ё Fabio Garbin          Ё Data Ё 01/12/00 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤ao Ё Arquivo de Configuracoes.                                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Integracao Palm                                            Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.             Ё╠╠
╠╠цддддддддддддбддддддддбддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁAnalista    Ё Data   ЁMotivo da Alteracao                              Ё╠╠
╠╠цддддддддддддеддддддддеддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁM.Vieira    Ё24.09.02Ё Conversao para gerar bases para versao Eadvpl   Ё╠╠
╠╠юддддддддддддаддддддддаддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Function XEXPHCF()

Local aCfg      := {} // Estrutura do arquivo de Configuracoes
Local aCfgData  := {} // Contem os dados do arquivo de Configuracoes
Local aCfgUser	:= {}  // Parametros do usuario
Local aTab      := {} // 
Local aTiposcli := {}
Local aStrus    := {}
Local cTitulo   := ""
Local cTipo     := ""
Local nTam      := 0
Local nDec      := 0
Local i 		:= 1
Local ix 		:= 1
Local cIntr     := "I"
Local cId 		:= HHCheckID("HCF")
Local cValor 	:= ""
Local cParam 	:= ""
Local aParam	:= SFAllPar(2)
Local nX		:= 0
Local nVersao	:= HHNextVer(cID,"HCF")	
Local cDelete   := ""

dbSelectArea("SX3")
dbSetOrder(2)
If dbSeek("A1_TIPO")
	cTipos := SX3->X3_CBOX + ";"
	nPos := At(";", cTipos)
	While nPos > 0
		cValor := Subs(cTipos, 1, nPos - 1)
		nPos1 := At("=", cValor)
		aAdd(aTiposCli, {Subs(cValor, 1, nPos1-1), Subs(cValor, nPos1+1, Len(cValor))})
		cTipos := Subs(cTipos, nPos+1, Len(cTipos))
		nPos := At(";", cTipos)
	EndDo
EndIf

//Parametros para o SFA

aadd(aCfg,{"CF_PARAM"    , "C", 15, 0}) // Parametro 
aadd(aCfg,{"CF_VALOR"    , "C",255, 0}) // Conteudo

// Tabela HX5 
aadd(aTab,{"X5_TABELA","C",2,0})
aadd(aTab,{"X5_CHAVE","C",6,0})
aadd(aTab,{"X5_DESCRI","C",55,0})

//ConOut("PALMJOB: Criando arquivo de Configuracoes para " + Trim(HCADHH->HH_NOMUSR))
//PalmCreate(aCfg,cFileCfg,"HCF")     // Arquivo Configuracoes
//PalmCreate(aTab,cFileHX5,"HX5")     // Arquivo Tabelas genericas 

aAdd(aStrus, aCfg)
aAdd(aStrus, aTab)

//Carrega todos os parametros para o aplicativo
For nX := 1 to len(aParam)
	aadd(aCfgData,{aParam[nX][1],GetMV(aParam[nX][1],,aParam[nX][3])})
Next
aadd(aCfgData,{"CALCPROTHEUS","T"}) // Usa calculo de Desconto basado no Protheus (T = Protheus, F = Nao Protheus)

dbSelectArea("SIX")
dbSetOrder(1)
If dbSeek("HE4"+"2")
	aadd(aCfgData,{"MV_IND2HE4","T"})
Else
	aadd(aCfgData,{"MV_IND2HE4","F"})
EndIf

aadd(aCfgData,{"MV_IND2HA4","1"})

dbSelectArea("SIX")
dbSetOrder(1)
If dbSeek("HA4"+"2")
	aCfgData[len(aCfgData)][2] := "2"
EndIf

If dbSeek("HA4"+"3")
	aCfgData[len(aCfgData)][2] := "3"
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁPonto de Entrada para incluir parБmetros de configuraГЦo Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock("HEXPHCF01")
	aCfgUser := ExecBlock("HEXPHCF01", .F., .F.)
	For ix := 1 To Len(aCfgUser) 
		aAdd(aCfgData, {aCfgUser[ix,1], aCfgUser[ix,2]})
	Next
EndIf

If ExisteSX6("MV_CPOLVR") .And. !Empty(GetMv("MV_CPOLVR"))
	dbSelectArea("SX3")
	dbSetOrder(2)
	If dbSeek(GetMv("MV_CPOLVR"))
		cTitulo := SX3->X3_TITULO
		cTipo   := SX3->X3_TIPO
		nTam    := SX3->X3_TAMANHO
		nDec    := SX3->X3_DECIMAL
	EndIf
EndIf

// Grava Arquivo CONFIG (HCF)
For i := 1 To Len(aCfgData)
	cValor := Iif(len(aCfgData[i])==2,aCfgData[i,2],aCfgData[i,3])
	cParam := aCfgData[i,1]
	If Valtype(cParam) == "C" .And. Valtype(cValor) == "C"
		dbSelectArea("HCF")
		dbSetOrder(1)
		If !dbSeek(xFilial() + cId + cParam)
			RecLock("HCF",.T.)
		Else
			RecLock("HCF",.F.)
		EndIf
		HCF->HCF_FILIAL := xFilial("HCF")
		HCF->HCF_ID 	:= cId
		HCF->HCF_PARAM 	:= cParam
		HCF->HCF_VALOR	:= cValor
		HCF->HCF_INTR	:= cIntr
		HCF->HCF_VER	:= nVersao
		HCF->(MsUnlock())
	EndIf
Next

HHUpdCtr(cID,"HCF")
nVersao	:= HHNextVer(cID,"HX5")	

//Grava os Cargos
dbSelectArea("SUM")
dbSetOrder(1)
dbGoTop()
While !Eof() .And. SUM->UM_FILIAL == xFilial("SUM")
	dbSelectArea("HX5")
	dbSetOrder(1)
	If !dbSeek(xFilial() + cId + "UM" + SUM->UM_CARGO)
		RecLock("HX5",.T.)
	Else
		RecLock("HX5",.F.)
	EndIf	
	HX5->HX5_FILIAL := xFilial()
	HX5->HX5_ID := cId
	HX5->HX5_TABELA := "UM"
	HX5->HX5_CHAVE  := SUM->UM_CARGO
	HX5->HX5_DESCRI := SUM->UM_DESC
	HX5->HX5_INTR   := cIntr
	HX5->HX5_VER    := nVersao
	HX5->(MsUnlock())
	dbSelectArea("SUM")
	dbSkip()
EndDo                    

cTabela := "12"  // Tabela Estados UF
dbSelectArea("SX5")
dbSetOrder(1)
dbSeek(xFilial("SX5") + cTabela)
While !Eof() .And. SX5->X5_FILIAL = xFilial() .And. SX5->X5_TABELA = cTabela
   dbSelectArea("HX5")
	dbSetOrder(1)
	If !dbSeek(xFilial() + cId + "UF" + SX5->X5_CHAVE)
		RecLock("HX5",.T.)
	Else
		RecLock("HX5",.F.)
	EndIf	
	HX5->HX5_FILIAL := xFilial()
	HX5->HX5_ID := cId
	HX5->HX5_TABELA := "UF"
	HX5->HX5_CHAVE  := SX5->X5_CHAVE
 	HX5->HX5_DESCRI := SX5->X5_DESCRI
	HX5->HX5_INTR   := cIntr
	HX5->HX5_VER    := nVersao
	HX5->(MsUnlock())
	dbSelectArea("SX5")
	dbSkip()
EndDo

// Tabela de Motivos de Indenizacao
cTabela := "MT"
dbSelectArea("SX5")
dbSetOrder(1)
dbSeek(xFilial("SX5") + cTabela)
While !Eof() .And. SX5->X5_FILIAL = xFilial() .And. SX5->X5_TABELA = cTabela
   dbSelectArea("HX5")
	dbSetOrder(1)
	If !dbSeek(xFilial() + cId + SX5->X5_TABELA + SX5->X5_CHAVE)
		RecLock("HX5",.T.)
	Else
		RecLock("HX5",.F.)
	EndIf	
	HX5->HX5_FILIAL := xFilial()
	HX5->HX5_ID := cId
	HX5->HX5_TABELA := SX5->X5_TABELA
	HX5->HX5_CHAVE  := SX5->X5_CHAVE
 	HX5->HX5_DESCRI := SX5->X5_DESCRI
	HX5->HX5_INTR   := cIntr
	HX5->HX5_VER    := nVersao
	HX5->(MsUnlock())
	dbSelectArea("SX5")
	dbSkip()
EndDo

//Grava as Ocorrencias de nao visita

//Limpa os registros deletados na retaguarda 
dbSelectArea("AC5")
dbSetOrder(1) 

cDelete := "DELETE"
cDelete += " " +RetSqlName("HX5")+ " "
cDelete += "WHERE "
cDelete += "R_E_C_N_O_ IN ("
cDelete += "SELECT R_E_C_N_O_ "
cDelete += "FROM "+RetSqlName("HX5")+ " HX5 "
cDelete += "WHERE "  
cDelete += "HX5.HX5_TABELA = 'OC' AND "
cDelete += "HX5.D_E_L_E_T_ = ' '  AND "
cDelete += "EXISTS ("
cDelete += "SELECT * " 
cDelete += "FROM "+RetSqlName("AC5")+ " AC5 "
cDelete += "WHERE "  
cDelete += "AC5.AC5_FILIAL = '" + xFilial("HX5") + "' AND "
cDelete += "AC5.AC5_EVENTO <> HX5.HX5_CHAVE AND " 
cDelete += "AC5.D_E_L_E_T_ = ' ' " 
cDelete += " ))"
TCSqlExec(cDelete)	

dbSelectArea("AC5")
//dbSetOrder(1)
dbGoTop()
While !Eof() .And. AC5->AC5_FILIAL == xFilial("AC5")
   dbSelectArea("HX5")
	dbSetOrder(1)
	If !dbSeek(xFilial() + cId+ "OC" + AC5->AC5_EVENTO)
		RecLock("HX5",.T.)
	Else
		RecLock("HX5",.F.)
	EndIf	
	HX5->HX5_FILIAL := xFilial()
	HX5->HX5_ID := cId
	HX5->HX5_TABELA := "OC"
	HX5->HX5_CHAVE  := AC5->AC5_EVENTO
	HX5->HX5_DESCRI := AC5->AC5_DESCRI
	HX5->HX5_INTR   := cIntr
	HX5->HX5_VER    := nVersao
	HX5->(MsUnlock())
	dbSelectArea("AC5")
	dbSkip()
EndDo

// Grava Tipos de Cliente
For ix := 1 To Len(aTiposCli)
   dbSelectArea("HX5")
	dbSetOrder(1)
	If !dbSeek(xFilial() + cId + "TC" + SUBS(aTiposCli[ix,1],1,1 ))
		RecLock("HX5",.T.)
	Else
		RecLock("HX5",.F.)
	EndIf	
	HX5->HX5_FILIAL := xFilial()
	HX5->HX5_ID := cId
	HX5->HX5_TABELA  := "TC"
	HX5->HX5_CHAVE   := aTiposCli[ix,1]
	HX5->HX5_DESCRI  := aTiposCli[ix,2]
	HX5->HX5_INTR   := cIntr
	HX5->HX5_VER    := nVersao
	HX5->(MsUnlock())
Next

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁPonto de Entrada para incluir tabelas no SX5										|
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ExistBlock("HEXPSX501")
	ExecBlock("HEXPSX501", .F., .F.)
EndIf

HHUpdCtr(cID,"HX5")

//HCF->(dbCloseArea())
//HX5->(dbCloseArea())
//HHCloseAlias()
Return

/*эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё XEXPHCN  Ё Autor ЁLiber De Esteban       Ё Data Ё22/10/2007Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁSincronizaГЦo do HandHeld - HCN - Consumo                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁObs.      ЁComo essa funcao nao deve ser disparada via gatilho, seu    Ё╠╠
╠╠Ё          Ёnome nao deve comecar por HHEXP                             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Function XEXPHCN(cCpo,nOper)

Local cId		:= ""
Local cGeraCons	:= GetMV("MV_HHCONS",,"F")
Local cAliasA1	:= ""
Local cQuery	:= ""
Local aCons		:= {}
Local nX		:= 0
Local nPadCpo   := 0 // n. campos dicionario padrao
DEFAULT cCpo 	:= ""
DEFAULT nOper	:= 0

cId := HHCheckID("HCN","SA3")

If cId = "0" .Or. Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. !Empty(cId) .And. nOper >= 0 .And. cGeraCons == "T"

	//Limpa HCN
	cDelete := "DELETE "
	cDelete += "FROM "+RetSqlName("HCN")+" "
	cDelete += "WHERE HCN_FILIAL='" + xFilial("HCN") + "' AND "
	cDelete += "HCN_ID = '" + cId + "'"
	TcSqlExec(cDelete)
	
	//Filtra clientes para atualizacao
	cQuery := "SELECT A1_COD, A1_LOJA FROM "+RetSqlName("SA1")+" SA1 "
	cQuery += "WHERE "
	cQuery += "SA1.A1_FILIAL='" + xFilial("SA1") + "' AND "
	If !Empty(cId)
		cQuery += "SA1.A1_VEND = '" + cId + "' AND "
	EndIf
	cQuery += "SA1.D_E_L_E_T_ = ' ' "
	cQuery += "Order by A1_COD"
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para complementar o filtro de clientes   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSA1B")
		cQuery := ExecBlock("HEXPSA1B", .F., .F., {cQuery})
	EndIf
	
	cQuery	 := ChangeQuery(cQuery)
	cAliasA1 := GetNextAlias()
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasA1)
	
	While !(cAliasA1)->(Eof())
	
		aCons := {}
		//Busca relacao de consumo do EXPSF3 ate implemetar exportacaoo no modelo novo
		If ExistBlock("XEXPSF2")
//			aCons := U_XEXPSF2(@aCons, (cAliasA1)->A1_COD, (cAliasA1)->A1_LOJA)
			U_XEXPSF2(@aCons, (cAliasA1)->A1_COD, (cAliasA1)->A1_LOJA)
		ElseIf ExistBlock("HHEXPSF2")
//			aCons := U_HHEXPSF2(@aCons, (cAliasA1)->A1_COD, (cAliasA1)->A1_LOJA)
			U_HHEXPSF2(@aCons, (cAliasA1)->A1_COD, (cAliasA1)->A1_LOJA)
		EndIf
		
		// Grava o Arquivo de Consumo
		For nX := 1 to len(aCons)
			dbSelectArea("HCN")
			RecLock("HCN",.T.)
			HCN->HCN_FILIAL := xFilial("HCN")
			HCN->HCN_ID     := cId
			HCN->HCN_CLIENT := aCons[nX,2]
			HCN->HCN_LOJA   := aCons[nX,3]
			HCN->HCN_GRUPO  := aCons[nX,4]
			HCN->HCN_PROD   := aCons[nX,5]
			HCN->HCN_ANOANT := aCons[nX,6]
			HCN->HCN_MESANT := aCons[nX,7]                	
			HCN->HCN_MESATU := aCons[nX,8]
			nPadCpo :=8  // n. campos dicionario padrao
			If ExistBlock("HEXPHCNA")
			   nPadCpo := ExecBlock("HEXPHCNA", .F., .F.,{aCons,nX,@nPadCpo})
    	    EndIf			
			HCN->HCN_INTR   := "I"
			HCN->HCN_VER    := 1
			HCN->(MsUnlock())
		Next  
		
		(cAliasA1)->(dbSkip())
	
	End
	
	(cAliasA1)->(dbCloseArea())

EndIf

HHUpdCtr(cID,"HCN")

Return(cID)


/*эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFuncao    Ё HHEXPSCT Ё Autor ЁLiber De Esteban       Ё Data Ё03/12/2007Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁSincronizaГЦo do HandHeld - HMT - Metas                     Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Informa o campo de controle para atualizacao         Ё╠╠
╠╠Ё          ЁExpN2: Informa a operacao realizada                         Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao Efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Function HHEXPSCT(cCpo,nOper)

Local aArea		:= GetArea()
Local aAreaSCT	:= SCT->(GetArea())
Local aAreaHMT	:= HMT->(GetArea())
Local nX		:= 1
Local cInsert	:= ""
Local cDelete	:= ""
Local cSelect	:= ""
Local cQuery	:= ""
Local cUpdate	:= ""
Local cNoQuery	:= ""
Local cDelUpd	:= ""
Local cId		:= HHCheckID("HMT","SCT")
Local aDados	:= {}
Local cIntr		:= "I"
Local nVersao	:= 1
Local nRetSql  	:= 0
Local cFuncName	:= ProcName()

Local cOpConcat	:= Iif("MSSQL"$Upper(TCGetDB()),"+","||")
Local cSubstr	:= Iif("MSSQL"$Upper(TCGetDB()),"substring","substr")

DEFAULT cCpo 	:= ""
DEFAULT nOper	:= 0

If Empty(cCpo) .And. !Empty(cId)
	cId := HGU->HGU_CODBAS
EndIf

If !cId == "0" .And. nOper >= 0
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica o relacionamento dos campos e tabelas        Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aadd(aDados,{"HMT_FILIAL ","CT_FILIAL"})
	aadd(aDados,{"HMT_DATA   ","CT_DATA"})
	aadd(aDados,{"HMT_GRUPO  ","CT_GRUPO"})
	aadd(aDados,{"HMT_PROD   ","CT_PRODUTO"})
	aadd(aDados,{"HMT_QTD    ","CT_QUANT"})
	aadd(aDados,{"HMT_VALOR  ","CT_VALOR"})
	aadd(aDados,{"HMT_DOC    ","CT_DOC"})
	aadd(aDados,{"HMT_SEQUEN ","CT_SEQUEN"})
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPonto de Entrada para alteraГЦo dos Campos para exportaГЦo  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("HEXPSCTA")
		aDados := ExecBlock("HEXPSCTA", .F., .F., {aDados})
		If __HHLog >= 1
			__HHLogMsg := STR0001
			GravaHHLog(__HHLogMsg)
		EndIf
	EndIf
	
	dbSelectArea("SCT")
	dbSetOrder(1)
	dbSelectArea("HMT")
	dbSetOrder(1)
	#IFDEF TOP
		If GetNewPar("MV_HHOPT",.T.)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁExportaГЦo da tabela de metas.                        Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If LockByName("HHEXP_SCT"+cID,.T.,!Empty(xFilial("HMT")),.T.)	
				dbSelectArea("SCT")
				dbCommit()
				
				//Filtro para atualizacao
				cQuery := "FROM "+RetSqlName("SCT")+" SCT "
				cQuery += "WHERE "
				cQuery += "SCT.CT_FILIAL='" + xFilial("SCT") + "' AND "
				If !Empty(cId)
					cQuery += "SCT.CT_VEND = '" + cId + "' AND "
				EndIf
				cQuery += "SCT.D_E_L_E_T_ = ' ' "
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁPonto de Entrada para complementar o filtro do servico    Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If ExistBlock("HEXPSCTB")
					cQuery := ExecBlock("HEXPSCTB", .F., .F., {cQuery})
				EndIf
				
				cNoQuery := " AND "
				cNoQuery += "SCT.R_E_C_N_O_ NOT IN ("
				cNoQuery += "SELECT HMT.R_E_C_N_O_ "
				cNoQuery += "FROM "+RetSqlName("HMT")+" HMT "
				cNoQuery += "WHERE "
				cNoQuery += "HMT_FILIAL='"+xFilial("HMT")+"' AND "
				cNoQuery += "HMT.D_E_L_E_T_ = ' ' ) "

				If nOper <> 0
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁAnalisa a instrucao e versao do registro                                         Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					cIntr := HHChkIntr(nOper,"HMT",.T.)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//ЁObtem a prСxima versao do registro                                               Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
					nVersao := HHNextVer(cID,"HMT")	
					
					cUpdate := "FROM "+RetSqlName("SCT")+" SCT "
					cUpdate += "WHERE "
					cUpdate += "SCT.CT_FILIAL='" + xFilial("SCT") + "' AND "
					If !Empty(cId)
						cUpdate += "SCT.CT_VEND = '" + cId + "' AND "
					EndIf
					cUpdate += "SCT.D_E_L_E_T_ = ' ' AND "
					cUpdate += "HMT_FILIAL='" + xFilial("HMT") + "' AND "
					cUpdate += "HMT_ID = '" + cID + "' AND "
					cUpdate += "("
					For nX := 1 To Len(aDados)-1
						cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" OR "
					Next nX
					cUpdate += aDados[nX][1]+" <> "+aDados[nX][2]+" ) "

				EndIf
				
				cSelect := "SELECT "
				For nX := 1 To Len(aDados)
					cSelect += aDados[nX][2]+","
				Next nX
				//Motagem da query para gravar DATA no formato determinado no serviГo de metas no SFA
				cSelect += cSubstr+"(CT_DATA,5,2)"+cOpConcat+cSubstr+"(CT_DATA,1,4),"
				cSelect += "'"+cIntr+"',"
				cSelect += Str(nVersao,10)+","
				cSelect += "'"+cId+"',"
				cSelect += "R_E_C_N_O_ "
				
				If nOper == 0

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HMT")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT R_E_C_N_O_ "
					cDelete += cQuery
					cDelete += ")

				Else

					cDelete := "DELETE "
					cDelete += "FROM "+RetSqlName("HMT")+" "
					cDelete += "WHERE "
					cDelete += "R_E_C_N_O_ IN ("
					cDelete += "SELECT SCT.R_E_C_N_O_ "
					cDelete += cUpdate
					cDelete += ")
					
				EndIf

				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cDelete)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-1): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cDelete + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf
				
				cInsert := "INSERT INTO "
				cInsert += RetSqlName("HMT")+" "
				cInsert += "("
				For nX := 1 To Len(aDados)
					cInsert += aDados[nX][1]+","
				Next nX
				cInsert += "HMT_MESANO,"
				cInsert += "HMT_INTR,"
				cInsert += "HMT_VER,"
				cInsert += "HMT_ID,"
				cInsert += "R_E_C_N_O_"
				cInsert += ") "
				cInsert += cSelect
				cInsert += cQuery
				cInsert += cNoQuery
 
				__HHLogTime := PText2Sec(Time())
				nRetSql := TcSqlExec(cInsert)
				If __HHLog >= 1
					__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
					__HHLogMsg += Space(__HHLogTab) + cInsert + KB_ENTER
					If nRetSql != 0 .And. __HHLog == 9
						__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
					EndIf
					__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
					GravaHHLog(__HHLogMsg)
				EndIf

				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁMarca os registros deleteados para atualizacao no hand held                      Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If nOper <> 0
					cDelUpd  := "UPDATE "+RetSqlName("HMT")+" "
					cDelUpd  += "SET HMT_INTR = 'E',HMT_VER="+Str(nVersao,10)+" "
					cDelUpd  += "WHERE "
					cDelUpd  += "R_E_C_N_O_ NOT IN ("
					cDelUpd  += "SELECT SCT.R_E_C_N_O_ "
					cDelUpd  += "FROM " + RetSqlName("SCT") + " SCT," + RetSqlName("HMT") + " HMT "
					cDelUpd  += "WHERE "
					cDelUpd  += "SCT.CT_FILIAL = '" + xFilial("SCT") + "' AND "
					cDelUpd  += "SCT.CT_VEND = '" + cId + "' AND "
					cDelUpd  += "HMT.R_E_C_N_O_ = SCT.R_E_C_N_O_ AND "
					cDelUpd  += "SCT.D_E_L_E_T_=' ')  AND "
					cDelUpd  += "HMT_INTR <> 'E' "

					nRetSql := TcSqlExec(cDelUpd)
					
				EndIf
				Begin Transaction
					HHExcGenDel("HMT")
					HHUpdCtr(cID,"HMT")	
				End Transaction			
				UnLockByName("HHEXP_SCT"+cID,.T.,!Empty(xFilial("HMT")),.T.)
			EndIf			
		Else
	#ENDIF
			Conout("Ambiente Codebase nao homologado para SFA")
	#IFDEF TOP
		EndIf
	#ENDIF
EndIf
RestArea(aAreaHMT)
RestArea(aAreaSCT)
RestArea(aArea)
Return(cID)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммяммммммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨FuncaoЁHHComplHC5    ╨Autor  ЁTatiana Maia        ╨ Data Ё06/06/2008   ╨╠╠
╠╠лммммммьммммммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc. ЁSincronizacao do HandHeld - Complemnto tabela HC5               ╨╠╠
╠╠╨      ЁCampos acumulados da tabela HC5  - HC5_VALOR e HC5_QTDITE       ╨╠╠
╠╠лммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso   ЁSFA                                                             ╨╠╠
╠╠хммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function HHComplHC5(cID)

Local cQuery	:= ""  
Local cGetDb     := ""
Local nRetSql  	:= 0
Local cFuncName	:= ProcName()

cGetDb   := Upper(TcGetDb())

#IFDEF TOP
	If "MSSQL" $ cGetDb
		cQuery := "UPDATE "
		cQuery += RetSqlName("HC5")
		cQuery += " SET HC5_VALOR = (SELECT ISNULL(SUM(HC6_VALOR),0) TOTAL "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM "
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' ),"
		
		cQuery += " HC5_QTDITE = (SELECT COUNT(HC6_NUM) QTDITE "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' )"
		
		cQuery += " WHERE HC5_FILIAL = '"+xFilial('HC5')+"'"
		cQuery += " AND HC5_ID = '"+cId+"'"
		cQuery += " AND D_E_L_E_T_ = ' '
		
	ElseIf "DB2" $ cGetDb
		cQuery := "UPDATE "
		cQuery += RetSqlName("HC5")
		cQuery += " SET HC5_VALOR = (SELECT COALESCE(SUM(HC6_VALOR),0) TOTAL "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM "
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' ),"
		
		cQuery += " HC5_QTDITE = (SELECT COUNT(HC6_NUM) QTDITE "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' )"
		
		cQuery += " WHERE HC5_FILIAL = '"+xFilial('HC5')+"'"
		cQuery += " AND HC5_ID = '"+cId+"'"
		cQuery += " AND D_E_L_E_T_ = ' '
	Else
		cQuery := "UPDATE "
		cQuery += RetSqlName("HC5")
		cQuery += " SET HC5_VALOR = (SELECT NVL(SUM(HC6_VALOR),0) TOTAL "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM "
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' ),"
		
		cQuery += " HC5_QTDITE = (SELECT COUNT(HC6_NUM) QTDITE "
		cQuery += " FROM "+RetSqlName("HC6")+ " HC6 "
		cQuery += " WHERE "
		cQuery += " HC6.HC6_FILIAL = '"+xFilial("HC6")+"'"
		cQuery += " AND HC6.HC6_ID = HC5_ID "
		cQuery += " AND HC6.HC6_NUM = HC5_NUM
		cQuery += " AND HC6.D_E_L_E_T_ = ' ' )"
		
		cQuery += " WHERE HC5_FILIAL = '"+xFilial('HC5')+"'"
		cQuery += " AND HC5_ID = '"+cId+"'"
		cQuery += " AND D_E_L_E_T_ = ' '
	EndIf
	
	__HHLogTime := PText2Sec(Time())
	nRetSql := TcSqlExec(cQuery)
	If __HHLog >= 1
		__HHLogMsg := STR0002 + cFuncName + "-2): " + KB_ENTER
		__HHLogMsg += Space(__HHLogTab) + cQuery + KB_ENTER
		If nRetSql != 0 .And. __HHLog == 9
			__HHLogMsg += Space(__HHLogTab) + STR0003 + TCSQLERROR() + KB_ENTER
		EndIf
		__HHLogMsg += Space(__HHLogTab) + STR0004 + PSec2Text(PText2Sec(Time()) - __HHLogTime) + KB_ENTER
		GravaHHLog(__HHLogMsg)
	EndIf
	
#ENDIF  


Return(cID)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммямммммммммммкммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁHHTESTE_EXP╨Autor ЁMicrosiga           ╨ Data Ё  08/16/06   ╨╠╠
╠╠лммммммммммьмммммммммммйммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁFuncao de testes do HHMOBEXP.                               ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Main Function HHTeste_exp()
RpcSetType ( 3 )
PREPARE ENVIRONMENT EMPRESA "01" FILIAL "01" MODULO "FAT"
HHRstMobExp()
HHEXPSC5()
Return