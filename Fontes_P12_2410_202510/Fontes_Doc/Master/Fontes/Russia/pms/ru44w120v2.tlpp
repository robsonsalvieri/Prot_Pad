// #include 'protheus.ch'
// #include 'tlpp-core.th'
// #include 'tlpp-rest.th'


// #DEFINE _INSERT_COLS_NR 3

// #DEFINE GROUP_NO_ALL	10
// #DEFINE GROUP_NO   		0
// #DEFINE GROUP_TEAM 		1
// #DEFINE GROUP_RES  		2
// #DEFINE GROUP_TYPE_TEAM 3
// #DEFINE GROUP_TYPE_RES  4

// /*/{Protheus.doc} full
// Get all allocation by team
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// /*/
// @Get("/api/pms/v2/ru44w120/allocation/:groupBy/:cDateFrom/:cDateTo/")
// Function ru44w120_fullV2()

// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery     := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local lTasks := .F.
// 	Local lDelayed := .F.
// 	Local nGroupBy := -1
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local lRet := .T.
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	Private _cErrorRest := ""

// 	jPath := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	BEGIN SEQUENCE
// 		If ( jQuery <> Nil )
// 			cTeam 		:= jQuery[ 'teams' ]
// 			cResource 	:= jQuery[ 'resources' ]
// 			lTasks 		:= (jQuery[ 'details' ] <> NIL .and. (jQuery[ 'details' ] == '1' .or. upper(jQuery[ 'details' ])=='TRUE'))
// 			lDelayed 	:= (jQuery[ 'delayed' ] <> NIL .and. (jQuery[ 'delayed' ] == '1' .or. upper(jQuery[ 'delayed' ])=='TRUE'))
// 			If cResource == 'MYSELF'
// 				DbSelectArea('AE8')
// 				DbSetOrder(3)
// 				If DbSeek(xFilial()+__cUserID)
// 					cResource := AE8_RECURS
// 				Endif
// 			Endif
// 		EndIf

// 		Do Case
// 		case upper(jPath[ 'groupBy' ]) == "TEAM"
// 			nGroupBy := GROUP_TEAM
// 		case upper(jPath[ 'groupBy' ]) == "RESOURCE"
// 			nGroupBy := GROUP_RES
// 		EndCase

// 		if nGroupBy <> -1
// 			If (jPath <> Nil )
// 				jResponse := GetAlloc(nTipoRet=nGroupBy, cDateFrom=jPath[ 'cDateFrom' ], cDateTo = jPath[ 'cDateTo' ], cTeam = cTeam, cRes=cResource, lTasks=lTasks, lDelayed=lDelayed)
// 			EndIf

// 			oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 			oRest:setResponse(jResponse)
// 		Else
// 			//TODO: Set error
// 		Endif
// 		RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)
// Return


// /*/{Protheus.doc} ru44w120_det_tasks
// Get detaileds tasks, delayed, closed or  closed with delay from a date
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// /*/
// 	@Get("/api/pms/v2/ru44w120/det_tasks/:cTipo")
// Function ru44w120_det_tasksV2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local cType
// 	Local cProject
// 	Local cCostColl
// 	Local cDaysRef
// 	Local jHeader:= oRest:getHeaderRequest()
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local lCPI := .F.
// 	Local lSPI := .F.
// 	Local lPOC := .F.
// 	Local cTskSit 
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()
// 	BEGIN SEQUENCE
// 		If ( jQuery <> Nil )
// 			cTeam 		:= jQuery[ 'teams' ]
// 			cResource 	:= jQuery[ 'resources' ]
// 			cType 		:= jQuery[ 'types' ]
// 			cProject 	:= jQuery[ 'projects' ]
// 			cCostColl 	:= jQuery[ 'costCollectors' ]
// 			cDaysRef 	:= jQuery[ 'daysRef' ]
// 			lPOC 		:= (jQuery[ 'POC' ]<> Nil .And. (jQuery[ 'POC' ] == '1' .or. upper(jQuery[ 'POC' ])=='TRUE')) .Or. ;
// 						(jQuery[ 'poc' ]<> Nil .And. (jQuery[ 'poc' ] == '1' .or. upper(jQuery[ 'poc' ])=='TRUE')) 
// 			lSPI 		:= jQuery[ 'spi' ] <> Nil .And. (jQuery[ 'spi' ] == '1' .or. upper(jQuery[ 'spi' ])=='TRUE')
// 			lCPI 		:= jQuery[ 'cpi' ] <> Nil .And. (jQuery[ 'cpi' ] == '1' .or. upper(jQuery[ 'cpi' ])=='TRUE')
// 			If cResource == 'MYSELF'
// 				DbSelectArea('AE8')
// 				DbSetOrder(3)
// 				If DbSeek(xFilial()+__cUserID)
// 					cResource := AE8_RECURS
// 				Endif
// 			Endif
// 		EndIf
// 		cTskSit := jPath[ 'cTipo' ]
// 		Do Case
// 		Case upper(cTskSit) == 'CLOSEDWITHDELAY'
// 			cTskSit := '1'
// 		Case upper(cTskSit) == 'CLOSED'
// 			cTskSit := '3'
// 		Case upper(cTskSit) == 'DELAYED'
// 			cTskSit := '2'
// 		Case upper(cTskSit) == 'OPEN'
// 			cTskSit := '4'
// 		Case upper(cTskSit) == 'ALL'
// 			cTskSit := '0'
// 		EndCase
// 		If (jPath <> Nil )
// 			jResponse := GetTsk(cResource, cTeam, cProject, cType, cTskSit, cDaysRef, cCostColl, lPOC, lCPI=lCPI, lSPI=lSPI)
// 		EndIf
// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 	RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)

// Return

// /*/{Protheus.doc} ru44w120_det_tasks
// Get detaileds tasks, delayed, closed or  closed with delay from a date
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// /*/
// @Get("/api/pms/v2/ru44w120/myTasks/:cTipo")
// Function ru44w120_MytasksV2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cResource
// 	Local cType
// 	Local cProject
// 	Local cCostColl
// 	Local cDaysRef
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local lCPI := .F.
// 	Local lSPI := .F.
// 	Local lPOC := .F.
// 	Local cTskSit := ""
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()
// 	BEGIN SEQUENCE
// 		If ( jQuery <> Nil )
// 			cType 		:= jQuery[ 'types' ]
// 			cProject 	:= jQuery[ 'projects' ]
// 			cCostColl 	:= jQuery[ 'costCollectors' ]
// 			cDaysRef 	:= jQuery[ 'daysRef' ]
// 			lPOC 		:= jQuery[ 'poc' ] <> Nil .And. (jQuery[ 'poc' ] == '1' .or. upper(jQuery[ 'poc' ])=='TRUE')
// 			lSPI 		:= jQuery[ 'spi' ] <> Nil .And. (jQuery[ 'spi' ] == '1' .or. upper(jQuery[ 'spi' ])=='TRUE')
// 			lCPI 		:= jQuery[ 'cpi' ] <> Nil .And. (jQuery[ 'cpi' ] == '1' .or. upper(jQuery[ 'cpi' ])=='TRUE')
// 		EndIf
// //		@param cTskSit, character, Task situation => ClosedWithDelay = '1', Closed = '3', Delayed = '2', Open = '4', All = '0' or Nil
// 		cTskSit := jPath[ 'cTipo' ]
// 		Do Case
// 		Case upper(cTskSit) == 'CLOSEDWITHDELAY'
// 			cTskSit := '1'
// 		Case upper(cTskSit) == 'CLOSED'
// 			cTskSit := '3'
// 		Case upper(cTskSit) == 'DELAYED'
// 			cTskSit := '2'
// 		Case upper(cTskSit) == 'OPEN'
// 			cTskSit := '4'
// 		Case upper(cTskSit) == 'ALL'
// 			cTskSit := '0'
// 		EndCase
// 		DbSelectArea('AE8')
// 		DbSetOrder(3)
// 		If DbSeek(xFilial()+__cUSerID)
// 			cResource := AE8_RECURS
// 		Endif
// 		If (cResource <> Nil)
// 			jResponse := GetTsk(cRes=cResource, cEqp = '', cPrj=cProject, cType=cType, cTskSit=cTskSit, cDaysRef=cDaysRef, cCC=cCostColl, lPoc=lPOC, lCPI=lCPI, lSPI=lSPI)
// 		EndIf

// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 	RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)
// Return

// /*/{Protheus.doc} ru44w120_alloc_an
// Get allocation analysis
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// /*/
// 	@Get("/api/pms/v2/ru44w120/alloc_an/:cDateFrom/:cDateTo/:nType")
// Function ru44w120_alloc_anV2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	If ( jQuery <> Nil )
// 		cTeam := jQuery[ 'team' ]
// 		cResource := jQuery[ 'resource' ]
// 		If cResource == 'MYSELF'
// 			DbSelectArea('AE8')
// 			DbSetOrder(3)
// 			If DbSeek(xFilial()+__cUserID)
// 				cResource := AE8_RECURS
// 			Endif
// 		Endif
// 	EndIf

// 	If (jPath <> Nil )
// 		jResponse := RecAnalisys(Stod(jPath[ 'cDateFrom' ]), Stod(jPath[ 'cDateTo' ]), jPath[ 'nType' ], cTeam, cResource)
// 	EndIf

// 	oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 	oRest:setResponse(jResponse)
// Return

// @Get("/api/pms/v2/ru44w120/tssummary/:cDateFrom/:cDateTo/:period")
// Function ru44w120_tssummary_v2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local cType
// 	Local cProject
// 	Local cCostColl
// 	Local cFields
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	If ( jQuery <> Nil )
// 		cTeam 		:= jQuery[ 'team' ]
// 		cResource 	:= jQuery[ 'resource' ]
// 		cType 		:= jQuery[ 'type' ]
// 		cProject 	:= jQuery[ 'project' ]
// 		cCostColl 	:= jQuery[ 'costCollector' ]
// 		cFields 	:= jQuery[ 'fields' ]
// 		If cResource == 'MYSELF'
// 			DbSelectArea('AE8')
// 			DbSetOrder(3)
// 			If DbSeek(xFilial()+__cUserID)
// 				cResource := AE8_RECURS
// 			Endif
// 		Endif
// 	EndIf

// 	BEGIN SEQUENCE
// 		If (jPath <> Nil )
// 			jResponse := GetAFUSummary(jPath[ 'cDateFrom' ], jPath[ 'cDateTo' ],jPath[ 'period' ], cTeam, cResource, cType, cProject, cCostColl, cFields)
// 		EndIf

// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 		RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)

// Return

// @Get("/api/pms/v2/ru44w120/ts_prets_summary/:cDateFrom/:cDateTo/:period")
// Function ru44w120_ts_prets_summary_v2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local cOption
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	If ( jQuery <> Nil )
// 		cTeam 		:= jQuery[ 'team' ]
// 		cResource 	:= jQuery[ 'resource' ]
// 		cOption 	:= jQuery[ 'filterOption' ]
// 		If cResource == 'MYSELF'
// 			DbSelectArea('AE8')
// 			DbSetOrder(3)
// 			If DbSeek(xFilial()+__cUserID)
// 				cResource := AE8_RECURS
// 			Endif
// 		Endif
// 	EndIf
// 	BEGIN SEQUENCE
// 		If (jPath <> Nil )
// 			jResponse := GetAFUAJKSummary(jPath[ 'cDateFrom' ], jPath[ 'cDateTo' ],jPath[ 'period' ], cTeam, cResource, cOption=cOption)
// 		EndIf

// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 		RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)

// Return

// @Get("/api/pms/v2/ru44w120/ts/:cDateFrom/:cDateTo/")
// Function ru44w120_ts_v2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local cType
// 	Local cProject
// 	Local cCostColl
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	If ( jQuery <> Nil )
// 		cTeam 		:= jQuery[ 'team' ]
// 		cResource 	:= jQuery[ 'resource' ]
// 		cType 		:= jQuery[ 'type' ]
// 		cProject 	:= jQuery[ 'project' ]
// 		cCostColl 	:= jQuery[ 'costCollector' ]
// 		If cResource == 'MYSELF'
// 			DbSelectArea('AE8')
// 			DbSetOrder(3)
// 			If DbSeek(xFilial()+__cUserID)
// 				cResource := AE8_RECURS
// 			Endif
// 		Endif

// 	EndIf
// 	BEGIN SEQUENCE
// 		If (jPath <> Nil )
// 			jResponse := GetAFU(jPath[ 'cDateFrom' ], jPath[ 'cDateTo' ], cTeam, cResource, cType, cProject, cCostColl)
// 		EndIf

// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 		RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)

// Return
// @Get("/api/pms/v2/ru44w120/ts_prets/:cDateFrom/:cDateTo/")
// Function ru44w120_ts_prets_v2()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery    := jsonObject():New() As Json
// 	Local cTeam
// 	Local cResource
// 	Local cType
// 	Local cProject
// 	Local cCostColl
// 	Local bBlock := ErrorBlock( { |e| CatchError(e) } )
// 	Local jHeader:= oRest:getHeaderRequest()
// 	Local cOption
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath  := oRest:getPathParamsRequest()
// 	jQuery := oRest:GetQueryRequest()

// 	If ( jQuery <> Nil )
// 		cTeam 		:= jQuery[ 'team' ]
// 		cResource 	:= jQuery[ 'resource' ]
// 		cType 		:= jQuery[ 'type' ]
// 		cProject 	:= jQuery[ 'project' ]
// 		cCostColl 	:= jQuery[ 'costCollector' ]
// 		cOption 	:= jQuery[ 'filterOption' ]
// 		If cResource == 'MYSELF'
// 			DbSelectArea('AE8')
// 			DbSetOrder(3)
// 			If DbSeek(xFilial()+__cUserID)
// 				cResource := AE8_RECURS
// 			Endif
// 		Endif

// 	EndIf
// 	BEGIN SEQUENCE
// 		If (jPath <> Nil )
// 			jResponse := GetAFUAJK(jPath[ 'cDateFrom' ], jPath[ 'cDateTo' ], cTeam, cResource, cType, cProject, cCostColl, cOption=cOption)
// 		EndIf

// 		oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 		oRest:setResponse(jResponse)
// 		RECOVER
// 		lRet := .F.
// 	END SEQUENCE

// 	ErrorBlock(bBlock)

// Return


// /*/{Protheus.doc} ru44w120_task_hour_balance
// Get task hours according to calendar
// @type function
// @author Bruno Sobieski
// @since 12/02/2025
// /*/
// 	@Get("/api/pms/v2/ru44w120/task_hour_balance/:project/:task/:resource")
// Function Ru44w120_task_hour_balance()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local cResource 
// 	Local cTask as character
// 	Local cProject as character
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath := oRest:getPathParamsRequest()

// 	If (jPath <> Nil )
// 		cResource := jPath['resource']
// 		cProject := jPath['project']
// 		cTask := jPath['task']
// 		jResponse['data'] := jsonObject():New() 
// 		jResponse['data']['hours'] :=  RU44W70010(cProject,,cTask, cResource)
// 	EndIf

// 	oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 	oRest:setResponse(jResponse)
// Return


// /*/{Protheus.doc} Ru44w120_task_hours
// Get task hours according to calendar
// @type function
// @author Bruno Sobieski
// @since 12/02/2025
// /*/
// 	@Get("/api/pms/v2/ru44w120/task_hours/:project/:task/:date/:startHour/:finishHour")
// Function Ru44w120_task_hours()
// 	Local jResponse := jsonObject():New() As Json
// 	Local jPath     := jsonObject():New() As Json
// 	Local jQuery     := jsonObject():New() As Json
// 	Local cResource 
// 	Local cTask as character
// 	Local cProject as character
// 	Local dDate  as date
// 	Local cStart  as character
// 	Local cFinish   as character
// 	Local cCalendar  as character
// 	Local jHeader:= oRest:getHeaderRequest()
// 	If (jHeader <> Nil .And. jHeader['Accept-Language'] <> Nil .And.  lower(jHeader['Accept-Language']) $ 'pt,es,en,ru,pt-br,pt-pt' )
// 		if upper(jHeader['Accept-Language']) <> upper(fwRetIdiom())
// 			FwSetIdiom(jHeader['Accept-Language'])
// 		Endif
// 	EndIf

// 	jPath := oRest:getPathParamsRequest()

// 	If (jPath <> Nil )
// 		cProject := jPath['project']
// 		cTask 	 := jPath['task']
// 		dDate 	 := Stod(jPath['date'])
// 		cStart 	 := jPath['startHour']
// 		cFinish  := jPath['finishHour']
// 		If jQuery <> Nil
// 			If jQuery['resource'] <> Nil .And. !Empty(jQuery['resource'])
// 				cResource:= jQuery['resource']
// 				AE8->(dbSetOrder(1))
// 				AE8->(dbSeek(xFilial()+cResource))
// 				cCalendar := AE8->AE8_CALEND
// 			Endif
// 		Endif
// 		If cResource == Nil
// 			AF8->(DbSetOrder(1))
// 			AF8->(DbSeek(xFilial()+cProject))
// 			AF9->(DbSetOrder(1))
// 			AF9->(DbSeek(xFilial()+AF8->AF8_PROJET+AF8->AF8_REVISA+cTask ))
// 			cCalendar := AF9->AF9_CALEND
// 		Endif
// 		jResponse['data'] := jsonObject():New() 	    
// 		jResponse['data']['hours'] :=  PmsHrsItvl(dDate,cStart,dDate,cFinish,cCalendar,cProject,cResource,,.T.)
// 	EndIf


// 	oRest:SetKeyHeaderResponse('Content-Type', 'application/json')
// 	oRest:setResponse(jResponse)
// Return
// /*/{Protheus.doc} GetAlloc
// Get Allocation data
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param nTipoRet, numeric, Grouped by team or grouped by resource 
// @param cDateFrom, character, Date from
// @param cDateTo, character, Date to
// @param cTeam, character, Teams to filter (comma sparated)
// @param cRes, character, Resources to filter (comma sparated)
// @param lTasks, logical, Return tasks details
// @param lDelayed, logical, Return delayed tasks also
// @Return Json, Json Object
// /*/
// Static Function GetAlloc(nTipoRet, cDateFrom, cDateTo, cTeam, cRes, lTasks, lDelayed)
// 	Local cAlias    := GetNextAlias()
// 	Local cAliasTmp := GetNextAlias()
// 	Local cResFault	:=""
// 	Local cSql      := ""
// 	Local nX        := 0
// 	Local aRes      := {}
// 	Local oFWTMP	//FWTemporaryTable():New(cAliasTMP,aFields )
// 	Local aFields	:=	{{"TOT_AL_RES", "N", 14,  2},;
// 		{"TOT_AV_RES" , "N", 14,  2},;
// 		{"AL_PER_RES" , "N", 6,  2},;
// 		{"TOT_AL_TSK" , "N", 14,  2},;
// 		{"TOT_DE_TSK" , "N", 14, 2},;
// 		{"TOT_AL_TEA" , "N", 14,  2},;
// 		{"TOT_AV_TEA" , "N", 14,  2},;
// 		{"AL_PER_TEA" , "N", 6,  2}}
// 	Local cFields       := ""
// 	Local cFieldsQry    := ""
// 	Local cFieldsAdic	:= ""
// 	Local nTimeDelay	:= 0
// 	Local nDoneHours    := 0
// 	Local nHoursBefore  := 0
// 	Local nPercCompl    := 0
// 	Local jsonRet 	:= JsonObject():New()
// 	Local jRetTmp
// 	Local cInsert := ""
// 	Local cSelect := ""

// 	Local lAE8CalStd := AE8->(ColumnPos("AE8_CALSTD")) > 0
// 	Local lAE8Start  := AE8->(ColumnPos("AE8_START")) > 0
// 	Local lAE8Finish := AE8->(ColumnPos("AE8_FINISH")) > 0
// 	DEFAULT lTasks := .F.
// 	For nx:=1 To Len(aFields)
// 		cFieldsAdic += ","+aFIELDS[nX,1]
// 	Next
// //nTipoRet
// //1=Group by team
// //2=Group By resource
// //Adjust periods to date
// 	cDateFrom := Substr(cDateFrom,1,6) + "01"
// 	cDateTo	:= DtoS(LastDay(Stod(Substr(cDateTo,1,6) + "01")))

// 	cFields	:= " AF9_START, AF9_HORAI, AF9_FINISH, AF9_HORAF, AF9_DESCRI, AF9_TAREFA, AF9_CALEND, AF9_GRPCOM, AF9_QUANT, "
// 	cFields	+= " AF9_DTATUI, AF9_HRATUI, AF9_DTATUF, AF9_HRATUF, "
// 	cFields	+= " AF8_PROJET, AF8_DESCRI, AF8_REVISA, AF8_TPPRJ, "
// 	cFields	+= " AE8_RECURS, AE8_DESCRI, AE8_UMAX, "

// 	If lAE8CalStd .And. lAE8Start .And. lAE8Finish
// 		cFields	+= " AE8_CALSTD, AE8_START, AE8_FINISH, "
// 	EndIf

// 	cFields	+= " AFA_QUANT, "
// 	cFieldsQry := cFields
// 	cFields	+= " AED_EQUIP, AED_DESCRI,"
// 	cFields	+= " AE5_GRPCOM, AE5_DESCRI "
// 	cFieldsQry	+= " AE8_EQUIP, Coalesce(AED_DESCRI,''),"
// 	cFieldsQry	+= " AF9_GRPCOM, Coalesce(AE5_DESCRI,'') "

// 	SX3->(DBSETORDER(2))
// 	aFLDtMP	:=	Strtokarr2( cFields, ",", .F.)
// 	For nX := 1 To len(aFLDtMP)
// 		If !Empty(aFLDtMP[nX]) .and. SX3->(Dbseek(AllTrim(aFLDtMP[nX])))
// 			aAdd(aFIELDS, {SX3->X3_CAMPO, SX3->X3_TIPO, SX3->X3_TAMANHO, SX3->X3_DECIMAL})
// 		ElseIf !Empty(aFLDtMP[nX]) .and. !SX3->(Dbseek(AllTrim(aFLDtMP[nX])))
// 			aAdd(aFIELDS, {aFLDtMP[nX], "C", 8, 0})
// 		Else
// 			cc := ""
// 		EndIf
// 	Next nX
// 	oFWTMP	:=	FWTemporaryTable():New(cAliasTMP, aFIELDS )
// 	oFWTMP:Create()
// 	cSqlTemp	:=	oFWTMP:GetRealName()
// 	cSql := " ( ( AF9_START >= '" + cDateFrom + "' "
// 	cSql += "      AND AFA_START <= '" + cDateTo + "' ) "
// 	cSql += "     OR ( AF9_FINISH >= '" + cDateFrom + "' "
// 	cSql += "         AND AF9_FINISH <= '" + cDateTo + "' ) "
// 	cSql += "     OR ( AF9_START < '" + cDateFrom + "' "
// 	cSql += "         AND AF9_FINISH > '" + cDateTo + "' ) "
// 	If lDelayed
// 		cSql += "     OR  ( AF9_START < '"+cDateFrom+"'  "
// 		cSql += "    		AND AF9_DTATUF = '') "
// 	Endif
// 	cSql += "    		 )"
// 	cFilterResTeam := ""
// 	If cTeam <> Nil
// 		cFilterResTeam += " AND AED_EQUIP IN "+FormatIn(cTeam, ',')
// 	EndIf

// 	If cRes<> Nil
// 		cFilterResTeam += " AND AE8_RECURS IN "+FormatIn(cRes, ',')
// 	EndIf

// 	cSql += cFilterResTeam
// 	//Ignore delayed tasks
// 	/*
// 	cSql += "     OR  ( AF9_START < '"+cDateFrom+"'  "
// 	cSql += "    		AND AF9_DTATUF = '') )"
// */
// 	cInsert	:=	"INSERT INTO " + cSqlTemp + " ( " + cFields + ") "
// 	//cInsert	+=	" ( "
// 	cSelect	:=	" SELECT "+ cFieldsQry
// 	cSelect	+=	" FROM " + RetSqlName('AFA') + " AFA, " + RetSqlName('AF8') + " AF8, " + RetSqlName('AE8') +" AE8 "
// 	cSelect	+=  "   LEFT OUTER JOIN " + RetSqlName('AED') + " AED ON "
// 	cSelect	+=	"	  AED_FILIAL = '"+xFilial('AED')+"' AND AED.d_e_l_e_t_=' ' AND "
// 	cSelect	+=	"	  AE8_EQUIP = AED_EQUIP		,"
// 	cSelect +=   RetSqlName('AF9') + " AF9 "
// 	cSelect  += "  LEFT OUTER JOIN "+RetSqlName('AE5')+" AE5 ON "
// 	cSelect	+=	"				AE5_FILIAL = '"+xFilial('AE5')+"' AND AE5.d_e_l_e_t_=' ' AND "
// 	cSelect	+=	"			    AF9_GRPCOM = AE5_GRPCOM "
// 	cSelect	+=	"	WHERE 	AFA_FILIAL = '" + xFilial('AFA') + "' AND AFA.d_e_l_e_t_ = ' ' AND "
// 	cSelect	+=	"				AF8_FILIAL = '" + xFilial('AF8') + "' AND AF8.d_e_l_e_t_ = ' ' AND "
// 	cSelect	+=	"				AF9_FILIAL = '" + xFilial('AF9') + "' AND AF9.d_e_l_e_t_ = ' ' AND "
// 	cSelect	+=	"				AE8_FILIAL = '" + xFilial('AE8') + "' AND AE8.d_e_l_e_t_ = ' ' AND "
// //	cSelect	+=	"				AE5_FILIAL = '" + xFilial('AE5') + "' AND AE5.d_e_l_e_t_ = ' ' AND "
// 	// cSelect	+=	"				COALESCE(AED_FILIAL, '" + xFilial('AED') + "') = '" + xFilial('AED') + "' AND "
// 	// cSelect	+=	"				COALESCE(AED.D_E_L_E_T_ , ' ') = ' ' AND "
// 	// cSelect	+=	"				COALESCE(AE5_FILIAL, '" + xFilial('AE5') + "') = '" + xFilial('AE5') + "' AND "
// 	// cSelect	+=	"				COALESCE(AE5.D_E_L_E_T_ , ' ') = ' ' AND "
// 	cSelect	+=	"				AFA_PROJET = AF8_PROJET AND "
// 	cSelect	+=	"				AFA_PROJET = AF9_PROJET AND "
// 	cSelect	+=	"				AFA_TAREFA = AF9_TAREFA AND "
// 	cSelect	+=	"				AFA_REVISA = AF8_REVISA AND "
// 	cSelect	+=	"				AF9_REVISA = AF8_REVISA AND "
// //	cSelect	+=	"				AF9_GRPCOM = AE5_GRPCOM AND "
// 	cSelect	+=	"				AFA_RECURS = AE8_RECURS AND "

// 	If lAE8CalStd .And. lAE8Start .And. lAE8Finish
// 		cSelect	+=	"				AE8_START  <= '" + cDateTo + "' AND "
// 		cSelect	+=	"				(AE8_FINISH = '' OR AE8_FINISH >= '" + cDateFrom + "') AND "
// 	EndIf

// 	cSelect	+=	cSql
// 	cSelect	+=	"	ORDER BY AE8_EQUIP, AFA_RECURS, AF9_GRPCOM, AF9_START, AF9_HORAI, AF8_PROJET, AF8_REVISA, AF9_TAREFA  "

// 	cSelect := ChangeQuery(cSelect)

// 	cInsert := cInsert + cSelect

// 	tcSqlExec(cInsert)
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault += CRLF + cError
// 	EndIf

// 	cInsert	:=	"INSERT INTO " + cSqlTemp + " (AE8_RECURS, AE8_DESCRI, AE8_UMAX, AED_EQUIP, AED_DESCRI
// 	If lAE8CalStd
// 		cInsert	+= ", AE8_CALSTD "
// 	EndIf
// 	cInsert	+=  ") "
// 	// cInsert	+=	"("
// 	cSelect	:=	" SELECT AE8_RECURS, AE8_DESCRI, AE8_UMAX, AED_EQUIP, AED_DESCRI "

// 	If lAE8CalStd
// 		cSelect	+=	", AE8_CALSTD "
// 	EndIf

// 	cSelect	+=	" FROM " + RetSqlName('AE8') + " AE8 LEFT OUTER JOIN " + RetSqlName('AED') + " AED ON "
// 	cSelect	+=	"	AE8_EQUIP = AED_EQUIP "

// 	cSelect	+=	"	WHERE AE8_FILIAL = '" + xFilial('AE8') + "' AND AE8.d_e_l_e_t_ = ' ' AND "
// 	cSelect	+=	"		AE8_RECURS NOT IN (SELECT DISTINCT AE8_RECURS FROM " + cSqlTemp + ") AND "
// 	cSelect	+=	"				COALESCE(AED_FILIAL, '" + xFilial('AED') + "') = '" + xFilial('AED') + "' AND "
// 	cSelect	+=	"				COALESCE(AED.D_E_L_E_T_ , ' ') = ' ' "

// 	If lAE8CalStd .And. lAE8Start .And. lAE8Finish
// 		cSelect	+=	"				AND AE8_START  <= '" + cDateTo + "'  "
// 		cSelect	+=	"				AND (AE8_FINISH = '' OR AE8_FINISH >= '" + cDateFrom + "')  "
// 	EndIf

// 	// cSelect	+=	"				AE8_USER <> ' ' "
// 	cSelect += cFilterResTeam

// 	cSelect := ChangeQuery(cSelect)

// 	cInsert := cInsert + cSelect

// 	tcSqlExec(cInsert)
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault	+= CRLF+cError
// 	EndIf

// 	dbSelectArea(cAliasTMP)
// 	DbGotop()
// 	//Update task time in period selected
// 	dDateFrom   := Stod(cDateFrom)
// 	dDateTo     := Stod(cDateTo)
// 	aTimeCalc	:=	{}
// 	While !EoF()
// 		nHoursBefore	:=	0
// 		nTimeDelay		:=	0
// 		If AFA_QUANT > 0
// 			If AF9_START < dDateFrom .and. Empty(AF9_DTATUF)
// 				If (nPosT:=Ascan(aTimeCalc,{|x| x[1]==DtoS(AF9_START)+AF9_HORAI+DtoS(Min(dDateFrom-1,AF9_FINISH))+AF9_HORAF+AF9_CALEND+AF8_PROJET}))>0
// 					nHoursBefore:=	aTimeCalc[nPost,2]
// 				Else
// 					nHoursBefore	:=	PmsHrsItv2(AF9_START,AF9_HORAI,Min(dDateFrom-1,AF9_FINISH),AF9_HORAF,AF9_CALEND,AF8_PROJET)
// 					aAdd(aTimeCalc,{DtoS(AF9_START)+AF9_HORAI+DtoS(Min(dDateFrom-1,AF9_FINISH))+AF9_HORAF+AF9_CALEND+AF8_PROJET,nHoursBefore})
// 				EndIf
// 			EndIf

// 			If (nPosT:=Ascan(aTimeCalc,{|x| x[1]==DtoS(Max(dDateFrom,AF9_START))+AF9_HORAI+DtoS(Min(dDateTo,AF9_FINISH))+AF9_HORAF+AF9_CALEND+AF8_PROJET}))>0
// 				nTimePer:=	aTimeCalc[nPost,2]
// 			Else
// 				nTimePer	:=	PmsHrsItv2(Max(dDateFrom,AF9_START),AF9_HORAI,Min(dDateTo,AF9_FINISH),AF9_HORAF,AF9_CALEND,AF8_PROJET)
// 				aAdd(aTimeCalc,{DtoS(Max(dDateFrom,AF9_START))+AF9_HORAI+DtoS(Min(dDateTo,AF9_FINISH))+AF9_HORAF+AF9_CALEND+AF8_PROJET,nTImePer})
// 			EndIf


// 			If (nPosT:=Ascan(aTimeCalc,{|x| x[1]==DtoS(AF9_START)+AF9_HORAI+DtoS(AF9_FINISH)+AF9_HORAF+AF9_CALEND+AF8_PROJET}))>0
// 				nTimeTot:=	aTimeCalc[nPost,2]
// 			Else
// 				nTimeTot	:=	PmsHrsItv2(AF9_START,AF9_HORAI,AF9_FINISH,AF9_HORAF,AF9_CALEND,AF8_PROJET)
// 				aAdd(aTimeCalc,{DtoS(AF9_START)+AF9_HORAI+DtoS(AF9_FINISH)+AF9_HORAF+AF9_CALEND+AF8_PROJET,nTimeTot})
// 			EndIf

// 			If nTimeTot == 0
// 				nTimeTOT	:=	nTimePer
// 			EndIf
// 			nTimeAloc	:=	AFA_QUANT
// 			nTimeTsk		:=	nTimeAloc* (nTimePer/nTimeTot)
// 			If nHoursBefore > 0
// 				nPercCompl	:=	PmsPOCAF9(AF8_PROJET,AF8_REVISA,AF9_TAREFA)/100
// 				nDoneHours	:=	nPercCompl * nTimeTot
// 				//nDelayPerc	:= nTimeDelay/nTimeTot
// 				nTimeDelay	:=	nHoursBefore - nDoneHours

// 				nTimeDelay	:=	(AFA_QUANT/ nTimeTOT) * nTimeDelay
// 				If nTimeDelay < 0
// 					nTimeDelay :=	0
// 				EndIf
// 			EndIf
// 			//aAdd(aTasks,{AF9_PROJET,AF9_TAREFA,nTimeTsk})
// 			RecLock(cAliasTMP,.F.)
// 			TOT_AL_TSK	+=	nTimeTsk
// 			TOT_DE_TSK	+=	nTimeDelay
// 			MsUnLock()
// 		EndIf
// 		If Ascan(aRes,{|x| x[1]==AE8_RECURS}) == 0
// 			aAdd(aRes,{AE8_RECURS,iif(lAE8CalStd, AE8_CALSTD, ''),AED_EQUIP,iif(lAE8Start,AE8_START,dDateFrom),Iif(!lAE8Finish.Or.Empty(AE8_FINISH),ddateto,AE8_FINISH)})
// 		EndIf
// 		DbSelectArea(cAliasTMP)
// 		DbSkip()
// 	Enddo
// 	//UPDATE RESOURCE ALLOCATION
// 	//cUpdate	:= 'UPDATE '+cSqlTemp+ " A SET TOT_AL_RES= (SELECT SUM(TOT_AL_TSK) FROM "+cSqlTemp+" B WHERE A.AE8_RECURS=B.AE8_RECURS ) "
// 	//tcSqlExec(cUpdate)
// 	//UPDATE TEAM ALLOCATION
// 	//	cUpdate	:= 'UPDATE '+cSqlTemp+ " A SET TOT_AL_TEA= (SELECT SUM(TOT_AL_TSK) FROM "+cSqlTemp+" B WHERE A.AED_EQUIP=B.AED_EQUIP ) "
// 	//	tcSqlExec(cUpdate)

// 	//Update resorces availability in period selected
// 	For nX:=1 To Len(aRes)

// 		nTimeRes	:=	PmsHrsItv2(MAX(dDateFrom,ARES[nX,4]),"00:00",Min(dDateTo,aRes[nX,5]),"24:00",IIf(aRes[nX,2]<>"",aRes[nX,2],'001'),,aRes[nX,1])
// 		tcSqlExec('UPDATE '+cSqlTemp+ " SET TOT_AV_RES="+STR(nTimeRes)+" WHERE AE8_RECURS='"+aRes[nX,1]+"'")
// 		cError	:=	TCSQLError()
// 		If !Empty(cError)
// 			cResFault	+= CRLF+cError
// 		EndIf
// 		tcSqlExec('UPDATE '+cSqlTemp+ " SET TOT_AV_TEA=TOT_AV_TEA+"+STR(nTimeRes)+" WHERE AED_EQUIP='"+aRes[nX,3]+"'")
// 		cError	:=	TCSQLError()
// 		If !Empty(cError)
// 			cResFault	+= CRLF+cError
// 		EndIf
// 	Next nX

// 	//UPDATE RESOURCE AVAILABILITY
// 	cUpdate	:= 'UPDATE '+cSqlTemp+ " A SET AL_PER_RES=( CASE WHEN TOT_AV_RES=0 THEN 0 ELSE TOT_AL_RES/TOT_AV_RES END  )*100 "
// 	tcSqlExec(cUpdate)
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault	+= CRLF+cError
// 	EndIf
// 	//UPDATE TEAM AVAILABILITY
// 	cUpdate	:= 'UPDATE '+cSqlTemp+ " A SET AL_PER_TEA=( CASE WHEN TOT_AV_TEA=0 THEN 0 ELSE TOT_AL_TEA/TOT_AV_TEA END  )*100 "
// 	tcSqlExec(cUpdate)
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault	+= CRLF+cError
// 	EndIf

// 	//UPDATE EMPTY ALOCATION
// 	cUpdate	:= 'UPDATE '+cSqlTemp+ " A SET AF9_DESCRI='NO ALLOCATION', AF9_START = '"+cDateFrom+"',AF9_FINISH = '"+cDateTo+"' WHERE AF9_TAREFA = '' "
// 	tcSqlExec(cUpdate)
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault	+= CRLF+cError
// 	EndIf

// 	DbCloseArea()


// 	cTable := '%'+cSqlTemp+'%'
// 	jsonRet['list'] 	:= {}
// 	jsonRet['resources']:= {}
// 	jsonRet['teams'] 	:= {}
// 	jsonRet['costCollector'] 	:= {}
// 	If lTasks
// 		jsonRet['projects'] := {}
// 		jsonRet['types'] 	:= {}
// 	Endif
// 	If nTipoRet == GROUP_RES
// 		BeginSql alias cAlias
// 			SELECT AE8_RECURS,AE8_DESCRI, AED_EQUIP, AED_DESCRI, Sum(TOT_DE_TSK) TOT_DE_TSK, Sum(TOT_AL_TSK) TOT_AL_TSK,  MAX(TOT_AV_RES) TOT_AV_RES  from 	%Exp:cTable% 
// 			GROUP by AE8_RECURS,AE8_DESCRI, AED_EQUIP, AED_DESCRI
// 			ORDER BY AED_EQUIP,AE8_RECURS
// 		EndSql
// 		While !EoF()
// 			jRetTmp := JsonObject():New()
// 			jRetTmp["resource"]	:=	AllTrim(AE8_RECURS)
// 			jRetTmp["team"]		:=	AllTrim(AED_EQUIP)
// 			jRetTmp["delay"]	:=	TOT_DE_TSK
// 			jRetTmp["allocation"]:=	TOT_AL_TSK
// 			jRetTmp["availability"]:=	TOT_AV_RES
// 			jRetTmp["percent"]	:=	If(TOT_AV_RES<> 0,(TOT_AL_TSK/TOT_AV_RES),0)
// 			If Ascan(jsonRet['resources'],{|x| x['id']==AllTrim(AE8_RECURS)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] := AllTrim(AE8_RECURS)
// 				jTmp['label'] := AllTrim(AE8_DESCRI)
// 				aAdd(jsonRet['resources'],jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 			If Ascan(jsonRet['teams'],{|x| x['id']==AllTrim(AED_EQUIP)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] := AllTrim(AED_EQUIP)
// 				If Empty(Alltrim(AED_EQUIP))
// 					jTmp['label'] 	:= 'Undefined'
// 				Else
// 					jTmp['label'] := AllTrim(AED_DESCRI)
// 				Endif
// 				aAdd(jsonRet['teams'],jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 			If lTasks
// 				jRetTmp['tasks'] := addTasks(jsonRet = @jsonRet,cTable=cTable,cRes=AllTrim(AE8_RECURS))
// 			Else
// 				jRetTmp['tasks'] := Nil
// 			Endif
// 			aadd(jsonRet['list'],jRetTmp)
// 			FreeObj(jRetTmp)
// 			DbSkip()
// 		Enddo
// 	ElseIf nTipoRet == GROUP_TEAM
// 		BeginSql alias cAlias
// 			SELECT AED_EQUIP,AED_DESCRI, Sum(TOT_AL_TSK) TOT_AL_TSK, Sum(TOT_DE_TSK) TOT_DE_TSK,  MAX(TOT_AV_TEA) TOT_AV_TEA  from 	%exp:cTable%
// 			GROUP by AED_EQUIP,AED_DESCRI
// 			ORDER BY AED_EQUIP
// 		EndSql
// 		While !EoF()
// 			jRetTmp := JsonObject():New()
// 			jRetTmp["team"]		:=	AllTrim(AED_EQUIP)
// 			jRetTmp["delay"]	:=	TOT_DE_TSK
// 			jRetTmp["allocation"]:=	TOT_AL_TSK
// 			jRetTmp["availability"]:=	TOT_AV_TEA
// 			jRetTmp["percent"]	:=	If(TOT_AV_TEA<> 0,(TOT_AL_TSK/TOT_AV_TEA),0)
// 			If Ascan(jsonRet['teams'],{|x| x['id']==AllTrim(AED_EQUIP)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] := Alltrim(AED_EQUIP)
// 				If Empty(Alltrim(AED_EQUIP))
// 					jTmp['label'] 	:= 'Undefined'
// 				Else
// 					jTmp['label'] := AllTrim(AED_DESCRI)
// 				Endif
// 				aAdd(jsonRet['teams'],jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 			If lTasks
// 				jRetTmp['tasks'] := addTasks(jsonRet = @jsonRet,cTable=cTable,cTeam=AllTrim(AED_EQUIP))
// 			Else
// 				jRetTmp['tasks'] := Nil
// 			Endif
// 			aadd(jsonRet['list'],jRetTmp)
// 			DbSkip()
// 		Enddo
// 	EndIf
// 	DbCloseArea()
// 	cError	:=	TCSQLError()
// 	If !Empty(cError)
// 		cResFault	+= CRLF+cError
// 	EndIf
// 	If !Empty(cResFault)
// 		SetRestFault(100,cResFault)
// 	EndIf
// 	//jJsonRet := JsonObject():New()
// 	//jJsonRet:FromJson(cRet)
// 	oFWTMP:Delete()
// Return jsonRet


// Static Function AddTasks(jSonRet,cTable, cRes,cTeam)
// 	Local cAliasBkp := Alias()
// 	Local cAlias := GetNextAlias()
// 	Local cWhere
// 	Local aRet := {}
// 	Local jRetTmp
// 	If cRes <> Nil
// 		cWhere :=	"% AE8_RECURS = '"+cRes+"' %"
// 	ElseIf cTeam <> Nil
// 		cWhere :=	"% AED_EQUIP = '"+cTeam+"' %"
// 	Endif
// 	BeginSql alias cAlias
// 	SELECT * from 	%Exp:cTable% 
// 	WHERE %Exp:cWhere%
// 	ORDER BY AED_EQUIP,AE8_RECURS, AF8_PROJET,AF9_TAREFA
// 	EndSql
// 	While !Eof()

// 		jRetTmp := TaskObject(cAlias, cAlias, cAlias, cAlias, cAlias, cAlias)

// 		jRetTmp["hUsed"]	:=	RetUsed(AF8_PROJET,AF9_TAREFA,AE8_RECURS)
// 		jRetTmp["hDelayed"]	:=	TOT_DE_TSK
// 		jRetTmp["poc"]		:=	PmsPOCAF9(AF8_PROJET,AF8_REVISA,AF9_TAREFA)/100

// 		If Ascan(jsonRet['projects'],{|x| x['id']==alltrim(AF8_PROJET)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AF8_PROJET)
// 			jTmp['label'] := AllTrim(AF8_DESCRI)
// 			aAdd(jsonRet['projects'],jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(jsonRet['resources'],{|x| x['id']==alltrim(AE8_RECURS)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AE8_RECURS)
// 			jTmp['label'] := AllTrim(AE8_DESCRI)
// 			aAdd(jsonRet['resources'],jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(jsonRet['types'],{|x| x['id']==Alltrim(AE5_GRPCOM)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AE5_GRPCOM)
// 			If Empty(Alltrim(AE5_GRPCOM))
// 				jTmp['label'] 	:= 'Undefined'
// 			Else
// 				jTmp['label'] := AllTrim(AE5_DESCRI)
// 			Endif
// 			aAdd(jsonRet['types'],jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(jsonRet['costCollector'],{|x| x['id']==Alltrim(AF8_TPPRJ)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AF8_TPPRJ)
// 			If Empty(Alltrim(AF8_TPPRJ))
// 				jTmp['label'] 	:= 'Undefined'
// 			Else
// 				jTmp['label'] 	:= AllTrim(TABELA('FE',AF8_TPPRJ))
// 			Endif
// 			aAdd(jsonRet['costCollector'],jTmp)
// 			FreeObj(jTmp)
// 		EndIf

// 		aadd(aRet,jRetTmp)
// 		FreeObj(jRetTmp)
// 		DbSkip()
// 	Enddo
// 	DbCloseArea()
// 	DbSelectArea(cAliasBkp)

// Return aRet
// /*/{Protheus.doc} GetPoc
// Get Percentage of compression for a task
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cPrj, character, Project code
// @param cTsk, character, TaskCode
// @param cDate, character, Date in DTOS format
// @Return Json, Json Object
// /*/
// Static Function GetPoc(cPrj, cTsk, cDate)

// 	Local cRet := "" As Character
// 	Local jJsonRet As Json

// 	cRet := '{"COMPLETED": ' + AllTrim(STR(PmsPOCAF9(cPrj, Nil, cTsk, Stod(cDate)), 7, 2)) + '}'

// 	jJsonRet := JsonObject():New()

// 	jJsonRet:FromJson(cRet)

// Return jJsonRet

// /*/{Protheus.doc} GetTsk
// Get detailed tasks
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cRes, character, Resources (comma separated)
// @param cEqp, character, Teams (comma separated)
// @param cPrj, character, Projects (comma separated)
// @param cType, character, Task types  (comma separated)
// @param cTskSit, character, Task situation => ClosedWithDelay = '1', Closed = '3', Delayed = '2', Open = '4', All = '0' or Nil
// @param cDaysRef, character, Reference days (default is 30 days back and valid only for delayed and closed with delay task situations)
// @param cCC, character, Cost Collectors  (comma separated)
// @param lPoc, logical, POC values
// @param lCPI, logical, Return Cost performance index
// @param lSPI, logical, Return Schedule performance index
// @param lPredec, logical, Return predecessors quantity
// @Return Json, Json Object
// /*/
// Static Function GetTsk(cRes, cEqp, cPrj, cType, cTskSit, cDaysRef, cCC,lPOC, lCPI, lSPI, lPredec)
// 	Local cQuery   := ""
// 	Local cFinalQuery   := ""
// 	Local cAliasQry:= ""
// 	Local nDaysRef
// 	Local aTasks  	:= {}
// 	Local jJsonRet as Json
// 	Local nX
// 	Local aQryVars := {}
// 	Local oStatement := FWPreparedStatement():New()
// 	Local aCote := {}
// 	Local aCrte := {}
// 	Local aCotp := {}
// 	Local nCote := 0
// 	Local nCrte := 0
// 	Local nCotp := 0

// 	Default cEqp      := ""
// 	Default cRes      := ""
// 	Default cTypr     := ""
// 	Default cSqlPrj   := ""
// 	Default cCC   		:= ""
// 	Default cDaysRef	:='30'
// 	Default cTskSit 	:= 1
// 	Default lPOC 		:= .F.
// 	Default lCPI 		:= .F.
// 	Default lSPI 		:= .F.
// 	Default lPredec 	:= .T.

// 	nDaysRef	:=	Val(cDaysRef)

// 	cAliasQry := GetNextAlias()

// 	cQuery   := "SELECT AF9.*,AFC_DESCRI,AE8_RECURS,AED_EQUIP,AED_DESCRI,AE8_DESCRI,Af8_PROJET,AF8_TPPRJ,af8_descri,COALESCE(afa_quant,0) AFA_QUANT FROM "+RetSqlName('AFC')+" AFC, "+RetSqlName('AF8')+" AF8, "
// 	cQuery   += RetSqlName('AF9')+" AF9 "
// 	cQuery   += "  LEFT OUTER JOIN "+RetSqlName('AFA')+" AFA ON "
// 	cQuery   += "  			AFA_FILIAL = '"+xFilial('AFA')+"' AND AFA.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AFA_REVISA = AF9_REVISA AND "
// 	cQuery	+=	"				AFA_PROJET = AF9_PROJET AND "
// 	cQuery	+=	"				AFA_TAREFA = AF9_TAREFA "
// 	cQuery   += "  LEFT OUTER JOIN "+RetSqlName('AE8')+" AE8 ON "
// 	cQuery	+=	"				AE8_FILIAL = '"+xFilial('AE8')+"' AND AE8.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"			   COALESCE(AFA_RECURS,'UNDEFINED      ') = AE8_RECURS "
// 	cQuery   += "  LEFT OUTER JOIN "+RetSqlName('AE5')+" AE5 ON "
// 	cQuery	+=	"				AE5_FILIAL = '"+xFilial('AE5')+"' AND AE5.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"			    AF9_GRPCOM = AE5_GRPCOM "
// 	cQuery   += "  LEFT OUTER JOIN "+RetSqlName('AED')+" AED ON
// 	cQuery	+=	"				AED_FILIAL = '"+xFilial('AED')+"' AND AED.D_E_L_E_T_  = ' ' AND "
// 	cQuery   += "				AE8_EQUIP = AED_EQUIP	"
// 	cQuery	+=	"	WHERE
// 	cQuery	+=	"				AF8_FILIAL = '"+xFilial('AF8')+"' AND AF8.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AF9_FILIAL = '"+xFilial('AF9')+"' AND AF9.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AF9_REVISA = AF8_REVISA AND "
// 	cQuery	+=	"				AF9_PROJET = AF8_PROJET AND "
// 	cQuery	+=	"				AFC_FILIAL = '"+xFilial('AFC')+"' AND AFC.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AFC_REVISA = AF8_REVISA AND "
// 	cQuery	+=	"				AFC_EDT	  = AF9_EDTPAI AND "
// 	cQuery	+=	"				AFC_PROJET = AF8_PROJET "
	
// //CLOSED WITH DELAY
// 	If cTskSit == '1'
// 		cQuery	+=	"			AND	AF9_DTATUF  >=  '"+DtoS(dDatabase-nDaysRef) + "' AND "
// 		cQuery	+=	"				AF9_DTATUF > AF9_FINISH  AND "
// 		cQuery	+=	"				AF9_DTATUF <> '' "
// //Opened and delayed   
// 	ElseIf cTskSit == '2'
// 		cQuery	+=	"				AF9_DTATUF <> ''  "
// 		cQuery	+=	"			AND AF8_ENCPRJ <> '1' AND "
// 		cQuery	+=	"				AF9_DTATUF = '' AND "
// 		cQuery	+=	"				AF9_FINISH < '"+DtoS(dDatabase)+"' "
// //All Closed
// 	ElseIf cTskSit == '3'
// 		cQuery	+=	"			AND AF9_DTATUF >=  '"+DtoS(dDatabase-nDaysRef) + "' AND "
// //All Open
// 	ElseIf cTskSit == '4'
// 		cQuery	+=	"			AND AF9_DTATUF = ''  "
// 	EndIf

// 	If cEqp <> Nil .And. !Empty(cEqp)
// 		aTmpFormatIn := SafeFormatIn(cEqp, ',')
// 		cQuery += " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cRes<> Nil .And. !Empty(cRes)
// 		aTmpFormatIn := SafeFormatIn(cRes, ',')
// 		cQuery += " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cPrj<> Nil .And. !Empty(cPrj)
// 		aTmpFormatIn := SafeFormatIn(cPrj, ',')
// 		cQuery += " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cCC<> Nil .And. !Empty(cCC) 
// 		aTmpFormatIn := SafeFormatIn(cCC, ',')
// 		cQuery	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cType<> Nil .And. !Empty(cType) 
// 		aTmpFormatIn := SafeFormatIn(cType, ',')
// 		cQuery	+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	cQuery	+=	"				ORDER BY AE8_RECURS, AF9_START,AF9_TAREFA"
// 	cQuery := ChangeQuery(cQuery)

// 	//Define a consulta e os parâmetros
// 	oStatement:SetQuery(cQuery)
// 	oStatement:setParams(aQryVars)	
// 	//Recupera a consulta já com os parâmetros injetados
// 	cFinalQuery := oStatement:GetFixQuery()
// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cFinalQuery), cAliasQry, .F., .T.)

// 	aTeam		:=	{}
// 	aRecurs		:=	{}
// 	aType		:=	{}
// 	aPrj		:=	{}
// 	aCC			:=	{}
// 	While !Eof()
// 		If lPredec
// 			cQueryAFD	:=	'SELECT COUNT(*) AS CONTA FROM '
// 			cQueryAFD	+=	 RETSQLNAME('AFD')+' AFD,'
// 			cQueryAFD	+=	 RETSQLNAME('AF9')+' AF9 WHERE '
// 			cQueryAFD	+=	" AFD_FILIAL ='"+xFilial('AFD') + "' AND "
// 			cQueryAFD	+=	" AFD_PROJET ='"+AF8_PROJET+ "' AND "
// 			cQueryAFD	+=	" AFD_REVISA ='"+AF9_REVISA+ "' AND "
// 			cQueryAFD	+=	" AFD_TAREFA ='"+AF9_TAREFA+ "' AND "
// 			//cQueryAFD	+=	" AFD_TIPO ='1' AND "
// 			cQueryAFD	+=	" AF9_FILIAL ='"+xFilial('AF9') + "' AND "
// 			cQueryAFD	+=	" AF9_TAREFA = AFD_PREDEC AND "
// 			cQueryAFD	+=	" AF9_PROJET ='"+AF8_PROJET+ "' AND "
// 			cQueryAFD	+=	" AF9_REVISA ='"+AF9_REVISA+ "' AND "
// 			cQueryAFD	+=	" AF9_DTATUF ='' AND "
// 			cQueryAFD	+=	" afd.d_e_l_e_t_ =' ' AND "
// 			cQueryAFD	+=	" af9.d_e_l_e_t_ =' '  "

// 			cQueryAFD := ChangeQuery(cQueryAFD)

// 			cAlias	:=	Alias()
// 			dbUseArea(.T., "TOPCONN", TCGenQry(,,cQueryAFD), cAliasQry+"AFD", .F., .T.)
// 			nConta:=	CONTA
// 			DbCloseArea()
// 		Else
// 			nConta := Nil
// 		Endif
// 		dbselectArea(cAliasQry)
// 		nSPI 	:= Nil
// 		nCPI 	:= Nil
// 		nPOC 	:= Nil
// 		nCRTE 	:= Nil
// 		nCOTE 	:= Nil
// 		nCOTP 	:= Nil
// 		aCRTE 	:= {}
// 		aCOTP 	:= {}
// 		//Need to guarantee that AF and AFF are open
// 		if lPoc	.or. lSPI .or. lCPI
// 			DbSelectArea('AF9')
// 			DbSelectArea('AFF')
// 			dbselectArea(cAliasQry)
// 		Endif
// 		If lPOC
// 			dDate := date()
// 			nPoc	:=	PmsPocAF9(AF8_PROJET, AF9_REVISA, AF9_tarefa, dDate)/100
// 		Endif
// 		if lSPI .Or. lCPI
// 			dDate := dDate-1
// 			nCOTE	:=	PmsRetCOTE(aCOTE,1,AF9_TAREFA,.T.)[1]
// 			If lCPI
// 				aCRTE	:=	PmsIniCRTE(AF8_PROJET,AF9_REVISA,dDate,AF9_tarefa,AF9_tarefa)
// 				nCRTE	:=	PmsRetCRTE(aCRTE,1,AF9_TAREFA,.T.)[1]
// 				If nCRTE<>0
// 					nCPI	:=	nCOTE/nCRTE
// 				EndIf
// 			Endif
// 			If lSPI
// 				aCOTP	:=	PmsIniCOTP(AF8_PROJET,AF9_REVISA,dDate,AF9_tarefa,AF9_tarefa,/*lAcumulado*/.T.,@aCOTP)
// 				nCOTP	:=	PmsRetCOTP(aCOTP,1,AF9_TAREFA,.T.)[1]
// 				If nCOTP<>0
// 					nSPI	:=	nCOTE/nCOTP
// 				EndIf
// 			Endif
// 		EndIf

// 		jTsk := TaskObject(cAliasQry, cAliasQry, cAliasQry, cAliasQry, cAliasQry, cAliasQry)

// 		jTsk['predOpen'] 		:= nConta
// 		jTsk['wbsDescription'] 	:= AllTrim(AFC_DESCRI)

// 		If lPOC
// 			jTsk["poc"]		:=	nPOC
// 		Endif
// 		If lSPI
// 			jTsk["bcWs"]	:=	nCOTP
// 			jTsk["bcWp"]	:=	nCOTE
// 			jTsk["spi"]		:=	nSPI
// 		Endif
// 		if lCPI
// 			jTsk["acWp"]	:=	nCRTE
// 			jTsk["cpi"]		:=	nCPI
// 		Endif
// 		aadd(aTasks,jTsk)
// 		FreeObj(jTsk)
// 		If Ascan(aPrj,{|x| x['id']==Alltrim(AF8_PROJET)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AF8_PROJET)
// 			jTmp['label'] := AllTrim(AF8_DESCRI)
// 			aAdd(aPrj,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(aTeam,{|x| x['id']==Alltrim(AED_EQUIP)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AED_EQUIP)
// 			If Empty(Alltrim(AED_EQUIP))
// 				jTmp['label'] 	:= 'Undefined'
// 			Else
// 				jTmp['label'] 	:= AllTrim(AED_DESCRI)
// 			Endif
// 			aAdd(aTeam,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(aRecurs,{|x| x['id']==AllTrim(AE8_recurs)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AE8_recurs)
// 			jTmp['label'] 	:= AllTrim(AE8_descri)
// 			aAdd(aRecurs,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		If Ascan(aType,{|x| x['id']==Alltrim(AF9_GRPCOM)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim((cAliasQry)->AF9_GRPCOM)
// 			If Empty(Alltrim(AF9_GRPCOM))
// 				jTmp['label'] 	:= 'Undefined'
// 				jTmp['color'] 	:=  Nil
// 			Else
// 				AE5->(DbSetorder(1))
// 				AE5->(MsSeek(xFilial()+(cAliasQry)->AF9_GRPCOM))
// 				jTmp['label'] 	:= AllTrim(AE5->AE5_DESCRI)
// 				jTmp['color'] 	:= Iif(fieldPos('AE5_COLOR') > 0 , AE5->AE5_COLOR, Nil)
// 			Endif
// 			aAdd(aType,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
		
// 		If Ascan(aCC,{|x| x['id']==Alltrim(AF8_TPPRJ)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AF8_TPPRJ)
// 			If Empty(Alltrim(AF8_TPPRJ))
// 				jTmp['label'] 	:= 'Undefined'
// 			Else
// 				jTmp['label'] 	:= AllTrim(TABELA('FE',AF8_TPPRJ))
// 			Endif
// 			aAdd(aCC,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		DbSkip()
// 	Enddo
// // //Add original type to list
// // 	If !Empty(cType)
// // 		If Ascan(aType,{|x| x['id']==Alltrim(cType)}) == 0
// // 			AE5->(DbSetorder(1))
// // 			AE5->(MsSeek(xFilial()+cType))
// // 			jTmp := JsonObject():New()
// // 			jTmp['id'] 		:= Alltrim((cAliasQry)->AE5_GRPCOM)
// // 			jTmp['label'] 	:= AllTrim(AE5->AE5_DESCRI)
// // 			jTmp['color'] 	:= Iif(fieldPos('AE5_COLOR') > 0 , AE5->AE5_COLOR, Nil)
// // 			aAdd(aType,jTmp)
// // 			FreeObj(jTmp)
// // 		EndIf
// // 	EndIf
// 	DbCloseArea()
// 	jJsonRet := JsonObject():New()
// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['tasks'] := aTasks
// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['resources'] := aRecurs
// 	aPrj	:=	aSort(aPrj,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['projects'] := aPrj
// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['teams'] := aTeam
// 	aType	:=	aSort(aType,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['types'] := aType
// 	aCC	:=	aSort(aCC,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['costCollectors'] := aCC

// Return jJsonRet


// /*/{Protheus.doc} GetTskGnt
// Get detailed open tasks
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cRes, character, Resources (comma separated)
// @param cEqp, character, Teams (comma separated)
// @param cPrj, character, Projects (comma separated)
// @param cType, character, Task types  (comma separated)
// @param cCC, character, param_description
// @param cStartFrom, character, param_description
// @param cStartTo, character, param_description
// @Return Json, Json Object
// /*/
// // TODO: REMOVE custom fields from AE5
// Static Function GetTskGnt(cRes, cEqp, cPrj, cType, cCC, cStartFrom, cStartTo)
// 	Local cQuery   := ""
// 	Local cAliasQry:= ""
// 	Local cRetTypes:=	""
// 	Local cRetTeam	:=	""
// 	Local cRetRes	:=	""
// 	Local nX
// 	Local cRetAlloc	:=	""
// 	Local dDate:=""
// 	Local jJsonRet As Json
// 	Default cEqp      := ""
// 	Default cRes      := ""
// 	Default cTypr     := ""
// 	Default cSqlPrj   := ""
// 	Default cCC   		:= ""

// 	Default cTskSit 	:= 1

// 	cAliasQry:= GetNextAlias()

// 	cQuery   := "SELECT AF9.*,AE5_CTCPI,AE5_CTSPI,AFC_DESCRI,AE5_GROUP,AE8_RECURS,AED_EQUIP,AED_DESCRI,AE8_DESCRI,Af8_PROJET,AF8_TPPRJ,af8_descri,afa_quant FROM "+RetSqlName('AFC')+" AFC, "+RetSqlName('AE5')+" AE5, "+RetSqlName('AF8')+" AF8, "
// 	cQuery   += RetSqlName('AF9')+" AF9 "
// 	cQuery   += "  INNER JOIN "+RetSqlName('AFA')+" AFA ON "
// 	cQuery   += "  			AFA_FILIAL = '"+xFilial('AFA')+"' AND AFA.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AFA_REVISA = AF9_REVISA AND "
// 	cQuery	+=	"				AFA_PROJET = AF9_PROJET AND "
// 	cQuery	+=	"				AFA_TAREFA = AF9_TAREFA "
// 	cQuery   += "  INNER JOIN "+RetSqlName('AE8')+" AE8 ON "
// 	cQuery	+=	"				AE8_FILIAL = '"+xFilial('AE8')+"' AND AE8.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"			   COALESCE(AFA_RECURS,'UNDEFINED      ') = AE8_RECURS "
// 	cQuery   += "  INNER JOIN "+RetSqlName('AED')+" AED ON
// 	cQuery	+=	"				AED_FILIAL = '"+xFilial('AED')+"' AND AED.D_E_L_E_T_  = ' ' AND "
// 	cQuery   += "				AE8_EQUIP = AED_EQUIP	"
// 	cQuery	+=	"	WHERE
// 	cQuery	+=	"				AF8_FILIAL = '"+xFilial('AF8')+"' AND AF8.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AF8_DESCRI not like 'NOT PROJECT%' AND "
// 	cQuery	+=	"				AF9_FILIAL = '"+xFilial('AF9')+"' AND AF9.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AF9_REVISA = AF8_REVISA AND "
// 	cQuery	+=	"				AF9_PROJET = AF8_PROJET AND "
// 	cQuery	+=	"				AFC_FILIAL = '"+xFilial('AFC')+"' AND AFC.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AFC_REVISA = AF8_REVISA AND "
// 	cQuery	+=	"				AFC_EDT	  = AF9_EDTPAI AND "
// 	cQuery	+=	"				AFC_PROJET = AF8_PROJET AND "
// 	cQuery	+=	"				AE5_FILIAL = '"+xFilial('AE5')+"' AND AE5.d_e_l_e_t_=' ' AND "
// 	cQuery	+=	"				AF9_GRPCOM = AE5_GRPCOM AND "
// 	cQuery	+=	"				AF9_START  BETWEEN '"+cStartFrom + "' and '"+cStartTo + "' AND "
// 	cQuery	+=	"				AF9_DTATUF = ''  "

// 	If !Empty(cRes)
// 		cQuery	+=	" AND AE8_RECURS='"+cRes+"' "
// 	EndIf
// 	If !Empty(cType)
// 		DbSelectArea('AE5')
// 		DbSetOrder(3)
// 		DbSeek(xFilial()+cType)
// 		cRetTypes:=	"'"+cType +"'"
// 		While !Eof() .and. AE5_FILIAL+AE5_GROUP==xFilial()+cType
// 			cRetTypes+=	",'"+ae5_grpcom +"'"
// 			DbSkip()
// 		Enddo
// 		cQuery	+=	" AND AE5_GRPCOM in ("+cRetTypes +") "
// 	EndIf
// 	If !Empty(cEqp)
// 		cQuery	+=	" AND AED_EQUIP='"+cEqp+"' "
// 	EndIf
// 	If !Empty(cPrj)
// 		cQuery	+=	" AND AF8_PROJET='"+cPrj+"' "
// 	EndIf
// 	If !Empty(cCC)
// 		cQuery	+=	" AND AF8_TPPRJ='"+cCC +"' "
// 	Else
// 		cQuery	+=	" AND Substring(AF8_TPPRJ,1,1)<>'Z' "
// 	EndIf

// 	cQuery	+=	"				ORDER BY AE8_RECURS, AF9_START,AF8_PROJET, AF9_TAREFA"

// 	cQuery := ChangeQuery(cQuery)

// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cAliasQry, .F., .T.)

// 	aTeam		:=	{}
// 	aRecurs	:=	{}
// 	aType		:=	{}
// 	aPrj		:=	{}
// 	aCC		:=	{}
// 	aCOTP		:=	{}
// 	aCOTE		:=	{}
// 	aCRTE		:=	{}

// 	cRetAlloc:=	""
// 	While !Eof()
// 		AF8->(dbsetorder(1))
// 		AF8->(DbSeek(xFilial()+(cAliasQry)->AF8_PROJET))
// 		AF9->(dbsetorder(1))
// 		AF9->(DbSeek(xFilial()+(cAliasQry)->(AF8_PROJET+AF9_REVISA+AF9_TAREFA)))
// 		nCOTP	:=	0  //BCWS
// 		nCOTE	:=	0  //BCWP
// 		nCRTE	:=	0 	//ACWP
// 		nSPI:=	-1 //not controlled
// 		nCPI:=	-1//not controlled

// 		dDate := date()
// 		nPoc	:=	PmsPocAF9(AF8_PROJET, AF9_REVISA, AF9_tarefa, dDate)

// 		dDate := dDate-1
// 		aCOTP	:=	PmsIniCOTP(AF8_PROJET,AF9_REVISA,dDate,AF9_tarefa,AF9_tarefa,/*lAcumulado*/.T.,@aCOTP)

// 		nCOTP	:=	PmsRetCOTP(aCOTP,1,AF9_TAREFA,.T.)[1]
// 		nCOTE	:=	PmsRetCOTE(aCOTE,1,AF9_TAREFA,.T.)[1]

// 		aCRTE	:=	PmsIniCRTE(AF8_PROJET,AF9_REVISA,dDate,AF9_tarefa,AF9_tarefa)
// 		nCRTE	:=	PmsRetCRTE(aCRTE,1,AF9_TAREFA,.T.)[1]
// 		If nCOTP<>0
// 			nSPI	:=	nCOTE/nCOTP
// 		EndIf
// 		If nCRTE<>0
// 			nCPI	:=	nCOTE/nCRTE
// 		EndIf
// 		cUsed:=	RetUsed(AF8_PROJET,AF9_TAREFA,AE8_RECURS)
// 		cRetAlloc  += ',{"type":"'+AllTrim(AE5_GROUP)+'","team":"'+AllTrim(AED_EQUIP)+'","project":"'+AllTrim(AF8_PROJET)+'","costcollector":"'+AllTrim(AF8_TPPRJ)+;
// 			'","resource":"'+AllTrim(AE8_RECURS)+;
// 			'","task":"'+AllTrim(AF9_TAREFA)+;
// 			'","taskDescription":"'+AllTrim(AF9_DESCRI)+;
// 			'","wbsDescription":"'+AllTrim(AFC_DESCRI)+;
// 			'","start":"'+AllTrim(AF9_START)+;
// 			'","finish":"'+AllTrim(AF9_FINISH)+;
// 			'","bcWs":'+Str(nCOTP)+;
// 			',"bcWp":'+Str(nCOTE)+;
// 			',"acWp":'+Str(nCRTE)+;
// 			',"spi":'+Str(nSPI)+;
// 			',"cpi":'+Str(nCPI)+;
// 			',"poc":'+Str(nPOC)+;
// 			',"hUsed":'+cUsed+;
// 			',"hours":'+AllTrim(sTR(AFA_QUANT))+'}'

// 		If Ascan(aPrj,{|x| x[1]==AF8_PROJET}) == 0
// 			aAdd(aPrj,{AF8_PROJET,AllTrim(AF8_DESCRI)})
// 		EndIf
// 		If Ascan(aTeam,{|x| x[1]==AED_EQUIP}) == 0
// 			aAdd(aTeam,{AED_EQUIP,AllTrim(AED_DESCRI)})
// 		EndIf
// 		If Ascan(aRecurs,{|x| x[1]==AllTrim(AE8_recurs)}) == 0
// 			aAdd(aRecurs,{AllTrim(AE8_recurs),AllTrim(AE8_descri)})
// 		EndIf
// 		If Ascan(aType,{|x| x[1]==AE5_GROUP}) == 0
// 			AE5->(DbSetorder(1))
// 			AE5->(MsSeek(xFilial()+(cAliasQry)->AE5_GROUP))
// 			aAdd(aType,{AE5_GROUP,AllTrim(AE5->AE5_DESCRI),AE5->AE5_COLOR})
// 		EndIf
// 		If Ascan(aCC,{|x| x[1]==AF8_TPPRJ}) == 0
// 			aAdd(aCC,{AF8_TPPRJ,AllTrim(TABELA('FE',AF8_TPPRJ))})
// 		EndIf

// 		DbSkip()
// 	Enddo
// //Add original type to list
// 	If !Empty(cType)
// 		AE5->(DbSetorder(1))
// 		If AE5->(MsSeek(xFilial()+cType))
// 			aAdd(aType,{AE5_GROUP,AllTrim(AE5->AE5_DESCRI),AE5->AE5_COLOR})
// 		EndIf
// 	EndIf
// 	cRetTypes:=	""
// 	cRetTeam	:=	""
// 	cRetRes	:=	""
// 	cRetPrj	:=	""
// 	cRetCC	:= ""
// 	aPrj	:=	aSort(aPrj,/*nInicio*/,/*nCont*/,{|x,y| x[1]<y[1]})
// 	For nX:=1 To Len(aPrj)
// 		cRetPrj+= ',{"project":"'+AllTrim(aPrj[nX,1])+'","projectDescription":"'+AllTrim(aPrj[nX,2])+'"}'
// 	Next

// 	aCC	:=	aSort(aCC,/*nInicio*/,/*nCont*/,{|x,y| x[1]<y[1]})
// 	For nX:=1 To Len(aCC)
// 		cRetCC+= ',{"costcollector":"'+AllTrim(aCC[nX,1])+'","costcollectorDescription":"'+AllTrim(aCC[nX,2])+'"}'
// 	Next

// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x[1]<y[1]})
// 	For nX:=1 To Len(aTeam)
// 		cRetTeam+= ',{"team":"'+AllTrim(aTeam[nX,1])+'","teamDescription":"'+IIf(empty(aTeam[nX,2]),'Team not informed',AllTrim(aTeam[nX,2]))+'"}'
// 	Next
// 	aType	:=	aSort(aType,/*nInicio*/,/*nCont*/,{|x,y| x[1]<y[1]})
// 	For nX:=1 To Len(aType)
// 		cRetTypes+= ',{"type":"'+AllTrim(aType[nX,1])+'","typeColor":"'+IIf(empty(aType[nX,2]),'cd6155',AllTrim(aType[nX,3]))+'","typeDescription":"'+IIf(empty(aType[nX,2]),'Type not informed',AllTrim(aType[nX,2]))+'"}'
// 	Next

// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x[1]<y[1]})
// 	For nX:=1 To Len(aRecurs)
// 		cRetRes+= ',{"resource":"'+AllTrim(aRecurs[nX,1])+'","resourceDescription":"'+AllTrim(aRecurs[nX,2])+'"}'
// 	Next
// 	cRet:='['
// 	cRet+=	Substr(cRetAlloc,2)
// 	cRet+=	'],['
// 	cRet+=	Substr(cRetTypes,2)
// 	cRet+=	'],['
// 	cRet+=	Substr(cRetRes,2)
// 	cRet+=	'],['
// 	cRet+=	Substr(cRetPrj,2)
// 	cRet+=	'],['
// 	cRet+=	Substr(cRetTeam,2)
// 	cRet+=	'],['
// 	cRet+=	Substr(cRetCC,2)
// 	cRet+=	']'

// 	DbCloseArea()

// 	cRet := "[" + cRet + "]"

// 	jJsonRet := JsonObject():New()

// 	jJsonRet:FromJson(cRet)

// Return jJsonRet



// /*/{Protheus.doc} RecAnalisys
// Get allocation analysis
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param dIniQry, date
// @param dFimQry, date
// @param cFilter, character
// @param cTeam, character, param_description
// @param cResource, character, param_description
// @Return Json, Json Object
// /*/
// Static Function RecAnalisys(dIniQry, dFimQry, cFilter, cTeam, cResource)
// 	Local aRecAF9	:= {}
// 	Local nX := 0
// 	Local nY := 0
// 	Local aAreaAE8 := AE8->(GetArea())
// 	Local aAloc		:=	{}
// 	Local aRecAE8	:=	{}
// 	Local aGantt := {}
// 	Local ATSK:={}
// 	Local aResource :={}
// 	Local nfilter
// 	Local aProjects := {}
// 	Local jRet := JsonObject():new()
// 	default cfilter:='1'
// 	nfilter := val(cfilter)
// //default cteam  :='A0001'
// //default cResource:='AFEDOROVA'


// /*
// @param nFilter, 	numerico,  Tipo de filtro selecionado(1-Todas as tarefas,2-Tarefas finalizadas,3-Tarefas a Executar e 4-Tarefas com restrição)
// */
// 	aGantt := {}
// 	If !Empty(cResource)
// 		AE8->(dbSetOrder(1))
// 		If AE8->(dbSeek(xFilial()+cResource))
// 			aAdd(aRecAE8,AE8->(RECNO()))
// 		EndIf
// 	Else
// 		AE8->(dbSetOrder(4))
// 		AE8->(dbSeek(xFilial()+cTeam))
// 		While AE8->(AE8_FILIAL = xFilial() .And. !Eof() .And. (Empty(cTeam) .Or. AllTrim(AE8->AE8_EQUIP) == AllTrim(cTeam)))	//loop para carregar todos os
// 			aAdd(aRecAE8,AE8->(RECNO()))
// 			AE8->(DbSkip())
// 		Enddo
// 	EndIf

// 	For nY := 1 To Len(aRecAE8)
// 		AE8->(MsGoTo(aRecAE8[nY]))

// 		aAdd(aResource,JsonObject():new())
// 		nPos := Len(aResource)
// 		aResource[nPos]['AE8_RECURS' ] := AllTrim(AE8->AE8_RECURS)
// 		aResource[nPos]['AE8_DESCRI' ] := AllTrim(AE8->AE8_DESCRI)
// 		aResource[nPos]['AE8_UMAX' ] 	 := cValtoChar(AE8->AE8_UMAX)
// 		aResource[nPos]['AE8_SUPALO' ] := AE8->AE8_SUPALO
// 		//aResource[nPos]['ALOC' 	]		 :={}
// 		//aÐesource[nPos]['TASKS' ]		 :={}
// 		aAlocJson	:= {}
// 		aAlocTasks	:= {}
// 		aRecAF9	:= {}
// 		aAloc	:= PmsRetAloc(AE8->AE8_RECURS,dIniQry,"00:00",dFimQry,"24:00",nFilter,,,,aRecAF9) //'Verificando alocacao do recurso '
// 		If !Empty(aAloc)
// 			aAdd(aGantt,{{AE8->AE8_RECURS,AE8->AE8_DESCRI,AE8->AE8_UMAX,AE8->AE8_SUPALO},{},{}})
// 			For nx := 1 to Len(aAloc)-1
// 				If aAloc[nx][3] > 0
// 					dIni	:= aAloc[nx][1]
// 					cHIni	:= aAloc[nx][2]
// 					dFim	:= aAloc[nx+1][1]
// 					cHFim	:= aAloc[nx+1][2]
// 					aAdd(aGantt[Len(aGantt)][2],{dIni,cHIni,dFim,cHFim,aAloc[nx][3]})
// 					aAdd(aAlocJson,JsonObject():new())
// 					nPosAloc := Len(aAlocJson)
// 					aAlocJson[nPosAloc]['START_DAY' 	] := DtoS(dIni)
// 					aAlocJson[nPosAloc]['START_HOUR' ] := cValtoChar(cHIni)
// 					aAlocJson[nPosAloc]['FINISH_DAY' ] := DtoS(dFim)
// 					aAlocJson[nPosAloc]['FINISH_HOUR'] := cValtoChar(cHFim)
// 					aAlocJson[nPosAloc]['ALLOCATION']  := cValtoChar(aAloc[nx][3])
// 				EndIf
// 			Next
// 			aResource[nPos]['ALOC' 	]:= aAlocJson
// 			For nx := 1 to Len(aRecAF9)
// 				dbSelectArea("AF9")
// 				dbGoto(aRecAF9[nx])
// 				AFA->(DBSETORDER(5))
// 				AFA->(DBSEEK(xfilial()+AF9->AF9_PROJET+AF9->AF9_REVISA+AF9->AF9_TAREFA+AE8->AE8_RECURS))
// 				aAdd(aTsk,JsonObject():new())
// 				nPosTsk := Len(aTsk)
// 				aTsk[nPosTsk]['AF9_PROJET'] := AllTrim(AF9->AF9_PROJET)
// 				aTsk[nPosTsk]['AF9_TAREFA'] := AllTrim(AF9->AF9_TAREFA)
// 				aTsk[nPosTsk]['AF9_DESCRI'] := AllTrim(AF9->AF9_DESCRI)
// 				aTsk[nPosTsk]['AF9_START'] := DtoS(AF9->AF9_START)
// 				aTsk[nPosTsk]['AF9_HORAI'] := AllTrim(AF9->AF9_HORAI)
// 				aTsk[nPosTsk]['AF9_FINISH'] := DtoS(AF9->AF9_FINISH)
// 				aTsk[nPosTsk]['AF9_HORAF'] := AllTrim(AF9->AF9_HORAF)
// 				aTsk[nPosTsk]['POC'] 		:= AllTrim(TransForm(PmsPOCAF9(AF9_PROJET,AF9_REVISA,AF9_TAREFA,MSDate(),AF9->AF9_QUANT),"@E 999.99%"))
// 				aTsk[nPosTsk]['AFA_ALOC']	:=	AFA->AFA_ALOC
// 				If Ascan(aProjects,{|x| x['id'] == AllTrim(AF9->AF9_PROJET)}) == 0
// 					tmpPrj := JsonObject():New()
// 					tmpPrj[ 'id'] 	 :=  AllTrim(AF9->AF9_PROJET)
// 					tmpPrj[ 'label'] :=  AllTrim(Posicione('AF8',1,xFilial('AF8')+AF9->AF9_PROJET,'AF8->AF8_DESCRI'))
// 					aadd(aProjects,tmpPrj)
// 					FreeObj(tmpPrj)
// 				Endif
// 			Next nx
// 			aResource[nPos]['TASKS' 	]:= aTsk
// 		EndIf
// 	Next
// 	AE8->(dbSetOrder(1))
// 	RestArea(aAreaAE8)

// 	jRet :=  JsonObject():new()
// 	jRet['RESOURCES'] 	:= aResource
// 	jRet['PROJECTS'] 	:= aProjects
// Return jRet:toJson()


// /*/{Protheus.doc} GetAFUSummary
// Get timesheet summary
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cDateFrom, character, Date From 
// @param cDateTo, character, Date to
// @param cTeam, character, Teams (comma separated)
// @param cRes, character, Resources (comma separated)
// @param cTypeTsk, character, Task types  (comma separated)
// @param cPrj, character, Projects (comma separated)
// @param cCC, character, Cost collectors (comma separated)
// @Return Json, Json Object
// /*/
// Static Function GetAFUSummary(cDateFrom, cDateTo, cPeriod, cTeam, cRes, cTypeTsk, cPrj, cCC, cFieldsDetail)
// 	Local cAliasQry    := GetNextAlias() As Character
// 	Local cSql      := "" As Character
// 	Local nX        := 0  As Numeric
// 	Local aRes      := {} As Array
// 	Local cFields   := "" As Character
// 	Local cGroupbY  := "" As Character
// 	Local cOrder    := "" As Character
// 	Local aPrj      := {} As Array
// 	Local aType     := {} As Array
// 	Local aTeam     := {} As Array
// 	Local aCC     	:= {} As Array
// 	Local aRecurs     	:= {} As Array
// 	Local jJsonRet  := JsonObject():New() As Json
// 	Local aQryVars := {}
// 	Local oStatement := FWPreparedStatement():New()
// 	//.And. cPeriod <> 'week'
// 	If cPeriod <> 'day' .And. cPeriod <> 'fortnight'  .And.cPeriod <> 'month' .And. cPeriod <> 'quarter' .And. cPeriod <> 'year'
// 		cPeriod = 'month'
// 	Endif
// 	//Adjust periods to date
// 	If len(cDateFrom) == 4
// 		cDateFrom+= "0101"
// 	ElseIf len(cDateFrom) == 6
// 		cDateFrom+= "01"
// 	EndIf
// 	If len(cDateTo) == 4
// 		cDateTo+= "12"
// 	Endif
// 	If len(cDateTo) == 6
// 		cDateTo	:= DtoS(LastDay(Stod(cDateTo+"01")))
// 	EndIf

// 	Do Case
// 	Case cPeriod == 'day'
// 		cDataFields := ", AFU_DATA as startdate "
// 	// Case cPeriod == 'week'
// 	// 	If TCGetDB() == 'ORACLE'
// 	// 		cDataFields := ", trunc(to_date(AFU_DATA), 'iw') as startdate "
// 	// 	elseIf TCGetDB() == 'MSSQL'
// 	// 		cDataFields := ", DATEPART(dw,AFU_DATA) as startdate "
// 	// 	elseIf TCGetDB() == 'POSTGRES'
// 	// 		cDataFields := ", extract(dow from AFU_DATA::timestamp) as startdate "
// 	// 	else
// 	// 		cDataFields := ", AFU_DATA as startdate "
// 	// 	Endif
// 	Case cPeriod == 'month'
// 		cDataFields := ", Substring(AFU_DATA,1,6) || '01' as startdate"
// 	Case cPeriod == 'fortnight'
// 		cDataFields := ",case "+;
// 					   "	when "+;
// 						"	SUBSTRING(AFU_DATA,7,2) <= '15' then "+;
// 						"		SUBSTRING(AFU_DATA,1,6) || '01'"+;
// 						"		else "+;
// 						"		SUBSTRING(AFU_DATA,1,6) || '16'"+;
// 						" end as startdate"
// 	Case cPeriod == 'quarter'
// 		cDataFields := ",case "+;
//     					"	when "+;
// 						"	SUBSTRING(AFU_DATA,5,2) <= '03' then "+;
// 						"		SUBSTRING(AFU_DATA,1,4) || '0101'"+;
//     					"	when "+;
// 						"	SUBSTRING(AFU_DATA,5,2) between '03' and '06' then "+;
// 						"		SUBSTRING(AFU_DATA,1,4) || '0401'"+;
//     					"	when "+;
// 						"	SUBSTRING(AFU_DATA,5,2) between '06' and '09' then "+;
// 						"		SUBSTRING(AFU_DATA,1,4) || '0701'"+;
//     					"	else "+;
// 						"		SUBSTRING(AFU_DATA,1,4) || '1001'"+;
// 						" end as startdate"
// 	Case cPeriod == 'year'
// 		cDataFields := ", Substring(AFU_DATA,1,4) || '0101' as startdate"
// 	//If not defined use Month
// 	OtherWise
// 		cDataFields := ", Substring(AFU_DATA,1,6) || '01' as startdate"
// 	EndCase
// 	cFields	:=	"Sum(AFU_HQUANT) AFU_HQUANT"+cDataFields
// 	cGroupBy:=	"startdate" //, %
// 	cOrder	:=	"startdate"
// 	If 'team' $ cFieldsDetail .Or. 'AED_EQUIP' $ cFieldsDetail
// 		cFields += ',AED_EQUIP, AED_DESCRI'
// 		cGroupBy+= ",AED_EQUIP, AED_DESCRI" //, %
// 		cOrder	+=	", AED_EQUIP"
// 	Endif
// 	If 'resource' $ cFieldsDetail .Or. 'AE8_RECURS' $ cFieldsDetail
// 		cFields += ',AE8_RECURS, AE8_DESCRI'
// 		cGroupBy+= ",AE8_RECURS, AE8_DESCRI" //, %
// 		cOrder	+=	", AE8_RECURS"
// 	Endif
// 	If 'project' $ cFieldsDetail .Or. 'AF8_PROJET' $ cFieldsDetail
// 		cFields += ',AF8_PROJET, AF8_DESCRI'
// 		cGroupBy+= ",AF8_PROJET, AF8_DESCRI" //, %
// 		cOrder	+=	", AF8_PROJET"
// 	Endif
// 	If 'type' $ cFieldsDetail .Or.'AE5_GRPCOM' $ cFieldsDetail
// 		//cFields += ",COALESCE(AE5_GRPCOM,'') AE5_GRPCOM"
// 		cFields += ",AE5_GRPCOM"		
// 		cGroupBy+= ",AE5_GRPCOM" //, %
// 		cOrder	+=	",AE5_GRPCOM"
// 	Endif
// 	If 'costCollector' $ cFieldsDetail .Or. 'AF8_TPPRJ' $ cFieldsDetail
// 		cFields += ',AF8_TPPRJ'
// 		cGroupBy+= ",AF8_TPPRJ" //, %
// 	Endif

// 	cSQL := ""
// 	cSql	:= " AND AFU_DATA BETWEEN ? AND ? "
// 	aadd(aQryVars,cDateFrom)
// 	aadd(aQryVars,cDateTo)
// 	If cTeam <> Nil .And. !Empty(cTeam)
// 		aTmpFormatIn := SafeFormatIn(cTeam, ',')
// 		cSQL += " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cRes<> Nil .And. !Empty(cRes)
// 		aTmpFormatIn := SafeFormatIn(cRes, ',')
// 		cSQL += " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cPrj<> Nil .And. !Empty(cPrj)
// 		aTmpFormatIn := SafeFormatIn(cPrj, ',')
// 		cSQL += " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cCC<> Nil .And. !Empty(cCC) 
// 		aTmpFormatIn := SafeFormatIn(cCC, ',')
// 		cSQL	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cTypeTsk<> Nil .And. !Empty(cTypeTsk) 
// 		aTmpFormatIn := SafeFormatIn(cTypeTsk, ',')
// 		cSQL	+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	//cSql:=	"% "+cSql+ " %"
// 	//%noparser%

// 	BeginContent var cQuery
// 		SELECT %Exp:cFields% 
// 		FROM %Exp:RetSqlName("AFU")% AFU, %Exp:RetSqlName("AF8")% AF8,
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			

// 		WHERE 	AFU_FILIAL = '%Exp:xfilial("AFU")%' AND AFU.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AFU_PROJET = AF8_PROJET AND
// 				AFU_PROJET = AF9_PROJET AND
// 				AFU_TAREFA = AF9_TAREFA AND
// 				AFU_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AFU_CTRRVS = '1' AND
// 				AFU_RECURS = AE8_RECURS
// 				%Exp:cSql%				
// 		GROUP BY %Exp:cGroupBy%
// 		ORDER BY %Exp:cOrder%
// 	EndContent
// 	cQuery := ChangeQuery(cQuery)

// 	//Define a consulta e os parâmetros
// 	oStatement:SetQuery(cQuery)
// 	oStatement:setParams(aQryVars)	
// 	//Recupera a consulta já com os parâmetros injetados
// 	cFinalQuery := oStatement:GetFixQuery()
// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cFinalQuery), cAliasQry, .F., .T.)
// 	jJsonRet['list'] 	:= {}
// 	jJsonRet['resources']:= {}
// 	jJsonRet['teams'] 	:= {}
// 	jJsonRet['costCollectors'] 	:= {}
// 	jJsonRet['projects'] := {}
// 	jJsonRet['types'] 	:= {}

// 	aType	:=	{}
// 	aTeam	:=	{}
// 	aPrj	:=	{}
// 	aRes	:=	{}
// 	aCC	:= {}
// 	WHILE !EOF()
// 		jRetTmp := JsonObject():New()

// 		If  'project' $ cFieldsDetail .Or. 'AF8_PROJET' $ cFieldsDetail
// 			jRetTmp["project"]	:=	AllTrim(AF8_PROJET)
// 			If Ascan(aPrj,{|x| x['id']==Alltrim(AF8_PROJET)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] := Alltrim(AF8_PROJET)
// 				jTmp['label'] := AllTrim(AF8_DESCRI)
// 				aAdd(aPrj,jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 		EndIf

// 		If 'AED_EQUIP' $ cFieldsDetail .Or.  'team' $ cFieldsDetail 
// 			jRetTmp["team"]		:=	AllTrim(AED_EQUIP)
// 			If Ascan(aTeam,{|x| x['id']==Alltrim(AED_EQUIP)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] 		:= Alltrim(AED_EQUIP)
// 				jTmp['label'] 	:= AllTrim(AED_DESCRI)
// 				aAdd(aTeam,jTmp)
// 				FreeObj(jTmp)
// 			Endif
// 		EndIf
// 		If 'AE8_RECURS' $ cFieldsDetail .or.  'resource' $ cFieldsDetail 
// 			jRetTmp["resource"]	:=	AllTrim(AE8_RECURS)
// 			If Ascan(aRecurs,{|x| x['id']==AllTrim(AE8_recurs)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] 		:= Alltrim(AE8_recurs)
// 				jTmp['label'] 	:= AllTrim(AE8_descri)
// 				aAdd(aRecurs,jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 		Endif
// 		If 'AE5_GRPCOM' $ cFieldsDetail .Or. 'type' $ cFieldsDetail 
// 			jRetTmp["type"]:=	AllTrim(AE5_GRPCOM)
// 			If Ascan(aType,{|x| x['id']==Alltrim(AE5_GRPCOM)}) == 0
// 				AE5->(DbSetorder(1))
// 				AE5->(MsSeek(xFilial()+(cAliasQry)->AE5_GRPCOM))
// 				jTmp := JsonObject():New()
// 				jTmp['id'] 		:= Alltrim((cAliasQry)->AE5_GRPCOM)
// 				jTmp['label'] 	:= AllTrim(AE5->AE5_DESCRI)
// 				jTmp['color'] 	:= Iif(fieldPos('AE5_COLOR') > 0 , AE5->AE5_COLOR, Nil)
// 				aAdd(aType,jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 		Endif

// 		If 'AF8_TPPRJ' $ cFieldsDetail .Or. 'costCollector' $ cFieldsDetail 
// 			jRetTmp["costCollector"]:=	AllTrim(AF8_TPPRJ)
// 			If Ascan(aCC,{|x| x['id']==Alltrim(AF8_TPPRJ)}) == 0
// 				jTmp := JsonObject():New()
// 				jTmp['id'] 		:= Alltrim(AF8_TPPRJ)
// 				jTmp['label'] 	:= AllTrim(TABELA('FE',AF8_TPPRJ))
// 				aAdd(aCC,jTmp)
// 				FreeObj(jTmp)
// 			EndIf
// 		Endif

// 		jRetTmp["startDate"]		:=	AllTrim(startDate)
// 		Do Case
// 		Case cPeriod == 'day'
// 			jRetTmp["finishDate"]	:=	AllTrim(startDate)
// 		// Case cPeriod == 'week'
// 		// 	jRetTmp["finishDate"] 	:= Dtos(Stod(startDate) + 6)
// 		Case cPeriod == 'month'
// 			jRetTmp["finishDate"]	:=	DtoS(LastDay(Stod(startDate)))
// 		Case cPeriod == 'fortnight'
// 			jRetTmp["finishDate"]	:=	iif(Substr(startDate,7,2)=="01",Substr(startDate,1,6)+"15" , DtoS(LastDay(Stod(startDate))))
// 		Case cPeriod == 'quarter'
// 			jRetTmp["finishDate"]	:=	DtoS(LastDay(Stod(StrZero(Val(Substr(startDate,1,6)) + 2,6)+"01")))
// 		Case cPeriod == 'year'
// 			jRetTmp["finishDate"]	:=	Substr(startDate,1,4) + "1231"
// 		//If not defined use Month
// 		OtherWise
// 			jRetTmp["finishDate"]	:=	DtoS(LastDay(Stod(startDate)))
// 		EndCase
// 		jRetTmp["hours"] 	:= AFU_HQUANT
// 		aadd(jJsonRet['list'],jRetTmp)
// 		FreeObj(jRetTmp)
// 		DbSkip()
// 	Enddo

// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['resources'] := aRecurs
// 	aPrj	:=	aSort(aPrj,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['projects'] := aPrj
// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['teams'] := aTeam
// 	aType	:=	aSort(aType,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['types'] := aType
// 	aCC	:=	aSort(aCC,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['costCollectors'] := aCC

// Return jJsonRet


// /*/{Protheus.doc} GetAFU
// Get timesheet 
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cDateFrom, character, param_description
// @param cDateTo, character, param_description
// @param cTeam, character, param_description
// @param cRes, character, param_description
// @param cTypeTsk, character, param_description
// @param cPrj, character, param_description
// @param cCC, character, param_description
// @Return Json, Json Object
// /*/
// Static Function GetAFU(cDateFrom, cDateTo, cTeam, cRes, cTypeTsk, cPrj, cCC)
// 	Local cAliasQry    := GetNextAlias() As Character
// 	Local cSql      := "" As Character
// 	Local nX        := 0  As Numeric
// 	Local aRes      := {} As Array
// 	Local cOrder    := "" As Character
// 	Local aPrj      := {} As Array
// 	Local aType     := {} As Array
// 	Local aTeam     := {} As Array
// 	Local aCC     	:= {} As Array
// 	Local aRecurs     	:= {} As Array
// 	Local jJsonRet  := JsonObject():New() As Json
// 	Local aQryVars := {}
// 	Local oStatement := FWPreparedStatement():New()
// 	If len(cDateFrom) == 4
// 		cDateFrom+= "0101"
// 	ElseIf len(cDateFrom) == 6
// 		cDateFrom+= "01"
// 	EndIf
// 	If len(cDateTo) == 4
// 		cDateTo+= "12"
// 	Endif
// 	If len(cDateTo) == 6
// 		cDateTo	:= DtoS(LastDay(Stod(cDateTo+"01")))
// 	EndIf

// 	cOrder	:=	"AFU_DATA, AFU_HORAI, AFU_PROJET, AFU_TAREFA"
// 	cSQL := ""
// 	cSql	:= " AND AFU_DATA BETWEEN ? AND ? "
// 	aadd(aQryVars,cDateFrom)
// 	aadd(aQryVars,cDateTo)
// 	If cTeam <> Nil .And. !Empty(cTeam)
// 		aTmpFormatIn := SafeFormatIn(cTeam, ',')
// 		cSQL += " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cRes<> Nil .And. !Empty(cRes)
// 		aTmpFormatIn := SafeFormatIn(cRes, ',')
// 		cSQL += " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cPrj<> Nil .And. !Empty(cPrj)
// 		aTmpFormatIn := SafeFormatIn(cPrj, ',')
// 		cSQL += " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cCC<> Nil .And. !Empty(cCC) 
// 		aTmpFormatIn := SafeFormatIn(cCC, ',')
// 		cSQL	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cTypeTsk<> Nil .And. !Empty(cTypeTsk) 
// 		aTmpFormatIn := SafeFormatIn(cTypeTsk, ',')
// 		cSQL	+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	//cSql:=	"% "+cSql+ " %"
// 	//%noparser%

// 	BeginContent var cQuery
// 		SELECT 
// 		AFU_DATA,AFU_HORAI,AFU_HORAF,AFU_HQUANT,AF8_PROJET,AF8_DESCRI, AF8_TPPRJ,AED_EQUIP,AED_DESCRI,AE8_RECURS,AE8_DESCRI, AE5_GRPCOM,AF9_TAREFA,AF9_DESCRI

// 		FROM %Exp:RetSqlName("AFU")% AFU, %Exp:RetSqlName("AF8")% AF8,
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			
// 		WHERE 	AFU_FILIAL = '%Exp:xfilial("AFU")%' AND AFU.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AFU_PROJET = AF8_PROJET AND
// 				AFU_PROJET = AF9_PROJET AND
// 				AFU_TAREFA = AF9_TAREFA AND
// 				AFU_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AFU_CTRRVS = '1' AND
// 				AFU_RECURS = AE8_RECURS
// 				%Exp:cSql%				
// 		ORDER BY %Exp:cOrder%
// 	EndContent
// 	cQuery := ChangeQuery(cQuery)

// 	//Define a consulta e os parâmetros
// 	oStatement:SetQuery(cQuery)
// 	oStatement:setParams(aQryVars)	
// 	//Recupera a consulta já com os parâmetros injetados
// 	cFinalQuery := oStatement:GetFixQuery()
// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cFinalQuery), cAliasQry, .F., .T.)
// 	jJsonRet['list'] 	:= {}
// 	jJsonRet['resources']:= {}
// 	jJsonRet['teams'] 	:= {}
// 	jJsonRet['costCollector'] 	:= {}
// 	jJsonRet['projects'] := {}
// 	jJsonRet['types'] 	:= {}

// 	aType	:=	{}
// 	aTeam	:=	{}
// 	aPrj	:=	{}
// 	aRes	:=	{}
// 	aCC	:= {}
// 	WHILE !EOF()
// 		jRetTmp := JsonObject():New()

// 		jRetTmp["project"]	:=	AllTrim(AF8_PROJET)
// 		If Ascan(aPrj,{|x| x['id']==Alltrim(AF8_PROJET)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AF8_PROJET)
// 			jTmp['label'] := AllTrim(AF8_DESCRI)
// 			aAdd(aPrj,jTmp)
// 			FreeObj(jTmp)
// 		EndIf

// 		jRetTmp["team"]		:=	AllTrim(AED_EQUIP)
// 		If Ascan(aTeam,{|x| x['id']==Alltrim(AED_EQUIP)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AED_EQUIP)
// 			jTmp['label'] 	:= AllTrim(AED_DESCRI)
// 			aAdd(aTeam,jTmp)
// 			FreeObj(jTmp)
// 		Endif
// 		jRetTmp["resource"]	:=	AllTrim(AE8_RECURS)
// 		If Ascan(aRecurs,{|x| x['id']==AllTrim(AE8_recurs)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AE8_recurs)
// 			jTmp['label'] 	:= AllTrim(AE8_descri)
// 			aAdd(aRecurs,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		jRetTmp["type"]:=	AllTrim(AE5_GRPCOM)
// 		If Ascan(aType,{|x| x['id']==Alltrim(AE5_GRPCOM)}) == 0
// 			AE5->(DbSetorder(1))
// 			AE5->(MsSeek(xFilial()+(cAliasQry)->AE5_GRPCOM))
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim((cAliasQry)->AE5_GRPCOM)
// 			jTmp['label'] 	:= AllTrim(AE5->AE5_DESCRI)
// 			jTmp['color'] 	:= Iif(fieldPos('AE5_COLOR') > 0 , AE5->AE5_COLOR, Nil)
// 			aAdd(aType,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		jRetTmp["costCollector"]:=	AllTrim(AF8_TPPRJ)
// 		If Ascan(aCC,{|x| x['id']==Alltrim(AF8_TPPRJ)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AF8_TPPRJ)
// 			jTmp['label'] 	:= AllTrim(TABELA('FE',AF8_TPPRJ))
// 			aAdd(aCC,jTmp)
// 			FreeObj(jTmp)
// 		Endif

// 		jRetTmp["date"]			:=	AllTrim(AFU_DATA)
// 		jRetTmp["startHour"] 	:= 	AFU_HORAI
// 		jRetTmp["finishHour"] 	:= 	AFU_HORAF
// 		jRetTmp["hours"] 		:= 	AFU_HQUANT
// 		jRetTmp["projet"] 		:= 	Alltrim(AF8_PROJET)
// 		jRetTmp["costCollector"]:= 	AF8_TPPRJ
// 		jRetTmp["team"] 		:= 	Alltrim(AED_EQUIP)
// 		jRetTmp["resource"] 	:= 	Alltrim(AE8_RECURS)
// 		jRetTmp["type"] 		:= 	Alltrim(AE5_GRPCOM)
// 		jRetTmp["task"] 		:= 	Alltrim(AF9_TAREFA)
// 		jRetTmp["taskDescription"] := 	Alltrim(AF9_DESCRI)
		
// 		aadd(jJsonRet['list'],jRetTmp)
// 		FreeObj(jRetTmp)
// 		DbSkip()
// 	Enddo

// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['resources'] := aRecurs
// 	aPrj	:=	aSort(aPrj,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['projects'] := aPrj
// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['teams'] := aTeam
// 	aType	:=	aSort(aType,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['types'] := aType
// 	aCC	:=	aSort(aCC,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['costCollectors'] := aCC

// Return jJsonRet


// /*/{Protheus.doc} GetAFUAJK
// Get timesheet 
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cDateFrom, character, param_description
// @param cDateTo, character, param_description
// @param cTeam, character, param_description
// @param cRes, character, param_description
// @param cTypeTsk, character, param_description
// @param cPrj, character, param_description
// @param cCC, character, param_description
// @Return Json, Json Object
// /*/
// Static Function GetAFUAJK(cDateFrom, cDateTo, cTeam, cRes, cTypeTsk, cPrj, cCC, cOption)
// 	Local cAliasQry    := GetNextAlias() As Character
// 	Local cSql      := "" As Character
// 	Local nX        := 0  As Numeric
// 	Local aRes      := {} As Array
// 	Local cOrder    := "" As Character
// 	Local aPrj      := {} As Array
// 	Local aType     := {} As Array
// 	Local aTeam     := {} As Array
// 	Local aCC     	:= {} As Array
// 	Local aRecurs     	:= {} As Array
// 	Local jJsonRet  := JsonObject():New() As Json
// 	Local aQryVars 	:= {}
// 	Local aQryVarsTMP := {}
// 	Local oStatement := FWPreparedStatement():New()
// 	Default cOption := 'AFUAJK'
// 	If len(cDateFrom) == 4
// 		cDateFrom+= "0101"
// 	ElseIf len(cDateFrom) == 6
// 		cDateFrom+= "01"
// 	EndIf
// 	If len(cDateTo) == 4
// 		cDateTo+= "12"
// 	Endif
// 	If len(cDateTo) == 6
// 		cDateTo	:= DtoS(LastDay(Stod(cDateTo+"01")))
// 	EndIf

// 	cOrder	:=	"AE8_RECURS, DATA, HORAI, AF8_PROJET, AF9_TAREFA"

// 	cSql	:= " AND AFU_DATA BETWEEN ? AND ? "
// 	If !('AFU' $ cOption)
// 		cSql	+= " AND 1=0 "
// 	Endif
// 	cSqlAJK	:= " AND AJK_DATA BETWEEN ? AND ? "	
// 	If !('AJK' $ cOption)
// 		cSqlAJK	+= " AND 1=0 "
// 	Endif

// 	If cTeam <> Nil .And. !Empty(cTeam)
// 		aTmpFormatIn := SafeFormatIn(cTeam, ',')
// 		cSQL 	+= " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		cSQLAJK += " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cRes<> Nil .And. !Empty(cRes)
// 		aTmpFormatIn := SafeFormatIn(cRes, ',')
// 		cSQL 	+= " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		cSQLAJK += " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cPrj<> Nil .And. !Empty(cPrj)
// 		aTmpFormatIn := SafeFormatIn(cPrj, ',')
// 		cSQL 	+= " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		cSQLAJK += " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cCC<> Nil .And. !Empty(cCC) 
// 		aTmpFormatIn := SafeFormatIn(cCC, ',')
// 		cSQL	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		cSQLAJK	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cTypeTsk<> Nil .And. !Empty(cTypeTsk) 
// 		aTmpFormatIn := SafeFormatIn(cTypeTsk, ',')
// 		cSQL	+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		cSQLAJK	+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	//cSql:=	"% "+cSql+ " %"
// 	//%noparser%

// 	BeginContent var cQuery
// 		SELECT 
// 		1 AS TIMESHEET, AFU_DATA AS DATA,AFU_HORAI AS HORAI,AFU_HORAF AS HORAF,AFU_HQUANT AS HQUANT,AF8_PROJET,AF8_DESCRI, AF8_TPPRJ,AED_EQUIP,AED_DESCRI,AE8_RECURS,AE8_DESCRI, AE5_GRPCOM,AF9_TAREFA,AF9_DESCRI

// 		FROM %Exp:RetSqlName("AFU")% AFU, %Exp:RetSqlName("AF8")% AF8,
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			
// 		WHERE 	AFU_FILIAL = '%Exp:xfilial("AFU")%' AND AFU.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AFU_PROJET = AF8_PROJET AND
// 				AFU_PROJET = AF9_PROJET AND
// 				AFU_TAREFA = AF9_TAREFA AND
// 				AFU_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AFU_CTRRVS = '1' AND
// 				AFU_RECURS = AE8_RECURS
// 				%Exp:cSql%				
// 		UNION ALL

// 		SELECT 
// 		0 AS TIMESHEET, AJK_DATA as DATA,AJK_HORAI AS HORAI,AJK_HORAF AS HORAF,AJK_HQUANT AS HQUANT,AF8_PROJET,AF8_DESCRI, AF8_TPPRJ,AED_EQUIP,AED_DESCRI,AE8_RECURS,AE8_DESCRI, AE5_GRPCOM,AF9_TAREFA,AF9_DESCRI

// 		FROM %Exp:RetSqlName("AJK")% AJK, %Exp:RetSqlName("AF8")% AF8,
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			
// 		WHERE 	AJK_FILIAL = '%Exp:xfilial("AJK")%' AND AJK.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AJK_PROJET = AF8_PROJET AND
// 				AJK_PROJET = AF9_PROJET AND
// 				AJK_TAREFA = AF9_TAREFA AND
// 				AJK_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AJK_CTRRVS = '1' AND
// 				AJK_SITUAC = '1' AND
// 				AJK_RECURS = AE8_RECURS
// 				%Exp:cSqlAJK%				

// 		ORDER BY %Exp:cOrder%
// 	EndContent
// 	cQuery := ChangeQuery(cQuery)

// 	//Define a consulta e os parâmetros
// 	oStatement:SetQuery(cQuery)
// 	aadd(aQryVarsTMP,cDateFrom)
// 	aadd(aQryVarsTMP,cDateTo)
// 	For nX:=1 To Len(aQryVars)
// 		AAdd(aQryVarsTMP,aQryVars[nX])
// 	Next
// 	aadd(aQryVarsTMP,cDateFrom)
// 	aadd(aQryVarsTMP,cDateTo)
// 	For nX:=1 To Len(aQryVars)
// 		AAdd(aQryVarsTMP,aQryVars[nX])
// 	Next
// 	oStatement:setParams(aQryVarsTMP)	
// 	//Recupera a consulta já com os parâmetros injetados
// 	cFinalQuery := oStatement:GetFixQuery()
// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cFinalQuery), cAliasQry, .F., .T.)
// 	jJsonRet['list'] 	:= {}
// 	jJsonRet['resources']:= {}
// 	jJsonRet['teams'] 	:= {}
// 	jJsonRet['costCollectors'] 	:= {}
// 	jJsonRet['projects'] := {}
// 	jJsonRet['types'] 	:= {}

// 	aType	:=	{}
// 	aTeam	:=	{}
// 	aPrj	:=	{}
// 	aRes	:=	{}
// 	aCC	:= {}
// 	WHILE !EOF()
// 		jRetTmp := JsonObject():New()

// 		jRetTmp["project"]	:=	AllTrim(AF8_PROJET)
// 		If Ascan(aPrj,{|x| x['id']==Alltrim(AF8_PROJET)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] := Alltrim(AF8_PROJET)
// 			jTmp['label'] := AllTrim(AF8_DESCRI)
// 			aAdd(aPrj,jTmp)
// 			FreeObj(jTmp)
// 		EndIf

// 		jRetTmp["team"]		:=	AllTrim(AED_EQUIP)
// 		If Ascan(aTeam,{|x| x['id']==Alltrim(AED_EQUIP)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AED_EQUIP)
// 			jTmp['label'] 	:= AllTrim(AED_DESCRI)
// 			aAdd(aTeam,jTmp)
// 			FreeObj(jTmp)
// 		Endif
// 		jRetTmp["resource"]	:=	AllTrim(AE8_RECURS)
// 		If Ascan(aRecurs,{|x| x['id']==AllTrim(AE8_recurs)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AE8_recurs)
// 			jTmp['label'] 	:= AllTrim(AE8_descri)
// 			aAdd(aRecurs,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		jRetTmp["type"]:=	AllTrim(AE5_GRPCOM)
// 		If Ascan(aType,{|x| x['id']==Alltrim(AE5_GRPCOM)}) == 0
// 			AE5->(DbSetorder(1))
// 			AE5->(MsSeek(xFilial()+(cAliasQry)->AE5_GRPCOM))
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim((cAliasQry)->AE5_GRPCOM)
// 			jTmp['label'] 	:= AllTrim(AE5->AE5_DESCRI)
// 			jTmp['color'] 	:= Iif(fieldPos('AE5_COLOR') > 0 , AE5->AE5_COLOR, Nil)
// 			aAdd(aType,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		jRetTmp["costCollector"]:=	AllTrim(AF8_TPPRJ)
// 		If Ascan(aCC,{|x| x['id']==Alltrim(AF8_TPPRJ)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AF8_TPPRJ)
// 			jTmp['label'] 	:= AllTrim(TABELA('FE',AF8_TPPRJ))
// 			aAdd(aCC,jTmp)
// 			FreeObj(jTmp)
// 		Endif

// 		jRetTmp["date"]					:=	AllTrim(DATA)
// 		jRetTmp["startHour"] 			:= 	HORAI
// 		jRetTmp["finishHour"] 			:= 	HORAF
// 		jRetTmp["timesheet"] 			:= 	TIMESHEET 
// 		jRetTmp["hours"]				:= 	HQUANT
// 		jRetTmp["task"] 				:= 	Alltrim(AF9_TAREFA)
// 		jRetTmp["taskDescription"] 		:= 	Alltrim(AF9_DESCRI)
		
// 		aadd(jJsonRet['list'],jRetTmp)
// 		FreeObj(jRetTmp)
// 		DbSkip()
// 	Enddo

// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['resources'] := aRecurs
// 	aPrj	:=	aSort(aPrj,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['projects'] := aPrj
// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['teams'] := aTeam
// 	aType	:=	aSort(aType,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['types'] := aType
// 	aCC	:=	aSort(aCC,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['costCollectors'] := aCC

// Return jJsonRet

// /*/{Protheus.doc} GetAFUAJKSummary
// Get timesheet 
// @type function
// @author Bruno Sobieski
// @author Fernando Nicolau
// @since 18/07/2023
// @param cDateFrom, character, param_description
// @param cDateTo, character, param_description
// @param cTeam, character, param_description
// @param cRes, character, param_description
// @param cTypeTsk, character, param_description
// @param cPrj, character, param_description
// @param cCC, character, param_description
// @Return Json, Json Object
// /*/
// Static Function GetAFUAJKSummary(cDateFrom, cDateTo, cPeriod,cTeam, cRes, cTypeTsk, cPrj, cCC, cOption)
// 	Local cAliasQry    := GetNextAlias() As Character
// 	Local cSql      := "" As Character
// 	Local nX        := 0  As Numeric
// 	Local aRes      := {} As Array
// 	Local cOrder    := "" As Character
// 	Local aTeam     := {} As Array
// 	Local aRecurs     	:= {} As Array
// 	Local jJsonRet  := JsonObject():New() As Json
// 	Local aQryVarsTMP := {}
// 	Local aQryVars := {}
// 	Local oStatement := FWPreparedStatement():New()
// 	Local cDataFields := "" as character
// 	Local nWeek as Numeric
// 	Local nYear as Numeric
// 	Local dStartDate as Date
// 	Local dFinishDate as Date

// 	DEFAULT cOption := "AFUAJK"
// 	If cPeriod <> 'day' .And. cPeriod <> 'fortnight'  .And.cPeriod <> 'month' .And. cPeriod <> 'quarter' .And. cPeriod <> 'year'.And. cPeriod <> 'week'
// 		cPeriod = 'day'
// 	Endif
// 	//Adjust periods to date
// 	If len(cDateFrom) == 4
// 		cDateFrom+= "0101"
// 	ElseIf len(cDateFrom) == 6
// 		cDateFrom+= "01"
// 	EndIf
// 	If len(cDateTo) == 4
// 		cDateTo+= "12"
// 	Endif
// 	If len(cDateTo) == 6
// 		cDateTo	:= DtoS(LastDay(Stod(cDateTo+"01")))
// 	EndIf

// 	Do Case
// 	Case cPeriod == 'day'
// 		cDataFields := ", DATA as startdate "
// 	Case cPeriod == 'month'
// 		cDataFields := ", Substring(DATA,1,6) || '01' as startdate"
// 	Case cPeriod == 'fortnight'
// 		cDataFields := ",case "+;
// 					   "	when "+;
// 						"	SUBSTRING(DATA,7,2) <= '15' then "+;
// 						"		SUBSTRING(DATA,1,6) || '01'"+;
// 						"		else "+;
// 						"		SUBSTRING(DATA,1,6) || '16'"+;
// 						" end as startdate"
// 	Case cPeriod == 'quarter'
// 		cDataFields := ",case "+;
//     					"	when "+;
// 						"	SUBSTRING(DATA,5,2) <= '03' then "+;
// 						"		SUBSTRING(DATA,1,4) || '0101'"+;
//     					"	when "+;
// 						"	SUBSTRING(DATA,5,2) between '03' and '06' then "+;
// 						"		SUBSTRING(DATA,1,4) || '0401'"+;
//     					"	when "+;
// 						"	SUBSTRING(DATA,5,2) between '06' and '09' then "+;
// 						"		SUBSTRING(DATA,1,4) || '0701'"+;
//     					"	else "+;
// 						"		SUBSTRING(DATA,1,4) || '1001'"+;
// 						" end as startdate"
// 	Case cPeriod == 'year'
// 		cDataFields := ", Substring(DATA,1,4) || '0101' as startdate"
// 	//If not defined use Month
// 	Case cPeriod == 'week'
// 		cDataFields := ", DATA as startdate "
// 	OtherWise
// 		cDataFields := ", DATA as startdate "
// 	EndCase

// 	cDataFields := "AE8_RECURS, AE8_DESCRI, AED_EQUIP, AED_DESCRI,TIMESHEET, SUM(hquant) as hquant"+cDataFields
// 	cOrder	:=	"AE8_RECURS, startdate"
// 	cSQL    := ""
// 	cSql	:= " AND AFU_DATA BETWEEN ? AND ? "

// 	If !('AFU' $ cOption)
// 		cSql	+= " AND 1=0 "
// 	Endif

// 	cSqlAJK	:= " AND AJK_DATA BETWEEN ? AND ? "	
// 	If !('AJK' $ cOption)
// 		cSqlAJK	+= " AND 1=0 "
// 	Endif

// 	If cTeam <> Nil .And. !Empty(cTeam)
// 		aTmpFormatIn := SafeFormatIn(cTeam, ',')
// 		cSQL 	+= " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		cSqlAJK += " AND AED_EQUIP IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cRes<> Nil .And. !Empty(cRes)
// 		aTmpFormatIn := SafeFormatIn(cRes, ',')
// 		cSQL 	+= " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		cSQLAJK += " AND AE8_RECURS IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	If cPrj<> Nil .And. !Empty(cPrj)
// 		aTmpFormatIn := SafeFormatIn(cPrj, ',')
// 		cSQL 	+= " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		cSQLAJK += " AND AF8_PROJET IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cCC<> Nil .And. !Empty(cCC) 
// 		aTmpFormatIn := SafeFormatIn(cCC, ',')
// 		cSQL	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		cSQLAJK	+=	" AND AF8_TPPRJ IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf
// 	If cTypeTsk<> Nil .And. !Empty(cTypeTsk) 
// 		aTmpFormatIn := SafeFormatIn(cTypeTsk, ',')
// 		cSQL		+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		cSQLAJK		+=	" AND AF9_GRPCOM IN "+aTmpFormatIn[1]
// 		For nX:=1 To Len(aTmpFormatIn[2])
// 			aadd(aQryVars,aTmpFormatIn[2][nX])
// 		Next
// 	EndIf

// 	//cSql:=	"% "+cSql+ " %"
// 	//%noparser%

// 	BeginContent var cQuery
// 	SELECT 	%Exp:cDataFields%	from 	
//  (
// 		SELECT 
// 		1 AS TIMESHEET, AFU_DATA AS DATA, SUM(AFU_HQUANT) AS HQUANT,AE8_RECURS,AE8_DESCRI, AED_EQUIP, AED_DESCRI

// 		FROM %Exp:RetSqlName("AFU")% AFU, %Exp:RetSqlName("AF8")% AF8, 
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			
// 		WHERE 	AFU_FILIAL = '%Exp:xfilial("AFU")%' AND AFU.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AFU_PROJET = AF8_PROJET AND
// 				AFU_PROJET = AF9_PROJET AND
// 				AFU_TAREFA = AF9_TAREFA AND
// 				AFU_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AFU_CTRRVS = '1' AND
// 				AFU_RECURS = AE8_RECURS
// 				%Exp:cSql%		
// 		GROUP BY  AE8_RECURS, AE8_DESCRI,AED_EQUIP, AED_DESCRI, AFU_DATA 

// 		UNION ALL

// 		SELECT 
// 		0 AS TIMESHEET, AJK_DATA as DATA,Sum(AJK_HQUANT) AS HQUANT,AE8_RECURS,AE8_DESCRI, AED_EQUIP, AED_DESCRI

// 		FROM %Exp:RetSqlName("AJK")% AJK, %Exp:RetSqlName("AF8")% AF8,
// 			 %Exp:RetSqlName("AF9")% AF9 LEFT OUTER JOIN %Exp:RetSqlName("AE5")% AE5 ON 
// 				AE5_FILIAL = '%Exp:xfilial("AE5")%' AND AF9_GRPCOM = AE5_GRPCOM  AND
// 				AE5.d_e_l_e_t_='',
// 			 %Exp:RetSqlName("AE8")% AE8 LEFT OUTER JOIN %Exp:RetSqlName("AED")% AED ON 
// 				AED_FILIAL = '%Exp:xfilial("AED")%' AND AE8_EQUIP = AED_EQUIP AND	
// 				AED.d_e_l_e_t_=''			
// 		WHERE 	AJK_FILIAL = '%Exp:xfilial("AJK")%' AND AJK.d_e_l_e_t_='' AND
// 				AF8_FILIAL = '%Exp:xfilial("AF8")%' AND AF8.d_e_l_e_t_='' AND
// 				AF9_FILIAL = '%Exp:xfilial("AF9")%' AND AF9.d_e_l_e_t_='' AND
// 				AE8_FILIAL = '%Exp:xfilial("AE8")%' AND AE8.d_e_l_e_t_='' AND
// 				AJK_PROJET = AF8_PROJET AND
// 				AJK_PROJET = AF9_PROJET AND
// 				AJK_TAREFA = AF9_TAREFA AND
// 				AJK_REVISA = AF8_REVISA AND
// 				AF9_REVISA = AF8_REVISA AND
// 				AJK_CTRRVS = '1' AND
// 				AJK_SITUAC = '1' AND
// 				AJK_RECURS = AE8_RECURS
// 				%Exp:cSqlAJK%				

// 		GROUP BY  AE8_RECURS, AE8_DESCRI,AED_EQUIP, AED_DESCRI, AJK_DATA 
// 	) AS ITEMS
// 		GROUP BY TIMESHEET, AE8_RECURS, AE8_DESCRI,AED_EQUIP, AED_DESCRI, startDate 
// 		ORDER BY %Exp:cOrder%
// 	EndContent
// 	Conout(cQuery)

// 	cQuery := ChangeQuery(cQuery)
// 	//Conout(cQuery)

// 	//Define a consulta e os parâmetros
// 	oStatement:SetQuery(cQuery)
// 	aadd(aQryVarsTMP,cDateFrom)
// 	aadd(aQryVarsTMP,cDateTo)
// 	For nX:=1 To Len(aQryVars)
// 		AAdd(aQryVarsTMP, aQryVars[nX])
// 	Next
// 	aadd(aQryVarsTMP,cDateFrom)
// 	aadd(aQryVarsTMP,cDateTo)
// //	If cOption == 'AFUAJK'
// 		For nX:=1 To Len(aQryVars)
// 			AAdd(aQryVarsTMP,aQryVars[nX])
// 		Next
// //	Endif
// 	oStatement:setParams(aQryVarsTMP)	
// 	//Recupera a consulta já com os parâmetros injetados
// 	cFinalQuery := oStatement:GetFixQuery()
// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cFinalQuery), cAliasQry, .F., .T.)
// 	jJsonRet['list'] 	:= {}
// 	jJsonRet['resources']:= {}
// 	jJsonRet['teams'] 	:= {}

// 	aRes	:=	{}
// 	WHILE !EOF()
// 		jRetTmp := JsonObject():New()

// 		jRetTmp["resource"]	:=	AllTrim(AE8_RECURS)
// 		If Ascan(aRecurs,{|x| x['id']==AllTrim(AE8_recurs)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AE8_recurs)
// 			jTmp['label'] 	:= AllTrim(AE8_descri)
// 			aAdd(aRecurs,jTmp)
// 			FreeObj(jTmp)
// 		EndIf

// 		jRetTmp["resource"]	:=	AllTrim(AED_EQUIP)
// 		If Ascan(aTeam,{|x| x['id']==AllTrim(AED_EQUIP)}) == 0
// 			jTmp := JsonObject():New()
// 			jTmp['id'] 		:= Alltrim(AED_EQUIP)
// 			jTmp['label'] 	:= AllTrim(AED_descri)
// 			aAdd(aTeam,jTmp)
// 			FreeObj(jTmp)
// 		EndIf
// 		dStartDate :=Stod(AllTrim(startDate))
// 		If cPeriod == 'week'
// 			nWeek := RetSem(dStartDate)
// 			nYear := Year(dStartDate)
// 			dStartDate := dStartDate - (Dow(dStartDate)-1)
// 			dFinishDate:= dStartDate + 6 
// 			If (nPos := Ascan(jJsonRet['list'], {|x| x['week'] == nWeek .And. x['year'] == nYear .and. x['resource'] == Alltrim(AE8_RECURS)})) == 0
// 				AAdd(jJsonRet['list'],jRetTmp)
// 				nPos := Len(jJsonRet['list'])
// 				jJsonRet['list'][nPos]["hoursTimesheet"] 	:= 0
// 				jJsonRet['list'][nPos]["hoursPreTimesheet"] := 0
// 				jJsonRet['list'][nPos]["startDate"]			:=	Dtos(dStartDate)
// 				jJsonRet['list'][nPos]["team"] 				:= 	Alltrim(AED_EQUIP)
// 				jJsonRet['list'][nPos]["resource"] 			:= 	Alltrim(AE8_RECURS)
// 				jJsonRet['list'][nPos]["week"]				:=	nWeek
// 				jJsonRet['list'][nPos]["year"]				:=	nYear
// 				jJsonRet['list'][nPos]["month"]				:=	Month(dStartDate)
// 				jJsonRet['list'][nPos]["day"]				:=	Day(dStartDate)
// 			Endif
// 		Else
// 			nWeek := RetSem(dStartDate)
// 			nYear := Year(dStartDate)
// 			If (nPos := Ascan(jJsonRet['list'], {|x| x['startDate'] == AllTrim(startDate) .and. x['resource'] == Alltrim(AE8_RECURS)})) == 0
// 				AAdd(jJsonRet['list'],jRetTmp)
// 				nPos := Len(jJsonRet['list'])
// 				jJsonRet['list'][nPos]["hoursTimesheet"] 	:= 0
// 				jJsonRet['list'][nPos]["hoursPreTimesheet"] := 0
// 				jJsonRet['list'][nPos]["startDate"]			:=	AllTrim(startDate)
// 				jJsonRet['list'][nPos]["team"] 				:= 	Alltrim(AED_EQUIP)
// 				jJsonRet['list'][nPos]["resource"] 			:= 	Alltrim(AE8_RECURS)
// 				jJsonRet['list'][nPos]["week"]				:=	nWeek
// 				jJsonRet['list'][nPos]["year"]				:=	nYear
// 				jJsonRet['list'][nPos]["month"]				:=	Month(dStartDate)
// 				jJsonRet['list'][nPos]["day"]				:=	Day(dStartDate)
// 			Endif
// 		Endif
// 		jJsonRet['list'][nPos]["hoursTimesheet"] 	+= 	IIf (TIMESHEET == 1,HQUANT,0)
// 		jJsonRet['list'][nPos]["hoursPreTimesheet"] += 	IIf (TIMESHEET == 0,HQUANT,0)
// 		Do Case
// 		Case cPeriod == 'day'
// 			jJsonRet['list'][nPos]["finishDate"]	:= AllTrim(startDate)
// 		Case cPeriod == 'week'
// 		 	jJsonRet['list'][nPos]["finishDate"] 	:= Dtos(dFinishDate)
// 		Case cPeriod == 'month'
// 			jJsonRet['list'][nPos]["finishDate"]	:=	DtoS(LastDay(Stod(startDate)))
// 		Case cPeriod == 'fortnight'
// 			jJsonRet['list'][nPos]["finishDate"]	:=	iif(Substr(startDate,7,2)=="01",Substr(startDate,1,6)+"15" , DtoS(LastDay(Stod(startDate))))
// 		Case cPeriod == 'quarter'
// 			jJsonRet['list'][nPos]["finishDate"]	:=	DtoS(LastDay(Stod(StrZero(Val(Substr(startDate,1,6)) + 2,6)+"01")))
// 		Case cPeriod == 'year'
// 			jJsonRet['list'][nPos]["finishDate"]	:=	Substr(startDate,1,4) + "1231"
// 		//If not defined use Month
// 		OtherWise
// 			jJsonRet['list'][nPos]["finishDate"]	:=	DtoS(LastDay(Stod(startDate)))
// 		EndCase
		
// 		//aadd(jJsonRet['list'],jRetTmp)
// 		FreeObj(jRetTmp)
// 		DbSkip()
// 	Enddo

// 	aRecurs	:=	aSort(aRecurs,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['resources'] := aRecurs
// 	aTeam	:=	aSort(aTeam,/*nInicio*/,/*nCont*/,{|x,y| x['id']<y['id']})
// 	jJsonRet['teams'] := aTeam

// Return jJsonRet

// Static Function CatchError(oError)
// 	//Local nAt := At(chr(10),oError:errorStack,2)
// 	//Local nFind := 1
// 	Local aDetails
// 	// While nAt == 0 .Or. nFind <=2
// 	// 	nFind++
// 	// 	nAt := At(chr(10),oError:errorStack,nAt+1)
// 	// Enddo
// 	//SetRestFault(nCode,cMessage,lJson,nStatus,cDetailMsg,cHelpUrl,aDetails)
// 	//SetRestFault(500,oError:description,.T.,500,Substr(oError:errorStack,2,nAt-3),,{"asdasdas","asdsadasdsa"})
// 	aDetails := { {500,oError:description,Substr(oError:errorStack,2),"",{} }}
// 	cError := "Error : "+oError:description
// 	cError += '\n'+Substr(oError:errorStack,2)
// 	SetRestFault(500,cError,.T.,500,Substr(oError:errorStack,2),,aDetails)
// 	Break //__Quit()
// Return

// Static function RetUsed(cProjeto,cTarefa,cRecurs)
// 	Local cAliasQry	:= "AFU"+getNextAlias()
// 	Local cAlias	   := ""
// 	Local nRet    :=  0

// 	cRevisa := PmsAF8Ver(cProjeto)

// 	cAlias	:= Alias()
// 	cQuery    := "SELECT SUM(AFU_HQUANT) AFU_HQUANT from "+RETSqlNAME('AFU')+" AFU WHERE "
// 	cQuery    += "AFU_FILIAL ='"+XFilial('AFU')+"' and "
// 	cQuery    += "AFU_PROJET='"+cProjeto+"' AND "
// 	cQuery    += "AFU_REVISA='"+cRevisa+"' AND "
// 	cQuery    += "AFU_TAREFA='"+cTarefa+"' AND "
// 	cQuery    += "AFU_RECURS='"+cRecurs+"'  AND "
// 	cQuery    += "AFU_DATA <='"+DTOS(dDataBase)+"' AND "
// 	cQuery    += "d_e_l_e_t_ =' ' "

// 	dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cAliasQry, .F., .T.)

// //posiciona no registro referente a confirmação ate a database
// 	If (cAliasQry)->( !EOF() )
// 		nRet := AFU_HQUANT
// 	EndIf

// 	(cAliasQry)->(dbCloseArea())
// 	dbSelectArea(cAlias)

// Return nRet

// Static Function  SafeFormatIn( cString, cSep, nTam )
// 	LOCAL cRet := "(",; // array de string separadas
// 	nPoSep         // posicao do separador da string
// 	Local aVars := {}
// 	DEFAULT nTam := 0
// 	WHILE .T.
// 		// localiza a posicao do separador e separa a string encontrada
// 		If nTam > 0
// 			nPoSep := nTam
// 		Else
// 			nPoSep := AT(cSep,cString)
// 		Endif
// 		AAdd(aVars, IIf(nPoSep#0, LEFT(cString,nPoSep-If(nTam>0,0,1)), cString))
// 		cRet   += IIf(nPoSep#0, "?,", "?")
// 		// verifica se existem mais separadores
// 		IF nPoSep#0
// 			If Len(cString) > nTam
// 				cString := SUBSTR(cString,nPoSep+1)
// 			Else
// 				cRet := Left(cRet,Len(cRet)-1)
// 				cRet += ")"
// 				EXIT
// 			Endif
// 		ELSE
// 			cRet += ")"
// 			EXIT
// 		ENDIF
// 	ENDDO
// RETURN {cRet,aVars}

// Static function TaskObject(cAliasAF8, cAliasAF9, cAliasAFA, cAliasAFC, cAliasAED, cAliasAE8)
// Local jTsk := JsonObject():New()
// // Check Bug on saving time
// Local cTmpHour := ""
// If cAliasAF8 == Nil
// 	AF8->(DbSetOrder(1))
// 	AF8->(DbSeek(xFilial()+(cAliasAF9)->AF9_PROJET+(cAliasAF9)->AF9_TAREFA))
// 	cAliasAF8 := "AF8"
// Endif
// jTsk["project"]			:=	AllTrim((cAliasAF8)->AF8_PROJET)
// jTsk["task"]			:=	AllTrim((cAliasAF9)->AF9_TAREFA)
// jTsk["taskDescription"]	:=	AllTrim((cAliasAF9)->AF9_DESCRI)
// jTsk["type"]			:=	AllTrim((cAliasAF9)->AF9_GRPCOM)
// jTsk["costCollector"]	:=	AllTrim((cAliasAF8)->AF8_TPPRJ)
// If !Empty(cAliasAFA)
// 	jTsk['hoursResource'] 	:= (cAliasAFA)->(AFA_QUANT)
// Endif
// If !Empty(cAliasAE8)
// 	jTsk["resource"]		:=	AllTrim((cAliasAE8)->AE8_RECURS)
// Endif
// If !Empty(cAliasAED)
// 	jTsk["team"]			:=	AllTrim((cAliasAED)->AED_EQUIP)
// Endif
// jTsk["startDate"]		:=	AllTrim((cAliasAF9)->AF9_START)
// jTsk["startTime"]		:=	AllTrim((cAliasAF9)->AF9_HORAI)
// If Substr((cAliasAF9)->AF9_HORAI,3,1) <> ":""
// 	cTmpHour := "00:00:00"
// Else
// 	If Len(Alltrim((cAliasAF9)->AF9_HORAI))==4
// 		cTmpHour := "0"+Alltrim((cAliasAF9)->AF9_HORAI)+":00"
// 	Else
// 		cTmpHour := (cAliasAF9)->AF9_HORAI+":00"
// 	Endif
// Endif
// jTsk["start"]		:=	FWTimeStamp(6, Stod((cAliasAF9)->AF9_START), cTmpHour)
// jTsk["endDate"]		:=	AllTrim((cAliasAF9)->AF9_FINISH)
// jTsk["endTime"]		:=	AllTrim((cAliasAF9)->AF9_HORAF)
// If Substr((cAliasAF9)->AF9_HORAF,3,1) <> ":""
// 	cTmpHour := "23:59:00"
// Else
// 	If Len(Alltrim((cAliasAF9)->AF9_HORAF))==4
// 		cTmpHour := "0"+Alltrim((cAliasAF9)->AF9_HORAF)+":00"
// 	Else
// 		cTmpHour := (cAliasAF9)->AF9_HORAF+":00"
// 	Endif
// Endif

// jTsk["end"]			:=	FWTimeStamp(6, Stod((cAliasAF9)->AF9_FINISH), cTmpHour)

// if !Empty((cAliasAF9)->AF9_DTATUI)
// 	jTsk['startRealDate'] 	:= 	AllTrim((cAliasAF9)->AF9_DTATUI)
// 	jTsk['startRealTime'] 	:= 	AllTrim((cAliasAF9)->AF9_HRATUI)
// 	If Substr((cAliasAF9)->AF9_HRATUI,3,1) <> ":""
// 		cTmpHour := "00:00:00"
// 	Else
// 		if Len(alltrim((cAliasAF9)->AF9_HRATUI)) == 4
// 			cTmpHour := "0"+Alltrim((cAliasAF9)->AF9_HRATUI)+":00"
// 		else
// 			cTmpHour := (cAliasAF9)->AF9_HRATUI+":00"
// 		Endif
// 	Endif
// 	jTsk["startReal"]		:=	FWTimeStamp(6, Stod((cAliasAF9)->AF9_DTATUI), cTmpHour)
// Endif
// if !Empty((cAliasAF9)->AF9_DTATUF)
// 	jTsk['endRealDate'] 	:= 	AllTrim((cAliasAF9)->AF9_DTATUF)
// 	jTsk['endRealTime'] 	:= 	AllTrim((cAliasAF9)->AF9_HRATUF)
// 	If Substr((cAliasAF9)->AF9_HRATUF,3,1) <> ":""
// 		cTmpHour := "23:59:00"
// 	Else
// 		if Len(alltrim((cAliasAF9)->AF9_HRATUF)) == 4
// 			cTmpHour := "0"+Alltrim((cAliasAF9)->AF9_HRATUF)+":00"		
// 		else
// 			cTmpHour := (cAliasAF9)->AF9_HRATUF+":00"
// 		Endif
// 	Endif
// 	jTsk["endReal"]			:=	FWTimeStamp(6, Stod((cAliasAF9)->AF9_DTATUF), cTmpHour)
// Endif
// jTsk['hoursTask'] 		:= (cAliasAF9)->(AF9_QUANT)

// Return jTsk

