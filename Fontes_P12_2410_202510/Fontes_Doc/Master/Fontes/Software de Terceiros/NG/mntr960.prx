#INCLUDE "MNTR960.ch"
#include "PROTHEUS.ch"

/*


Ŀ
Funo    MNTR960    Autor Soraia de Carvalho      Data  31/01/06 
Ĵ
Descrio Resumo mensal de KM por filial                              
Ĵ
 Uso      MNR960                                                      
ٱ


*/
Function MNTR960()

	Private aRotina   := MenuDef()
	Private cTRB 	  := GetNextAlias()
	Private cCadastro := OemtoAnsi(STR0004)   //"Relatorio mensal de resumo de KM"
	Private cPerg  	  := "MNR960    "
	Private aPerg 	  := {}
	Private aVETINR   := {}  
	Private cMESANTER
	Private cMESATUAL
	Private nAno 
	Private lOper     := If(Alltrim(GetMv("MV_NGOPER")) == "S",.T.,.F.)
	Private cContab   := GetMv("MV_MCONTAB")
	Private lST6Tipo  := NGCADICBASE('T6_TIPO1','A','ST6',.F.)
	Private vCampoCC  := {}
	Private nSizeFil  := If(FindFunction("FWSizeFilial"),FwSizeFilial(),Len(STP->TP_FILIAL))

	If cContab == "CTB"
		vCampoCC := {"CTT","CTT_CUSTO","CTT_OPERAC"}
	ElseIf cContab == "CON"
		vCampoCC := {"SI3","I3_CUSTO","I3_OPERAC"}
	EndIf

	SetKey( VK_F9, { | | NGVersao( "MNTR960" , 1 ) } )

	aPos1 := {15,1,95,315 }

	If lST6Tipo
		aDBFR960 := {{"CODSER" ,"C", 03,0},;
		{"TIPSER" ,"C", 40,0},;
		{"CODFL"  ,"C", nSizeFil,0},;
		{"NMFL"   ,"C", 20,0},;
		{"KMANT"  ,"N", 09,0},;
		{"KMAT"   ,"N", 09,0},; 
		{"TIPO"   ,"C", 03,0},;
		{"PERC"   ,"N", 12,2}}
	Else
		aDBFR960 := {{"CODSER" ,"C", 03,0},;
		{"TIPSER" ,"C", 40,0},;
		{"CODFL"  ,"C", nSizeFil,0},;
		{"NMFL"   ,"C", 20,0},;
		{"KMANT"  ,"N", 09,0},;
		{"KMAT"   ,"N", 09,0},; 
		{"PERC"   ,"N", 12,2}}
	EndIf


	If lOper
		If lST6Tipo
			aINDR960  := {{"TIPSER","CODFL","TIPO"},{"CODSER","NMFL"}}
		Else
			aINDR960  := {{"TIPSER","CODFL"},{"CODSER","NMFL"}}
		EndIf
	Else
		If lST6Tipo
			aINDR960  := {{"CODFL","TIPO"},{"NMFL"}}
		Else
			aINDR960  := {{"CODFL"},{"NMFL"}}
		EndIf
	EndIf

	//Cria Tabela Temporria 
	oARQTR960 := NGFwTmpTbl(cTRB, aDBFR960, aINDR960)

	If lOper
		If lST6Tipo
			aTRBB := {{STR0022 ,"TIPSER" ,"C", 40,0,"@!"},;               //"Operao"
					  {STR0014 ,"NMFL"   ,"C", nSizeFil,0,"@!" },;        //"Filial"
			{STR0015 ,"KMANT"  ,"N", 09,0,"@ 999,999,999" },;   //"Anterior"
			{""      ,"TIPO"   ,"C", 03,0,"@!" },;
			{STR0016 ,"KMAT"   ,"N", 09,0,"@ 999,999,999" },;   //"Atual"
			{""      ,"TIPO"   ,"C", 03,0,"@!" },;
			{STR0017 ,"PERC "  ,"N", 12,2,"@E 999,999,999.99" }}//"%Rodado"
		Else
			aTRBB := {{STR0022 ,"TIPSER" ,"C", 40,0,"@!"},;               //"Operao"
					  {STR0014 ,"NMFL"   ,"C", nSizeFil,0,"@!" },;        //"Filial"
			{STR0015 ,"KMANT"  ,"N", 09,0,"@ 999,999,999" },;   //"Anterior"
			{STR0016 ,"KMAT"   ,"N", 09,0,"@ 999,999,999" },;   //"Atual"
			{STR0017 ,"PERC "  ,"N", 12,2,"@E 999,999,999.99" }}//"%Rodado"
		EndIf
	Else	   
		If lST6Tipo
			aTRBB := {{STR0014 ,"NMFL"   ,"C", nSizeFil,0,"@!" },; 	 	  //"Filial"
			{STR0015 ,"KMANT"  ,"N", 09,0,"@ 999,999,999" },;   //"Anterior"
			{""      ,"TIPO"   ,"C", 03,0,"@!" },;
			{STR0016 ,"KMAT"   ,"N", 09,0,"@ 999,999,999" },;   //"Atual"
			{""      ,"TIPO"   ,"C", 03,0,"@!" },;
			{STR0017 ,"PERC "  ,"N", 12,2,"@E 999,999,999.99" }}//"%Rodado"
		Else
			aTRBB := {{STR0014 ,"NMFL"   ,"C", nSizeFil,0,"@!" },;        //"Filial"
			{STR0015 ,"KMANT"  ,"N", 09,0,"@ 999,999,999" },;   //"Anterior"
			{STR0016 ,"KMAT"   ,"N", 09,0,"@ 999,999,999" },;   //"Atual"
			{STR0017 ,"PERC "  ,"N", 12,2,"@E 999,999,999.99" }}//"%Rodado"
		EndIf
	EndIf

	If Pergunte("MNR960",.T.)
		Processa({ |lEnd| MNR960INI()},STR0023,STR0013) //"Aguarde..."###"Processando Registros..."
		DbSelectarea(cTRB)
		DbGotop()     
		mBrowse(6,1,22,75,(cTRB),aTRBB)
	EndIf

	//Deleta o arquivo temporario fisicamente 
	oARQTR960:Delete()       

	DbSelectArea("TQN")
	DbSetOrder(01)
	Dbseek(xFilial("TQN"))

Return .T.

/*


Ŀ
Funo    MNTR960INI Autor Soraia de Carvalho      Data  10/01/06 
Ĵ
Descrio Monta o arquivo temporario inicial mostrado no browse       
Ĵ
 Uso      MNR960                                                      
ٱ


*/
Function MNR960INI()
	Local aResumo := {}, i := 0
	Local _cGetDB := TcGetDb()		
	Private nKMAN, nKMAT,nKmPercA := 0,nKmPercB := 0
	Private cOperA := Space(1)

	nMes := Val(SubStr(Mv_Par03,1,2))
	nAno := Val(SubStr(Mv_Par03,4,4))
	If nMes = 01
		nMes := 12
		nAno := nAno-1
		cDATATQN2 := StrZero(nMes,2)+ "/" + Alltrim(Str(nAno)) 
	Else 
		nMes := nMes-1
		cDATATQN2 := StrZero(nMes,2)+ "/" + Alltrim(Str(nAno)) 
	EndIf   
	cMESANTER := MesExtenso(cDATATQN2)
	cMESATUAL := MesExtenso(Mv_Par03)
	dDATATUAL := SUBSTR(MV_PAR03,4,4)+SUBSTR(MV_PAR03,1,2)
	dDATAAT   := SUBSTR(cDATATQN2,4,4)+SUBSTR(cDATATQN2,1,2)
	nMes := Val(SubStr(dDATAAT,5,2))
	nAno := Val(SubStr(dDATAAT,1,4))
	If nMes = 01
		nMes := 12
		nAno := nAno-1
		cDATATQN2 := StrZero(nMes,2)+ "/" + Alltrim(Str(nAno)) 
	Else 
		nMes := nMes-1
		cDATATQN2 := StrZero(nMes,2)+ "/" + Alltrim(Str(nAno)) 
	EndIf   
	dDATAAT2   := SUBSTR(cDATATQN2,4,4)+SUBSTR(cDATATQN2,1,2)

	cAliasQry := GetNextAlias()                     

	If Upper(_cGetDB) == "ORACLE"                                 
		cQuery := " SELECT A.TP_FILIAL,A.TP_CODBEM,((MAX(A.TP_ACUMCON)-(SELECT MAX(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C  "
		cQuery += " WHERE C.TP_TEMCONT = 'S' AND C.TP_CODBEM=A.TP_CODBEM AND C.D_E_L_E_T_ = ' ' "
		cQuery += " AND (C.TP_TIPOLAN = 'A' OR C.TP_TIPOLAN = 'I') AND "
		cQuery += " ((A.TP_FILIAL <> C.TP_FILIAL AND SUBSTR(C.TP_DTLEITU,1,6)<='"+dDatAtual+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTR(C.TP_DTLEITU,1,6)<'"+dDatAtual+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTR(c.tp_dtleitu,1,6) <= '"+dDatAtual+"' AND (A.TP_CCUSTO <> C.TP_CCUSTO)) " 
		cQuery += " ))))KMPERC ,A.TP_CCUSTO "
		If lOper
			cQuery += ",E.TSZ_DESSER "
		EndIf	
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " FROM "+RetSQLName("STP")+" A "
		If lOper
			cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E"
		EndIf	
		If lST6Tipo
			cQuery += ", "+RetSQLName("ST9")+" F, "+RetSQLName("ST6")+" G"
		EndIf
		cQuery += " WHERE SUBSTR(A.TP_DTLEITU,1,6)='"+dDatAtual+"'" 
		cQuery += " AND A.TP_FILIAL BETWEEN '"+Mv_Par01+"' AND '"+Mv_Par02+"' AND A.D_E_L_E_T_ = ' ' AND "
		If lOper
			cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+" AND D."+vCampoCC[3]+"=E.TSZ_CODSER and "
		EndIf	
		cQuery += " (A.TP_TIPOLAN = 'A' OR A.TP_TIPOLAN = 'I') AND A.TP_TEMCONT = 'S' AND "
		cQuery += " A.TP_CODBEM IN  (SELECT B.TP_CODBEM FROM "+RetSQLName("STP")+" B WHERE "
		cQuery += " B.D_E_L_E_T_ = ' ') "
		If lOper
			cQuery += " AND D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' "
		EndIf
		If lST6Tipo
			cQuery += " AND A.TP_CODBEM = F.T9_CODBEM AND F.T9_CODFAMI = G.T6_CODFAMI "
		EndIf
		cQuery += " GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
		If lOper
			cQuery += " ,E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " ORDER BY A.TP_FILIAL"
		If lOper
			cQuery += " ,E.TSZ_DESSER"
		EndIf
		If lST6Tipo
			cQuery += ", G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += "	,KMPERC"
	Else
		cQuery := " SELECT A.TP_FILIAL,A.TP_CODBEM,((MAX(A.TP_ACUMCON)-(SELECT MAX(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C  "
		cQuery += " WHERE C.TP_TEMCONT = 'S' AND C.TP_CODBEM=A.TP_CODBEM AND C.D_E_L_E_T_ = ' ' "
		cQuery += " AND (C.TP_TIPOLAN = 'A' OR C.TP_TIPOLAN = 'I') AND "
		cQuery += " ((A.TP_FILIAL <> C.TP_FILIAL AND SUBSTRING(C.TP_DTLEITU,1,6)<='"+dDatAtual+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTRING(C.TP_DTLEITU,1,6)<'"+dDatAtual+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTRING(c.tp_dtleitu,1,6) <= '"+dDatAtual+"' AND (A.TP_CCUSTO <> C.TP_CCUSTO)) " 
		cQuery += " )))) AS KMPERC,A.TP_CCUSTO "
		If lOper
			cQuery += ",E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " FROM "+RetSQLName("STP")+" A "
		If lOper
			cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E "
		EndIf
		If lST6Tipo
			cQuery += ", "+RetSQLName("ST9")+" F, "+RetSQLName("ST6")+" G"
		EndIf
		cQuery += " WHERE SUBSTRING(A.TP_DTLEITU,1,6)='"+dDatAtual+"'" 
		cQuery += " AND A.TP_FILIAL BETWEEN '"+Mv_Par01+"' AND '"+Mv_Par02+"' AND A.D_E_L_E_T_ = ' ' AND "
		If lOper
			cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+" AND D."+vCampoCC[3]+"=E.TSZ_CODSER and "
		EndIf
		cQuery += "	(A.TP_TIPOLAN = 'A' OR A.TP_TIPOLAN = 'I') AND A.TP_TEMCONT = 'S' AND "
		cQuery += " A.TP_CODBEM IN  (SELECT B.TP_CODBEM FROM "+RetSQLName("STP")+" B WHERE "
		cQuery += " B.D_E_L_E_T_ = ' ')"
		If lOper
			cQuery += " AND D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' "
		EndIf
		If lST6Tipo
			cQuery += " AND A.TP_CODBEM = F.T9_CODBEM AND F.T9_CODFAMI = G.T6_CODFAMI "
		EndIf
		cQuery += " GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
		If lOper
			cQuery += ",E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " ORDER BY A.TP_FILIAL"
		If lOper
			cQuery += ",E.TSZ_DESSER"
		EndIf
		If lST6Tipo
			cQuery += ", G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += ", KMPERC "
	EndIf	
	cQuery := ChangeQuery(cQuery)
	dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),cAliasQry, .F., .T.)

	DbSelectArea(cALIASQRY) 
	DbGotop()
	ProcRegua(LastRec(),STR0023,STR0013) //"Aguarde..."###"Processando Registros..."
	cOperac := " "
	While !Eof()

		IncProc(STR0023,STR0013)   //"Aguarde..."###"Selecionando Registros..."
		cFil 	   := (cAliasQry)->TP_FILIAL

		If lST6Tipo
			cTipo    := (cAliasQry)->T6_TIPO1
		EndIf
		If lOper
			cOperac 	:= (cAliasQry)->TSZ_DESSER
			cCond := " cFil == (cAliasQry)->TP_FILIAL .AND. cOperac == (cAliasQry)->TSZ_DESSER"
		Else
			cCond := " cFil == (cAliasQry)->TP_FILIAL"
		EndIf

		If lST6Tipo
			cCond += " .AND. (cTipo == (cAliasQry)->T6_TIPO1)"
		EndIf

		lRes := .f.                                                   

		While !Eof() .And. &cCond  //cFil == (cAliasQry)->TP_FILIAL .AND. cOperac == (cAliasQry)->TSZ_DESSER 
			// .AND. (cTipo == (cAliasQry)->T6_TIPO1) //se lST6Tipo
			If Empty((cAliasQry)->KmPerc) .OR. (cAliasQry)->KmPerc < 0
				lGroup := .f.
				If (cAliasQry)->KmPerc < 0
					cMaxMin := 'MAX'
					//cDtQry  := dDATAAT 
					cDtQry  := 'D.TP_DTLEITU < A.TP_DTLEITU'
					lGroup  := .t.
				Else	             
					cMaxMin := 'MIN'    
					cDtQry  := 'SUBSTR(D.TP_DTLEITU,1,6)<='+"'"+dDatAtual+"'"
				EndIf	
				cQry := GetNextAlias()

				If Upper(_cGetDB) == "ORACLE"                                                                  

					cQuery := " SELECT A.TP_FILIAL,a.tp_codbem,((MAX(A.TP_ACUMCON)- "
					cQuery += " (SELECT "+cMaxMin+"(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C WHERE  C.TP_DTLEITU = "
					cQuery += " (SELECT "+cMaxMin+"(D.TP_DTLEITU) FROM "+RetSQLName("STP")+" D "
					cQuery += " WHERE D.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (D.TP_TIPOLAN='A' OR D.TP_TIPOLAN='I')"
					cQuery += " AND "+cDtQry+" AND D.D_E_L_E_T_ = ' ') "
					cQuery += " AND C.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' "
					cQuery += " AND (C.TP_TIPOLAN='I' OR C.TP_TIPOLAN='A') AND C.D_E_L_E_T_ = ' '))) AS KMPERC , "
					cQuery += " A.TP_CCUSTO "
					If lOper
						cQuery += ",E.TSZ_DESSER " 
					EndIf
					cQuery += " FROM "+RetSQLName("STP")+" A "
					If lOper 
						cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E " 
					EndIf	
					cQuery += " WHERE SUBSTR(A.TP_DTLEITU,1,6)='"+dDatAtual+"' AND A.TP_FILIAL='"+(cAliasQry)->TP_FILIAL+"' AND "
					cQuery += " A.D_E_L_E_T_ = ' ' AND "
					If lOper
						cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+"  AND D."+vCampoCC[3]+"=E.TSZ_CODSER AND "  
						cQuery += " E.TSZ_DESSER='"+(cAliasQry)->TSZ_DESSER+"' AND D."+vCampoCC[2]+"='"+(cAliasQry)->TP_CCUSTO+"' AND "
						cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
					EndIf	
					cQuery += " A.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (a.TP_TIPOLAN='I' OR a.TP_TIPOLAN='A') "
					cQuery += "GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
					If lOper
						cQuery += ",E.TSZ_DESSER "
					EndIf				
					If lGroup 
						cQuery += ",A.TP_DTLEITU ORDER BY A.TP_FILIAL
						If lOper 
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					Else	                                                                  
						cQuery += "ORDER BY A.TP_FILIAL"
						If lOper 
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					EndIf	
				Else                       
					If SubStr(cDtQry,1,6) == 'SUBSTR'
						cDtQry := 'SUBSTRING'+SubStr(cDtQry,7,Len(cDtQry)-6)
					EndIf	
					cQuery := " SELECT A.TP_FILIAL,a.tp_codbem,((MAX(A.TP_ACUMCON)- "
					cQuery += " (SELECT "+cMaxMin+"(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C WHERE C.TP_DTLEITU = "
					cQuery += " (SELECT "+cMaxMin+"(D.TP_DTLEITU) FROM "+RetSQLName("STP")+" D "
					cQuery += " WHERE D.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (D.TP_TIPOLAN='A' OR D.TP_TIPOLAN='I')"
					cQuery += " AND "+cDtQry+" AND D.D_E_L_E_T_ = ' ') "
					cQuery += " AND C.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' "
					cQuery += " AND (C.TP_TIPOLAN='I' OR C.TP_TIPOLAN='A') AND C.D_E_L_E_T_ = ' '))) AS KMPERC , "
					cQuery += " A.TP_CCUSTO "
					If lOper
						cQuery += ",E.TSZ_DESSER "
					EndIf
					cQuery += " FROM "+RetSQLName("STP")+" A "
					If lOper
						cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E " 
					EndIf
					cQuery += " WHERE SUBSTRING(A.TP_DTLEITU,1,6)='"+dDatAtual+"' AND A.TP_FILIAL='"+(cAliasQry)->TP_FILIAL+"' AND "
					cQuery += " A.D_E_L_E_T_ = ' ' AND "
					If lOper
						cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+"  AND D."+vCampoCC[3]+"=E.TSZ_CODSER AND "
						cQuery += " E.TSZ_DESSER='"+(cAliasQry)->TSZ_DESSER+"' AND D."+vCampoCC[2]+"='"+(cAliasQry)->TP_CCUSTO+"' AND "
						cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
					EndIf					
					cQuery += " A.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (a.TP_TIPOLAN='I' OR a.TP_TIPOLAN='A') "
					cQuery += "GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
					If lOper 
						cQuery += " ,E.TSZ_DESSER "
					EndIf	
					If lGroup 
						cQuery += ",A.TP_DTLEITU ORDER BY A.TP_FILIAL"
						If lOper 
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					Else	                                                                  
						cQuery += "ORDER BY A.TP_FILIAL"
						If lOper 
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					EndIf	
				EndIf
				cQuery := ChangeQuery(cQuery)
				dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),cQry, .F., .T.)

				DbSelectArea(cQRY)
				While !Eof()
					lRes := .t.
					nKmPercA += (cQRY)->KmPerc
					DbSelectArea(cQRY)
					DbSkip()
				End 
				If lRes
					(cQRY)->( dbCloseArea() )  
				EndIf	
			EndIf	
			DbSelectArea(cALIASQRY)
			If (cAliasQry)->KmPerc > 0 	
				nKmPercA += (cAliasQry)->KmPerc
			EndIf	
			If lOper
				cOperA   := (cAliasQry)->TSZ_DESSER
			EndIf	
			cFilA   := (cAliasQry)->TP_FILIAL

			If lST6Tipo
				cTipoA   := (cAliasQry)->T6_TIPO1
			EndIf
			DbSelectArea(cALIASQRY)
			DbSkip()
		End 
		aAdd(aResumo,{cFilA,cOperA,nKmPercA,1, If(lST6Tipo,cTipoA,"") })
		nKmPercA := 0
	End	
	(cALIASQRY)->( dbCloseArea() )  

	cAliasQry := GetNextAlias()

	If Upper(_cGetDB) == "ORACLE"
		cQuery := " SELECT A.TP_FILIAL,A.TP_CODBEM,((MAX(A.TP_ACUMCON)-(SELECT MAX(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C  "
		cQuery += " WHERE C.TP_TEMCONT = 'S' AND C.TP_CODBEM=A.TP_CODBEM AND C.D_E_L_E_T_ = ' ' "
		cQuery += " AND (C.TP_TIPOLAN = 'A' OR C.TP_TIPOLAN = 'I') AND "
		cQuery += " ((A.TP_FILIAL <> C.TP_FILIAL AND SUBSTR(C.TP_DTLEITU,1,6)<='"+dDATAAT+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTR(C.TP_DTLEITU,1,6)<'"+dDATAAT+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTR(c.tp_dtleitu,1,6) <= '"+dDATAAT+"' AND (A.TP_CCUSTO <> C.TP_CCUSTO)) " 
		cQuery += " ))))KMPERC ,A.TP_CCUSTO "
		If lOper
			cQuery += ",E.TSZ_DESSER " 
		EndIf
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += "	FROM "+RetSQLName("STP")+" A "
		If lOper
			cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E "
		EndIf
		If lST6Tipo
			cQuery += ", "+RetSQLName("ST9")+" F, "+RetSQLName("ST6")+" G "
		EndIf
		cQuery += "	WHERE SUBSTR(A.TP_DTLEITU,1,6)='"+dDATAAT+"'" 
		cQuery += " AND A.TP_FILIAL BETWEEN '"+Mv_Par01+"' AND '"+Mv_Par02+"' AND A.D_E_L_E_T_ = ' ' AND "
		If lOper
			cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+" AND D."+vCampoCC[3]+"=E.TSZ_CODSER and "
			cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
		EndIf
		cQuery += " (A.TP_TIPOLAN = 'A' OR A.TP_TIPOLAN = 'I') AND A.TP_TEMCONT = 'S' AND "
		cQuery += " A.TP_CODBEM IN  (SELECT B.TP_CODBEM FROM "+RetSQLName("STP")+" B WHERE "
		cQuery += " B.D_E_L_E_T_ = ' ') "
		If lST6Tipo
			cQuery += " AND A.TP_CODBEM = F.T9_CODBEM AND F.T9_CODFAMI = G.T6_CODFAMI "
		EndIf
		cQuery += " GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
		If lOper
			cQuery += " ,E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ",F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " ORDER BY A.TP_FILIAL "
		If lOper
			cQuery += " ,E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ", G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += ", KMPERC"
	Else
		cQuery := " SELECT A.TP_FILIAL,A.TP_CODBEM,((MAX(A.TP_ACUMCON)-(SELECT MAX(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C  "
		cQuery += " WHERE C.TP_TEMCONT = 'S' AND C.TP_CODBEM=A.TP_CODBEM AND C.D_E_L_E_T_ = ' ' "
		cQuery += " AND (C.TP_TIPOLAN = 'A' OR C.TP_TIPOLAN = 'I') AND "
		cQuery += " ((A.TP_FILIAL <> C.TP_FILIAL AND SUBSTRING(C.TP_DTLEITU,1,6)<='"+dDATAAT+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTRING(C.TP_DTLEITU,1,6)<'"+dDATAAT+"') "
		cQuery += " OR (A.TP_FILIAL = C.TP_FILIAL AND SUBSTRING(c.tp_dtleitu,1,6) <= '"+dDATAAT+"' AND (A.TP_CCUSTO <> C.TP_CCUSTO)) " 
		cQuery += " )))) AS KMPERC,A.TP_CCUSTO"
		If lOper
			cQuery += ",E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ",F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += "	FROM "+RetSQLName("STP")+" A"                   
		If lOper
			cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E "
		EndIf
		If lST6Tipo
			cQuery += ", "+RetSQLName("ST9")+" F, "+RetSQLName("ST6")+" G "
		EndIf
		cQuery += "	WHERE SUBSTRING(A.TP_DTLEITU,1,6)='"+dDATAAT+"'" 
		cQuery += " AND A.TP_FILIAL BETWEEN '"+Mv_Par01+"' AND '"+Mv_Par02+"' AND A.D_E_L_E_T_ = ' ' AND "
		If lOper
			cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+" AND D."+vCampoCC[3]+"=E.TSZ_CODSER and "
			cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
		EndIf
		cQuery += "	(A.TP_TIPOLAN = 'A' OR A.TP_TIPOLAN = 'I') AND A.TP_TEMCONT = 'S' AND "
		cQuery += " A.TP_CODBEM IN  (SELECT B.TP_CODBEM FROM "+RetSQLName("STP")+" B WHERE "
		cQuery += " B.D_E_L_E_T_ = ' ') "
		If lST6Tipo
			cQuery += "AND A.TP_CODBEM = F.T9_CODBEM AND F.T9_CODFAMI = G.T6_CODFAMI "
		EndIf
		cQuery += " GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
		If lOper
			cQuery += ",E.TSZ_DESSER"
		EndIf
		If lST6Tipo
			cQuery += ", F.T9_CODFAMI, G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += " ORDER BY A.TP_FILIAL"
		If lOper
			cQuery += ",E.TSZ_DESSER "
		EndIf
		If lST6Tipo
			cQuery += ",G.T6_TIPO1, G.T6_UNIDAD1, G.T6_MEDIA1 "
		EndIf
		cQuery += ",KMPERC"

	EndIf	
	cQuery := ChangeQuery(cQuery)
	dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),cAliasQry, .F., .T.)

	DbSelectArea(cALIASQRY) 
	DbGotop()
	ProcRegua(LastRec())
	cOperac := " "
	While !Eof()

		IncProc(STR0023,STR0013)   //"Aguarde..."###"Selecionando Registros..."
		cFil 	   := (cAliasQry)->TP_FILIAL

		If lST6Tipo
			cTipo    := (cAliasQry)->T6_TIPO1
		EndIf

		If lOper
			cOperac := (cAliasQry)->TSZ_DESSER
			cCond   := "cFil == (cAliasQry)->TP_FILIAL .AND. cOperac == (cAliasQry)->TSZ_DESSER"
		Else
			cCond   := "cFil == (cAliasQry)->TP_FILIAL"  	
		EndIf	                                                                                
		If lST6Tipo
			cCond += " .AND. (cTipo == (cAliasQry)->T6_TIPO1)"
		EndIf
		lRes := .f.
		While !Eof() .And. &cCond //cFil == (cAliasQry)->TP_FILIAL .AND. cOperac == (cAliasQry)->TSZ_DESSER 
			//.AND. (cTipo == (cAliasQry)->T6_TIPO1)"  //se lST6Tipo
			If Empty((cAliasQry)->KmPerc) .OR. (cAliasQry)->KmPerc < 0
				lGroup := .f.
				If (cAliasQry)->KmPerc < 0
					cMaxMin := 'MAX'  
					//cDtQry  := dDATAAT2    
					cDtQry  := 'D.TP_DTLEITU < A.TP_DTLEITU'
					lGroup  := .t.
				Else	             
					cMaxMin := 'MIN'    
					//cDtQry  := dDATAAT 
					cDtQry  := 'SUBSTR(D.TP_DTLEITU,1,6)<='+"'"+dDATAAT+"'"
				EndIf	
				cQry := GetNextAlias()

				If Upper(_cGetDB) == "ORACLE"                                 
					cQuery := " SELECT A.TP_FILIAL,a.tp_codbem,((MAX(A.TP_ACUMCON)- "
					cQuery += " (SELECT "+cMaxMin+"(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C WHERE  C.TP_DTLEITU = "
					cQuery += " (SELECT "+cMaxMin+"(D.TP_DTLEITU) FROM "+RetSQLName("STP")+" D "
					cQuery += " WHERE D.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (D.TP_TIPOLAN='A' OR D.TP_TIPOLAN='I')"
					cQuery += " AND "+cDtQry+" AND D.D_E_L_E_T_ = ' ') "
					cQuery += " AND C.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' "
					cQuery += " AND (C.TP_TIPOLAN='I' OR C.TP_TIPOLAN='A') AND C.D_E_L_E_T_ = ' '))) AS KMPERC,A.TP_CCUSTO "
					If lOper
						cQuery += " ,E.TSZ_DESSER "
					EndIf 
					cQuery += " FROM "+RetSQLName("STP")+" A" 
					If lOper
						cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E " 
					EndIf	
					cQuery += " WHERE SUBSTR(A.TP_DTLEITU,1,6)='"+dDATAAT+"' AND A.TP_FILIAL='"+(cAliasQry)->TP_FILIAL+"' AND A.D_E_L_E_T_ = ' ' AND "
					If lOper
						cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+"  AND D."+vCampoCC[3]+"=E.TSZ_CODSER AND " 
						cQuery += " E.TSZ_DESSER='"+(cAliasQry)->TSZ_DESSER+"' AND D."+vCampoCC[2]+"='"+(cAliasQry)->TP_CCUSTO+"' AND " 
						cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
					EndIf					
					cQuery += " A.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (a.TP_TIPOLAN='I' OR a.TP_TIPOLAN='A') "
					cQuery += "GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
					If lOper 
						cQuery += ",E.TSZ_DESSER "
					EndIf	
					If lGroup 
						cQuery += ",A.TP_DTLEITU ORDER BY A.TP_FILIAL"
						If lOper
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					Else	                                                                  
						cQuery += " ORDER BY A.TP_FILIAL"
						If lOper
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					EndIf					
				Else
					If SubStr(cDtQry,1,6) == 'SUBSTR'
						cDtQry := 'SUBSTRING'+SubStr(cDtQry,7,Len(cDtQry)-6)
					EndIf	
					cQuery := " SELECT A.TP_FILIAL,a.tp_codbem,((MAX(A.TP_ACUMCON)- "
					cQuery += " (SELECT "+cMaxMin+"(C.TP_ACUMCON) FROM "+RetSQLName("STP")+" C WHERE  C.TP_DTLEITU = "
					cQuery += " (SELECT "+cMaxMin+"(D.TP_DTLEITU) FROM "+RetSQLName("STP")+" D "
					cQuery += " WHERE D.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (D.TP_TIPOLAN='A' OR D.TP_TIPOLAN='I')"
					cQuery += " AND "+cDtQry+" AND D.D_E_L_E_T_ = ' ') "
					cQuery += " AND C.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' "
					cQuery += " AND (C.TP_TIPOLAN='I' OR C.TP_TIPOLAN='A') AND C.D_E_L_E_T_ = ' '))) AS KMPERC , "
					cQuery += " A.TP_CCUSTO"
					If lOper
						cQuery += ",E.TSZ_DESSER "
					EndIf
					cQuery += " FROM "+RetSQLName("STP")+" A" 
					If lOper
						cQuery += ","+RetSQLName(vCampoCC[1])+" D,"+RetSQLName("TSZ")+" E " 
					EndIf	
					cQuery += " WHERE SUBSTRING(A.TP_DTLEITU,1,6)='"+dDATAAT+"' AND A.TP_FILIAL='"+(cAliasQry)->TP_FILIAL+"' AND "
					cQuery += " A.D_E_L_E_T_ = ' ' AND "
					If lOper
						cQuery += " A.TP_CCUSTO=D."+vCampoCC[2]+"  AND D."+vCampoCC[3]+"=E.TSZ_CODSER AND "
						cQuery += " E.TSZ_DESSER='"+(cAliasQry)->TSZ_DESSER+"' AND D."+vCampoCC[2]+"='"+(cAliasQry)->TP_CCUSTO+"' AND "  
						cQuery += " D.D_E_L_E_T_ = ' ' AND E.D_E_L_E_T_ = ' ' AND "
					EndIf	
					cQuery += " A.TP_CODBEM='"+(cAliasQry)->TP_CODBEM+"' AND (a.TP_TIPOLAN='I' OR a.TP_TIPOLAN='A') "
					cQuery += "GROUP BY A.TP_FILIAL,A.TP_CODBEM,A.TP_CCUSTO "
					If lOper
						cQuery += ",E.TSZ_DESSER "
					EndIf	
					If lGroup 
						cQuery += ",A.TP_DTLEITU ORDER BY A.TP_FILIAL"
						If lOper
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					Else	                                                                  
						cQuery += "ORDER BY A.TP_FILIAL"
						If lOper
							cQuery += ",E.TSZ_DESSER"
						EndIf
						cQuery += ",KMPERC"	
					EndIf					 	      
				EndIf
				cQuery := ChangeQuery(cQuery)
				dbUseArea( .T., "TOPCONN", TCGENQRY(,,cQuery),cQry, .F., .T.)

				DbSelectArea(cQRY)
				While !Eof()
					lRes := .t.
					nKmPercB += (cQRY)->KmPerc
					DbSelectArea(cQRY)
					DbSkip()
				End 
				If lRes
					(cQRY)->( dbCloseArea() )  
				EndIf	
			EndIf	
			DbSelectArea(cALIASQRY)    
			If (cAliasQry)->KmPerc > 0 	
				nKmPercB += (cAliasQry)->KmPerc
			EndIf	
			If lOper
				cOperA   := (cAliasQry)->TSZ_DESSER
			EndIf	
			cFilA   := (cAliasQry)->TP_FILIAL  

			If lST6Tipo
				cTipoA   := (cAliasQry)->T6_TIPO1
			EndIf

			DbSelectArea(cALIASQRY)
			DbSkip()
		End 
		aAdd(aResumo,{cFilA,cOperA,nKmPercB,2,If(lST6Tipo,cTipoA,"")})
		nKmPercB := 0
	End	
	(cALIASQRY)->( dbCloseArea() )  




	For i:= 1 To Len(aResumo)

		IncProc(STR0023,STR0013) //"Aguarde..."###"Processando Registros..."

		If lOper
			DbSelectArea(cTRB)
			DbSetOrder(1)
			If !DbSeek(aResumo[i][2]+aResumo[i][1]+If(lST6Tipo, AllTrim(aResumo[i][5]),""))
				RecLock((cTRB), .T.) 
				(cTRB)->TIPSER := aResumo[i][2]
				(cTRB)->CODFL  := aResumo[i][1]

				DbSelectArea("SM0")  
				DbSetOrder(1)
				If DbSeek(SM0->M0_CODIGO+aResumo[i][1])
					(cTRB)->NMFL := SM0->M0_FILIAL
				EndIf 

				If aResumo[i][4] = 1 //cDATATQN = Mv_par03
					(cTRB)->KMAT  := aResumo[i][3] //+= nDIFCONT
				Else
					(cTRB)->KMANT := aResumo[i][3] //+= nDIFCONT
				EndIf

				If lST6Tipo
					(cTRB)->TIPO := AllTrim(aResumo[i][5])
				EndIf

				(cTRB)->(MsUnLock()) 
			Else
				RecLock((cTRB), .F.) 
				If aResumo[i][4] = 1
					(cTRB)->KMAT  := aResumo[i][3]
				Else
					(cTRB)->KMANT := aResumo[i][3]
				EndIf

				If lST6Tipo
					(cTRB)->TIPO := AllTrim(aResumo[i][5])
				EndiF

				(cTRB)->(MsUnLock()) 
			EndIf   
		Else
			DbSelectArea(cTRB)
			DbSetOrder(1)
			If !DbSeek(aResumo[i][1])
				RecLock((cTRB), .T.) 
				(cTRB)->TIPSER := aResumo[i][2]
				(cTRB)->CODFL  := aResumo[i][1]

				DbSelectArea("SM0")  
				DbSetOrder(1)
				If DbSeek(SM0->M0_CODIGO+aResumo[i][1])
					(cTRB)->NMFL := SM0->M0_FILIAL
				EndIf 

				If aResumo[i][4] = 1 //cDATATQN = Mv_par03
					(cTRB)->KMAT  := aResumo[i][3] //+= nDIFCONT
				Else
					(cTRB)->KMANT := aResumo[i][3] //+= nDIFCONT
				EndIf

				If lST6Tipo
					(cTRB)->TIPO := AllTrim(aResumo[i][5])
				EndIf

				(cTRB)->(MsUnLock())  
			Else
				RecLock((cTRB), .F.) 
				If aResumo[i][4] = 1
					(cTRB)->KMAT  := aResumo[i][3]
				Else
					(cTRB)->KMANT := aResumo[i][3]
				EndIf            

				If lST6Tipo
					(cTRB)->TIPO := AllTrim(aResumo[i][5])
				EndIf

				(cTRB)->(MsUnLock()) 
			EndIf   
		EndIf	    	    
	Next i

	DbselectArea(cTRB)
	DbGoTop()
	While !Eof()
		If (cTRB)->KMANT == 0
			(cTRB)->PERC  := 100
		Else	  
			(cTRB)->PERC  := (((cTRB)->KMAT /(cTRB)->KMANT)*100) 
		EndIf   
		DbSkip()
	End
Return .T. 

/*


Ŀ
Funo    MNR960PA   Autor Soraia de Carvalho      Data  10/01/06 
Ĵ
Descrio Reprocessa o browse de acordo com os parametros             
Ĵ
 Uso      MNTR960                                                     
ٱ


*/
Function MNR960PA()

	If !Pergunte("MNR960",.T.)
		Return
	EndIf 

	DbSelectArea(cTRB)
	Zap 

	Processa({ |lEnd| MNR960INI() }, STR0023,STR0018 )  //"Aguarde ..Processando Arquivo de Filiais"

	DbSelectArea(cTRB)
	DbGotop()

RETURN .T.
/*



Ŀ
Funo     MNTR60    Autor  Soraia de Carvalho     Data 29/06/2004
Ĵ
Descrio Relatorio de Abastecimento por Filiais                      
Ĵ
Tabelas   TQF - Estrutura Organizacional                              
          TQN - Usuarios.                                             
                                                                      
Ĵ
 Uso       SigaMNT                                                    
Ĵ 
         ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL.             
Ĵ
Programador  Data    F.O    Motivo da Alteracao                     
Ĵ
                                                                    
ٱ


/*/
Function MNR960IM()
	Local cString    := (cTRB)
	Local cDesc1     := STR0004+STR0019 //"Relatorio mensal de resumo de KM"###" percorrido por filial nas respectivas operaes."
	Local cDesc2     := "" 
	Local cDesc3     := ""
	Local wnRel      := "MNTR960"
	Private aReturn  := { STR0020, 1,STR0021 , 2, 2, 1, "",1 }     //"Administracao"###"Zebrado"
	Private nLastKey := 0
	Private Titulo   := STR0004 //"Relatorio mensal de resumo de KM"
	Private Tamanho  := "M"

	DbSelectArea("TQN")

	//Ŀ
	// Envia controle para a funcao SETPRINT     
	//

	DbSelectArea(cTRB)
	DbGotop()
	If Reccount() > 0
		wnRel := SetPrint(cString,wnRel, ,Titulo,cDesc1,cDesc2,cDesc3,.f.,"")
		If nLastKey = 27
			Set Filter To
			DbSelectArea(cTRB)
			Return
		Endif
		SetDefault(aReturn,cString)
		RptStatus({|lEnd| R960Imp(@lEnd,wnRel,Titulo,Tamanho)},Titulo)
	Else
		MsgInfo(STR0024,STR0025) //"Nao exite dados para imprimir o relatrio."###"ATENO"
	EndIf    

Return Nil

/*//*


Ŀ
Funo     R960IMP   Autor  Soraia de Carvalho     Data 29/06/2004
Ĵ
Descrio Chamada do Relatorio.                                       
Ĵ
 Uso       SigaMNT                                                    
Ĵ 
         ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL.             
Ĵ
Programador  Data    F.O    Motivo da Alteracao                     
Ĵ
                                                                    
ٱ


/*/

Static Function R960Imp(lEnd,wnRel,Titulo,Tamanho)
	Local cRodaTxt := ''
	Local nCntImpr := 0

	Private li := 80 ,m_pag := 1
	Private NomeProg := "MNTR960"
	Private Cabec1   := STR0026+cMESATUAL+"/"+SubStr(Mv_Par03,4,4) //"Ms de Referncia: "
	Private Cabec2   := STR0027+Space(If(lST6Tipo,14,10))+SubStr(cMESANTER,1,3)+"/"+StrZero(nAno,4) +"         "+  SubStr(cMESATUAL,1,3)+"/"+SubStr(Mv_Par03,4,4);//"Descrio        Cod.Filial"
	+STR0028 //"        %Rodado em rel. ao mes anterior"      

	Private cOPER    //CODIGO DA OPERACAO

	//Ŀ
	// Verifica se deve comprimir ou nao                            
	//
	nTipo  := IIf(aReturn[4]==1,15,18)

	//Ŀ
	// Monta os Cabecalhos                                          
	//
	/*/
	1         2         3         4         5         6         7         8         9         0         1         2         3         4         5
	0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
	*******************************************************************************************************************************************************
	Descrio        Cod.Filial              Anterior            Atual        %Rodado em rel. ao mes anterior   Ms de Ref.   Ms Anterior 
	*******************************************************************************************************************************************************
	xxxxxxxxxxxxxxxx     xx           999,999,999 ___  999,999,999 ___        999,999,999.999                xxxxxxxxxx    xxxxxxxxxx

	/*/                                                

	//Ŀ
	// Define o indice de leitura do arquivo                    
	//
	DbSelectArea(cTRB)
	DbSetOrder(02)               
	DbGoTop()
	SetRegua(LastRec())
	While !Eof()

		IncRegua()
		If lOper
			If (cTRB)->TIPSER <> cOPER  
				NgSomaLi(58)
				@ Li,000 PSay STR0022+": " //"Operao:"
				@ Li,010 PSay (cTRB)->TIPSER
				cOPER := (cTRB)->TIPSER
			EndIf 


			If (cTRB)->TIPSER = cOPER  //Imprime por operacao
				NgSomaLi(58)
				NgSomaLi(58)   	   

				@ Li,000 PSay Substr((cTRB)->NMFL,1,20)
				@ Li,025 PSay (cTRB)->CODFL
				@ Li,034 PSay (cTRB)->KMANT Picture "@E 999,999,999"
				If lST6Tipo
					@ Li,046 PSay (cTRB)->TIPO Picture "@!"
				EndIf
				@ Li,051 PSay (cTRB)->KMAT Picture "@E 999,999,999"
				If lST6Tipo
					@ Li,063 PSay (cTRB)->TIPO Picture "@!"
				EndIf
				@ Li,074 PSay (cTRB)->PERC Picture "@E 999,999,999.99" 
				NgSomaLi(58)	   	
			EndIf
		Else
			NgSomaLi(58)
			NgSomaLi(58)   	   
			@ Li,000 PSay Substr((cTRB)->NMFL,1,20)
			@ Li,025 PSay (cTRB)->CODFL
			@ Li,034 PSay (cTRB)->KMANT Picture "@E 999,999,999"
			If lST6Tipo
				@ Li,046 PSay (cTRB)->TIPO Picture "@!"
			EndIf
			@ Li,051 PSay (cTRB)->KMAT Picture "@E 999,999,999"
			If lST6Tipo
				@ Li,063 PSay (cTRB)->TIPO Picture "@!"
			EndIf
			@ Li,074 PSay (cTRB)->PERC Picture "@E 999,999,999.99" 
			NgSomaLi(58)	   		
		EndIf       
		DbSelectArea(cTRB)
		DbSkip()
	End	         

	Roda(nCntImpr,cRodaTxt,Tamanho)

	//Ŀ
	// Devolve a condicao original do arquivo principal             
	//
	RetIndex('TQN')

	Set Filter To

	Set device to Screen

	If aReturn[5] = 1
		Set Printer To
		dbCommitAll()
		OurSpool(wnrel)
	Endif
	MS_FLUSH()

Return NIL  

Function MNR960FL(nOpc)
	Local cVERFL

	cVERFL := Mv_Par01

	If Empty(mv_par01)
		Return .t.
	Else       
		If nOpc == 1
			lRet := IIf(Empty(Mv_Par01),.t.,ExistCpo('SM0',SM0->M0_CODIGO+Mv_par01))
			If !lRet
				Return .f.
			EndIf
		EndIf

		If nOpc == 2    
			lRet := IIf(ATECODIGO('SM0',SM0->M0_CODIGO+Mv_par01,SM0->M0_CODIGO+Mv_Par02,02),.T.,.F.)
			If !lRet
				Return .f.
			EndIf 
		EndIf   
	EndIf        

Return .t.

/*/


Ŀ
Funo     MenuDef   Autor  Rafael Diogo Richter   Data 02/02/2008
Ĵ
Descrio Utilizacao de Menu Funcional.                               
Ĵ
 Uso       SigaMNT                                                    
Ĵ
Retorno   Array com opcoes da rotina.                                 
Ĵ
ParametrosParametros do array a Rotina:                               
          1. Nome a aparecer no cabecalho                             
          2. Nome da Rotina associada                                 
          3. Reservado                                                
          4. Tipo de Transao a ser efetuada:                        
          		1 - Pesquisa e Posiciona em um Banco de Dados           
              2 - Simplesmente Mostra os Campos                       
              3 - Inclui registros no Bancos de Dados                 
              4 - Altera o registro corrente                          
              5 - Remove o registro corrente do Banco de Dados        
          5. Nivel de acesso                                          
          6. Habilita Menu Funcional                                  
Ĵ 
         ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL.             
Ĵ
Programador  Data    F.O    Motivo da Alteracao                     
Ĵ
                                                                    
ٱ


/*/
Static Function MenuDef()
	Local aRotina :=	{{STR0002 ,"MNR960PA" ,0,3,0},;   //"Parametros"
	{STR0003 ,"MNR960IM" ,0,3,0}}   //"Imprimir"

Return aRotina
