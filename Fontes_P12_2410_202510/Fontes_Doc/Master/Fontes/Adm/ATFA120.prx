#INCLUDE "ATFA120.CH"
#Include "PROTHEUS.CH"
#INCLUDE "FWLIBVERSION.CH"

#define smo_CODEMP			1	// SM0->M0_CODIGO
#define smo_CODFIL			2	// IIf( lFWCodFilSM0, FWGETCODFILIAL, SM0->M0_CODFIL )
#define smo_NOMEEMPRESA		6	// SM0->M0_NOME
#define smo_NOMEFILIAL		7	// SM0->M0_FILIAL

// 17/08/2009 - Ajuste para filiais com mais de 2 caracteres.
Static lFWCodFil := .T.
//********************************
// Controle de multiplas moedas  *
//********************************
Static lMultMoed := .T.
Static __lTabSld
Static __lPROVCTR

STATIC lIsRussia	:= If(cPaisLoc$"RUS",.T.,.F.) // CAZARINI - Flag to indicate if is Russia location	

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ ATFA120    ³ Autor ³ Wagner/Alice          ³ Data ³ 24/01/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Refaz o SN5                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAATF                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ATFA120(lDireto)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define Variaveis                                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Local aSays		:={}, aButtons:={}
Local aArea 	:= GetArea()
Local bBlock	:= Nil

Local oProcess as object
Local bProcess as codeblock
Local cDescription  := "" 		  as character
Local cFunction		:= "ATFA120"  as character
Local cPerg			:= "AFA120"	  as character
Local cLibLabel 	:= "20240520" as character
Local lLibSchedule	:= FwLibVersion() >= cLibLabel as logical
Local lSchedule     := FWGetRunSchedule() as logical
	
DEFAULT lDireto		:= .F.

Private cCadastro 	:= STR0001 // "Reprocessar Saldos"

Private aRotina 	:= MenuDef()
Private nTaxaDepr 	:= 0
Private dDataRef  	:= CTOD("  /  /  ")

nOpca := 0

/*
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Tratamento para tipo de Saldo³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
*/
If __lTabSld == Nil
	__lTabSld := .T.
EndIf

// Tratamento para ativos com a classificação de ativos de custo/provisão
If __lPROVCTR == Nil
	__lPROVCTR := AFXAtCsPrv()
EndIf

ATFXKERNEL()

If !lSchedule .And. (IsBlind() .Or. lDireto)
	BatchProcess( 	cCadastro, 	STR0006 + Chr(13) + Chr(10) +; // "Este programa tem o objetivo reconstruir o arquivo de saldos cont -"
										STR0007 + Chr(13) + Chr(10) +; // "beis. SINTETICO(atrav‚s dos cadastros de Bens(SN1+SN3) ou ANALITICO"
										STR0008 + Chr(13) + Chr(10) +; // "(SN4) atrav‚s do arquivo de movimenta‡”es."
										STR0009 + Chr(13) + Chr(10) +; // "Obs: Se for reconstru¡do atrav‚s dos Bens, ser„o gerados os saldos "
										STR0010 + Chr(13) + Chr(10) +; // "atualizados (Resumo) e se pela movimenta‡„o ser„o gerados com os   "
										STR0011, "AFA120",; 			  // "valores hist¢ricos (baixas,deprecia‡”es,etc)."
	{ || If(mv_par01 == 1,	Processa({|lEnd| AF120SN3()}),;
									Processa({|lEnd| AF120SN4()})) },;
 	{ || .F. })
	Return .T.
Endif

if !lLibSchedule
	Pergunte("AFA120",.F.)
	AADD(aSays,STR0006 ) // "Este programa tem o objetivo reconstruir o arquivo de saldos cont -"
	AADD(aSays,STR0007 ) // "beis. SINTETICO(atrav‚s dos cadastros de Bens(SN1+SN3) ou ANALITICO"
	AADD(aSays,STR0008 ) // "(SN4) atrav‚s do arquivo de movimenta‡”es."
	AADD(aSays,STR0009 ) // "Obs: Se for reconstru¡do atrav‚s dos Bens, ser„o gerados os saldos "
	AADD(aSays,STR0010 ) // "atualizados (Resumo) e se pela movimenta‡„o ser„o gerados com os   "
	AADD(aSays,STR0011 ) // "valores hist¢ricos (baixas,deprecia‡”es,etc)."

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicializa o log de processamento                            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	ProcLogIni( aButtons )

	AADD(aButtons, { 5,.T.,{|| Pergunte("AFA120",.T. ) } } )
	AADD(aButtons, { 1,.T.,{|| nOpca := 1,	IF( AtfOK(),FechaBatch(),nOpca := 0 ) }} )
	AADD(aButtons, { 2,.T.,{|| FechaBatch() }} )

	FormBatch( cCadastro, aSays, aButtons ,,,445)

	If nOpca == 1
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza o log de processamento   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		ProcLogAtu("INICIO")


		If mv_par01 == 1
			bBlock := {|| AF120SN3()}
		Else
			bBlock := {|| AF120SN4()}
		EndIF

		If MV_PAR03 == 1 .And. !Empty(xFilial("SN1"))// Seleciona filiais
			Processa({ |lEnd| Afa120Fil(MV_PAR04,MV_PAR05,bBlock) })
		Else
			Processa(bBlock)
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza o log de processamento   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		ProcLogAtu("FIM")

	Endif
else
	SetKey( VK_F12, { |a,b| AcessaPerg(cPerg,.T.) } )
	if !lSchedule
		Pergunte("AFA120",.F.)
	endif

	bProcess := { |oSelf| AF020Sched(oSelf) }

	cDescription := STR0005

	oProcess := tNewProcess():New(cFunction, cCadastro, bProcess, cDescription, cPerg,;
								  aSays                   		 /*aSays*/     	     ,;
								  .T.                            /*lPanelAux*/ 	     ,;
								  5                              /*nSizePanelAux*/   ,;
								  cDescription    				 /*cDescriAux*/      ,;
								  .T.                            /*lViewExecute*/    ,;
								  .F.                            /*lOneMeter*/       ,;
								  .T.                            /*lSchedAuto*/       )
endif

RestArea(aArea)

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ATFA120 ºAutor  ³Alvaro Camillo Neto º Data ³  21/09/09   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Executa o processamento para cada filial                    º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ ATFA120                                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function Afa120Fil(cFilDe,cFilAte,bBlock,oProcess)
Local cFilIni	:= cFIlAnt
Local aArea		:= GetArea()
Local nInc		:= 0
Local nPosIni	:= 0
Local aSM0		:= AdmAbreSM0()
Local cFilX		:= ""
Local lCheckObj as logical

lCheckObj := ValType(oProcess) == "O" .And. oProcess <> Nil

ProcLogAtu( "MENSAGEM" , STR0014 ) // "Iniciando o Processo"
If lCheckObj
	oProcess:SaveLog("MENSAGEM: "+STR0014)
EndIf
// Posiciona na primeira opcao do usuario
nPosIni := ASCAN(aSM0, {|E| E[smo_CODEMP] == cEmpAnt .and. E[smo_CODFIL] >= cFilDe })
If nposIni > 0
	For nInc := nPosIni To Len( aSM0 )
		If aSM0[nInc][smo_CODEMP] == cEmpAnt .AND. aSM0[nInc][smo_CODFIL] <= cFilAte
			cFilAnt := aSM0[nInc][2]
			If xFilial("SN1") != cFilX
				ProcLogAtu( "ALERTA" , STR0016  + cFilAnt) // "Executando o processo da filial: "
				If lCheckObj
					oProcess:SaveLog("ALERTA: "+STR0016  + cFilAnt)
				EndIf
				Eval( bBlock )
				cFilX := xFilial("SN1")
			EndIf
		EndIf
	Next
Else
	ProcLogAtu( "ALERTA" , STR0017 + cFilDe) // "Filial não encontrada!"
	If lCheckObj
		oProcess:SaveLog("ALERTA: "+STR0017 + cFilDe)
	EndIf
EndIf

If lCheckObj
	oProcess:SaveLog("MENSAGEM: "+STR0029) // "Finalizando o Processo"
EndIf

cFIlAnt := cFilIni
RestArea(aArea)
Return


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ AF120SN3   ³ Autor ³ Wagner/Alice          ³ Data ³ 27/01/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Recria o SN5                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA120                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF120SN3(oProcess as object)

Local cTipoImob
Local cTipoCorr        //Tipo de correcao do Bem
Local dUltDepr	:= SuperGetMV("MV_ULTDEPR")
Local cTipoBaixa
Local cAliasSN3 := "SN3"
Local cTipoGerenc := ATFXTpBem(2)
Local lCheckObj as logical
Local nRegua    as numeric

Local nCpoSelQ
Local aCpoSelQ
Local cTipSld := ""
Local cTipBem := ""
Local cCustProv := ""


//********************************
// Controle de multiplas moedas  *
//********************************
Local aValorMoed
Local dAntBase := dDataBase

// Verificação da classificação de Ativo se sofre depreciação
Local lAtClDepr := .F.

dDataBase := mv_par02

lCheckObj := ValType(oProcess) == "O" .And. oProcess <> Nil //Valida se foi chamado pela função AF120SN3 para tratar regua
nRegua 	  := 0

If !AF120ChkVir()
	dDataBase := dAntBase
	Return
EndIf
Af120Delete("SN5")		// Saldos da conta
Af120Delete("SN6")		// Item Contabil
Af120Delete("SNA")		// Classe de Valor
Af120Delete("SNC")		// Centro de custo

//Acerto dos campo N3_TPSALD
AF120TpSld()

AF120SN4( .T. /*lSldInicial*/, .F. /*lMovimento*/ )	// Geracao dos Saldos Iniciais

cAliasSN3 := "SN3QRY"
cQrySN3 := " SELECT * FROM "+RetSqlName("SN3")+" SN3QRY "
cQrySN3 += " WHERE N3_FILIAL = '" + xFilial("SN3") + "'"

If Year( dUltDepr ) == Year( dDataRef )
	cQrySN3 += " AND (N3_BAIXA < '1' OR  N3_DTBAIXA LIKE '"+Str(Year(dUltDepr),4)+"%') "
Else
	cQrySN3 += " AND (N3_BAIXA < '1') "
EndIf

cQrySN3 += " AND D_E_L_E_T_ = ' ' "
cQrySN3 += " ORDER BY N3_FILIAL,N3_CBASE,N3_ITEM,N3_TIPO,N3_BAIXA,N3_SEQ,R_E_C_N_O_ "

cQrySN3 := ChangeQuery(cQrySN3)

If Select(cAliasSN3) > 0
	dbSelectArea(cAliasSN3)
	dbCloseArea()
Endif
dbUseArea(.T., "TOPCONN", TCGenQry(,,cQrySN3), cAliasSN3, .F., .T.)
dbSelectArea("SN3")
aCpoSelQ := dbStruct()
dbSelectArea(cAliasSN3)
SX3->(DbSetOrder(2))
For nCpoSelQ := 1 To Len(aCpoSelQ)
	If ValType(aCpoSelQ[nCpoSelQ]) == "A"
		If aCpoSelQ[nCpoSelQ][2] <> "C"
			TCSetField(cAliasSN3, 	aCpoSelQ[nCpoSelQ][1], aCpoSelQ[nCpoSelQ][2], aCpoSelQ[nCpoSelQ][3], aCpoSelQ[nCpoSelQ][4])
		Endif
	ElseIf SX3->(DbSeek(aCpoSelQ[nCpoSelQ])) .And. SX3->X3_TIPO <> "C" .And. SX3->X3_TIPO <> "M"
		TCSetField(cAliasSN3, 	SX3->X3_CAMPO, SX3->X3_TIPO,SX3->X3_TAMANHO, SX3->X3_DECIMAL)
	Endif
Next

Count to nRegua 
(cAliasSN3)->(dbGoTop())

If lCheckObj
	oProcess:SetRegua1(nRegua)
EndIf


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Inicia a leitura do SN3                                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

While !Eof()

	IncProc()

	If lCheckObj
		oProcess:IncRegua1()
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Posiciona no SN1                                                    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SN1")
	dbSeek(xFilial()+(cAliasSN3)->N3_CBASE+(cAliasSN3)->N3_ITEM)
	dbSelectArea(cAliasSN3)

	// Verificação da classificação de Ativo se sofre depreciação
	lAtClDepr := AtClssVer(SN1->N1_PATRIM )
	If cPaisLoc <> "COL"
		If lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
			cTipoImob := "1"
			cTipoBaixa:= "5"
			cTipoCorr := "6"
		Elseif SN1->N1_PATRIM $ "CAS"
			cTipoImob := "A"
			cTipoBaixa:= "C"
			cTipoCorr := "O"
		Else
			cTipoImob := "B"
			cTipoBaixa:= "D"
			cTipoCorr := "6"
		Endif
	EndIf

	If __lTabSld
		cTipSld := (cAliasSN3)->N3_TPSALDO
		cTipBem := (cAliasSN3)->N3_TIPO
	EndIf

	If __lPROVCTR
		cCustProv := (cAliasSN3)->N3_ATFCPR
	EndIf

	If YEAR( SN1->N1_AQUISIC ) == YEAR( dDataBase )

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Imobiliza‡„o. Conta do Bem                             ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			aValorMoed := AtfMultMoe(,, {|x| (cAliasSN3)->(&("N3_VORIG"+Alltrim(Str(x))) + &(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x)) ) ) } )
		EndIf
		If cPaisLoc == "COL"
			// Verificação da classificação de Ativo se sofre depreciação
			lAtClDepr := AtClssVer(SN1->N1_PATRIM )
			cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"5","D"))
			cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"6","6"))
			cTipoBaixa:= IIF(SN1->N1_PATRIM $ "CAS","5",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"C","D"))
		EndIf

		AtfSaldo(	(cAliasSN3)->N3_CCONTAB,dDataRef,cTipoImob,;
		(cAliasSN3)->(N3_VORIG1+N3_AMPLIA1),(cAliasSN3)->(N3_VORIG2+N3_AMPLIA2),(cAliasSN3)->(N3_VORIG3+N3_AMPLIA3),;
		(cAliasSN3)->(N3_VORIG4+N3_AMPLIA4),(cAliasSN3)->(N3_VORIG5+N3_AMPLIA5),"+",nTaxaDepr,;
		(cAliasSN3)->N3_SUBCCON,, (cAliasSN3)->N3_CLVLCON,(cAliasSN3)->N3_CUSTBEM,"1", aValorMoed,cTipSld,,cTipBem,cCustProv )

	Endif

	If Val((cAliasSN3)->N3_BAIXA) = 0 .and. If( EMPTY( (cAliasSN3)->N3_FIMDEPR ), .T., YEAR((cAliasSN3)->N3_FIMDEPR) == YEAR(dDataBase) )

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ No raz„o soma-se a corre‡„o do bem a conta do bem, no RAZAO.      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCACM1 != 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| if(x=1,(cAliasSN3)->N3_VRCACM1,0) })
			EndIf
			If cPaisLoc == "COL"
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer(SN1->N1_PATRIM )
				cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"5","D"))
				cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"6","6"))
				cTipoBaixa:= IIF(SN1->N1_PATRIM $ "CAS","5",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"C","D"))
			EndIf
			AtfSaldo(	(cAliasSN3)->N3_CCONTAB,dDataRef,cTipoCorr,;
			(cAliasSN3)->N3_VRCACM1 ,0 ,0 ,0 ,0 ,"+", nTaxaDepr,;
			(cAliasSN3)->N3_SUBCCON,, (cAliasSN3)->N3_CLVLCON,(cAliasSN3)->N3_CUSTBEM,"1", aValorMoed,cTipSld,,cTipBem,cCustProv )
		Endif

		// Verificação da classificação de Ativo se sofre depreciação
		lAtClDepr := AtClssVer(SN1->N1_PATRIM )

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a conta de Despesa de Depreciacao  o total de deprecia-³
		//³ cao acumulada no exercicio.                                       ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)) .and. (cAliasSN3)->N3_VRDBAL1 != 0  .And. Year(dDataRef) = Year(dUltDepr)

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(cAliasSN3,"N3_VRDBAL")
			EndIf

			If (cAliasSN3)->N3_TIPO $ cTipoGerenc
				cTipoImob := "Y" // Depreciacao Gerencial
			ElseIf (cAliasSN3)->N3_TIPO =="09"
				cTipoImob := "L" // Depreciacao Incentivada Negativa
			ElseIf (cAliasSN3)->N3_TIPO =="08"
				cTipoImob := "K" // Depreciacao Incentivada Positiva
			Else
				cTipoImob := "4"
			EndIf

			AtfSaldo(	(cAliasSN3)->N3_CDEPREC,dDataRef,cTipoImob,;
			(cAliasSN3)->N3_VRDBAL1 ,(cAliasSN3)->N3_VRDBAL2,(cAliasSN3)->N3_VRDBAL3,;
			(cAliasSN3)->N3_VRDBAL4 ,(cAliasSN3)->N3_VRDBAL5 ,"+", nTaxaDepr,;
			(cAliasSN3)->N3_SUBCDEP,, (cAliasSN3)->N3_CLVLDEP,(cAliasSN3)->N3_CCDESP,"3" , aValorMoed,cTipSld,,cTipBem,cCustProv )


			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(cAliasSN3,"N3_VRDBAL")
			EndIf


			AtfSaldo(	(cAliasSN3)->N3_CCDEPR,dDataRef,cTipoImob,;
			(cAliasSN3)->N3_VRDBAL1,(cAliasSN3)->N3_VRDBAL2,(cAliasSN3)->N3_VRDBAL3,;
			(cAliasSN3)->N3_VRDBAL4 ,(cAliasSN3)->N3_VRDBAL5 ,"+", nTaxaDepr,;
			(cAliasSN3)->N3_SUBCCDE,,(cAliasSN3)->N3_CLVLCDE,(cAliasSN3)->N3_CCCDEP,"4", aValorMoed,cTipSld,,cTipBem,cCustProv )

		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Correcao da Deprecia‡„o                                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCDB1 != 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| If(x=1,(cAliasSN3)->N3_VRCDB1,0) })
			EndIf
			cTipoCorr := "7"
			AtfSaldo(	(cAliasSN3)->N3_CDESP,dDataRef,cTipoCorr,(cAliasSN3)->N3_VRCDB1,0,0,0,0,"+",;
			nTaxaDepr,(cAliasSN3)->N3_SUBCDES,, (cAliasSN3)->N3_CLVLDES, (cAliasSN3)->N3_CCCDES,"5", aValorMoed,cTipSld,,cTipBem,cCustProv )
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Soma a Corre‡„o da depreciacao acumulada na conta de depr acum.   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCDA1 != 0
			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| If(x=1,(cAliasSN3)->N3_VRCDA1,0) })
			EndIf
			cTipoCorr := "6"
			AtfSaldo(	(cAliasSN3)->N3_CCDEPR,dDataRef,cTipoCorr, (cAliasSN3)->N3_VRCDA1,0,0,0,0 ,;
			"+",nTaxaDepr,(cAliasSN3)->N3_SUBCCDE,, N3_CLVLCDE, (cAliasSN3)->N3_CCCDEP,"4", aValorMoed,cTipSld,,cTipBem,cCustProv )
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Corre‡„o                                               ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCBAL1 != 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| If(x=1,(cAliasSN3)->N3_VRCBAL1,0) })
			EndIf

			If cPaisLoc == "COL"
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer(SN1->N1_PATRIM)
				cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"5","D"))
				cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"6","6"))
				cTipoBaixa:= IIF(SN1->N1_PATRIM $ "CAS","5",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"C","D"))
			EndIf

			AtfSaldo(	(cAliasSN3)->N3_CCORREC,dDataRef,cTipoCorr,;
			(cAliasSN3)->N3_VRCBAL1,0,0,0,0,"+", nTaxaDepr,(cAliasSN3)->N3_SUBCCOR,,;
			(cAliasSN3)->N3_CLVLCOR,(cAliasSN3)->N3_CCCORR,"2", aValorMoed,cTipSld,,cTipBem,cCustProv )
		Endif

	ElseIf Year((cAliasSN3)->N3_DTBAIXA) = Year(dUltDepr) .And. (Year(dUltDepr) = Year(dDataRef))
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Trago os valores das baixas nas contas que sÆo zeradas no exerc¡- ³
		//³ cio (N3_CDEPREC, N3_CDESP, N3_CORREC) se baixas ocorreram no exer-³
		//³ c¡cio corrente E a data de rec lculo for no exercicio corrente.   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ


		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a baixa da Imobiliza‡„o. Conta do Bem                    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			aValorMoed := AtfMultMoe(,, {|x| (cAliasSN3)->(&("N3_VORIG"+Alltrim(Str(x))) + &(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x)) ) ) } )
		EndIf
		If cPaisLoc == "COL"
			// Verificação da classificação de Ativo se sofre depreciação
			lAtClDepr := AtClssVer(SN1->N1_PATRIM)
			cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"5","D"))
			cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"6","6"))
			cTipoBaixa:= IIF(SN1->N1_PATRIM $ "CAS","5",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"C","D"))
		EndIf

		AtfSaldo(	(cAliasSN3)->N3_CCONTAB,dDataRef,cTipoImob,;
		(cAliasSN3)->(N3_VORIG1+N3_AMPLIA1),;
		(cAliasSN3)->(N3_VORIG2+N3_AMPLIA2),;
		(cAliasSN3)->(N3_VORIG3+N3_AMPLIA3),;
		(cAliasSN3)->(N3_VORIG4+N3_AMPLIA4),;
		(cAliasSN3)->(N3_VORIG5+N3_AMPLIA5),"-",nTaxaDepr,;
		(cAliasSN3)->N3_SUBCCON,, (cAliasSN3)->N3_CLVLCON,(cAliasSN3)->N3_CUSTBEM,"1", aValorMoed,cTipSld,,cTipBem,cCustProv )

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a conta de Despesa de Deprecia‡„o. E o total de deprecia-³
		//³ cao acumulado no exercicio. Mesmo que o bem tenha sido baixado no ³
		//³ exercicio a sua depreciacao devera ser somada na cta de Desp.Depr.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)) .and. (cAliasSN3)->N3_VRDBAL1 != 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(cAliasSN3,"N3_VRDBAL")
			EndIf

			If cPaisLoc == "COL"
				cTipoImob := If( !SN3->N3_TIPO $ ("08,09,10,12,50,51,52,53,54" + cTypesNM), "4", If(SN3->N3_TIPO $ ("10,12,50,51,52,53,54" + cTypesNM),"Y",If(SN3->N3_TIPO=="09","L","K")))
			Else
				cTipoImob := "4"
			EndIf

			AtfSaldo(	(cAliasSN3)->N3_CDEPREC,dDataRef,cTipoImob,;
			(cAliasSN3)->N3_VRDBAL1,;
			(cAliasSN3)->N3_VRDBAL2,;
			(cAliasSN3)->N3_VRDBAL3,;
			(cAliasSN3)->N3_VRDBAL4,;
			(cAliasSN3)->N3_VRDBAL5,"+", nTaxaDepr,;
			(cAliasSN3)->N3_SUBCDEP,, (cAliasSN3)->N3_CLVLDEP,(cAliasSN3)->N3_CCDESP,"3", aValorMoed,cTipSld,,cTipBem,cCustProv )

			If lMultMoed
				aValorMoed := AtfMultMoe(,, {|x| (cAliasSN3)->(&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)) )  ) } )
				//aValorMoed := AtfMultMoe(,, {|x| (cAliasSN3)->(&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)) ) - &(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)) )  ) } )
			EndIf

		End

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Correcao da Deprecia‡„o                                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCDB1 != 0


			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| If(x=1,(cAliasSN3)->N3_VRCDB1,0) })
			Endif
			cTipoCorr := "7"
			AtfSaldo(	(cAliasSN3)->N3_CDESP,dDataRef,cTipoCorr,(cAliasSN3)->N3_VRCDB1,0,0,0,0,"+",;
			nTaxaDepr,(cAliasSN3)->N3_SUBCDES,, (cAliasSN3)->N3_CLVLDES, (cAliasSN3)->N3_CCCDES,"5", aValorMoed,cTipSld,,cTipBem,cCustProv )
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Corre‡„o                                               ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasSN3)->N3_VRCBAL1 != 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| If(x=1,(cAliasSN3)->N3_VRCBAL1,0) })
			EndIf

			If cPaisLoc == "COL"
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer(SN1->N1_PATRIM)
				cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"5","D"))
				cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"6","6"))
				cTipoBaixa:= IIF(SN1->N1_PATRIM $ "CAS","5",IIF(lAtClDepr .OR. EMPTY(SN1->N1_PATRIM),"C","D"))
			EndIf

			AtfSaldo(	(cAliasSN3)->N3_CCORREC,dDataRef,cTipoCorr,;
			(cAliasSN3)->N3_VRCBAL1,0,0,0,0,"+",nTaxaDepr,(cAliasSN3)->N3_SUBCCOR,,;
			(cAliasSN3)->N3_CLVLCOR,(cAliasSN3)->N3_CCCORR,"2", aValorMoed,cTipSld,,cTipBem,cCustProv )
		Endif
	Endif

	dbSelectArea(cAliasSN3)
	dbSkip()
End

MsUnlockAll()

dbSelectArea(cAliasSN3)
SET FILTER TO

dDataBase := dAntBase
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ AF120SN4   ³ Autor ³ Wagner/Alice          ³ Data ³ 27/01/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Recria o SN5                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA120                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF120SN4( lSldInicial, lMovimento, oProcess )
Local nTaxaDepr
Local cAno
Local dDataRef
Local cAliasQry := "SN4", cAliasSn1 := "SN1"
Local nFator 	:= 1
Local cTipSld  := ""
Local cTipBem  := ""
Local cCustProv:= ""
//********************************
// Controle de multiplas moedas  *
//********************************
Local aValorMoed
Local lSldAtf 	:= GetNewPar("MV_ATFRSLD",.F.)
Local bSldIni  := {||.T.}
Local bSldMov  := {||.T.}
Local cMotivo  := "  "

// Verificação da classificação de Ativo se sofre depreciação
Local lAtClDepr := .F.

Local lCheckObj as logical
Local lAF120SN3 as logical
Local nRegua 	as numeric

Default lSldInicial		:= .T.
Default lMovimento		:= .T.

//se tem o parametro MV_ATFRSLD (REFAZ SALDO) CONFIGURADO COM .T. e controla data de virada
If lSldAtf
	If ! AF120ChkVir()
		Return
	EndIf
EndIf

lCheckObj := ValType(oProcess) == "O" .And. oProcess <> Nil 
lAF120SN3 := FWIsInCallStack("AF120SN3") //Valida se foi chamado pela função AF120SN3 para tratar regua
nRegua 	  := 0

Af120Delete("SN5")		// Saldos da conta
Af120Delete("SN6")		// Item Contabil
Af120Delete("SNA")		// Classe de Valor
Af120Delete("SNC")		// Centro de custo

//Acerto dos campo N3_TPSALD
AF120TpSld()

cAno 		:= Right(Str(Year(dDataBase)),2)
dDataRef 	:="01/01/"+cAno

//Blocos condicionais para processamento do saldo inicial e dos movimentos
bSldIni  :=  {|| (cAliasQry)->N4_TIPOCNT != '3' }  //NO SALDO INICIAL NAO CONSIDERA CONTA DE DESPESAS DEPRECIACAO
bSldMov  :=  {|| Year((cAliasQry)->N4_DATA) == Year(dDataBase) .And. (cAliasQry)->N4_DATA <= dDataBase } //SOMENTE MOV DO ANO E MENOR Q DATABASE

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Calcula os Saldos iniciais das contas do Bem e de Deprec. Acumulada    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

cAliasQry := "SELECT N4_FILIAL, N4_DATA, N4_CONTA, N4_SUBCTA, N4_OCORR, N4_TIPO, N4_TIPOCNT, N1_PATRIM, N4_TXMEDIA, N4_CLVL, N4_CCUSTO,N4_MOTIVO"
If __lTabSld
	cAliasQry +=",N4_TPSALDO "
EndIf

//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	AtfMultMoe(,,{|x| cAliasQry += ", SUM(N4_VLROC" + Alltrim(Str(x)) + ") N4_VLROC" + Alltrim(Str(x)) })
Else
	cAliasQry += ", SUM(N4_VLROC1) N4_VLROC1, SUM(N4_VLROC2) N4_VLROC2, SUM(N4_VLROC3) N4_VLROC3, SUM(N4_VLROC4) N4_VLROC4, SUM(N4_VLROC5) N4_VLROC5"
EndIf

cAliasQry += " FROM "+RetSqlName("SN4")+" SN4, "+RetSqlName("SN1") + " SN1"
cAliasQry += " WHERE N4_FILIAL='"+xFilial("SN4")+"'"
cAliasQry += " AND SN4.D_E_L_E_T_ <> '*' AND SN1.D_E_L_E_T_ <> '*'"
cAliasQry += " AND N4_FILIAL = SN1.N1_FILIAL"
cAliasQry += " AND N4_CBASE = SN1.N1_CBASE AND N4_ITEM = SN1.N1_ITEM"
cAliasQry += " GROUP BY N4_FILIAL,N4_DATA, N4_CONTA, N4_SUBCTA, N4_OCORR, N4_TIPO, N4_TIPOCNT, N4_TXMEDIA, N1_PATRIM, N4_CLVL, N4_CCUSTO,N4_MOTIVO"
If __lTabSld
	cAliasQry +=",N4_TPSALDO "
EndIf

cAliasQry := ChangeQuery(cAliasQry)

dbUseArea(.T.,"TOPCONN",TcGenQry(,,cAliasQry),"QRYSN4",.T.,.F.)

TcSetField("QRYSN4", "N4_DATA", "D", 8, 0)
TcSetField("QRYSN4", "N4_TXMEDIA", "N", TamSx3("N4_TXMEDIA")[1], TamSx3("N4_TXMEDIA")[2])
cAliasQry := "QRYSN4"
cAliasSn1 := "QRYSN4"

Count to nRegua 
(cAliasQry)->(dbGoTop())

If lCheckObj .And. !lAF120SN3
	oProcess:SetRegua1(nRegua)
EndIf

While !Eof() .and. N4_FILIAL == xFilial("SN4")

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Movimenta a regua                                                   ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IncProc()

	If lCheckObj .And. !lAF120SN3
		oProcess:IncRegua1()
	EndIf

	If __lTabSld
		cTipSld := (cAliasQry)->N4_TPSALDO
		cTipBem := (cAliasQry)->N4_TIPO
	EndIf

	If __lPROVCTR
		cCustProv := AF120CProv(SN4->N4_CBASE,SN4->N4_ITEM,(cAliasQry)->N4_TIPO,cTipSld)
	EndIf

	nTaxaDepr := (cAliasQry)->N4_TXMEDIA
	cMotivo := (cAliasQry)->N4_MOTIVO

	// Gera Saldo Iniciai por Conta Contabil, exceto para conta despesas de depreciacao, pois estas contas sao zeradas na virada anual
	If lSldInicial .and. ( Year((cAliasQry)->N4_DATA) < Year(dDataBase) ) .And. Eval(bSldIni)
		nFator := 1
		If (cAliasSn1)->N1_PATRIM $ "S"
			nFator := -1
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Se for implantacao (N4_OCORR = "05") ou Correcao do bem (N4_OCORR ³
		//³ = "07" atualizo a conta do bem (N3_CCONTAB).                      ³
		//³ Incluido tratamento para transferencia N4_OCORR = "03" ou "04     ³
		//³ Incluido tratamento para inventario                               ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cAliasQry)->N4_OCORR == "01"
			// Verificação da classificação de Ativo se sofre depreciação
			lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
			If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM)

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					aValorMoed := AtfMultMoe(,,{|x| -(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
				EndIf
				AtfSaldo(	(cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",;
				-(cAliasQry)->N4_VLROC1,;
				-(cAliasQry)->N4_VLROC2,;
				-(cAliasQry)->N4_VLROC3,;
				-(cAliasQry)->N4_VLROC4,;
				-(cAliasQry)->N4_VLROC5,;
				"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,(cAliasQry)->N4_CLVL,;
				(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem ,cCustProv)

			Else

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					aValorMoed := AtfMultMoe(cAliasQry,"N4_VLROC")
				EndIf
				AtfSaldo(	(cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",;
				(cAliasQry)->N4_VLROC1,;
				(cAliasQry)->N4_VLROC2,;
				(cAliasQry)->N4_VLROC3,;
				(cAliasQry)->N4_VLROC4,;
				(cAliasQry)->N4_VLROC5,;
				"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
				(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )

			Endif
		ElseIf (cAliasQry)->N4_OCORR $ "03,15"
			// Verificação da classificação de Ativo se sofre depreciação
			lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
			If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM)

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					aValorMoed := AtfMultMoe(,,{|x| -(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
				EndIf
				AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",-(cAliasQry)->N4_VLROC1,;
				-(cAliasQry)->N4_VLROC2,-(cAliasQry)->N4_VLROC3,-(cAliasQry)->N4_VLROC4,;
				-(cAliasQry)->N4_VLROC5,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
				(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv,(cAliasQry)->N4_OCORR)
			Else

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					aValorMoed := AtfMultMoe(cAliasQry,"N4_VLROC")
				EndIf
				AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(cAliasQry)->N4_VLROC1,;
				(cAliasQry)->N4_VLROC2,(cAliasQry)->N4_VLROC3,(cAliasQry)->N4_VLROC4,;
				(cAliasQry)->N4_VLROC5,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
				(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )
			Endif
		ElseIf (cAliasQry)->N4_OCORR $ "04,16"
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza Saldos Cont beis.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| (nFator)*(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
			EndIf
			AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(nFator)*(cAliasQry)->N4_VLROC1,;
			(nFator)*(cAliasQry)->N4_VLROC2 ,(nFator)*(cAliasQry)->N4_VLROC3,(nFator)*(cAliasQry)->N4_VLROC4,;
			(nFator)*(cAliasQry)->N4_VLROC5 ,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
			(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )

		ElseIf (cAliasQry)->N4_OCORR $ "05,09,13" .Or.;
			((cAliasQry)->N4_OCORR $ "06;20" .And. (cAliasQry)->N4_TIPOCNT $ "3|4") .Or.;
			((cAliasQry)->N4_OCORR = "07" .And. (cAliasQry)->N4_TIPOCNT = "1") .Or.;
			((cAliasQry)->N4_OCORR = "08" .And. (cAliasQry)->N4_TIPOCNT = "4")
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza Saldos Cont beis.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| (nFator)*(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
			EndIf
			AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(nFator)*(cAliasQry)->N4_VLROC1,;
			(nFator)*(cAliasQry)->N4_VLROC2 ,(nFator)*(cAliasQry)->N4_VLROC3,(nFator)*(cAliasQry)->N4_VLROC4,;
			(nFator)*(cAliasQry)->N4_VLROC5 ,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
			(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )
			// TRATAMENTO ESPECIFICO PARA TIPO 07 - DEPRECIACAO ACUMULADA
		ElseIf (cAliasQry)->N4_TIPO == "07" .AND. (cAliasQry)->N4_OCORR == "10" .And. ;
			(cAliasQry)->N4_TIPOCNT = "4"

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza Saldos Cont beis.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| (nFator)*(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
			EndIf
			AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(nFator)*(cAliasQry)->N4_VLROC1,;
			(nFator)*(cAliasQry)->N4_VLROC2 ,(nFator)*(cAliasQry)->N4_VLROC3,(nFator)*(cAliasQry)->N4_VLROC4,;
			(nFator)*(cAliasQry)->N4_VLROC5 ,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
			(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )

			// TRATAMENTO ESPECIFICO PARA TIPOS 08/09 - DEPRECIACAO ACUMULADA
		ElseIf (cAliasQry)->N4_TIPO $ "08/09" .AND. (cAliasQry)->N4_OCORR $ "11/12" .And. ;
			(cAliasQry)->N4_TIPOCNT = "4"

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza Saldos Cont beis.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IF (cAliasQry)->N4_TIPO == "08"
				nFator := 1
				cSinal := "+"
			ELSE
				nFator := -1
				cSinal := "-"
			ENDIF

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| (nFator)*(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
			Endif
			AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(nFator)*(cAliasQry)->N4_VLROC1,;
			(nFator)*(cAliasQry)->N4_VLROC2 ,(nFator)*(cAliasQry)->N4_VLROC3,(nFator)*(cAliasQry)->N4_VLROC4,;
			(nFator)*(cAliasQry)->N4_VLROC5 ,cSinal,nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
			(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )

			// TRATAMENTO ESPECIFICO PARA TIPOS 08/09 - DESPESA DE DEPRECIACAO
		ElseIf (cAliasQry)->N4_TIPO $ "08/09" .AND. (cAliasQry)->N4_OCORR $ "11/12" .And. ;
			(cAliasQry)->N4_TIPOCNT = "3"

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza Saldos Cont beis.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMoed := AtfMultMoe(,,{|x| (nFator)*(cAliasQry)->&("N4_VLROC" + Alltrim(Str(x))) })
			EndIf
			AtfSaldo((cAliasQry)->N4_CONTA,CTOD(dDataRef),"0",(nFator)*(cAliasQry)->N4_VLROC1,;
			(nFator)*(cAliasQry)->N4_VLROC2 ,(nFator)*(cAliasQry)->N4_VLROC3,(nFator)*(cAliasQry)->N4_VLROC4,;
			(nFator)*(cAliasQry)->N4_VLROC5 ,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
			(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,, aValorMoed,cTipSld,(cAliasQry)->N4_MOTIVO,cTipBem,cCustProv  )
		Endif

	// Gera Movimento do Exercicio
	ElseIf	lMovimento .And. Eval(bSldMov)
		Do Case
			Case (cAliasQry)->N4_OCORR == "01"        // Baixa
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM) // Bem Normal
					cCodSn5 := "5"
				Elseif (cAliasSn1)->N1_PATRIM $ "CAS" // Bem Patrimonial
					cCodSn5 := "C"
				Else
					cCodSn5 := "D"           // Patrimonial Prejuizo
				End
			Case (cAliasQry)->N4_OCORR == "03"        // Transferencia DE
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM) // Bem Normal
					cCodSn5 := "8"
				Elseif (cAliasSn1)->N1_PATRIM $ "CAS" // Bem Patrimonial
					cCodSn5 := "G"
				Else
					cCodSn5 := "H"           // Patrimonial Prejuizo
				End
			Case (cAliasQry)->N4_OCORR == "04"        // Transferencia DE
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM) // Bem Normal
					cCodSn5 := "9"
				Elseif (cAliasSn1)->N1_PATRIM $ "CAS" // Bem Patrimonial
					cCodSn5 := "I"
				Else
					cCodSn5 := "J"           // Patrimonial Prejuizo
				End
			Case (cAliasQry)->N4_OCORR == "05"        // Aquisi‡„o
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM) // Bem Normal
					If (cAliasQry)->N4_TIPO $ "02#05" // Reavaliacao
						cCodSn5 := "3"
					Else
						cCodSn5 := "1"
					Endif
				Elseif (cAliasSn1)->N1_PATRIM $ "CAS" // Bem Patrimonial
					cCodSn5 := "A"
				Else
					cCodSn5 := "B"           // Patrimonial Prejuizo
				End
			Case (cAliasQry)->N4_OCORR == "06"        // Deprecia‡„o
				cCodSn5 := "4"
			Case (cAliasQry)->N4_OCORR == "07"        // Corre‡„o do bem
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM)
					cCodSn5 := "6"
				Else
					cCodSn5 := "O"
				EndIf
			Case (cAliasQry)->N4_OCORR == "08"        // Corre‡„o
				cCodSn5 := "7"
			Case (cAliasQry)->N4_OCORR == "09"        // Amplia‡„o
				// Verificação da classificação de Ativo se sofre depreciação
				lAtClDepr := AtClssVer((cAliasSn1)->N1_PATRIM)
				If lAtClDepr .OR. EMPTY((cAliasSn1)->N1_PATRIM)    // Bem Normal
					cCodSn5 := "2"
				Elseif (cAliasSn1)->N1_PATRIM $ "CAS" // Bem Patrimonial
					cCodSn5 := "E"
				Else
					cCodSn5 := "F"           // Patrimonial Prejuizo
				End
			Case (cAliasQry)->N4_TIPO $ "07" .AND. (cAliasQry)->N4_OCORR $ "10"  // Depreciacao Acelerada
				cCodSn5 := "4"
			Case (cAliasQry)->N4_TIPO $ "08" .AND. (cAliasQry)->N4_OCORR $ "12"  // Aceleração Positiva
				cCodSn5 := "K"
			Case (cAliasQry)->N4_OCORR == "11" // Aceleracao Negativa
				cCodSn5 := "L"
			Case (cAliasQry)->N4_OCORR == "13"
				cCodSn5 := "P"
			Case (cAliasQry)->N4_OCORR == "15"
				cCodSn5 := "R"
			Case (cAliasQry)->N4_OCORR == "16"
				cCodSn5 := "Q"
			Case (cAliasQry)->N4_OCORR == "20"
				cCodSn5	:= "Y"
			OtherWise
				cCodSn5 := "1"
		EndCase

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza Saldos Cont beis.                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			aValorMoed := AtfMultMoe(cAliasQry,"N4_VLROC")
		Endif
		AtfSaldo((cAliasQry)->N4_CONTA,(cAliasQry)->N4_DATA,cCodSn5,(cAliasQry)->N4_VLROC1,;
		(cAliasQry)->N4_VLROC2 ,(cAliasQry)->N4_VLROC3 ,(cAliasQry)->N4_VLROC4,;
		(cAliasQry)->N4_VLROC5 ,"+",nTaxaDepr,(cAliasQry)->N4_SUBCTA,,;
		(cAliasQry)->N4_CLVL,(cAliasQry)->N4_CCUSTO,(cAliasQry)->N4_TIPOCNT, aValorMoed,cTipSld,cMotivo,cTipBem,cCustProv  )

	Endif
	dbSelectArea(cAliasQry)
	dbSkip()
End

MsUnlockAll()

If cAliasQry <> "SN4"
	DbSelectArea(cAliasQry)
	DbCloseArea()
	DbSelectArea("SN4")
	DbSetOrder(1)
Endif

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ AtfOk    ³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 01.12.95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Mensagem e confirmacao do processamento                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AtfOk(void)                                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static function AtfOk()
Return(Af120moeda())

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³Af120Moeda³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 01.12.95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Verifica se existe moeda cadastrada na data referente      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³                                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Af120moeda()
Local cOldArea := Alias()
Local lRet := .T.
Private cAtfMoeda := GETMV("MV_ATFMOED")
dDataref := mv_par02
dbSelectArea("SM2")
dbSeek(dDataRef)
If !Found()
	HELP(" ", 1 , "PESQ01") //Verificar este Help
	lRet := .F.
Else
	nTaxaDepr := &('SM2->M2_MOEDA'+cAtfMoeda)
End
dbSelectArea(cOldArea)

Return lRet

/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ Af120Delete  ³ Autor ³ Wagner Mobile Costa ³ Data ³ 11/04/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Deleta todos os registros da filial do alias recebido         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³cAlias = Alias para delecao de registro                    	³±±
±±³          ³dData  = Data Limite para delecao de registros             	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Af120Delete(cAlias,dData)                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA120                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Af120Delete(cAlias, dData)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Elimina os registros do SN5                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

Local nCont
cAliasQry := "SELECT MIN(R_E_C_N_O_) MINRECNO,"
cAliasQry += "MAX(R_E_C_N_O_) MAXRECNO FROM "+RetSqlName(cAlias)+" "
cAliasQry += "WHERE " + Right(cAlias, 2) + "_FILIAL='"+xFilial(cAlias)+ "'"

If dData <> Nil
	cAliasQry += " AND " + Right(cAlias, 2) + "_DATA<'"+Dtos(dData)+ "'"
Endif

cAliasQry := ChangeQuery(cAliasQry)

dbUseArea(.T.,"TOPCONN",TcGenQry(,,cAliasQry),"RECNO",.T.,.F.)
nMinRecno := MINRECNO
nMaxRecno := MAXRECNO
DbCloseArea()

cAliasQry := "DELETE FROM "+RetSqlName(cAlias)+" "
cAliasQry += "WHERE " + Right(cAlias, 2) + "_FILIAL='"+xFilial(cAlias)+ "'"
If dData <> Nil
	cAliasQry += " AND " + Right(cAlias, 2) + "_DATA<'"+Dtos(dData)+ "'"
Endif

For nCont := nMinRecno To nMaxRecno STEP 1024
	cChave :=	" AND R_E_C_N_O_>="+Str(nCont,10,0)+;
					" AND R_E_C_N_O_<="+Str(nCont+1023,10,0)+""
	TcSqlExec(cAliasQry+cChave)
Next nCont

Return .T.
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³MenuDef   ³ Autor ³ Ana Paula N. Silva     ³ Data ³10/12/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Utilizacao de menu Funcional                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Array com opcoes da rotina.                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³Parametros do array a Rotina:                               ³±±
±±³          ³1. Nome a aparecer no cabecalho                             ³±±
±±³          ³2. Nome da Rotina associada                                 ³±±
±±³          ³3. Reservado                                                ³±±
±±³          ³4. Tipo de Transa‡„o a ser efetuada:                        ³±±
±±³          ³		1 - Pesquisa e Posiciona em um Banco de Dados     ³±±
±±³          ³    2 - Simplesmente Mostra os Campos                       ³±±
±±³          ³    3 - Inclui registros no Bancos de Dados                 ³±±
±±³          ³    4 - Altera o registro corrente                          ³±±
±±³          ³    5 - Remove o registro corrente do Banco de Dados        ³±±
±±³          ³5. Nivel de acesso                                          ³±±
±±³          ³6. Habilita Menu Funcional                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MenuDef()
	Local aRotina:={ {STR0004, "AllwaysTrue",0,3}} // "Parametros"
Return(aRotina)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³AdmAbreSM0³ Autor ³ Orizio                ³ Data ³ 22/01/10 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna um array com as informacoes das filias das empresas ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function AdmAbreSM0()
Local aArea			:= SM0->( GetArea() )
Local aAux			:= {}
Local aRetSM0		:= {}
Local lFWLoadSM0	:= .T.
Local lFWCodFilSM0 	:= .T.

If lFWLoadSM0
	aRetSM0	:= FWLoadSM0()
Else
	DbSelectArea( "SM0" )
	SM0->( DbGoTop() )
	While SM0->( !Eof() )
		aAux := { 	SM0->M0_CODIGO,;
		IIf( lFWCodFilSM0, FWGETCODFILIAL, SM0->M0_CODFIL ),;
		"",;
		"",;
		"",;
		SM0->M0_NOME,;
		SM0->M0_FILIAL }

		aAdd( aRetSM0, aClone( aAux ) )
		SM0->( DbSkip() )
	End
EndIf

RestArea( aArea )
Return aRetSM0
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF120ChkVir ºAutor ³Microsiga          º Data ³  12/09/11   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³                                                            º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP                                                         º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Static Function AF120ChkVir()
Local lSldAtf 	:= GetNewPar("MV_ATFRSLD",.F.)
Local lRet 		:= .T.
Local dUltDepr	:= SuperGetMV("MV_ULTDEPR")

//se tem o parametro MV_ATFRSLD (REFAZ SALDO) CONFIGURADO COM .T. e controla data de virada
If lSldAtf
	dDataVir :=  AtfGetSN0("13","VIRADAATIVO")
	If !Empty(dDataVir)
		dDataVir := STOD(dDataVir)
		//data da virada deve ser sempre no primeiro dia do ano
		If ( DTOS(dDataVir) != "19800101" .And. Year(dDataBase) != Year(dDataVir) ) .Or. Month(dDataVir) != 1 .Or. Day(dDataVir) != 1
			Aviso(STR0025,STR0018+CRLF+; //"Atencao"##"A rotina para reconstrucao dos saldos do ativo somente pode ocorrer após a virada anual. "
							STR0019+CRLF+;  //"A virada anual deve ser executada sempre que se encerra o exercício contábil. "
							STR0020+CRLF+;  //"No Ativo, o exercício encerra-se após o cálculo de 31 de Dezembro."
							STR0021+DtoC(dDataVir)+" "+CRLF+;   //"Ultima Virada : "
							STR0022+DtoC(dUltDepr), {"Ok"})  //"Ultima Calculo Depreciacao : "
			lRet := .F.
		EndIf
	Else
			Aviso(STR0025,STR0023+CRLF+;  //"Atencao"##"Não encontrada a data da virada anual e o parametro MV_ATFRSLD esta ativo. Verifique!"
							STR0020+Space(50)+CRLF+;  //"No Ativo, a virada ocorre após o cálculo de 31 de Dezembro. "
							STR0025, {"Ok"})  //"Erro : Nao preenchido a data da virada."
			lRet := .F.
	EndIf
EndIf

Return(lRet)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF120TpSldºAutor  ³Alvaro Camillo Neto º Data ³  28/03/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Realiza o acerto das fichas do ativo que não possuem       º±±
±±º          ³ o campo N3_TPSALDO preenchido                              º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP                                                        º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF120TpSld()
Local aArea    := GetArea()
Local aAreaSN3 := SN3->(GetArea())
Local aAreaSN4 := SN4->(GetArea())
Local cQuery   := ""
Local cAliasBem := GetNextAlias()

SN3->(dbSetOrder(1)) //N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO+N3_BAIXA+N3_SEQ
SN4->(dbSetOrder(1)) //N4_FILIAL+N4_CBASE+N4_ITEM+N4_TIPO+DTOS(N4_DATA)+N4_OCORR+N4_SEQ

// Ajuste da Tabela SN3
If Select(cAliasBem) > 0
	(cAliasBem)->(dbCloseArea())
EndIf

cQuery   := " SELECT "
cQuery   += "     COUNT(*) CONT  "
cQuery   += " FROM  " + RetSQLName("SN3")
cQuery   += " WHERE "
cQuery   += "     N3_TPSALDO = '' AND "
cQuery   += "     D_E_L_E_T_ = '' "
cQuery   := ChangeQuery(cQuery )
dbUseArea( .T. , "TOPCONN" , TcGenQry(,,cQuery) , cAliasBem , .T. , .F.)
If (cAliasBem)->CONT > 0
	cQuery   := " UPDATE " + RetSQLName("SN3")
	cQuery   += " SET N3_TPSALDO = '1' "
	cQuery   += " WHERE "
	cQuery   += "     N3_TPSALDO = '' AND "
	cQuery   += "     D_E_L_E_T_ = '' "
	TCSQLExec(cQuery)
EndIf

// Ajuste da Tabela SN4
If Select(cAliasBem) > 0
	(cAliasBem)->(dbCloseArea())
EndIf

cQuery   := " SELECT "
cQuery   += "     COUNT(*) CONT  "
cQuery   += " FROM  " + RetSQLName("SN4")
cQuery   += " WHERE "
cQuery   += "     N4_TPSALDO = '' AND "
cQuery   += "     D_E_L_E_T_ = '' "
cQuery   := ChangeQuery(cQuery )
dbUseArea( .T. , "TOPCONN" , TcGenQry(,,cQuery) , cAliasBem , .T. , .F.)
If (cAliasBem)->CONT > 0
	cQuery   := " UPDATE " + RetSQLName("SN4")
	cQuery   += " SET N4_TPSALDO = '1' "
	cQuery   += " WHERE "
	cQuery   += "     N4_TPSALDO = ''  AND "
	cQuery   += "     D_E_L_E_T_ = '' "
	TCSQLExec(cQuery)
EndIf

(cAliasBem)->(dbCloseArea())

RestArea(aAreaSN4)
RestArea(aAreaSN3)
RestArea(aArea)
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF120CProvºAutor  ³Alvaro Camillo Neto º Data ³  07/05/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Verifica o conteudo do campo de classificação de custo/pro º±±
±±º          ³ visao para filtro nos relatórios                           º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP                                                        º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF120CProv(cBase,cItem,cTipo,cTipSld)
Local cCustProv := ""
Local aArea := GetArea()
Local aAreaSN3 := SN3->(GetArea())

SN3->(dbSetOrder(11))//N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO+N3_BAIXA+N3_TPSALDO+N3_SEQ+N3_SEQREAV

If SN3->(MsSeek(xFilial("SN3") + cBase + cItem + cTipo + "0" + cTipSld ))
	cCustProv := SN3->N3_ATFCPR
EndIf

RestArea(aAreaSN3)
RestArea(aArea)

Return cCustProv

//-------------------------------------------------------------------
/*/{Protheus.doc} SchedDef
Retorna os parametros no schedule.

@return aReturn			Array com os parametros

@author  TOTVS
@since   07/04/2014
@version 12
/*/
//-------------------------------------------------------------------
Static Function SchedDef()

Local aParam  := {}

aParam := { "P",;			//Tipo R para relatorio P para processo
            "AFA120",;		//Pergunte do relatorio, caso nao use passar ParamDef
            ,;				//Alias
            ,;				//Array de ordens
            STR0028}		//Titulo -  Refaz Saldos

Return aParam

//-------------------------------------------------------------------
/*/{Protheus.doc} AF020Sched
Realiza a execução quando chamado pelo smart schedule

@author  TOTVS
@since   10/03/2025
@version 12
/*/
//-------------------------------------------------------------------
Static Function AF020Sched(oProcess as object)
	local bBlock as codeblock
	local bProcess as codeblock

	if MV_PAR01 == 1
		bBlock := {|| AF120SN3(@oProcess)}
	else
		bBlock := {|| AF120SN4(,,@oProcess)}
	endif

	if MV_PAR03 == 1 .And. !Empty(FWxFilial("SN1"))// Seleciona filiais
		bProcess := { |lEnd| Afa120Fil(MV_PAR04,MV_PAR05,bBlock,@oProcess) }
	else
		bProcess := bBlock
	endif

	Eval(bProcess)
Return
