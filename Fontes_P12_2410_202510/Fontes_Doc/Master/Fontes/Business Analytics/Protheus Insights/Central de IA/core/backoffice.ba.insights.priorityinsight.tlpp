#INCLUDE "totvs.ch"
#INCLUDE "tlpp-core.th"
#include "InsightDefs.CH"
#include "BACKOFFICE.BA.INSIGHTS.PRIORITYINSIGHTS.CH"

NAMESPACE totvs.protheus.backoffice.ba.insights

Function priorityInsight(cCompanyGroup As Character, cMessageId As Character)

    Local aTables               As Array
    Local nStart                As Numeric
    Local oInsightProcessor     As Object
    // Local oException            As Object
    
    nStart := Seconds()

    try
        If ( Empty(cCompanyGroup) .Or. Empty(cMessageId) )
            pinsError( INSIGHTSERROR_PARAMETER_NOT_PRESENT, 'PriorityInsight', { STR0001 } )    //"CompanyGroup ou MessageId não informados corretamente"
            // Throw oException
        EndIf

        aTables := {"I19", "I20", "I21"}

        FwLogMsg("INFO", Nil, "ProtheusInsights", "PriorityInsight", Nil, "", I18N( STR0002, {cMessageId, cCompanyGroup } ),, Seconds() - nStart, ;
            {;
                { "Message", STR0003 },;
                { "CompanyGroup", cCompanyGroup },;
                { "MessageId", cMessageId };
            })  //"Processamento de Insight prioritário iniciado. Mensagem: [#1] CompanyGroup:[#2]"###"Processamento de Insight prioritário iniciado."

        RpcSetType(3)
        RpcSetEnv(cCompanyGroup,"",,, "FIN", "PriorityInsight", /*aTables*/, /*lShowFinal*/, /*lAbend*/, .T. /*lOpenSX*/, .T./*lConnect*/)

        oInsightProcessor := totvs.protheus.backoffice.ba.insights.InsightsProcessor():New()

        oInsightProcessor:ProcessMessage( cMessageId )

        FwLogMsg("INFO", Nil, "ProtheusInsights", "PriorityInsight", Nil, "", I18N( STR0004, { cMessageId } ),, Seconds() - nStart, ;
            {;
                { "Message", STR0005 },;
                { "CompanyGroup", cCompanyGroup},;
                { "MessageId", cMessageId};
            })  //"Processamento de insight prioritário com ID [#1] encerrado."###"Processamento de insight prioritário encerrado."

    catch oException
        FwLogMsg("ERROR", Nil, "ProtheusInsights", "PriorityInsight", Nil, "", STR0006,, Seconds() - nStart, ;
            {;
                { "Message", STR0006 },;
                { "ErrorCode", oException:genCode },;
                { "ErrorMessage", oException:description };
            })  //"Processamento de insight prioritário abortado com exceção."

        // Throw oException
    endTry

    // FreeObj( oException )
Return
