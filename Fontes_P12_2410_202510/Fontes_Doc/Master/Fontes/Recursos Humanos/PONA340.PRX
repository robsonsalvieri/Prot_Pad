#INCLUDE "PROTHEUS.CH"
#INCLUDE "PONA340.CH"

Static l340Block	:= ExistBlock( "PN340VALID" ,.F.,.F.)

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё PONA340  Ё Autor Ё Mauricio MR           Ё Data Ё 26/11/03 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Cadastramento de Visitas                                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё PONA340()                                                  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Generico                                                   Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.             Ё╠╠
╠╠цддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁProgramador Ё Data   Ё BOPS Ё  Motivo da Alteracao                     Ё╠╠
╠╠цддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁCecilia C.  Ё20/05/14ЁTPQAN3ЁIncluido o fonte da 11 para a 12 e efetu- Ё╠╠
╠╠Ё            Ё        Ё      Ёada a limpeza.                            Ё╠╠
╠╠ЁLuis Artuso Ё15/07/14ЁTPXU04ЁAjuste na inclusao do cadastro de visitas.Ё╠╠
╠╠Ё			   Ё        Ё      ЁAo incluir foto para o visitante, a rotinaЁ╠╠
╠╠Ё			   Ё        Ё      Ёera encerrada devido alteracao na varia-  Ё╠╠
╠╠Ё			   Ё        Ё      Ёvel 'oDlg'.                               Ё╠╠
╠╠ЁAlberto M   Ё24/09/14ЁTQPJQXЁAjuste nas funГУes FGETVISITANTE,         Ё╠╠
╠╠Ё			   Ё        Ё      ЁFGETCONTATO, FGETCC e PnVMat para inclusЦoЁ╠╠
╠╠Ё			   Ё        Ё      Ёde visitas em filial diferente da que     Ё╠╠
╠╠Ё			   Ё        Ё      Ёestamos logados                           Ё╠╠
╠╠ЁLuis Artuso Ё29/10/15ЁTTOUOIЁAjuste em fValidGet para que respeite o reЁ╠╠
╠╠Ё			   Ё        Ё      Ёtorno da execucao do P.E. PN340VALID.     Ё╠╠
╠╠ЁMatheus M.  Ё01/09/16ЁTUTZKEЁMudanГa do fonte para FwMBrowse.		  Ё╠╠
╠╠юддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ/*/
Function PONA340(aAuto,nOpc)

Local aSvKeys		:= GetKeys() 
Local aGrupoUser	:= {}
Local cFiltro		:= ""
Local uRet			
Local nPos  
Local nX    
Local nLenX
Local nReflesh		:= SuperGetMv("MV_P340ATU",NIL,5000)  			   //-- Tempo, em milisegundos, para atualizacao da tela			

Private oBrwPn340   := Nil
Private aRotAuto    := aClone(aAuto)
Private lPona340Aut := ( aAuto <> NIL )
Private cMemoAut    :=""  
Private lMudFVis    := ( SuperGetMv("MV_MUDFVIS",NIL,"S") == "S" )    //-- Verifica a mudanca de filtro a cada refresh de tela
Private lVerGrpUsr  := .T.
Private oEnchoice	 := NIL	
Private oDlg		:= NIL
Private oDlgBkp		:= NIL


If lPona340Aut
	nPos := aScan(aRotauto,{|x| x[1] == "PY_HISTVIS"})
	If nPos > 0
		cMemoAut:= aRotauto[nPos,2]
	End	
EndIf
	
Begin Sequence
		    
    SetRepName("IMGVIST")
    
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁSo Executa se o Modo de Acesso dos Arquivos do Ponto estiverem OK		 Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF !( ValidArqPon() )
		Break
	EndIF

	PRIVATE aFilterExp	 := {} 			//Expressao de filtro
	PRIVATE aAlsFilterExp:= {}
	PRIVATE aGrpFilterExp:= {}
	PRIVATE aUsrFilterExp:= {}
	PRIVATE cExpFiltro	:= ""
	PRIVATE aIndex		:= {}		
	PRIVATE cFiltra						//Variavel para filtro
	PRIVATE bFiltraBrw  := {|| Nil}		//Variavel para Filtro
	PRIVATE bEndFilBrw  := {||EndFilBrw("SPY",@aIndex)}   
	PRIVATE nOrdPesq	:= SPY->(INDEXORD())       

	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Define Array contendo as Rotinas a executar do programa      Ё
	//Ё ----------- Elementos contidos por dimensao ------------     Ё
	//Ё 1. Nome a aparecer no cabecalho                              Ё
	//Ё 2. Nome da Rotina associada                                  Ё
	//Ё 3. Usado pela rotina                                         Ё
	//Ё 4. Tipo de Transa┤└o a ser efetuada                          Ё
	//Ё    1 - Pesquisa e Posiciona em um Banco de Dados             Ё
	//Ё    2 - Simplesmente Mostra os Campos                         Ё
	//Ё    3 - Inclui registros no Bancos de Dados                   Ё
	//Ё    4 - Altera o registro corrente                            Ё
	//Ё    5 - Remove o registro corrente do Banco de Dados          Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды   
	PRIVATE aAcho
	PRIVATE aAlter   
	
	Private aEtiqueta

	PRIVATE aRotina := MenuDef() // ajuste para versao 9.12 - chamada da funcao MenuDef() que contem aRotina	
	
	If ExistBlock( "P340ROTI")
	   	aRotina := ExecBlock( "P340ROTI" ,.F.,.F.,{aRotina}, .F. )
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Define o cabecalho da tela de atualizacoes                   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	Private cCadastro := OemToAnsi( STR0009 )  //"Cadastro de Visitas"
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Define o botao para consulta/alteracao do visitante          Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	Private aSpyVisVisitante
	Private aSpyAltVisitante
	Private bSpyVisVisitante
	Private bSpyAltVisitante
		
	bSpyVisVisitante:= {|| Pn340VerVisitante(2), SetKey( VK_F6 , bSpyVisVisitante  ) } 
	aSpyVisVisitante:=	{;
						"pesquisa" 							,;
				   		bSpyVisVisitante						,;
				    	OemToAnsi( STR0033  + "...<F6>"  )	,;	//"Visualiza Visitante"
				    	OemToAnsi( STR0033 )				 ;	//"Visualiza Visitante"
			    	}
	SetKey( VK_F6 , bSpyVisVisitante )	
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Define o botao para consulta do visitante                    Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

	bSpyAltVisitante:= {|| Pn340VerVisitante(4), SetKey( VK_F7 , bSpyAltVisitante  ) } 
	aSpyAltVisitante:=	{;
						"pesquisa" 							,;
				   		bSpyAltVisitante						,;
				    	OemToAnsi( STR0038  + "...<F7>"  )	,;	//"Altera Visitante"
				    	OemToAnsi( STR0038 )				 ;	//"Altera Visitante"
			    	}
	SetKey( VK_F7 , bSpyAltVisitante )			    
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Monta a estrutura para obtencao de Filtros 							   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aAlsFilterExp	:={}
	aGrupoUser		:= UsrRetGrp()
	aUsrFilterExp	:={}
	
	aAdd( aAlsFilterExp , { "FILTRO_ALS" , "SPY"     , .T. , ".AND." } )
	aAdd( aAlsFilterExp , { "FILTRO_PRG" , FunName() , .T. , ".AND." } )  
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifica se Nao se trata de usuario administrador e filtra filtros por Ё
	//Ё usuario e grupo										                   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If lVerGrpUsr .AND. EMPTY(Ascan(aGrupoUser,{|x| x == "000000"}))   
		nLenx:=Len(aGrupoUser)
		For nX:=1 to nLenx
			aAdd( aGrpFilterExp , { "FILTRO_GRP" , aGrupoUser[nX] , If(nLenx > 1, .T., .F.) , If(nLenx > 1,".OR.", ".AND.")   } )  	
		Next nX
		aAdd( aUsrFilterExp , { "FILTRO_USR" , RetCodUsr() , NIL , NIL 	   } )  	
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Inicializa o filtro utilizando a funcao FilBrowse                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cFiltra 	:= CHKRH("PONA340","SPY","1")
	
	bFiltraBrw 	:= {|cCompleta| If( !Empty(cCompleta), ( cFiltro:=cFiltra + IF( !Empty(cFiltra), ' .AND. ', "" ) + cCompleta ), cFiltro:=cFiltra), FilBrowse("SPY", @aIndex,@cFiltro,.F.) }
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Executa ponto de entrada para filtro de browse (FilBrowse)             Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
	aFilterExp:=aClone(aAlsFilterExp)
	cExpFiltro:= fExpFiltro(@aFilterExp,.F.,.T.,lVerGrpUsr) 
	If ExistBlock( "P340FILT")
	   	If (Valtype(uRet := ExecBlock( "P340FILT" ,.F.,.F.,{cExpFiltro}, .F. )) == "C")
	   	   cExpFiltro:= uRet
	   	Endif   
	EndIf
	
	If !lPona340Aut
		Eval(bFiltraBrw,cExpFiltro)
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Endereca a funcao de BROWSE                                  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea( "SPY" )
	dbGoTop()
	
	If lPona340Aut                       
		//Estas variaveis sao necessarias para que a rotina automatica funcione.
		PRIVATE INCLUI := (nOpc==3)
		PRIVATE ALTERA := (nOpc==4)
		Private nOpx	:= nOpc                                              
		Private nRegx	:= SPY->(Recno())
	 	RegToMemory("SPY") 
		MsRotAuto(nOpc,aRotAuto,"SPY")
	Else
		//Monta o Browse
		oBrwPn340:= FwMBrowse():New()
		oBrwPn340:SetAlias( 'SPY' )
		oBrwPn340:SetDescription(OemToAnsi(cCadastro))	
		
		// - Inclui as opГУes de legenda no Browse.
		oBrwPn340:AddLegend( "EMPTY(SPY->PY_DTBAIXA) .AND. !EMPTY(SPY->PY_DATAE)"	, "GREEN"	, OemToAnsi(STR0014) ) //"Em Visita"
		oBrwPn340:AddLegend( "EMPTY(SPY->PY_DTBAIXA) .AND. SPY->PY_CLASSIF == '1'"	, "YELLOW"	, OemToAnsi(STR0013) ) //"Agendada"
		oBrwPn340:AddLegend( "!EMPTY(SPY->PY_DTBAIXA)"	, "RED"		, OemToAnsi(STR0020) ) //"Encerrada"
		oBrwPn340:SetTimer({||AtuBrw(oBrwPn340)}, nReflesh)
		oBrwPn340:SetmenuDef( 'PONA340' )  		
		oBrwPn340:Activate()  
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Deleta o filtro utilizando a funcao FilBrowse                     	   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	//--Cancela Filtros Anteriores  
	If !lPona340Aut
		Eval(bEndFilBrw) 
	Endif
	
End Sequence

RestKeys( aSvKeys , .T. )

SetRepName("SIGAADV")	

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё Pn340Rot Ё Autor Ё Mauricio MR           Ё Data Ё 26.11.03 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Rotina para Manutencao de Visitas			              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё Pn340Rot(ExpC1,ExpN1,ExpN2)                                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ ExpC1 = Alias do arquivo 								  Ё╠╠
╠╠Ё 		 Ё ExpN1 = Numero do registro								  Ё╠╠
╠╠Ё 	 	 Ё ExpN2 = Numero da opcao Selecionada						  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё Pn340Rot  												  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
                                                                             */
Function Pn340Rot(cAlias,nReg,nOpc)

Local aArea			:= GetArea()  
Local aBotoes     	:= {}              
Local aAcessos		:= {}
Local aAdvSize		:= {}
Local aInfoAdvSize	:= {}
Local aObjSize		:= {}
Local aObjCoords	:= {}
Local aSPYHeader	:= {}
Local aSPYCols		:= {}
Local aSPYFields	:= {}
Local aSPYAltera	:= {}
Local aSPYNaoAlt	:= {}
Local aSPYVirtEn	:= {}
Local aSPYNotFields	:= {}
Local aSPYRecnos	:= {}
Local aSPYVisuEn	:= {}
Local aSPYMemoEn	:= {}
Local aSPZGdAltera  := {}
Local aSPZGdNaoAlt	:= {}
Local aSPZRecnos	:= {}
Local aSPZNotFields	:= {}
Local aSPZVirtGd	:= {}
Local aSPZVisuGd	:= {}
Local aSPZHeader	:= {}
Local aSPZCols		:= {}
Local aSvKeys		:= GetKeys()
Local aSYPRecnos	:= {}
Local bCFGEtiqueta	:= {||If( fProgAtual(), fCFGEtiqueta()	, Nil) }
Local bPRTEtiqueta	:= {||If( fProgAtual(), fImprime()		, Nil) }
Local bPn340Locks	:=	{|cAlias, aRecnos| WhileYesNoWait(;
											{ |cAlias,aRecnos| PonLockRegs( cAlias , aRecnos , NIL , 1 , 1 ) }	,;	//Bloco a Ser Executando Enquando ( Devera Retornar Valor Logico )
											05														,;	//Numero de Tentativas
											.T.														,;	//Se podera Encerrar as as Tentativas ( Button Cancel Enabled )
											OemToAnsi( STR0112 )									,;	//Mensagem de Corpo para a MsgInfo //"O Registro est═ sendo utilizado por outro usu═rio"
											cCadastro												,;	//Titulo para a MsgInfo 
											OemToAnsi( STR0114 )									,;	//Mensagem de Corpo para a MsgYesNo //"Tentar novamente?"
											cCadastro												,;	//Titulo para a MsgYesNo
											OemToAnsi( STR0116 )									,;	//Mensagem de corpo para a ProcWaiting //"Tentando acessar o registro."
											cCadastro												 ;	//Titulo para a ProcWaiting
					   						);
    					}										

Local bSPZGdDelOk	:= { || Pn340DelOk() }
Local bSet15		:= { || NIL }
Local bSet24		:= { || NIL }
Local cSPYKeySeek	:= ""
Local cFilSPY		:= ""
Local cVisSPY		:= ""
Local cCrachaSPY	:= ""
Local cDtVisitSPY	:= ""
Local cNumeroSPY	:= ""
Local lGetDados		:=  ( nOpc == 2  .OR. nOpc == 5) //Visualiza ou Exclusao
Local lLocks		:= .F.
Local nOpcAlt		:= 0.00
Local nSPYUsado		:= 0.00
Local nSPZUsado		:= 0.00
Local nLoop			:= 0.00
Local nLoops		:= 0.00
Local nOpcNewGd		:= IF( (( nOpc == 2 ) .or. ( nOpc == 5 )),0, If( (( nOpc == 6 ) .or. ( nOpc == 7 )), GD_UPDATE, GD_INSERT + GD_UPDATE + GD_DELETE ))	
Local nOpcGdMax		:= 9999
Local oGetDados		:= NIL 
Local aObject		:= {}
Local bGrava
Local lGrava		:= .T.

Private aSPZClone		:= {}
Private nPosSPZData		:= 0.00
Private nPosSPZHora		:= 0.00
Private nPosSPZFlag		:= 0.00
Private nPosSPZTpMarca	:= 0.00
Private nPosSPZRelogio	:= 0.00

Private nOpx			:= nOpc
Private nRegx			:= If(__cInternet=="AUTOMATICO",SPY->(Recno()),nReg)
Private nSaveSX8    	:= GetSX8Len() 

Private aTamMat		    := TamSX3( "PY_MAT" )
Private nLastRec		:= 0
Private nGetSX8Len		:= GetSX8Len()

DEFAULT nRegX := SPY->(RECNO())

If ExistBlock( "P340VLD")
 	If !(ExecBlock( "P340VLD" ,.F.,.F.,{nOpc}, , .F. ))
  		Return()
 	EndIf
EndIf

Begin Sequence  
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Permite Apenas Visualizar os casos abaixo					   Ё
	Ё a) Tentativa de registrar uma entrada ja realizada		   Ё
	Ё b) Tentativa de registrar uma baixa ja realizada			   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
     
     If nOpx == 6 .AND. !Empty(SPY->PY_DATAE)
     	MsgAlert( OemToAnsi( STR0035) , STR0034 )	//Atencao# Entrada do Visitante ja Registrada"
        nOpc:=nOpx:= 2
     Endif                                                                
     
     If nOpx == 7 .AND. !Empty(SPY->PY_DTBAIXA)
     	MsgAlert( OemToAnsi( STR0036 ) , STR0034 )	//Atencao# Baixa ja Registrada"
        nOpc:=nOpx:= 2
     Endif                                                                
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Quando For Inclusao Posiciona o SPY No Final do Arquivo	   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( nOpc == 3  ) //Inclusao
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Garante que na Inclusao o Ponteiro do SPY estara em Eof()    Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		PutFileInEof( "SPY" , @nReg )  
	Endif	

	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Monta os Dados para a Enchoice							   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	
	aSPYNotFields	:= { "PY_FILIAL","PY_NUMERO","PY_DCARGO"}
   

	aSPYCols		:= SPY->(GdMontaCols(@aSPYHeader,@nSPYUsado,@aSPYVirtEn,@aSPYVisuEn,NIL,aSPYNotFields,@aSPYRecnos))
	cFilSPY			:= SPY->PY_FILIAL
	cVisSPY			:= SPY->PY_VISITA
	cCrachaSPY		:= SPY->PY_CRACHA
	cDtVisitSPY		:= Dtos(SPY->PY_DTVISIT)
	cNumeroSPY		:= SPY->PY_NUMERO
	cSPYKeySeek		:= ( cFilSPY + cNumeroSPY )

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Cria as Variaveis de Memoria e Carrega os Dados Conforme o arЁ
	Ё quivo														   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	If ! lPona340Aut
		For nLoop := 1 To nSPYUsado
			aAdd( aSPYFields , aSPYHeader[ nLoop , 02 ] )
			Private &( "M->"+aSPYHeader[ nLoop , 02 ] ) := aSPYCols[ 01 , nLoop ]
		Next nLoop  
	EndIf
	

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Alimenta as Variaveis de Memoria.							   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/	
	If nOpc <> 1
		PnVMat(M->PY_MAT, .F.)
		Pn340VCC()
		PnVVisita(M->PY_VISITA,.F.) 
		Pn340RDTBAIXA(@M->PY_DTBAIXA)
		Pn340RSAIDA(@M->PY_SAIDA)
		Pn340RDTS(@M->PY_DATAS)  
		Pn340RENTRADA(@M->PY_ENTRADA)       
		Pn340RDTE(@M->PY_DATAE)
    Endif

 	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁDefine os Campos Editaveis na Enchoice.                       Ё
	Ё                   										   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( ( nOpc == 3 ) .or. ( nOpc == 4 ) .or. ( nOpc == 6 ) .or. ( nOpc == 7 ))
		
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Define os Campos Editaveis								   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		nLoops := Len( aSPYVisuEn )
		
		For nLoop := 1 To nLoops
			aAdd( aSPYNaoAlt , aSPYVisuEn[ nLoop ] )
		Next nLoop
		
		IF ( nOpc == 4 ) .or. ( nOpc == 6 ) .or. ( nOpc == 7 )            
			
			If !(nOpc == 4 .And. Empty(SPY->PY_DTBAIXA) .AND. Empty(SPY->PY_DATAE) .AND. SPY->PY_CLASSIF == '1')
				aAdd( aSPYNaoAlt , "PY_VISITA" )
			EndIf
			
			IF ( nOpc == 6 )
				aAdd( aSPYNaoAlt , "PY_DATAS" 	)
				aAdd( aSPYNaoAlt , "PY_SAIDA" 	)
				aAdd( aSPYNaoAlt , "PY_DTBAIXA" )
			ElseIF ( nOpc == 7 )            
				aAdd( aSPYNaoAlt , "PY_DATAE" 	)
				aAdd( aSPYNaoAlt , "PY_ENTRADA"	)
				aAdd( aSPYNaoAlt , "PY_CRACHA" 	) 
				aAdd( aSPYNaoAlt , "PY_NOMEMP" 	) 							
				aAdd( aSPYNaoAlt , "PY_MAT" 	) 							
				aAdd( aSPYNaoAlt , "PY_CC" 		) 											
				aAdd( aSPYNaoAlt , "PY_TIPOVIS"	) 							
				aAdd( aSPYNaoAlt , "PY_CLASSIF"	) 							
			Endif
			
		EndIF
		
		nLoops := Len( aSPYFields )
		For nLoop := 1 To nLoops
			IF ( aScan( aSPYNaoAlt , { |cNaoA| cNaoA == aSPYFields[ nLoop ] } ) == 0.00 )
				aAdd( aSPYAltera , aSPYFields[ nLoop ] )
			EndIF
		Next nLoop
	EndIF
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁObtem os Recnos e Chaves dos Memos                            Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	aAdd( aSPYMemoEn , { "PY_HISTVIS" , "PY_CODHIST" } )
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁSe nao For Visualizacao nem Inclusao	 					   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	//-- Obtem dados de campo Memo
	IF ( ( nOpc <> 2 ) .and. ( nOpc <> 3 ) )
		MsMmObtemRec( "SPY" , aSPYRecnos , aSPYMemoEn , @aSYPRecnos )
	EndIF

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Monta os Dados para a GetDados							   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	
	aAdd( aSPZNotFields , "PZ_FILIAL"  )
	aAdd( aSPZNotFields , "PZ_VISITA"	)
	aAdd( aSPZNotFields , "PZ_CRACHA"	)
	aAdd( aSPZNotFields , "PZ_NUMERO"	)
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Quando For Inclusao Posiciona o SPZ No Final do Arquivo	   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( nOpc == 3  ) //Inclusao
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Garante que na Inclusao o Ponteiro do SPZ estara em Eof()    Ё 
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		PutFileInEof( "SPZ" )
	EndIF

	//aSPZCols := SPZ->(GdMontaCols(@aSPZHeader,@nSPZUsado,@aSPZVirtGd,@aSPZVisuGd,NIL,aSPZNotFields,@aSPZRecnos,"SPZ",cSPYKeySeek,NIL,NIL,NIL,NIL,NIL,NIL,NIL,NIL,aSPZQuery,.F.,.F.,.T.))
    aSPZHeader := GdMontaHeader( @nSPZUsado , @aSPZVirtGd , @aSPZVisuGd , 'SPZ' , aSPZNotFields )

	IF ( nOpc == 2  .OR. nOpc == 5) //Visualiza ou Exclusao
		GetAcessos(	@aAcessos			,;	//01 -> Acessos
					M->PY_DATAE			,;	//02 -> Periodo Inicial
					M->PY_ENTRADA		,;  //03 -> Hora Inicial
					M->PY_DATAS			,;	//04 -> Periodo Final
					M->PY_SAIDA			,;  //05 -> Hora Final
					cFilSPY				,;	//06 -> Filial
					M->PY_CRACHA		,;  //07 -> Cracha
					'SPZ'				,;	//08 -> Alias para Carga das Marcacoes
					.T.					 ;	//09 -> Se carrega Recno em aAcessos
				  )
		
	    GdSPZMontaCols(aAcessos, @aSPZCols, @aSPZRecnos)
	Else
    	aSPZCols := GdRmkaCols( aSPZHeader , .F.)
	Endif    
    /*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Obtem as Posicoes dos Campos do SPZ - Marcacoes dos VisitanteЁ
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
    nPosSPZData		:= GdFieldPos( "PZ_DATA" 	, aSPZHeader )
    nPosSPZHora		:= GdFieldPos( "PZ_HORA" 	, aSPZHeader )
    nPosSPZFlag		:= GdFieldPos( "PZ_FLAG" 	, aSPZHeader )
    nPosSPZTpMarca	:= GdFieldPos( "PZ_TPMARCA" , aSPZHeader )
    nPosSPZRelogio	:= GdFieldPos( "PZ_RELOGIO" , aSPZHeader )
    
                                                                        
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Copia as Marcacoes para Posterior Comparacao na Gravacao	   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	aSPZClone:=aClone(aSPZCols)
   
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Carrega os Campos Editaveis para a GetDados				   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	For nLoop := 1	To nSPZUsado
		Private &( "M->"+aSPZHeader[ nLoop , 02 ] ) := GetValType( aSPZHeader[ nLoop , 08 ] , aSPZHeader[ nLoop , 04 ] )
		IF (;
				( aScan( aSPZVirtGd		, aSPZHeader[ nLoop , 02 ] ) == 0.00 ) .and.	;
		   		( aScan( aSPZVisuGd		, aSPZHeader[ nLoop , 02 ] ) == 0.00 ) .and.	;
		   		( aScan( aSPZNotFields	, aSPZHeader[ nLoop , 02 ] ) == 0.00 ) .and.	;
		   		( aScan( aSPZGdNaoAlt	, aSPZHeader[ nLoop , 02 ] ) == 0.00 )			;
		  	)
			aAdd( aSPZGdAltera , aSPZHeader[ nLoop , 02 ] )
		EndIF
	Next nLoop

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁLock dos Registros											   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	If ( ( nOpc <> 2 ) .and. ( nOpc <> 3 ) )
		IF !( lLocks := Eval(bPn340Locks,'SPY', aSPYRecnos, aSYPRecnos))
			Break
		EndIF 
		IF !( lLocks := Eval(bPn340Locks,'SYP', aSPYRecnos, aSYPRecnos))
			Break
		EndIF
		IF !( lLocks := Eval(bPn340Locks,'SPZ', aSPZRecnos))
			Break
		EndIF
    Endif


	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Monta as Dimensoes dos Objetos         					   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	aAdvSize		:= MsAdvSize()
	aInfoAdvSize	:= { aAdvSize[1] , aAdvSize[2] , aAdvSize[3] , aAdvSize[4] , 0 , 0 }

	IF ( nOpc == 2  .OR. nOpc == 5) //Visualiza ou Exclusao
		aAdd( aObjCoords , { 000 , 120 , .T. , .F. } ) 
		aAdd( aObjCoords , { 000 , 000 , .T. , .T. } )
	Else
		aAdd( aObjCoords , { 000 , 300 , .T. , .T. } ) 
	Endif	

	aObjSize		:= MsObjSize( aInfoAdvSize , aObjCoords )

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Define o Bloco para a Tecla <CTRL-O> 						   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	bSet15		:= { || fValidGet(nOpc,lGetDados,@nOpcAlt) }
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Define o Bloco para a Teclas <CTRL-X>     	   			   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	bSet24		:= { || ( nOpcAlt := 0.00 , oDlg:End() ) }

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Define o Bloco de Definicao de Botoes 	   	   			   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	If   ( ( nOpc == 3 ) .or. ( nOpc == 4 ) .or. ;
		   ( nOpc == 6 ) .or. ( nOpc == 7 ) )	
		 aAdd(; 
				aBotoes	,;
								{;
									"PRTETQ"			,;	
		   							bPRTEtiqueta		,;
		       	   					OemToAnsi( STR0021 ),; //"Imprime Etiqueta <F4>..."
		       	   					OemToAnsi( STR0121 ); //"Imprime"
		           				};
		    )	 
	
		 aAdd(; 
				aBotoes	,;
								{;
									"note"				,;	
		   							bCFGEtiqueta			,;
		       	   					OemToAnsi( STR0024 )	,; //"Configura Etiqueta <F5>..."
		       	   					OemToAnsi( STR0124 )	; //"Configura"
		           				};
		    )	


		 SetKey(VK_F4,bPRTEtiqueta)
 		 SetKey(VK_F5,bCFGEtiqueta)
	Endif                    

	If ! lPona340Aut	
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Monta o Dialogo Principal para a Manutencao             	   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
        
		DEFINE MSDIALOG oDlg TITLE OemToAnsi( STR0009 ) From aAdvSize[7],0 TO aAdvSize[6],aAdvSize[5] OF oMainWnd PIXEL
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Monta o Objeto Enchoice para o SPY                      	   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			oEnchoice	:= MsmGet():New(	"SPY"		,; 
											nReg		,; 
											nOpc		,; 
											NIL			,; 
											NIL			,; 
											NIL			,; 
											aSPYFields	,; 
											aObjSize[1] ,; 
											aSPYAltera	,; 
											NIL			,; 
											NIL			,; 
											NIL			,; 
											"PN340EncTOk",;
											oDlg		,; 
											NIL			,; 
											.T.         ,; 
											NIL			,; 
											NIL			;  
										)
			Aadd(aObject, oEnchoice:oBox)
			oDlgBkp	:= oDlg			

			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Monta o Objeto GetDados para o SPZ						   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			// MsNewGetDados(nTop, nLeft, nBottom, nRight, nStyle, uLinhaOk, uTudoOk, cIniCpos, aAlter, nFreeze, nMax, cFieldOk, uSuperDel, uDelOk, oWnd, aParHeader, aParCols)
		   	IF lGetDados //Visualiza ou Exclusao
				oGetDados	:= MsNewGetDados():New(	aObjSize[2,1]								,;
													aObjSize[2,2]								,;
													aObjSize[2,3]								,;
													aObjSize[2,4]								,;
													nOpcNewGd									,;
													"Pn340LinOk"								,;
													"Pn340TudOk"								,;
													NIL											,;
													aSPZGdAltera								,;
													0											,;
													nOpcGdMax  									,;
													NIL											,;
													NIL											,;
													bSPZGdDelOk									,;
													oDlg										,;
													aSPZHeader									,;
													aSPZCols		 							 ;
												  )
			    oGetDados:oBrowse:bWhen	:={|| fLiberaGet(oEnchoice, nOpc)}
			    Aadd(aObject, oGetDados:oBrowse)
			Endif
	
		ACTIVATE MSDIALOG oDlg ON INIT ( EnchoiceBar( oDlg , bSet15 , bSet24 ,, aBotoes ),;
										AlignObject(oDlg,aObject,1))
	Else 
		If  PN340EncTOk() 
		   nOpcAlt := 1
		Else
		   nOpcAlt 	:= 0
	   	   AutoGRLog(STR0037+ "PN340EncTOk()") //"Inconsistencia em PN340EncTOk()"
   		   lMsErroAuto:= .t.
	   EndIf
	EndIf	

	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁQuando Confirmada a Opcao e Nao for Visualizacao Grava ou   ExЁ
	Ёclui as Informacoes do SPY e SPZ							   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF( nOpcAlt == 1 )
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Apenas se nao For Visualizacao              				   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
 		IF ( nOpc != 2 )
 		

			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Gravando/Incluido ou Excluindo Informacoes                   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			bGrava := { ||;
								Pn340Grava(		If(nOpc == 6 .or. nOpc == 7, 4, nOpc)	,;
												nReg			,;
												aSPYHeader		,;
												aSPYVirtEn		,;
												aSPYMemoEn		,;
												aSPZHeader		,;
												If(lGetDados,oGetDados:aCols,{}),;
												aSPZVirtGd		,;
												aSPZRecnos		 ;
											);
							}
					
			If ! lPona340Aut
				MsAguarde(bGrava)
			Else 
			   Eval(bGrava)
			EndIf	

		EndIF
	ElseIF ( nOpc == 3 )
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё RollBack da Numeracao Automatica            				   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	  
		While (GetSx8Len() > nSaveSx8)
			RollBackSx8()
		EndDo            
		
	EndIF

End Sequence

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
ЁLibera os Locks             								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
PonFreeLocks()
/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
ЁLibera as Chaves Exclusivas 								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
FreeUsedCode()

/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Restaura as Teclas de Atalho                				   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
RestKeys( aSvKeys, .T. )

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
ЁRestaura os Dados de Entrada								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
RestArea( aArea )

nLastRec := Iif(nLastRec == 0, SPY->( Recno() ), nLastRec)

// - Efetua o Refresh no Browse posicionando no Зltimo registro Visualizado/Alterado/Incluido.
If !lPona340Aut
	oBrwPn340:Refresh(.T.)
	oBrwPn340:GoTo(nLastRec)
EndIf

Return( nOpcAlt )

/*
зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340Leg Ё Autor Ё Maurico MR	          Ё Data Ё26/11/2003Ё  
цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Cria uma janela contendo a legenda da mBrowse              Ё  
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё PnLegend                                                   Ё  
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/

Function Pn340leg()
Local aCores:={}

IF Type( "cCadastro" ) == "U"
	Private cCadastro := STR0011						//"Legenda"
EndIF

aCores:={	{"ENABLE"		,OemToAnsi(STR0014)	}	,;	//"Em Visita"
			{"BR_AMARELO"	,OemToAnsi(STR0013)	}	,;	//"Agendada"
			{"BR_VERMELHO"	,OemToAnsi(STR0020)	}	;	//"Encerrada"
			}
              
If ExistBlock( "P340LEG")
   aCores := ExecBlock( "P340LEG" ,.F.,.F.,{aCores,1}, .F. )
EndIf

BrwLegenda(	OemToAnsi(cCadastro)					,;	//Titulo do Cadastro
			OemToAnsi( STR0012 )					,;	//"Legenda"
			aCores )

Return( .T. )
                 

/*/
зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©  
ЁFuncao    Ё fAgendCorЁ Autor Ё Mauricio MR           Ё Data Ё02.12.2003Ё  
цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢  
ЁDescri┤┘o Ё Funcao p/ definir cores da Situacao da Visita.	  	        Ё  
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
ЁRetorno   ЁaCores                                                      Ё  
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
ЁParametrosЁ													        Ё  
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
/*/
Function fAgendCor()

Local aCores	:=	{	 ;
						{ "EMPTY(SPY->PY_DTBAIXA) .AND. !EMPTY(SPY->PY_DATAE)" , 'BR_VERDE'		}	,;
	             		{ "EMPTY(SPY->PY_DTBAIXA) .AND. SPY->PY_CLASSIF == '1'" , 'BR_AMARELO'	}	,;
	           			{ "!EMPTY(SPY->PY_DTBAIXA)" , 'BR_VERMELHO'	}	;
				    }

IF ExistBlock( "P340LEG")
   aCores := ExecBlock( "P340LEG" ,.F.,.F.,{aCores,2}, .F. )
ENDIF

Return(aCores)


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VCracha  Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Cracha										  	   Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VCracha                                              Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/  
Function Pn340VCracha(cCracha,cVisita,dDtVisit)
Local aArea			:=	GetArea()
Local aAreaSPY		:=	SPY->(GetArea())
Local cFilSPY		:= xFilial('SPY')
Local cChave		:= cFilSPY+cCracha
Local lRet			:= .T. 

DEFAULT cVisita		:=M->PY_Visita
DEFAULT dDtVisit	:=M->PY_DtVisit  



Begin Sequence  

    If Empty(cCracha) .AND. ( M->PY_CLASSIF <> '1' .OR. nOpx == 6 .OR. nOpx == 7) 
       Help(" ",1,"PN340NOCRA")   //-- Cracha Obrigatorio para Visita Nao Agendada
       lRet:= .F.
       Break
    Endif  
    
    If !EMPTY(cCracha)
        If Texto()
			SPY->(DbSetOrder(2))
			If SPY->(Dbseek(cChave))
			   While SPY->(!EOF() .AND. cChave == (cFilSPY+PY_Cracha) )          
			   		 If EMPTY(SPY->PY_DtBaixa) .AND. (cVisita <> SPY->PY_Visita)
 			     		lRet:= .F.  
			            Help(" ",1,"PN340CRESV")   //-- Cracha Ja reservado a outro visitante
			            Exit
			         Endif          
			         SPY->(DbSkip())
			   Enddo
			Endif 
		Else
		    lRet:= .F.
       		Break
		Endif
	Endif
End
RestArea(aArea)
RestArea(aAreaSPY)
Return (lRet)

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VDtVisit Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Data da Visita								  	   Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VDtVisit                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/  
Function Pn340VDtVisit(cVisita,dDtVisit)
Local aArea			:= GetArea()
Local aAreaSPY		:= SPY->(GetArea())
Local lRet			:= .T.
Local cFilSPY		:= xFilial('SPY')
Local cChave		:= ''
Local lTemVistHr	:= .F.
Local lTemVistDt	:= .F.
Local nNovoRecno	:= SPY->(Recno())
Local lIsBind		:= IsBlind()

DEFAULT cVisita		:=	M->PY_VISITA
DEFAULT dDtVisit	:=	M->PY_DTVISIT

//-- Verifica se Cracha em uso por outro Visitante
cChave	:= cFilSPY + cVisita + Dtos(dDtVisit)

If SPY->(Dbseek(cChave)) .And. IsInCallStack("PN340EncTOk")
	While SPY->(!Eof() .And. cChave == (cFilSPY + PY_VISITA + Dtos(PY_DTVISIT)))
		If Empty(SPY->PY_DTBAIXA) .And. SPY->(Recno()) <> nNovoRecno .And. SPY->PY_ENTRADA == M->PY_ENTRADA
			lTemVistHr := .T.
			Exit
		ElseIf SPY->(Recno()) <> nNovoRecno
			lTemVistDt := .T.
		EndIf
		
		SPY->(DbSkip())
	Enddo

	If lTemVistHr
		lRet := .F.
		Help(NIL, NIL, STR0131, NIL, STR0132, 1, 0, NIL, NIL, NIL, NIL, NIL, {STR0133}) // "Visita com duplicidade" - "JА existe uma visita com a mesma data e hora de entrada cadastrada." - "Altere a data da visita ou a hora de entrada."
	EndIf

	If !lTemVistHr .And. lTemVistDt
		If !lIsBind .And. MsgYesNo(STR0134, STR0135) // "JА existe uma visita para o mesmo dia com horАrio diferente, deseja continuar?" - "Visita na mesma data"
			lRet := .T.
		Else
			lRet := .F.
		EndIf
	EndIf
EndIf 

RestArea(aArea)
RestArea(aAreaSPY)

Return (lRet)

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VDtBaixa Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Data da Baixa								  	   Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VDtBaixa                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/
Function Pn340VDtBaixa(dDtVisit,dDtBaixa)
Local lRet			:= .T.

DEFAULT dDtBaixa	:=	M->PY_DtBaixa
DEFAULT dDtVisit	:=	M->PY_DtVisit 

If dDtVisit > dDtBaixa  .AND. !Empty(dDtBaixa)
	Help(" ",1,"PN340DTVB")   //-- Data de Baixa menor que Data de Visita ou de Saida
   lRet:= .F.
Endif
Return (lRet)


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340RDTBAIXA Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Retorna o Conteudo do SX3_Relacao                         Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340RDTBAIXA                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340RDTBAIXA(dRet)
DEFAULT dRet:= Ctod("")

If nOpx = 7 
   dRet:= dDatabase
Endif

Return (dRet)       

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340WEntrada Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ When Entrada		  					                   Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340WENTRADA                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340WENTRADA()
Local lRet:= .T.
If nOpx <> 6 .AND. nOpx <> 3.AND. nOpx <> 4
   lRet:= .F.
Endif   
Return lRet
           
/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340WDTE     Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ When DATAE		  					                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340WDTE                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340WDTE()
Local lRet:= .T.
If nOpx <> 6 .AND. nOpx <> 3 .AND. nOpx <> 4
   lRet:= .F.
Endif   
Return lRet 

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340WDTS     Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ When DATAS		  					                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340WDTS                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340WDTS()
Local lRet:= .T.
If nOpx <> 7.AND. nOpx <> 3 .AND. nOpx <> 4
   lRet:= .F.
Endif   
Return lRet 


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340WSAIDA   Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ When Saida  		  					                   Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340WSAIDA                                               Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   

Function Pn340WSAIDA()
Local lRet:= .T.
If nOpx <> 7.AND. nOpx <> 3 .AND. nOpx <> 4
   lRet:= .F.
Endif   
Return lRet

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VENTRADA Ё Autor Ё Maurico MR      Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Entrada  					                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VENTRADA                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/     
Function Pn340VENTRADA(nEntrada)
Local lRet:= .T.
DEFAULT nEntrada:=M->PY_ENTRADA

lRet:=VLDHORA(nEntrada)

Return lRet


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VSAIDA   Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Saida  						                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VSAIDA                                               Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340VSAIDA(nSaida)
Local lRet:= .T.
DEFAULT nSaida:=M->PY_SAIDA

(lRet:=VLDHORA(nSaida))

Return lRet


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340RENTRADA Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁRetorna o Conteudo do SX3_Relacao 	                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340RENTRADA                                             Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340RENTRADA(nEntrada)
DEFAULT  nEntrada:=0.00
If nOpx = 6 .and. Empty(M->PY_DATAE)  .and. ! lPona340Aut
	nEntrada:= VAL(StrTran(Substr(time(),1,5),":","."))
Endif
Return nEntrada


/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340RSAIDA   Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁRetorna o Conteudo do SX3_Relacao 	                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340RSAIDA                                               Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340RSAIDA(nSaida)
DEFAULT  nSaida:=0.00

If nOpx = 7   .and. Empty(M->PY_DATAS)
	nSaida:= VAL(StrTran(Substr(time(),1,5),":","."))
Endif

Return nSaida

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340RDTS     Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё          
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Retorna o Conteudo do SX3_Relacao                         Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340RDTS                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340RDTS(dRet)
DEFAULT dRet:= Ctod("")

If nOpx = 7   .and. Empty(M->PY_DATAS)
   dRet:= dDatabase
Endif 
Return dRet 

/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340RDTE     Ё Autor Ё Maurico MR      Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Retorna o Conteudo do SX3_Relacao                         Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340RDTE                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340RDTE(dRet)
DEFAULT dRet:= Ctod("")

If nOpx = 6 .and. Empty(M->PY_DATAE) .and. ! lPona340Aut
   dRet:= dDatabase
Endif 
Return dRet

/*             
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VDTE   Ё Autor Ё Maurico MR	     Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Data Entrada                                       Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VDTE                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340VDTE(dDataE)
Local lRet:= .T.

Return lRet

/*             
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340VDTS     Ё Autor Ё Maurico MR   	 Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Data Saida                                         Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340VDTS                                                 Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function Pn340VDTS(dDataS)
Local lRet:= .T.

Return lRet

                     
/*             
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©  
Ё Fun┤┘o   Ё Pn340EncTOk   Ё Autor Ё Maurico MR   	 Ё Data Ё18/12/2003Ё  
цддддддддддедддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢  
Ё Descri┤┘oЁ Valida Enchoice                                           Ё  
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
Ё Uso      Ё Pn340EncTOk                                               Ё  
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
*/                   
Function PN340EncTOk(aGets,aTela, oEnchoice)
Local lRet		:= .T.                
Local laGets	:= (aGets  <> Nil)
Local loEncho	:= (oEnchoice <> Nil)

Begin Sequence
      If laGets 
		  If !(lRet:=Obrigatorio(aGets,aTela))
		     Break
		  Endif   
      Endif 
     
      If EMPTY(M->PY_MAT) .AND. EMPTY(M->PY_CC)
         Help(" ",1,"PN340NOCC") // "Matricula ou C.Custo NЦo Informado"
         lRet:=.F. 
         If loEncho
		   	 fPosEnchoice(oEnchoice, "PY_CC")
		 Endif  	 
	   	 Break
      Endif  
       
      //-- Cracha do Visitante Nao Informado  
      //-- Foi fornecida Data de Entrada ou de Saida ou de Baixa
      If EMPTY(M->PY_CRACHA) .AND. ( ! EMPTY(M->PY_DATAE) .OR. !EMPTY(M->PY_DATAS) .OR. !EMPTY(M->PY_DTBAIXA)) .and. ! lPona340Aut         
        
     	 lRet:=.F.
       	 Help(" ",1,"PN340NOCRA")   //-- Cracha do Visitante Nao Informado  
       	 
         //-- Se Nao for Saida posiciona no Campo Cracha 
         If loEncho .AND. nOpx <> 7  
		  	 fPosEnchoice(oEnchoice, "PY_CRACHA")
		 Endif  	 
  
         Break        
		      
	  ENDIF      	  
	        
      //-- Nao Consta Entrada do Visitante.
      //-- Foi fornecida a Data de Saida ou o Cracha 
      If !nOpx == 3 .And. EMPTY(M->PY_DATAE) .AND. ( !EMPTY(M->PY_DATAS)  .OR. ! EMPTY(M->PY_CRACHA) )
	     lRet:=.F.
	     Help(" ",1,"PN340SEM_E")   //-- Nao Consta Entrada do Visitante.  
	          
	      //-- Se Nao for Saida posiciona no Campo Data de Entrada 
         If loEncho .AND. nOpx <> 7  
		  	fPosEnchoice(oEnchoice, "PY_DATAE")
		 Endif  	 
			  
	     Break   
	     
      Endif 
       
      //-- Foi Fornecida a Data de Saida e DataHora informada eh inferior a DataHora de Entrada
      If !Empty(M->PY_DATAS) .AND. (DataHora2Str(M->PY_DATAS, M->PY_SAIDA) < DataHora2Str(M->PY_DATAE, M->PY_ENTRADA))
	     lRet:=.F.
       	 Help(" ",1,"PN340DTMAE")   //-- Data da Marcacao Anterior a Data de Entrada.
	     Break 
	  Endif 
	  
	   //-- Foi Fornecida a Hora de  Entrada e Data informada eh Nula
      If !EMPTY(M->PY_ENTRADA) .AND. EMPTY(M->PY_DATAE)
	     lRet:=.F.
       	 Help(" ",1,"NVAZIO")   //-- Sem data de Entrada    
          
          //-- Se Nao for Entrada posiciona no Campo Data de Saida 
         If loEncho .AND. nOpx <> 6
	   	 	 fPosEnchoice(oEnchoice, "PY_DATAE")
	  	 Endif  	 
	  
         Break        
      Endif  
	  
	  //-- Foi Fornecida a Hora de  Saida e Data Saida informada eh Nula
      If !EMPTY(M->PY_SAIDA) .AND. EMPTY(M->PY_DATAS)
	     lRet:=.F.
       	 Help(" ",1,"NVAZIO")   //-- Sem data de Saida    
          
         If loEncho 
	   	 	 fPosEnchoice(oEnchoice, "PY_DATAS")
	  	 Endif  	 
	  
         Break        
      Endif 
      
      //-- Foi Fornecida a Data de Baixa e Data Saida informada eh Nula
      If !EMPTY(M->PY_DTBAIXA) .AND. EMPTY(M->PY_DATAS)
	     lRet:=.F.
       	 Help(" ",1,"NVAZIO")   //-- Sem data de Saida    
          
         If loEncho 
	   	 	 fPosEnchoice(oEnchoice, "PY_DATAS")
	  	 Endif  	 
	  
         Break        
      Endif   
      
	  //-- Foi Fornecida a Data de Baixa e eh menor que a Data Saida informada 
      If !EMPTY(M->PY_DTBAIXA) .AND. ( M->PY_DTBAIXA < M->PY_DATAS )
	     lRet:=.F.
       	 Help(" ",1,"PN340DTVB")   //-- Data Baixa menor que Data de Saida    
          
         If loEncho 
	   	 	 fPosEnchoice(oEnchoice, "PY_DTBAIXA")
	  	 Endif  	 
	  
         Break        
      Endif  

	  //-- Foi Fornecida a Data de Entrada e eh menor que a Data Visitada informada 
      If !Empty(M->PY_DATAE) .AND. ( M->PY_DATAE < M->PY_DTVISIT )
	     lRet:=.F.
       	 MsgAlert( OemToAnsi( STR0125) , STR0034 )	//-- Data de Entrada Anterior a Data de Visita.
	     Break 
	  Endif

	// Valida se jА existe uma visita para mesma data e hora.
	If !Pn340VDtVisit(M->PY_VISITA,M->PY_DTVISIT)
		lRet := .F.
		Break
	EndIf
      
End

Return(lRet)

/*
зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340LinOk  ЁAutorЁMauricio MR            Ё Data Ё27/11/2003Ё
цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё                                                            Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁPn340LinOk( oBrowse )									    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ 															Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Function Pn340LinOk( oBrowse)

Local aCposKey		:= {}
Local lLinOk		:= .T.
Local nPosEntrada	:= 0.00
Local nPosSaida		:= 0.00

nPosSaida	:= Ascan(aCols,{|x| x[nPosSPZTpMarca] == '2'})
nPosEntrada	:= Ascan(aCols,{|x| x[nPosSPZTpMarca] == '1'}) 

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Altera o Estado do Cursor  								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

CursorWait()

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Evitar que os Inicializadores padroes sejam carregados indeviЁ
	Ё damente													   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

	PutFileInEof( "SPZ" )
	
	Begin Sequence
	
	   
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Se a Linha da GetDados Nao Estiver Deletada				   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		
		IF !( GdDeleted() )   
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Verifica Se o Campos Estao Devidamente Preenchidos		   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			
			aAdd( aCposKey , "PZ_DATA" )
			IF !( lLinOk := GdNoEmpty( aCposKey ) )
		    	Break
			EndIF
	        
	        //-- Se Lancamento for uma Marcacao
	        If aCols[n,nPosSPZTpMarca] == '3'
	           //-- Verifica a Marcacao em Relacao a Entrada
	           If Empty(nPosEntrada)
	              lLinOk:= .F.
	              Break 
		       Endif                                     
		       
		       If DataHora2Str(aCols[n		 	 , nPosSPZData], aCols[n			, nPosSPZHora] ) < ;
		          DataHora2Str(aCols[nPosEntrada , nPosSPZData], aCols[nPosEntrada	, nPosSPZHora] )
			       lLinOk:= .F.
               		Help(" ",1,"PN340DTMAE")   //-- Data da Marcacao Anterior a Entrada
	              Break 
		       Endif 
	           //-- Verifica a Marcacao em Relacao a Saida
		       If !Empty(nPosSaida)
	              If DataHora2Str(aCols[n		     , nPosSPZData], aCols[n			, nPosSPZHora] ) > ;
		          		DataHora2Str(aCols[nPosSaida , nPosSPZData], aCols[nPosSaida   	, nPosSPZHora] )
			       		lLinOk:= .F.
               			Help(" ",1,"PN340DTMAS")   //-- Data da Marcacao Apos a Saida
	              		Break 
		       	  Endif 
		       Endif
		       
		    Endif   
		EndIF
		
	End Sequence
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁSe Houver Alguma Inconsistencia na GetDados, Seta-lhe o Foco  Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	
	IF !( lLinOk )
		oBrowse:SetFocus()
	EndIF

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Restaura o Estado do Cursor								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

CursorArrow()

Return( lLinOk )             

/*
зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340TudOk  ЁAutorЁMauricio MR            Ё Data Ё27/11/2003Ё
цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё                                                            Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁPn340TudOk( oBrowse )									    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ 															Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Function Pn340TudOk( oBrowse )

Local lTudoOk 	:= .T.
Local nLenaCols	:= 0
Local n			:= 0
/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Altera o Estado do Cursor  								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

CursorWait()
	Begin Sequence
	
	    /*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Percorre Todas as Linhas para verificar se Esta Tudo OK      Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		nLenaCols:= Len( aCols )
		
		For n := 1 To Len( aCols )
			IF !( lTudoOk := Pn340LinOk( oBrowse ) )
				oBrowse:Refresh()
				Break
			EndIF
		Next n
	
	End Sequence
	                 
	//-- Libera aCols em branco quando nenhuma informacao foi digitada
	IF ( fCompArray( aCols, aSPZClone) )
		lTudoOk:= .T.
    Endif
/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Restaura o Estado do Cursor								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

CursorArrow()

Return( lTudoOk  )


/*
зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340DelOk  ЁAutorЁMauricio MR            Ё Data Ё05/12/2003Ё
цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁValidar a Delecao na GetDados                               Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁPn340DelOk( oBrowse )									    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ 															Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPn340DelOk	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function Pn340DelOk(oBrowse)
         
Local lDelOk 		:= .T.
Local nPos			:= 0.00

Begin Sequence

	If !( GdDeleted() )                                          
	     If aCols[n, nPosSPZTPMARCA] == '1' 
	        If !Empty(nPos:= aScan( aCols , { |x| x[nPosSPZTPMARCA] == "2" } ) )
	           	lDelOk:= .F.
	           	Help(" ",1,"PN340DEL_S") //- Elimine a Saida primeiramente.
	           	Break       
	        Endif
	     ElseIf aCols[n, nPosSPZTPMARCA] == '2'      	                    
	            M->PY_DTBAIXA:=CTOD('')
	     Endif
	Endif

End Sequence
	
Return( lDelOk )

/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340Grava   ЁAutorЁMauricio MR           Ё Data Ё27/11/2003Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё                                                            Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Static Function Pn340Grava(		nOpc		,;	//Opcao de Acordo com aRotina
							 	nReg		,;	//Numero do Registro do Arquivo Pai ( SPY )
							 	aSPYHeader	,;	//Campos do Arquivo Pai ( SPY )
							 	aSPYVirtEn	,;	//Campos Virtuais do Arquivo Pai ( SPY )
							 	aSPYMemoEn  ,;  //Campo Memo
							 	aSPZHeader	,;	//Campos do Arquivo Filho ( SPZ )
							 	aSPZCols	,;	//Itens do Arquivo Filho ( SPZ )
							 	aSPZVirtGd	,;	//Campos Virtuais do Arquivo Filho ( SPZ )
							 	aSPZRecnos	 ;	//Recnos do Arquivo Filho ( SPZ )
							  )


Local lLock			:= .F.
Local aSPYPutMsMm	:= {}
Local cMsgErr		:= ""
Local nCpoMemo		:= 0.00
Local nChoice		:= 0.00
Local nChoices		:= 0.00
Local nHeader		:= 0.00
Local nHeaders		:= 0.00
Local nCol			:= 0.00
Local nCols			:= 0.00
Local nRecno		:= 0.00
Local nRecnos		:= 0.00        
Local nDeleted		:= GdFieldPos( "GDDELETED" , aSPZHeader )

  
DEFAULT nOpc		:= 0.00
DEFAULT nReg		:= 0.00
DEFAULT aSPYHeader	:= {}
DEFAULT aSPYVirtEn	:= {}
DEFAULT aSPYMemoEn	:= {}
DEFAULT aSPZHeader	:= {}
DEFAULT aSPZCols	:= {}
DEFAULT aSPZVirtGd	:= {}
DEFAULT aSPZRecnos	:= {}

nChoices			:= Len(	aSPYHeader	)
nHeaders			:= Len(	aSPZHeader	)
nCols				:= Len(	aSPZCols	)
nRecnos				:= Len( aSPZRecnos	)

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Se for Exclusao ( nOpc == 5 )								   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
IF ( nOpc == 5 )
	IF !Empty( nReg )
		Begin Transaction
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Deleta os Memos											   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			MsMmDel( "SPY" , { nReg } , aSPYMemoEn )
			PonDelRecnos( "SPZ" , aSPZRecnos )
			PonDelRecnos( "SPY" , { nReg } )

		End Transaction
	EndIF
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Se for Inclusao/Alteracao ( nOpc == 3 .or. nOpc == 4 )	   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
ElseIF ( nOpc == 3 .or. nOpc == 4 )
	Begin Transaction
		IF !Empty( nReg )
			SPY->( MsGoto( nReg ) )
			lLock := RecLock( "SPY" , .F. , .F. )
		Else
			lLock := RecLock( "SPY" , .T. , .F. )
		EndIF 
		
		IF !( lLock )
			Break
		EndIF
        
        SPY->PY_FILIAL := xFilial('SPY')              	
		
		For nChoice := 1 To nChoices
			IF ( aScan( aSPYVirtEn , { |cCpo| ( cCpo == aSPYHeader[ nChoice , 02 ] ) } ) == 0.00 )
				
				SPY->( &( aSPYHeader[ nChoice , 02 ] ) ) :=FormataCampo( aSPYHeader[ nChoice , 02 ], aSPYHeader[ nChoice , 08 ], aSPYHeader[ nChoice , 04 ], aSPYHeader[ nChoice , 05 ],&( "M->"+aSPYHeader[ nChoice , 02 ] ) )

			ElseIF ( ( nCpoMemo := aScan( aSPYMemoEn , { |cCpo| ( cCpo[1] == aSPYHeader[ nChoice , 02 ] ) } ) ) > 0.00 )
				/*
				здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				Ё Armazena as Informacoes que serao gravadas no SYP      	   Ё
				юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
				SPY->( aAdd( aSPYPutMsMm , { Recno() , &("SPY->"+aSPYMemoEn[nCpoMemo,02]) , &( "M->"+aSPYHeader[ nChoice , 02 ] ) , aSPYMemoEn[nCpoMemo,02] } ) )
			EndIF
		Next nChoice

		IF nOpc == 3
		   SPY->PY_NUMERO:= GetSX8NUM("SPY","PY_NUMERO")
		Endif

		SPY->( MsUnLock() )
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Grava as Informacoes no SYP                           	   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		If nOpc ==3 .and. lPona340Aut .and. ! Empty(cMemoAut)
			MSMM(,80,,cMemoAut,1,,,"SPY","PY_CODHIST")
 		EndIf
		nChoices := Len( aSPYPutMsMm )
		For nChoice := 1 To nChoices
			SPY->( dbGoto( aSPYPutMsMm[ nChoice , 01 ] ) )
			MsMm( aSPYPutMsMm[ nChoice , 02 ] , NIL , NIL , aSPYPutMsMm[ nChoice , 03 ] , 1 , NIL , NIL , "SPY" , aSPYPutMsMm[ nChoice , 04 ] )
		Next nChoice
		
		IF ( nRecnos == nCols )
			For nRecno := 1 To nRecnos
				SPZ->( dbGoto( aSPZRecnos[ nRecno ] ) )
				IF !RecLock( "SPZ" , .F. , .F. )
					Loop
				EndIF
				IF !( aSPZCols[ nRecno , nDeleted ] )
					For nHeader := 1 To nHeaders
						IF ( aScan( aSPZVirtGd , { |cCpo| ( cCpo == aSPZHeader[ nHeader , 02 ] ) } ) == 0.00 )
							SPZ->( &( aSPZHeader[ nHeader , 02 ] ) ) := FormataCampo( aSPZHeader[ nHeader , 02 ], aSPZHeader[ nHeader , 08 ], aSPZHeader[ nHeader , 04 ], aSPZHeader[ nHeader , 05 ], aSPZCols[ nRecno , nHeader ] )
						ElseIF ( ( nCpoMemo := aScan( aSPYMemoEn , { |cCpo| ( cCpo[1] == aSPYHeader[ nChoice , 02 ] ) } ) ) > 0.00 )
							/*
							здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							Ё Armazena as Informacoes que serao gravadas no SYP      	   Ё
							юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
								SPY->( aAdd( aSPYPutMsMm , { Recno() , &("SPY->"+aSPYMemoEn[nCpoMemo,02]) , &( "M->"+aSPYHeader[ nHeader , 02 ] ) , aSPYMemoEn[nCpoMemo,02] } ) )
						EndIF
					Next nHeader 
					/*
					здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					Ё Grava as Informacoes no SYP                           	   Ё
					юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
					nChoices := Len( aSPYPutMsMm )
					For nChoice := 1 To nChoices
						SPY->( dbGoto( aSPYPutMsMm[ nChoice , 01 ] ) )
						MsMm( aSPYPutMsMm[ nChoice , 02 ] , NIL , NIL , aSPYPutMsMm[ nChoice , 03 ] , 1 , NIL , NIL , "SPY" , aSPYPutMsMm[ nChoice , 04 ] )
					Next nChoice
				Else
					MsMmDel( "SPY" , { nReg } , aSPYMemoEn )
					IF !SPZ->( FkDelete( @cMsgErr ) )
						SPZ->( RollBackDelTran( cMsgErr ) )
					EndIF
				EndIF
				SPZ->( MsUnlock() )
			Next nRecno
		ElseIF ( nRecnos < nCols )
			For nRecno := 1 To nRecnos
				SPZ->( dbGoto( aSPZRecnos[ nRecno ] ) )
				IF !RecLock( "SPZ" , .F. , .F. )
					Loop
				EndIF
				IF !( aSPZCols[ nRecno , nDeleted ] )
					SPZ->PZ_FILIAL		:= SPY->PY_FILIAL
					SPZ->PZ_VISITA  	:= SPY->PY_VISITA
					SPZ->PZ_CRACHA  	:= SPY->PY_CRACHA
					SPZ->PZ_DATA  		:= SPY->PY_DTVISIT
					SPZ->PZ_NUMERO 		:= SPY->PY_NUMERO
					For nHeader := 1 To nHeaders
						IF ( aScan( aSPZVirtGd , { |cCpo| ( cCpo == aSPZHeader[ nHeader , 02 ] ) } ) == 0.00 )
							SPZ->( &( aSPZHeader[ nHeader , 02 ] ) ) := FormataCampo( aSPZHeader[ nHeader , 02 ], aSPZHeader[ nHeader , 08 ], aSPZHeader[ nHeader , 04 ], aSPZHeader[ nHeader , 05 ], aSPZCols[ nRecno , nHeader ] )
						ElseIF ( ( nCpoMemo := aScan( aSPYMemoEn , { |cCpo| ( cCpo[1] == aSPYHeader[ nChoice , 02 ] ) } ) ) > 0.00 )
							/*
							здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							Ё Armazena as Informacoes que serao gravadas no SYP      	   Ё
							юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
								SPY->( aAdd( aSPYPutMsMm , { Recno() , &("SPY->"+aSPYMemoEn[nCpoMemo,02]) , &( "M->"+aSPYHeader[ nHeader , 02 ] ) , aSPYMemoEn[nCpoMemo,02] } ) )
						EndIF
					Next nHeader 
					/*
					здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					Ё Grava as Informacoes no SYP                           	   Ё
					юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
					nChoices := Len( aSPYPutMsMm )
					For nChoice := 1 To nChoices
						SPY->( dbGoto( aSPYPutMsMm[ nChoice , 01 ] ) )
						MsMm( aSPYPutMsMm[ nChoice , 02 ] , NIL , NIL , aSPYPutMsMm[ nChoice , 03 ] , 1 , NIL , NIL , "SPY" , aSPYPutMsMm[ nChoice , 04 ] )
					Next nChoice
				Else   
					MsMmDel( "SPY" , { nReg } , aSPYMemoEn )
					IF !SPZ->( FkDelete( @cMsgErr ) )
						SPZ->( RollBackDelTran( cMsgErr ) )
					EndIF
				EndIF
				SPZ->( MsUnlock() )
			Next nRecno	
			For nCol := nRecno To nCols
				IF !( aSPZCols[ nCol , nDeleted ] )
					IF !RecLock( "SPZ" , .T. , .F. )
						Loop
					EndIF
					SPZ->PZ_FILIAL		:= SPY->PY_FILIAL
					SPZ->PZ_VISITA  	:= SPY->PY_VISITA
					SPZ->PZ_CRACHA  	:= SPY->PY_CRACHA    
					SPZ->PZ_DATA  		:= SPY->PY_DTVISIT					
					SPZ->PZ_NUMERO 		:= SPY->PY_NUMERO
					For nHeader := 1 To nHeaders
						IF ( aScan( aSPZVirtGd , { |cCpo| ( cCpo == aSPZHeader[ nHeader , 02 ] ) } ) == 0.00 )
							SPZ->( &( aSPZHeader[ nHeader , 02 ] ) ) := FormataCampo( aSPZHeader[ nHeader , 02 ], aSPZHeader[ nHeader , 08 ], aSPZHeader[ nHeader , 04 ], aSPZHeader[ nHeader , 05 ], aSPZCols[ nCol , nHeader ] )
						ElseIF ( ( nCpoMemo := aScan( aSPYMemoEn , { |cCpo| ( cCpo[1] == aSPYHeader[ nChoice , 02 ] ) } ) ) > 0.00 )
								/*
								здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
								Ё Armazena as Informacoes que serao gravadas no SYP      	   Ё
								юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
								SPY->( aAdd( aSPYPutMsMm , { Recno() , &("SPY->"+aSPYMemoEn[nCpoMemo,02]) , &( "M->"+aSPYHeader[ nHeader , 02 ] ) , aSPYMemoEn[nCpoMemo,02] } ) )
						EndIF
					Next nHeader 
					/*
					здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					Ё Grava as Informacoes no SYP                           	   Ё
					юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
					nChoices := Len( aSPYPutMsMm )
					For nChoice := 1 To nChoices
						SPY->( dbGoto( aSPYPutMsMm[ nChoice , 01 ] ) )
						MsMm( aSPYPutMsMm[ nChoice , 02 ] , NIL , NIL , aSPYPutMsMm[ nChoice , 03 ] , 1 , NIL , NIL , "SPY" , aSPYPutMsMm[ nChoice , 04 ] )
					Next nChoice
					SPZ->( MsUnlock() )
				EndIF
			Next nCol
		EndIF

	End Transaction

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё ATENCAO: Nao Colocar Dentro de Transacao	o comando abaixo   Ё
	Ё Confirmando a Numeracao Automatica          				   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( nOpc == 3 .and. ( __lSX8 ) )
		While ( GetSX8Len() > nGetSX8Len )
			ConfirmSX8()
		End While
	EndIF
	
EndIF

// - ObtИm o Зltimo registro Alterado/Incluido/Visualizado para posicionamento no browse.
nLastRec := SPY->( Recno() )

Return( NIL )


/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁFormataCampo ЁAutorЁMauricio MR           Ё Data Ё27/11/2003Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁConverte campo para o Formato de Gravacao                   Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function FormataCampo(cCampo, cTipo, nTam, nDecimal, xConteudo)

DEFAULT xConteudo:= &( "M->"+cCampo )
 
If Substr(cCampo,3)$'HORA.ENTRADA.SAIDA.DTVISIT.DTBAIXA'
   xConteudo:= (Substr(StrTran(xConteudo,":", "."),1,nTam))
Endif   

If cTipo == 'N' .AND. ValType(xConteudo) == 'C'
   xConteudo:= Val(xConteudo)
Endif

Return xConteudo
                    
/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340PesqBrw ЁAutorЁMauricio MR           Ё Data Ё09/08/2004Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё Trata Pesquisa com Filtro                                  Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Function Pn340PesqBrw( cAlias , nReg )                       
If AxPesqui() == 1
  	nOrdPesq	:= SPY->(IndexOrd())
	Eval(bFiltraBrw,fExpFiltro(aFilterExp,.F., lMudFVis,lVerGrpUsr)) 
Endif
Return (.T.)

/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340Filtro  ЁAutorЁMauricio MR           Ё Data Ё27/11/2003Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё Refaz o Filtro do mBrowse                                  Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Function Pn340Filtro()

//-- Obtem a Expressao de Filtro Adicional da Rotina
cExpFiltro:= fExpFiltro(@aFilterExp,Nil, .T., lVerGrpUsr)

//--Cancela Filtros Anteriores  
Eval(bEndFilBrw) 
               
//--Executa Filtro do RH mais o Filtro Adicional da Rotina 
SPY->(DbSetOrder(nOrdPesq))
Eval(bFiltraBrw,cExpFiltro)

Return( MBrChgLoop( .F. ) )                             


/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁPn340KeepFiltЁAutorЁMauricio MR           Ё Data Ё20/07/2005Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё Mantem o indice de entrada                                 Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Function Pn340KeepFilt(lxMudFVis, lxVerGrpUsr)

Local nIndex 			:= 0 

DEFAULT lxMudFVis		:= lMudFVis
DEFAULT lxVerGrpUsr		:= lVerGrpUsr


If Empty(cExpFiltro)
	//--Executa Filtro do RH mais o Filtro Adicional da Rotina 
	//--IMPORTANTE: Nao retire esse filtro MALUCO pois ele garante
	//--que tenhamos pelo menos um indice na saida da rotina quando
	//--entramos nela filtrados e saimos sem nenhum filtro selecionado.
	//--O mBrowse tenta setar o indice que foi entrado.
	Eval(bFiltraBrw,If(Empty(cExpFiltro),"1 == 1",cExpFiltro))

	//--Posiciona num Indice Valido
	If !Empty((nIndex:=Len(aIndex))) 
  		SPY->(DbSetOrder( Indexord() ) )
 	Else
		cExpFiltro:=fExpFiltro(aFilterExp, .F., lxMudFVis, lxVerGrpUsr)
		Eval(bFiltraBrw, cExpFiltro)
//		SPY->(dbSetOrder(nOrdPesq))
 	Endif
Else

  	Eval(bEndFilBrw) 
	Eval(bFiltraBrw,cExpFiltro) 
//	SPY->(dbSetOrder(nOrdPesq)) 
Endif          

Return( .T. )                             


/*
зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁfExpFiltro   ЁAutorЁMauricio MR           Ё Data Ё10/08/2004Ё
цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o Ё REcupra Expressao de Filtro                                Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁPona340()	                                                Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function fExpFiltro(aFilterExp, lBuildExp, lMudFVis,lVerGrpUsr)
Local nPos					:= 0.00   
Local aCloneFilterExp		:= aClone(aAlsFilterExp) 
Local aFiltros				:= {}
Local cRetFiltro			:= ""
Local lForceReadFilter		:= Empty(aFilterExp)

DEFAULT lBuildExp			:= .T.
DEFAULT lMudfVis			:= .T.
DEFAULT lVerGrpUsr			:= .F.
//-- Se a expressao de filtro deva ser checada obtem a ultima expressao selecionada
//-- a partir do arquivo Crit_Sel no \Profile. Inclusive pode ser uma expressao salva
//-- por outro usuario. 

If lMudFVis 
	If lVerGrpUsr
		//-- Monta Expressao de Filtro conforme Alias, Programa, Grupo e Usuario
		aEval(aGrpFilter,{|X| AADD(aCloneFilterExp, x) } )
		
		If !Empty((aFiltros := GpFiltro( aCloneFilterExp , .F. , .F. ))) 
			aFilterExp		:= aClone(aCloneFilterExp) 
		Else
			aCloneFilterExp	:= aClone(aFilterExp) 
		Endif
		
		aEval(aUsrFilter,{|X| AADD(aCloneFilterExp, x) } )
		If !Empty((aFiltros := GpFiltro( aCloneFilterExp , .F. , .F. )))
			aFilterExp:=aClone(aCloneFilterExp)
		Endif 
	Endif
	
	//-- Abre Janela ( se solicitada) e ativa o filtro escolhido
	aFiltros := GpFiltro( aFilterExp , lBuildExp , .F. )
	
	nPos := 0 	
	nPos := Ascan(aFiltros,{|X|X[1]=="SPY"})
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁMonta a expressao do filtro                                     Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If nPos > 0.00  
		cRetFiltro	:=	aFiltros[nPos][2]	
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁRecupera o Valor Original da Expressao de Filtro se o Usuario   Ё
	//Ёcancelou a escolha/definicao de filtros						   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
	If !GpFltBtnOk()
		cRetFiltro:= cExpFiltro
	Else
		cExpFiltro:= cRetFiltro 
	Endif
Endif
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁGarante que o conteudo do filtro recupere todas as ocorrencias  Ё
//Ёno caso do mesmo nao existir.								   Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды	
If Empty(cExpFiltro)
   cExpFiltro := "1==1"
Endif   
Return(cExpFiltro)

/*
зддддддддддбддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPn340OpcFiltЁ Autor ЁMauricio MR           Ё Data Ё01/12/2003Ё
цддддддддддеддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁDialogo para Obter Opcoes de Filtro							 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL															 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     												 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Function Pn340OpcFilt( dIniPer, dFimPer )

Local aSvKeys		:= GetKeys()
Local aAdvSize		:= MsAdvSize( .F. , .T. , 25 )
Local bSet15		:= { || NIL }
Local bSet24		:= { || NIL }
Local oDlg 			:= NIL
Local oFont			:= NIL
Local oGroup1		:= NIL

     
DEFINE FONT oFont NAME "Arial" SIZE 0,-11 BOLD
DEFINE MSDIALOG oDlg TITLE OemToAnsi( cCadastro + " - " + STR0017 ) From aAdvSize[7],0 TO aAdvSize[6]*.7,aAdvSize[5] OF oMainWnd PIXEL	//"Cadastro de Visitas" - "Filtro"

@ 015 , 003	GROUP oGroup1 TO 050,315 LABEL OemToAnsi(STR0018) OF oDlg PIXEL		//"Filtro de Visitas"
oGroup1:oFont:=oFont


@ 034 , 007 SAY OemToAnsi( STR0019 )	SIZE	100,10 OF oDlg PIXEL FONT oFont	//"Periodo: "
@ 030 , 060 GET dIniPer					SIZE	100,10 OF oDlg PIXEL FONT oFont	Valid (dIniPer<=dFimPer)
@ 030 , 170 GET dFimPer					SIZE	100,10 OF oDlg PIXEL FONT oFont	Valid (dFimPer >=dIniPer)
    
bSet15	:= { || oDlg:End() }
bSet24	:= { || oDlg:End() }

ACTIVATE MSDIALOG oDlg CENTERED ON INIT EnchoiceBar( oDlg , bSet15 , bSet24  ) 

RestKeys( aSvKeys , .T. )

Return(Nil)
            
/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPnVVisita   	Ё Autor ЁMauricio MR           Ё Data Ё01/12/2003Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁValida Codigo do Visitante										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Function PnVVisita(cCodVisita, lFree)
Local lRet		:= .T.    

DEFAULT lFree:= .T.

If !Empty(cCodVisita)
	If ExistCPO("SPW",cCodVisita) .AND. Val(cCodVisita) > 0.00
		M->PY_NOME	:= ALLTRIM(Posicione("SPW",1,xFilial("SPW")+cCodVisita,"PW_NOMFULL"))
	Else
	   lRet			:= .F.              
	   Help(" ",1,"PN340NOVIS") // Codigo de Visitante nao Encontrado
	Endif
Endif


If (lRet .AND. lFree)
   lRet:= FreeForUse("SPW",M->PY_VISITA)    
Endif 

If lRet .AND. !Empty(cCodVisita) .AND. GETSX3CACHE("PY_BITMAP","X3_CAMPO")<> NIL  
   M->PY_BITMAP:=SPW->PW_BITMAP
ENDIF   

Return (lRet) 

/*
зддддддддддбддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPnVMat		Ё Autor ЁMauricio MR           Ё Data Ё01/12/2003Ё
цддддддддддеддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁValida o Codigo de Matricula do Funcionario					 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL															 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     												 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Function PnVMat(cCodMat, lValid)
Local lRet		:= .T.
Local aArea		:=GetArea()
Local aSRAArea	:=SRA->(GetArea())
Local nPos		:= 0	
Default lValid := .T. // Quando a chamada da funГЦo vem do fonte o lValid И .F. e quando vem do Valid do PY_MAT o lValid И .T. 


M->PY_MAT:=If(!Empty(cCodMat), cCodMat, M->PY_MAT)

If !lPona340Aut
	If Alltrim(UPPER(ReadVar())) ==  "M->PY_MAT"  .OR. !EMPTY(M->PY_MAT)
		If !Empty(M->PY_MAT) .AND. ExistCpo("SRA", M->PY_MAT)
			If(lValid)
				SRA->(DBSEEK(fFilfunc('SRA')+M->PY_MAT))
			Else
		    	SRA->(DBSEEK(SPY->PY_FILIAL+M->PY_MAT))
		    EndIf
		    M->PY_CONTATO	:= SRA->RA_NOME	    
		   	M->PY_CC		:= SRA->RA_CC
			M->PY_DESCCC	:= Upper( AllTrim( fDesc("CTT",M->PY_CC,"CTT_DESC01",,XFILIAL('CTT') ) ) )
		Else                               
	    	IF !EMPTY(M->PY_MAT)
		    	M->PY_MAT		:= SPACE(aTamMat[1]) 
	    	    lRet			:= .F.    
	    	Endif
	    	    
		Endif	
	Endif
	IF EMPTY(M->PY_MAT)
    	M->PY_CONTATO 	:= SPACE(LEN(M->PY_CONTATO))  
    Endif
	If TYPE("OENCHOICE") <>"U" .AND. !( ValType(oEnchoice:aEntryCtrls[1]) == "U" )
		fPosEnchoice(oEnchoice, "PY_MAT",.F.,@nPos)   
	    If nPos > 0
		    oEnchoice:aEntryCtrls[ nPos ]:Cargo:= M->PY_MAT
	  		oEnchoice:aEntryCtrls[ nPos ]:Refresh()
	    Endif
    Endif
Endif

RestArea(aSRAArea)
RestArea(aArea)

Return (lRet) 

/*
зддддддддддбдддддддддддддддддбдддддддбдддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfLiberaGet	  	 Ё Autor ЁMauricio MR      Ё Data Ё22/07/2003Ё
цддддддддддедддддддддддддддддадддддддадддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁLibera a Digitacao de Grupo e Eventos correspondentes.       Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁfLiberaGet()		  										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁVer abaixo												 	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL                                                  	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONA320                                                      Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function fLiberaGet(oEnchoice, nOpc) 
Local aSvKeys	:= GetKeys()
Local lRet		:=.T.

IF ( nOpc == 3 ) .or. ( nOpc == 4 ) .or. ( nOpc == 6 ) .or. ( nOpc == 7 ) 
	IF ! Obrigatorio( oEnchoice:aGets , oEnchoice:aTela )   
     lRet:= .F.
	Endif    
Endif    

RestKeys( aSvKeys , .T. )

Return (lRet)            
                                                                    

/*
 зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©  
 ЁFun┤└o    ЁfFilVisit Ё Autor ЁEquipe Advanced RH     Ё Data Ё09/10/2003Ё  
 цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢  
 ЁDescri┤└o ЁRetorna a filial a ser utilizada para Pesquisa/Grava┤└o no  Ё  
 Ё          Ёarquivo desejado, sempre com base na Filial do Visitante.   Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁSintaxe   Ё fFilVisit(cVar)                                            Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁPar┐metrosЁ cVar = Alias do arquivo cuja filial se deseja Pesq./Gravar Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁUso       Ё Gen┌rico                                                   Ё  
 юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
 */
Function fFilVisit(cAlias )

DEFAULT cAlias	:= Alias()

Return( xFilial( Upper( AllTrim( cAlias ) ) , IF( Select( "SPW" ) > 0.00 , SPW->PW_FILIAL , cFilAnt ) ) )

/*
 зддддддддддбддддддддддддддбдддддддбдддддддддддддддддддбддддддбдддддддддд©  
 ЁFun┤└o    ЁfPosEnchoice  Ё Autor ЁEquipe Advanced RH Ё Data Ё09/10/2003Ё  
 цддддддддддеддддддддддддддадддддддадддддддддддддддддддаддддддадддддддддд╢  
 ЁDescri┤└o ЁObtem foco de determinado campo da Enchoice				 Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁSintaxe   Ё fPosEnchoice(oEnchoice, cCampo)                            Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁPar┐metrosЁ 															 Ё  
 цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢  
 ЁUso       Ё Gen┌rico                                                   Ё  
 юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды  
 */
Static Function fPosEnchoice(oEnchoice, cCampo, lPosiciona, nPosField)
  Local cReadVar:= ''
  Local cCpoVld	:= ''
  Local	nCtrls 	:= Len( oEnchoice:aEntryCtrls )
  Local nCtrl	:= 0.00
  
  DEFAULT lPosiciona	:= .T.                
 
  For nCtrl := 1 To nCtrls
  	   cReadVar := oEnchoice:aEntryCtrls[ nCtrl ]:cReadVar 
  	   cCpoVld	:= Upper( AllTrim( StrTran( cReadVar , "M->" , "" ) ) )
  	   If !(cCpoVld == ALLTRIM(UPPER(cCampo)))
  	      Loop
  	   Endif   
  	   
  	   //-- Obtem a posicao do campo
  	   If nPosField <> NIL
	  	   nPosField:= nCtrl
 	   Endif
 	   
 	   If lPosiciona
	 	   oEnchoice:aEntryCtrls[ nCtrl ]:SetFocus() 
 	   Endif
       
       Exit
  Next nCtrl 
  
Return Nil  	


/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁGDSPZMontaCols	Ё Autor ЁMauricio MR           Ё Data Ё01/12/2003Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁMonta aCols do SPZ - Acessos									 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Function GDSPZMontaCols(aAcessos, aCols, aRecnos)

Local nPos			:= 0.00
Local nAcessos		:= Len(aAcessos)  

aCols:= {}

For nPos:= 1 To nAcessos
	aAdd(aCols ,	{	aAcessos[nPos,01]	,;	//01 - Data
						aAcessos[nPos,02]	,;	//02 - Hora
						aAcessos[nPos,03]	,;	//03 - Relogio
						aAcessos[nPos,04]	,;	//04 - TpMarca
						aAcessos[nPos,05]	,;	//05 - Flag de Marcacao
						aAcessos[nPos,06]	,;	//06 - Funcao
						aAcessos[nPos,07]	,;	//07 - Giro
						"SPZ"				,;	//08 - Alias					
						aAcessos[nPos,08]	,;	//09 - Recno						
						.F.				 	;								 
					 };
		 )
	
	AADD(aRecnos,aAcessos[nPos,8]) 
Next nPos

Return (Nil)

/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁFGETVISITANTE	Ё Autor ЁMauricio MR           Ё Data Ё08/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁObtem o Nome do Visitante - Uso em Inic Browse					 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

FUNCTION FGETVISITANTE()
RETURN(Posicione("SPW",1,SPY->PY_FILIAL+SPY->PY_VISITA,"PW_NOMFULL"))	

/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁFGETCONTATO		Ё Autor ЁMauricio MR           Ё Data Ё08/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁObtem o Nome do Funcionario - Uso em Inic Browse				 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
FUNCTION FGETCONTATO()
RETURN(Posicione("SRA",1,SPY->PY_FILIAL+SPY->PY_MAT,"RA_NOME"))	

/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁFGETCC			Ё Autor ЁMauricio MR           Ё Data Ё08/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁObtem a Descricao do Cento de Custo - Uso em Inic Browse		 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
FUNCTION FGETCC()
cRet:= ""
If !EMPTY(PY_MAT)
	cRet:=fDesc("CTT",SPY->PY_CC,"CTT_DESC01",,xFilial("CTT",SPY->PY_FILIAL))	
Endif	

RETURN(cRet)


/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfImprime		Ё Autor ЁMauricio MR           Ё Data Ё08/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁExecuta Rotina de Impressao Individual de Etiquetas para Cracha	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/  
Static Function fImprime()
                                  
If EMPTY(M->PY_VISITA) 
   Help(" ",1,"PN340NOVIS") // Codigo de Visitante nao Encontrado
   Return(.F.)
Endif
	
//-- Imprime Cracha Individual
IF ExistBlock( "ETQVIST")
   ExecBlock( "ETQVIST" , .F. , .F. ,{2}, .F. )
ELSE
	GPER1017(2)
ENDIF

Return

/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfCFGEtiqueta	Ё Autor ЁMauricio MR           Ё Data Ё08/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁExecuta Rotina de Configuracao de Etiquetas para Cracah de ID	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/  
Function fCFGEtiqueta()
	
	If ExistBlock( "ETQVIST")
		ExecBlock( "ETQVIST", .F. , .F., {1}, .F. )
	Else
		// Para realizar a configuraГЦo das etiquetas И necessАrio que o RDMake ETQVIST esteja compilado no ambiente.
		// Compile o RDMake ETQVIST no ambiente para configurar e imprimir as etiquetas para visitantes. 
		// Uma versЦo atualizada desse RDMake estА disponМvel na central de downloads."
		//help( NIL, NIL, "ETQVIST", NIL, STR0126 + STR0130 + STR0128, 1 , 0,,,,,, {STR0129})
		GPER1017(1)
	EndIf
	
Return

/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfEmissao		Ё Autor ЁMauricio MR           Ё Data Ё27/01/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁExecuta Rotina de Impressao Coltivas de Etiquetas para Crachas	 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/  
Function fEmissao()
	
	If ExistBlock( "ETQVIST")
		ExecBlock( "ETQVIST", .F., .F., {3}, .F. )
	Else
		// Para realizar a emissЦo das etiquetas И necessАrio que o RDMake ETQVIST esteja compilado no ambiente.
		// Compile o RDMake ETQVIST no ambiente para configurar e imprimir as etiquetas para visitantes. 
		// Uma versЦo atualizada desse RDMake estА disponМvel na central de downloads."
		//help( NIL, NIL, "ETQVIST", NIL, STR0126 + STR0127 + STR0128, 1 , 0,,,,,, {STR0129})
		GPER1017(3)
	EndIf
	
Return
/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPn340VNum		Ё Autor ЁMauricio MR           Ё Data Ё14/02/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁValida Numero Sequencial de Visita'								 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/  
Function Pn340VNum(cNumero)
Local lRet:= .T.

DEFAULT cNumero:= If(TYPE('M->PY_NUMERO') <> 'U', M->PY_NUMERO,SPY->PY_NUMERO)
 
lRet:=ExistChav("SPY",M->PY_NUMERO) .AND. FreeForUse("SPY",M->PY_NUMERO)

Return (lRet)
 
/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPn340RNum		Ё Autor ЁMauricio MR           Ё Data Ё14/02/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁGera Numero Sequencial de Visita'								 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/ 
Function Pn340RNum()
Local xRet:= ''

xRet:=IIF(INCLUI,GetSx8Num("SPY","PY_NUMERO"),"")

Return (xRet)                            


/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPn340VCC		Ё Autor ЁMauricio MR           Ё Data Ё14/02/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁValida C.Custo													 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/  
Function Pn340VCC()
Local lRet:= .T.

If Alltrim(UPPER(ReadVar())) ==  "M->PY_CC"  .OR. !EMPTY(M->PY_CC)
	IF ((lRet:=(CTB105CC(M->PY_CC) .And. FHIST())))
		CTT->(DbsetOrder(RetOrder("CTT","CTT_FILIAL+CTT_CUSTO")))
	    M->PY_DESCCC	:= Upper( AllTrim( fDesc("CTT",M->PY_CC,"CTT_DESC01",,xFilial('CTT') ) ) )
	Endif
Endif
Return (lRet)


/*
зддддддддддбддддддддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁfProgAtual()	Ё Autor ЁMauricio MR           Ё Data Ё14/02/2004Ё
цддддддддддеддддддддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁControla recursividade de chamada de funcao via tecla programada Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/ 
Static function fProgAtual()
Local lRet			:= .T.
Local cProcName3	:= Upper( AllTrim( ProcName( 3 ) ) )
Local cProcName5	:= Upper( AllTrim( ProcName( 5 ) ) )

lRet:=( "PN340ROT" $ ( cProcName3 + cProcName5 ) )

Return (lRet) 

/*
зддддддддддбдддддддддддддддддддбдддддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁPn340VerVisitante()Ё Autor ЁMauricio MR        Ё Data Ё20/05/2005Ё
цддддддддддедддддддддддддддддддадддддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁPosiciona e Exibe o Cadastro do Visitante						 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>										 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL																 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                	      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁUso       ЁSIGAPON     													 Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/                                  
Function Pn340VerVisitante(nOpc)            
Local aSPYArea	:= GetArea("SPY")
Local aSPWArea	:= GetArea("SPW")
Local aSvKeys	:= GetKeys()

Private aNewBtn:={}

PosAlias( "SPW" , SPY->PY_VISITA, SPY->PY_FILIAL, Nil, Nil, .T. )
//AxCadVis("SPW",SPW->(Recno()),2)

Pn330Rot("SPW", SPW->(Recno()), nOpc)

RestArea(aSPWArea)
RestArea(aSPYArea)  
/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Restaura as Teclas de Atalho                				   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
RestKeys( aSvKeys, .T. )
Return( .T. )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё TmBrowse Ё Autor Ё ASV                   Ё Data Ё 16/05/05 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Funcao de timer do mbrowse                                 Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ cMBrowse -> objeto mbrowse a dar refresh                   Ё╠╠
╠╠Ё          Ё oTimer   -> objeto timer                                   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   Ё .T.                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso       Ё                                                            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function TmBrowse(oObjBrow, lMudFVis, lVerGrpUsr)
Local cIndex	:= SPY->(IndexKey())
Local cConteudo	:= &cIndex  
Local nReg		:= SPY->(Recno())

cExpFiltro:= fExpFiltro(aFilterExp,.F.,lMudFVis, lVerGrpUsr )
nOrdPesq  := SPY->(IndexOrd())

//--Cancela Filtros Anteriores  
Eval(bEndFilBrw) 

//--Executa Filtro do RH mais o Filtro Adicional da Rotina 
SPY->(DbSetOrder(nOrdPesq))
Eval(bFiltraBrw,cExpFiltro)

SET SOFTSEEK ON
SPY->(Dbseek(cConteudo))
SET SOFTSEEK OFF
If eof()
   SPY->(DbGoto(nReg))
Endif   

AtuBrw(oObjBrow)
Return .T.  

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    Ё MenuDef		ЁAutorЁ  Luiz Gustavo     Ё Data Ё30/11/2006Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁIsola opcoes de menu para que as opcoes da rotina possam    Ё
Ё          Ёser lidas pelas bibliotecas Framework da Versao 9.12 .      Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё< Vide Parametros Formais >									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONA340                                                     Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Retorno  ЁaRotina														Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ< Vide Parametros Formais >									Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/   

Static Function MenuDef()
  Local aRotina
  
  
  aEtiqueta:=          {		{ STR0022,"fCFGEtiqueta", 0 , 3}   ,; //"Cfg.Cracha"
								{ STR0023,"fEmissao"    , 0 , 2}   ;  //"Emissao"
					   }		
	


  aRotina :=         {  		{ STR0004,"Pn340PesqBrw", 0 , 1, ,.F.}	,; 	//"Pesquisar"
								{ STR0005,"Pn340Rot"	, 0 , 2}	,; 	//"Visualizar"
								{ STR0006,"Pn340Rot" 	, 0 , 3}	,; 	//"Incluir"
								{ STR0007,"Pn340Rot"	, 0 , 4}	,; 	//"Alterar"
								{ STR0008,"Pn340Rot"	, 0 , 5}	,; 	//"Excluir" 
								{ STR0015,"Pn340Rot"	, 0 , 4}	,; 	//"Entrada"
								{ STR0016,"Pn340Rot"	, 0 , 4}	,; 	//"Saida"
								{ STR0017,"Pn340Filtro"	, 0 , 3}	,; 	//"Filtro"
								{ STR0023, aEtiqueta    , 0 , 1, ,.F.}   ,;  //"Emissao"
								{ STR0012,"Pn340Leg"	, 0 , 2, ,.F.}    ;   //"Legenda"
								}	
								
  Return aRotina            

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁAtuBrw    ╨Autor  ЁLuis Artuso         ╨ Data Ё  11/02/14   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                            ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Static Function AtuBrw(oObjBrow)

oObjBrow:ResetLen()
oObjBrow:Default()
oObjBrow:Refresh()

Return .T.


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁfValidGet ╨Autor  ЁLuis Artuso         ╨ Data Ё  24/06/14   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                            ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Static Function fValidGet(nOpc,lGetDados,nOpcAlt)

Local lRet	:=	.T.
oDlg		:= oDlgBkp
nOpcAlt		:= 0

IF(	( ( nOpc == 3 ) .or. ( nOpc == 4 ) .or. ( nOpc == 6 ) .or. ( nOpc == 7 ) ) )
	
	If ( l340Block )
		lRet	:= ExecBlock("PN340VALID" , .F. , .F.)
	EndIf
	
	If ( lRet )
		
		RstEnchoVlds()
		
		If ( Obrigatorio( oEnchoice:aGets , oEnchoice:aTela ) )//Verifica os Campos Obrigatoris na Enchoice )
			If ( EnchoTudOk( oEnchoice ) )
				If ( PN340EncTOk(Nil, Nil, oEnchoice) )
					If( lGetDados )
						If !( oGetDados:TudoOk() )//Valida as Informacoes da GetDados
							lRet	:=	.F.
						EndIf
					EndIf
				Else
					lRet	:=	.F.
				EndIf
			Else
				lRet	:=	.F.
			EndIf
		Else
			lRet	:=	.F.
		EndIf
		
		If ( lRet )
			nOpcAlt := 1
			oDlg:End()
		EndIf
		
	EndIf
	
Else
	nOpcAlt := IF( nOpc == 2 , 0 , 1 ) 	//Visualizacao ou Exclusao
	oDlg:End()
EndIf

Return lRet
