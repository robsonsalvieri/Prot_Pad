#INCLUDE "PONM050.CH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "PONCALEN.CH"

Static lPnm050CposBlock		:= ExistBlock( "PNM050CPOS" )
Static lExInAs400			:= ExeInAs400()

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё PONM050  Ё Autor ЁMarinaldo de Jesus     Ё Data Ё29/06/2003Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Exclusao de Informacoes Apontadas pelo SIGAPON             Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso  	 Ё SIGAPON													  Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.             Ё╠╠
╠╠цддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁProgramador Ё Data   Ё BOPS Ё  Motivo da Alteracao                     Ё╠╠
╠╠цддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠|Marinaldo   Ё21/04/04ЁMelhorЁTratamento nos Lock dos Registros e Delete|╠╠ 
╠╠|Mauricio MR Ё28/04/04ЁMelhorЁTratamento de cFilAnt para Integridade	  |╠╠
╠╠ЁLuiz GustavoЁ06/02/07Ё      ЁRetiradas funcoes de ajuste de dicionario.Ё╠╠ 
╠╠ЁIgor FranzoiЁ10/05/07Ё      ЁVerificar campos a mais para Query p/ SRA Ё╠╠
╠╠ЁLeandro Dr  Ё25/03/08Ё      ЁInclusao de processo no pergunte, adequadoЁ╠╠
╠╠Ё            Ё        Ё      Ёpara trabalhar com objeto oPeriodo        Ё╠╠
╠╠ЁErika K.    Ё29/05/08Ё      ЁAjustes nos indices da tabela SPK para    Ё╠╠
╠╠ЁFrancisco JrЁ29/11/09Ё026092ЁAlteracao FWCODFILIAL para uso gestao     Ё╠╠
╠╠Ё            Ё        Ё /2009ЁCorporativa.                              Ё╠╠
╠╠|Glaucia C.  Ё29/08/11Ё022242ЁMelhoria das consultas SQL para DB2.TDPBEV|╠╠
╠╠юддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Function PONM050()

Local aArea			:= GetArea()
Local aRegs			:= {} //Variavel Terporaria. Devera Ser Excluida Para a Proxima Versao
Local aHelpPor	 
Local aHelpEng	 
Local aHelpSpa   
Local aSays   		:= {}
Local aButtons		:= {}
Local cSvFilAnt		:= cFilAnt
Local lBarG1ShowTm 	:= .F.
Local lBarG2ShowTm 	:= .F.
Local nOpcA			:= 0

Private lAbortPrint := .F.
Private cCadastro   := OemToAnsi(STR0001 ) // 'Elimina┤└o das Marca┤■es'
Private oPeriodo	:= RHPERIODO():New()

DEFAULT lPnm050CposBlock	:= ExistBlock( "PNM050CPOS" )
DEFAULT lExInAs400			:= ExeInAs400()

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё So Executa se os Modos de Acesso dos Arquivos Relacionados esЁ
Ё tiverm OK.											  	   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
IF ValidArqPon()

	Pergunte('PONM050', .F.)
	
	aAdd(aSays,OemToAnsi( STR0003 ) )//'Este programa tem como objetivo efetuar a Elimina┤└o de :'
	aAdd(aSays,OemToAnsi( STR0004 ) )//'- Marca┤■es(SP8)________Acumulado de Marca┤■es(SPG)'
	aAdd(aSays,OemToAnsi( STR0005 ) )//'- Apontamentos(SPC)_____Acumulados Apontamentos(SPH)'
	aAdd(aSays,OemToAnsi( STR0006 ) )//'- Refei┤■es(SP5)________Acumulado de Refei┤■es(SPN)'
	aAdd(aSays,OemToAnsi( STR0007 ) )//'- Resultados(SPB)_______Abonos(SPK)'
	aAdd(aSays,OemToAnsi( STR0008 ) )//'- Banco de Horas(SPI)___Abonos(SPK)'
	
	aAdd(aButtons, { 5,.T.,{|| Pergunte("PONM050",.T. ) } } )
	aAdd(aButtons, { 1,.T.,{|o| nOpcA := 1,IF(GpConfOK(),FechaBatch(),nOpcA := 0 ) }} )
	aAdd(aButtons, { 2,.T.,{|o| FechaBatch() }} )
		
	FormBatch( cCadastro, aSays, aButtons )
	
	IF ( nOpcA == 1 )
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Verifica se deve Mostrar Calculo de Tempo nas BarGauge			 Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		lBarG1ShowTm := ( SuperGetMv("MV_PNSWTG1",NIL,"N") == "S" )
		lBarG2ShowTm := ( SuperGetMv("MV_PNSWTG2",NIL,"S") == "S" )
		/*                               
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Executa o Processo de Exclusao de Marcacoes              			 Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		Proc2BarGauge( { || Ponm050Proc() } , STR0001 , NIL , NIL , .T. , lBarG1ShowTm , lBarG2ShowTm )  // 'Elimina┤└o das Marca┤■es'
	EndIF

EndIF	

cFilAnt := cSvFilAnt
	
RestArea( aArea )

Return( NIL )

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    ЁPonm050ProcЁAutor Ё Marinaldo de Jesus    Ё Data Ё29/06/2003Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Realizar a Dele┤└o de Registros                            Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё PonM050                                                    Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠Ё           ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.           Ё╠╠
╠╠цддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁProgramador Ё Data   Ё BOPS Ё  Motivo da Alteracao                     Ё╠╠
╠╠цддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё            Ё--------Ё------Ё                                          Ё╠╠
╠╠юддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Static Function Ponm050Proc()

//-- Defini┤└o de Variaveis Locais   
Local aAreaSRA		:= SRA->( GetArea() )
Local aAreaSP5		:= SP5->( GetArea() )
Local aAreaSP8		:= SP8->( GetArea() )
Local aAreaSPB		:= SPB->( GetArea() )
Local aAreaSPC		:= SPC->( GetArea() )
Local aAreaSPG		:= SPG->( GetArea() )
Local aAreaSPH		:= SPH->( GetArea() )
Local aAreaSPI		:= SPI->( GetArea() )
Local aAreaSPL		:= SPL->( GetArea() )
Local aAreaSPN		:= SPN->( GetArea() )
Local aAreaSPK		:= SPK->( GetArea() )
Local aRecnos		:= {}
Local aTabPadrao 	:= {}
Local aInfo			:= {}
Local aRecsBarG		:= {}
Local bSraScope		:= { || NIL }
Local cFilDe   	 	:= ""
Local cFilAte   	:= ""
Local cCCDe     	:= ""
Local cCCAte    	:= ""
Local cTurnoDe  	:= ""
Local cTurnoAte 	:= ""
Local cMatDe    	:= ""
Local cMatAte   	:= ""
Local cNomeDe   	:= ""
Local cNomeAte  	:= ""
Local cTipo     	:= ""
Local cSituacoes 	:= ''
Local cCategoria 	:= ''
Local cLimpaMotAbo	:= Space( TamSx3("PC_ABONO")[1] )	//Variavel auxiliar para preencher em branco o campo Motivo do Abono
Local nRefDe		:= ""
Local nRefAte		:= ""
Local cTpRefDe		:= ""
Local cTpRefAte		:= ""
Local cAcessaSRA 	:= &("{ || " + ChkRH("PONM050","SRA","2") + "}")
Local cLastFil		:= "__cLastFil__"  
Local cSvFilAnt		:= cFilAnt
Local cTimeIni		:= Time()
Local cMsgBarG1		:= ""
Local dPerIni		:= Ctod("//")
Local dPerFim		:= Ctod("//")
Local lDataApontamento:= .F.
Local lSP8      	:= .F.
Local lSPG      	:= .F.
Local lSPC      	:= .F.
Local lSPH      	:= .F.
Local lSP5      	:= .F.
Local lSPN      	:= .F.
Local lSPB      	:= .F.
Local lSPL			:= .F.
Local lSPI      	:= .F.
Local lSPK      	:= .F. 
Local nLimpa    	:= 2
Local nLastRec		:= 0.00
Local nIncPercG1	:= 0.00
Local nIncPercG2	:= 0.00
Local nRecsBarG		:= 0.00

#IFDEF TOP
   	Local aStruSRA		:= {}
	Local aCposSRA		:= {}
	Local aTempSRA		:= SRA->( dbStruct() )
	Local cQuery	 	:= ""
	Local cQueryCond	:= ""
	Local cRetSqlName	:= ""
	Local lSraQryOpened	:= .F.
	Local nContField	:= Len( aTempSRA	)
	Local uRet			:= NIL
	Local nX
#ENDIF

Private cProcesso		:= ''

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Carrega as Perguntas em Variaveis MV_PAR??                   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Pergunte( "PONM050" , .F. )

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Carregando as Perguntas                                      Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
cProcesso   := mv_par01
cFilDe    	:= mv_par02									//Filial De
cFilAte   	:= mv_par03									//Filial Ate
cCCDe     	:= mv_par04									//Centro de Custo De
cCCAte    	:= mv_par05									//Centro de Custo Ate
cTurnoDe  	:= mv_par06									//Turno De
cTurnoAte 	:= mv_par07									//Turno Ate
cMatDe    	:= mv_par08									//Matricula De
cMatAte   	:= mv_par09									//Matricula Ate
cNomeDe   	:= mv_par10									//Nome De
cNomeAte  	:= mv_par11									//Nome Ate
dPerIni    	:= mv_par12									//Data Inicio
dPerFim    	:= mv_par13									//Data Fim
lSP8      	:= ( mv_par14 == 2 .or. mv_par14 == 4 )		//Excluir Marcacoes:1=Nao;2;Movimento;4=Ambos
lSPG      	:= ( mv_par14 == 3 .or. mv_par14 == 4 )		//Excluir Marcacoes:1=Nao;3=Acumulado;4=Ambos
lSP5      	:= ( mv_par15 == 2 .or. mv_par15 == 4 )		//Excluir Refeicoes:1=Nao;2=Movimento;4=Ambos
lSPN      	:= ( mv_par15 == 3 .or. mv_par15 == 4 )		//Excluir Refeicoes:1=Nao;3=Acumulado;4=Ambos
lSPC      	:= ( mv_par16 == 2 .or. mv_par16 == 4 )		//Excluir Apontamentos:1=Nao;2=Movimento;4=Ambos
lSPH      	:= ( mv_par16 == 3 .or. mv_par16 == 4 )		//Excluir Apontamentos:1=Nao;3=Acumulado;4=Ambos
lSPB      	:= ( mv_par17 == 2 .or. mv_par17 == 4 )		//Excluir Resultados:1=Nao;2=Movimento;4=Ambos
lSPL      	:= ( mv_par17 == 3 .or. mv_par17 == 4 )		//Excluir Resultados:1=Nao;3=Acumulado;4=Ambos
lSPK      	:= ( mv_par18 == 1 )						//Excluir Abonos
lSPI      	:= ( mv_par19 == 1 )						//Excluir Banco de Horas
cTipo     	:= RetTipoExclu( mv_par20 )					//Tipo a Ser Excluido:1=Gerado;2=Informado;3=Leitura;4=Marcacao;5=Classificado
nLimpa    	:= mv_par21 								//Exclui Todos os Tipos:1=Sim;2=Nao
nRefDe	 	:= mv_par22									//Horas de Refeicao De
nRefAte	 	:= mv_par23									//Horas de Refeicao Ate
cTpRefDe	:= mv_par24									//Tipo de Refeicao De
cTpRefAte	:= mv_par25									//Tipo de Refeicao Ate
cSituacoes	:= mv_par26
cCategoria	:= mv_par27

lDataApontamento:= If(mv_par28 == 1, .T., .F.) //-- Elimina marcacoes/refeicoes pela data de apontamento
/*
зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Seta as Ordens dos Arquivos                                 Ё
юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
SP5->( dbSetOrder(1) )
SP8->( dbSetOrder(1) )
SPB->( dbSetOrder(1) )
SPC->( dbSetOrder(2) )
SPG->( dbSetOrder(1) )
SPH->( dbSetOrder(1) )
SPI->( dbSetOrder(1) )
SPL->( dbSetOrder(1) )
SPN->( dbSetOrder(1) )
SPK->( dbSetOrder(RetOrdem( "SPK", "PK_FILIAL+PK_MAT+DTOS(PK_DATA)+PK_CODABO+STR(PK_HORINI,5,2)+PK_TPMARCA+PK_CC+PK_DEPTO+PK_POSTO+PK_CODFUNC") ))

/*
зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Procura primeiro funcion═rio.                               Ё
юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
SRA->( dbSetOrder( RetOrdem( "SRA" , "RA_FILIAL+RA_TNOTRAB" ) ) )
cInicio  := "RA_FILIAL+RA_TNOTRAB"
cFim     := cFilAte + cTurnoAte

/*/
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Cria o Bloco dos Funcionarios que atendam ao Scopo	   	   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
bSraScope	:= { || ;
						(;
							(	RA_FILIAL	>= cFilDe  	) .and. (	RA_FILIAL	<= cFilAte  	) .and. ;
							(	RA_TNOTRAB	>= cTurnoDe	) .and. (	RA_TNOTRAB	<= cTurnoAte	) .and. ;
							(	RA_NOME		>= cNomeDe	) .and. (	RA_NOME		<= cNomeAte		) .and. ;
							(	RA_MAT		>= cMatDe	) .and. (	RA_MAT		<= cMatAte		) .and. ;
							(	RA_CATFUNC $ cCategorias ) .and. (	RA_SITFOLH	$ cSituacoes	) .and. ;
							(	RA_CC		>= cCCDe	) .and. (	RA_CC		<= cCCAte		)	    ;
						);
			   }

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Atualiza a Mensagem para a IncProcG1() (Cadastro de Empresas)Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
CREATE SCOPE aInfo FOR ( ( ( M0_CODIGO == cEmpAnt ) .and. ( FWGETCODFILIAL >= cFilDe ) .and. ( FWGETCODFILIAL <= cFilAte ) ) )
BarGauge1Set( ( nRecsBarG := SM0->( ScopeCount( aInfo ) ) ) )

#IFNDEF TOP

	/*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Numero de Funcionarios a serem Pocessados                   Ё
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	aRecsBarG := {}
	CREATE SCOPE aRecsBarG FOR Eval( bSraScope )
	nLastRec := SRA->( ScopeCount( aRecsBarG ) )

	/*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Procura primeiro funcion═rio.                               Ё
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	SRA->( dbSeek( cFilDe + cTurnoDe + cMatDe , .T. ) )

#ELSE
	/*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Seta apenas os Campos do SRA que serao Utilizados           Ё
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	aAdd( aCposSRA , "RA_FILIAL"	)
	aAdd( aCposSRA , "RA_MAT" 		)	
	aAdd( aCposSRA , "RA_NOME"		)
	aAdd( aCposSRA , "RA_CC"		)
	aAdd( aCposSRA , "RA_TNOTRAB"	)
	aAdd( aCposSRA , "RA_SEQTURN"	)
	aAdd( aCposSRA , "RA_REGRA"		)
	aAdd( aCposSRA , "RA_ADMISSA"	)
	If cPaisLoc == "MEX"
		aAdd( aCposSRA , "RA_FECREI"  	)
	EndIf
	aAdd( aCposSRA , "RA_CATFUNC"	)
	aAdd( aCposSRA , "RA_SITFOLH"	)
	/*/
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁVerifica e Seta os campos a mais incluidos no Mex             Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/				
	fAdCpoSra(aCposSra)
	
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Ponto de Entrada para Campos do Usuario                      Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( lPnm050CposBlock )
		IF ( ValType( uRet := ExecBlock("PNM050CPOS",.F.,.F.,aCposSRA) ) == "A" )
			IF Len( uRet ) >= Len( aCposSRA )
				aCposSRA := aClone(uRet)
				uRet	 := NIL
			EndIF
		EndIF
	EndIF
	For nX := 1 To nContField
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Carrega os Campos do SRA para a Montagem da Query			   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF aScan( aCposSRA , { |x| Upper(AllTrim(x)) == Upper( AllTrim( aTempSRA[ nX , 1 ] ) ) } ) > 0.00
			aAdd( aStruSRA , aClone( aTempSRA[ nX ] ) )
		EndIF
	Next nX
	aCposSRA	:= aTempSRA := NIL
	nContField	:= Len( aStruSRA )
	cQuery := "SELECT "
	For nX := 1 To nContField
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Inclui os Campos na Montagem da Query						   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		cQuery += aStruSRA[ nX , 1 ] + ", "
	Next nX
	cRetSqlName := InitSqlName("SRA")
	cQuery		:= SubStr( cQuery , 1 , Len( cQuery ) - 2 )
	
	cQueryCond	:= " FROM "+cRetSqlName
	cQueryCond	+= " WHERE "
	cQueryCond	+= "RA_FILIAL>='"+cFilDe+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_FILIAL<='"+cFilAte+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_TNOTRAB>='"+cTurnoDe+"'"	
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_TNOTRAB<='"+cTurnoAte+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_MAT>='"+cMatDe+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_MAT<='"+cMatAte+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_NOME>='"+cNomeDe+"'"	
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_NOME<='"+cNomeAte+"'"
	cQueryCond	+= " AND " 	
	cQueryCond	+= "RA_CC>='"+cCCDe+"'"
	cQueryCond	+= " AND " 
	cQueryCond	+= "RA_CC<='"+cCCAte+"'"
	cQueryCond	+= " AND "
	
	If !Empty(cProcesso)
		cQueryCond	+= "RA_PROCES='"+cProcesso+"'"
		cQueryCond	+= " AND "
	EndIf
	
	cQueryCond	+= "D_E_L_E_T_=' ' "
	
	cQuery		+= cQueryCond
	cQuery		+= "ORDER BY "+SqlOrder( SRA->( IndexKey() ) )
	cQuery		:= ChangeQuery(cQuery)
	SRA->( dbCloseArea() ) //Fecha o SRA para uso da Query
	IF ( lSraQryOpened := MsOpenDbf(.T.,"TOPCONN",TcGenQry(,,cQuery),"SRA",.T.,.T.) )
		For nX := 1 To nContField
			IF ( aStruSRA[nX,2] <> "C" )
				TcSetField("SRA",aStruSRA[nX,1],aStruSRA[nX,2],aStruSRA[nX,3],aStruSRA[nX,4])
			EndIF
		Next nX
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Verifica o Total de Registros a Serem Processados            Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		cQuery := "SELECT COUNT(*) NLASTREC "
		cQuery += cQueryCond
		cQuery := ChangeQuery(cQuery)
        IF ( MsOpenDbf(.T.,"TOPCONN",TcGenQry(,,cQuery),"__QRYCOUNT",.T.,.T.) )
			nLastRec := __QRYCOUNT->NLASTREC
			__QRYCOUNT->( dbCloseArea() )
		Else
			MsAguarde( { || SRA->( dbEval( { || ++nLastRec } ) ) } , STR0002 + STR0009 )	//'Aguarde...'###'Selecionaldo Funcionarios'
			SRA->( dbGotop() )
		EndIF
		cQuery		:= ""
		cQueryCond	:= ""
	Else
		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Restaura Arquivo Padrao e Ordem                             Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		ChkFile( "SRA" , .F. )
		SRA->( dbSetOrder( RetOrdem( "SRA" ) ) )
		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Procura primeiro funcion═rio.                               Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		SRA->( dbSeek( cFilDe + cMatDe , .T. ) )
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Verifica o Total de Registros a Serem Processados            Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		nLastRec := SRA->( LastRec() )
	EndIF
#ENDIF

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Inicializa a Mensagem para a IncProcG2() ( Funcionarios )	   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
IncProcG2( OemToAnsi( STR0012 ) , .F. )	//'Processando...'

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Atualiza a Mensagem para a IncProcG2() ( Funcionarios )	   Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
BarGauge2Set( nLastRec )

Begin Sequence

	/*/
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Ajusta Estruturas											   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды/*/
	IF !PonStruct( Nil, Nil, {|x|( VerSP5Struct() ) } )
	   Break
	Endif

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Processa a Exclusao   									   Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	While SRA->( !Eof() .and. &(cInicio) <= cFim )

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Consiste filtro do intervalo De / Ate                        Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		#IFNDEF TOP
			IF SRA->( !Eval( bSraScope ) )
				SRA->( dbSkip() )
				Loop
			EndIF
		#ELSE
			IF !( lSraQryOpened )
				IF SRA->( !Eval( bSraScope ) )
					SRA->( dbSkip() )
					Loop
				EndIF
			Else
		       	If 	SRA->( ! ( ( RA_CATFUNC $ cCategorias ) .and. ( RA_SITFOLH	$ cSituacoes ) ) )
					SRA->(dbSkip())              
					Loop
				Endif
			EndIF
		#ENDIF
		
		If !Empty(cProcesso)
			If !( SRA->RA_PROCES == cProcesso )
				SRA->(dbSkip())
				Loop
			EndIf
		EndIf

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		ЁCarrega as Filiais e Periodos de Apontamento                           Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	    IF !( cLastFil == SRA->RA_FILIAL )
	    	cLastFil := SRA->RA_FILIAL
	    	cFilAnt	 := IF( !Empty( cLastFil ) , cLastFil , cFilAnt )
			
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Obtem o % de Incremento da 2a. BarGauge					   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			nIncPercG1 := SuperGetMv( "MV_PONINC1" , NIL , 5 , cLastFil )
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Obtem o % de Incremento da 2a. BarGauge					   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			nIncPercG2 := SuperGetMv( "MV_PONINCP" , NIL , 5 , cLastFil )
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Atualiza a Mensagem para a IncProcG1() ( Turnos )			   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			fInfo( @aInfo , cLastFil )
			cMsgBarG1 := ( STR0013 + " " + cLastFil + " - " + AllTrim( aInfo[3] ) ) ////"Filial:"
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Inicializa Mensagem na 1a BarGauge                           Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IncProcG1( cMsgBarG1 , .F.  )
			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			ЁIncrementa a Barra de Gauge referente a Filial				   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IncPrcG1Time( cMsgBarG1 , nRecsBarG , cTimeIni , .F. , 1 , nIncPercG1 )

	    EndIF
		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Movimenta a R┌gua de Processamento                           Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IncPrcG2Time( OemToAnsi( STR0019 ) , nLastRec , cTimeIni , .T. , 2 , nIncPercG2 )	//"Processados:"

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Consiste controle de acessos e filiais validas               Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF SRA->( !(RA_FILIAL $ fValidFil()) .Or. !Eval(cAcessaSRA) )
			SRA->(dbSkip())
			Loop
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta marca┤■es de Refei┤└o (SP5)                          Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSP5 )
			#IFNDEF TOP
				DelSp5SpnC("SP5",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
					DelSp5SpnC("SP5",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
				Else
					DelSp5SpnT("SP5",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Acumulados de Marca┤■es de Refei┤└o (SPN)        Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPN )
			#IFNDEF TOP
				DelSp5SpnC("SPN",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
					DelSp5SpnC("SPN",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
				Else
					DelSp5SpnT("SPN",nLimpa,cTipo,nRefDe,nRefAte,dPerIni,dPerFim,cTpRefDe,cTpRefAte)
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Marca┤■es (SP8/SPG)                     Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

	    IF lDataApontamento
	       DeleTopApont( lSP8, lSPG, dPerIni , dPerFim , cLastFil, nLimpa, cTipo) 
	    Else   
			/*
			зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Deleta registros de Marca┤■es (SP8)                         Ё
			юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF ( lSP8 )
				#IFNDEF TOP
					DeleteXbs( "SP8" , nLimpa , cTipo , dPerIni , dPerFim )
				#ELSE
					IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
						DeleteXbs( "SP8" , nLimpa , cTipo , dPerIni , dPerFim )
					Else
						DeleteTop( "SP8" , nLimpa , cTipo , dPerIni , dPerFim )
					EndIF	
				#ENDIF
	        EndIF

			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Aborta o Processamento									   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF ( lAbortPrint )
				Break
			EndIF

			/*
			зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Deleta registros de Acumulados de Marca┤■es (SPG)           Ё
			юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF ( lSPG )
				#IFNDEF TOP
					DeleteXbs( "SPG" , nLimpa , cTipo , dPerIni , dPerFim )
				#ELSE
					IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
						DeleteXbs( "SPG" , nLimpa , cTipo , dPerIni , dPerFim )
					Else
						DeleteTop( "SPG" , nLimpa , cTipo , dPerIni , dPerFim )
					EndIF	
				#ENDIF
			EndIF

			/*
			здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Aborta o Processamento									   Ё
			юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF ( lAbortPrint )
				Break
			EndIF
	    Endif

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Apontamentos (SPC)                      Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPC )
			/*
			зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			ЁDesflega as Marcacoes Apontadas apenas quando nao for selecioЁ
			Ёnada a exclusao das marcacoes								  Ё
			юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF IF( !( lSP8 ) , SP8FlgAponta( dPerIni , dPerFim , @aRecnos , @aTabPadrao ) , .T. )
				#IFNDEF TOP
					DeleteXbs( "SPC" , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
				#ELSE
					IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
						DeleteXbs( "SPC" , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
					Else
						DeleteTop( "SPC" , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
					EndIF
				#ENDIF
			EndIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Acumulado de Apontamentos (SPH)         Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPH )
			#IFNDEF TOP
				DeleteXbs( "SPH" , nLimpa , cTipo , dPerIni , dPerFim )
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
					DeleteXbs( "SPH" , nLimpa , cTipo , dPerIni , dPerFim )
				Else
					DeleteTop( "SPH" , nLimpa , cTipo , dPerIni , dPerFim )
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Resultados (SPB)                        Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPB )
			#IFNDEF TOP
				DeleteXbs( "SPB" , nLimpa , cTipo , dPerIni , dPerFim )
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) ) 
					DeleteXbs( "SPB" , nLimpa , cTipo , dPerIni , dPerFim )
				Else
					DeleteTop( "SPB" , nLimpa , cTipo , dPerIni , dPerFim )
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Acumulado de Resultados (SPL)           Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPL )
			#IFNDEF TOP
				DeleteXbs( "SPL" , nLimpa , cTipo , dPerIni , dPerFim )
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
					DeleteXbs( "SPL" , nLimpa , cTipo , dPerIni , dPerFim )
				Else
					DeleteTop( "SPL" , nLimpa , cTipo , dPerIni , dPerFim )
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Banco de Horas (SPI)                    Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPI )
			#IFNDEF TOP
				DeleteXbs( "SPI" , nLimpa , cTipo , dPerIni , dPerFim )
			#ELSE
				IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
					DeleteXbs( "SPI" , nLimpa , cTipo , dPerIni , dPerFim )
				Else
					DeleteTop( "SPI" , nLimpa , cTipo , dPerIni , dPerFim )
				EndIF	
			#ENDIF
		EndIF

		/*
		здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Aborta o Processamento									   Ё
		юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lAbortPrint )
			Break
		EndIF

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		Ё Deleta registros de Abonos (SPK)                            Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF ( lSPK )
			IF IF( !( lSPC ) , SPCClearAbono( dPerIni , dPerFim , cLimpaMotAbo , @aRecnos ) , .T. )
				#IFNDEF TOP
					DeleteXbs( "SPK" , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
				#ELSE
					IF ( ( lExInAs400 ) .or. ( __lFkInUse ) )
						DeleteXbs( "SPK" , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
					Else
						DeleteTop( "SPK" , nLimpa , cTipo , dPerIni , dPerFim )
					EndIF
				#ENDIF
			EndIF
		EndIF
		
		SRA->( dbSkip() )

	End While
	
End Sequence

/*
зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Fecha a Query do SRA e Restaura o Padrao                    Ё
юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
#IFDEF TOP
	IF ( lSraQryOpened )
		SRA->( dbCloseArea() )
		ChkFile( "SRA" , .F. )
	EndIF
	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁReabre os Arquivos										       Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	ReOpenFiles( { "SP5" , "SPN" , "SP8" , "SPG" , "SPB" , "SPL" , "SPC" , "SPH" , "SPI" , "SPK" } ) 
#ENDIF

RestArea( aAreaSRA )
RestArea( aAreaSP5 )
RestArea( aAreaSP8 )
RestArea( aAreaSPB )
RestArea( aAreaSPC )
RestArea( aAreaSPG )
RestArea( aAreaSPH )
RestArea( aAreaSPI )
RestArea( aAreaSPL )
RestArea( aAreaSPN )
RestArea( aAreaSPK )

cFilAnt	:= cSvFilAnt

Return( NIL )

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁDelSp5SpnC		ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁDeleta os Dados do SP5 ou SPN Quando Code Base ou As/400    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONM050 													Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function DelSp5SpnC(	cAlias		,;
							nLimpa		,;
							cTipo		,;
							nRefDe		,;
							nRefAte		,;
							dPerIni		,;
							dPerFim		,;
							cTpRefDe	,;
							cTpRefAte	 ;
						  )

Local cPrefixo	:= ""
Local cMsgErr	:= ""

cAlias		:= Upper( AllTrim( cAlias ) )
cPrefixo	:= ( PrefixoCpo( cAlias ) + "_" )

IF ( cAlias $ ( "SP5_SPN" ) )
	IF ( cAlias )->( dbSeek( SRA->RA_FILIAL + SRA->RA_MAT , .F. ) )
		While ( cAlias )->( !Eof() .and. SRA->RA_FILIAL + SRA->RA_MAT == &( cPrefixo+"FILIAL" ) + &( cPrefixo+"MAT" ) )
			IF ( cAlias )->(;
								( &( cPrefixo+"DATA"    ) >= dPerIni		.and. &( cPrefixo+"DATA" )		<= dPerFim		) .and. ;
								( &( cPrefixo+"HORA"    ) >= nRefDe 	.and. &( cPrefixo+"HORA" ) 		<= nRefAte	) .and. ;
								( &( cPrefixo+"TIPOREF" ) >= cTpRefDe	.and. &( cPrefixo+"TIPOREF" )	<= cTpRefAte);
							)	
				/*
				зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				Ё Limpa registros conforme tipo de Lancto					  Ё
				юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
				IF ( ( nLimpa == 1 ) .or. ( ( cAlias )->( &( cPrefixo+"FLAG" ) == cTipo ) ) )
					IF ( cAlias )->( RecLock( cAlias , .F. , .T. ) )
						IF !( cAlias )->( FkDelete( @cMsgErr ) )
							( cAlias )->( RollBackDelTran( cMsgErr ) )
						EndIF
						( cAlias )->( MsUnlock() )
					EndIF	
				EndIF
			EndIF
			( cAlias )->( dbSkip() )
		End While
	EndIF
EndIF
	
Return( NIL )

#IFDEF TOP

	/*
	зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
	ЁFun┤┘o    ЁDelSp5SpnT		ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
	цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
	ЁDescri┤┘o ЁDeleta os Dados do SP5 ou SPN Quando TOP					Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁSintaxe   Ё<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁParametrosЁ<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	Ё Uso      ЁPONM050 													Ё
	юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	Static Function DelSp5SpnT(	cAlias		,;
								nLimpa		,;
								cTipo		,;
								nRefDe		,;
								nRefAte		,;
								dPerIni		,;
								dPerFim		,;
								cTpRefDe	,;
								cTpRefAte	 ;
							  )
	
	Local cPrefixo 		:= ""
	Local cFil			:= SRA->RA_FILIAL
	Local cMat			:= SRA->RA_MAT
	Local cQuery		:= ""
	Local cWhere		:= ""
	Local cQueryDelet	:= ""
	Local cQueryRecno	:= ""
	Local cRetSqlName	:= InitSqlName( cAlias )
	Local cIniData		:= Dtos( dPerIni )
	Local cFimData		:= Dtos( dPerFim )
	Local cCpoRecno 	:= IF( lExInAs400 , "RRN("+cRetSqlName+")", "R_E_C_N_O_" )
	Local lDeleted 		:= .F.
	Local nMinRec 		:= 0.00
	Local nMaxRec 		:= 0.00
	Local nCountDele	:= 0.00
		
	cAlias		:= Upper( AllTrim( cAlias ) )
	cPrefixo	:= ( PrefixoCpo( cAlias ) + "_" )
		
	IF ( cAlias $ ( "SP5_SPN" ) )
	
		IF ( lDeleted := ( ( nCountDele := CountDele(cAlias,cPrefixo,cFil,cMat,cIniData,cFimData,cRetSqlName) ) > 0.00 ) )
	
			cQuery := "DELETE FROM " + cRetSqlName
	
			cWhere := " WHERE "
			cWhere += cPrefixo+"FILIAL='"+cFil+"'"
			cWhere += " AND "
			cWhere += cPrefixo+"MAT='"+cMat+"'"
			cWhere += " AND "
			IF !( nLimpa == 1 )
				cWhere += cPrefixo+"FLAG='"+cTipo+"'"
				cWhere += " AND "
			EndIF
			cWhere += cPrefixo+"TIPOREF>='"+cTpRefDe+"'"
			cWhere += " AND "
			cWhere += cPrefixo+"TIPOREF<='"+cTpRefAte+"'"
			cWhere += " AND "
			cWhere += cPrefixo+"DATA>='"+cIniData+"'"
			cWhere += " AND "
			cWhere += cPrefixo+"DATA<='"+cFimData+"'"
			cWhere += " AND "
			cWhere += cPrefixo+"HORA>="+Str(nRefDe,TamSx3(cPrefixo+"HORA")[1],TamSx3(cPrefixo+"HORA")[2])
			cWhere += " AND "
			cWhere += cPrefixo+"HORA<="+Str(nRefAte,TamSx3(cPrefixo+"HORA")[1],TamSx3(cPrefixo+"HORA")[2])
				
			cQuery += cWhere
		
			MsMinMaxRec( cAlias , @nMinRec , @nMaxRec , NIL , cWhere )
		
			While ( nMinRec <= nMaxRec )
				cQueryRecno := " AND "
				cQueryRecno += "("
				cQueryRecno +=		cCpoRecno + " >= " + AllTrim( Str( nMinRec , 18 , 0 ) )
				cQueryRecno += 		" AND "
				cQueryRecno += 		cCpoRecno + " <= " + AllTrim( Str( ( nMinRec += 1024 ) , 18 , 0 ) )
				cQueryRecno += ")"
				cQueryDelet := ( cQuery + cQueryRecno )
				TcSqlExec( cQueryDelet )
			End While
		
		EndIF
	
	EndIF	
	
	Return( lDeleted )
	
#ENDIF

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁDeleteXbs		ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁDeleta os Dados Quando Code Base ou As/400    				Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONM050 													Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function DeleteXbs( cAlias , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )

Local cPrefixo 		:= ""
Local cCpo			:= ""
Local cMsgErr		:= ""
Local lExistFlag	:= .F.
Local lExistTipo2	:= .F.
Local lChkFlag		:= .F.
Local lDeleted		:= .F.
Local nRecno		:= 0.00
Local nRecnos		:= 0.00

cAlias		:= Upper( AllTrim( cAlias ) )

IF Empty( aRecnos )
	cPrefixo	:= ( PrefixoCpo( cAlias ) + "_" )
	IF ( lExistFlag	:= ( ( cAlias )->( FieldPos( cPrefixo+"FLAG" ) ) > 0.00 ) )
		cCpo := "FLAG"
	ElseIF ( lExistTipo2 := ( ( cAlias )->( FieldPos( cPrefixo+"TIPO2" ) ) > 0.00 ) )
		cCpo := "TIPO2"
	EndIF	
	lChkFlag := ( lExistFlag .or. lExistTipo2 )
	IF ( cAlias)->( dbSeek( SRA->RA_FILIAL + SRA->RA_MAT, .F.) )
		While ( cAlias)->( !Eof() .and. SRA->RA_FILIAL + SRA->RA_MAT == &( cPrefixo+"FILIAL" ) + &( cPrefixo+"MAT" ) )
			IF ( ( nLimpa == 1 ) .or. IF( lChkFlag ,  ( ( cAlias )->( &( cPrefixo+cCpo ) ) == cTipo ) , .T. ) )
				IF ( cAlias)->( &( cPrefixo+"DATA" ) >= dPerIni .and. &( cPrefixo+"DATA" ) <= dPerFim )
					IF ( cAlias)->( RecLock( cAlias , .F. , .T. ) )
						IF !( cAlias )->( FkDelete( @cMsgErr ) )
							( cAlias )->( RollBackDelTran( cMsgErr ) )
						EndIF
						( cAlias)->( MsUnlock() )
						lDeleted := .T.
					EndIF
				EndIF
			EndIF
			( cAlias)->( dbSkip() )
		End While
	EndIF	
Else
	IF ( lDeleted := ( ( nRecnos := Len( aRecnos ) ) > 0.00 ) )
		For nRecno := 1 To nRecnos
			( cAlias )->( dbGoto( aRecnos[ nRecno ] ) )
			IF ( cAlias )->( RecLock( cAlias , .F. ) )
				IF !( cAlias )->( FkDelete( @cMsgErr ) )
					( cAlias )->( RollBackDelTran( cMsgErr ) )
				EndIF
				( cAlias )->( MsUnLock() )
			EndIF
		Next nRecno
	EndIF	
EndIF

Return( lDeleted )

#IFDEF TOP

	/*
	зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
	ЁFun┤┘o    ЁDeleteToP		ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
	цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
	ЁDescri┤┘o ЁDeleta os Dados Quando TOP               				    Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁSintaxe   Ё<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁParametrosЁ<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	Ё Uso      ЁPONM050 													Ё
	юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	Static Function DeleteToP( cAlias , nLimpa , cTipo , dPerIni , dPerFim , aRecnos )
	
	Local cPrefixo 		:= ""
	Local cQuery		:= ""
	Local cWhere		:= ""	
	Local cQueryDelet	:= ""
	Local cQueryRecno	:= ""
	Local cRetSqlName	:= InitSqlName( cAlias )
	Local cFil			:= SRA->RA_FILIAL
	Local cMat			:= SRA->RA_MAT
	Local cIniData		:= Dtos( dPerIni )
	Local cFimData		:= Dtos( dPerFim )
	Local cCpoRecno 	:= IF( lExInAs400 , "RRN("+cRetSqlName+")", "R_E_C_N_O_" )
	Local lExistFlag	:= .F.
	Local lExistTipo2	:= .F.
	Local lDeleted		:= .F.
	Local nMinRec 		:= 0.00
	Local nMaxRec 		:= 0.00
	Local nCountDele	:= 0.00
	
	cAlias		:= Upper( AllTrim( cAlias ) )
	cPrefixo	:= ( PrefixoCpo( cAlias ) + "_" )
	
	IF Empty( aRecnos )
	
		IF !( cAlias $ ( "SP5_SPN" ) )
		
			IF ( lDeleted := ( ( nCountDele := CountDele(cAlias,cPrefixo,cFil,cMat,cIniData,cFimData,cRetSqlName) ) > 0.00 ) )
			
				lExistFlag	:= ( ( cAlias )->( FieldPos( cPrefixo+"FLAG" ) ) > 0.00 )
				lExistTipo2	:= ( ( cAlias )->( FieldPos( cPrefixo+"TIPO2" ) ) > 0.00 )
		
				cQuery := "DELETE FROM " + cRetSqlName
					
				cWhere := " WHERE "
				cWhere += ( cPrefixo+"FILIAL='"+cFil+"'" )
				cWhere += " AND "
				cWhere += ( cPrefixo+"MAT='"+cMat+"'" )
				cWhere += " AND "
				IF !( nLimpa == 1 )
					IF ( lExistFlag )
						cWhere += ( cPrefixo+"FLAG='"+cTipo+"'" )
						cWhere += " AND "
					ElseIF ( lExistTipo2 )
						cWhere += ( cPrefixo+"TIPO2='"+cTipo+"'" )
						cWhere += " AND "
					EndIF
				EndIF
				cWhere += ( cPrefixo+"DATA>='"+cIniData+"'" )
				cWhere += " AND "
				cWhere += ( cPrefixo+"DATA<='"+cFimData+"'" )
	
				cQuery += cWhere
			
				MsMinMaxRec( cAlias , @nMinRec , @nMaxRec , NIL , cWhere )
		
				While ( nMinRec <= nMaxRec )
					cQueryRecno := " AND "
					cQueryRecno += "("
					cQueryRecno +=		cCpoRecno + " >= " + AllTrim( Str( nMinRec , 18 , 0 ) )
					cQueryRecno += 		" AND "
					cQueryRecno += 		cCpoRecno + " <= " + AllTrim( Str( ( nMinRec += 1024 ) , 18 , 0 ) )
					cQueryRecno += ")"
					cQueryDelet := ( cQuery + cQueryRecno )
					TcSqlExec( cQueryDelet )
				End While
	
			EndIF
		
		EndIF
	
	Else    
	
		lDeleted := ( ( nMaxRec := Len( aRecnos ) ) > 0.00 )
		For nMinRec := 1 To nMaxRec
		
			nCountDele := aRecnos[ nMinRec ]
			
			cQueryDelet := "DELETE FROM " + cRetSqlName
			cQueryDelet += " WHERE "
			cQueryDelet += cCpoRecno + "=" + AllTrim( Str( nCountDele , 18 , 0 ) )
			TcSqlExec( cQueryDelet )
			
		Next nMinRec
		
	EndIF
	
	Return( lDeleted )

#ENDIF

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁSP8FlgAponta    ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁRetira o Flag de Apontamento do SP8      				    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONM050 													Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function SP8FlgAponta( dPerIni , dPerFim , aRecnos , aTabPadrao )

Local aTabCalend	:= {}
Local cSvAlias		:= Alias()
Local cAlias		:= "SPC"
Local cAliasQuery	:= cAlias
Local cAliasSP8		:= "SP8"
Local cFil			:= SRA->RA_FILIAL
Local cMat			:= SRA->RA_MAT
Local cFilMat		:= ( cFil + cMat )
Local dLstData		:= Ctod("//")
Local lExistApont	:= .F.
Local lQueryOpened	:= .F.
Local lSP8QryOpened	:= .F.
Local nPosCalend	:= 0.00

#IFDEF TOP
	Local aSp8Recnos		:= {}
	Local aSpcFields		:= ( "SPC" )->( dbStruct() )
	Local cIniData	 		:= ""
	Local cFimData			:= ""
	Local cQuery	 		:= ""
	Local cQuerySP8			:= ""
	Local cRetSqlName		:= InitSqlName( cAlias )
	Local cSp8RetSqln		:= InitSqlName( cAliasSP8 )
	Local cSp8IndexKey		:= SqlOrder( ( cAliasSP8 )->( IndexKey() ) )
	Local cCpoRecno			:= ""
	Local cDataBase			:= ""
	Local nSpcFields 		:= Len( aSpcFields )
	Local nRecno			:= 0.00
	Local nRecnos			:= 0.00
	Local nX
#ENDIF

aRecnos := {}

#IFNDEF TOP

	( cAliasQuery )->( dbSeek( cFilMat  , .F. ) )

#ELSE

	IF ( !( lExInAs400 ) .and. !( __lFkInUse ) )
	
		cIniData	:= Dtos( dPerIni )
		cFimData	:= Dtos( dPerFim )
		cCpoRecno	:= IF( lExInAs400 , "RRN("+cRetSqlName+")", "R_E_C_N_O_" )
		cDataBase	:= IF( lExInAs400 , GetDataBase() , "" )
	
		IF ( lExistApont := ( CountDele(cAlias,"PC_",cFil,cMat,cIniData,cFimData,cRetSqlName) > 0.00 ) ) 
			cAliasQuery := ( "__Q" + cAliasQuery + "QRY" )
			cQuery := "SELECT "
			For nX := 1 To nSpcFields
				cQuery += aSpcFields[ nX , 01 ] + ", "
			Next nX
			cQuery += "R_E_C_N_O_ RECNO "
			cQuery += " FROM " + cRetSqlName
			cQuery += " WHERE "
			cQuery += "PC_FILIAL='"+cFil+"'"
			cQuery += " AND "
			cQuery += "PC_MAT='"+cMat+"'"
			cQuery += " AND "
			cQuery += " ( "
			cQuery += 		"PC_DATA>='"+cIniData+"'"
			cQuery += 		" AND "
			cQuery += 		"PC_DATA<='"+cFimData+"'"
			cQuery += " ) "
			cQuery += "ORDER BY " + SqlOrder( (cAlias)->( IndexKey() ) )
			cQuery := ChangeQuery( cQuery )
			IF ( lQueryOpened := MsOpenDbf(.T.,"TOPCONN",TcGenQry(NIL,NIL,cQuery),cAliasQuery,.T.,.T.) )
				For nX := 1 To nSpcFields
					IF !( aSpcFields[ nX , 02 ] == "C" )
						TcSetField(cAliasQuery,aSpcFields[nX,01],aSpcFields[nX,02],aSpcFields[nX,03],aSpcFields[nX,04])
					EndIF
				Next nX
				cQuery := ""
			EndIF
		EndIF

	EndIF

	IF !( lQueryOpened )
		cAliasQuery	:= cAlias
		( cAliasQuery )->( dbSeek( cFilMat , .F. ) )
	EndIF	
	
#ENDIF

#IFNDEF TOP
	lExistApont := ( cAliasQuery )->( Found() )
#ELSE
	IF !( lQueryOpened )
		lExistApont := ( cAliasQuery )->( Found() )
	Else
		lExistApont := ( cAliasQuery )->( !Eof() )
	EndIF
#ENDIF

IF ( lExistApont )
	
	CriaCalend(dPerIni,dPerFim,SRA->RA_TNOTRAB,SRA->RA_SEQTURN,@aTabPadrao,@aTabCalend,cFil,NIL,NIL,NIL,NIL,NIL,.F.)

	dPerIni -= 2
	dPerFim += 2
	
	#IFDEF TOP

		IF ( lQueryOpened )

			cIniData	:= Dtos( dPerIni )
			cFimData	:= Dtos( dPerFim )

		EndIF

	#ENDIF	
	
	While ( cAliasQuery )->( !Eof() .and. cFilMat == PC_FILIAL + PC_MAT )

		#IFNDEF TOP

			IF ( cAliasQuery )->( PC_DATA >= dPerIni .and. PC_DATA <= dPerFim )

		#ENDIF

				IF !( dLstData == ( cAliasQuery )->( PC_DATA ) )
			
					dLstData := ( cAliasQuery )->( PC_DATA )
			
					/*
					зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					ЁRetira o Flag de Marcacao Apontada do SP8					  Ё
					юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
					IF ( nPosCalend := aScan( aTabCalend , { |x| x[1] == dLstData .and. x[4] == "1E" } ) ) > 0.00

						#IFDEF TOP
						
							IF ( !( lExInAs400 ) .and. !( __lFkInUse ) )
							
								cQuerySP8	:= "SELECT "
								cQuerySP8 	+= "R_E_C_N_O_ RECNO "
								cQuerySP8	+= " FROM "+ cSp8RetSqln
								cQuerySP8	+= " WHERE "
								cQuerySP8	+= "P8_FILIAL='"+cFil+"'"
								cQuerySP8	+= " AND "
								cQuerySP8	+= "P8_MAT='"+cMat+"'"
								cQuerySP8	+= " AND "
								cQuerySP8	+= "P8_ORDEM='"+aTabCalend[ nPosCalend , 02 ]+"'"
								cQuerySP8	+= " AND "
								cQuerySP8	+= " ( "
								cQuerySP8	+= 		"P8_DATA>='"+cIniData+"'"
								cQuerySP8	+= 		" AND "
								cQuerySP8	+= 		"P8_DATA<='"+cFimData+"'"
								cQuerySP8	+= " ) "
								cQuerySP8	+= " AND "
								cQuerySP8	+= "P8_APONTA='S'"
								cQuery		+= "ORDER BY "+cSp8IndexKey
								cQuerySP8	:= ChangeQuery( cQuerySP8 )
					
								cAliasSP8	:= "QRYSP8REC"
					
								IF !( lSP8QryOpened := MsOpenDbf(.T.,"TOPCONN",TcGenQry(,,cQuerySP8),cAliasSP8,.T.,.T.) )
									cAliasSP8 := "SP8"
								EndIF
							
							EndIF
						
						#ENDIF
						
						IF ( lSP8QryOpened )

							While ( cAliasSP8 )->( !Eof() )
								( cAliasSP8 )->( aAdd( aSp8Recnos , RECNO ) )
								( cAliasSP8 )->( dbSkip() )
							End While
							cQuerySP8 := ""
							( cAliasSP8 )->( dbCloseArea() )
							dbSelectArea( cAliasQuery )
						
						Else
							
							IF ( cAliasSP8 )->( dbSeek( ( cAliasQuery )->( PC_FILIAL + PC_MAT ) + aTabCalend[ nPosCalend , 02 ] ) )
								While ( cAliasSP8 )->( !Eof() .and. P8_FILIAL + P8_MAT + P8_ORDEM == ( cFilMat + aTabCalend[ nPosCalend , 02 ] )  )
									IF ( cAliasSP8 )->( P8_DATA >= dPerIni .and. P8_DATA <= dPerFim )
										IF ( cAliasSP8 )->( RecLock( "SP8" , .F. , .T. ) )
											( cAliasSP8 )->( P8_APONTA ) := "N"
											( cAliasSP8 )->( MsUnLock() )
										EndIF
									EndIF
									( cAliasSP8 )->( dbSkip() )
								End While
							EndIF

		   				EndIF
			
		   			EndIF
			
				EndIF

				#IFNDEF TOP

					aAdd( aRecnos , ( cAliasQuery )->( Recno() ) )

				#ELSE

					IF !( lQueryOpened )

						aAdd( aRecnos , ( cAliasQuery )->( Recno() ) )

					Else

						aAdd( aRecnos , ( cAliasQuery )->( RECNO ) )

					EndIF	

				#ENDIF

		#IFNDEF TOP				

			EndIF

		#ENDIF	

		( cAliasQuery )->( dbSkip() )

	End While

	#IFDEF TOP

		nRecnos := Len( aSp8Recnos )
		For nRecno := 1 To nRecnos 
			cQuerySP8 := "UPDATE "
			IF ( lExInAs400 )
				cQuerySP8 += cDataBase+"/"+cSp8RetSqln
			Else
				cQuerySP8 += cSp8RetSqln
			EndIF
			cQuerySP8 += " SET P8_APONTA='N' "
			cQuerySP8 += " WHERE " 
			cQuerySP8 += cCpoRecno + "=" + AllTrim( Str( aSp8Recnos[ nRecno ] , 18 , 0 ) )
			TcSqlExec( cQuerySP8 )
		Next nRecno
		IF ( lQueryOpened )
			( cAliasQuery )->( dbCloseArea() )
		EndIF

	#ENDIF	

EndIF

dbSelectArea( cSvAlias )

Return( lExistApont )

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁSPCClearAbono   ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁLimpa os Abonos do SPC                   				    Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONM050 													Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function SPCClearAbono( dPerIni , dPerFim , cLimpaMotAbo , aRecnos )

Local cSvAlias			:= Alias()
Local cAlias			:= "SPK"
Local cAliasQuery		:= cAlias
Local cAliasSPC			:= "SPC"
Local cFil				:= SRA->RA_FILIAL
Local cMat				:= SRA->RA_MAT
Local cChave    		:= ""
Local cChave1   		:= ""
Local lExistAbono		:= .F.
Local lSPCQryOpened		:= .F.

#IFDEF TOP
	Local aSpcRecnos		:= {}
	Local aSpkFields		:= ( "SPK" )->( dbStruct() )
	Local cIniData	 		:= ""
	Local cFimData			:= ""
	Local cQuery	 		:= ""
	Local cQuerySPC			:= ""
	Local cCpoRecno			:= ""
	Local cRetSqlName		:= InitSqlName( cAlias )
	Local cSpcRetSqln		:= InitSqlName( cAliasSPC )
	Local cSpcIndexKey		:= SqlOrder( ( cAliasSPC )->( IndexKey() ) )
	Local lQueryOpened		:= .F.
	Local nSpkFields 		:= Len( aSpkFields )
	Local nRecno			:= 0.00
	Local nRecnos			:= 0.00
	Local nX
#ENDIF

aRecnos := {}

#IFNDEF TOP

	( cAliasQuery )->( dbSeek( cChave , .F. ) )

#ELSE

	IF ( !( lExInAs400 ) .and. !( __lFkInUse ) )
		cIniData	:= Dtos( dPerIni )
		cFimData	:= Dtos( dPerFim )
		cCpoRecno	:= IF( lExInAs400 , "RRN("+cRetSqlName+")", "R_E_C_N_O_" )
	
		IF ( lExistAbono := ( CountDele(cAlias,"PK_",cFil,cMat,cIniData,cFimData,cRetSqlName) > 0.00 ) ) 
			cAliasQuery := ( "__Q" + cAliasQuery + "QRY" )
			cQuery := "SELECT "
			For nX := 1 To nSpkFields
				cQuery += aSpkFields[ nX , 01 ] + ", "
			Next nX
			cQuery += "R_E_C_N_O_ RECNO "
			cQuery += " FROM "
			cQuery += cRetSqlName
			cQuery += " WHERE "
			cQuery += "PK_FILIAL='"+cFil+"'"
			cQuery += " AND "
			cQuery += "PK_MAT='"+cMat+"'"
			cQuery += " AND "
			cQuery += " ( "
			cQuery += 		"PK_DATA>='"+cIniData+"'"
			cQuery +=		" AND "
			cQuery += 		"PK_DATA<='"+cFimData+"'"
			cQuery += " ) "
			cQuery += "ORDER BY " + SqlOrder( (cAlias)->( IndexKey() ) )
			cQuery := ChangeQuery( cQuery )
			IF ( lQueryOpened := MsOpenDbf(.T.,"TOPCONN",TcGenQry(NIL,NIL,cQuery),cAliasQuery,.T.,.T.) )
				For nX := 1 To nSpkFields
					IF !( aSpkFields[ nX , 02 ] == "C" )
						TcSetField(cAliasQuery,aSpkFields[nX,01],aSpkFields[nX,02],aSpkFields[nX,03],aSpkFields[nX,04])
					EndIF
				Next nX
				cQuery := ""
			EndIF
		EndIF

	EndIF
	
	IF !( lQueryOpened )
		cAliasQuery		:= cAlias
		( cAliasQuery )->( dbSeek( cChave , .F. ) )
	EndIF
	
#ENDIF

#IFNDEF TOP
	lExistAbono := ( cAliasQuery )->( Found() )
#ELSE
	IF !( lQueryOpened )
		lExistAbono := ( cAliasQuery )->( Found() )
	Else
		lExistAbono := ( cAliasQuery )->( !Eof() )		
	EndIF
#ENDIF

IF ( lExistAbono )

	cChave	:= ( cFil + cMat )

	While ( cAliasQuery )->( !Eof() .and. cChave == (PK_FILIAL + PK_MAT) )

		IF ( cAliasQuery )->( PK_DATA >= dPerIni .And. PK_DATA <= dPerFim )
			
			#IFDEF TOP

			IF ( !( lExInAs400 ) .and. !( __lFkInUse ) )

					cQuerySPC	:= "SELECT "
					cQuerySPC 	+= "R_E_C_N_O_ RECNO "
					cQuerySPC	+= " FROM "+cSpcRetSqln
					cQuerySPC	+= " WHERE "
					cQuerySPC	+= "PC_FILIAL='"+cFil+"'"
					cQuerySPC	+= " AND "
					cQuerySPC	+= "PC_MAT='"+cMat+"'"
					cQuerySPC	+= " AND "
					cQuerySPC	+= "PC_ABONO='"+(cAliasQuery)->(PK_CODABO)+"'"
					cQuerySPC	+= " AND "
					cQuerySPC	+= "PC_DATA='"+Dtos((cAliasQuery)->(PK_DATA))+"'"
					cQuerySPC	+= " AND "
					cQuerySPC	+= "PC_CC='"+(cAliasQuery)->(PK_CC)+"'"
					cQuerySPC	+= " AND "
					cQuerySPC	+= "PC_TPMARCA='"+(cAliasQuery)->(PK_TPMARCA)+"'"
					cQuery		+= "ORDER BY "+cSpcIndexKey
					cQuerySPC	:= ChangeQuery( cQuerySPC )
				   
					cAliasSPC	:= "QRYSPCREC"
					
					IF !( lSPCQryOpened := MsOpenDbf(.T.,"TOPCONN",TcGenQry(,,cQuerySPC),cAliasSPC,.T.,.T.) )
						cAliasSPC	:= "SPC"
					EndIF
					
	            EndIF
            
            #ENDIF
                
			IF ( lSPCQryOpened )

				While ( cAliasSPC )->( !Eof() )
					( cAliasSPC )->( aAdd( aSpcRecnos , RECNO ) )
					( cAliasSPC )->( dbSkip() )
				End While
				cQuerySPC := ""
				( cAliasSPC )->( dbCloseArea() )
				dbSelectArea( cAliasQuery )
				
			Else				

				/*
				здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				Ё Zera o Abono e Limpa o Motivo								   Ё
				юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
				cChave1 := ( cAliasQuery )->( cChave + Dtos(PK_DATA)+ PK_CODEVE + PK_TPMARCA + PK_CC )
				IF ( cAliasSPC )->( dbSeek( cChave1 ) )
					IF ( cAliasSPC )->( RecLock( "SPC" , .F. ) )
						( cAliasSPC )->( PC_QTABONO	)	:= 0.00
	               		( cAliasSPC )->( PC_ABONO	)	:= cLimpaMotAbo
						( cAliasSPC )->( MsUnLock() )
					EndIF
				EndIF

			EndIF
			
			#IFNDEF TOP
				aAdd( aRecnos , ( cAliasQuery )->( Recno() ) )
			#ELSE
				IF !( lQueryOpened )
					aAdd( aRecnos , ( cAliasQuery )->( Recno() ) )
				Else
					aAdd( aRecnos , ( cAliasQuery )->( RECNO ) )
				EndIF	
			#ENDIF	
		
		EndIF
        
		( cAliasQuery )->( dbSkip() )
		
	End While

	#IFDEF TOP

		nRecnos := Len( aSpcRecnos )
		For nRecno := 1 To nRecnos
			cQuerySPC := "UPDATE "
			IF ( lExInAs400 )
				cQuerySPC += cDataBase+"/"+cSpcRetSqln
			Else
				cQuerySPC += cSpcRetSqln
			EndIF
			cQuerySPC += " SET "
			cQuerySPC += "PC_QTABONO=0 , "
			cQuerySPC += "PC_ABONO='" + cLimpaMotAbo + "'"
			cQuerySPC += " WHERE "
			cQuerySPC += cCpoRecno + "=" + AllTrim( Str( aSpcRecnos[ nRecno ] , 18 , 0 ) )
			TcSqlExec( cQuerySPC )
		Next nRecno
		IF ( lQueryOpened )
			( cAliasQuery )->( dbCloseArea() )
		EndIF

	#ENDIF	

EndIF

dbSelectArea( cSvAlias )

Return( lExistAbono )


#IFDEF TOP

	/*
	зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
	ЁFun┤┘o    ЁCountDele	    ЁAutorЁMarinaldo de Jesus Ё Data Ё28/01/2003Ё
	цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
	ЁDescri┤┘o ЁConta Registros para ver se deve haver delecao				Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁSintaxe   Ё<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁParametrosЁ<Vide Parametros Formais>									Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	Ё Uso      ЁPONM050 													Ё
	юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	Static Function CountDele(	cAlias		,;
								cPrefixo	,;
								cFil		,;
								cMat		,;
								cIniData	,;
								cFimData	,;
								cRetSqlName	 ;
							 )
	
	Local cSvAlias	 := Alias()	
	Local nCountDele := 0.00

	/*
	здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Verifica o Total de Registros a Serem Processados            Ё
	юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	cQuery := "SELECT COUNT(*) NCOUNTDELE "
	cQuery += " FROM "
	cQuery += cRetSqlName
	cQuery += " WHERE "
	cQuery += cPrefixo+"FILIAL='"+cFil+"'"
	cQuery += " AND "  
	cQuery += cPrefixo+"MAT='"+cMat+"'"
	cQuery += " AND "  
	cQuery += " ( "
	cQuery += 		cPrefixo+"DATA>='"+cIniData+"'"
	cQuery += 		" AND "  
	cQuery += 		cPrefixo+"DATA<='"+cFimData+"'"
	cQuery += " ) "
	cQuery := ChangeQuery(cQuery)
	IF MsOpenDbf(.T.,"TOPCONN",TcGenQry(,,cQuery),"__RECSDELE")
		nCountDele := __RECSDELE->NCOUNTDELE
		__RECSDELE->( dbCloseArea() )
	EndIF

	dbSelectArea( cSvAlias )
	
	Return( nCountDele )

#ENDIF

/*
зддддддддддбддддддддддддддддбдддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤┘o    ЁRetTipoExclu    ЁAutorЁMarinaldo de Jesus Ё Data Ё02/04/2003Ё
цддддддддддеддддддддддддддддадддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤┘o ЁRetorna o Tipo para Exclusao                  				Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   Ё<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametrosЁ<Vide Parametros Formais>									Ё
цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPONM050 													Ё
юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
Static Function RetTipoExclu( nMvPar )
Return( IF(nMvPar==1,"G",IF(nMvPar==2,"I",IF(nMvPar==3,"E",IF(nMvPar==4,"M","A")))) )

#IFDEF TOP

	/*
	зддддддддддбддддддддддддддбдддддбдддддддддддддддддддддбддддддбдддддддддд©
	ЁFun┤┘o	   ЁReOpenFiles   ЁAutorЁEquipe Advanded RH   Ё Data Ё11/03/2004Ё
	цддддддддддеддддддддддддддадддддадддддддддддддддддддддаддддддадддддддддд╢
	ЁDescri┤┘o ЁReabre os Arquivos em Modo Compartilhado					Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁSintaxe   Ё<Vide parametros Formais>                                   Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	ЁParametrosЁ<Vide parametros Formais>                                   Ё
	цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
	Ё Uso	   ЁPONM090   												    Ё
	юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	Static Function ReOpenFiles( aFilesReOpen )
	
	Local nLoop
	Local nLoops
	
	nLoops := Len( aFilesReOpen )
	For nLoop := 1 To nLoops
	    ( aFilesReOpen[ nLoop ] )->( dbCloseArea() )
	    ChkFile( aFilesReOpen[ nLoop ] )
	Next nLoop
	
	Return( NIL )

#ENDIF
/*
зддддддддддбдддддддддддддддбдддддддбдддддддддддддддддддбддддддбдддддддддд©
ЁFun┤└o    ЁDeleTopApont   Ё Autor ЁMauricio MR        Ё Data Ё03/05/2005Ё
цддддддддддедддддддддддддддадддддддадддддддддддддддддддаддддддадддддддддд╢
ЁDescri┤└o ЁDeleta as marcacoes conforme o periodo informado		     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁSintaxe   ЁDeleTopApont()												 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁParametro Ё															 Ё
Ё          ЁdPerIni  		-> Data Inicial			                     Ё
Ё          ЁdPerFim  		-> Data Final			         		     Ё
Ё          ЁdPerIni   	-> Inicio Periodo de Apontamento				 Ё
Ё          Ё               Retornado.                               	 Ё
Ё          ЁdPerFim   	-> Final do Periodo de Apontamento				 Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁRetorno   ЁNIL                                                  	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
ЁObserva┤└oЁ                                                      	     Ё
цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
Ё Uso      ЁPonm050			                                             Ё
юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/

Static Function DeleTopApont( lSP8, lSPG, dPerIni , dPerFim, cLastFil, nLimpa, cTipo)

Local aPeriodos		:= {}
Local aMarcacoes	:= {}
Local aTabCalend	:= {}
Local aTabPadrao	:= {}
Local aTurnos		:= {}
Local cOrdem	
Local cTurno		:= ""
Local cSeq			:= ""   
Local dData
Local dDataApo		:= Ctod("//")
Local dMarcIni   	:= Ctod("//")	//-- Data Inicial a Considerar para Recuperar as Marcacoes
Local dMarcFim   	:= Ctod("//")	//-- Data Final a Considerar para Recuperar as Marcacoes
Local dPerCorrIni
Local dPerCorrFim
Local lImpAcum   	:= .F.  
Local cMsgErr		:= ""   
Local nDia
Local nDias
Local nMarc  
Local nPosMarc
Local nTab
Local nX  

oPeriodo:dDataIni := dPerIni
oPeriodo:dDataFim := dPerFim

//Faz a eliminacao duas vezes, primeiro do acumulado e depois do movimento, com o periodo completo.
//Se faz necessario o processamento desta forma pois, se for informado uma data inicial e final que englobe
//varios periodos, nao sera possivel saber qual e aberto e qual e fechado pois os periodos nao sao continuos.
For nX := 1 To 2
   	/*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	ЁVerifica se eh Acumulado e a Eliminacao NAO eh de Acumulado	  Ё
	ЁVerifica se NAO eh Acumulado e a Eliminacao NAO eh do Mes Aberto Ё
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	
	If nX == 1
		lImpAcum := .T.
	Else
		lImpAcum := .F.
	EndIf

	If lImpAcum .and. ( !lSPG )
	   Loop
	ElseIf ( !lImpAcum ) .and. ( !lSP8 )
	   Loop
	Endif   
    
    /*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Retorna Turno/Sequencia das Marca┤■es Acumuladas			  Ё
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF ( lImpAcum ) 
	    cAlias:= "SPG"
		IF SPF->( dbSeek( SRA->( RA_FILIAL + RA_MAT ) + Dtos( dPerIni) ) ) .and. !Empty(SPF->PF_SEQUEPA)
			cTurno	:= SPF->PF_TURNOPA
			cSeq	:= SPF->PF_SEQUEPA
		Else
    		/*
			зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			Ё Tenta Achar a Sequencia Inicial utilizando RetSeq()Ё
			юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
			IF !RetSeq(cSeq,@cTurno,dPerIni,dPerFim,dDataBase,aTabPadrao,@cSeq) .or. Empty( cSeq )
    			/*
				зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				ЁTenta Achar a Sequencia Inicial utilizando fQualSeq()		  Ё
				юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
				cSeq := fQualSeq( NIL , aTabPadrao , dPerIni , @cTurno )
			EndIF
		EndIF
	Else
	    cAlias:= "SP8"
   			/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		ЁConsidera a Sequencia e Turno do Cadastro            		  Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		cTurno	:= SRA->RA_TNOTRAB
		cSeq	:= SRA->RA_SEQTURN
	EndIF

    /*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Carrega Arrays com as Marca┤■es do Periodo (aMarcacoes), comЁ
	Ёo Calendario de Marca┤■es do Periodo (aTabCalend) e com    asЁ	
	ЁTrocas de Turno do Funcionario (aTurnos)					  Ё	
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	( aMarcacoes := {} , aTabCalend := {} , aTurnos := {} )   
    /*
	зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	Ё Importante: 												  Ё
	Ё O periodo fornecido abaixo para recuperar as marcacoes   corЁ
	Ё respondente ao periodo de apontamentoo Calendario de 	 MarcaЁ	
	Ё ┤■es do Periodo ( aTabCalend ) e com  as Trocas de Turno  doЁ	
	Ё Funcionario ( aTurnos ) integral afim de criar o  calendarioЁ	
	Ё com as ordens correspondentes as gravadas nas marcacoes	  Ё	
	юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
	IF !GetMarcacoes(	@aMarcacoes					,;	//Marcacoes dos Funcionarios
						@aTabCalend					,;	//Calendario de Marcacoes
						@aTabPadrao					,;	//Tabela Padrao
						@aTurnos					,;	//Turnos de Trabalho
						dPerIni 			   		,;	//Periodo Inicial
						dPerFim						,;	//Periodo Final
						SRA->RA_FILIAL				,;	//Filial
						SRA->RA_MAT					,;	//Matricula
						cTurno						,;	//Turno
						cSeq						,;	//Sequencia de Turno
						SRA->RA_CC					,;	//Centro de Custo
						IF(lImpAcum,"SPG","SP8")	,;	//Alias para Carga das Marcacoes
						.T.							,;	//Se carrega Recno em aMarcacoes
						NIL							,;	//Se considera Apenas Ordenadas
					    .T.    						,;	//Se Verifica as Folgas Automaticas
					  	.F.    			 			,;	//Se Grava Evento de Folga Automatica Periodo Anterior 
				  	  	NIL							,;
					 	NIL							,;
					 	NIL							,;
					  	.F.							,;
					  	NIL							,;
					  	.T.							,;  //Se considera data de apontamento
					  	.T.							;	//Se considera data inicial						  	
				 )
		Loop
	EndIF					 

	nDias := ( dPerFim - dPerIni )
	For nDia := 0 To nDias
		//-- Reinicializa Variaveis.
		dData  := dPerIni + nDia		
		//-- o Array aTabcalend ┌ setado para a 1a Entrada do dia em quest└o.
		IF ( nTab := aScan(aTabCalend, {|x| x[1] == dData .And. x[4] == '1E' }) ) == 0.00
			Loop
		EndIF
        
		//-- o Array aMarcacoes ┌ setado para a 1a Marca┤└o do dia em quest└o.
//		cOrdem  	:= aTabCalend[nTab, CALEND_POS_ORDEM]
		dDataApo  	:= aTabCalend[nTab, CALEND_POS_DATA_APO]
//		If ( ( nPosMarc 	:= aScan( aMarcacoes, { |x| x[ AMARC_ORDEM  ] == cOrdem } ) ) > 0 )
		If ( ( nPosMarc 	:= aScan( aMarcacoes, { |x| x[ AMARC_DATAAPO  ] == dDataApo } ) ) > 0 )
			For nMarc:= nPosMarc To Len(aMarcacoes)
//			    If aMarcacoes[nMarc, AMARC_ORDEM ] ==  cOrdem
			    If aMarcacoes[nMarc, AMARC_DATAAPO ] ==  dDataApo 
			    	If nLimpa == 1 .or.  aMarcacoes[nMarc, AMARC_FLAG ] == cTipo
				        (cAlias)->(dbGoto( aMarcacoes[nMarc, AMARC_RECNO ] ) )
						RecLock( cAlias , .F. ) 
						IF !( cAlias )->( FkDelete( @cMsgErr ) )
							( cAlias )->( RollBackDelTran( cMsgErr ) )
						EndIF
						( cAlias )->( MsUnLock() ) 
					Endif
			    Else
			       Exit
			    Endif   
			Next nMarc
		Endif
    Next nDia
Next nX
Return	