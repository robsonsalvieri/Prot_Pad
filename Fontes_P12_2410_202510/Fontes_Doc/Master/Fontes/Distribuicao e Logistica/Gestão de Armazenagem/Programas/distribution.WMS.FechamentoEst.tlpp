#include "tlpp-core.th"
#include "tlpp-rest.th"
#INCLUDE "distribution.WMS.FechamentoEst.CH"
#INCLUDE "Fwlibversion.ch"

namespace distribution.WMS.FechamentoEst
using namespace ac.Reopening.OfStock.Repository
using namespace ac.Reopening.OfStock.Service

Class DistributionWmsFechEst
    public data     dMVULMES        as date
    public data     cMsgErro        as Character
    public data     oService        as Object
    public Method   New()
    public Method   DeleteWmsFechEst()
    public Method   WmsConsultD15()
        
EndClass

/*/{Protheus.doc} New()
    Metodo responsavel por instanciar e iniciar as variaveis da class acList
    @type  Function
	@author murilo.brandao
	@since 03/08/2023
	@version 1.0
/*/
METHOD new() class DistributionWmsFechEst
    ::dMVULMES     := GetMV("MV_ULMES")
    ::cMsgErro     := " "
Return 

/*/{Protheus.doc} DeleteWmsFechEst
	Função para processar exclusão de registros das tabelas de fechamento do WMS 
	@type  Function
	@author murilo.brandao
	@since 03/08/2023
	@version 1.0
	@param cAlias, caracter, Alias da tabela cujos registros serao excluidos
	@param dMVULMES, date, data do fechamento que está sendo desfeito
/*/
METHOD DeleteWmsFechEst(cAlias,dMVULMES,oRepository,cMsgErro) Class DistributionWmsFechEst
    Local cQuery    := ""
    Local nTotReg   := 0
    Local lRet      := .T.
    
    ::oService:= ac.Reopening.OfStock.Service.acReopeningOfStockServ():new()
    ::oService:literature(cAlias)
    
    nTotReg := ::WmsConsultD15(cAlias,dMVULMES)
    
    oRepository:ReopeningLog("MENSAGEM", STR0001 + " - ", + cAlias + " : " + STR0002 + STR0003 + AllTrim(Str(nTotReg))) 
    
    IF nTotReg > 0
        cQuery := "DELETE FROM " +RetSQLName(cAlias) +" WHERE D_E_L_E_T_ = ' ' AND "
        cQuery += cAlias +"_FILIAL = '" +xFilial(cAlias) +"' AND "
        cQuery += cAlias +"_DATA = '" +DToS(dMVULMES) +"'"
        Iif(TCSQLExec(cQuery) < 0, lRet := .F., lRet)

        oRepository:ReopeningLog("MENSAGEM",STR0001 +" - "+ STR0002 +cAlias +": " +::oService:cNomeTab,AllTrim(Str(nTotReg)) +" registros processados.", '5'+::oService:cNameStep ,  ) // FILIAL Término de exclusão
    EndIf
    
Return lRet

/*/{Protheus.doc} WmsConsultD15
	Meódo desenvolvido para validar os registro da tabela D15
	@type  Function
	@author murilo.brandao
	@since 07/08/2023
	@version 1.0
	@param cAlias, caracter, Alias da tabela cujos registros serao excluidos
	@param dMVULMES, date, data do fechamento que está sendo desfeito
/*/
METHOD WmsConsultD15(cAlias,dMVULMES) Class DistributionWmsFechEst
    Local cQuery    := ""
    Local nTotReg   := 0
    
    cQuery := "SELECT COUNT(*) TOTREG FROM " +RetSQLName(cAlias) +" WHERE D_E_L_E_T_ = ' ' AND "
    cQuery += (cAlias) +"_FILIAL = '" +xFilial(cAlias) +"' AND "
    cQuery += (cAlias) +"_DATA = '" +DToS(dMVULMES) +"'"
    dbUseArea(.T.,"TOPCONN",TCGenQry(,,cQuery),"TMP",.F.,.T.)
    nTotReg := TMP->TOTREG
    TMP->(dbCloseArea())

    Return nTotReg
