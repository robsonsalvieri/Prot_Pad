#include "tlpp-core.th"
#include "tlpp-rest.th"

#define INTEGRADO WMSSaasConvergencia():getStatusIntegrado()
#define CANCELADO WMSSaasConvergencia():getStatusCancelado()
#define FINALIZADO WMSSaasConvergencia():getStatusFinalizado()

@Post("/wms/api/v2/pedidosVenda/atualizarParaIntegradoPorChaveExterna")
Function WMSSaasPedidoVendaAtualizar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoPedidoVenda(), INTEGRADO)
Return

@Post("/wms/api/v2/pedidosVenda/faturados/atualizarParaIntegradoPorChaveExterna")
Function WMSSaasPedidoVendaFaturadoAtualizar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoFaturamentoPedidoVenda(), FINALIZADO)
Return

@Post("/wms/api/v2/pedidosVenda/finalizarSeparacaoPorChaveExterna")
Function WMSSaasPedidoVendaFinalizar()
Local oAdapter := WMSSaasPedidoVendaAdapter():New()
    Conout("Executa methodo WMSSaasFinish para finalizar pedido venda.")
    WMSSaasFinish(oRest, oAdapter)
Return

@Post("/wms/api/v2/pedidosVenda/cancelarPorChaveExterna")
Function WMSSaasPedidoVendaCancelar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoPedidoVenda(), CANCELADO)
Return

/*/{Protheus.doc} WMSSaasPedidoVendaGetAll
    Servico de retorno da api de getAll pedidoVendas
    @author Filipe Mendes
    @since 15/05/2024
    @version 1.0
    @obs Funcao para tratar get dos pedidos de venda
    /*/
@Get("/wms/api/v2/pedidosVenda")
Function WMSSaasPedidoVendaGetAll()
Local oError
Local oSuccess := WMSSaasRestFinish():new(@oRest)
Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oPedidoVenda := WMSSaasPedidoVendaAdapter():getAll(oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oPedidoVenda:GetJSONResponse())
        
        FwFreeObj(oPedidoVenda)
	Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasPedidoVendaGetById
    Servico de retorno da api de getId pedidoVendas
    @author Filipe Mendes
    @since 15/05/2024
    @version 1.0
    @obs funcao para pegar os pedidos de venda por Id
    /*/
@Post("/wms/api/v2/pedidosVenda/buscarPorChaveExterna")
Function WMSSaasPedidoVendaGetById()
Local oError
Local oSuccess := WMSSaasRestFinish():new(@oRest)
Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oJsonBody := WMSSaasParseBodyFromRest(oRest)
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oPedidoVenda := WMSSaasPedidoVendaAdapter():getById(oJsonBody['dadosExternos']['id'],oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oPedidoVenda:GetJSONResponse())
        
        FwFreeObj(oPedidoVenda)
	Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasBuscarPedidosFaturados
    Servico de retorno da api de pedidos faturados
    @author Fagner Ferraz
    @since 18/10/2024
    @version 1.0
    @obs Funcao para tratar get dos pedidos de venda
    /*/
@Get("/wms/api/v2/pedidosVenda/buscarFaturados")
Function WMSSaasBuscarPedidosFaturados()
Local oError
Local oSuccess := WMSSaasRestFinish():new(@oRest)
Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oPedidoVenda := WMSSaasPedidoVendaAdapter():getPedidosFaturados(oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oPedidoVenda:GetJSONResponse())
        
        FwFreeObj(oPedidoVenda)
	Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return
