#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "distribution.convergencia.api.estoque.transferencia.ch"

#define INTEGRADO WMSSaasConvergencia():getStatusIntegrado()
#define CANCELADO WMSSaasConvergencia():getStatusCancelado()

/*/{Protheus.doc} Function WMSSaasEstoqueTransferenciaEntradaGetById()
    Servico de retorno da api getId das transferencia de entrada (Devolucao)
    @author Alexsander Burigo Correa
    @since 19/02/2025
    @version 1.0
    @obs funcao para pegar as transferencia de entrada por Id
    /*/
@Post("/wms/api/v2/transferenciasEntrada/buscarPorChaveExterna")
Function WMSSaasEstoqueTransferenciaEntradaGetById()
Local oJsonBody                  As Object
Local oError                     As Object
Local oQueryParams               As Object
Local oEstoqueTransfenciaEntrada As Object
Local oSuccess                   := WMSSaasRestFinish():new(@oRest)
Local bError                     := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oJsonBody := WMSSaasParseBodyFromRest(oRest)
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oEstoqueTransfenciaEntrada := WMSSaasEstoqueTransferenciaEntradaAdapter():getById(oJsonBody['dadosExternos']['id'],oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oEstoqueTransfenciaEntrada:GetJSONResponse())
        
        FwFreeObj(oEstoqueTransfenciaEntrada)
	Recover using oError
		SetRestFault(oError:getStatus(),oError:getDescription(),.T.,oError:getStatus(),oError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaEntradaGetAll
    Servico de retorno da api getAll das requisicoes de manufatura 
    @author Alexsander Burigo Correa
    @since 19/02/2025
    @version 1.0
    @obs Funcao para tratar get das requisicoes de manufatura
    /*/
@Get("/wms/api/v2/transferenciasEntrada")
Function WMSSaasEstoqueTransferenciaEntradaGetAll()
Local oError                     As Object
Local oQueryParams               As Object
Local oEstoqueTransfenciaEntrada As Object
Local oSuccess                   := WMSSaasRestFinish():new(@oRest)
Local bError                     := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oEstoqueTransfenciaEntrada := WMSSaasEstoqueTransferenciaEntradaAdapter():getAll(oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oEstoqueTransfenciaEntrada:GetJSONResponse())
        
        FwFreeObj(oEstoqueTransfenciaEntrada)
	Recover using oError
		SetRestFault(oError:getStatus(),oError:getDescription(),.T.,oError:getStatus(),oError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} Function WMSSaasEstoqueTransferenciaSaidaGetById()
    Servico de retorno da api getId das transferencia de saida (Requisicao)
    @author Alexsander Burigo Correa
    @since 19/02/2025
    @version 1.0
    @obs funcao para pegar as transferencia de saida por Id
    /*/
@Post("/wms/api/v2/transferenciasSaida/buscarPorChaveExterna")
Function WMSSaasEstoqueTransferenciaSaidaGetById()
Local oJsonBody                As Object
Local oError                   As Object
Local oQueryParams             As Object
Local oEstoqueTransfenciaSaida As Object
Local oSuccess                 := WMSSaasRestFinish():new(@oRest)
Local bError                   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oJsonBody := WMSSaasParseBodyFromRest(oRest)
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oEstoqueTransfenciaSaida := WMSSaasEstoqueTransferenciaSaidaAdapter():getById(oJsonBody['dadosExternos']['id'],oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oEstoqueTransfenciaSaida:GetJSONResponse())
        
        FwFreeObj(oEstoqueTransfenciaSaida)
	Recover using oError
		SetRestFault(oError:getStatus(),oError:getDescription(),.T.,oError:getStatus(),oError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaSaidaGetAll
    Servico de retorno da api getAll das requisicoes de manufatura 
    @author Alexsander Burigo Correa
    @since 19/02/2025
    @version 1.0
    @obs Funcao para tratar get das requisicoes de manufatura
    /*/
@Get("/wms/api/v2/transferenciasSaida")
Function WMSSaasEstoqueTransferenciaSaidaGetAll()
Local oError                   As Object
Local oQueryParams             As Object
Local oEstoqueTransfenciaSaida As Object
Local oSuccess                 := WMSSaasRestFinish():new(@oRest)
Local bError                   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oEstoqueTransfenciaSaida := WMSSaasEstoqueTransferenciaSaidaAdapter():getAll(oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oEstoqueTransfenciaSaida:GetJSONResponse())
        
        FwFreeObj(oEstoqueTransfenciaSaida)
	Recover using oError
		SetRestFault(oError:getStatus(),oError:getDescription(),.T.,oError:getStatus(),oError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaEntradaAtualizar
    Servico de mudanca do status da convergencia para integrado
    @author Roselaine
    @since 28/02/2025
    @version 1.0
    /*/
@Post("/wms/api/v2/transferenciasEntrada/atualizarParaIntegradoPorChaveExterna")
Function WMSSaasEstoqueTransferenciaEntradaAtualizar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoEstoqueTransferenciaEntrada(), INTEGRADO)
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaEntradaCancelar
    Servico de mudanca do status da convergencia para integrado
    @author Roselaine
    @since 28/02/2025
    @version 1.0
    /*/
@Post("/wms/api/v2/transferenciasEntrada/cancelarPorChaveExterna")
Function WMSSaasEstoqueTransferenciaEntradaCancelar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoEstoqueTransferenciaEntrada(), CANCELADO)
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaSaidaAtualizar
    Servico de mudanca do status da convergencia para integrado
    @author Roselaine
    @since 28/02/2025
    @version 1.0
    /*/
@Post("/wms/api/v2/transferenciasSaida/atualizarParaIntegradoPorChaveExterna")
Function WMSSaasEstoqueTransferenciaSaidaAtualizar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoEstoqueTransferenciaSaida(), INTEGRADO)
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaEntradaCancelar
    Servico de mudanca do status da convergencia para integrado
    @author Roselaine
    @since 28/02/2025
    @version 1.0
    /*/
@Post("/wms/api/v2/transferenciasSaida/cancelarPorChaveExterna")
Function WMSSaasEstoqueTransferenciaSaidaCancelar()
    WMSSaasUpdateStatus(oRest, WMSSaasConvergencia():getTipoTransacaoEstoqueTransferenciaSaida(), CANCELADO)
Return

/*/{Protheus.doc} WMSSaasEstoqueTransferenciaEntradaFinalizar
    Servico de mudanca do status da convergencia para integrado
    @author Roselaine
    @since 05/03/2025
    @version 1.0
    /*/
@Post("/wms/api/v2/transferenciasEntrada/finalizarConferenciaPorChaveExterna")
Function WMSaasEstoqueTransferenciaEntradaFinalizar()
Local oAdapter := WMSSaasEstoqueTransferenciaEntradaAdapter():New()
    WMSSaasFinish(oRest, oAdapter)
Return

/*/{Protheus.doc} WMSaasEstoqueTransferenciaSaidaFinalizar
    Servico de finalizacao de separacao de requisicao 
    @author Roselaine Adriano
    @since 10/03/2025
    @version 1.0
    @obs Camada de API
    /*/
@Post("/wms/api/v2/transferenciasSaida/finalizarSeparacaoPorChaveExterna")
Function WMSaasEstoqueTransferenciaSaidaFinalizar()
    Local oError
    Local oSuccess := WMSSaasRestFinish():new(@oRest)
    Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oJsonBody   := WMSSaasparseBodyFromRest(oRest)
        If WMSSaasEstoqueTransferenciaSaidaAdapter():finaliza(oJsonBody)
            oSuccess:setStatus(200)
            oSuccess:setJsonResponse(STR0001) // Registro finalizado com sucesso. 
        Else
            oSuccess:setStatus(400)
            oSuccess:setJsonResponse(STR0002+oJsonBody['dadosExternos']['id']) //"Falha ao  finalizar o registro de id "
        EndIf
    
    Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return
