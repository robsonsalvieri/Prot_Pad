#include "tlpp-core.th"
#include "TBICONN.CH"
#include "distribution.convergencia.convergencia.classe.ch"

// Definicao dos status
#define CRIADO "01"
#define LIBERADO "02"
#define INTEGRADO "03"
#define ERRO_INTEGRACAO "04"
#define CANCELADO "05"
#define FINALIZADO "06"
#define FINALIZADO_COM_DIVERGENCIA "07"

#define RECEBIMENTO "01"
#define PEDIDO_VENDA "02"
#define FATURAMENTO_PEDIDO_VENDA "03"
#define ESTOQUE_INVENTARIO "04"
#define ESTOQUE_MOVIMENTO_SIMPLIFICADO "05"
#define ESTOQUE_MOVIMENTO_TRANSFERENCIA "06"
#define FATURAMENTO_ANTECIPADO "07"
#define MANUFATURA_REQUISICAO "08"
#define MANUFATURA_APONTAMENTO_PRODUCAO "09"
#define ESTOQUE_TRANSFERENCIA_ENTRADA "10"
#define ESTOQUE_TRANSFERENCIA_SAIDA "11"
#define ESTOQUE_REQUISICAO_ARMAZEM "12"

#define PROPRIEDADE_LOTE "lote"
#define PROPRIEDADE_DATAVALIDADE "dataValidade"

Static nTamSeqInt   := TamSX3("DBZ_SEQINT")[1]

/*/{Protheus.doc} statusConvergencia
    (long_description)
    @type  Static Function
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    @example
    (examples)
    @see (links_or_references)
/*/
Static Function statusConvergencia() as object
  oHash := tHashMap():new()
  oHash:Set(CRIADO,STR0001)
  oHash:Set(LIBERADO,STR0002)
  oHash:Set(INTEGRADO,STR0003)
  oHash:Set(ERRO_INTEGRACAO,STR0004)
  oHash:Set(CANCELADO,STR0005)
  oHash:Set(FINALIZADO,STR0006)
  oHash:Set(FINALIZADO_COM_DIVERGENCIA,STR0007)
Return oHash

/*/{Protheus.doc} WMSSaasConvergencia
    (long_description)
    @author Filipe Mendes
    @since 15/04/2024
    @version 1.0
    @obs Classe para gerenciamento das transacoes na tabela
    de convergencia WMS Saas x Protheus
    /*/
Class WMSSaasConvergencia
    Public Method new() as object
    Public Method load() as object
    Public Method save()
    Public Method saveItens()
    Public Method loadById(cId as character)
    Public Method delete()
    Static Method getStatusCriado() as character
    Static Method getTamSeqInt() as numeric
    Public Method setLiberado() as object
    Static Method getStatusLiberado() as character
    Public Method setIntegrado() as object
    Static Method getStatusIntegrado() as character
    Public Method setErroIntegracao(cMensagem as character) as object
    Static Method getStatusErroIntegracao() as character
    Public Method setCancelado() as object
    Static Method getStatusCancelado() as character
    Public Method setFinalizado() as object
    Static Method getStatusFinalizado() as character
    Public Method setMensagemIntegracao(cMessage as character) as object
    Public Method getMensagemIntegracao() as character
    Public Method setFinalizadoDivergente() as object
    Static Method getStatusFinalizadoDivergente() as character
    Public Method isCriado() as logical
    Public Method isIntegrado() as logical
    Public Method isErroIntegracao() as logical
    Public Method isCancelado() as logical
    Public Method isFinalizado() as logical
    Public Method isFinalizadoDivergente() as logical
    Public Method getDetalheStatus() as logical
    Static Method getTipoTransacaoRecebimento() as character
    Static Method getTipoTransacaoPedidoVenda() as character
    Static Method getTipoTransacaoFaturamentoPedidoVenda() as character
    Static Method getTipoTransacaoEstoqueInventario() as character
    Static Method getTipoTransacaoEstoqueMovimentoSimplificado() as character
    Static Method getTipoTransacaoEstoqueMovimentoTransferencia() as character
    Static Method getTipoTransacaoFaturamentoAntecipado() as character
    Static Method getTipoTransacaoManufaturaRequisicao() as character
    Static Method getTipoTransacaoManufaturaApontamentoProducao() as character
    Static Method getTipoTransacaoEstoqueTransferenciaEntrada() as character
    Static Method getTipoTransacaoEstoqueTransferenciaSaida() as character
    Static Method getTipoTransacaoEstoqueRequisicaoArmazem() as character
    Public Method getAllItems() as array
    Public Method getItem(cItem as character, cProduto as character, cSequencia as character) as object
    Static Method isStatusDisponivelLiberacao(cStatus as character) as logical
    Public Method getNomePessoa() as character
    Static Method getPropriedadeLote() as character
    Static Method getPropriedadeDataValidade() as character
    Public Data id as character
    Public Data status as character
    Public Data tipoTransacao as character
    Public Data numeroDocumento as character
    Public Data serieDocumento as character 
    Public Data clienteOuFornecedor as character
    Public Data loja as character
    Public Data dataCriacao as character
    Public Data dataEmissao as date
    Public Data transportador as character
    Public Data chaveNfe as character
    Public Data sequenciaIntegracao as character
    Public Data carga as character
    Public Data idSaas as character
    Public Data ordemProducao as character
    Public Data mensagemIntegracao as character
    Public Data itensConvergencia as array
    Public Data itemConvergencia as object
EndClass

/*/{Protheus.doc} new
    (long_description)
    @author Filipe Mendes
    @since 15/04/2024
    @version version
    @return return_var, return_type, return_description
    /*/
Method new() Class WMSSaasConvergencia
    self:id          := ""
    self:status      := CRIADO
    self:dataCriacao := FWTimeStamp(3, dDataBase, Time())
Return self

/*/{Protheus.doc} LoadById
    Instancia um novo objeto a partir do id
    @author user
    @since 15/04/2024
    @version version
    @param cId, character, Id do registro na tabela (DBZ_ID)
    @return self, object, classe instanciada
    /*/
Method loadById(cId as character) Class WMSSaasConvergencia
Local aArea    := GetArea()
Local aAreaDBZ := DBZ->(GetArea())  
Local newSelf  := self:new()  
    If WMSSaasSeekDBZById(cId)
        newSelf:load()
    EndIf
    RestArea(aAreaDBZ)
    RestArea(aArea)
Return newSelf

/*/{Protheus.doc} setLiberado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setLiberado() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_STATUS := LIBERADO
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setIntegrado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setIntegrado() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_STATUS := INTEGRADO
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setErroIntegracao
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setErroIntegracao(cMensagem) Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_MSGINT := EncodeUTF8(cMensagem)
        DBZ->DBZ_STATUS := ERRO_INTEGRACAO
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setCancelado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setCancelado() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_STATUS := CANCELADO
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setFinalizado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setFinalizado() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_STATUS := FINALIZADO
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setFinalizadoDivergente
    Seta o status da integracao para Finalizado com Divergencia
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method setFinalizadoDivergente() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_STATUS := FINALIZADO_COM_DIVERGENCIA
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} setMensagemIntegracao 
    Seta a mensagem da integracao.
    @author user
    @since 02/05/2024
    @version version
    @param cMessage, character, Mensagem a ser gravada no memo
    @return self, object, objeto atualizado
    /*/
Method setMensagemIntegracao(cMessage) Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ", .F.)
        DBZ->DBZ_MSGINT := cMessage
        DBZ->(MsUnlock())
        self:load()
    EndIf
Return self

/*/{Protheus.doc} getMensagemIntegracao
    @author user
    @since 03/06/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method getMensagemIntegracao() Class WMSSaasConvergencia as character
Return self:mensagemIntegracao

/*/{Protheus.doc} isCriado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh criado
    /*/
Method isCriado() Class WMSSaasConvergencia
Return self:status == CRIADO

/*/{Protheus.doc} isIntegrado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh integrado
    /*/
Method isIntegrado() Class WMSSaasConvergencia
Return self:status == INTEGRADO

/*/{Protheus.doc} isErroIntegracao
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh erro na integracao
    /*/
Method isErroIntegracao() Class WMSSaasConvergencia
Return self:status == ERRO_INTEGRACAO

/*/{Protheus.doc} isCancelado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh cancelado
    /*/
Method isCancelado() Class WMSSaasConvergencia
Return self:status == CANCELADO

/*/{Protheus.doc} isFinalizado
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh finalizado
    /*/
Method isFinalizado() Class WMSSaasConvergencia
Return self:status == FINALIZADO

/*/{Protheus.doc} isFinalizadoComDivergencia
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, boolean, indica se eh finalizado com divergencia
    /*/
Method isFinalizadoDivergente() Class WMSSaasConvergencia
Return self:status == FINALIZADO_COM_DIVERGENCIA

/*/{Protheus.doc} getDetalheStatus
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method getDetalheStatus() Class WMSSaasConvergencia
Local detalheStatus
Local oStatus := statusConvergencia()
    oStatus:Get(self:status, detalheStatus)
    // Destruindo objeto para evitar MemoryLeak
    FwFreeObj(oStatus)
Return detalheStatus

/*/{Protheus.doc} Load
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method load() Class WMSSaasConvergencia
    self:id                  := DBZ->DBZ_ID
    self:status              := DBZ->DBZ_STATUS
    self:tipoTransacao       := DBZ->DBZ_TIPOTR
    self:numeroDocumento     := Alltrim(DBZ->DBZ_NUMDOC)
    self:serieDocumento      := Alltrim(DBZ->DBZ_SERIE)
    self:clienteOuFornecedor := Alltrim(DBZ->DBZ_CLIFOR)
    self:loja                := Alltrim(DBZ->DBZ_LOJA)
    self:dataCriacao         := Alltrim(DBZ->DBZ_CRIACA)
    self:dataEmissao         := DBZ->DBZ_EMISSA
    self:transportador       := Alltrim(DBZ->DBZ_TRANSP)
    self:chaveNfe            := Alltrim(DBZ->DBZ_CHVNFE)
    self:sequenciaIntegracao := Alltrim(DBZ->DBZ_SEQINT)
    self:carga               := Alltrim(DBZ->DBZ_CARGA)
    self:mensagemIntegracao  := DBZ->DBZ_MSGINT
    self:itensConvergencia   := self:getAllItems()
    self:idSaas              := DBZ->DBZ_IDSAAS
    self:ordemProducao       := DBZ->DBZ_OP
Return self

/*/{Protheus.doc} Save
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method Save() Class WMSSaasConvergencia
Local lInsert := Empty(self:id)
Local cId     := If(lInsert, FWUUIDV4(.T.), self:id) 

    If !lInsert
        WMSSaasSeekDBZById(cId)
    EndIf

    //Executa funcao para liberar automaticamente
    If !( self:tipoTransacao $ MANUFATURA_REQUISICAO ) //--Desconsidera transacoes que tenham tratamentos proprios para liberacao automatica
        WMSSCanReleaseAutomatically(self:tipoTransacao, self:status, cId)
    EndIf

    If RecLock("DBZ", Empty(self:id))
        DBZ->DBZ_FILIAL := xFilial("DBZ")
        DBZ->DBZ_ID     := cId
        DBZ->DBZ_STATUS := self:status
        DBZ->DBZ_TIPOTR := self:tipoTransacao
        DBZ->DBZ_NUMDOC := self:numeroDocumento
        DBZ->DBZ_SERIE  := self:serieDocumento
        DBZ->DBZ_CLIFOR := self:clienteOuFornecedor
        DBZ->DBZ_LOJA   := self:loja
        DBZ->DBZ_CRIACA := self:dataCriacao
        DBZ->DBZ_EMISSA := self:dataEmissao
        DBZ->DBZ_TRANSP := self:transportador
        DBZ->DBZ_CHVNFE := self:chaveNfe
        DBZ->DBZ_SEQINT := self:sequenciaIntegracao
        DBZ->DBZ_CARGA  := self:carga
        DBZ->DBZ_MSGINT := self:mensagemIntegracao
        DBZ->DBZ_IDSAAS := self:idSaas
        DBZ->DBZ_OP     := self:ordemProducao
        DBZ->(MsUnlock())
    EndIf
    self:id := cId
Return 

/*/{Protheus.doc} Delete
    (long_description)
    @author user
    @since 15/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method delete() Class WMSSaasConvergencia
    If WMSSaasSeekDBZById(self:id) .And. RecLock("DBZ",.F.)
		DBZ->(dbDelete())
		DBZ->(MsUnlock())
        aEval(self:itensConvergencia, {|item| item:delete()})
    EndIf
Return 

Method getTipoTransacaoRecebimento() Class WMSSaasConvergencia
Return RECEBIMENTO

Method getTipoTransacaoPedidoVenda() Class WMSSaasConvergencia
Return PEDIDO_VENDA

Method getTipoTransacaoFaturamentoPedidoVenda() Class WMSSaasConvergencia
Return FATURAMENTO_PEDIDO_VENDA

Method getTipoTransacaoEstoqueInventario() Class WMSSaasConvergencia
Return ESTOQUE_INVENTARIO

Method getTipoTransacaoEstoqueMovimentoSimplificado() Class WMSSaasConvergencia
Return ESTOQUE_MOVIMENTO_SIMPLIFICADO

Method getTipoTransacaoEstoqueMovimentoTransferencia() Class WMSSaasConvergencia
Return ESTOQUE_MOVIMENTO_TRANSFERENCIA

Method getTipoTransacaoFaturamentoAntecipado() Class WMSSaasConvergencia
Return FATURAMENTO_ANTECIPADO

Method getTipoTransacaoManufaturaRequisicao() Class WMSSaasConvergencia
Return MANUFATURA_REQUISICAO

Method getTipoTransacaoManufaturaApontamentoProducao() Class WMSSaasConvergencia
Return MANUFATURA_APONTAMENTO_PRODUCAO

Method getTipoTransacaoEstoqueTransferenciaEntrada() Class WMSSaasConvergencia
Return ESTOQUE_TRANSFERENCIA_ENTRADA

Method getTipoTransacaoEstoqueTransferenciaSaida() Class WMSSaasConvergencia
Return ESTOQUE_TRANSFERENCIA_SAIDA

Method getTipoTransacaoEstoqueRequisicaoArmazem() Class WMSSaasConvergencia
Return ESTOQUE_REQUISICAO_ARMAZEM

Method getStatusLiberado() Class WMSSaasConvergencia
Return LIBERADO

Method getStatusCriado() Class WMSSaasConvergencia
Return CRIADO

Method getStatusIntegrado() Class WMSSaasConvergencia
Return INTEGRADO

Method getStatusErroIntegracao() Class WMSSaasConvergencia
Return ERRO_INTEGRACAO

Method getStatusCancelado() Class WMSSaasConvergencia
Return CANCELADO

Method getStatusFinalizado() Class WMSSaasConvergencia
Return FINALIZADO

Method getStatusFinalizadoDivergente() Class WMSSaasConvergencia
Return FINALIZADO_COM_DIVERGENCIA

Method isStatusDisponivelLiberacao(cStatus) Class WMSSaasConvergencia as logical
return cStatus $ CRIADO+"|"+CANCELADO+"|"+ERRO_INTEGRACAO

Method getPropriedadeLote() Class WMSSaasConvergencia as character
Return PROPRIEDADE_LOTE

Method getPropriedadeDataValidade() Class WMSSaasConvergencia as character
Return PROPRIEDADE_DATAVALIDADE

/*/{Protheus.doc} WMSSaasConvergencia::SaveItens
Efetua a gravacao dos itens da tabela de convergencia
    @type method
    @author fagner.ferraz
    @since 4/22/2024
/*/
Method saveItens() Class WMSSaasConvergencia
Local nI := 0

    For nI := 1 To Len( self:itensConvergencia )
        self:itensConvergencia[nI]:save(self:id)
    Next nI

Return

/*/{Protheus.doc} getAllItems
    (long_description)
    @author user
    @since 25/04/2024
    @version version
    @param param_name, param_type, param_descr
    @return return_var, return_type, return_description
    /*/
Method getAllItems() Class WMSSaasConvergencia as array
Return WMSSaasItemConvergencia():loadAllByParentId(self:id)

/*/{Protheus.doc} getItem
    (long_description)
    @author Alexsander Burigo CorrÃªa
    @since 22/10/2024
    @version 1.0
    @param cItem, character, Item da convergecia
    @param cProduto, character, Produto da convergencia
    @param cSequencia, character, Sequencia da convergencia
    @return objeto, object, Item da convergencia
/*/
Method getItem(cProduto, cItem, cSequencia) Class WMSSaasConvergencia as object
Return WMSSaasFind(self:itensConvergencia, {|x| x:isItem(cProduto, cItem, cSequencia) })

/*/{Protheus.doc} getNomePessoa
    Busca o nome do Cliente ou fornecedor
    @author Alexsander Burigo Correa
    @since 22/10/2024
    @version 1.0
    @return ClienteOuFornecedor, character, Cliente ou fornecedor
/*/
Method getNomePessoa() Class WMSSaasConvergencia as character
Return self:clienteOuFornecedor


/*/{Protheus.doc} getTamSeqInt
    @author user
    @since 18/12/2024
    @version version
    @param param_name, param_type, param_descr
    @return nTamSeqInt, numeric, Tamanho do campo seqint
    /*/
Method getTamSeqInt() Class WMSSaasConvergencia
Return nTamSeqInt
