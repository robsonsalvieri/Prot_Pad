#include "tlpp-core.th"

#define FieldJson 1
#define FieldQuery 2
#define JsonField 3
#define Fixed 4
#define Struct 5
#define RenameField 6

Class WMSSaasConvergenciaAdapter FROM FWAdapterBaseV2
	Public Method getLiberados(cTipoTransacao as character, nPage as integer, nPageSize as integer) as object
	Public Method getCompletoById(cId as character) as object
	Static Method getMapDbz() as array
	Static Method getMapDby() as array

	Public Method montaPayloadCabecalho(cId as character) as json

	Public Data oJsonReturn as json
EndClass

Method getLiberados(cTipoTransacao, nPage, nPageSize) Class WMSSaasConvergenciaAdapter as object
Local aArea     as array
Local cWhere    as character

	// Instancia classe pai
	_Super:new( "GET", .T. )

	aArea   := FwGetArea()
	::SetPage(nPage)
	::SetPageSize(nPageSize)

	::setIsCaseSensitive(.T.)
	//Adiciona o mapa de campos Json/ResultSet
	aEval(self:getMapDbz(), {|mapConfig| self:AddMapFields(mapConfig[FieldJson], mapConfig[FieldQuery], mapConfig[JsonField], mapConfig[Fixed], mapConfig[Struct]) })
	//Informa a Query a ser utilizada pela API
	::SetQuery(" SELECT #QueryFields# FROM "+RetSqlName('DBZ')+" WHERE #QueryWhere#" )
	//Informa a clausula Where da Query
	cWhere := "DBZ_FILIAL = '"+xFilial('DBZ')+"' AND DBZ_STATUS = '"+WMSSaasConvergencia():getStatusLiberado()+"' AND DBZ_TIPOTR = '"+cTipoTransacao+"' AND D_E_L_E_T_ = ' '"
	::SetWhere( cWhere )
	//Informa a ordenacao padrao a ser Utilizada pela Query
	::SetOrder( "DBZ_ID" )
	//Executa a consulta, se retornar .T. tudo ocorreu conforme esperado
	If ::Execute()
		// Gera o arquivo Json com o retorno da Query
		::FillGetResponse()
	EndIf
	FwrestArea(aArea)
Return self

Method GetCompletoById(cId, nPage, nPageSize) Class WMSSaasConvergenciaAdapter as object
Local aArea     as array
Local cWhere    as character
	
	self:oJsonReturn := JsonObject():new()
	// Instancia classe pai
	_Super:new( "GET", .T. )

	aArea   := FwGetArea()
	::SetPage(nPage)
	::SetPageSize(2000)
	//Adiciona o mapa de campos Json/ResultSet

	::setIsCaseSensitive(.T.)
	aEval(self:getMapDby(), {|mapConfig| self:AddMapFields(mapConfig[FieldJson], mapConfig[FieldQuery], mapConfig[JsonField], mapConfig[Fixed], mapConfig[Struct]) })
	//Informa a Query a ser utilizada pela API
	::SetQuery(" SELECT #QueryFields# FROM "+RetSqlName('DBY')+" WHERE #QueryWhere#" )
	//Informa a clausula Where da Query
	cWhere := "DBY_FILIAL = '"+xFilial('DBY')+"' AND DBY_ID = '"+cId+"' AND D_E_L_E_T_ = ' '"
	::SetWhere( cWhere )
	//Informa a ordenacao padrao a ser Utilizada pela Query
	::SetOrder( "DBY_ITEM" )
	//Executa a consulta, se retornar .T. tudo ocorreu conforme esperado
	If ::Execute()
		// Gera o arquivo Json com o retorno da Query
		::FillGetResponse()
	EndIf
	FwrestArea(aArea)
	self:montaPayloadCabecalho(cId)
Return self

Method getMapDbz() Class WMSSaasConvergenciaAdapter as array
Return {;
			{'id'                    , 'DBZ_ID'      , .T., .T., { 'DBZ_ID'          , 'C', TamSX3( 'DBZ_ID')[1]    , 0 } },;
			{'documento'             , 'DBZ_NUMDOC'  , .T., .T., { 'DBZ_NUMDOC'      , 'C', TamSX3( 'DBZ_NUMDOC')[1], 0 } },;
			{'serie'                 , 'DBZ_SERIE'   , .T., .T., { 'DBZ_SERIE'       , 'C', TamSX3( 'DBZ_SERIE')[1] , 0 } },;
			{'pessoa'                , 'DBZ_CLIFOR'  , .T., .T., { 'DBZ_CLIFOR'      , 'C', TamSX3( 'DBZ_CLIFOR')[1], 0 } },;
			{'loja'                  , 'DBZ_LOJA'    , .T., .T., { 'DBZ_LOJA'        , 'C', TamSX3( 'DBZ_LOJA')[1]  , 0 } },;
			{'emissao'               , 'DBZ_EMISSA'  , .T., .T., { 'DBZ_EMISSA'      , 'C', TamSX3( 'DBZ_EMISSA')[1], 0 } },;
			{'timeStamp'             , 'DBZ_CRIACA'  , .T., .T., { 'DBZ_CRIACA'      , 'C', TamSX3( 'DBZ_CRIACA')[1], 0 } },;
			{'transportador'         , 'DBZ_TRANSP'  , .T., .T., { 'DBZ_TRANSP'      , 'C', TamSX3( 'DBZ_TRANSP')[1], 0 } },;
			{'sequenciaIntegracao'   , 'DBZ_SEQINT'  , .T., .T., { 'DBZ_SEQINT'      , 'C', TamSX3( 'DBZ_SEQINT')[1], 0 } },;
			{'carga'                 , 'DBZ_CARGA'   , .T., .T., { 'DBZ_CARGA'       , 'C', TamSX3( 'DBZ_CARGA')[1] , 0 } },;
			{'loja'                  , 'DBZ_LOJA'    , .T., .T., { 'DBZ_LOJA'        , 'C', TamSX3( 'DBZ_LOJA')[1]  , 0 } },;
			{'chaveNfe'              , 'DBZ_CHVNFE'  , .T., .T., { 'DBZ_CHVNFE'      , 'C', TamSX3( 'DBZ_CHVNFE')[1], 0 } },;
			{'idSaas'                , 'DBZ_IDSAAS'  , .T., .T., { 'DBZ_IDSAAS'      , 'C', TamSX3( 'DBZ_IDSAAS')[1], 0 } },; 
			{'ordemProducao'         , 'DBZ_OP'      , .T., .T., { 'DBZ_OP'          , 'C', TamSX3( 'DBZ_OP')[1], 0 } }; 
		}

Method getMapDby() Class WMSSaasConvergenciaAdapter as array
Return {;
			{ 'id'              , 'DBY_ID'      , .T., .T., { 'DBY_ID'          , 'C', TamSX3( 'DBY_ID' )[1], 0 } } ,;
			{ 'produto'        	, 'DBY_PRODUT'  , .T., .T., { 'DBY_PRODUT'      , 'C', TamSX3( 'DBY_PRODUT' )[1], 0 } } ,;
			{ 'item'           	, 'DBY_ITEM'  	, .T., .T., { 'DBY_ITEM'       	, 'C', TamSX3( 'DBY_ITEM' )[1], 0 } } ,;
			{ 'sequencia'      	, 'DBY_SEQUEN'  , .T., .T., { 'DBY_SEQUEN'      , 'C', TamSX3( 'DBY_SEQUEN' )[1], 0 } } ,;
			{ 'quantidade'     	, 'DBY_QUANT'  	, .T., .T., { 'DBY_QUANT'       , 'N', TamSX3( 'DBY_QUANT' )[1], TamSX3( 'DBY_QUANT' )[2] } } ,;
			{ 'valorUnitario'  	, 'DBY_VUNIT'  	, .T., .T., { 'DBY_VUNIT'      	, 'N', TamSX3( 'DBY_VUNIT' )[1], TamSX3( 'DBY_VUNIT' )[2] } } ,;
			{ 'armazem'        	, 'DBY_LOCAL'  	, .T., .T., { 'DBY_LOCAL'      	, 'C', TamSX3( 'DBY_LOCAL' )[1], 0 } } ,;
			{ 'lote'   			, 'DBY_LOTE'  	, .T., .T., { 'DBY_LOTE'      	, 'C', TamSX3( 'DBY_LOTE' )[1], 0 } } ,;
			{ 'seqSaaS' 		, 'DBY_SEQSAS'  , .T., .T., { 'DBY_SEQSAS'     	, 'N', TamSX3( 'DBY_SEQSAS' )[1], 0 } } ,;
			{ 'dataValidade'	, 'DBY_DTVALI'  , .T., .T., { 'DBY_DTVALI'      , 'C', TamSX3( 'DBY_DTVALI' )[1], 0 } } ,;
			{ 'numSeq'			, 'DBY_NUMSEQ'  , .T., .T., { 'DBY_NUMSEQ'      , 'C', TamSX3( 'DBY_NUMSEQ' )[1], 0 } };
		}

Method montaPayloadCabecalho(cId) Class WMSSaasConvergenciaAdapter as json
Local currentJsonObject := @self:oJsonObj:oJsonObj
	DbSelectArea("DBZ")
	DbSetOrder(1)
	DbSeek(xFilial("DBZ")+cId)

	aEval(self:getMapDbz(), {|mapConfig| currentJsonObject[mapConfig[FieldJson]] := WMSSaasTrataDados(DBZ->&(mapConfig[FieldQuery])) })
	DBZ->( DbCloseArea() )
Return currentJsonObject
