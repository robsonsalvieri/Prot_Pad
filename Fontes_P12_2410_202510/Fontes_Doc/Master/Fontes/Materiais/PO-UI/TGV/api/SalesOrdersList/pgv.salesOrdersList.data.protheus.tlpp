#include 'tlpp-core.th'
#include 'tlpp-rest.th'

namespace totvs.protheus.backoffice.pgvSalesOrdersList
using namespace tgv.util

#DEFINE LABEL            1
#DEFINE VALUE            2
#DEFINE STATUS           1
#DEFINE STATUSSQLFILTER  2

//------------------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData
	disponibiliza um classe para consulta de dados da tabela Pedidos SC9,SC5,SD2
	@type class
	@version 12.1.2310
	@author Squad CRM & Faturamento
	@since 17/11/2023
/*/
//------------------------------------------------------------------------------
Class pgvSalesOrdersListProtheusData from FWAdapterBaseV2

	public method new() as Object
	public method get()
	public method setAddMapFields()
	public method getSalesFilter() as Character
	public method getInnerJoin() as Character
	public method RowToJson()

EndClass

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData::new() as object
    Obter uma nova instancia da class pgvSalesOrdersListProtheusData
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return @return object, retorna uma nova instancia da classe
/*/
//-----------------------------------------------------------------------
Method new() as object Class pgvSalesOrdersListProtheusData
	_Super:New("GET", .T.)
Return Self

//------------------------------------------------------------------------------
/*/{Protheus.doc} RowToJson
	Converte o retorno da consulta SQL em JSON

	@sample		oProductData:RowToJson( cAlias, aFields, .F.)
	@type		method
	@param		cAlias	, Character	, Alias da Consulta
	@param		aFields	, Array		, Campos (MapFields)
	@param		lEmpty	, Logical	, Vazio.
	@return     Nil
	@author		Rafael Mota Previdi
	@since		15/01/2024
	@version	12.1.2310
/*/
//------------------------------------------------------------------------------
Method RowToJson( cAlias as Character, aFields as Array , lEmpty as Logical) CLASS pgvSalesOrdersListProtheusData
	Local nLoop		         as Integer
	Local nStatus            as Integer
	Local cStockblock        as Character
	Local cCreditBlock       as Character
	Local nVlrTotalSD2       as Numeric
	Local nQuantityReleased  as Numeric
	Local cBusinessRuleBlock as Character
	Local cContent	         as Character

	Default lEmpty := .T.

	For nLoop := 1 to Len( aFields )
		Do Case 
			Case UPPER(aFields[nLoop, LABEL]) == "STATUS"
				nStatus := nLoop
			Case UPPER(aFields[nLoop, LABEL]) == "STOCKBLOCK"
				cStockblock := (cAlias)->( &(aFields[nLoop, VALUE]) )
			Case UPPER(aFields[nLoop, LABEL]) == "CREDITBLOCK"
				cCreditBlock := (cAlias)->( &(aFields[nLoop, VALUE]) )
			Case UPPER(aFields[nLoop, LABEL]) == "VLR.TOTALSD2"
				nVlrTotalSD2 := (cAlias)->( &(aFields[nLoop, VALUE]) )
			Case UPPER(aFields[nLoop, LABEL]) == "QUANTITYRELEASED"
				nQuantityReleased := (cAlias)->( &(aFields[nLoop, VALUE]) )
			Case UPPER(aFields[nLoop, LABEL]) == "BUSINESSRULEBLOCK"
				cBusinessRuleBlock := (cAlias)->( &(aFields[nLoop, VALUE]) )
		EndCase
		cContent := Self:ValueToJson( aFields[nLoop, LABEL], (cAlias)->( &(aFields[nLoop, VALUE]) )  )
		Self:oJsonObj:setProp( aFields[nLoop, LABEL], cContent, lEmpty )
	Next

	If !Empty(nStatus)
		cContent := ""

		Do Case 
			Case	(!Empty(nQuantityReleased) .And. ((!Empty(cStockblock) .And. cStockblock <> "10") .Or. (!Empty(cCreditBlock) .And. cCreditBlock <> "10"))) ;
					.Or. !Empty(cBusinessRuleBlock)
				cContent := "BLQ"	// Bloqueado
			Case	(!Empty(nVlrTotalSD2) .Or. (cStockblock == "10" .And. cCreditBlock == "10"))
				cContent := "BIL"	// Faturado
			Case	(Empty(nQuantityReleased) .And. Empty(cBusinessRuleBlock))
				cContent := "OPN"	// Aberto
			Case	!Empty(nQuantityReleased) .And. Empty(cStockblock) .And. Empty(cCreditBlock) .And. Empty(cBusinessRuleBlock)
				cContent := "RLS"	// Liberado				
		EndCase

		Self:oJsonObj:setProp( aFields[nStatus, LABEL], cContent, lEmpty )
	EndIf

Return Nil

//------------------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:setAddMapFields
	Cria o Mapa de campos Protheus x API para os Pedidos (SC9, SC5 e SD2).
	@author		Squad CRM & Faturamento
	@param lCard, logical, Indica se será feito a tratativa para Card
	@param lBox, logical, indica se será feito a tratativa para box
	@param lTotVal, logical, indica se será feito a tratativa para valor total
	@param lTotValPeriod, logical, indica se será feito a tratativa para valor total últimos 7 dias
	@param lTopSellers, logical, indica se deve ser feito a tratativa para os top 5 produtos mais vendidos
	@since		17/11/2023
	@version	12.1.2310
/*/
//------------------------------------------------------------------------------
Method setAddMapFields(lCard as logical, lBox as logical, lTotVal as logical, lTotValPeriod as Logical, lTopSellers as Logical) Class pgvSalesOrdersListProtheusData
	Local aInternalId   := GetInternalId( { "C5_FILIAL", "C5_NUM", "C6_ITEM" } )
	Local aOrderId		:= GetInternalId( { "C5_FILIAL", "C5_NUM" } )
	Default lCard 		:= .F.
	Default lBox 		:= .F.
	Default lTopSellers	:= .F.
	
	Do Case
	Case lCard 
		Self:AddMapFields("quantity", "QTD_TOTAL"	 , .T., .F., { "QTD_TOTAL"  , 'N', GetFieldLength("C9_PEDIDO"), GetFieldDecimal("C9_PEDIDO") })
		Self:AddMapFields( "amount" , "VLR_TOTAL"    , .T., .F., { "VLR_TOTAL", 'N', GetFieldLength("C9_PRCVEN") , GetFieldDecimal("C9_PRCVEN") } )
		Self:AddMapFields( "total_type"	, "TIPO"     , .T., .F., { "TIPO", 'C', 16 , 0 }, " TIPO " )
	Case lBox
		Self:AddMapFields("quantity_cli", "QTD_CLIENTES"	 , .T., .F., { "QTD_CLIENTES"  , 'N', GetFieldLength("F2_CLIENTE"), GetFieldDecimal("F2_CLIENTE") })
		Self:AddMapFields( "quantity_prod", "QTD_PRODUTOS"    , .T., .F., { "QTD_PRODUTOS", 'N', GetFieldLength("D2_COD") , GetFieldDecimal("D2_COD") } )
	Case lTotVal
		Self:AddMapFields( "gross_amount" , "VAL_BRUT"    , .T., .F.,   { "VAL_BRUT", 'N', GetFieldLength("D2_TOTAL") , GetFieldDecimal("D2_TOTAL") } )
		Self:AddMapFields( "liquid_amount" , "VAL_LIQUID"  , .T., .F.,	  { "VAL_LIQUID", 'N', GetFieldLength("D2_TOTAL") , GetFieldDecimal("D2_TOTAL") } )
		Self:AddMapFields( "returned_amount" , "VAL_DEVOL"   , .T., .F.,   { "VAL_DEVOL", 'N', GetFieldLength("D1_TOTAL") , GetFieldDecimal("D1_TOTAL") } )
		If lTotValPeriod
			Self:AddMapFields( "date" , "DATE_EMISSAO"   , .T., .F.,   { "DATE_EMISSAO", 'D', GetFieldLength("D2_EMISSAO") , GetFieldDecimal("D2_EMISSAO") } )
		EndIF
	Case lTopSellers
		Self:AddMapFields("code" 				, "COD" 	, .T., .F.,  { "COD", 'C', GetFieldLength("D2_COD") , GetFieldDecimal("D2_COD") } )
		Self:AddMapFields("description" 		, "DESCRI"  , .T., .F.,  { "DESCRI", 'C', GetFieldLength("B1_DESC") , GetFieldDecimal("B1_DESC") } )
		Self:AddMapFields("quantity" 			, "QTD"   	, .T., .F.,  { "QTD", 'N', GetFieldLength("D2_QUANT") , GetFieldDecimal("D2_QUANT") } )
	Otherwise
		Self:AddMapFields("internalid" 			, "internalid"	, .T., .F., { "internalid" 	, 'C', aInternalId[1] , 0 }, aInternalId[2])
		Self:AddMapFields("orderid"  			, "orderid" 	, .T., .F., { "orderid"		, 'C', aOrderId[1]	  , 0 }, aOrderId[2])
		Self:AddMapFields("status"  			, "status"		, .T., .F., { "status"	 	, 'C', 1 			  , 0 }, "'A'")
		Self:AddMapFields("order"				, "C5_NUM"		, .T., .F., { "C5_NUM"  	, 'C', GetFieldLength("C5_PEDIDO")	, 0 })
		Self:AddMapFields("item"				, "C6_ITEM"		, .T., .F., { "C6_ITEM"  	, 'C', GetFieldLength("C6_ITEM")	, 0 })
		Self:AddMapFields("client"				, "C5_CLIENTE"	, .T., .F., { "C5_CLIENTE"  , 'C', GetFieldLength("C5_CLIENTE")	, 0 })
		Self:AddMapFields("store"				, "C5_LOJACLI"	, .T., .F., { "C5_LOJACLI"	, 'C', GetFieldLength("C5_LOJACLI")	, 0 })
		Self:AddMapFields("name"				, "A1_NOME"		, .T., .F., { "A1_NOME"		, 'C', GetFieldLength("A1_NOME")	, 0 })
		Self:AddMapFields("state"				, "A1_EST"		, .T., .F., { "A1_EST"		, 'C', GetFieldLength("A1_EST")		, 0 })
		Self:AddMapFields("product"				, "C6_PRODUTO"	, .T., .F., { "C6_PRODUTO"	, 'C', GetFieldLength("C6_PRODUTO")	, 0 })
		Self:AddMapFields("productName"			, "B1_DESC"		, .T., .F., { "B1_DESC"		, 'C', GetFieldLength("B1_DESC")	, 0 })
		Self:AddMapFields("quantityReleased"	, "C9_QTDLIB"	, .T., .F., { "C9_QTDLIB" 	, 'N', GetFieldLength("C9_QTDLIB")	, GetFieldDecimal("C9_QTDLIB") })
		Self:AddMapFields("quantitySaleOrder"	, "C6_QTDVEN"	, .T., .F., { "C6_QTDVEN" 	, 'N', GetFieldLength("C6_QTDVEN")	, GetFieldDecimal("C6_QTDVEN") })
		Self:AddMapFields("invoice"				, "C9_NFISCAL"	, .T., .F., { "C9_NFISCAL" 	, 'C', GetFieldLength("C9_NFISCAL")	, 0 })
		Self:AddMapFields("NFSerie"				, "C9_SERIENF"	, .T., .F., { "C9_SERIENF"	, 'C', GetFieldLength("C9_SERIENF")	, 0 })
		Self:AddMapFields("deliveryDate"		, "C6_ENTREG"	, .T., .F., { "C6_ENTREG"  , 'D', GetFieldLength("C6_ENTREG")	, 0 })
		Self:AddMapFields("dtRelease"			, "C9_DATALIB"	, .T., .F., { "C9_DATALIB"  , 'D', GetFieldLength("C9_DATALIB")	, 0 })
		Self:AddMapFields("sequence"			, "C9_SEQUEN"	, .T., .F., { "C9_SEQUEN" 	, 'C', GetFieldLength("C9_SEQUEN")	, 0 })
		Self:AddMapFields("group"				, "C9_GRUPO"	, .T., .F., { "C9_GRUPO"	, 'C', GetFieldLength("C9_GRUPO")	, 0 })
		Self:AddMapFields("prcSale"				, "C6_PRCVEN"	, .T., .F., { "C6_PRCVEN" 	, 'N', GetFieldLength("C6_PRCVEN")	, GetFieldDecimal("C6_PRCVEN") })
		Self:AddMapFields("amount"				, "C6_VALOR"	, .T., .F., { "C6_VALOR" 	, 'N', GetFieldLength("C6_VALOR")	, GetFieldDecimal("C6_VALOR") })
		Self:AddMapFields("agregLiber"			, "C9_AGREG"	, .T., .F., { "C9_AGREG" 	, 'C', GetFieldLength("C9_AGREG")	, 0 })
		Self:AddMapFields("idenPD3"				, "C9_IDENTB6"	, .T., .F., { "C9_IDENTB6" 	, 'C', GetFieldLength("C9_IDENTB6")	, 0 })
		Self:AddMapFields("sale"				, "C9_VENDA"	, .T., .F., { "C9_VENDA" 	, 'C', GetFieldLength("C9_VENDA")	, 0 })
		Self:AddMapFields("stockBlock"			, "C9_BLEST"	, .T., .F., { "C9_BLEST" 	, 'C', GetFieldLength("C9_BLEST")	, 0 })
		Self:AddMapFields("creditBlock"			, "C9_BLCRED"	, .T., .F., { "C9_BLCRED" 	, 'C', GetFieldLength("C9_BLCRED")	, 0 })
		Self:AddMapFields("block"				, "C9_BLOQUEI"	, .T., .F., { "C9_BLOQUEI" 	, 'C', GetFieldLength("C9_BLOQUEI")	, 0 })
		Self:AddMapFields("businessRuleBlock"	, "C6_BLOQUEI"	, .T., .F., { "C6_BLOQUEI" 	, 'C', GetFieldLength("C6_BLOQUEI")	, 0 })
		Self:AddMapFields("batch"				, "C9_LOTECTL"	, .T., .F., { "C9_LOTECTL" 	, 'C', GetFieldLength("C9_LOTECTL")	, 0 })
		Self:AddMapFields("subLote"				, "C9_NUMLOTE"	, .T., .F., { "C9_NUMLOTE" 	, 'C', GetFieldLength("C9_NUMLOTE")	, 0 })
		Self:AddMapFields("numberofSeries"		, "C9_NUMSERI"	, .T., .F., { "C9_NUMSERI" 	, 'C', GetFieldLength("C9_NUMSERI")	, 0 })
		Self:AddMapFields("remitNo"				, "C9_REMITO"	, .T., .F., { "C9_REMITO" 	, 'C', GetFieldLength("C9_REMITO")	, 0 })
		Self:AddMapFields("remitoItem"			, "C9_ITEMREM"	, .T., .F., { "C9_ITEMREM" 	, 'C', GetFieldLength("C9_ITEMREM")	, 0 })
		Self:AddMapFields("dtValidity"			, "C9_DTVALID"	, .T., .F., { "C9_DTVALID" 	, 'D', GetFieldLength("C9_DTVALID")	, 0 })
		Self:AddMapFields("reservationNumber"	, "C9_RESERVA"	, .T., .F., { "C9_RESERVA" 	, 'C', GetFieldLength("C9_RESERVA")	, 0 })
		Self:AddMapFields("reservationQuantity"	, "C9_QTDRESE"	, .T., .F., { "C9_QTDRESE" 	, 'N', GetFieldLength("C9_QTDRESE")	, GetFieldDecimal("C9_QTDRESE") })
		Self:AddMapFields("storage"				, "C9_LOCAL"	, .T., .F., { "C9_LOCAL" 	, 'C', GetFieldLength("C9_LOCAL")	, 0 })
		Self:AddMapFields("wmsLock"				, "C9_BLWMS"	, .T., .F., { "C9_BLWMS" 	, 'C', GetFieldLength("C9_BLWMS")	, 0 })
		Self:AddMapFields("cargoNo"				, "C9_CARGA"	, .T., .F., { "C9_CARGA" 	, 'C', GetFieldLength("C9_CARGA")	, 0 })
		Self:AddMapFields("loadSequence"		, "C9_SEQCAR"	, .T., .F., { "C9_SEQCAR" 	, 'C', GetFieldLength("C9_SEQCAR")	, 0 })
		Self:AddMapFields("seqDelivery"			, "C9_SEQENT"	, .T., .F., { "C9_SEQENT" 	, 'C', GetFieldLength("C9_SEQENT")	, 0 })
		Self:AddMapFields("service"				, "C9_SERVIC"	, .T., .F., { "C9_SERVIC" 	, 'C', GetFieldLength("C9_SERVIC")	, 0 })
		Self:AddMapFields("servStatus"			, "C9_STSERV"	, .T., .F., { "C9_STSERV" 	, 'C', GetFieldLength("C9_STSERV")	, 0 })
		Self:AddMapFields("defaultAddress"		, "C9_ENDPAD"	, .T., .F., { "C9_ENDPAD" 	, 'C', GetFieldLength("C9_ENDPAD")	, 0 })
		Self:AddMapFields("physicalStructure"	, "C9_TPESTR"	, .T., .F., { "C9_TPESTR" 	, 'C', GetFieldLength("C9_TPESTR")	, 0 })
		Self:AddMapFields("cargoMap"			, "C9_TPCARGA"	, .T., .F., { "C9_TPCARGA" 	, 'C', GetFieldLength("C9_TPCARGA")	, 0 })
		Self:AddMapFields("projectCode"			, "C9_PROJPMS"	, .T., .F., { "C9_PROJPMS" 	, 'C', GetFieldLength("C9_PROJPMS")	, 0 })
		Self:AddMapFields("edt"					, "C9_EDTPMS"	, .T., .F., { "C9_EDTPMS" 	, 'C', GetFieldLength("C9_EDTPMS")	, 0 })
		Self:AddMapFields("taskCode"			, "C9_TASKPMS"	, .T., .F., { "C9_TASKPMS" 	, 'C', GetFieldLength("C9_TASKPMS")	, 0 })
		Self:AddMapFields("qtReleased2"			, "C9_QTDLIB2"	, .T., .F., { "C9_QTDLIB2" 	, 'N', GetFieldLength("C9_QTDLIB2")	, GetFieldDecimal("C9_QTDLIB2") })
		Self:AddMapFields("biddingCode"			, "C9_LICITA"	, .T., .F., { "C9_LICITA" 	, 'C', GetFieldLength("C9_LICITA")	, 0 })
		Self:AddMapFields("power"				, "C9_POTENCI"	, .T., .F., { "C9_POTENCI" 	, 'N', GetFieldLength("C9_POTENCI")	, GetFieldDecimal("C9_POTENCI") })
		Self:AddMapFields("dcenvseries"			, "C9_SERIREM"	, .T., .F., { "C9_SERIREM" 	, 'C', GetFieldLength("C9_SERIREM")	, 0 })
		Self:AddMapFields("infBlock"			, "C9_BLINF"	, .T., .F., { "C9_BLINF" 	, 'C', GetFieldLength("C9_BLINF")	, 0 })
		Self:AddMapFields("tmsLotNo"			, "C9_LOTNFC"	, .T., .F., { "C9_LOTNFC" 	, 'C', GetFieldLength("C9_LOTNFC")	, 0 })
		Self:AddMapFields("tmsBlock"			, "C9_BLTMS"	, .T., .F., { "C9_BLTMS" 	, 'C', GetFieldLength("C9_BLTMS")	, 0 })
		Self:AddMapFields("wmsRule"				, "C9_REGWMS"	, .T., .F., { "C9_REGWMS" 	, 'C', GetFieldLength("C9_REGWMS")	, 0 })
		Self:AddMapFields("numSeq"				, "C9_NUMSEQ"	, .T., .F., { "C9_NUMSEQ" 	, 'C', GetFieldLength("C9_NUMSEQ")	, 0 })
		Self:AddMapFields("compFut."			, "C9_NUMCP"	, .T., .F., { "C9_NUMCP" 	, 'C', GetFieldLength("C9_NUMCP")	, 0 })
		Self:AddMapFields("serviceCode"			, "C9_CODISS"	, .T., .F., { "C9_CODISS" 	, 'C', GetFieldLength("C9_CODISS")	, 0 })
		Self:AddMapFields("seqEffort"			, "C9_TRT"		, .T., .F., { "C9_TRT"	 	, 'C', GetFieldLength("C9_TRT"	)	, 0 })
		Self:AddMapFields("operationRet"		, "C9_RETOPER"	, .T., .F., { "C9_RETOPER" 	, 'C', GetFieldLength("C9_RETOPER")	, 0 })
		Self:AddMapFields("seq.ID"				, "C9_IDDCF"	, .T., .F., { "C9_IDDCF" 	, 'C', GetFieldLength("C9_IDDCF")	, 0 })
		Self:AddMapFields("issuedDAV"			, "C9_DAV"		, .T., .F., { "C9_DAV"	 	, 'C', GetFieldLength("C9_DAV"	)	, 0 })
		Self:AddMapFields("orderSep."			, "C9_ORDSEP"	, .T., .F., { "C9_ORDSEP" 	, 'C', GetFieldLength("C9_ORDSEP")	, 0 })
		Self:AddMapFields("optype"				, "C9_TPOP"		, .T., .F., { "C9_TPOP"	 	, 'C', GetFieldLength("C9_TPOP"	)	, 0 })
		Self:AddMapFields("deliverydate"		, "C9_DATENT"	, .T., .F., { "C9_DATENT" 	, 'D', GetFieldLength("C9_DATENT")	, 0 })
		Self:AddMapFields("groupFilter"			, "C9_FILAGRU"	, .T., .F., { "C9_FILAGRU" 	, 'C', GetFieldLength("C9_FILAGRU")	, 0 })
		Self:AddMapFields("soliFluig"			, "C9_SOLFLG"	, .T., .F., { "C9_SOLFLG" 	, 'N', GetFieldLength("C9_SOLFLG")	, GetFieldDecimal("C9_SOLFLG") })
		Self:AddMapFields("dcenvseries"			, "C9_SDOCREM"	, .T., .F., { "C9_SDOCREM" 	, 'C', GetFieldLength("C9_SDOCREM")	, 0 })
		Self:AddMapFields("docSeries."			, "C9_SDOCNF"	, .T., .F., { "C9_SDOCNF" 	, 'C', GetFieldLength("C9_SDOCNF")	, 0 })
		Self:AddMapFields("embRomaneio"			, "C9_ROMEMB"	, .T., .F., { "C9_ROMEMB" 	, 'C', GetFieldLength("C9_ROMEMB")	, 0 })
		Self:AddMapFields("seqSD3"				, "C9_SD3SEQ"	, .T., .F., { "C9_SD3SEQ" 	, 'C', GetFieldLength("C9_SD3SEQ")	, 0 })
		Self:AddMapFields("tktCredit"			, "C9_TICKETC"	, .T., .F., { "C9_TICKETC" 	, 'C', GetFieldLength("C9_TICKETC")	, 0 })
		Self:AddMapFields("type"				, "C5_TIPO"		, .T., .F., { "C5_TIPO" 	, 'C', GetFieldLength("C5_TIPO")	, 0 })
		Self:AddMapFields("vlr.totalSD2"		, "D2_VALBRUT"	, .T., .F., { "D2_VALBRUT" 	, 'N', GetFieldLength("D2_VALBRUT")	, GetFieldDecimal("D2_VALBRUT") })
		Self:AddMapFields("vlr.BrutoSD2"		, "D2_TOTAL"	, .T., .F., { "D2_TOTAL" 	, 'N', GetFieldLength("D2_TOTAL")	, GetFieldDecimal("D2_TOTAL") })
	EndCase

	aSize(aOrderId, 0)
	aSize(aInternalId, 0)
Return Nil

//------------------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:Get
	Obtem uma Lista de Pedidos retornando um JSON respeitando a Quantidade de 
	registro por pagina, especificado no paramentro PageSize e Data de ou Data ate.
	@type		method
	@param		nPage		, Numeric	, Numero da pagina que sera retornada
	@param		nPageSize	, Numeric	, Quantidade de registros por pagina
	@param		aURLFilter	, Array		, Lista de Filtros no padrao do FWAdapterBaseV2
	@param		cFields		, Character	, Lista de campos que devem ser retornados
	@param		cSort		, Character	, Ordernacao do Response
	@param 		dDataDe      , date      , data de
	@param 		dDataAte     , date      , data ate
	@param      lCard        , logical   , Indica se será feito a tratativa para Card
	@param 		lBox         , logical   , indica se será feito a tratativa para box
	@param 		lTotVal      , logical   , indica se será feito a tratativa para valor total
	@param 		lTotValPeriod, logical   , indica se será feito a tratativa para valor total últimos 7 dias
	@param 		lTopSellers  , logical   , indica se deve ser feito a tratativa para os top 5 produtos mais vendidos
	@param      cStatusFilter, character , filtro de status utilizado pelos endpoints /api/pgv/salesorderslist e /api/pgv/salesorderslist/:dDataDe/:dDataAte
	@author		Squad CRM & Faturamento
	@since		17/11/2023
	@version	12.1.2310
/*/
//------------------------------------------------------------------------------
Method get(	nPage         as Numeric , nPageSize   as Numeric , aURLFilter    as Array   , cFields as Character      , cSort as Character, ;
			dDataDe       as Date    , dDataAte    as Date    , lCard         as Logical , lBox    as Logical        , lTotVal as Logical, ;
			lTotValPeriod as Logical , lTopSellers as Logical , cStatusFilter as Character) Class pgvSalesOrdersListProtheusData
	Local aArea			:= GetArea()
	Local cInnerJoin 	:= ::getInnerJoin(lCard) as Character

	::setAddMapFields(lCard, lBox, lTotVal, lTotValPeriod, lTopSellers)
	::setPage( nPage )
	::setPageSize( nPageSize )
	
	If lCard
		::SetQuery( GetQuerySalesCard(cInnerJoin, dDataDe, dDataAte))
	ElseIf lBox
		::SetQuery( GetQuerySalesBox( dDataDe, dDataAte))
	ElseIf lTotVal .OR. lTotValPeriod
		::SetQuery( GetQuerySalesTotVal( lTotValPeriod))
	ElseIf lTopSellers
		::SetQuery( GetQuerySalesTopSellers())
	Else 
		::SetQuery( getQueryTGV("SC5", cInnerJoin) )
	EndIf

	If !Empty( aURLFilter ) .And. Len( aURLFilter ) > 0
		::SetUrlFilter( aURLFilter )
	Endif

	If !Empty( cFields )
		::SetFields( cFields )
	Endif

	If !Empty( cSort )
		::SetOrderQuery( cSort )
	EndIf

	::SetWhere( ::GetSalesFilter( dDataDe, dDataAte, lCard, lBox, lTotVal, lTopSellers, cStatusFilter ) )
	
	If (!lCard .OR. lCard == NIL) .AND. (!lBox .OR. lBox == NIL) .AND. (!lTotVal .OR. lTotVal == NIL) .AND. (!lTotValPeriod .OR. lTotValPeriod == NIL) .AND. (!lTopSellers .OR. lTopSellers == NIL)
		::SetOrder( "C9_FILIAL,C9_PEDIDO,C9_ITEM" )
	ElseIf lTotValPeriod
		::SetOrder( "DATE_EMISSAO" )
	ElseIf lTopSellers
		::SetOrder( "QTD DESC" )
	Else
		::SetOrder( "TIPO" )
	EndIf

	If ::Execute()
		::FillGetResponse()
	EndIf

	RestArea(aArea)
	aSize(aArea, 0)
Return Nil

//-----------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:getInnerJoin
	Realiza um INNER JOIN da SC9 com a SC5
	@author Squad CRM & Faturamento
	@since 17/11/2023
	@version 12.1.2310
	@return cInnerJoin, character, retorna o innerJoin da query
/*/
//-------------------------------------------------------------------
Method getInnerJoin(lCard) as Character Class pgvSalesOrdersListProtheusData
	Local cInnerJoin := ""
	Default lCard    := .F. 

	cInnerJoin+=" INNER JOIN " + RetSQLName('SC6') + " SC6 "
	cInnerJoin+=" ON "
	cInnerJoin+=" SC5.C5_FILIAL = SC6.C6_FILIAL "
	cInnerJoin+=" AND SC5.C5_NUM = SC6.C6_NUM "
	cInnerJoin+=" AND SC5.D_E_L_E_T_ = SC6.D_E_L_E_T_ "
	
	cInnerJoin+=" LEFT JOIN "+RetSqlName('SC9')+" SC9 "
	cInnerJoin+=" ON "
	cInnerJoin+=" SC9.C9_PEDIDO = SC5.C5_NUM "
	cInnerJoin+=" AND SC9.C9_FILIAL = SC5.C5_FILIAL "
	cInnerJoin+=" AND SC6.C6_ITEM = SC9.C9_ITEM "
	cInnerJoin+=" AND SC6.C6_PRODUTO = SC9.C9_PRODUTO "
	cInnerJoin+=" AND SC6.D_E_L_E_T_ = SC9.D_E_L_E_T_ "

	cInnerJoin+=" LEFT JOIN "+RetSqlName('SD2')+" SD2 "
	cInnerJoin+=" ON "
	cInnerJoin+=" SC5.C5_NUM = SD2.D2_PEDIDO "
	cInnerJoin+=" AND SC9.C9_NFISCAL = SD2.D2_DOC "
	cInnerJoin+=" AND SC9.C9_SERIENF = SD2.D2_SERIE "
	cInnerJoin+=" AND SC9.C9_FILIAL = SD2.D2_FILIAL "
    cInnerJoin+=" AND SC9.C9_PRODUTO = SD2.D2_COD "
	cInnerJoin+=" AND SC6.C6_ITEM = SD2.D2_ITEMPV "
	cInnerJoin+=" AND SC6.D_E_L_E_T_ = SD2.D_E_L_E_T_ "
	
	If !lCard
		cInnerJoin+=" LEFT JOIN "+RetSqlName('SB1')+" SB1 "
		cInnerJoin+=" ON "
		cInnerJoin+=" SB1.B1_FILIAL = '"+ FwXFilial("SB1") +"' AND "
		cInnerJoin+=" SB1.B1_COD = SC6.C6_PRODUTO "
		cInnerJoin+=" AND SB1.D_E_L_E_T_ = ' ' "

		cInnerJoin+=" LEFT JOIN "+RetSqlName('SA1')+" SA1 "
		cInnerJoin+=" ON "
		cInnerJoin+=" SA1.A1_FILIAL = '"+ FwXFilial("SA1") +"' AND " 
		cInnerJoin+=" SA1.A1_COD = SC6.C6_CLI "
		cInnerJoin+=" AND SA1.A1_LOJA = SC6.C6_LOJA "
		cInnerJoin+=" AND SA1.D_E_L_E_T_ = ' ' "
	EndIf
Return cInnerJoin

//-----------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:getSalesFilter
	Obtem os filtros referente ao vendedor
	@type method
	@author Squad CRM & Faturamento
	@since 17/11/2023
	@version 12.1.2310
	@param dDataDe      , date      , data de
	@param lCard        , logical   , Indica se será feito a tratativa para Card
	@param lBox         , logical   , indica se será feito a tratativa para box
	@param lTotVal      , logical   , indica se será feito a tratativa para valores totais
	@param lTopSellers  , logical   , indica se deve ser feito a tratativa para os top 5 produtos mais vendidos
	@param cStatusFilter, character , filtro de status utilizado pelos endpoints /api/pgv/salesorderslist e /api/pgv/salesorderslist/:dDataDe/:dDataAte
	@return cWhere, character, retorna o Where da query
	/*/
//-------------------------------------------------------------------
Method getSalesFilter(	dDataDe as date    , dDataAte    as date   , lCard         as logical  , lBox    as logical, ;
						lTotVal as logical , lTopSellers as logical, cStatusFilter as Character) as Character Class pgvSalesOrdersListProtheusData
	Local cWhere 	:= "" as Character
	DEFAULT lCard := .F.
	DEFAULT lBox := .F.
	DEFAULT lTotVal := .F.
	DEFAULT lTopSellers := .F.

	cWhere := " (SC9.C9_FILIAL = '" +FwXFilial("SC9")+ "' OR SC9.C9_FILIAL IS NULL) "

	cWhere +=  getSellerFilter() 

	cWhere += " AND (SC9.D_E_L_E_T_ = ' ' OR SC9.D_E_L_E_T_  IS NULL) "

	cWhere += " AND ( SD2.D2_EMISSAO BETWEEN "
	cWhere += getBetweenDates(dDataDe, dDataAte)
	cWhere += " OR SC5.C5_EMISSAO BETWEEN "

	cWhere += getBetweenDates(dDataDe, dDataAte)
	cWhere += ") "

	If !Empty(cStatusFilter)
		cWhere += getStatusFilter(cStatusFilter)
	EndIf
	
	cWhere += " AND SC5.C5_TIPO IN ('N','C') "
	cWhere += " AND SC5.D_E_L_E_T_ = ' ' "

	If lCard .Or. lBox .Or. lTotVal .Or. lTopSellers
		cWhere := ' 1 = 1 '
	EndIf 
	
	If lTopSellers
		cWhere += IIF(AllTrim(Upper(TcGetDb())) == "ORACLE","AND ROWNUM <= 5"," ")
	EndIf

Return cWhere

//-----------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:getBetweenDates
	Obtem o range de Datas (De - Até)
	@type method
	@author Squad CRM & Faturamento
	@since 17/11/2023
	@version 12.1.2310
	@param dDataDe, date, data de
	@param dDataAte, date, data até
	@param lTotValPeriod, logical, indica se será feito a tratativa para valor total últimos 7 dias
	@return character, cBetween, retorna o range de datas
	/*/
//-------------------------------------------------------------------

Static Function getBetweenDates( dDataDe as date, dDataAte as date, lTotValPeriod as Logical) as character
	Local cBetween := "" as character

	If !Empty( dDataDe ) .And. !Empty( dDataAte )
		cBetween += "'" + DTOS(dDataDe)+ "' AND '" +DTOS(dDataAte)+ "'"
	ElseIf lTotValPeriod
		cBetween += "'" + DTOS((DATE())-7) + "' AND '" + DTOS((DATE())) + "'"
	Else
		cBetween += "'" + AnoMes(DATE())+ "01' AND '" +DTOS(LastDate(DATE()))+ "'"
	EndIf
Return cBetween

//-----------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:getStatusFilter
	Obtem o filtro SQL para o Status informado
	@type method
	@author Squad CRM & Faturamento
	@since 24/01/2024
	@version 12.1.2310
	@param cStatusFilter, character , filtro de status utilizado pelos endpoints /api/pgv/salesorderslist e /api/pgv/salesorderslist/:dDataDe/:dDataAte
	@return cFilter, character , retorna o filtro em SQL para trazer os itens dos pedidos no status informado
	/*/
//-------------------------------------------------------------------

Static Function getStatusFilter(cStatusFilter as Character) as character
	Local cFilter    := "" as Character
	Local aStatus    := {} as Array
	Local nPosStatus := 0  as Numeric

	aStatus :=	{ ;
					{"BLQ", " AND ( (C9_QTDLIB > 0 AND ((C9_BLEST <> '  ' AND C9_BLEST <> '10') OR (C9_BLCRED <> '  ' AND C9_BLCRED <> '10'))) OR C6_BLOQUEI <> '  ') "}, ;
					{"OPN", " AND (C9_QTDLIB IS NULL AND C6_BLOQUEI = '  ') "}, ;
					{"RLS", " AND (C9_QTDLIB > 0 AND C9_BLEST = '  ' AND C9_BLCRED = '  ' AND C6_BLOQUEI = '  ') "}, ;
					{"BIL", " AND ( C9_BLEST = '10' AND C9_BLCRED = '10' ) "}, ;
				}

	nPosStatus := aScan(aStatus, {|status| status[STATUS] == cStatusFilter})
	If nPosStatus > 0
		cFilter := aStatus[nPosStatus][STATUSSQLFILTER]
	EndIf
Return cFilter

//-----------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersListProtheusData:getSellerFilter
	Obtem o filtro de vendedores
	@type method
	@author Squad CRM & Faturamento
	@since 17/11/2023
	@version 12.1.2310
	@param lBox, logical, indica se será feito a tratativa para box
	@return character, cWhere, retorna o Where da query
	/*/
//-------------------------------------------------------------------

Static Function getSellerFilter( lBox as Logical, lCard as Logical) as character
	Local cWhere := "" as character
	Local isAdmin := FWIsAdmin() 						as Logical
	Local cSeller := getSellerFromFilter(isAdmin, .F.)  as Character

	If !EMPTY(cSeller) .AND. !isAdmin
		If lBox
			cWhere += "	( SF2.F2_VEND1 = '" + cSeller + "'	OR	"
			cWhere += "	SF2.F2_VEND2 = '" + cSeller + "'	OR	"
			cWhere += "	SF2.F2_VEND3 = '" + cSeller + "'	OR	"
			cWhere += "	SF2.F2_VEND4 = '" + cSeller + "'	OR	"
			cWhere += "	SF2.F2_VEND5 = '" + cSeller + "' )	AND	"
		Elseif lCard
			cWhere += " AND (SC5.C5_VEND1 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND2 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND3 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND4 = '" 	+cSeller+ "') "
			cWhere += " AND SC5.C5_TIPO IN ('N','C') "
		Else 
			cWhere += " AND (SC5.C5_VEND1 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND2 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND3 = '" 	+cSeller+ "' "
			cWhere += " OR SC5.C5_VEND4 = '" 	+cSeller+ "') "
		EndIf 

	EndIf 

Return cWhere

//------------------------------------------------------------------------------
/*/{Protheus.doc} GetQuerySalesCard
	@type		function
	@version	12.2310
	@author		Gabriel Santos / Squad CRM & Faturamento
	@since		14/12/2023
	@return		character, Expressao SQL para consulta
/*/
//------------------------------------------------------------------------------
Function GetQuerySalesCard(cInnerJoin as character, dDataDe as date, dDataAte as date) as Character
	Local cQuery  := ""    as Character
	Default cInnerJoin := ""
	Default lCard      := .F.

	cQuery += " SELECT #QueryFields# "
	cQuery += " FROM ( "
	//Total Bloqueados
	cQuery += "			SELECT "
	cQuery += "				COUNT(C9_PEDIDO) QTD_TOTAL, "
	cQuery += "				SUM(C9_PRCVEN) VLR_TOTAL, "
	cQuery += "				C9_FILIAL, "
	cQuery += "				TIPO "
	cQuery += "			FROM "
	cQuery += "				(  	"
	// Bloqueio de Crédito e/ou Estoque
	cQuery += "			SELECT C9_PEDIDO         C9_PEDIDO, "
	cQuery += "				   Sum(C9_PRCVEN*C9_QTDLIB)           C9_PRCVEN, "
	cQuery += "				   C9_FILIAL, "
	cQuery += "				   'TOTAL_BLOQUEADOS'        TIPO "
	cQuery += "			FROM   " + RetSqlName("SC9") + " SC9 "
	cQuery += "				   INNER JOIN " + RetSqlName("SC6") + " SC6 "
	cQuery += "						   ON SC9.C9_PEDIDO = SC6.C6_NUM "
	cQuery += "							  AND SC9.C9_FILIAL = SC6.C6_FILIAL "
	cQuery += "							  AND SC9.C9_PRODUTO = SC6.C6_PRODUTO "
	cQuery += "							  AND SC9.C9_ITEM = SC6.C6_ITEM "
	cQuery += "							  AND SC6.D_E_L_E_T_ = SC9.D_E_L_E_T_ "
	cQuery += "				   INNER JOIN " + RetSqlName("SC5") + " SC5 "
	cQuery += "						   ON SC9.C9_PEDIDO = SC5.C5_NUM "
	cQuery += "							  AND SC9.C9_FILIAL = SC5.C5_FILIAL "
	cQuery += "							  AND SC5.D_E_L_E_T_ = SC9.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"' "
	cQuery += "                                           AND SF4.F4_CODIGO = SC6.C6_TES "
	cQuery += "			WHERE  SC9.C9_FILIAL = '" + FwXFilial("SC9") + "' "
	cQuery += "				   AND SC9.D_E_L_E_T_ = ' ' "
	cQuery += " AND SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SC5.C5_TIPO IN ('N','C')  "
	cQuery += "				   AND SC5.C5_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += getSellerFilter(.F.,.T.)
	cQuery += "				   AND ( SC9.C9_BLEST NOT IN ( '  ', '10' ) "
	cQuery += "				   OR SC9.C9_BLCRED NOT IN ( '  ', '10' ) )"
	cQuery += "			 GROUP BY C9_FILIAL, C9_PEDIDO "
	cQuery += "				UNION "
	// Bloqueio de Regra e/ou Verba
	cQuery += "				  SELECT SC5.C5_NUM C9_PEDIDO, "
	cQuery += "                       Sum(SC6.C6_PRCVEN * SC6.C6_QTDVEN) C9_PRCVEN, "
	cQuery += "                       C5_FILIAL, "
	cQuery += "                       'TOTAL_BLOQUEADOS'         TIPO "
	cQuery += "                FROM   " + RetSQLName("SC6") + " SC6 "
	cQuery += "                       INNER JOIN " + RetSQLName("SC5") + " SC5 "
	cQuery += "                               ON SC6.C6_NUM = SC5.C5_NUM "
	cQuery += "                                  AND SC6.C6_FILIAL = SC5.C5_FILIAL "
	cQuery += "                                  AND SC5.D_E_L_E_T_ = SC6.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SC6.C6_TES "
	cQuery += "                WHERE  SC6.C6_FILIAL = '" + FwXFilial("SC6") + "' "
	cQuery += " AND SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SC5.C5_TIPO IN ('N','C')  "
	cQuery += "                       AND SC6.D_E_L_E_T_ = ' ' "
	cQuery += "                       AND SC5.C5_EMISSAO BETWEEN "  + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += getSellerFilter(.F.,.T.)
	cQuery += "                       AND SC6.C6_BLOQUEI <> ' ' "
	cQuery += "                GROUP  BY C5_FILIAL, "
	cQuery += "                          C5_NUM "
	cQuery += "				) TRB_TOT_BY_BLQ_ORD "
	cQuery += "				GROUP BY C9_FILIAL, TIPO "
	//Total Faturados
	cQuery += "			UNION "
	cQuery += "			SELECT "
	cQuery += "				COUNT(C9_PEDIDO) QTD_TOTAL, "
	cQuery += "				SUM(D2_TOTAL) VLR_TOTAL, "
	cQuery += "				C9_FILIAL, "
	cQuery += "				TIPO "
	cQuery += "			FROM "
	cQuery += "				(    
	cQuery += "					SELECT C9_PEDIDO, "
	cQuery += "						   C9_FILIAL, "
	cQuery += "						   Sum(D2_TOTAL)            D2_TOTAL, "
	cQuery += "						   'TOTAL_FATURADOS'        TIPO "
	cQuery += "					FROM   " + RetSqlName("SC5") + " SC5 "
	If !Empty(cInnerJoin)
		cQuery += cInnerJoin
	EndIf 
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SC6.C6_TES "
	cQuery += "					WHERE  SC9.C9_FILIAL = '" + FwXFilial("SC9") + "' "
	cQuery += " AND SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SC5.C5_TIPO IN ('N','C')  "
	cQuery += "						   AND SC5.D_E_L_E_T_ = ' ' "
	cQuery += "						   AND SD2.D2_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += getSellerFilter(.F.,.T.)
	cQuery += "						   AND SC9.C9_BLEST  = '10' "
	cQuery += "						   AND SC9.C9_BLCRED ='10' "
	cQuery += "					GROUP BY C9_FILIAL, C9_PEDIDO "
	cQuery += "				) TRB_TOT_BY_BIL_ORD "
	cQuery += "				GROUP BY C9_FILIAL, TIPO "
	//Total em Aberto
	cQuery += "			UNION "
	cQuery += " "
	cQuery += "			SELECT "
	cQuery += "				COUNT(C5_PEDIDO) QTD_TOTAL, "
	cQuery += "				SUM(C6_PRCVEN) VLR_TOTAL, "
	cQuery += "				C5_FILIAL C9_FILIAL, "
	cQuery += "				TIPO "
	cQuery += "			FROM "
	cQuery += "				( "
	cQuery += "				SELECT
	cQuery += "					C5_FILIAL,
	cQuery += "					C5_PEDIDO,
	cQuery += "					TIPO,
	cQuery += "					SUM(C6_PRCVEN) C6_PRCVEN
	cQuery += "				FROM
	cQuery += "					(
	// QUANDO NÃO HÁ REGISTROS NA SC9
	cQuery += "						SELECT C5_NUM                C5_PEDIDO, "
	cQuery += "							   C5_FILIAL, "
	cQuery += "							   Sum(C6_VALOR)        C6_PRCVEN, "
	cQuery += "							   'TOTAL_ABERTO'        TIPO, "
	cQuery += "           				   C6_BLOQUEI "
	cQuery += "						FROM   " + RetSqlName("SC5") + " SC5 "
	cQuery += "							   INNER JOIN " + RetSqlName("SC6") + " SC6 "
	cQuery += "									ON SC6.C6_NUM = SC5.C5_NUM "
	cQuery += "										  AND SC6.C6_FILIAL = SC5.C5_FILIAL "
	cQuery += "										  AND SC5.D_E_L_E_T_ = SC6.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SC6.C6_TES "
	cQuery += "								LEFT JOIN " + RetSqlName("SC9") + " SC9 "
	cQuery += "									ON SC6.C6_NUM = SC9.C9_PEDIDO "
	cQuery += "										AND SC6.C6_FILIAL = SC9.C9_FILIAL "
	cQuery += "										AND SC6.C6_ITEM = SC9.C9_ITEM "
	cQuery += "										AND SC6.C6_PRODUTO = SC9.C9_PRODUTO "
	cQuery += "						WHERE  SC5.C5_FILIAL = '" + FwXFilial("SC5") + "' "
	cQuery += " AND SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SC5.C5_TIPO IN ('N','C')  "
	cQuery += "							   AND SC5.D_E_L_E_T_ = ' ' "
	cQuery += "							   AND SC5.C5_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += "							   AND C9_FILIAL IS NULL  "
	cQuery += getSellerFilter(.F.,.T.)
	cQuery += "							   AND  SC6.C6_BLOQUEI = ' ' "
	cQuery += "						GROUP BY C5_FILIAL, C5_NUM, C6_BLOQUEI"
	cQuery += "						UNION
	// QUANDO HÁ REGISTROS NA SC9 PARA O PEDIDO, MAS ELES ESTÃO TODOS DELETADOS
	cQuery += "						SELECT C5_NUM C5_PEDIDO, "
    cQuery += "						       C5_FILIAL, "
    cQuery += "						       Sum(C6_VALOR) C6_PRCVEN, "
    cQuery += "						       'TOTAL_ABERTO' TIPO, "
	cQuery += "						       SC6.C6_BLOQUEI "
    cQuery += "						FROM   " + RetSQLName("SC5") + " SC5 "
    cQuery += "						       INNER JOIN " + RetSQLName("SC6") + " SC6 "
    cQuery += "						               ON SC6.C6_NUM = SC5.C5_NUM "
    cQuery += "						                  AND SC6.C6_FILIAL = SC5.C5_FILIAL "
    cQuery += "						                  AND SC5.D_E_L_E_T_ = SC6.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SC6.C6_TES "
    cQuery += "						       INNER JOIN	(										 "
	cQuery += "												SELECT "
	cQuery += "													REG_DEL.C9_FILIAL, "
	cQuery += "													REG_DEL.C9_PEDIDO, "
	cQuery += "													REG_DEL.C9_ITEM, "
	cQuery += "													REG_DEL.C9_PRODUTO "
	cQuery += "												FROM "
	cQuery += "													( "
	cQuery += "														SELECT "
	cQuery += "															SC9.C9_FILIAL, "
	cQuery += "															SC9.C9_PEDIDO, "
	cQuery += "															SC9.C9_ITEM, "
	cQuery += "															SC9.C9_PRODUTO "
	cQuery += "														FROM "
	cQuery += "															" + RetSQLName("SC9") + " SC9 "
	cQuery += "														WHERE "
	cQuery += "															SC9.D_E_L_E_T_ = '*' "
	cQuery += "														GROUP BY "
	cQuery += "															SC9.C9_FILIAL, "
	cQuery += "															SC9.C9_PEDIDO, "
	cQuery += "															SC9.C9_ITEM, "
	cQuery += "															SC9.C9_PRODUTO "
	cQuery += "													) REG_DEL "
	cQuery += "														LEFT JOIN "
	cQuery += "													( "
	cQuery += "														SELECT "
	cQuery += "															SC9.C9_FILIAL, "
	cQuery += "															SC9.C9_PEDIDO, "
	cQuery += "															SC9.C9_ITEM, "
	cQuery += "															SC9.C9_PRODUTO "
	cQuery += "														FROM "
	cQuery += "															" + RetSQLName("SC9") + " SC9 "
	cQuery += "														WHERE "
	cQuery += "															SC9.D_E_L_E_T_ = ' ' "
	cQuery += "														GROUP BY "
	cQuery += "															SC9.C9_FILIAL, "
	cQuery += "															SC9.C9_PEDIDO, "
	cQuery += "															SC9.C9_ITEM, "
	cQuery += "															SC9.C9_PRODUTO "
	cQuery += "													) REG_NOT_DEL "
	cQuery += "														ON "
	cQuery += "															REG_DEL.C9_FILIAL = REG_NOT_DEL.C9_FILIAL "
	cQuery += "																AND "
	cQuery += "															REG_DEL.C9_PEDIDO = REG_NOT_DEL.C9_PEDIDO "
	cQuery += "																AND "
	cQuery += "															REG_DEL.C9_ITEM = REG_NOT_DEL.C9_ITEM "
	cQuery += "																AND "
	cQuery += "															REG_DEL.C9_PRODUTO = REG_NOT_DEL.C9_PRODUTO "
	cQuery += "												WHERE "
	cQuery += "													REG_NOT_DEL.C9_FILIAL IS NULL "
	cQuery += "											) SC9_DEL "
    cQuery += "						              ON SC6.C6_NUM = SC9_DEL.C9_PEDIDO "
    cQuery += "						                 AND SC6.C6_FILIAL = SC9_DEL.C9_FILIAL "
	cQuery += "						                 AND SC6.C6_ITEM = SC9_DEL.C9_ITEM "
	cQuery += "						                 AND SC6.C6_PRODUTO = SC9_DEL.C9_PRODUTO "
    cQuery += "						WHERE  SC5.C5_FILIAL = '" + FwXFilial("SC5") + "' "
    cQuery += "						       AND SC5.D_E_L_E_T_ = ' ' "
	cQuery += " AND SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SC5.C5_TIPO IN ('N','C')  "
    cQuery += "						       AND SC5.C5_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + "  "
	cQuery += getSellerFilter(.F.,.T.)
	cQuery += "							   AND SC6.C6_BLOQUEI = ' ' "
    cQuery += "						GROUP  BY C5_FILIAL, "
    cQuery += "						          C5_NUM, "
	cQuery += "						          SC6.C6_BLOQUEI "
	cQuery += "					) GROUP_TOT_BY_OPN_ORD "
	cQuery += "				GROUP BY "
	cQuery += "					C5_FILIAL, "
	cQuery += "					C5_PEDIDO, "
	cQuery += "					TIPO "
	cQuery += "				) TRB_TOT_BY_OPN_ORD "
	cQuery += "			GROUP BY "
	cQuery += "				C5_FILIAL, "
	cQuery += "				TIPO "
	cQuery += "		) TRB_TOT_BY_STATUS "
	cQuery += " WHERE #QueryWhere#"

Return cQuery
//------------------------------------------------------------------------------
/*/{Protheus.doc} GetQuerySalesBox
	@type		function
	@version	12.2310
	@author		Gabriel Santos / Squad CRM & Faturamento
	@since		10/01/2024
	@param datade, date, indica a data de
	@param dataate, date, indica a data até
	@return		character, Expressao SQL para consulta
/*/
//------------------------------------------------------------------------------
Function GetQuerySalesBox(dDataDe as date, dDataAte as date) as Character
	Local cQuery  := ""    as Character

	cQuery := " SELECT #QueryFields# "
	cQuery += " FROM ( "
	cQuery += " SELECT	"
	cQuery += " 	SUM(QTD_CLIENTES) QTD_CLIENTES,  "
	cQuery += " 	SUM(QTD_PRODUTOS) QTD_PRODUTOS, "
	cQuery += "		TIPO "
	cQuery += " FROM ( "
	cQuery += " 	SELECT  "
	cQuery += " 		COUNT(ITEM) AS QTD_CLIENTES, "
	cQuery += " 		0 QTD_PRODUTOS, "
	cQuery += "				   'TIPO_ORDEM'        TIPO "
	cQuery += " 	FROM ( "
	cQuery += " 			SELECT  "
	cQuery += " 				SF2.F2_CLIENTE ITEM   "
	cQuery += " 			FROM  "
	cQuery += "				   " + RetSqlName("SF2") + " SF2 "
	cQuery += " INNER JOIN  "+ RetSqlName("SD2") + " SD2 "
	cQuery += "                                        ON SD2.D2_FILIAL = SF2.F2_FILIAL "
	cQuery += "                                           AND SD2.D2_DOC = SF2.F2_DOC AND SD2.D2_ITEM = '01' "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SD2.D2_TES "
	cQuery += " 			WHERE  "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SF2.F2_TIPO IN ('N','C') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "	 SF2.F2_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += " 		AND SF2.D_E_L_E_T_ = ' ' "
	cQuery += " 			GROUP BY F2_CLIENTE "
	cQuery += " 		) TOT_CLI_BY_DATE "
	cQuery += "  "
	cQuery += " 	UNION "
	cQuery += "  "
	cQuery += " 	SELECT  "
	cQuery += " 		0 QTD_CLIENTES, "
	cQuery += " 		COUNT(ITEM) AS QTD_PRODUTOS, "
	cQuery += "				   'TIPO_ORDEM'        TIPO "
	cQuery += " 	FROM ( "
	cQuery += " 			SELECT  "
	cQuery += " 				SD2.D2_COD ITEM "
	cQuery += "					FROM   " + RetSqlName("SD2") + " SD2 "
	cQuery += "		INNER JOIN " + RetSqlName("SF2") + " SF2  ON SF2.F2_FILIAL = SD2.D2_FILIAL AND SF2.F2_DOC = SD2.D2_DOC AND SF2.F2_SERIE = SD2.D2_SERIE AND SD2.D_E_L_E_T_ = SF2.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SD2.D2_TES "
	cQuery += " 			WHERE  "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SF2.F2_TIPO IN ('N','C') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "  SD2.D2_EMISSAO BETWEEN " + getBetweenDates(dDataDe, dDataAte) + " "
	cQuery += " 		AND SF2.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' '	"
	cQuery += " 			GROUP BY D2_COD "
	cQuery += " 		) TOT_PROD_BY_DATE "
	cQuery += " ) TBL_X  GROUP BY TIPO) TRB_TOT "
	cQuery += " WHERE #QueryWhere#  "

Return cQuery

//------------------------------------------------------------------------------
/*/{Protheus.doc} GetQuerySalesTotVal
	@type		function
	@version	12.2310
	@author		Gabriel Santos / Squad CRM & Faturamento
	@since		16/01/2024
	@param      lTotValPeriod, logical, indica se será feito a tratativa para valor total últimos 7 dias
	@return		character, Expressao SQL para consulta
/*/
//------------------------------------------------------------------------------
Function GetQuerySalesTotVal( lTotValPeriod as Logical) as Character
	Local cQuery  := ""    								as Character

	cQuery := " SELECT #QueryFields# "
	cQuery += " FROM   (SELECT SUM(VAL_BRUT) VAL_BRUT, "
	cQuery += "                SUM(VAL_LIQUID) VAL_LIQUID, "
	cQuery += " 			   SUM(VAL_DEVOL) VAL_DEVOL, "
	If lTotValPeriod
		cQuery += " DATE_EMISSAO  DATE_EMISSAO "
	Else 
		cQuery += "                TIPO "
	EndIf 
	cQuery += "         FROM   (SELECT SUM(VAL_BRUT)  AS VAL_BRUT, "
	cQuery += "                        0            VAL_LIQUID, "
	cQuery += " 					   0            VAL_DEVOL, "
	If lTotValPeriod
		cQuery += " DATE_EMISSAO  DATE_EMISSAO "
	Else 
		cQuery += "                        'TIPO_ORDEM' TIPO "
	EndIf 
	cQuery += "                 FROM   (SELECT SD2.D2_VALBRUT VAL_BRUT "
	If lTotValPeriod
		cQuery += " , SD2.D2_EMISSAO DATE_EMISSAO "
	EndIf 
	cQuery += "					FROM   " + RetSqlName("SD2") + " SD2 "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF2") + " SF2 "
	cQuery += "                                        ON SF2.F2_FILIAL = SD2.D2_FILIAL "
	cQuery += "                                           AND SF2.F2_DOC = SD2.D2_DOC "
	cQuery += "                                           AND SF2.F2_SERIE = SD2.D2_SERIE "
	cQuery += " 										  AND SF2.D_E_L_E_T_ = SD2.D_E_L_E_T_ "
	cQuery += " 										  AND SF2.F2_TIPO  = SD2.D2_TIPO "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SD2.D2_TES "
	cQuery += "                         WHERE            "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SF2.F2_TIPO IN ('N','C') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "  SD2.D2_EMISSAO BETWEEN " + getBetweenDates(NIL, NIL, lTotValPeriod) + " "
	cQuery += " 								AND SF2.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' ' "
	cQuery += "                         ) TOT_BRU_BY_DATE "
	If lTotValPeriod
		cQuery += " GROUP BY DATE_EMISSAO "
	EndIf 
	cQuery += "                 UNION "
	cQuery += "                 SELECT 0            VAL_BRUT, "
	cQuery += "                        SUM(VAL_LIQUID)  AS VAL_LIQUID, "
	cQuery += "                        0            VAL_DEVOL, "
	If lTotValPeriod
		cQuery += " DATE_EMISSAO  DATE_EMISSAO "
	Else 
	cQuery += " 					   'TIPO_ORDEM' TIPO "
	EndIf 
	cQuery += "                 FROM   (SELECT SD2.D2_TOTAL VAL_LIQUID "
	If lTotValPeriod
		cQuery += " , SD2.D2_EMISSAO DATE_EMISSAO "
	EndIf 
	cQuery += "					FROM   " + RetSqlName("SD2") + " SD2 "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF2") + " SF2 "
	cQuery += "                                        ON SF2.F2_FILIAL = SD2.D2_FILIAL "
	cQuery += "                                           AND SF2.F2_DOC = SD2.D2_DOC "
	cQuery += "                                           AND SF2.F2_SERIE = SD2.D2_SERIE "
	cQuery += " 										  AND SF2.F2_TIPO  = SD2.D2_TIPO "
	cQuery += " 										  AND SF2.D_E_L_E_T_ = SD2.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SD2.D2_TES "
	cQuery += "                         WHERE            "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SF2.F2_TIPO IN ('N','C') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "  SD2.D2_EMISSAO BETWEEN " + getBetweenDates(NIL, NIL, lTotValPeriod) + " "
	cQuery += " 						AND SF2.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' ' "
	cQuery += "                         ) TOT_LIQ_BY_DATE "
	If lTotValPeriod
		cQuery += " GROUP BY DATE_EMISSAO "
	EndIf
	cQuery += " 				UNION "
	cQuery += "                 SELECT 0            VAL_BRUT, "
	cQuery += "                        0            VAL_LIQUID, "
	cQuery += "                        SUM(VAL_DEVOL)  AS VAL_DEVOL, "
	If lTotValPeriod
		cQuery += " DATE_EMISSAO DATE_EMISSAO "
	Else 
	cQuery += " 					   'TIPO_ORDEM' TIPO "
	EndIf 
	cQuery += "                 FROM   (SELECT SD1.D1_TOTAL VAL_DEVOL "
	If lTotValPeriod
		cQuery += " , SD1.D1_EMISSAO DATE_EMISSAO "
	EndIf 
	cQuery += "					FROM   " + RetSqlName("SD1") + " SD1 "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF1") + " SF1 "
	cQuery += "                                        ON SF1.F1_FILIAL = SD1.D1_FILIAL "
	cQuery += "                                           AND SF1.F1_DOC = SD1.D1_DOC "
	cQuery += "                                           AND SF1.F1_SERIE = SD1.D1_SERIE "
	cQuery += " 										  AND SF1.F1_TIPO  = SD1.D1_TIPO "
	cQuery += " 										  AND SF1.D_E_L_E_T_ = SD1.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SD2") + " SD2 "
	cQuery += "                                        ON SD1.D1_FILIAL 	 = SD2.D2_FILIAL "
	cQuery += "                                           AND SD1.D1_NFORI 	 = SD2.D2_DOC "
	cQuery += "                                           AND SD1.D1_SERIORI = SD2.D2_SERIE "
	cQuery += " 										  AND SD1.D1_COD 	 = SD2.D2_COD "
	cQuery += " 										  AND SD1.D_E_L_E_T_ = SD2.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF2") + " SF2 "
	cQuery += "                                        ON SF2.F2_FILIAL = SD2.D2_FILIAL "
	cQuery += "                                           AND SF2.F2_DOC = SD2.D2_DOC "
	cQuery += "                                           AND SF2.F2_SERIE = SD2.D2_SERIE "
	cQuery += " 										  AND SF2.F2_TIPO  = SD2.D2_TIPO "
	cQuery += " 										  AND SF2.D_E_L_E_T_ = SD2.D_E_L_E_T_ "
	cQuery += "                                INNER JOIN  "+ RetSqlName("SF4") + " SF4 "
	cQuery += "                                        ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"'  "
	cQuery += "                                           AND SF4.F4_CODIGO = SD2.D2_TES "
	cQuery += "                         WHERE            "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND "
	cQuery += " SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += " SF2.F2_TIPO IN ('N','C') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "  SD1.D1_EMISSAO BETWEEN " + getBetweenDates(NIL , NIL, lTotValPeriod) + " "
	cQuery += " 						AND SF1.D_E_L_E_T_ = ' ' AND SD1.D_E_L_E_T_ = ' ' "
	cQuery += " 						AND SF1.F1_TIPO = 'D' "
	cQuery += "                         ) TOT_DEV_BY_DATE 
	If lTotValPeriod
		cQuery += " GROUP BY DATE_EMISSAO "
	EndIf
	cQuery += " ) TBL_X "
	If lTotValPeriod
		cQuery += "         GROUP  BY DATE_EMISSAO "
	Else
		cQuery += "  GROUP  BY TIPO "
	EndIf 
	cQuery += " ) TRB_TOT "
	cQuery += " WHERE #QueryWhere#  "

Return cQuery

//------------------------------------------------------------------------------
/*/{Protheus.doc} GetQuerySalesTopSellers - Produtos Mais Vendidos Mensalmente
	@type		function
	@version	12.2310
	@author		Gabriel Santos / Squad CRM & Faturamento
	@since		23/01/2024
	@return		character, Expressao SQL para consulta
/*/
//------------------------------------------------------------------------------
Function GetQuerySalesTopSellers() 						as Character
	Local cQuery  := ""    								as Character

	cQuery := " SELECT #QueryFields# "
	cQuery += IIF(AllTrim(Upper(TcGetDb())) == "MSSQL"," FROM (SELECT TOP 5 D2_COD COD, B1_DESC DESCRI, SUM(D2_QUANT) QTD FROM " + RetSqlName("SF2") + " SF2 "," FROM (SELECT D2_COD COD, B1_DESC DESCRI, SUM(D2_QUANT) QTD FROM " + RetSqlName("SF2") + " SF2 ")
	cQuery += "	INNER JOIN  " + RetSqlName("SD2") + " SD2 ON SD2.D2_FILIAL = SF2.F2_FILIAL AND SF2.F2_DOC = SD2.D2_DOC AND SF2.F2_SERIE = SD2.D2_SERIE AND SD2.D2_TIPO = SF2.F2_TIPO AND SD2.D_E_L_E_T_ = SF2.D_E_L_E_T_  "
	cQuery += "	INNER JOIN  " + RetSqlName("SB1") + " SB1 ON SB1.B1_FILIAL = '"+ FwXFilial("SB1") +"' AND SB1.B1_COD = SD2.D2_COD AND SD2.D_E_L_E_T_ = SB1.D_E_L_E_T_ "
	cQuery += " INNER JOIN  "+ RetSqlName("SF4") + " SF4 ON SF4.F4_FILIAL = '"+ FwXFilial("SF4") +"' AND SF4.F4_CODIGO = SD2.D2_TES  "
	cQuery += " WHERE SD2.D2_EMISSAO BETWEEN " + getBetweenDates(NIL , NIL, .F.) + " AND "
	cQuery += " SF4.F4_TRANFIL IN ('2','') AND SF4.F4_MSBLQL IN ('2','') AND "
	cQuery += getSellerFilter(.T.,.F.)
	cQuery += "	 SD2.D_E_L_E_T_ = ' ' AND "
	cQuery += " SF2.F2_TIPO IN ('N','C')  "
	cQuery += "	GROUP BY D2_COD, B1_DESC "
	cQuery += "	ORDER BY QTD DESC " + IIF(AllTrim(Upper(TcGetDb())) == "POSTGRES", " LIMIT 5 ", " ") + " ) TOT_QTD"
	cQuery += " WHERE #QueryWhere#  "

Return cQuery
