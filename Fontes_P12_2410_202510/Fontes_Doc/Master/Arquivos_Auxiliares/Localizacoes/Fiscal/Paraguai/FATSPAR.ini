[XXX INICIALIZACION]
(PRE) SD2->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SYA->(DbSetOrder(1))
(PRE) SAH->(DbSetOrder(1))

(PRE) If(AllTrim(SF2->F2_ESPECIE)<>"NDI",CTO->(MsSeek(xFilial("CTO")+Strzero(SF2->F2_MOEDA,2))) , .T.)
(PRE) If(AllTrim(SF2->F2_ESPECIE)<>"NDI",SA1->(MSSeek(xFilial("SA1")+SF2->F2_CLIENTE+SF2->F2_LOJA)) , .T.)
(PRE) If(AllTrim(SF2->F2_ESPECIE)<>"NDI",SYA->(MsSeek(xFilial("SYA")+SA1->A1_PAIS)) , .T.)
(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999.99"
(PRE) _aTotal[004] := {"SD2",""}
(PRE) _aTotal[005] := M486SecCod(Time(),SF2->F2_EMISSAO)
(PRE) _aTotal[006] := Alltrim(SF2->F2_SERIE) + Alltrim(SF2->F2_DOC) + Alltrim(SF2->F2_ESPECIE)
(PRE) _aTotal[007] := IIF(AllTrim(SF2->F2_ESPECIE)=="NF",M486GENCDC("01",SUBSTR(SM0->M0_CGC,1,RAT("-",SM0->M0_CGC)-1),Substr(SM0->M0_CGC,RAT("-",SM0->M0_CGC)+ 1,1),SUBSTR(SF2->F2_DOC,1,3),SUBSTR(SF2->F2_DOC,4,3),RIGHT(SF2->F2_DOC,7),"1",SF2->F2_EMISSAO,"1",_aTotal[005],SF2->F2_ESPECIE),"")
(PRE) _aTotal[007] := IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",M486GENCDC("06",SUBSTR(SM0->M0_CGC,1,RAT("-",SM0->M0_CGC)-1),Substr(SM0->M0_CGC,RAT("-",SM0->M0_CGC)+ 1,1),SUBSTR(SF2->F2_DOC,1,3),SUBSTR(SF2->F2_DOC,4,3),RIGHT(SF2->F2_DOC,7),"1",SF2->F2_EMISSAO,"1",_aTotal[005],SF2->F2_ESPECIE),_aTotal[007])
(PRE) _aTotal[007] := IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",M486GENCDC("07",SUBSTR(SM0->M0_CGC,1,RAT("-",SM0->M0_CGC)-1),Substr(SM0->M0_CGC,RAT("-",SM0->M0_CGC)+ 1,1),SUBSTR(SF2->F2_DOC,1,3),SUBSTR(SF2->F2_DOC,4,3),RIGHT(SF2->F2_DOC,7),"1",SF2->F2_EMISSAO,"1",_aTotal[005],SF2->F2_ESPECIE),_aTotal[007])
(PRE) _aTotal[008] := AllTrim(STR(CalcMod11(SUBSTR(_aTotal[007],1,43))))
(PRE) _aTotal[009] := M486CONDPAG(SF2->F2_FILIAL, SF2->F2_DOC,SF2->F2_SERIE, SF2->F2_CLIENTE,SF2->F2_LOJA,SF2->F2_ESPECIE,SF2->F2_COND,SF2->F2_MOEDA,SF2->F2_TXMOEDA)
(PRE) _aTotal[010] := ObtColSAT("S030",SUBSTR(SM0->M0_CGC,1,10) , 1, 10, 18,2) 
(PRE) _aTotal[011] := SUBSTR(DTOS(SF2->F2_EMISSAO),0,4) + "-" + SUBSTR(DTOS(SF2->F2_EMISSAO),5,2) + "-" + SUBSTR(DTOS(SF2->F2_EMISSAO),7,2) + "T" + SF2->F2_HORA
(PRE) _aTotal[012] := ObtColSAT("S030",SUBSTR(SM0->M0_CGC,1,10) , 1, 10, 20,3)
(PRE) _aTotal[013] :=.f.
(PRE) _aTotal[014] := ObtColSAT("S030",SUBSTR(SM0->M0_CGC,1,10) , 1, 10, 23,4)
(PRE) _aTotal[015] := M486IMPPAR(ALLTRIM(SF2->F2_ESPECIE),SF2->F2_DOC,SF2->F2_SERIE, SF2->F2_CLIENTE,SF2->F2_LOJA, CTO->CTO_MOESAT, AllTrim(SF2->F2_TPTRANS),SF2->F2_TXMOEDA)
(PRE) _aTotal[016] := ""
(PRE) _aTotal[017] :=  M486SUBTOT(ALLTRIM(SF2->F2_ESPECIE),SF2->F2_DOC,SF2->F2_SERIE, SF2->F2_CLIENTE,SF2->F2_LOJA)
(PRE) _aTotal[024] := ObtColSAT("S030",SUBSTR(SM0->M0_CGC,1,10) , 1, 10, 11,6)
(PRE) _aTotal[025] := {0,0}

(PREREG) FsQuery(_aTotal[004],1,"D2_DOC='" + SF2->F2_DOC + "' AND D2_SERIE='" + SF2->F2_SERIE + "' AND D2_CLIENTE='" + SF2->F2_CLIENTE + "' AND D2_LOJA='" + SF2->F2_LOJA + "'","SD2->D2_DOC=SF2->F2_DOC .AND. SD2->D2_SERIE=SF2->F2_SERIE .AND. SD2->D2_CLIENTE=SF2->F2_CLIENTE .AND. SD2->D2_LOJA=SF2->F2_LOJA","D2_ITEM") .And. .T.

[XXX ENCABEZADO]
(PREREG) (_aTotal[001] := '<rDE' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += ' xmlns="http://ekuatia.set.gov.py/sifen/xsd" ' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += ' xsi:schemaLocation="http://ekuatia.set.gov.py/sifen/xsd/ siRecepDE_v150.xsd">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += ' <dVerFor>150</dVerFor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '	<DE Id="' + _aTotal[007] + '">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		<dDVId>' + _aTotal[008] + '</dDVId>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		<dFecFirma></dFecFirma> ' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '		<dSisFact>1</dSisFact>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		<gOpeDE>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        	<iTipEmi>1</iTipEmi>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        	<dDesTipEmi>Normal</dDesTipEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '			<dCodSeg>' + SUBSTR(_aTotal[007],35,9) + '</dCodSeg>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'    		<dInfoEmi>PRUEBAS</dInfoEmi>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"NDC",'    		<dInfoFisc>PRUEBAS</dInfoFisc>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += '		</gOpeDE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		<gTimb>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'        	<iTiDE>1</iTiDE>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'        	<iTiDE>6</iTiDE>' + _aTotal[002],'        	<iTiDE>7</iTiDE>' + _aTotal[002])),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'        	<dDesTiDE>Factura electrónica</dDesTiDE>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'        	<dDesTiDE>Nota de débito electrónica</dDesTiDE>' + _aTotal[002],'        	<dDesTiDE>Nota de remisión electrónica</dDesTiDE>' + _aTotal[002])),.T.)
(PREREG) (_aTotal[001] += '        	<dNumTim>'+ ALLTRIM(SF2->F2_NUMTIM) +'</dNumTim>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        	<dEst>' + SUBSTR(SF2->F2_DOC,1,3) + '</dEst>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        	<dPunExp>' + SUBSTR(SF2->F2_DOC,4,3) + '</dPunExp>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        	<dNumDoc>' + RIGHT(SF2->F2_DOC,7) + '</dNumDoc>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        	<dSerieNum>' + "AA" + '</dSerieNum>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '			<dFeIniT>' +FecIniTimb(SF2->F2_SERIE, SF2->F2_ESPECIE) + '</dFeIniT>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		</gTimb>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		<gDatGralOpe>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '			<dFeEmiDE>' + _aTotal[011] + '</dFeEmiDE>' + _aTotal[002],.T.)
// Campos inherentes a la operación comercial (D010-D099)
//(PREREG) (_aTotal[001] +=  _aTotal[015] + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",  _aTotal[015] + _aTotal[002],""),.T.)
//EMISOR
(PREREG) (_aTotal[001] += '			<gEmis>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dRucEm>' + SUBSTR(SM0->M0_CGC,1,RAT("-",SM0->M0_CGC)-1)+'</dRucEm>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDVEmi>' + Substr(SM0->M0_CGC,RAT("-",SM0->M0_CGC)+ 1,1) + '</dDVEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<iTipCont>1</iTipCont>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cTipReg>'+ ObtColSAT("S030",SUBSTR(SM0->M0_CGC,1,10) , 1, 10, 17,1) +'</cTipReg>' + _aTotal[002],.T.)
//Si se realiza el proceso en producción habilitar la siguiente linea, si se realizan pruebas comentarla
//(PREREG) (_aTotal[001] += '				<dNomEmi>'+ alltrim(SM0->M0_NOME) + '</dNomEmi>' + _aTotal[002],.T.)
//Si se realiza el proceso en testes habilitar la siguiente linea, si se realizan producción comentarla
(PREREG) (_aTotal[001] += '				<dNomEmi>'+  "DE generado en ambiente de prueba - sin valor comercial ni fiscal" + '</dNomEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dNomFanEmi>'+ alltrim(SM0->M0_NOMECOM) + '</dNomFanEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDirEmi>'+ alltrim(SM0->M0_ENDENT) + '</dDirEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(Empty(_aTotal[024]),'				<dNumCas>0</dNumCas>' + _aTotal[002],'				<dNumCas>'+ _aTotal[024] + '</dNumCas>' + _aTotal[002]),.T.)
(PREREG) (_aTotal[001] += '				<cDepEmi>' + _aTotal[010]+ '</cDepEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesDepEmi>' + alltrim(ObtColSAT("S003",_aTotal[010], 1, 2, 3,28)) + '</dDesDepEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cDisEmi>' + alltrim(_aTotal[012]) + '</cDisEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesDisEmi>' + alltrim(ObtColSAT("S031",_aTotal[012], 1, 3, 4,30))+ '</dDesDisEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cCiuEmi>' +  alltrim(_aTotal[014])  + '</cCiuEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesCiuEmi>' +  alltrim(ObtColSAT("S012",_aTotal[014], 48, 4, 52,30))+ '</dDesCiuEmi>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SM0->M0_TEL)  ,'				<dTelEmi>' + alltrim(SM0->M0_TEL) + '</dTelEmi>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += '				<dEmailE>' +  'contactos@ypsa.com.py'  + '</dEmailE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<gActEco>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '					<cActEco>' + ALLTRIM(SM0->M0_DSCCNA) + '</cActEco>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '					<dDesActEco>'+ ObtColSAT("S006",SUBSTR(SM0->M0_DSCCNA,1,6) , 2, 5, 7,166)+'</dDesActEco>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				</gActEco>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '			</gEmis>' + _aTotal[002],.T.)
//RECEPTOR
(PREREG) (_aTotal[001] += '			<gDatRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<iNatRec>1</iNatRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<iTiOpe>1</iTiOpe>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cPaisRec>' + SYA->YA_CODERP + '</cPaisRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesPaisRe>'+ ObtColSAT("S005",SYA->YA_CODERP, 1, 3, 4,52)+'</dDesPaisRe>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SA1->A1_CGC)  ,'				<iTiContRec>' + IIF(SA1->A1_PESSOA $ "F","1","2") + '</iTiContRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SA1->A1_CGC)  ,'				<dRucRec>' +  SUBSTR(SA1->A1_CGC,1,RAT("-",SA1->A1_CGC)-1) + '</dRucRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SA1->A1_CGC)  ,'				<dDVRec>' + Substr(SA1->A1_CGC,RAT("-",SA1->A1_CGC)+ 1,1) + '</dDVRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF( Empty(SA1->A1_CGC)  ,'				<iTipIDRec>' + AllTrim(SA1->A1_TIPDOC) + '</iTipIDRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF( Empty(SA1->A1_CGC)  ,'				<dDTipIDRec>' +  ObtColSAT("S018", SA1->A1_TIPDOC, 1, 1, 2,41) + '</dDTipIDRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF( Empty(SA1->A1_CGC)  ,'				<dNumIDRec>' +  IIF(AllTrim(SA1->A1_TIPDOC)=="5","0",ALLTRIM(SA1->A1_NIF)) + '</dNumIDRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += '				<dNomRec>' + ALLTRIM(SA1->A1_NOME)+ '</dNomRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dNomFanRec>' + ALLTRIM(SA1->A1_NREDUZ)+ '</dNomFanRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDirRec>' + AllTrim(SA1->A1_END) + '</dDirRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dNumCasRec>' + AllTrim(SA1->A1_NUM) + '</dNumCasRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cDepRec>' + SA1->A1_DEPTO + '</cDepRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesDepRec>' + alltrim(ObtColSAT("S003",SA1->A1_DEPTO, 1, 2, 3,28)) +'</dDesDepRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cDisRec>' + SA1->A1_DISTR+ '</cDisRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesDisRec>'+ AllTrim(ObtColSAT("S031",SA1->A1_DISTR, 1, 3, 4,30)) + '</dDesDisRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<cCiuRec>' + ALLTRIM(SA1->A1_CIUDAD) + '</cCiuRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '				<dDesCiuRec>' + alltrim(ObtColSAT("S012",SA1->A1_CIUDAD, 48, 4, 52,30)) + '</dDesCiuRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SA1->A1_TEL)  ,'				<dTelRec>' + ALLTRIM(SA1->A1_TEL) + '</dTelRec>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(!Empty(SA1->A1_EMAIL),'				<dEmailRec>' + SA1->A1_EMAIL + '</dEmailRec>' + _aTotal[002],'') ,.T.)
(PREREG) (_aTotal[001] += '				<dCodCliente>' + alltrim(SA1->A1_COD) + '</dCodCliente>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '			</gDatRec>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '		</gDatGralOpe>' + _aTotal[002],.T.)
//TIPO DE PRESENCIA
(PREREG) (_aTotal[001] += '		<gDtipDE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'        	<gCamFE>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'        	<gCamNCDE>' + _aTotal[002],'        	<gCamNRE>' + _aTotal[002])),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'    			<iIndPres>' + AllTrim(SF2->F2_TIPONF) + '</iIndPres>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    			<iMotEmi>' + ALLTRIM(SF2->F2_TIPREF) + '</iMotEmi>' + _aTotal[002],'    			<iMotEmiNR>' + ALLTRIM(SF2->F2_MOTEMIR) + '</iMotEmiNR>' + _aTotal[002])),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'        		<dDesIndPres>'+ ObtColSAT("S019",SF2->F2_TIPONF, 1, 1, 2,30)+'</dDesIndPres>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'        		<dDesMotEmi>'+ ObtColSAT("S021",SF2->F2_TIPREF, 1, 1, 2,30)+'</dDesMotEmi>' + _aTotal[002],'        		<dDesMotEmiNR>'+ ObtColSAT("S022",SF2->F2_MOTEMIR, 1, 2, 3,60)+'</dDesMotEmiNR>' + _aTotal[002])),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<iRespEmiNR>1</iRespEmiNR>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<dDesRespEmiNR>Emisor de la factura</dDesRespEmiNR>'+ _aTotal[002],""),.T.)
//(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<dKmR>' + ALLTRIM(STR(SF2->F2_KM)) + '</dKmR>'+ _aTotal[002],""),.T.)
(PRE) _aTotal[023] := SUBSTR(DTOS(SF2->F2_FECHSE),0,4) + "-" + SUBSTR(DTOS(SF2->F2_FECHSE),5,2) + "-" + SUBSTR(DTOS(SF2->F2_FECHSE),7,2)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .and. ALLTRIM(SF2->F2_MOTEMIR) == "1",'    			<dFecEm>' + _aTotal[023] + '</dFecEm>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'        	</gCamFE>' + _aTotal[002],IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'        	</gCamNCDE>' + _aTotal[002],'        	</gCamNRE>' + _aTotal[002])),.T.)

// CONDICIONES DE PAGO
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",  _aTotal[009] + _aTotal[002],""),.T.)
[SD2 GENERANDO_XML]
(PRE) DbGoTop()
(PREREG) (SB1->(DbSeek(xFilial("SB1") + SD2->D2_COD)),.T.)
(PREREG) (SAH->(DbSeek(xFilial("SAH") + SB1->B1_UM)),.T.)
(PREREG) _aTotal[016] := M486IMPDPAR(ALLTRIM(SF2->F2_ESPECIE),SF2->F2_DOC,SF2->F2_SERIE, SF2->F2_CLIENTE,SF2->F2_LOJA, SD2->D2_TES,SD2->D2_ITEM,SD2->D2_COD,@_aTotal[025],@_aTotal[017])
(PREREG) (_aTotal[001] += '        	<gCamItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    			<dCodInt>' + alltrim(SB1->B1_COD) + '</dCodInt>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    			<dDesProSer>' + alltrim(SB1->B1_DESC) + '</dDesProSer>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    			<cUniMed>' + alltrim(SAH->AH_COD_CO) + '</cUniMed>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    			<dDesUniMed>' + ObtColSAT("S002",SAH->AH_COD_CO, 1, 3, 29,6) + '</dDesUniMed>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    			<dCantProSer>' + ALLTRIM(TRANSFORM(SD2->D2_QUANT,"9999999999.9999") )+ '</dCantProSer>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN", _aTotal[016] + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += '        	</gCamItem>' + _aTotal[002],.T.)

//Nodos de Guia de Remisión
(PREREG) (DA3->(DbSetOrder(1)),.T.)
(PREREG) (DA3->(DbSeek(xFilial("DA3") + SF2->F2_VEICULO)),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'        	<gTransp>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<iTipTrans>' + AllTrim(DA3->DA3_TIPTR2) + '</iTipTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",IIF(AllTrim(AllTrim(DA3->DA3_FROVEI))=="1",'    			<dDesTipTrans>Propio</dDesTipTrans>' + _aTotal[002],'    			<dDesTipTrans>Tercero</dDesTipTrans>' + _aTotal[002]),""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<iModTrans>' + AllTrim(DA3->DA3_TIPTR2) + '</iModTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<dDesModTrans>' + alltrim(ObtColSAT("S026", AllTrim(DA3->DA3_TIPTR2), 1, 1, 2,10)) + '</dDesModTrans>' + _aTotal[002],""),.T.)
//VERIFICAR
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<iRespFlete>' + AllTrim(SF2->F2_TPRESFL) + '</iRespFlete>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<cCondNeg>' + AllTrim(SF2->F2_INCOTER) + '</cCondNeg>' + _aTotal[002],""),.T.)
(PRE) _aTotal[022] := SUBSTR(DTOS(SF2->F2_FECDSE),0,4) + "-" + SUBSTR(DTOS(SF2->F2_FECDSE),5,2) + "-" + SUBSTR(DTOS(SF2->F2_FECDSE),7,2)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<dIniTras>' + _aTotal[022] + '</dIniTras>' + _aTotal[002],""),.T.)
(PRE) _aTotal[023] := SUBSTR(DTOS(SF2->F2_FECHSE),0,4) + "-" + SUBSTR(DTOS(SF2->F2_FECHSE),5,2) + "-" + SUBSTR(DTOS(SF2->F2_FECHSE),7,2)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<dFinTras>' + _aTotal[023]  + '</dFinTras>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<gCamSal>' + _aTotal[002],""),.T.)

(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDirLocSal>' + alltrim(SM0->M0_ENDENT) + '</dDirLocSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",IIF(Empty(_aTotal[024]),'    				<dNumCasSal>0</dNumCasSal>' + _aTotal[002],'    				<dNumCasSal>'+ _aTotal[024] + '</dNumCasSal>' + _aTotal[002]),""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .and. !Empty(SM0->M0_COMPENT),'    				<dComp1Sal>' + alltrim(SM0->M0_COMPENT) + '</dComp1Sal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cDepSal>' + _aTotal[010] + '</cDepSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesDepSal>' + alltrim(ObtColSAT("S003",_aTotal[010], 1, 2, 3,28)) + '</dDesDepSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cDisSal>' + alltrim(_aTotal[012]) + '</cDisSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesDisSal>' + alltrim(ObtColSAT("S031",_aTotal[012], 1, 3, 4,30)) + '</dDesDisSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cCiuSal>' + alltrim(_aTotal[014]) + '</cCiuSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesCiuSal>' + alltrim(ObtColSAT("S012",_aTotal[014], 48, 4, 52,30)) + '</dDesCiuSal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			</gCamSal>' + _aTotal[002],""),.T.)

(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<gCamEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDirLocEnt>' + AllTrim(SA1->A1_END) + '</dDirLocEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dNumCasEnt>' + AllTrim(SA1->A1_NUM) + '</dNumCasEnt>' + _aTotal[002],""),.T.)
//(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dComp1Ent>' + AllTrim(_aTotal[025][3]) + '</dComp1Ent>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cDepEnt>' + AllTrim(SA1->A1_DEPTO) + '</cDepEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesDepEnt>' + Alltrim(ObtColSAT("S003",SA1->A1_DEPTO, 1, 2, 3,28)) + '</dDesDepEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cDisEnt>' + AllTrim(SA1->A1_DISTR) + '</cDisEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesDisEnt>' + AllTrim(ObtColSAT("S031",SA1->A1_DISTR, 1, 3, 4,30)) + '</dDesDisEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<cCiuEnt>' + ALLTRIM(SA1->A1_CIUDAD) + '</cCiuEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dDesCiuEnt>' +  AllTrim(ObtColSAT("S012",SA1->A1_CIUDAD, 48, 4, 52,30)) + '</dDesCiuEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .and. !Empty(SA1->A1_TEL),'    				<dTelEnt>' + ALLTRIM(SA1->A1_TEL) + '</dTelEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			</gCamEnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<gVehTras>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dTiVehTras>' + Alltrim(ObtColSAT("S026", AllTrim(DA3->DA3_TIPTR2), 1, 1, 2,10)) + '</dTiVehTras>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dMarVeh>' + AllTrim(DA3->DA3_DESC) + '</dMarVeh>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dTipIdenVeh>' + AllTrim(DA3->DA3_TIPID) + '</dTipIdenVeh>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",IIF(AllTrim(DA3->DA3_TIPID)=="1",'    				<dNroIDVeh>' + AllTrim(DA3->DA3_CHASSI) + '</dNroIDVeh>' + _aTotal[002],'    				<dNroMatVeh>' + AllTrim(DA3->DA3_PLACA) + '</dNroMatVeh>' + _aTotal[002]),""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",IIF(AllTrim(DA3->DA3_TIPTR2)=="3",'    				<dNroVuelo>' + AllTrim(SF2->F2_RASTR) + '</dNroVuelo>' + _aTotal[002], ""),""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			</gVehTras>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			<gCamTrans>' + _aTotal[002],""),.T.)
(PREREG) (SA4->(DbSeek(xFilial("SA4") + SF2->F2_TRANSP)),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<iNatTrans>' + AllTrim(SA4->A4_TIPCON) + '</iNatTrans>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dNomTrans>' + ALLTRIM(SA4->A4_NOME) + '</dNomTrans>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .And. AllTrim(SA4->A4_TIPCON)=="1",'    				<dRucTrans>' + SUBSTR(SA4->A4_CGC,1,RAT("-",SA4->A4_CGC)-1) + '</dRucTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .And. AllTrim(SA4->A4_TIPCON)=="1",'    				<dDVTrans>' + SUBSTR(SA4->A4_CGC,RAT("-",SA4->A4_CGC)+ 1,1) + '</dDVTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .And. AllTrim(SA4->A4_TIPCON)<>"1",'    				<iTipIDTrans>' + ALLTRIM(SA4->A4_TIPID) + '</iTipIDTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .And. AllTrim(SA4->A4_TIPCON)<>"1",'    				<dDTipIDTrans>' +  Alltrim(ObtColSAT("S018", ALLTRIM(SA4->A4_TIPID), 1, 1, 2,41))  + '</dDTipIDTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN" .And. AllTrim(SA4->A4_TIPCON)<>"1",'    				<dNumIDTrans>' + AllTrim(SA4->A4_CGC) + '</dNumIDTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dNumIDChof>' + AllTrim(SA4->A4_CGC) + '</dNumIDChof>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    				<dNomChof>' + AllTrim(SA4->A4_NOME) + '</dNomChof>'+ _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'    			</gCamTrans>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="RFN",'        	</gTransp>' + _aTotal[002],""),.T.)


[XXX INVOICE_FIN]
(PREREG) (_aTotal[001] += '		</gDtipDE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'		<gTotSub>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dSubExe>'+ ALLTRIM(TRANSFORM(_aTotal[017,1],"999999999999999.9999"))+'</dSubExe>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dSubExo>'+ ALLTRIM(TRANSFORM(_aTotal[017,2],"999999999999999.9999"))+'</dSubExo>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dSub5>'+ ALLTRIM(TRANSFORM(_aTotal[017,3],"999999999999999.9999"))+'</dSub5>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dSub10>'+ ALLTRIM(TRANSFORM(_aTotal[017,4],"999999999999999.9999"))+'</dSub10>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotOpe>'+ ALLTRIM(TRANSFORM(_aTotal[017,5],"999999999999999.9999"))+'</dTotOpe>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotDesc>'+ ALLTRIM(TRANSFORM(_aTotal[025][1],"999999999999999.9999"))+'</dTotDesc>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotDescGlotem>'+ ALLTRIM(TRANSFORM(_aTotal[017,6],"999999999999999.9999"))+'</dTotDescGlotem>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotAntItem>0</dTotAntItem>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotAnt>0</dTotAnt>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dPorcDescTotal>0</dPorcDescTotal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dDescTotal>'+ ALLTRIM(TRANSFORM(_aTotal[025][1],"999999999999999.9999"))+'</dDescTotal>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dAnticipo>0</dAnticipo>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dRedon>0.0</dRedon>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotGralOpe>'+ ALLTRIM(TRANSFORM(SF2->F2_VALBRUT,"999999999999999.9999"))+'</dTotGralOpe>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dIVA5>'+ ALLTRIM(TRANSFORM(_aTotal[017,7],"999999999999999.9999"))+'</dIVA5>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dIVA10>'+ ALLTRIM(TRANSFORM(_aTotal[017,8],"999999999999999.9999"))+'</dIVA10>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dTotIVA>'+ ALLTRIM(TRANSFORM(_aTotal[017,9],"999999999999999.9999"))+'</dTotIVA>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'        	<dBaseGrav5>'+ ALLTRIM(TRANSFORM(_aTotal[017,10],"999999999999999.9999"))+'</dBaseGrav5>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'			<dBaseGrav10>'+ ALLTRIM(TRANSFORM(_aTotal[017,11],"999999999999999.9999"))+'</dBaseGrav10>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'			<dTBasGraIVA>'+ ALLTRIM(TRANSFORM(_aTotal[017,12],"999999999999999.9999"))+'</dTBasGraIVA>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN" .and. AllTrim(STR(SF2->F2_MOEDA))<>"1"	 ,'			<dTotalGs>'+ ALLTRIM(TRANSFORM(SF2->F2_VALBRUT*SF2->F2_TXMOEDA,"999999999999999.9999"))+'</dTotalGs>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)<>"RFN",'		</gTotSub>' + _aTotal[002],""),.T.)


[XXX DOCUMENTO_ASOCIADO]

(PRE) _aTotal[018] := M486ASOC(SF2->F2_ESPECIE,SF2->F2_DOC,SF2->F2_SERIE,SF2->F2_CLIENTE,SF2->F2_LOJA,"1")
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'		<gCamDEAsoc>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC", _aTotal[018],""),.T.) 
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'		</gCamDEAsoc>' + _aTotal[002],""),.T.)
(PREREG) (_aTotal[001] += '	</DE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</rDE>' + _aTotal[002],.T.)
(PREREG) ENCODEUTF8(_aTotal[001])
(POS) FsQuery(_aTotal[004],2)

[XXX FACTURA]
(PRE) _aTotal[094] := _aTotal[006] + ".XML"
(ARQ) _aTotal[094]
