[XXX INICIALIZACION]
(PRE) SF1->(DbSetOrder(1))
(PRE) SD1->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SA1->(DbSetOrder(1))
(PRE) SFP->(DbSetOrder(1))
(PRE) CTO->(DbSetOrder(1))

(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999999999.9999"
(PRE) _aTotal[004] := {"SD1",""}
(PRE) _aTotal[005] := SFP->FP_DOCFIS
(PRE) _aTotal[006] := Alltrim(SF1->F1_SERIE) + Alltrim(SF1->F1_DOC) + Alltrim(SF1->F1_ESPECIE)
(PRE) _aTotal[007] := SuperGetMV("MV_CFDIAMB",.F.,"1")
(PRE) _aTotal[008] := SF1->F1_VALBRUT
(PRE) _aTotal[009] := TamSX3("F1_DOC")[1]
//(PRE) _aTotal[010] := "10"
(PRE) _aTotal[011] := DtoS(SF1->F1_EMISSAO)
(PRE) _aTotal[011] := Left(_aTotal[011],4) + "-" + Substr(_aTotal[011],5,2)+ "-" + Right(_aTotal[011],2)+ "T" + alltrim(SF1->F1_HORA) + iif(Len(alltrim(SF1->F1_HORA)) == 5, ":00.000", ".000" )
(PRE) _aTotal[012] := ""
(PRE) _aTotal[013] := alltrim(SA1->A1_EST) == "EX"
(PRE) _aTotal[014] := "1"
(PRE) _aTotal[015] := "01"
(PRE) _aTotal[016] := SuperGetMV("MV_CUFD",.F.," ") 
(PRE) _aTotal[017] := "0"
(PRE) _aTotal[018] := SPACE(17) 
(PRE) _aTotal[019] := PADL(Alltrim(SM0->M0_CGC), 13,"0") + _aTotal[018] + PADL(Alltrim(_aTotal[017]), 4,"0") + SuperGetMV("MV_SINMOD",,"") + SuperGetMV("MV_SINEMI",,"") + _aTotal[005] + PADL(alltrim(SF1->F1_TIPNOTA), 2, "0")    
(PRE) _aTotal[019] += PADL(ALLTRIM(substr(SF1->F1_DOC,(_aTotal[009]-7),8)), 8, "0") + iif(Empty(SFP->FP_PV),REPLICATE("0",4),PADL(SFP->FP_PV,4,"0"))
(PRE) _aTotal[020] := {"SD2",""}


(PREREG) FsQuery(_aTotal[004],1,"D1_DOC='" + SF1->F1_DOC + "' AND D1_SERIE='" + SF1->F1_SERIE + "' AND D1_FORNECE='" + SF1->F1_FORNECE + "' AND D1_LOJA='" + SF1->F1_LOJA + "'","SD1->D1_DOC=SF1->F1_DOC .AND. SD1->D1_SERIE=SF1->F1_SERIE .AND. SD1->D1_FORNECE=SF1->F1_FORNECE .AND. SD1->D1_LOJA=SF1->F1_LOJA","D1_ITEM") .And. .T.
(PREREG) _aTotal[010] := M486BOLDAT(SD1->D1_NFORI, SD1->D1_SERIORI, SD1->D1_FORNECE, SD1->D1_LOJA, '1')
//(PRE) MSGALERT("PRUEBA 01")
[XXX ENCABEZADO]
(PREREG) (SFP->(DbSeek(xFilial("SFP")+Alltrim(SF1->F1_FILIAL)+Alltrim(M->F1_SERIE))),.T.)
(PREREG) (CTO->(MsSeek(xFilial("CTO")+Strzero(SF1->F1_MOEDA,2))),.T.)
(PREREG) (SA1->(MSSeek(xFilial("SA1")+SF1->F1_FORNECE+SF1->F1_LOJA)),.T.)
(PREREG) (_aTotal[001] := '<?xml version="1.0" encoding="UTF-8"?>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<notaFiscalElectronicaCreditoDebito xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="notaFiscalElectronicaCreditoDebito.xsd">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '  <cabecera>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <nitEmisor>' + Alltrim(SM0->M0_CGC) + '</nitEmisor>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <numeroNotaCreditoDebito>' + ALLTRIM(substr(SF1->F1_DOC,(_aTotal[009]-7),8)) + '</numeroNotaCreditoDebito>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <cuf>' + _aTotal[019] +'</cuf>' + _aTotal[002],.T.)   
(PREREG) (_aTotal[001] += '    <cufd>'+ _aTotal[016] +'</cufd>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <codigoSucursal>'+  _aTotal[017] +'</codigoSucursal>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <direccion>'+ SA1->A1_END +'</direccion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <codigoPuntoVenta ' + iif(Empty(SFP->FP_PV) .OR. val(SFP->FP_PV) == 0 , 'xsi:nil="true"/>', '>' + PADL(SFP->FP_PV,4,"0") + '</codigoPuntoVenta>') + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <fechaEmision>' + _aTotal[011] + '</fechaEmision>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <nombreRazonSocial>' + Alltrim(SA1->A1_NOME) + '</nombreRazonSocial>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <codigoTipoDocumentoIdentidad>' + SA1->A1_TIPDOC + '</codigoTipoDocumentoIdentidad>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <numeroDocumento>' + Alltrim(SA1->A1_CGC) + '</numeroDocumento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <complemento xsi:nil="true"/>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoCliente>' + SF1->F1_FORNECE+SF1->F1_LOJA + '</codigoCliente>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <numeroFactura>' +  ALLTRIM(substr(SD1->D1_NFORI,(_aTotal[009]-7),8)) + '</numeroFactura>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <numeroAutorizacionCuf>' +  ALLTRIM(_aTotal[010][1][1]) + '</numeroAutorizacionCuf>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <fechaEmisionFactura>' +  _aTotal[010][1][2] + '</fechaEmisionFactura>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <montoTotalOriginal>' + Alltrim(TRANSFORM(_aTotal[010][1][4], _aTotal[003])) + '</montoTotalOriginal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <montoTotalDevuelto>' + Alltrim(TRANSFORM(SF1->F1_VALMERC, _aTotal[003])) + '</montoTotalDevuelto>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <montoEfectivoCreditoDebito>' + Alltrim(TRANSFORM(ObtImpBol(SF1->F1_DOC,SF1->F1_SERIE,SF1->F1_FORNECE,SF1->F1_LOJA), _aTotal[003])) + '</montoEfectivoCreditoDebito>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <leyenda>Ley Nro 453: Los servicios deben suministrarse en condiciones de inocuidad, calidad y seguridad.</leyenda>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <usuario>'+ Alltrim(SubStr(cUsuario,7,15)) +'</usuario>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <codigoDocumentoSector>' + alltrim(SF1->F1_TIPNOTA) + '</codigoDocumentoSector>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '  </cabecera>' + _aTotal[002],.T.)  
//(PRE)  MSGALERT("PRUEBA 02")


(PREREG) FsQuery(_aTotal[020],1,"D2_DOC='" + SD1->D1_NFORI + "' AND D2_SERIE='" + SD1->D1_SERIORI + "' AND D2_CLIENTE='" + SF1->F1_FORNECE + "' AND D2_LOJA='" + SF1->F1_LOJA + "'","SD2->D2_DOC=SD1->D1_NFORI .AND. SD2->D2_SERIE=SD1->D1_SERIORI .AND. SD2->D2_CLIENTE=SF1->F1_FORNECE .AND. SD2->D2_LOJA=SF1->F1_LOJA","D2_ITEM") .And. .T.
[SD2 INVOICE]
(PREREG) (SAH->(DbSeek(xFilial("SAH") + SD2->D2_UM)),.T.)
(PREREG) (SB1->(DbSeek(xFilial("SB1") + SD2->D2_COD)),.T.)
(PREREG) (_aTotal[001] += '  <detalle>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <actividadEconomica>' + Alltrim(SM0->M0_INSC) + '</actividadEconomica>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProductoSin>' + Alltrim(SB1->B1_PRODSAT) + '</codigoProductoSin>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProducto>' + Alltrim(SB1->B1_COD) + '</codigoProducto>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <descripcion>' + Alltrim(SB1->B1_DESC) + '</descripcion>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <cantidad>' + Alltrim(TRANSFORM(SD2->D2_QUANT,_aTotal[003])) + '</cantidad>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <unidadMedida>' + Alltrim(SAH->AH_COD_CO) + '</unidadMedida>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <precioUnitario>'+ Alltrim(TRANSFORM(SD2->D2_PRCVEN,_aTotal[003])) +'</precioUnitario>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <subTotal>'+ Alltrim(TRANSFORM(SD2->D2_TOTAL,_aTotal[003])) +'</subTotal>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoDetalleTransaccion>1</codigoDetalleTransaccion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '  </detalle>' + _aTotal[002],.T.) 



[SD1 INVOICE]
(PRE) DbGoTop()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
(PREREG) (SAH->(DbSeek(xFilial("SAH") + SD1->D1_UM)),.T.)
(PREREG) (SB1->(DbSeek(xFilial("SB1") + SD1->D1_COD)),.T.)
(PREREG) (_aTotal[001] += '  <detalle>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <actividadEconomica>' + Alltrim(SM0->M0_INSC) + '</actividadEconomica>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProductoSin>' + Alltrim(SB1->B1_PRODSAT) + '</codigoProductoSin>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProducto>' + Alltrim(SB1->B1_COD) + '</codigoProducto>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <descripcion>' + Alltrim(SB1->B1_DESC) + '</descripcion>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <cantidad>' + Alltrim(TRANSFORM(SD1->D1_QUANT,_aTotal[003])) + '</cantidad>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <unidadMedida>' + Alltrim(SAH->AH_COD_CO) + '</unidadMedida>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <precioUnitario>'+ Alltrim(TRANSFORM(SD1->D1_VUNIT,_aTotal[003])) +'</precioUnitario>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <subTotal>'+ Alltrim(TRANSFORM(SD1->D1_TOTAL,_aTotal[003])) +'</subTotal>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoDetalleTransaccion>2</codigoDetalleTransaccion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '  </detalle>' + _aTotal[002],.T.)  
 

//(PRE) MSGALERT("PRUEBA 03")

[XXX INVOICE_FIN]
(PREREG) (_aTotal[001] += _aTotal[012],.T.)
(PREREG) (_aTotal[001] += '</notaFiscalElectronicaCreditoDebito>' + _aTotal[002],.T.)   
(PREREG) ENCODEUTF8(_aTotal[001])

(POS) FsQuery(_aTotal[004],2)
[XXX FACTURA]
(PRE) _aTotal[094] := _aTotal[006] + ".XML"
(ARQ) _aTotal[094]
//(PRE) MSGALERT("PRUEBA 4")    
