[XXX INICIALIZACION]
(PRE) SF2->(DbSetOrder(1))
(PRE) SD2->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SA1->(DbSetOrder(1))
(PRE) SFP->(DbSetOrder(1))
(PRE) CTO->(DbSetOrder(1))

(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999999999.9999"
(PRE) _aTotal[004] := {"SD2",""}
(PRE) _aTotal[005] := SFP->FP_DOCFIS
(PRE) _aTotal[006] := Alltrim(SF2->F2_SERIE) + Alltrim(SF2->F2_DOC) + Alltrim(SF2->F2_ESPECIE)
(PRE) _aTotal[007] := SuperGetMV("MV_CFDIAMB",.F.,"1")
(PRE) _aTotal[008] := IIf(Alltrim(SF2->F2_ESPECIE)=="NDC",SF2->F2_VALBRUT,)
(PRE) _aTotal[009] := TamSX3("F2_DOC")[1]
//(PRE) _aTotal[010] := IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",M486BOLDAT(SD2->D2_NFORI, SD2->D2_SERIORI, SD2->D2_CLIENTE, SD2->D2_LOJA),)
(PRE) _aTotal[011] := DtoS(SF2->F2_EMISSAO)
(PRE) _aTotal[011] := Left(_aTotal[011],4) + "-" + Substr(_aTotal[011],5,2)+ "-" + Right(_aTotal[011],2)+ "T" + alltrim(SF2->F2_HORA) + iif(Len(alltrim(SF2->F2_HORA)) == 5, ":00.000", ".000" )
(PRE) _aTotal[012] := ""
(PRE) _aTotal[013] := alltrim(SA1->A1_EST) == "EX"
(PRE) _aTotal[014] := "1"
//(PRE) _aTotal[014] := alltrim(fGetSX5("XQ" + STR(SF2->F2_MOEDA,2)))
//(PRE) _aTotal[015] := fgetPais(ALLTRIM(SA1->A1_PAIS))  
(PRE) _aTotal[015] := "01"
(PRE) _aTotal[016] := SuperGetMV("MV_CUFD",.F.," ") 
//(PRE) _aTotal[017] := PADL(Alltrim(STR(SuperGetMV("MV_NUMSUC",.F.,1))), 4,"0")
(PRE) _aTotal[017] := "0"
(PRE) _aTotal[018] := SPACE(17) 
//(PRE) _aTotal[018] := STRTRAN(_aTotal[011],'-',"")
//(PRE) _aTotal[018] := STRTRAN(_aTotal[018],':',"")
//(PRE) _aTotal[018] := STRTRAN(_aTotal[018],'T',"")
//(PRE) _aTotal[018] := STRTRAN(_aTotal[018],'.',"")
(PRE) _aTotal[019] := PADL(Alltrim(SM0->M0_CGC), 13,"0") + _aTotal[018] + PADL(Alltrim(_aTotal[017]), 4,"0") + SuperGetMV("MV_SINMOD",,"") + SuperGetMV("MV_SINEMI",,"") + _aTotal[005] + PADL(alltrim(SF2->F2_TPDOC), 2, "0")    
(PRE) _aTotal[019] += PADL(ALLTRIM(substr(SF2->F2_DOC,(_aTotal[009]-7),8)), 8, "0") + iif(Empty(SFP->FP_PV),REPLICATE("0",4),PADL(SFP->FP_PV,4,"0"))       
(PREREG) FsQuery(_aTotal[004],1,"D2_DOC='" + SF2->F2_DOC + "' AND D2_SERIE='" + SF2->F2_SERIE + "' AND D2_CLIENTE='" + SF2->F2_CLIENTE + "' AND D2_LOJA='" + SF2->F2_LOJA + "'","SD2->D2_DOC=SF2->F2_DOC .AND. SD2->D2_SERIE=SF2->F2_SERIE .AND. SD2->D2_CLIENTE=SF2->F2_CLIENTE .AND. SD2->D2_LOJA=SF2->F2_LOJA","D2_ITEM") .And. .T.
(PREREG) _aTotal[010] := IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",M486BOLDAT(SD2->D2_NFORI, SD2->D2_SERIORI, SD2->D2_CLIENTE, SD2->D2_LOJA,'1'),)
(PREREG) _aTotal[020] := IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",M486BOLDAT(SD2->D2_NFORI, SD2->D2_SERIORI, SD2->D2_CLIENTE, SD2->D2_LOJA,'2'),)
(PREREG) _aTotal[022] := ObPrecioUn("SF2")
//(PRE) MSGALERT("PRUEBA " + SF2->F2_ESPECIE)
//(PRE) MSGALERT("PRUEBA " +  _aTotal[010][1])

[XXX ENCABEZADO]
(PREREG) (SFP->(DbSeek(xFilial("SFP")+Alltrim(SF2->F2_FILIAL)+Alltrim(M->F2_SERIE))),.T.)
(PREREG) (CTO->(MsSeek(xFilial("CTO")+Strzero(SF2->F2_MOEDA,2))),.T.)
(PREREG) (SA1->(MSSeek(xFilial("SA1")+SF2->F2_CLIENTE+SF2->F2_LOJA)),.T.)
(PREREG) (_aTotal[001] := '<?xml version="1.0" encoding="UTF-8"?>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '<facturaElectronicaEstandar xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="facturaElectronicaEstandar.xsd">','<notaFiscalElectronicaCreditoDebito xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="notaFiscalElectronicaCreditoDebito.xsd">')+ _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '  <cabecera>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <nitEmisor>' + Alltrim(SM0->M0_CGC) + '</nitEmisor>' + _aTotal[002],.T.)  
//(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'    <numeroFactura>' + ALLTRIM(substr(SF2->F2_DOC,(_aTotal[009]-7),8)) + '</numeroFactura>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF",'    <numeroFactura>' + ALLTRIM(str(Val(SF2->F2_DOC))) + '</numeroFactura>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <numeroNotaCreditoDebito>' + ALLTRIM(substr(SF2->F2_DOC,(_aTotal[009]-7),8)) + '</numeroNotaCreditoDebito>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += '    <cuf>' + _aTotal[019] +'</cuf>' + _aTotal[002],.T.)   
(PREREG) (_aTotal[001] += '    <cufd>'+ _aTotal[016] +'</cufd>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <codigoSucursal>'+  _aTotal[017] +'</codigoSucursal>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <direccion>'+ SA1->A1_END +'</direccion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '   <codigoPuntoVenta ' + iif(Empty(SFP->FP_PV) .OR. val(SFP->FP_PV) == 0 , 'xsi:nil="true"/>', '>' + SFP->FP_PV + '</codigoPuntoVenta>') + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <fechaEmision>' + _aTotal[011] + '</fechaEmision>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <nombreRazonSocial>' + Alltrim(SA1->A1_NOME) + '</nombreRazonSocial>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <codigoTipoDocumentoIdentidad>' + SA1->A1_TIPDOC + '</codigoTipoDocumentoIdentidad>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <numeroDocumento>' + Alltrim(SA1->A1_CGC) + '</numeroDocumento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <complemento xsi:nil="true"/>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoCliente>' + SF2->F2_CLIENTE+SF2->F2_LOJA + '</codigoCliente>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <numeroFactura>' +  ALLTRIM(substr(SD2->D2_NFORI,(_aTotal[009]-7),8)) + '</numeroFactura>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <numeroAutorizacionCuf>' +  ALLTRIM(_aTotal[010][1][1]) + '</numeroAutorizacionCuf>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <fechaEmisionFactura>' +  _aTotal[010][1][2] + '</fechaEmisionFactura>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <montoTotalOriginal>' + Alltrim(TRANSFORM(_aTotal[010][1][3], _aTotal[003])) + '</montoTotalOriginal>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <montoTotalDevuelto>' + Alltrim(TRANSFORM(SF2->F2_VALMERC, _aTotal[003])) + '</montoTotalDevuelto>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <montoEfectivoCreditoDebito>' + Alltrim(TRANSFORM(_aTotal[008], _aTotal[003])) + '</montoEfectivoCreditoDebito>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <codigoMetodoPago>'+ SF2->F2_MODCONS+'</codigoMetodoPago>' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <numeroTarjeta ' + iif(Empty(SF2->F2_IDRGS), 'xsi:nil="true"/>', '>' +  STUFF(SF2->F2_IDRGS,5,8,'00000000')+ '</numeroTarjeta>') + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <montoTotal>' + Alltrim(TRANSFORM(_aTotal[022][1][1], _aTotal[003])) + '</montoTotal>' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <montoDescuento ' + iif( _aTotal[022][1][3] == 0,'xsi:nil="true"/>', '>' + Alltrim(TRANSFORM(_aTotal[022][1][3], _aTotal[003])) + '</montoDescuento>') + _aTotal[002],''),.T.) 
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <codigoMoneda>' + Alltrim(CTO->CTO_MOESAT)  +'</codigoMoneda>' + _aTotal[002],''),.T.)   
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <tipoCambio>'+ iif(Alltrim(CTO->CTO_MOESAT) == "688","1", STR(SF2->F2_TXMOEDA)) +'</tipoCambio>' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <montoTotalMoneda>'+ Alltrim(TRANSFORM(_aTotal[022][1][2], _aTotal[003])) +'</montoTotalMoneda>' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += '    <leyenda>Ley Nro 453: Los servicios deben suministrarse en condiciones de inocuidad, calidad y seguridad.</leyenda>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '    <usuario>'+ Alltrim(SubStr(cUsuario,7,15)) +'</usuario>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <codigoDocumentoSector>' + alltrim(SF2->F2_TPDOC) + '</codigoDocumentoSector>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <codigoExcepcionDocumento  xsi:nil ="true" />' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += '  </cabecera>' + _aTotal[002],.T.)  
//(PRE)  MSGALERT("PRUEBA 02")

[SD2 INVOICE]
(PRE) DbGoTop()
(PREREG) _aTotal[023] := ObPrecioUn("SD2")
(PREREG) (SAH->(DbSeek(xFilial("SAH") + SD2->D2_UM)),.T.)
(PREREG) (SB1->(DbSeek(xFilial("SB1") + SD2->D2_COD)),.T.)
(PREREG) (_aTotal[001] += '  <detalle>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <actividadEconomica>' + Alltrim(SM0->M0_INSC) + '</actividadEconomica>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProductoSin>' + Alltrim(SB1->B1_PRODSAT) + '</codigoProductoSin>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <codigoProducto>' + Alltrim(SB1->B1_COD) + '</codigoProducto>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <descripcion>' + Alltrim(SB1->B1_DESC) + '</descripcion>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <cantidad>' + Alltrim(TRANSFORM(SD2->D2_QUANT,_aTotal[003])) + '</cantidad>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <unidadMedida>' + Alltrim(SAH->AH_COD_CO) + '</unidadMedida>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <precioUnitario>'+ Alltrim(TRANSFORM(_aTotal[023][1][1],_aTotal[003])) +'</precioUnitario>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <montoDescuento ' + iif(_aTotal[023][1][3] == 0,'xsi:nil="true"/>', '>' + Alltrim(TRANSFORM(_aTotal[023][1][3], _aTotal[003])) + '</montoDescuento>') + _aTotal[002],''),.T.) 
(PREREG) (_aTotal[001] += '    <subTotal>'+ Alltrim(TRANSFORM(_aTotal[023][1][2],_aTotal[003])) +'</subTotal>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <numeroSerie '+ iif(Empty(SD2->D2_NUMSERI), 'xsi:nil="true"/>', '>' +  alltrim(SD2->D2_NUMSERI) + '</numeroSerie>') + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '    <numeroImei  xsi:nil="true" />' + _aTotal[002],''),.T.)  
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NDC",'    <codigoDetalleTransaccion>2</codigoDetalleTransaccion>' + _aTotal[002],''),.T.)
(PREREG) (_aTotal[001] += '  </detalle>' + _aTotal[002],.T.)  
//(PRE) MSGALERT("PRUEBA 03")

[SD2 INVOICEORIGEN]
(PRE) (_aTotal[001] +=IIF(AllTrim(SF2->F2_ESPECIE)=="NDC", _aTotal[020][1][1]  + _aTotal[002],''),.T.) 
//(PRE) MSGALERT("PRUEBA 03"  + _aTotal[020][1][1])

[XXX INVOICE_FIN]
(PREREG) (_aTotal[001] += _aTotal[012],.T.)
(PREREG) (_aTotal[001] += IIF(AllTrim(SF2->F2_ESPECIE)=="NF", '</facturaElectronicaEstandar>','</notaFiscalElectronicaCreditoDebito>')  + _aTotal[002],.T.)   
(PREREG) ENCODEUTF8(_aTotal[001])

(POS) FsQuery(_aTotal[004],2)
[XXX FACTURA]
(PRE) _aTotal[094] := _aTotal[006] + ".XML"
(ARQ) _aTotal[094]
//(PRE) MSGALERT("PRUEBA 4")    
