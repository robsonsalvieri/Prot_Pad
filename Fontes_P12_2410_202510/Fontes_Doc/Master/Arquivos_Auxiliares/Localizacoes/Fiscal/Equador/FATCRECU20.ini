[XXX POSICIONAMENTOS]
(PRE) If(AllTrim(SF1->F1_ESPECIE) <> "NDI", SA2->(MSSeek(xFilial("SA2") + SF1->F1_FORNECE + SF1->F1_LOJA)) , .T.)

[XXX INICIALIZACION]
(PRE) SD1->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SYA->(DbSetOrder(1))
(PRE) SC6->(DbSetOrder(1))
(PRE) SE4->(DbSetOrder(1)) 
(PRE) CTO->(DbSetOrder(1)) 
(PRE) SAH->(DbSetOrder(1))

(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999.99"
(PRE) _aTotal[004] := {"SD1",""}
(PRE) _aTotal[005] := SuperGetMV("MV_CFDIAMB",.F.,"1")
(PRE) _aTotal[006] := TamSX3("F1_DOC")[1]
(PRE) _aTotal[007] := {"SFE",""}
(PRE) _aTotal[008] := SuperGetMV("MV_SIGNTCO",.F.,"")
(PRE) _aTotal[009] := {}

(PREREG) FsQuery(_aTotal[007],1,"FE_NROCERT='" + cCRet + "' AND FE_NFISCAL='" + SF1->F1_DOC + "' AND FE_SERIE='" + SF1->F1_SERIE + "' AND FE_FORNECE='" + SF1->F1_FORNECE + "' AND FE_LOJA='" + SF1->F1_LOJA + "'","SFE->FE_NROCERT=cCRet .AND. SFE->FE_NFISCAL=SF1->F1_DOC .AND. SFE->FE_SERIE=SF1->F1_SERIE .AND. SFE->FE_FORNECE=SF1->F1_FORNECE .AND. SFE->FE_LOJA=SF1->F1_LOJA","FE_NROCERT") .And. .T.

[XXX EMISOR]
(PREREG) (_aTotal[001] := '<?xml version="1.0" encoding="UTF-8" ?>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '<comprobanteRetencion id="comprobante" version="2.0.0">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <infoTributaria>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <ambiente>' + _aTotal[005] + '</ambiente>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <tipoEmision>' + "1" + '</tipoEmision>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <razonSocial>' + Alltrim(SM0->M0_NOMECOM) + '</razonSocial>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <ruc>' + Alltrim(SM0->M0_CGC) + '</ruc>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <codDoc>07</codDoc>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <estab>' + Substr(Alltrim(SM0->M0_DSCCNA),1,3) + '</estab>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <ptoEmi>' + Substr(Alltrim(SM0->M0_DSCCNA),4,3) + '</ptoEmi>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <secuencial>' + Alltrim(Substr(cCRet,(_aTotal[006]-8),9)) + '</secuencial>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <dirMatriz>' + Alltrim(SM0->M0_ENDENT) + " " + Alltrim(SM0->M0_COMPENT) + '</dirMatriz>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoTributaria>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[XXX RECEPTOR]
(PREREG) (_aTotal[001] := '    <infoCompRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <fechaEmision>' + cValtoChar( SF1->F1_EMISSAO ) + '</fechaEmision>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <dirEstablecimiento>' + Alltrim(SA2->A2_END) + '</dirEstablecimiento>' + _aTotal[002],.T.)
(PREREG) (IIf(!Empty(_aTotal[008]), _aTotal[001] += '        <contribuyenteEspecial>' + Alltrim(_aTotal[008]) + '</contribuyenteEspecial>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '        <obligadoContabilidad>SI</obligadoContabilidad >' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <tipoIdentificacionSujetoRetenido>' + Alltrim(SA2->A2_TIPDOC) + '</tipoIdentificacionSujetoRetenido >' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <parteRel>' + "NO" + '</parteRel>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <razonSocialSujetoRetenido>' + Alltrim(SA2->A2_NOME) + '</razonSocialSujetoRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <identificacionSujetoRetenido>' + Alltrim(SA2->A2_CGC) + '</identificacionSujetoRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <periodoFiscal>' + STRZERO(MONTH(SF1->F1_EMISSAO),2) + "/" + STRZERO(YEAR(SF1->F1_EMISSAO),4) + '</periodoFiscal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoCompRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <docsSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <docSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <codSustento>' + AllTrim(SF1->F1_CODCTR) + '</codSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <codDocSustento>' + AllTrim(SF1->F1_TIPOPE) + '</codDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <numDocSustento>' + AllTrim(SF1->F1_ESTABL) + Alltrim(SF1->F1_PTOEMIS) + IIf(Len(Alltrim(SF1->F1_DOC)) > 9, Alltrim(Substr(SF1->F1_DOC,(_aTotal[006]-8),9)), Alltrim(SF1->F1_DOC)) + '</numDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <fechaEmisionDocSustento>' + cValtoChar(SF1->F1_EMISSAO) + '</fechaEmisionDocSustento>' + _aTotal[002],.T.)
(PREREG) (IIf(!Empty(SF1->F1_DTLANC), _aTotal[001] += '            <fechaRegistroContable>' + cValtoChar(SF1->F1_DTLANC) + '</fechaRegistroContable>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '            <numAutDocSustento>' + AllTrim(SF1->F1_NUMAUT) + '</numAutDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <pagoLocExt>' + IIf(!Empty(SA2->A2_CONTRBE),SA2->A2_CONTRBE,"01") + '</pagoLocExt>' + _aTotal[002],.T.)
(PREREG) _aTotal[009] := FATXVALF3I("S029", "Codigo", SA2->A2_RETICA)
(PREREG) (IIf(SA2->A2_CONTRBE == "02", _aTotal[001] += '            <tipoRegi>' + Alltrim(SA2->A2_RETENED) + '</tipoRegi>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(SA2->A2_CONTRBE == "02", _aTotal[001] += '            <paisEfecPago>' + IIf(SA2->A2_RETENED == "01",SA2->A2_CODICA,IIf(Len(_aTotal[009])>=4,_aTotal[009][4],"")) + '</paisEfecPago>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(SA2->A2_CONTRBE == "02", _aTotal[001] += '            <aplicConvDobTrib>' + IIf(Alltrim(SA2->A2_ECDTEX)=="S","SI","NO") + '</aplicConvDobTrib>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(SA2->A2_CONTRBE == "02" .And. SA2->A2_ECDTEX == "N", _aTotal[001] += '            <pagExtSujRetNorLeg>' + IIf(Alltrim(SA2->A2_CBUCOM)=="S","SI","NO") + '</pagExtSujRetNorLeg>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(SA2->A2_CONTRBE == "02", _aTotal[001] += '            <pagoRegFis>SI</pagoRegFis>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '            <totalSinImpuestos>' + AllTrim(Str(SF1->F1_VALMERC,14,2)) + '</totalSinImpuestos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <importeTotal>' + AllTrim(Str(SF1->F1_VALBRUT,14,2)) + '</importeTotal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += M486XIMTOS(SF1->F1_FILIAL,SF1->F1_DOC,SF1->F1_SERIE,SF1->F1_FORNECE,SF1->F1_LOJA) + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <retenciones>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[SFE RETENCIONES]
(PRE) DbGoTop()
(PREREG) (_aTotal[001] := '                <retencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <codigo>' + IIf(SFE->FE_TIPO=='I',"2",IIf(SFE->FE_TIPO=='R',"1","6")) + '</codigo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <codigoRetencion>' + M486CODRET(SFE->FE_TIPO, SFE->FE_ALIQ) + '</codigoRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <baseImponible>' + Alltrim(TRANSFORM(SFE->FE_VALBASE,_aTotal[003])) + '</baseImponible>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <porcentajeRetener>' + Alltrim(TRANSFORM(SFE->FE_ALIQ,_aTotal[003])) + '</porcentajeRetener>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <valorRetenido>' + Alltrim(TRANSFORM(SFE->FE_RETENC,_aTotal[003])) + '</valorRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                </retencion>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[XXX RETENCION_FIN]
(PREREG) (_aTotal[001] := '            </retenciones>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <pagos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                <pago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <formaPago>' + AllTrim(SA2->A2_MPAGO) + '</formaPago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <total>' + AllTrim(Str(SF1->F1_VALBRUT,14,2)) + '</total>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                </pago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            </pagos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </docSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </docsSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <infoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <campoAdicional nombre="Email">' + Alltrim(SA2->A2_EMAIL) + '</campoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</comprobanteRetencion>',.T.)
(PREREG) _aTotal[001]

(POS) FsQuery(_aTotal[007],2)

[XXX FACTURA]
(PRE) _aTotal[094] := "RET" + Alltrim(SM0->M0_DSCCNA) + Alltrim(cCRet) + ".XML"

(ARQ) _aTotal[094]




