[XXX POSICIONAMENTOS]
(PRE) If(AllTrim(SF2->F2_ESPECIE) <> "NDI", SA1->(MSSeek(xFilial("SA1") + SF2->F2_CLIENTE + SF2->F2_LOJA)) , .T.)

[XXX INICIALIZACION]
(PRE) SD2->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SYA->(DbSetOrder(1))
(PRE) SC6->(DbSetOrder(1))
(PRE) SE4->(DbSetOrder(1)) 
(PRE) CTO->(DbSetOrder(1)) 
(PRE) SAH->(DbSetOrder(1))
(PRE) AI0->(DbSetOrder(1))

(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999.99"
(PRE) _aTotal[004] := {"SD2",""}
(PRE) _aTotal[005] := SuperGetMV("MV_CFDIAMB",.F.,"1")
(PRE) _aTotal[006] := TamSX3("F2_DOC")[1]
(PRE) _aTotal[007] := {"SFE",""}
(PRE) _aTotal[008] := SuperGetMV("MV_SIGNTCO",.F.,"")
(PRE) _aTotal[009] := {}
(PRE) _aTotal[010] := IIf(AI0->(ColumnPos("AI0_CONTRB")) > 0 .And. AI0->(ColumnPos("AI0_RETENE")) > 0 .And.  AI0->(ColumnPos("AI0_BCRESO")) > 0 .And.  AI0->(ColumnPos("AI0_APRREM")) > 0 .And.  AI0->(ColumnPos("AI0_TS")) > 0 ,.T.,.F.)
(PRE) _aTotal[011] := IIf(AI0->(ColumnPos("AI0_RETICA")) > 0 ,AllTrim(AI0->AI0_RETICA),"")

(PREREG) FsQuery(_aTotal[007],1,"FE_NROCERT='" + cCRet + "' AND FE_NFISCAL='" + SF2->F2_DOC + "' AND FE_SERIE='" + SF2->F2_SERIE + "' AND FE_CLIENTE='" + SF2->F2_CLIENTE + "' AND FE_LOJCLI='" + SF2->F2_LOJA + "'","SFE->FE_NROCERT=cCRet .AND. SFE->FE_NFISCAL=SF2->F2_DOC .AND. SFE->FE_SERIE=SF2->F2_SERIE .AND. SFE->FE_CLIENTE=SF2->F2_CLIENTE .AND. SFE->FE_LOJCLI=SF2->F2_LOJA","FE_NROCERT") .And. .T.

[XXX EMISOR]
(PREREG) (_aTotal[001] := '<?xml version="1.0" encoding="UTF-8" ?>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '<comprobanteRetencion id="comprobante" version="2.0.0">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <infoTributaria>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <ambiente>' + _aTotal[005] + '</ambiente>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <tipoEmision>' + "1" + '</tipoEmision>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <razonSocial>' + Alltrim(SM0->M0_NOMECOM) + '</razonSocial>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <ruc>' + Alltrim(SM0->M0_CGC) + '</ruc>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <codDoc>07</codDoc>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <estab>' + Substr(Alltrim(SM0->M0_DSCCNA),1,3) + '</estab>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <ptoEmi>' + Substr(Alltrim(SM0->M0_DSCCNA),4,3) + '</ptoEmi>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <secuencial>' + Alltrim(Substr(cCRet,(_aTotal[006]-8),9)) + '</secuencial>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <dirMatriz>' + Alltrim(SM0->M0_ENDENT) + " " + Alltrim(SM0->M0_COMPENT) + '</dirMatriz>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoTributaria>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[XXX RECEPTOR]
(PREREG) (_aTotal[001] := '    <infoCompRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <fechaEmision>' + cValtoChar( SF2->F2_EMISSAO ) + '</fechaEmision>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <dirEstablecimiento>' + Alltrim(SA1->A1_END) + '</dirEstablecimiento>' + _aTotal[002],.T.)
(PREREG) (IIf(!Empty(_aTotal[008]), _aTotal[001] += '        <contribuyenteEspecial>' + Alltrim(_aTotal[008]) + '</contribuyenteEspecial>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '        <obligadoContabilidad>SI</obligadoContabilidad >' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <tipoIdentificacionSujetoRetenido>' + Alltrim(SA1->A1_TIPDOC) + '</tipoIdentificacionSujetoRetenido >' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <parteRel>' + "SI" + '</parteRel>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <razonSocialSujetoRetenido>' + Alltrim(SA1->A1_NOME) + '</razonSocialSujetoRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <identificacionSujetoRetenido>' + Alltrim(SA1->A1_CGC) + '</identificacionSujetoRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <periodoFiscal>' + STRZERO(MONTH(SF2->F2_EMISSAO),2) + "/" + STRZERO(YEAR(SF2->F2_EMISSAO),4) + '</periodoFiscal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoCompRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <docsSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <docSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <codSustento>' + AllTrim(SF2->F2_CODCTR) + '</codSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <codDocSustento>' + AllTrim(SF2->F2_TIPOPE) + '</codDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <numDocSustento>' + AllTrim(SF2->F2_ESTABL) + Alltrim(SF2->F2_PTOEMIS) + IIf(Len(Alltrim(SF2->F2_DOC)) > 9, Alltrim(Substr(SF2->F2_DOC,(_aTotal[006]-8),9)), Alltrim(SF2->F2_DOC)) + '</numDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <fechaEmisionDocSustento>' + cValtoChar(SF2->F2_EMISSAO) + '</fechaEmisionDocSustento>' + _aTotal[002],.T.)
(PREREG) (IIf(!Empty(SF2->F2_DTLANC), _aTotal[001] += '            <fechaRegistroContable>' + cValtoChar(SF2->F2_DTLANC) + '</fechaRegistroContable>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '            <numAutDocSustento>' + AllTrim(SF2->F2_NUMAUT) + '</numAutDocSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <pagoLocExt>' + IIf(_aTotal[010] .And. !Empty(AI0->AI0_CONTRB),AI0->AI0_CONTRB,"01") + '</pagoLocExt>' + _aTotal[002],.T.)
(PREREG) _aTotal[009] := FATXVALF3I("S029", "Codigo", _aTotal[011])
(PREREG) (IIf(_aTotal[010] .And. AI0->AI0_CONTRB == "02", _aTotal[001] += '            <tipoRegi>' + Alltrim(AI0->AI0_RETENE) + '</tipoRegi>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(_aTotal[010] .And. AI0->AI0_CONTRB == "02", _aTotal[001] += '            <paisEfecPago>' + IIf(AI0->AI0_RETENE == "01",AI0->AI0_BCRESO,IIf(Len(_aTotal[009])>=4,_aTotal[009][4],"")) + '</paisEfecPago>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(_aTotal[010] .And. AI0->AI0_CONTRB == "02", _aTotal[001] += '            <aplicConvDobTrib>' + IIf(AI0->AI0_APRREM=="S","SI","NO") + '</aplicConvDobTrib>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(_aTotal[010] .And. AI0->AI0_CONTRB == "02" .And. AI0->AI0_APRREM == "N", _aTotal[001] += '            <pagExtSujRetNorLeg>' + IIf(AI0->AI0_TS=="S","SI","NO") + '</pagExtSujRetNorLeg>' + _aTotal[002], ""),.T.)
(PREREG) (IIf(_aTotal[010] .And. AI0->AI0_CONTRB == "02", _aTotal[001] += '            <pagoRegFis>SI</pagoRegFis>' + _aTotal[002], ""),.T.)

[XXX TOTALES_DOC]
(PREREG) (_aTotal[001] += M486REEMB(SF2->F2_DOC,SF2->F2_SERIE,SF2->F2_CLIENTE,SF2->F2_LOJA,SF2->F2_ESPECIE,.F.),.T.)																											 
(PREREG) (_aTotal[001] += '            <totalSinImpuestos>' + AllTrim(Str(SF2->F2_VALMERC,14,2)) + '</totalSinImpuestos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <importeTotal>' + AllTrim(Str(SF2->F2_VALBRUT,14,2)) + '</importeTotal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += M486XIMTOS(SF2->F2_FILIAL,SF2->F2_DOC,SF2->F2_SERIE,SF2->F2_CLIENTE,SF2->F2_LOJA, .T.) + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            <retenciones>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[SFE RETENCIONES]
(PRE) DbGoTop()
(PREREG) (_aTotal[001] := '                <retencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <codigo>' + IIf(SFE->FE_TIPO=='I',"2",IIf(SFE->FE_TIPO=='R',"1","6")) + '</codigo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <codigoRetencion>' + M486CODRET(SFE->FE_TIPO, SFE->FE_ALIQ) + '</codigoRetencion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <baseImponible>' + Alltrim(TRANSFORM(SFE->FE_VALBASE,_aTotal[003])) + '</baseImponible>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <porcentajeRetener>' + Alltrim(TRANSFORM(SFE->FE_ALIQ,_aTotal[003])) + '</porcentajeRetener>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <valorRetenido>' + Alltrim(TRANSFORM(SFE->FE_RETENC,_aTotal[003])) + '</valorRetenido>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                </retencion>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[XXX RETENCION_FIN]
(PREREG) (_aTotal[001] := '            </retenciones>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += M486REEMB(SF2->F2_DOC,SF2->F2_SERIE,SF2->F2_CLIENTE,SF2->F2_LOJA,SF2->F2_ESPECIE,.T.),.T.)
(PREREG) (_aTotal[001] += '            <pagos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                <pago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <formaPago>' + AllTrim(AI0->AI0_MPAGO) + '</formaPago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                    <total>' + AllTrim(Str(SF2->F2_VALBRUT,14,2)) + '</total>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '                </pago>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '            </pagos>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </docSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </docsSustento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <infoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <campoAdicional nombre="EMAIL">' + Alltrim(SA1->A1_EMAIL) + '</campoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </infoAdicional>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</comprobanteRetencion>',.T.)
(PREREG) _aTotal[001]

(POS) FsQuery(_aTotal[007],2)

[XXX FACTURA]
(PRE) _aTotal[094] := "RET" + Alltrim(SM0->M0_DSCCNA) + Alltrim(cCRet) + ".XML"

(ARQ) _aTotal[094]




