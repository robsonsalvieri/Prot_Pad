?{"Nome do Arquivo INI","DMSSALCC.INI"}
?{"Descicao Completa do Arquivo Magnético","Declaração Mensal de Serviços de Construção Civil e Reforma do município de Salvador."}
?{"A Quem se Destina","Substitutos tributários, Prestadores de Serviços, Prestadores de Serviço sob Regime Especial, Prestadores de Serviço que escrituram e confeccionam LRISS através de Regime Especial, Estabelecimentos não sujeitos à tributação de ISS, Contribuintes de ISS, Contribuintes não sujeitos à tributação de ISS, Prestadores de Serviço para Construção Civil e Reforma."}
?{"Objetivo","Registrar e enviar mensalmente para a Secretaria Municipal da Fazenda de Salvador informações economicas e fiscais, decorrentes de serviços prestados."}
?{"Prazo de Entrega","Ate o dia 05 do mês seguinte ao mês de competência da declaração."}
?{"Aplicativo Disponibilizado pelo Fisco","DMS"}
?{"Versão do Aplicativo Contemplada pela Microsiga","7.12.0"}
?{"Comentarios","Para maiores detalhes sobre quem deve utilizar o DMS, consulte o site da Secretaria Municipal da Fazenda de Salvador. http://www.sefaz.salvador.ba.gov.br/sistema/dms/dms_download.asp"}
[XXX Inicializacao] 
(PRE) _atotal[001] := MV_PAR01
(PRE) _atotal[002] := MV_PAR02
(PRE) _atotal[003] := MV_PAR03
(PRE) _atotal[004] := MV_PAR04
(PRE) _atotal[005] := MV_PAR05
(PRE) _aTotal[006] := ""
(PRE) _aTotal[007] := {"SF3", ""}
(PRE) _aTotal[008] := 0
(PRE) _aTotal[009] := ""
(PRE) _aTotal[010] := ""
(PRE) _aTotal[011] := ""
(PRE) _aTotal[012] := ""
(PRE) _aTotal[013] := 0
(PRE) _aTotal[014] := GetNewPar ("MV_F3RECIS", .F.)
(PRE) _aTotal[080] := {"CE2", ""}  
(PRE) _aTotal[081] :=0
(PRE) lAbtMt950 := !Pergunte ("DMSSCC", .T.)   
(PRE) DMSSAL(_atotal[001],_atotal[002],MV_PAR02,MV_PAR03, "DMSSALCC") 

[SF3 Registro Tipo L - Tabela de documentos fiscais emitidos.]
(PRE) SF3->(DbSetOrder (1))
(PRE) SA1->(DbSetOrder (1))
(PRE) SA2->(DbSetOrder(1))
(PRE) FsQuery (_aTotal[007], 1, "F3_FILIAL='"+xFilial("SF3")+"' AND F3_EMISSAO>='"+DTOS (_aTotal[001])+"' AND F3_EMISSAO<='"+DTOS (_aTotal[002])+"' AND (SUBSTRING(F3_CFO,1,1)>='5' OR (SUBSTRING(F3_CFO,1,1)<'5' AND F3_FORMUL='S')) AND F3_TIPO='S' ", "F3_FILIAL=='"+xFilial ("SF3")+"' .And. DTOS (F3_EMISSAO)>='"+DTOS (_aTotal[001])+"' .And. DTOS (F3_EMISSAO)<='"+DTOS (_aTotal[002])+"' .AND. (SubStr(F3_CFO,1,1)>='5' .Or. (SubStr(F3_CFO,1,1)<'5' .And. F3_FORMUL=='S')) .And. F3_TIPO=='S' ",SF3->(IndexKey ()))
(PRE) SF3->(DbGotop())
(PRE) _aTotal[009] := ""
(PRE) _aTotal[010] := ""
(PRE) _aTotal[011] := ""
(PRE) _aTotal[012] := ""     
(PRE) _aTotal[015] := GetNewPar ("MV_SIMPLES","")
(PREREG) Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. !SF3->F3_TIPO$"DB"), SA2->(DbSeek(xFilial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA)),.T.)
(PREREG) Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. !SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. SF3->F3_TIPO$"DB"), SA1->(DbSeek(xFilial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA)),.T.)
(PREREG) Iif(AllTrim(MV_PAR02)$"CC" .And. AllTrim(MV_PAR03)$"CS",Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. !SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. SF3->F3_TIPO$"DB"),AllTrim(SA1->A1_MUN)=="SALVADOR",AllTrim(SA2->A2_MUN)=="SALVADOR"),Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. !SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. SF3->F3_TIPO$"DB"),AllTrim(SA1->A1_MUN)<>"SALVADOR",AllTrim(SA2->A2_MUN)<>"SALVADOR"))
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Quando o tomador do servico reter o ISS, deverah ser apresentado no software como ISS RETIDO(_RECISS==S ou 1).   ³
//³Quando o prestador de servico reter o ISS, deverah ser apresentado no software como ISS PROPRIO(_RECISS==N ou 2).³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

(PREREG) (_aTotal[009] := Iif(_aTotal[014],Iif(SF3->F3_RECISS$"S,1","R",""),""),.T.)
(PREREG) (_aTotal[009] := Iif(Empty(_aTotal[009]),Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. !SF3->F3_TIPO$"DB"),Iif("S,1"$SA2->A2_RECISS,"R",""),Iif("S,1"$SA1->A1_RECISS,"R","")),""),.T.)
(PREREG) (_aTotal[009] := Iif(!Empty(_aTotal[009]),Iif(!Empty(SF3->F3_DTCANC),"C",_aTotal[009]),Iif(!Empty(SF3->F3_DTCANC),"C","")), .T.)
(PREREG) (_aTotal[009] := Iif(!Empty(_aTotal[009]),_aTotal[009],Iif(SF3->F3_ISENICM<>0,"I","")), .T.) 
(PREREG) (_aTotal[009] := Iif(!Empty(_aTotal[009]),_aTotal[009],Iif(_aTotal[015]=="S","L","P")), .T.)
(PREREG) (_aTotal[010] := Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. !SF3->F3_TIPO$"DB"), SA2->A2_CGC, SA1->A1_CGC), .T.)
(PREREG) (_aTotal[011] := Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. !SF3->F3_TIPO$"DB"), SA2->A2_TIPO, SA1->A1_PESSOA), .T.)
(PREREG) (_aTotal[012] := Iif((SubStr(SF3->F3_CFO,1,1)>="5" .And. SF3->F3_TIPO$"DB") .Or. (SubStr(SF3->F3_CFO,1,1)< "5" .And. !SF3->F3_TIPO$"DB"), SA2->A2_ATIVIDA, SA1->A1_ATIVIDA), .T.)
(PREREG) _aTotal[008]++
TIPOREG    C 001 0 "L"
CODTABELA  N 002 0 01
EMISSAO    C 010 0 StrZero (Day (SF3->F3_EMISSAO), 2)+"/"+StrZero (Month (SF3->F3_EMISSAO), 2)+"/"+StrZero (Year (SF3->F3_EMISSAO), 4)
SERIE      C 005 0 Iif(!Empty(F3_NFELETR) .AND. "1"$ SerieNfId("SF3",2,"F3_SERIE"),"A", SerieNfId("SF3",2,"F3_SERIE") )
SUBSERIE   C 005 0 Space (05)
NUMERONF   C 010 0 Replicate("0",10-len(AllTrim (SF3->F3_NFISCAL)))+SF3->F3_NFISCAL
TIPONF     C 002 0 IIF(!Empty(SF3->F3_NFELETR),"12","01")
SITUACAO   C 001 0 _aTotal[009]
VALOR      N 015 0 SF3->F3_VALCONT*100
VALORISS   N 015 0 SF3->F3_VALICM*100
CNAE       N 007 0 Val (Left (AllTrim (_aTotal[012]), 7))
MOTIVO     C 009 0 IIF(!Empty(SF3->F3_DTCANC).OR."CANCEL"$SF3->F3_OBSERV,"000000008","")
DATANFSUBS C 010 0 Space (010)
SERIESUBS  C 005 0 Space (005)
SUBSERSUBS C 005 0 Space (005)
NFSUBST    N 010 0 0
TPNFSUBST  C 002 0 Space (002)
NUMOCORR   C 010 0 Space (010)
DTPUBLIC   C 010 0 Space (010)
OUTMOTIVO  C 100 0 IIF(!Empty(SF3->F3_DTCANC).OR."CANCEL"$SF3->F3_OBSERV,SF3->F3_OBSERV,"")
(POS) FsQuery (_aTotal[007], 2)                                       

[XXX Registro Tipo H - Header tabela de documentos fisciais emitidos (Registro Tipo L).] 
(PREREG) ABC->(RecCount())>0           
TIPOREG    C 001 0 "H"
CODTABELA  N 002 0 02
QTDREG     N 005 0 ABC->(RecCount())

[ABC Registro Tipo L]  
TIPOREG    C 001 0 "L"
CODTABELA  N 002 0 02
EMISSAO	   C 010 0 ABC->EMISSAO
SERIE      C 005 0 ABC->SERIE  
SUBSERIE   C 005 0 ABC->SUBSERIE
NUMERONF   C 010 0 ABC->NUMERONF
VALOR      N 015 0 ABC->VALOR
CNPJ       C 014 0 ABC->CNPJ
SITUAC     C 001 0 ABC->SITUAC  

[XXX Registro Tipo H - Header tabela de documentos fisciais emitidos (Registro Tipo L).]    
(PREREG) RET->(RecCount())>0  
TIPOREG    C 001 0 "H"
CODTABELA  N 002 0 03
QTDREG     N 005 0 RET->(RecCount())
                                     
[RET Registro Tipo L - Documentos Fiscais recebidos na Contratacao de subempreitadas para o servico.]                                                                                                                                                                                                                                                                                                                                                      
TIPOREG    C 001 0 "L"
CODTABELA  N 002 0 03 
EMISSAO    C 010 0 RET->EMISSAO
SERIE      C 005 0 RET->SERIE
SUBSERIE   C 005 0 RET->SUBSERIE
NUMERONF   C 010 0 RET->NUMERONF
TIPONF     C 002 0 RET->TIPONF 
VALOR      C 015 0 STRZERO(RET->VALOR,15)
ISSRETIDO  C 001 0 RET->ISSRETIDO
ALIQISS    N 004 0 RET->ALIQISS
VALORISS   N 015 0 RET->VALORISS
CNPJ       C 015 0 RET->CNPJ
MUNIC      C 003 0 RET->MUNIC
DATARET    C 010 0 RET->DATARET
SIMPLES    C 001 0 RET->SIMPLES 

[XXX Registro tipo I - Informacoes gerais do arquivo.]
(ORD) TOP
TIPOARQ    C 001 0 "I"
TIPOREG    C 001 0 "N"
COMPET     C 006 0 StrZero (Month (_aTotal[001]), 2)+StrZero (Year (_aTotal[001]), 4)
CORPOCNPJ  C 008 0 SubStr (AllTrim (SM0->M0_CGC), 01, 08)
FILIALCNPJ C 004 0 SubStr (AllTrim (SM0->M0_CGC), 09, 04)
DIGITOCNPJ C 002 0 SubStr (AllTrim (SM0->M0_CGC), 13, 02)
CORPOCGA   C 006 0 SubStr (AllTrim (MV_PAR01), 01, 06)
FILIALCGA  C 003 0 SubStr (AllTrim (MV_PAR01), 07, 03)
DIGITOCGA  C 002 0 SubStr (AllTrim (MV_PAR01), 10, 02)
TPSERVICO  C 002 0 AllTrim (MV_PAR02)
SUBSERVICO C 002 0 AllTrim (MV_PAR03)
(POS) _aTotal[013]++

[XXX Registro Tipo H - Header tabela de documentos fisciais emitidos (Registro Tipo L).]
(ORD) TOP
(PREREG) _aTotal[008]>0
TIPOREG    C 001 0 "H"
CODTABELA  N 002 0 01
QTDREG     N 005 0 _aTotal[008]
(POS) _aTotal[013] += _aTotal[008]+Iif (_aTotal[008]==0, 0, 1)

[XXX Registro Tipo F - Registro de fim do arquivo.]
TIPOREG    C 001 0 "F"
QTDLINARQ  N 005 0 _aTotal[013]+1
(POS)
