<?xml version="1.0" encoding="ISO-8859-1" ?>
<EASYLINK>
    <SERVICE>
        <ID>002</ID>
        <XMLEX>cNomFile</XMLEX>
        <INSERT_FIELDS Activated = "Y"/>
        <DATA_SELECTION>
            <CMD_00>DbSelectArea("EYM")</CMD_00>
            <CMD_01>EYM->(RecLock("EYM", .F.))</CMD_01>
            <EYM_STATUS ISFIELD = "'S'">"D"</EYM_STATUS>
            <!--Identificação do Documento XML -->
            <EYM_ID_DOC ISFIELD = '"S"'>#TAGEX Message\Header\DocumentIdentifier#</EYM_ID_DOC>
            <REF_NUM>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation:ReferenceType#</REF_NUM>
            <FOR_01
                REPL = '"1"'
                INI = "1"
                TO = "Len(#TAG REF_NUM#)"
                VAR = "'nInc'"
                STEP = "1">
                <IF_01 COND = '#TAG REF_NUM#[nInc] == "ShipperIdentifyingNumber"'>
                    <!--<EYM_PROC ISFIELD = '"S"'>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation#[nInc]</EYM_PROC> -->
                    <EYM_PROC ISFIELD = '"S"'>#TAGEX Message\MessageBody\MessageProperties\ShipmentID\Shipmentidentifier#</EYM_PROC>
                </IF_01>
                <IF_02 COND = '#TAG REF_NUM#[nInc] == "INTTRABookingNumber"'>
                    <EYM_BKINTT ISFIELD = '"S"'>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation#[nInc]</EYM_BKINTT>
                </IF_02>
                <IF_03 COND = '#TAG REF_NUM#[nInc] == "BookingNumber"'>
                    <EYM_BOOK ISFIELD = '"S"'>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation#[nInc]</EYM_BOOK>
                </IF_03>
            </FOR_01>
            <!--Status do Retorno -->
            <EYM_ST_MES ISFIELD = '"S"'>AllTrim(#TAGEX Message\MessageBody\MessageProperties\ShipmentID\Shipmentidentifier:MessageStatus#)</EYM_ST_MES>
            <EYM_DATABK ISFIELD = '"S"'>dDataBase</EYM_DATABK>
            <EYM_HORABK ISFIELD = '"S"'>Time()</EYM_HORABK>
            <ALIAS_02>"EEC"</ALIAS_02>
            <ORDER_02>1</ORDER_02>
            <SEEK_02>xFilial("EEC")+AvKey(#TAGEX Message\MessageBody\MessageProperties\ShipmentID\Shipmentidentifier#, "EEC_PREEMB")</SEEK_02>
            <IF_01 COND = "EEC->(!Eof() .And. Alltrim(EYM->EYM_ST_MES) != 'Rejected')">
                <CMD_01>DbSelectArea("EEC")</CMD_01>
                <CMD_02>EEC->(RecLock("EEC", .F.))</CMD_02>
                <!--Copia os campos da base para as variaveis de memoria criadas antes da chamada do servico, para comparacao das alteracoes -->
                <CMD_03>FRM104RToM("EEC")</CMD_03>
                <!--Data de Geração do Booking -->
                <EEC_DTFCPR ISFIELD = '"S"'>SToD(Left(#TAGEX Message\MessageBody\MessageProperties\DateTime#, 8))</EEC_DTFCPR>
                <!--Tipo da Localidade -->
                <TIPO_LOC>#TAGEX Message\MessageBody\MessageProperties\TransportationDetails\Location:LocationType#</TIPO_LOC>
                <!--Tipo do código da Localidade -->
                <TIPO_COD_LOC>#TAGEX Message\MessageBody\MessageProperties\TransportationDetails\Location\LocationCode:Agency#</TIPO_COD_LOC>
                <!--Código da Localidade -->
                <COD_LOC>#TAGEX Message\MessageBody\MessageProperties\TransportationDetails\Location\LocationCode#</COD_LOC>
                <!--Tipo de Movimento -->
                <TIPO_MOV>#TAGEX Message\MessageBody\MessageProperties\HaulageDetails:MovementType#</TIPO_MOV>
                <ALIAS_03>"EXL"</ALIAS_03>
                <ORDER_03>1</ORDER_03>
                <SEEK_03>xFilial("EXL")+EEC->EEC_PREEMB</SEEK_03>
                <IF_01 COND = "EXL->(!Eof())">
                    <CMD_00>DbSelectArea("EXL")</CMD_00>
                    <CMD_01>EXL->(RecLock("EXL",.F.))</CMD_01>
                    <!--Copia os campos da base para as variaveis de memoria criadas antes da chamada do servico, para comparacao das alteracoes -->
                    <CMD_02>FRM104RToM("EXL")</CMD_02>
                    <!--Atualiza a via de transporte -->
                    <CMD_03>FRM102AtuVia(#TAG TIPO_LOC#, #TAG TIPO_COD_LOC#, #TAG COD_LOC#, #TAG TIPO_MOV#)</CMD_03>
                    <FOR_02
                        REPL = '"1"'
                        INI = "1"
                        TO = "Len(#TAG REF_NUM#)"
                        VAR = "'nInc'"
                        STEP = "1">
                        <IF_01 COND = '#TAG REF_NUM#[nInc] == "INTTRABookingNumber"'>
                            <!--Número de Referencia do Booking no Inttra -->
                            <EXL_BKRFIN>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation#[nInc]</EXL_BKRFIN>
                        </IF_01>
                        <IF_02 COND = '#TAG REF_NUM#[nInc] == "BookingNumber"'>
                            <!--Número do Referencia do Booking no Armador (Reserva de Praça) -->
                            <EXL_BOOK>#TAGEX Message\MessageBody\MessageProperties\ReferenceInformation#[nInc]</EXL_BOOK>
                        </IF_02>
                    </FOR_02>
                    <!--Tipos de Datas Relacionadas à Localidade -->
                    <TIPO_DATA_LOC>#TAGEX Message\MessageBody\MessageProperties\TransportationDetails\Location:LocationType#</TIPO_DATA_LOC>
                    <!--Datas Relacionadas à Localidade -->
                    <DATA_LOC>#TAGEX Message\MessageBody\MessageProperties\TransportationDetails\Location\DateTime#</DATA_LOC>
                    <CMD_04>Frm102AtuDatas(#TAG TIPO_DATA_LOC#, #TAG DATA_LOC#, #TAGEX Message\MessageBody\MessageProperties\TransportationDetails\ConveyanceInformation\ConveyanceName#, #TAGEX Message\MessageBody\MessageProperties\TransportationDetails\ConveyanceInformation\VoyageTripNumber#)</CMD_04>
                    <CMD_05>EXL->(MsUnlock())</CMD_05>
                    <!--Comentários Referentes ao Booking -->
                    <CMD_06>Frm102AtuBkCom(#TAGEX Message\MessageBody\MessageProperties\Instructions\ShipmentComments#)</CMD_06>
                </IF_01>
            </IF_01>
            <!--Destrava os arquivos -->
            <CMD_02>EYM->(MsUnlock())</CMD_02>
            <CMD_03>EEC->(MsUnlock())</CMD_03>
        </DATA_SELECTION>
        <DATA_SEND>
            <SEND>''</SEND>
        </DATA_SEND>
        <DATA_RECEIVE>
            <SRV_STATUS>.T.</SRV_STATUS>
        </DATA_RECEIVE>
    </SERVICE>
</EASYLINK>
