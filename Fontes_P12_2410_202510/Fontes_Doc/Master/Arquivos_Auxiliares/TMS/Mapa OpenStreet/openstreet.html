<!DOCTYPE html>
<html>
<head>
	
	<title>SIGATMS OPENSTREET MAP</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>


	
</head>

<body>
<script src="tprchannel.js"></script>
<div id="mapid" style="width: 1890px; height: 650px;"></div>
	<script>
		
		onload = function () { 
			loadEngine();
		}
		
		function loadEngine() {
			conectTotvsTec();
		}

		function conectTotvsTec( ) {
			//Conecta WebSocket Server
			twebchannel.connectWS(function () {
				// Carrega mensageria exclusiva da pagina
				dialog.advplToJs.connect(function (codeType, codeContent) {
					
					if (codeType == "initData") {
						setOrigemDestino(codeContent);
					}
					if (codeType == "tolls") {
						setPedagios(codeContent);
					}
					if (codeType == "changeRow") {
						changeRowPedidos(codeContent);
					}
					if (codeType == "initMap"){
						initMap( codeContent );
					}
					if (codeType == "TPRsetToken"){
						TPRsetToken( codeContent );
					}

				});

				// Envia sinal informando termino da carga da pagina
				dialog.jsToAdvpl("pageStarted", "Pagina inicializada");

			});

		}


		function sendMessage(msg) {
			// Make sure you are sending a string, and to stringify JSON
			dialog.jsToAdvpl(msg.type, JSON.stringify(msg.data));
		}
			
		function initMap( cjson ) {
			var mymap;
			//var mymap;
			const ojson = JSON.parse(cjson);
			
			mymap = L.map('mapid').setView( [ ojson[0].latitude , ojson[0].longitude ] , 14 );
			
			L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom:30,
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1
			}).addTo(mymap);
			
			//for ( [expressão inicial]; [expressão condicional]; [atualização da expressão inicial] ) {
			for ( let i = 1; i < ojson.length; i++ ){
			// um ou vários comandos a serem executados //
				L.marker( [ ojson[i].latitude , ojson[i].longitude ]  ).addTo( mymap )
				.bindPopup(ojson[i].Document).closePopup();
			}
			
		
		}		

	</script>


</body>
</html>