<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>exemplo</title>
	<style>
        .botaoCentralizar {
            border: 1px solid #219ebc;
            padding: 3px;
            border-radius: 5px;
            margin-bottom: 5px;
            color: #fff;
            background-color: #219ebc;
			display: none;
        }
        .botaoCentralizar:hover{
            cursor: pointer;
            border: 1px solid #219ebc;
            color: #219ebc;
            background-color: #fff;
        }
    </style>

</head>
<body>
	<button class="botaoCentralizar" id="centerOnRoutes"  name="center" onclick="centralizar()">
        Centralizar nas rotas
    </button>
    <div id="map" style="width: 100%; height: 88vh"></div>
	<!-- <script src="https://planejamentorotasqa.totvs.com/tpr-client/v1"></script> QA --> 
	<script src="https://planejamentorotas.totvs.com/tpr-client/v1"></script> <!-- Producao -->
	<script src="tprchannel.js"></script>
    <script>
		var tpr = new tprClient.TPR();
		var lStarted = false;
		var tprMap = null;
		var newRouteURL = null;
		var identifier = null;
		
		onload = function () { loadEngine(); }
		
		function loadEngine() {
			conectTotvsTec();
		}

		function conectTotvsTec( ) {
			//Conecta WebSocket Server
			twebchannel.connect(function () {
				// Carrega mensageria exclusiva da pagina
				twebchannel.advplToJs = function(codeType, codeContent) {
					
					if (codeType == "initData") {
						setOrigemDestino(codeContent);
					}
					if (codeType == "tolls") {
						setPedagios(codeContent);
					}
					if (codeType == "changeRow") {
						changeRowPedidos(codeContent);
					}
					if (codeType == "initMap"){
						document.querySelector("#centerOnRoutes").style.display='block';
						initMap(tpr, codeContent );

					}
					if (codeType == "TPRsetToken"){
						TPRsetToken( codeContent );
					}
					
					if (codeType == "TMSAO15"){
						TPRTMSAO15(tpr, codeContent );
					}

					if (codeType == "newRouteURL"){
						newRouteURL = codeContent;
					}
					if (codeType == "identifier"){
						identifier = codeContent;
					}					
				};

				// Envia sinal informando termino da carga da pagina
				twebchannel.jsToAdvpl("pageStarted", "Pagina inicializada");

			});

		}


		function sendMessage(msg) {
			// Make sure you are sending a string, and to stringify JSON
			twebchannel.jsToAdvpl(msg.type, JSON.stringify(msg.data));
		}
	
	function TPRsetToken( ctoken ){
		tprtoken	= ctoken;
	}
	
	function initMap(tpr, cjson ){
    
		console.log("URL para atualizacao da rota");
		console.log(newRouteURL);
		console.log("Identificador para atualizacao da rota");
		console.log(identifier);
		
		const ojson = JSON.parse(cjson);
	  
      tpr.get(tprtoken, {
        system: "1.0.0",
        version: "abc",
        qualifiers: "",
		callbackURL: newRouteURL
		})
		.then(service => {
			return service.createMap(document.querySelector("#map"));
		}).then((map) => {
		tprMap = map;
		for (var i = 0; i < ojson.length ; i++) {
			console.log("Objeto json para o mapa");
			console.log(ojson[i]);
			console.log("String json para o mapa");
			console.log(JSON.stringify(ojson[i]));
			
			tprMap.viewRoute(new tprClient.TPRRoute( ojson[i],identifier ) , new tprClient.TPRRouteOptions(true));
		}
		setTimeout(function() {
  			tprMap.centerRoutes();
		}, 1500)
		dialog.jsToAdvpl("initMap", "Tela Montada");
		
        return;
      }).then((tprMapRoutes) => {
		
      });
	 }
	 
	 function TPRTMSAO15(tpr, codeContent){
				
		var data = JSON.parse(codeContent);
		console.log(data)
		var lat = "";
		var long = "";

		lat = parseFloat(data.latitude)
		long = parseFloat(data.longitude) 

		if (lStarted == false  ){
			lStarted = true;
			tpr = new tprClient.TPR();
			tpr.get(tprtoken, {
				system: "1.0.0",
				version: "abc",
				qualifiers: ""
			})
			.then(service => {
				return service.createMap(document.querySelector("#map"));
			}).then((map) => {
				tprMap = map;
				if(!isNaN(lat)  && !isNaN(long)){
					addMarcador(tprMap, lat, long)
				}
				return;
			}).then((tprMapRoutes) => {	});
		}else{
			tprMap.clear()
			if(!isNaN(lat)  && !isNaN(long)){
				addMarcador(tprMap, lat, long)
			}
		}
	}

	function onDragPrint(lat, long) {
		var coord = {"latitude":long,"longitude":lat}
		dialog.jsToAdvpl("updCoord", JSON.stringify(coord));
	}
	
	function addMarcador(tprMap, lat, long){
		const point = { latitude: lat, longitude: long };
		tprMap.addMarker(point, { color: "red", draggable: true , onDrag: (lat, long) => onDragPrint(lat, long)});
	}
	function centralizar(){
		tprMap.centerRoutes();
	}

	</script>
</body>
</html>
