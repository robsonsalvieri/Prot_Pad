<!DOCTYPE html>

<html>

	<Head>

		<style>
			body {width: 100%; 
			      height: 100%; 
			      position: absolute; 
			      margin: 0px; 
			      padding: 0px; 
			      overflow: hidden;
			} 

			#map {position:absolute; 
			      top:0; 
			      bottom:0; 
			      width:100%; 
			      height: 100%;
			}

			table {border-collapse: collapse;}
			th, td {border: solid 1px; padding: 0; font-size: 10px}
			td:first-child {width: 110px}
			td:first-child + td {width: 130px}
			td:first-child + td + td {width: 080px}
			td:first-child + td + td + td {width: 100px}
			td:first-child + td + td + td + td {width: 100px}
			td:first-child + td + td + td + td + td {width: 100px}
			td:first-child + td + td + td + td + td + td {width: 100px}
			td:first-child + td + td + td + td + td + td + td {width: 140px}
			td:first-child + td + td + td + td + td + td + td + td {width: 140px}
			td:first-child + td + td + td + td + td + td + td + td + td {width: 140px}
			td:first-child + td + td + td + td + td + td + td + td + td + td {width: 160px}

		</style>

		<script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript"></script>
		<script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript"></script>
		<script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript"></script>
		<script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

	</Head>

<body>
	<script src="twebchannel.js"></script>
	<div id='map'></div>

	<script>

		// Executa a chamada do Protheus
		window.onload = function(){
			mastervariaveis()
		}

		function mastervariaveis(){
			var oJson
			var map
			var ui
			ConectTotvsTec();
			//semconexao();

		}

		function ConectTotvsTec() {
			// Fecha conexao entre o AdvPL e o JavaScript via WebSocket
			twebchannel.connect( () => { console.log('Websocket Connected!'); } );
			twebchannel.advplToJs = function(key, value) {

			// ----------------------------------------------------------
			// Insira aqui o tratamento para as mensagens vindas do AdvPL
			// ----------------------------------------------------------
			if (key === "initMap") {
				Prepara_Json(value);
				}
			};

		// Envia sinal informando termino da carga da pagina
		twebchannel.jsToAdvpl("pageStarted","Pagina inicializada");

		}


		function semconexao() {
			cJson = '{"Prog":[{"LatitFil":-23.70794,"LongitFil":-46.59565,"FilOri":"M SP 01 ","NumProg":"000001","Roteiro":"","ParRoteiro":"","RotWayPoints":"","LinRota":"","LatOrigem":-23.70794,"LongOrigem":-46.59565,"NomeOrigem":"000001","CorOrigem":"rgba(0,0,255,1)","LatDestino":-23.70794,"LongDestino":-46.59565,"NomeDestino":"000001","CorDestino":"rgba(0,0,255,1)","CorLinha":"rgba(0,0,255,1)","WayPoint":[{"Latitude":-25.52062,"Longitude":-54.59005,"Nome":"0000010001","Cor":"rgba(255,0,0,1)","Documento":[{"FilialDocumento":"M SP 01 ","NumDocumento":"500003482","SerieDocumento":"117","QtdeVolumes":10,"PesoReal":1000,"PesoCubado":0,"Metragem3":0,"ValMercadoria":3000}]}]}],"Resumo":[{"ResLigado":0,"Latitude":-23.70794,"Longitude":-46.59565,"Detalhes":"<h1>Totais do Ponto</h1><p>Programações :    2<br>Documentos :   10<br>Volumes :    10<br>Peso Real :      10,0000<br>Peso Cubado :      10,0000<br>Metragem Cúbica :      10,0000<br>Valor da Mercadoria :             10,00</p>"},{"ResLigado":0,"Latitude":-25.52062,"Longitude":-54.59005,"Detalhes":"<h1>Totais do Ponto</h1><p>Programações :    1<br>Documentos :    1<br>Volumes :    10<br>Peso Real :   1.000,0000<br>Peso Cubado :       0,0000<br>Metragem Cúbica :       0,0000<br>Valor da Mercadoria :          3.000,00</p>"}],"Viagens":[{"VgeLigado":0,"Latitude":-23.70794,"Longitude":-46.59565,"Detalhes":"<table><caption><h1>Viagens do Ponto</h1></caption><tr><th>Fil. Origem </th><th>Prg Carregto</th><th>Viagem      </th><th>Dt.Prevista </th><th>Hr.Prevista </th><th>Qtd.Doctos  </th><th>Qtd.Volumes </th><th>Peso        </th><th>Peso Cubado </th><th>M3          </th><th>Valor       </th></tr><tr><td>M SP 01 </td><td>000001</td><td>000789</td><td> </td><td>00:00</td><td>   1</td><td>  10</td><td>  1.000,0000</td><td>      0,0000</td><td>      0,0000</td><td>         3.000,00</td></tr></table>"},{"VgeLigado":0,"Latitude":-25.52062,"Longitude":-54.59005,"Detalhes":"<table><caption><h1>Viagens do Ponto</h1></caption><tr><th>Fil. Origem </th><th>Prg Carregto</th><th>Viagem      </th><th>Dt.Prevista </th><th>Hr.Prevista </th><th>Qtd.Doctos  </th><th>Qtd.Volumes </th><th>Peso        </th><th>Peso Cubado </th><th>M3          </th><th>Valor       </th></tr><tr><td>M SP 01 </td><td>000001</td><td>000789</td><td> </td><td>00:00</td><td>   1</td><td>  10</td><td>  1.000,0000</td><td>      0,0000</td><td>      0,0000</td><td>         3.000,00</td></tr></table>"}]}'
			Prepara_Json(cJson);
		}

		/*
		 * Função Responsável pela preparação do Json das viagens
 		*/
		 function Prepara_Json (cJson) {
			oJson = JSON.parse(cJson);
			maphere()
		}

		function maphere() {
			// Inicializa as variáveis das viagens
			nSeqVia   = 0
			nSeqWay   = 0
			nPromessa = 0
			nLatVia   = 0
			nLongVia  = 0
			waypoints = []
			
			// Inicie e autentique sua conexão com a plataforma Here
			const platform = new H.service.Platform({'apikey':'ptpq0mVq0aSmpAefk3wUDilR8e6dzDLHb0p2juo2tWE'});

			// Obtenha os tipos de mapa padrão do objeto de plataforma
			const defaultLayers = platform.createDefaultLayers();

			// Receba e converta o Json em objeto
			//ConectTotvsTec()
			//semconexao()

			// Instanciar e exibir um mapa
			map = new H.Map(document.getElementById("map"),

			// Centralize o mapa no ponto desejado com o nível de zoom 10
			defaultLayers.vector.normal.map, {zoom: 10,center: {lat: oJson.Prog[nSeqVia].LatitFil,lng: oJson.Prog[nSeqVia].LongitFil}});

			// MapEvents habilita o sistema de eventos
			// A variável de comportamento implementa interações padrão para panorâmica/zoom também em ambientes de toque móvel
			const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

			// Habilite o redimensionamento dinâmico do mapa, com base no tamanho atual do contêiner anexo
			window.addEventListener("resize",() => map.getViewPort().resize());

			// Crie a interface de usuário padrão
			ui = H.ui.UI.createDefault(map,defaultLayers,);

			// LOGICA DO PROGRAMA

			// Carrega as Viagens
			Carrega_Viagens(oJson,platform,ui);
		}

		/*
		 * Manipulador para a chamada H.service.RoutingService8#calculateRoute
		 * @param {object} response - O objeto de resposta retornado pelo método calculaRoute
		 */
		function routeResponseHandler(response) {
		    const sections = response.routes[0].sections;
		    const lineStrings = [];
		    sections.forEach((section) => {
		        // Converter string codificada de polilinha flexível em geometria
		        lineStrings.push(H.geo.LineString.fromFlexiblePolyline(section.polyline));
		    });
		    const multiLineString = new H.geo.MultiLineString(lineStrings);
		    const bounds = multiLineString.getBoundingBox();

		    // Crie a polilinha para a rota
		    if (oJson.Prog[nPromessa].LinRota) {
		        // Se for routePolyline, apenas definimos a nova geometria
		        oJson.Prog[nPromessa].LinRota.setGeometry(multiLineString);
		    } else {
		        // routePolyline ainda não está definido, instancie um novo H.map.Polyline
		        oJson.Prog[nPromessa].LinRota = new H.map.Polyline(multiLineString,
					{style: {strokeColor: oJson.Prog[nPromessa].CorLinha,lineWidth: 5}});
		    }

		    // Adicione a polilinha ao mapa
		    map.addObject(oJson.Prog[nPromessa].LinRota);

		    nPromessa ++;

		}

		/*
		 * Atualiza a rota
		 */
		function updateRoute(nSeqVia) {
		    // Adicione pontos de referência pelos quais a rota deve passar
		    oJson.Prog[nSeqVia].ParRoteiro.via = 
			new H.service.Url.MultiValueQueryParameter(waypoints.map(wp => `${wp.getGeometry().lat},${wp.getGeometry().lng}`));
		    oJson.Prog[nSeqVia].Roteiro.calculateRoute(oJson.Prog[nSeqVia].ParRoteiro,routeResponseHandler,console.error);
		}

		/*
		 * Retorna uma instância de H.map.Icon para estilizar os marcadores
		 * @param {number|string} id - Um identificador que será exibido como rótulo de marcador
		 * @return {H.map.Icon}
		 */
		function getMarkerIcon(id, cCor) {
		    const svgCircle = `<svg width="100" height="100" version="1.1" xmlns="http://www.w3.org/2000/svg">
			<g id="marker">
			<circle cx="50" cy="50" r="25" fill="${cCor}" stroke="${cCor}" stroke-width="4" />
			<text x="50%" y="50%" text-anchor="middle" fill="black" font-family="Arial, sans-serif" font-size="12px"
				dy=".3em">${id}</text>
			</g></svg>`;
		    return new H.map.Icon(svgCircle, {anchor: {x: 10, y: 10} });
		}

		/*
		 * Crie uma instância de H.map.Marker e adicione-a ao mapa
		 * @param {object} position - Um objeto com propriedades 'lat' e 'lng' definindo a posição do marcador
		 * @param {string|number} id - Um identificador que será exibido como rótulo de marcador
		 * @return {H.map.Marker} A instância do marcador que foi criado
		 */
		function addMarker(position, id, cCor) {
		    const marker = new H.map.Marker(position,{data: {id},icon: getMarkerIcon(id,cCor),
		        // Ativar arrastar suavemente
		        volatility: true});

		    // Habilitar marcadores arrastáveis
		    marker.draggable = true;

		    map.addObject(marker);
		    return marker;
		}

		/*
		 * Função Responsável pela Exibição das Viagens do Ponto
 		*/
		function VgaPonto(ui) {
			Viagens = '<div style="width: 1050px">' + oJson.Viagens.find(Detalhes => Detalhes.Latitude === nLatVia && Detalhes.Longitude === nLongVia).Detalhes + '</div>'
			var bubbleVga = new H.ui.InfoBubble({ lng: nLongVia, lat: nLatVia }, {
				content: Viagens});
			ui.addBubble(bubbleVga);

		}

		/*
		 * Função Responsável pela Carga das Viagens Vindas do Protheus
 		*/
		function Carrega_Viagens (oJson,platform,ui) {

			for (nSeqVia = 0; nSeqVia <= oJson.Prog.length - 1; nSeqVia++) {
				// ADICIONE MARCADORES PARA ORIGEM/DESTINO
				origin      = {lat: oJson.Prog[nSeqVia].LatOrigem ,lng: oJson.Prog[nSeqVia].LongOrigem}; // Ponto origem
				destination = {lat: oJson.Prog[nSeqVia].LatDestino,lng: oJson.Prog[nSeqVia].LongDestino}; // Ponto destino

				originMarker      = addMarker(origin     ,oJson.Prog[nSeqVia].NomeOrigem ,oJson.Prog[nSeqVia].CorOrigem);
				destinationMarker = addMarker(destination,oJson.Prog[nSeqVia].NomeDestino,oJson.Prog[nSeqVia].CorDestino);

				// Defina os parâmetros do serviço de roteamento
				// define vários waypoints
				waypoints = []
				oJson.Prog[nSeqVia].RotWayPoints = new H.service.Url.MultiValueQueryParameter(waypoints);
				oJson.Prog[nSeqVia].ParRoteiro = {"origin": `${origin.lat},${origin.lng}`,
					"destination": `${destination.lat},${destination.lng}`,"via": oJson.Prog[nSeqVia].RotWayPoints,
					"transportMode": "car","return": "polyline"};

				// Obtenha uma instância do serviço H.service.RoutingService8
				oJson.Prog[nSeqVia].Roteiro = platform.getRoutingService(null,8);

				// Monte os waypoints
				for (nSeqWay = 0; nSeqWay <= oJson.Prog[nSeqVia].WayPoint.length - 1; nSeqWay++) {
					waypoints.push(addMarker({lat: oJson.Prog[nSeqVia].WayPoint[nSeqWay].Latitude,
						lng: oJson.Prog[nSeqVia].WayPoint[nSeqWay].Longitude},
						oJson.Prog[nSeqVia].WayPoint[nSeqWay].Nome,oJson.Prog[nSeqVia].WayPoint[nSeqWay].Cor));
				}
				
				updateRoute(nSeqVia);	//Chame o serviço de roteamento com os parâmetros definidos e exiba a rota
			}

			/*
			* Função Responsável pela Exibição do Resumo do Ponto
			*/
			map.addEventListener('tap', function(ev) {
				const target = ev.target;
				const pointer = ev.currentPointer;
				if (target instanceof H.map.Marker) {
					nLatVia  = target.$l.lat
					nLongVia = target.$l.lng
					Resumo   = '<div style="width: 220px">' + oJson.Resumo.find(Detalhes => Detalhes.Latitude === nLatVia && Detalhes.Longitude === nLongVia).Detalhes
					var bubbleRes = new H.ui.InfoBubble({ lng: nLongVia, lat: nLatVia }, {
					content: Resumo + '<input type="button" onclick="VgaPonto(ui)" value="Viagens" /></div>'
									});
					ui.addBubble(bubbleRes);
				}
			});

		}

	</script>

</body>

</html>
