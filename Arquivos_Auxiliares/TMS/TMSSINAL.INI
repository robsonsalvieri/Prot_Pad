?{"Nome do Arquivo INI","TMSSINAL.INI"}
?{"Descrição Completa do Arquivo Magnético","Sistema de Internamento de Mercadoria Nacional - Disponibilizado pelo SUFRAMA."}
?{"A Quem se Destina","A empresas remetentes que operam com a ZFM e com as demais áreas de atuação da SUFRAMA."}
?{"Objetivo","Gerar arquivo magnético pré-formatado para a importação dos dados de carga (MANIFESTO E CONHECIMENTO) do WSSINAL "}
?{"Aplicativo Disponibilizado pelo Fisco","WS SINAL."}
?{"Versao do Aplicativo Contemplada pela Microsiga","6.0"}
?{"Comentarios",""}
           
//---- Variaveis Utilizadas
//_aTotal[01]: Informacoes na Tela de Parametros
//_aTotal[02]: Parametros (Filial Manifesto, Manifesto, Nro ANTT, Nro Versao)
//_aTotal[03]: Controle da informacao dos parametros 
//_aTotal[04]: Conteudo dos parametros
//_aTotal[05]: Processamento da rotina TMS (TMSSINAL.PRW)
//_aTotal[06]: Dados do Manifesto  - Cabecalho do Manifesto
//_aTotal[07]: Dados do Manifesto  - Cabecalho do Manifesto
//_aTotal[08]: Placa ANTT
//_aTotal[09]: Tipo ANTT 
//_aTotal[10]: Controle de Abertura/Fechamento da TAG
//_aTotal[11]: Controle de Abertura/Fechamento da TAG
//_aTotal[12]: Cabecalho TAG da Nota Fiscal
//_aTotal[13]: Cabecalho TAG do Conhecimento

//--- Tabelas Temporarias gerados a partir do TMSSINAL.PRW
//NFC - Dados da Nota Fiscal
//CHC - Dados do Conhecimento
//MAN - Dados do Manifesto    

//Codigo ANTT Ramos - '0044361' 

@XML

[XXX Layout dos Arquivos ]
(PRE) _aTotal[01] 	:= {}
(PRE) _aTotal[02] 	:= {}
(PRE) _aTotal[03] 	:= .F.
(PRE) _aTotal[04] 	:= {}
(PRE) _aTotal[05] 	:= .F.      
(PRE) _aTotal[10] 	:= .T.    
(PRE) _aTotal[11]    := 0
 

[XXX Montagem das informações necessárias pela rotina - PRINCIPAL]
(PRE) aAdd (_aTotal[01], "Processamento das Cargas Transportadas para a ZFM ")
(PRE) aAdd (_aTotal[01], "")
(PRE) aAdd (_aTotal[01], "Preencha corretamente as informações solicitadas abaixo.")
(PRE) aAdd (_aTotal[01], "Informações necessárias para a geração correta do arquivo")
 

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[02], {})
(PRE) aAdd (_aTotal[02][1], "")
(PRE) aAdd (_aTotal[02][1], "Informações Gerais: ")
(PRE) aAdd (_aTotal[02][1], {})                                                          
(PRE) aAdd (_aTotal[02][1][3], {1, "Filial Manifesto",,,,,,})
(PRE) aAdd (_aTotal[02][1][3], {1, "Numero Manifesto",,,,,,})
(PRE) aAdd (_aTotal[02][1][3], {2,,"@!",1,,,,TAMSX3("DTX_FILMAN")[1] ,,,""})
(PRE) aAdd (_aTotal[02][1][3], {2,,"@!",1,,,,TAMSX3("DTX_MANIFE")[1] ,,,""})
(PRE) aAdd (_aTotal[02][1][3], {0, "",,,,,,})  
(PRE) aAdd (_aTotal[02][1][3], {0, "",,,,,,})  
(PRE) aAdd (_aTotal[02][1][3], {1, "Serie Manifesto",,,,,,})
(PRE) aAdd (_aTotal[02][1][3], {1, "Informe o Numero ANTT",,,,,,})
(PRE) aAdd (_aTotal[02][1][3], {2,,"XXX", 1,,,,3}) 
(PRE) aAdd (_aTotal[02][1][3], {2,,"XXXXXXXXXXXXXXXXXXXXXX", 1,,,,22})  
(PRE) aAdd (_aTotal[02][1][3], {0, "",,,,,,})  
(PRE) aAdd (_aTotal[02][1][3], {0, "",,,,,,}) 
(PRE) aAdd (_aTotal[02][1][3], {1, "Informe a Versao do SINAL",,,,,,})   
(PRE) aAdd (_aTotal[02][1][3], {0, "",,,,,,}) 
(PRE) aAdd (_aTotal[02][1][3], {2,,"XXXXX", 1,,,,5})  
           
                          
[XXX Chamada do Wizard]
(PRE) _atotal[03] := xMagWizard(_aTotal[01],_aTotal[02],"TMSSINAL")
(PRE) Iif (_atotal[03], xMagLeWiz ("TMSSINAL", @_aTotal[04], .T.), Nil)
(PRE) lAbtMT950	:= !_atotal[03]
 

[XXX Geracao Arquivo Temporario]    
(PRE) _aTotal[05]:= TMSSINPROC( _aTotal[04][1][1],_aTotal[04][1][2],_aTotal[04][1][3] )     
//-- Caso o retorno for Falso, nao continua com a geracao
(PRE) lAbtMT950	:= !_atotal[05]
                   
      
[XXX Abertura Arquivo Temporario MAN]    
(PRE) MAN->(dbGoTop())

[MAN - Arq.Temporario - Cabecalho do XML - Dados Notas Fiscais]
(PRE) _aTotal[06] := "version="+'"1.0"'+" encoding="+'"UTF-8"'+" ?"
(PRE) _aTotal[07] := 'nro="'+AllTrim(_aTotal[04][1][2])+'" versao_sw="'+AllTrim(_aTotal[04][1][5])+'" dtEmissao="'
(PRE) _aTotal[07] += FormDate(dDataBase)+'" xmlns="http://www.portal.fucapi.br" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.portal.fucapi.br http://alvaraes.suframa.gov.br:7778/PMNRecEViewController/jsp/importardados/ManifestoConhecimento.xsd"'
Linha1     C 000 0 MontaXML("?xml",,,,,,,.T.,.F.,.T.,_aTotal[06])
Manifesto  C 000 0 MontaXML("man",,,,,,,.T.,.F.,.T.,_aTotal[07])
cnpjTransp C 000 0 MontaXML("traCGCMF",SM0->M0_CGC,,,,,8,.T.,.T.,.T.)
VlTotNF    C 000 0 MontaXML("manValorTotalNota",MAN->VALMER,"N",22,2,"@R 9999999999999999999.99",8,.T.,.T.,.T.)
VlTotProd  C 000 0 MontaXML("manValorTotalProd",MAN->VALMER,"N",22,2,"@R 9999999999999999999.99",8,.T.,.T.,.T.)
Peso       C 000 0 MontaXML("manPeso",MAN->PESO,"N",22,2,"@R 9999999999999999999.99",8,.T.,.T.,.T.)
QtdCTRC    C 000 0 MontaXML("manQtdeConhecimento",MAN->QTDDOC,"N",22,,,8,.T.,.T.,.T.)
QtdNF      C 000 0 MontaXML("manQtdeNFs",MAN->QTDNF,"N",22,,,8,.T.,.T.,.T.)
UfDestino  C 000 0 MontaXML("manUF_Destino",MAN->UFDES,,,,,8,.T.,.T.,.T.)
//Modalidade de Transporte ->> 0= Transportadora
ModTransp  C 000 0 MontaXML("manModTransportador","0",,,,,8,.T.,.T.,.T.)
CPFCondut  C 000 0 MontaXML("manCPFCondutor",MAN->CGC,,,,,8,.T.,.T.,.T.)
PlacaVei   C 000 0 MontaXML("manPlaca",MAN->PLACA,,,,,8,.T.,.T.,.T.)
UFPlacaVei C 000 0 MontaXML("manUFPlaca",MAN->ESTPLA,,,,,8,.T.,.T.,.T.)
gpoNFINI   C 000 0 MontaXML("notasFiscais",,,,,,8,.T.,.F.,.T.)       
                 

[XXX Abertura Arquivo Temporario NFC e CHC]    
_aTotal[10]:= .F.
(PRE) NFC->(dbGoTop())
(PRE) CHC->(dbGoTop())   


[NFC - Arq.Temporario - Dados de Notas Fiscais] 
(PREREG) _aTotal[12]:= ""
(PREREG) _aTotal[12]:= 'nro="'+Iif(Empty(NFC->NFEID),NFC->NUMNFC,NFC->NFEID)+'" dtEmissao="'+FormDate(NFC->EMINFC)+'" '+'tipo="'+Iif(Empty(NFC->NFEID),"0","1")+'"'

NotaINI    C 000 0 MontaXML("notaFiscal",,,,,,16,.T.,.F.,.T.,_aTotal[12])          
CNPJRem    C 000 0 MontaXML("remCGCMF",Iif(Empty(NFC->NFEID),NFC->CGCREM,""),,,,,16,.T.,.T.,.T.)
CNPJDes    C 000 0 MontaXML("desCGCMF",Iif(Empty(NFC->NFEID),NFC->CGCDES,""),,,,,16,.T.,.T.,.T.)
CTRC       C 000 0 MontaXML("conNumero",NFC->DOC,,,,,16,.T.,.T.,.T.)  
NotaFIM    C 000 0 MontaXML("notaFiscal",,,,,,16,.F.,.T.,.T.)          
(POS)

[CHC - Arq.Temporario - Dados do Conhecimento]
(PRE) _aTotal[08]:= ''
(PRE) _aTotal[09]:= ''  

(PREREG) _aTotal[13]:= ""
(PREREG) _aTotal[13]:= 'nro="'+AllTrim(CHC->DOC)+'" dtEmissao="'+FormDate(CHC->DATEMI)+'"'

gpoNfFIM   C 000 0 MontaXML("notasFiscais",,,,,,IIF(_aTotal[11]==0,8,0),.F.,IIF(_aTotal[11]==0,.T.,.F.),IIF(_aTotal[11]==0,.T.,.F.))
gpoConINI  C 000 0 MontaXML("conhecimentos",,,,,,IIF(_aTotal[11]==0,8,0),IIF(_aTotal[11]==0,.T.,.F.),.F.,IIF(_aTotal[11]==0,.T.,.F.))

ConINI     C 000 0 MontaXML("conhecimento",,,,,,16,.T.,.F.,.T.,_aTotal[13])
VlrTotal   C 000 0 MontaXML("conValorTotalNota",CHC->VALMER,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
VlrTotPro  C 000 0 MontaXML("conValorTotalProd",CHC->VALMER,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
QtdeNF     C 000 0 MontaXML("conQtdeNotaFiscal",CHC->QTDNF,"N",,,,16,.T.,.T.,.T.) 
Peso       C 000 0 MontaXML("conPeso",CHC->PESO,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
CFOP       C 000 0 MontaXML("conCFOP",CHC->CFO,,,,,16,.T.,.T.,.T.) 
Modelo     C 000 0 MontaXML("conModelo","1",,,,,16,.T.,.T.,.T.) 
ModFret    C 000 0 MontaXML("conModFrete",CHC->TIPFRE,,,,,16,.T.,.T.,.T.) 
BaseICM    C 000 0 MontaXML("conBCICMS",CHC->BASEICM,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
VlrICM     C 000 0 MontaXML("conValorICMS",CHC->VALICM,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
VlrFrete   C 000 0 MontaXML("conValorFrete",CHC->VALFRE,"N",22,2,"@R 9999999999999999999.99",16,.T.,.T.,.T.) 
NrANTT     C 000 0 MontaXML("conANTTNum",_aTotal[04][1][4],,,,,16,.T.,.T.,.T.) 
PlacaANTT  C 000 0 MontaXML("conANTTPlaca",_aTotal[08],,,,,16,.T.,.T.,.T.) 
TipoANTT   C 000 0 MontaXML("conANTTTipo",_aTotal[09],,,,,16,.T.,.T.,.T.) 
cnpjTransp C 000 0 MontaXML("traCGCMF",SM0->M0_CGC,,,,,16,.T.,.T.,.T.)
ConFIM     C 000 0 MontaXML("conhecimento",,,,,,16,.F.,.T.,.T.)

_aTotal[10]:= .F.
(CONT) _aTotal[011]++
(POS)



[XXX - TAGs de encerramento do Arquivo]                                                                              
//Fecha Tags
gpoNfFIM   C 000 0 MontaXML("notasFiscais",,,,,,IIF(_aTotal[11]==0,8,0),.F.,IIF(_aTotal[11]==0,.T.,.F.),IIF(_aTotal[11]==0,.T.,.F.))
gpoCONFIM  C 000 0 MontaXML("conhecimentos",,,,,,IIF(_aTotal[11]>0,8,0),.F.,IIF(_aTotal[11]>0,.T.,.F.),IIF(_aTotal[11]>0,.T.,.F.))
ManFIM     C 000 0 MontaXML("man",,,,,,,.F.,.T.,.T.)  

//Fecha Arquivos Temporarios
(POS) TMSSINClos("MAN")       
(POS) TMSSINClos("NFC")       
(POS) TMSSINClos("CHC")       


