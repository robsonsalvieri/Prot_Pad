?{"Nombre del archivo INI","SIRETPER.INI"}
?{"Descripcion completa del Archivo Magnetico","Declaracion jurada para agentes de retencion/percepcion - Tucuman - Argentina"}
?{"A Quienes se Destina","A agentes de  retencion y percepcion estabelecidos en la provincia de Tucuman"}
?{"Objetivo","Generar un archivo de Declaracion jurada para agentes de retencion/percepcion. "}
?{"Plazo de Entrega","Mensal - Depende del C.U.I.T."}
?{"Aplicativo Disponibilizado","Siretper"}
?{"Version del Aplicativo Comtemplada por la Microsiga","6.2"}
?{"Nomenclatura de los Archivos",""}
?{"DATOS_R.TXT - Datos de la Factura o Comprobante"}
?{"DATOS_P.TXT - Datos de la Factura o Comprobante"}
?{"RETPER_R.TXT - Datos del Retenido/Percibido"}
?{"RETPER_P.TXT - Datos del Retenido/Percibido"}

[XXX Inicializacao]
(PRE) _aTotal[97] := SuperGetMV("MV_IGBTUCM",,"IB4")
(PRE) _aTotal[11] := {}
(PRE) _aTotal[13] := ""
(PRE) _aTotal[14] := ""
(PRE) _aTotal[15] := "" 
(PRE) _aTotal[16] := ""
(PRE) _aTotal[18] := ""
(PRE) _aTotal[19] := 0
(PRE) _aTotal[30] := .T.
(PRE) _aTotal[31] := ""
(PRE) _aTotal[96] := ""
(PRE) SFB->(DbSetOrder (1))
(PRE) SFB->(DbSeek (xFilial ("SFB")+_aTotal[97]))
(PRE) _aTotal[96] := SFB->FB_CPOLVRO
(PRE) _aTotal[96] := Iif(Empty(_aTotal[96]),"5",_aTotal[96])
(PRE) _aTotal[99] := MV_PAR01
(PRE) _aTotal[98] := MV_PAR02
(PRE) SF3->(DbSetOrder (4))
(PRE) SFE->(DbSetOrder (1))
(PRE) SA1->(DbSetOrder (1))
(PRE) SA2->(DbSetOrder (1))
(PRE) SX5->(DbSetOrder (1))
(PRE) _aTotal[81] := {"SF3", ""}
(PRE) _aTotal[82] := "F3_FILIAL='"+xFilial ("SF3")+"' AND F3_EMISSAO>='"+DTOS (_aTotal[99])+"' AND F3_EMISSAO<='"+DTOS (_aTotal[98])+"' AND F3_VALIMP"+_aTotal[96]+" > 0 AND (F3_TIPOMOV = 'V' OR F3_ESPECIE ='NDI' OR F3_ESPECIE ='NCI') "
(PRE) _aTotal[83] := "F3_FILIAL=='"+xFilial ("SF3")+"' .AND. DTOS (F3_EMISSAO)>='"+DTOS (_aTotal[99])+"' .AND. DTOS (F3_EMISSAO)<='"+DTOS (_aTotal[98])+"' .AND. F3_VALIMP"+_aTotal[96]+" > 0 .AND. (F3_TIPOMOV = 'V'OR F3_ESPECIE$'NDI|NCI')"
(PRE) _aTotal[84] := {"SFE", ""}
(PRE) _aTotal[85] := "FE_FORNECE <> '' AND FE_FILIAL='"+xFilial ("SFE")+"' AND FE_EMISSAO>='"+DTOS (_aTotal[99])+"' AND FE_EMISSAO<='"+DTOS (_aTotal[98])+"' AND FE_TIPO ='B' AND FE_EST = 'TU' "
(PRE) _aTotal[86] := "FE_FORNECE <> '' .AND. FE_FILIAL=='"+xFilial ("SFE")+"' .AND. DTOS (FE_EMISSAO)>='"+DTOS (_aTotal[99])+"' .AND. DTOS (FE_EMISSAO)<='"+DTOS (_aTotal[98])+"' .AND. FE_TIPO ='B' .AND. FE_EST == 'TU' "
(PRE) _aTotal[88] := 0
(PRE) _aTotal[89] := {} 
(PRE) _aTotal[87] := {} 
(PRE) _aTotal[90] := {}
(PRE) _aTotal[70] := .F.
(PRE) _aTotal[71] := .F.
(PRE) _aTotal[72] := ""
(PRE) _aTotal[73] := ""
(PRE) _aTotal[74] := ""
(PRE) _aTotal[75] := 0
(PRE) _aTotal[76] := ""
(PRE) _aTotal[77] := "D1_FILIAL='"+xFilial ("SD1")+"' AND D1_EMISSAO>='"+DTOS (_aTotal[99])+"' AND D1_EMISSAO<='"+DTOS (_aTotal[98])+"' AND D1_VALIMP"+_aTotal[96]+" > 0 AND  D1_ESPECIE ='NCC'"
(PRE) _aTotal[78] := "D1_FILIAL=='"+xFilial ("SD1")+"' .AND. DTOS (D1_EMISSAO)>='"+DTOS (_aTotal[99])+"' .AND. DTOS (D1_EMISSAO)<='"+DTOS (_aTotal[98])+"' .AND. D1_VALIMP"+_aTotal[96]+" > 0 .AND. Alltrim( D1_ESPECIE)$'NCC'"
(PRE) _aTotal[79] := "D2_FILIAL='"+xFilial ("SD2")+"' AND D2_EMISSAO>='"+DTOS (_aTotal[99])+"' AND D2_EMISSAO<='"+DTOS (_aTotal[98])+"' AND D2_VALIMP"+_aTotal[96]+" > 0 AND   D2_ESPECIE ='NCC'"
(PRE) _aTotal[80] := "D2_FILIAL=='"+xFilial ("SD2")+"' .AND. DTOS (D2_EMISSAO)>='"+DTOS (_aTotal[99])+"' .AND. DTOS (D2_EMISSAO)<='"+DTOS (_aTotal[98])+"' .AND. D2_VALIMP"+_aTotal[96]+" > 0 .AND.  Alltrim(D2_ESPECIE)$'NCC'"
(PRE) _aTotal[60] := {}

[XXX Registro SIRETPER - Retención]
(PRE) _aTotal[84] := SiRetPer(DTOS(_aTotal[99]),DTOS(_aTotal[98]),_aTotal[90],Iif(lAglFil,.T.,.F.),"SIRETPER","DATOS_R")

//Executa query SFE


[DATOSR - DATOS_R]
(ARQ) DATOS_R.TXT
(PRE) DATOSR->(DbGotop())
(POS)
FECHA      C 008 0 DATOSR->FECHA
TIPODOC    C 002 0 DATOSR->TIPODOC
DOC        C 011 0 DATOSR->DOC
TIPOCOMP   C 002 0 DATOSR->TIPOCOMP
LETRA      C 001 0 DATOSR->LETRA
NUMERO     C 012 0 DATOSR->NUMERO
MONTOIMP   C 015 2 DATOSR->MONTOIMP
ALICUOTA   C 006 2 DATOSR->ALICUOTA
MONTORET   C 015 2 DATOSR->MONTORET
//NINGBRU    C 011 0 Replicate("0",11-Len(Alltrim(_aTotal[31]))) + _aTotal[31]

[XXX Encerramento - DATOSR]


[XXX Registro SIRETPER - Percepción]
(PRE) _aTotal[81] := SiRetPer(DTOS(_aTotal[99]),DTOS(_aTotal[98]),_aTotal[90],Iif(lAglFil,.T.,.F.),"SIRETPER","DATOS_P")

//Executa query SF3

[DATOSP - DATOS_P]
(ARQ) DATOS_P.TXT
(PRE) DATOSP->(DbGotop())
(POS)
FECHA      C 008 0 DATOSP->FECHA
TIPODOC    C 002 0 DATOSP->TIPODOC
DOC        C 011 0 DATOSP->DOC
TIPOCOMP   C 002 0 DATOSP->TIPOCOMP
LETRA      C 001 0 DATOSP->LETRA 
TERMINAL   C 004 0 DATOSP->TERMINAL
NUMERO     C 008 0 DATOSP->NUMERO
MONTOIMP   C 015 0 DATOSP->MONTOIMP
ALICUOTA   C 006 0 DATOSP->ALICUOTA
MONTORET   C 015 0 DATOSP->MONTORET
//NINGBRU  C 011 0 Replicate("0",11-Len(Alltrim(_aTotal[31]))) + _aTotal[31]

[XXX Encerramento - DATOSP]


//Executa query SFE

[XXX Registro SIRETPER - Retención]
(PRE) _aTotal[84] := SiRetPer(DTOS(_aTotal[99]),DTOS(_aTotal[98]),_aTotal[90],Iif(lAglFil,.T.,.F.),"SIRETPER","RETPER_R")

[RETPERR - RETPER_R]
(ARQ) RETPER_R.TXT
(PRE) RETPERR->(DbGotop())
(POS)
CTIPODOC   C 002 0 RETPERR->CTIPODOC
DOC        C 011 0 RETPERR->DOC
TIPBRE     C 040 0 RETPERR->TIPBRE
DOMICILIO  C 040 0 RETPERR->DOMICILIO
PUERTA     C 005 0 RETPERR->PUERTA
LOCALIDAD  C 015 0 RETPERR->LOCALIDAD
PROVINCIA  C 015 0 RETPERR->PROVINCIA
NINGBRU    C 011 0 RETPERR->NINGBRU
C_POSTAL   C 008 0 RETPERR->C_POSTAL

[XXX Encerramento - RETPERR]


[XXX Registro SIRETPER - Percepción]

//Executa query SF3
(PRE) _aTotal[81] := SiRetPer(DTOS(_aTotal[99]),DTOS(_aTotal[98]),_aTotal[90],Iif(lAglFil,.T.,.F.),"SIRETPER","RETPER_P")

[RETPERP - RETPER]
(ARQ) RETPER_P.TXT
(PRE) RETPERP->(DbGotop())
(POS)
TIPODOC    C 002 0 RETPERP->TIPODOC
DOC        C 011 0 RETPERP->DOC
NOMBRE     C 040 0 RETPERP->NOMBRE
DOMICILIO  C 040 0 RETPERP->DOMICILIO
PUERTA     C 005 0 RETPERP->PUERTA
LOCALIDAD  C 015 0 RETPERP->LOCALIDAD
PROVINCIA  C 015 0 RETPERP->PROVINCIA
NINGBRU    C 011 0 RETPERP->NINGBRU
//NINGBRU    C 011 0 Replicate("0",11-Len(Alltrim(_aTotal[31]))) + _aTotal[31]
C_POSTAL   C 008 0 RETPERP->C_POSTAL


(PRE) FsQuery ({"SD1", ""}, 1,_aTotal[77],_aTotal[78],,,,,)

[SD1 - NCFACT]
(PRE) SD1->(DbGotop ())
(PREREG) ( IIF( !Empty(D1_REMITO) , .T. , IIF( !Empty(D1_NFORI) , .T. , .F. ) ) )
(PREREG) ( _aTotal[88] := Len(_aTotal[87]),.T.)
(PREREG) ( IIF( !EMPTY(D1_REMITO) ,  (_aTotal[70] := D1_FORNECE+D1_LOJA+D1_DOC+D1_SERIE+D1_REMITO+D1_SERIREM,.T.)  ,  (_aTotal[70] := D1_FORNECE+D1_LOJA+D1_DOC+D1_SERIE+D1_NFORI+D1_SERIORI,.T.)  ) )
(PREREG) (Iif(AScan(_aTotal[87],_aTotal[70]) == 0, AAdd(_aTotal[87],_aTotal[70]), .F.), .T.)
(PREREG) (IIF(_aTotal[88]<>Len(_aTotal[87] ),.T.,.F.))
(PREREG) ( IIf( EMPTY(SD1->D1_NFORI), _aTotal[60] := fVldRemDev(SD1->D1_ESPECIE), _aTotal[60] := {} ) )
LUGARNF    C 004 0 Substr(SD1->D1_DOC,1,4)
NUMERO     C 008 0 Replicate("0",8-Len(AllTrim(Substr(SD1->D1_DOC,5,TamSX3("D1_DOC")[1]-4))))+Substr(SD1->D1_DOC,5,TamSX3("D1_DOC")[1]-4)
CODLUGENC  C 004 0 IIf(!EMPTY(SD1->D1_NFORI) , Substr(D1_NFORI,1,4), IIF(Empty(_aTotal[60]),Substr(SD1->D1_REMITO,1,4), _aTotal[60][1]))
NUMERONF   C 008 0 IIf(!EMPTY(SD1->D1_NFORI), Replicate("0",8-Len(AllTrim(Substr(D1_NFORI,5,TamSX3("D1_NFORI")[1]-4))))+Substr(D1_NFORI,5,TamSX3("D1_NFORI")[1]-4), IIf(Empty(_aTotal[60]),Replicate("0",8-Len(AllTrim(Substr(SD1->D1_REMITO,5,TamSX3("D1_REMITO")[1]-4))))+Substr(SD1->D1_REMITO,5,TamSX3("D1_REMITO")[1]-4), _aTotal[60][2]))
TIPOFAC    C 002 0 TipDocTU(Alltrim( SerieNfId("SD1",2,"D1_SERIE") ),"NF")

[XXX Inicializacao - SD2]
//Executa query SF3
(PRE) FsQuery ({"SD2", ""}, 1,_aTotal[79],_aTotal[80],,,,,)

[SD2 - NCFACT]
(ARQ) NCFACT.TXT
(PRE) SD2->(DbGotop())
(PREREG) ( IIF( !Empty(D2_REMITO) , .T. , IIF( !Empty(D2_NFORI) , .T. , .F. ) ) )
(PREREG) ( _aTotal[88] := Len(_aTotal[87]),.T.)
(PREREG) ( IIF( !Empty(D2_REMITO) ,  (_aTotal[70] := D2_CLIENTE+D2_LOJA+D2_DOC+D2_SERIE+D2_REMITO+D2_SERIREM,.T.)  ,  (_aTotal[70] := D2_CLIENTE+D2_LOJA+D2_DOC+D2_SERIE+D2_NFORI+D2_SERIORI,.T.) )  )
(PREREG) (Iif(AScan(_aTotal[87],_aTotal[70]) == 0, AAdd(_aTotal[87],_aTotal[70]), .F.), .T.)
(PREREG) (IIF(_aTotal[88]<>Len(_aTotal[87] ),.T.,.F.))
LUGARNF    C 004 0 Substr(SD2->D2_DOC,1,4)
NUMERO     C 008 0 Replicate("0",8-Len(AllTrim(Substr(SD2->D2_DOC,5,TamSX3("D2_DOC")[1]-4))))+Substr(SD2->D2_DOC,5,TamSX3("D2_DOC")[1]-4)
CODLUGENC  C 004 0 Substr(D2_NFORI,1,4)
NUMERONF   C 008 0 Replicate("0",8-Len(AllTrim(Substr(D2_NFORI,5,TamSX3("D2_NFORI")[1]-4))))+Substr(D2_NFORI,5,TamSX3("D2_NFORI")[1]-4)
TIPOFAC    C 002 0 TipDocTU(Alltrim( SerieNfId("SD2",2,"D2_SERIE") ),"NF")

[XXX Encerramento] 