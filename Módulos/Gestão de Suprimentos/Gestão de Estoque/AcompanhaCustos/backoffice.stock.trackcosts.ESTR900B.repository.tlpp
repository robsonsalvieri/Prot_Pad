#include "tlpp-core.th"
#include "protheus.ch"
#include "tbiconn.ch"

namespace totvs.protheus.backoffice.stock.trackcosts.ESTR900B.repository

using namespace totvs.protheus.backoffice.stock.trackcosts.model.D4A

class ESTR900BRepository

    public method New() 

    public method startAsyncESTR900B()
    public method getTotalMovimentsByProduct()
    public method getMaxOrdem()
    public method version()

endclass

/*/{Protheus.doc} ACKardexController:New()
Â Â Â Â Metodo responsavel por instanciar e iniciar as variaveis da class acUser
Â Â Â Â @typeÂ Â Metodo
Â Â Â Â @authorÂ Pedro Missaglia
Â Â Â Â @sinceÂ Â OutubroÂ 02, 2020
Â Â Â Â @versionÂ 12.1.27
/*/
method new() class ESTR900BRepository
   
return Self

/*/{Protheus.doc} ACKardexController:New()
Â Â Â Â Metodo responsavel por instanciar e iniciar as variaveis da class acUser
Â Â Â Â @typeÂ Â Metodo
Â Â Â Â @authorÂ Pedro Missaglia
Â Â Â Â @sinceÂ Â OutubroÂ 02, 2020
Â Â Â Â @versionÂ 12.1.27
/*/
method startAsyncESTR900B(oJson, nQuantTot, oRanges, cType, lReproc, oReproc, lAdvpr) class ESTR900BRepository

Local cIdJob        := Upper(SUBSTR(FWUUIDV1(), 0, 16))
Local cIdConfig     := Alltrim(oJson:GetJsonObject("configuration"))
Local cBranch       := oJson:GetJsonObject("branch")
Local cWare         := oJson:GetJsonObject("warehouse")
Local cProd         := oJson:GetJsonObject("product")

Local nBalanIni     := oJson:GetJsonObject("initialBalance")
Local nBalanFinal   := oJson:GetJsonObject("finalBalance")
Local nQuantIni     := oJson:GetJsonObject("initialQuantity")
Local nQuantFinal   := oJson:GetJsonObject("finalQuantity")

Local nRangeStart   := 0
Local nRangeEnd     := 0
Local nTotal        := 0    
Local lNotInvert    := .F.
Local nRecStart     := 0
Local nRecEnd       := 0

Local cProc         := "ESTR900B"  

Local oObj          := JsonObject():New()
Local oD4A          := totvs.protheus.backoffice.stock.trackcosts.model.D4A.D4A():New()

Default lReproc := .F.
Default oReproc := JsonObject():New()
Default lAdvpr  := .F.

If lReproc 
    cIdJob := oReproc["id"]
Endif

If Empty(cBranch)
    cBranch := cFilAnt
Endif

oObj["D4A_FILIAL"]  := cBranch
oObj["D4A_ID"]      := cIdJob
oObj["D4A_CONFIG"]  := cIdConfig
oObj["D4A_PROC"]    := cProc
oObj["D4A_STATUS"]  := "SETUP"
oObj["D4A_USER"]    := cUserName
oObj["D4A_ERROR"]   := ""
oObj["D4A_STACK"]   := ""
oObj["D4A_DTEXEC"]  := MsDate()
oObj["D4A_HREXEC"]  := SubStr(Time(),1,TamSx3("D4A_HREXEC")[1])
oObj["D4A_BODY"]    := oJson:ToJson()

If lReproc 

    oObj["D4A_THRNUM"]  := oReproc["thread"]
    oObj["D4A_START"]   := oReproc["start"]
    oObj["D4A_END"]     := oReproc["end"]
    oObj["D4A_TOTAL"]   := oReproc["total"]

    oD4A:SEEK(cIdJob, oReproc["thread"], cProc)
    oD4A:UPDATE(oObj)

    If !lAdvpr
        StartJob('ESTR900B',GetEnvServer(),.F.,cEmpAnt,cBranch, cWare, cProd, nBalanIni, nBalanFinal, nQuantIni, nQuantFinal,;
            oReproc["start"], oReproc["end"],.F., cIdJob, cUserName, oReproc["total"],;
            cIdConfig;
        )
    Endif
Else 

    If cType == "MULTI"
        
        //ACIONAMENTO MULTI-THREAD

        nRangeStart := oRanges["thread_01"]:GetJsonObject("start")
        nRangeEnd   := oRanges["thread_01"]:GetJsonObject("end")
        nTotal      := oRanges["thread_01"]:GetJsonObject("total")

        oObj["D4A_THRNUM"]  := "01"
        oObj["D4A_START"]   := nRangeStart
        oObj["D4A_END"]     := nRangeEnd
        oObj["D4A_TOTAL"]   := nTotal

        oD4A:INSERT(oObj)

        If !lAdvpr
            //THREAD 1 - TOTALIZADOR ORDEM INICIO AO FIM
            StartJob('ESTR900B',GetEnvServer(),.F.,cEmpAnt,cBranch, cWare, cProd, nBalanIni, nBalanFinal, nQuantIni, nQuantFinal, nRangeStart, nRangeEnd,.F., cIdJob, cUserName, nTotal, cIdConfig)
        Endif

        nRangeStart := oRanges["thread_02"]:GetJsonObject("start")
        nRangeEnd   := oRanges["thread_02"]:GetJsonObject("end")
        nTotal      := oRanges["thread_02"]:GetJsonObject("total")
        lNotInvert  := oRanges["not_invert"]
        nRecStart   := oRanges["thread_02", 'recStart']
        nRecEnd     := oRanges["thread_02", 'recEnd']

        oObj["D4A_THRNUM"]  := "02"
        oObj["D4A_START"]   := nRangeStart
        oObj["D4A_END"]     := nRangeEnd
        oObj["D4A_TOTAL"]   := nTotal

        oD4A:INSERT(oObj)
        
        If !lAdvpr
            //THREAD 2 - TOTALIZADOR ORDEM FIM AO INICIO
            StartJob('ESTR900B',GetEnvServer(),.F.,cEmpAnt,cBranch, cWare, cProd, nBalanIni, nBalanFinal, nQuantIni, nQuantFinal, nRangeStart, nRangeEnd ,.T., cIdJob, cUserName, nTotal, cIdConfig, lNotInvert, nRecStart, nRecEnd)
        Endif

    Else 
        //ACIONAMENTO MONO-THREAD

        If nQuantTot > 0 
            nRangeStart := oRanges["thread_01"]:GetJsonObject("start")
            nRangeEnd   := oRanges["thread_01"]:GetJsonObject("end")
            nTotal      := oRanges["thread_01"]:GetJsonObject("total")
        Else 
            nRangeStart := 0
            nRangeEnd   := 0
            nTotal      := 0
        Endif 

        oObj["D4A_THRNUM"]  := "01"
        oObj["D4A_START"]   := nRangeStart
        oObj["D4A_END"]     := nRangeEnd
        oObj["D4A_TOTAL"]   := nTotal

        oD4A:INSERT(oObj)

        If !lAdvpr
            StartJob('ESTR900B',GetEnvServer(),.F.,cEmpAnt,cBranch, cWare, cProd, nBalanIni, nBalanFinal, nQuantIni, nQuantFinal, nRangeStart, nRangeEnd,.F., cIdJob, cUserName, nTotal, cIdConfig)
        Endif
    Endif
Endif

return cIdJob

/*/{Protheus.doc} getTotalMovimentsByProduct()
    Metodo responsavel por executar a query de total dos movimentos
    @type Metodo
    @author Pedro Missaglia
    @since Outubro 02, 2020
    @version 12.1.27
/*/
method getTotalMovimentsByProduct(cTable, cQuery, aBindParam) class ESTR900BRepository

    Local nTot as numeric

    If TCCanOpen(cTable)
        
        cQuery  := ChangeQuery(cQuery)
        nTot    := MPSysExecScalar(cQuery,'REG',aBindParam)

    EndIf

return nTot

/*/{Protheus.doc} ACKardexController:New()
Â Â Â Â Metodo responsavel por instanciar e iniciar as variaveis da class acUser
Â Â Â Â @typeÂ Â Metodo
Â Â Â Â @authorÂ Pedro Missaglia
Â Â Â Â @sinceÂ Â OutubroÂ 02, 2020
Â Â Â Â @versionÂ 12.1.27
/*/
method getMaxOrdem(cTable, cQuery, aBindParam) class ESTR900BRepository

Local nTot as numeric

If TCCanOpen(cTable)

    cQuery  := ChangeQuery(cQuery)
    nTot    := MPSysExecScalar(cQuery,'ORDEM',aBindParam)

EndIf

return nTot

/*/{Protheus.doc} version
    Metodo responsavel por indicar a versao da classe
    @type Method
    @author Adriano Vieira
    @since  15/02/2024
    @version 12.1.23.10
/*/
Method version() class ESTR900BRepository
    Local nVersion := 200
Return nVersion
