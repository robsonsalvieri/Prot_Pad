#include "totvs.ch"
#include "msobject.ch"
#include "tlpp-rest.th"
#include "tlpp-core.th"
#include 'fwlibversion.ch'
#include "totvs.framework.treports.integratedprovider.th"
#include "backoffice.sv.est.integratedprovider.CH"
/*/{Protheus.doc} EstIntegratedProvider
Metodo generico para tratamentos de dados do estoque e custos
@author Rodrigo Lombardi
@since 20/09/2024
@version 1.0
/*/
namespace totvs.protheus.backoffice.est.smartView.integratedProvider
using namespace totvs.framework.treports.integratedprovider
class EstIntegratedProvider from IntegratedProvider
    public method new() as object
    public method getSchema() as object
    //public method getFils() as array
    public method retFils() as array

    Protected method GetFiltroSV() as character

    Protected data aFils as Array
    Protected data cWhereFiltroSV as character
        
EndClass

/*/{Protheus.doc} new
    Inicializa a classe principal do integrated provider e gera a classe das filiais
    @author Rodrigo Lombardi
    @since 17/09/2024    
*/
method new() as object class EstIntegratedProvider
    _Super:new()
    self:aFils := {}
return self

/*/{Protheus.doc} getSchema
    Retorna o schema do objeto de negócios cpm o parametro de multifilial
    @author Rodrigo Lombardi
    @since 17/09/2024    
*/
method getSchema() as object class EstIntegratedProvider    
    self:oNGetSchema()

    self:oSchema:addParameter("SV_MULTBRANCH", STR0001, "string", .T.)//Filiais
    self:setCustomURL("SV_MULTBRANCH","api/framework/v1/genericLookupService/smartview/SM0",2)

return self:oSchema

/*/{Protheus.doc} retFils
Faz o tratamento do parametro de multifiliais
@author Rodrigo Lombardi
@since 04/10/2024
@version 1.0
/*/

Method retFils(jParam, oFilter) class EstIntegratedProvider

Local aRet := {} as Array
Local nSize := FwSizeFilial() as Numeric
Local nX    := 0 as Numeric

Default oFilter := Nil

//Protejo o aFils de ser passado vazio
if (Valtype(jParam) == 'U') .or. (Len(jParam) <= 0)
	aRet := {FwCodFil()}
elseif(Len(jParam) == 1 .and. Empty(jParam[1]))
	aadd(aRet,FwCodFil())	
else
    aRet := jParam
EndIf
//Ajusto tamanho do campo filial para não causar problemas
For nX := 1 To Len(aRet)
    aRet[nX] := Padr(aRet[nX], nSize)
Next nX

//Criado método e propriedade que carregas as intruções de filtro recebidas pelo Smart View
If oFilter <> Nil
    self:cWhereFiltroSV := self:GetFiltroSV(oFilter)
EndIf

Return aRet

/*/{Protheus.doc} GetFils
Gera o arquivo de filiais do modo multifilial
@author Rodrigo Lombardi
@since 20/09/2024
@version 1.0
/*/
/*Method getFils(cTable) class EstIntegratedProvider
Local aRet := {} as Array
Local nX   := 1 as numeric
Local cFilAux := '' as Character
Local nLen := len(self:aFils) as Numeric
    if nLen > 0 .or. (nLen==1 .and. !Empty(self:aFils[nLen])) 
        aRet := aClone(Self:aFils)
        if FWModeAccess(cTable) == 'C' 
            for nX := 1 to len(Self:aFils)
                cFilAux := FWxFilial(cTable,Self:aFils[nX])
                if aScan( aRet, cFilAux ) == 0
                    aAdd( aRet, cFilAux )
               endIf
            next        
        EndIf
    Else
        aadd(aRet,FWxFilial(cTable))
   EndIf
Return aRet
*/

/*/{Protheus.doc} retFils
Faz o tratamento do parametro de multifiliais
@author Rodrigo Lombardi
@since 04/10/2024
@version 1.0
/*/

Method GetFiltroSV(oFilter) as character class EstIntegratedProvider

    Local cRetFiltro := " AND " as character

    If !oFilter:hasFilter()
        cRetFiltro := ""
    EndIf

    cRetFiltro += oFilter:getSQLExpression()

Return cRetFiltro
