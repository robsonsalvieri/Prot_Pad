#include "tlpp-core.th"
#include "protheus.ch"
#include "average.ch"

//+-------------------------------------------------------------------+
//| Program: comex.eic.importduties.tlpp                             |
//| Objetivo: Cálculo de tributos CBS, IBS e IS                      |
//| Autor: GitHub Copilot                                             |
//| Data: 30/09/2025                                                  |
//+-------------------------------------------------------------------+
namespace comex.eic
//+-------------------------------------------------------------------+
//| Classe: ImportDuties                                              |
//| Objetivo: Cálculo de tributos CBS, IBS e IS                      |
//+-------------------------------------------------------------------+
CLASS ImportDuties
    
    // Atributos da classe
    DATA nAliquotaImposto   AS NUMERIC   // 4a - Alíquota do imposto
    DATA nReducaoAliquota   AS NUMERIC   // 4b - Redução da alíquota do imposto
    DATA nAliquotaEfetiva   AS NUMERIC   // 4c - Alíquota efetiva
    DATA nBaseImposto       AS NUMERIC   // 4d - Base do imposto
    DATA nReducaoBase       AS NUMERIC   // 4e - Alíquota de redução da base
    DATA nBaseEfetiva       AS NUMERIC   // 4f - Base efetiva
    DATA nValorDevido       AS NUMERIC   // 4g - Valor devido do imposto
    DATA nValorRecolher     AS NUMERIC   // 4h - Valor a recolher do imposto
    DATA dDataBase          AS DATE      // Data base para cálculo
    DATA cTipoTributo       AS CHARACTER // CBS, IBS, IS
    
    // Métodos da classe
    PUBLIC METHOD New(cTributo, nBaseImp, nReduzBase, nAliqImp, nReduzAliq) CONSTRUCTOR
    PUBLIC METHOD Destroy()
    
    // Métodos para definir valores
    PUBLIC METHOD SetAliquotaImposto(nValor)
    PUBLIC METHOD SetReducaoAliquota(nValor) 
    PUBLIC METHOD SetBaseImposto(nValor)
    PUBLIC METHOD SetReducaoBase(nValor)
    PUBLIC METHOD SetDataBase(dData)
    
    // Métodos para obter valores
    PUBLIC METHOD GetAliquotaEfetiva()
    PUBLIC METHOD GetBaseEfetiva()
    PUBLIC METHOD GetValorDevido()
    PUBLIC METHOD GetValorRecolher()
    
    // Métodos principais de cálculo
    METHOD CalcularBaseEfetiva()
    PUBLIC METHOD CalcularTributo()
    METHOD GravarImpostoRecolher()
    
    // Métodos auxiliares
    METHOD ValidarDados()
    METHOD LimparCalculos()
    
ENDCLASS

//+-------------------------------------------------------------------+
//| Método: New - Construtor da classe                               |
//+-------------------------------------------------------------------+
METHOD New(cTributo, nBaseImp, nReduzBase, nAliqImp, nReduzAliq) CLASS ImportDuties
    
    Default cTributo    := "CBS"
    Default nBaseImp    := 0
    Default nReduzBase  := 0
    Default nAliqImp    := 0
    Default nReduzAliq  := 0

    // Inicialização dos atributos
    Self:cTipoTributo      := Upper(AllTrim(cTributo))
    Self:nAliquotaEfetiva  := 0
    Self:nBaseEfetiva      := 0
    Self:nValorDevido      := 0
    Self:nValorRecolher    := 0
    Self:dDataBase         := Date()

    // Usa os setters para garantir validação
    Self:SetBaseImposto(nBaseImp)
    Self:SetReducaoBase(nReduzBase) 
    Self:SetAliquotaImposto(nAliqImp)
    Self:SetReducaoAliquota(nReduzAliq)
Return Self

//+-------------------------------------------------------------------+
//| Método: Destroy - Destrutor da classe                            |
//+-------------------------------------------------------------------+
METHOD Destroy() CLASS ImportDuties
    
    // Limpeza dos atributos
    Self:LimparCalculos()
    
Return

//+-------------------------------------------------------------------+
//| Método: SetAliquotaImposto - Define alíquota do imposto         |
//+-------------------------------------------------------------------+
METHOD SetAliquotaImposto(nValor) CLASS ImportDuties
    Local lRet as logical
    lRet := .F.
    If nValor >= 0
        lRet := .T.
    EndIf
    Self:nAliquotaImposto := nValor
    Self:LimparCalculos() // Limpa cálculos anteriores
Return lRet

//+-------------------------------------------------------------------+
//| Método: SetReducaoAliquota - Define redução da alíquota         |
//+-------------------------------------------------------------------+
METHOD SetReducaoAliquota(nValor) CLASS ImportDuties
    Local lRet as logical
    lRet := .F.
    If nValor >= 0 .And. nValor <= 100
        lRet := .T.
    EndIf
    Self:nReducaoAliquota := nValor
    Self:LimparCalculos() // Limpa cálculos anteriores
Return lRet

//+-------------------------------------------------------------------+
//| Método: SetBaseImposto - Define base do imposto                 |
//+-------------------------------------------------------------------+
METHOD SetBaseImposto(nValor) CLASS ImportDuties
    Local lRet as logical
    lRet := .F.
    If nValor >= 0
        lRet := .T.
    EndIf
    Self:nBaseImposto := nValor
    Self:LimparCalculos() // Limpa cálculos anteriores
Return lRet

//+-------------------------------------------------------------------+
//| Método: SetReducaoBase - Define redução da base                 |
//+-------------------------------------------------------------------+
METHOD SetReducaoBase(nValor) CLASS ImportDuties
    Local lRet as logical
    lRet := .F.
    If nValor >= 0 .And. nValor <= 100
        lRet := .T.
    EndIf
    Self:nReducaoBase := nValor
    Self:LimparCalculos() // Limpa cálculos anteriores
Return lRet

//+-------------------------------------------------------------------+
//| Método: SetDataBase - Define data base para cálculo             |
//+-------------------------------------------------------------------+
METHOD SetDataBase(dData) CLASS ImportDuties
    
    If !Empty(dData)
        Self:dDataBase := dData
    EndIf
    
Return

//+-------------------------------------------------------------------+
//| Método: GetAliquotaEfetiva - Retorna alíquota efetiva          |
//+-------------------------------------------------------------------+
METHOD GetAliquotaEfetiva() CLASS ImportDuties
Return Self:nAliquotaEfetiva

//+-------------------------------------------------------------------+
//| Método: GetBaseEfetiva - Retorna base efetiva                   |
//+-------------------------------------------------------------------+
METHOD GetBaseEfetiva() CLASS ImportDuties
Return Self:nBaseEfetiva

//+-------------------------------------------------------------------+
//| Método: GetValorDevido - Retorna valor devido                   |
//+-------------------------------------------------------------------+
METHOD GetValorDevido() CLASS ImportDuties
Return Self:nValorDevido

//+-------------------------------------------------------------------+
//| Método: GetValorRecolher - Retorna valor a recolher             |
//+-------------------------------------------------------------------+
METHOD GetValorRecolher() CLASS ImportDuties
Return Self:nValorRecolher

//+-------------------------------------------------------------------+
//| Método: CalcularBaseEfetiva - Calcula base efetiva do imposto   |
//+-------------------------------------------------------------------+
METHOD CalcularBaseEfetiva() CLASS ImportDuties
    
    Local nBaseCalculada := 0
    
    // Aplica redução de base quando diferente de zero
    If Self:nReducaoBase > 0
        // Base efetiva = Base original - (Base original * percentual de redução)
        nBaseCalculada := Self:nBaseImposto * (1 - (Self:nReducaoBase / 100))
    Else
        // Sem redução, base efetiva = base original
        nBaseCalculada := Self:nBaseImposto
    EndIf
    
    // Atualiza o atributo base efetiva
    Self:nBaseEfetiva := Round(nBaseCalculada, 2)
    
Return Self:nBaseEfetiva

//+-------------------------------------------------------------------+
//| Método: CalcularTributo - Calcula o tributo                     |
//+-------------------------------------------------------------------+
METHOD CalcularTributo() CLASS ImportDuties
    
    Local lRetorno := .F.
    
    If !Self:ValidarDados()
        Return .F.
    EndIf
    
    // Primeiro calcula a base efetiva
    Self:CalcularBaseEfetiva()
    
    // Calcula alíquota efetiva aplicando redução quando diferente de zero
    If Self:nReducaoAliquota > 0
        // Alíquota efetiva = Alíquota original - (Alíquota original * percentual de redução)
        Self:nAliquotaEfetiva := Self:nAliquotaImposto * (1 - (Self:nReducaoAliquota / 100))
    Else
        // Sem redução, alíquota efetiva = alíquota original
        Self:nAliquotaEfetiva := Self:nAliquotaImposto
    EndIf
    
    // Calcula valor devido = Base efetiva x Alíquota efetiva
    Self:nValorDevido := Round(Self:nBaseEfetiva * (Self:nAliquotaEfetiva / 100), 2)
    
    // Condiciona gravação do valor a recolher ao método GravarImpostoRecolher
    If Self:GravarImpostoRecolher()
        Self:nValorRecolher := Self:nValorDevido
        lRetorno := .T.
    Else
        Self:nValorRecolher := 0
        lRetorno := .T. // Cálculo foi feito, apenas não definiu valor a recolher
    EndIf
    
Return lRetorno

//+-------------------------------------------------------------------+
//| Método: GravarImpostoRecolher - Valida se deve gravar recolher  |
//+-------------------------------------------------------------------+
METHOD GravarImpostoRecolher() CLASS ImportDuties
    
    Local lRetorno := .F.
    Local dDataLimite := CtoD("01/01/2027")
    
    // Condição: database >= 01/01/2027
    If Self:dDataBase >= dDataLimite
        lRetorno := .T.
    EndIf
    
Return lRetorno

//+-------------------------------------------------------------------+
//| Método: ValidarDados - Valida dados para cálculo               |
//+-------------------------------------------------------------------+
METHOD ValidarDados() CLASS ImportDuties
    
    Local lValido := .T.
    
    If Self:nAliquotaImposto < 0
        lValido := .F.
    EndIf
    
    If Self:nBaseImposto <= 0
        lValido := .F.
    EndIf
    
    If Self:nReducaoAliquota < 0 .Or. Self:nReducaoAliquota > 100
        lValido := .F.
    EndIf
    
    If Self:nReducaoBase < 0 .Or. Self:nReducaoBase > 100
        lValido := .F.
    EndIf
    
Return lValido

//+-------------------------------------------------------------------+
//| Método: LimparCalculos - Limpa cálculos anteriores              |
//+-------------------------------------------------------------------+
METHOD LimparCalculos() CLASS ImportDuties
    
    Self:nAliquotaEfetiva := 0
    Self:nBaseEfetiva     := 0
    Self:nValorDevido     := 0
    Self:nValorRecolher   := 0
    
Return
