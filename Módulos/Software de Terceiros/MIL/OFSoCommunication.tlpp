#include 'totvs.ch'
#include "tlpp-core.th"
#include "OFSoCommunication.ch"

//static gravaArqLog := .f.
//static conoutLog := .f.
//static _dir_log_bb_ := "C:\totvs\_log_blackbird\"

/*/{Protheus.doc} OFSoCommunication
	Classe Que vai controlar os envios de dados e tratamentos basicos de lock vindos 
	nas respostas de comunicação

	
	@type class
	@author Vinicius Gati
	@since 06/07/2021
/*/
Class OFSoCommunication
	public Data nCodigoFalhaComunicacao
	Public Data oSoConfig
	Public Method New()
	Public Method SendMessage()
	Public Method Send()
EndClass

/*/{Protheus.doc} New
	Construtor Simples

	@type method
	@author Vinicius Gati
	@since 06/07/2021
/*/
Method New(oSoConfig) Class OFSoCommunication
	default oSoConfig := OFSoConfig():New()
	::oSoConfig := oSoConfig
	::nCodigoFalhaComunicacao := -1
Return SELF


/*/{Protheus.doc} SendMessage
	envia mensagem para SO

	@type method
	@author Vinicius Gati
	@since 12/08/2021
/*/
Method SendMessage(oMessage as object, oOFSoRequest as object) Class OFSoCommunication
return self:Send(oMessage:GetHeader(), oMessage:GetBody(), oOFSoRequest)

/*/{Protheus.doc} Send
	Descricao

	@type method
	@author Vinicius Gati
	@since 20/10/2021
/*/
Method Send(oGatewayHeader, oReqBody, oOFSoRequest) Class OFSoCommunication

	local jResp := JsonObject():New()
	local cHeadRet := ""
	local cResp
	local cXGatProp := oGatewayHeader:ToJson():ToJson()
	local aHeadStr := {;
		"Content-Type: application/json; charset=utf-8",;
		"Ocp-Apim-Subscription-Key: " + self:oSoConfig:GetSubscriptionKey(),;
		"X-Gateway-Properties:" + cXGatProp ;
	}

	//local nOpcao
	//local lEmulator := GetNewPar("MV_XMILJD2",.F.)
	local cJson
	local cErro := ""

	//if conoutLog
	//	Conout(" ")
	//	Conout(" __                         __   __  ")
	//	Conout("|  \ \ / |\ |  /\   |\/| | /  ` /__` ")
	//	Conout("|__/  |  | \| /~~\  |  | | \__, .__/ ")
	//	Conout("                                     ")
	//	Conout(" ")
	//	Conout("URL base : " + self:oSoConfig:GetSoUrl())
	//	Conout("Name     : " + oReqBody:GetName())
	//	Conout("URL      : " + self:oSoConfig:GetSoUrl() + "api/message/route/" + oReqBody:GetName())
	//	Conout(" ")
	//	//Conout("Header: " + cValToChar(aHeadStr[1]))
	//	//Conout("        " + cValToChar(aHeadStr[2]))
	//	//Conout("        " + cValToChar(aHeadStr[3]))
	//	//Conout(" ")
	//	//Conout("Body: " + oReqBody:toJson():toJson() )
	//	//Conout(" ")
	//	//PrintJson(oReqBody:toJson():getJsonObject("data"))
	//	//Conout(" ")
	//endif
		
	//if gravaArqLog
	//	cSufNome := DtoS(dDatabase) + "_" + StrTran(Time(),":","") + ".json"
	//	cNomeArq := _dir_log_bb_ + alltrim(oReqBody:GetName()) + "_request_" + cSufNome
	//	oFWriter := FWFileWriter():New(cNomeArq , .t.)
	//	oFWriter:Create()
	//	cJsonEnvio := alltrim(encodeUtf8(oReqBody:toJson():toJson()))
	//	oFWriter:Write( cJsonEnvio )
	//	oFWriter:Close()
	//endif

	//if lEmulator
	//	nOpcao := 1 // 200
	//	//nOpcao := 2 // 500
	//	//nOpcao := Aviso("HTTPPost - Emulador","Qual resposta deseja testar?",{"200","500"},3)
	//	if nOpcao == 2
	//		cResp := '{"obs":"MOCK SERVICE","name":"' + oReqBody:GetName() + '","parameters":null}'
	//		cHeadRet := "HTTP/1.1 500 Internal Server Error" + CHR(13) + CHR(10) +;
	//			"Transfer-Encoding: chunked" + CHR(13) + CHR(10) +;
	//			"Content-Type: application/json" + CHR(13) + CHR(10) +;
	//			"Request-Context: appId=cid-v1:03ef7d2a-f4de-4c18-a4d7-4a8f96e0f72c" + CHR(13) + CHR(10) +;
	//			"Strict-Transport-Security: max-age=2592000" + CHR(13) + CHR(10) +;
	//			"Set-Cookie: ARRAffinity=4bb1b0bab661d5bcad69aba2666af916fb75f56b306edaab26eef8d696250275;Path=/;HttpOnly;Secure;Domain=jd-bb-tot-ct-mig-app.azurewebsites.net" + CHR(13) + CHR(10) +;
	//			"Set-Cookie: ARRAffinitySameSite=4bb1b0bab661d5bcad69aba2666af916fb75f56b306edaab26eef8d696250275;Path=/;HttpOnly;SameSite=None;Secure;Domain=jd-bb-tot-ct-mig-app.azurewebsites.net" + CHR(13) + CHR(10) +;
	//			"X-Powered-By: ASP.NET" + CHR(13) + CHR(10) +;
	//			"Date: Fri, 24 Dec 2021 11:43:14 GMT"
	//	else 
	//		cResp := '{"obs":"MOCK SERVICE","name":"' + oReqBody:GetName() + '","parameters":null}'
	//		cHeadRet := "HTTP/1.1 200 OK" + CHR(13) + CHR(10) +;
	//			"Transfer-Encoding: chunked" + CHR(13) + CHR(10) +;
	//			"Content-Type: application/json" + CHR(13) + CHR(10) +;
	//			"Request-Context: appId=cid-v1:03ef7d2a-f4de-4c18-a4d7-4a8f96e0f72c" + CHR(13) + CHR(10) +;
	//			"Strict-Transport-Security: max-age=2592000" + CHR(13) + CHR(10) +;
	//			"Set-Cookie: ARRAffinity=4bb1b0bab661d5bcad69aba2666af916fb75f56b306edaab26eef8d696250275;Path=/;HttpOnly;Secure;Domain=jd-bb-tot-ct-mig-app.azurewebsites.net" + CHR(13) + CHR(10) +;
	//			"Set-Cookie: ARRAffinitySameSite=4bb1b0bab661d5bcad69aba2666af916fb75f56b306edaab26eef8d696250275;Path=/;HttpOnly;SameSite=None;Secure;Domain=jd-bb-tot-ct-mig-app.azurewebsites.net" + CHR(13) + CHR(10) +;
	//			"X-Powered-By: ASP.NET" + CHR(13) + CHR(10) +;
	//			"Date: Mon, 03 Jan 2022 16:38:59 GMT"
	//	endif
	//
	//	CONOUT(" ")
	//	Conout("       __   __       ")
	//	Conout(" |\/| /  \ /  ` |__/ ")
	//	Conout(" |  | \__/ \__, |  \ ")
	//	Conout("                     ")
	//	CONOUT(" ")
	//
	//else
		//cResp := HttpPost(self:oSoConfig:GetSoUrl() + "api/message/route/" + oReqBody:GetName(),,oReqBody:toJson():toJson(), 60, aHeadStr, @cHeadRet)
//		cJsonEnvio := alltrim(encodeUtf8(oReqBody:toJson():toJson()))
		cJsonEnvio := FMX_RmvAcent( alltrim( encodeUtf8(  FGX_JsonToText( oReqBody:toJson() ))) )
		cJson      := FGX_JSONform( cJsonEnvio, .T., @cErro )
		oOFSoRequest:Set("VK5_REQBOD", cJson)
		oOFSoRequest:Save()
		cErro := ""

		cResp := HttpPost(self:oSoConfig:GetSoUrl() + "api/message/route/" + oReqBody:GetName(),,cJsonEnvio, 60, aHeadStr, @cHeadRet)
	//endif


	if cResp != nil
		cParse := jResp:fromJson(cResp)
		if ValType(cParse) == "U"
			if valtype(oOFSoRequest) != 'U'
//				oOFSoRequest:Set("VK5_REQHEA", cXGatProp)
//				oOFSoRequest:Set("VK5_RESBOD", jResp:toJson())
				cJson := FGX_JSONform( cXGatProp, .T., @cErro )
				oOFSoRequest:Set("VK5_REQHEA", iif( empty( cErro ), cJson, cXGatProp ) )
				cErro := ""
				cJson := FGX_JSONform( jResp:toJson(), .T., @cErro )
				oOFSoRequest:Set("VK5_RESBOD", iif( empty( cErro ), cJson, jResp:toJson() ) )
				oOFSoRequest:Set("VK5_RESHEA", cHeadRet)
				oOFSoRequest:Set("VK5_RESCOD", Val(strToKarr(AllTrim(MemoLine(cHeadRet,,1))," ")[2]))
				oOFSoRequest:Save()
			endif

			//if gravaArqLog
			//	cNomeArq := _dir_log_bb_ + alltrim(oReqBody:GetName()) + "_response_" + cSufNome
			//	conout(STR0001 + cNomeArq)	// "Req detail: "
			//	oFWriter := FWFileWriter():New(cNomeArq , .t.)
			//	oFWriter:Create()
			//	oFWriter:Write( jResp:toJson() )
			//	oFWriter:Close()
			//endif
			return jResp
		endif
	else
		error := JsonObject():New()
		error["message"] := STR0002	// "Falha de comunicação"
		error["code"] := self:nCodigoFalhaComunicacao
		jResp["code"] := self:nCodigoFalhaComunicacao
		jResp["errors"] := {error}
	endif

	Conout(" ")
	conout(STR0003)	// "SERVICE OPERATIONS ERROR: Erro de comunicacao - Nao foi possivel obter resposta do servidor configurado"
	Conout(" ")

	//VarInfo("cResp",cResp)

Return jResp
