
#include "PLSMGER.CH"
/*/


Ŀ
Programa  PLSA206   Autor  Tulio Cesar           Data  29.11.2002 
Ĵ
Descrio  Cadastro de Lancamentos para o Pagamento Prestadores       
Ĵ
Uso        Advanced Protheus                                          
Ĵ
Parametros Nenhum                                                     
Ĵ
            ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL           
Ĵ
Programador  Data    BOPS   Motivo da Alterao                     
Ĵ
ٱ


/*/
Function PLSA206
//Ŀ
// Define variaveis PRIVATE...                                              
//
PRIVATE aRotina   := MenuDef()
PRIVATE cCadastro := "Lancamentos Pagamentos"
PRIVATE cAlias    := "BLR"
//Ŀ
// Verifica a chamada de acordo com tipo...                            
//
If !Empty(PLSINTPAD())
    PLSCRIABLR(PLSINTPAD())
Else
    Return
EndIf    

BLR->(mBrowse(ndLinIni,ndColIni,ndLinFin,ndColFin,cAlias))

BLR->(DbClearFilter())
//Ŀ
// Fim da Rotina                                                       
//
Return              
/*/


Ŀ
Funcao     PLSA206Num  Autor  Tulio Cesar           Data  15.03.01 
Ĵ
Descricao  Retorna o proximo codigo                                    
ٱ


/*/
Function PLSA206Num(cCodInt,cPropri)
LOCAL nRet    := 0
LOCAL nOrdBLR := BLR->(IndexOrd())
LOCAL nTam    := Len(BLR->BLR_CODLAN)

BLR->(DbSetOrder(1))

BLR->(DbSeek(xFilial("BLR")+cPropri+cCodInt+Replicate("9",nTam),.T.))
BLR->(DbSkip(-1))

If BLR->(BLR_FILIAL+BLR_PROPRI+BLR_CODINT) <> xFilial("BLR")+cPropri+cCodInt
   nRet := StrZero(1,nTam)
Else
   nRet := StrZero(Val(BLR->BLR_CODLAN)+1,nTam)
Endif

BLR->(DbSetOrder(nOrdBLR))

Return(nRet)
/*/


Ŀ
Programa   PLSA206MOV  Autor  Tulio Cesar        Data  13.07.1999 
Ĵ
Descrio  Movimentacao da TDE.                                       
Ĵ
Uso        PLSA206()                                                  
Ĵ
Parametros Padrao do mBrowse                                          
ٱ


/*/
Function PLSA206MOV(cAlias,nReg,nOpc)
Local I__f := 0
//Ŀ
// Define variaveis LOCAL...                                                
//
LOCAL nOpcA      := 0
LOCAL bDelLine   := { || lRet := (BLR->BLR_PROPRI == "9"), ;
                         If(!lRet,MsgStop("No  permitido excluir lancamento de pagamento cujo proprietrio  o sistema."),nil), ;
                         If(lRet,lRet:=PLSA206Del(nOpc),nil), lRet }
LOCAL bEdit      := bDelLine
LOCAL nRegAnt    := nReg
Local aPosObj   := {}
Local aObjects  := {}
Local aSize     := {}
Local aInfo     := {}
//Ŀ
// Define variaveis...                                                      
//
PRIVATE oDlg
PRIVATE aTELA[0][0]
PRIVATE aGETS[0]
PRIVATE aVetTrab := {}
PRIVATE aChave   
PRIVATE oEnchoice
PRIVATE oGet
PRIVATE bOK      := {|| nOpca := 1,If(Obrigatorio(aGets,aTela),oDlg:End(),nOpca:=2),If(nOpca==1,oDlg:End(),.F.) }
PRIVATE bCancel  := {||oDlg:End()}   
PRIVATE n        := 1
//Ŀ
// Testa se pode editar ou excluir...                                       
//
If nOpc == K_Excluir .And. ! Eval(bDelLine)
   Return
Endif
//Ŀ
// Monta aCols's e aHeader's da composicao de cobranca...                   
//
aCols   := {}
aHeader := {}
Store Header "BLS" TO aHeader For .T.

If nOpc == K_Incluir
   Copy "BLR" TO Memory Blank
   Store COLS Blank "BLS" TO aCols FROM aHeader
Else
   Copy "BLR" TO Memory  
	
   BLS->(DbSetOrder(1))
   If	BLS->(DbSeek(xFilial("BLS")+BLR->(BLR_CODINT+BLR_PROPRI+BLR_CODLAN)))
     	STORE COLS "BLS" TO aCols FROM aHeader VETTRAB aVetTrab While BLS->(BLS_FILIAL+BLS_CODINT+BLS_CODLAN) == BLR->(BLR_FILIAL+BLR_CODINT+BLR_PROPRI+BLR_CODLAN)
   Else
     	Store COLS Blank "BLS" TO aCols FROM aHeader
   EndIf
EndIf        
BLR->(DbGoTo(nRegAnt))
//Ŀ
// Inicia a construcao do Dialogo com usuario...                            
//
aSize := MsAdvSize()
aObjects := {}       
AAdd( aObjects, { 1, 1, .T., .T., .F. } )
AAdd( aObjects, { 1, 1, .T., .T., .F. } )

aInfo := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
aPosObj := MsObjSize( aInfo, aObjects )

DEFINE MSDIALOG oDlg TITLE cCadastro FROM aSize[7],0 To aSize[6],aSize[5] OF GetWndDefault() Pixel
//Ŀ
// Monta Enchoice...                                                        
//
oEnchoice := MSMGET():New(cAlias,nReg,nOpc,,,,,aPosObj[1],,,,,,oDlg,,,.F.)
//Ŀ
// Monta GetDados ...                                                       
//
oGet := TPLSBrw():New(aPosObj[2][1],aPosObj[2][2],aPosObj[2][4],aPosObj[2][3],nil,oDlg,nil,,nil,nil,nil,.T.,nil,.T.,nil,aHeader,aCols ,.F.,"BLS",nOpc,PLSRetTit("BLS"))
oGet:aVetTrab := aClone(aVetTrab)                                            
oGet:oBrowse:oBrowse:bWhen := { || M->BLR_PROPRI+M->BLR_CODLAN == "101" .Or. M->BLR_PROPRI <> "1" }
//Ŀ
// Ativa o Dialogo...                                                       
//
ACTIVATE MSDIALOG oDlg ON INIT Eval( { || EnChoiceBar(oDlg,bOK,bCancel,.F.,{}) })
//Ŀ
// Tratamento para atualizacoes...                                          
//
If nOpcA == K_OK
   //Ŀ
   // Trata a exclusao nao podendo haver modificacoes...                       
   //
   If ( nOpc <> K_Visualizar )
      //Ŀ
      // Atualiza Enchoice...                                                     
      //
      BLR->(DbGoTo(nRegAnt))
      PLUPTENC("BLR",nOpc)   	
      //Ŀ
      // Atualiza GetDados Composicao...                                          
      //
      aChave := { {"BLS_CODLAN",M->BLR_PROPRI+M->BLR_CODLAN},{"BLS_CODINT",M->BLR_CODINT} }

      oGet:Grava(aChave)
      ConfirmSX8()
   Endif  
Else
   RollBackSX8()
EndIf
//Ŀ
// Fim da Rotina                                                            
//
Return


Function PLSA206WHE()
LOCAL lRet := .T.

lRet := M->BLS_CALIMP=="1"  .And. Empty(M->BLR_VERBA)


Return(lRet)

/*/


Ŀ
Programa  MenuDef    Autor  Darcio R. Sporl        Data 02/01/2007
Ĵ
Descrio  Utilizacao de menu Funcional                               
                                                                      
                                                                      
Ĵ
Retorno   Array com opcoes da rotina.                                 
Ĵ
ParametrosParametros do array a Rotina:                               
          1. Nome a aparecer no cabecalho                             
          2. Nome da Rotina associada                                 
          3. Reservado                                                
          4. Tipo de Transao a ser efetuada:                        
          		1 - Pesquisa e Posiciona em um Banco de Dados           
              2 - Simplesmente Mostra os Campos                       
              3 - Inclui registros no Bancos de Dados                 
              4 - Altera o registro corrente                          
              5 - Remove o registro corrente do Banco de Dados        
          5. Nivel de acesso                                          
          6. Habilita Menu Funcional                                  
Ĵ
   DATA    Programador   Manutencao efetuada                         
Ĵ
                                                                     
ٱ


/*/
Static Function MenuDef()
     
Private aRotina := {	{ STRPL01  ,'AxPesqui'    , 0 , K_Pesquisar  , 0, .F.},; //'Pesquisar'
											{ STRPL02 ,'PLSA206MOV'  , 0 , K_Visualizar , 0, Nil},; //'Visualizar'	
											{ STRPL03    ,'PLSA206MOV'  , 0 , K_Incluir    , 0, Nil},; //'Incluir'
											{ STRPL04    ,'PLSA206MOV'  , 0 , K_Alterar    , 0, Nil},; //'Alterar'
											{ STRPL05    ,'PLSA206MOV'  , 0 , K_Excluir    , 0, Nil} } //'Excluir'
											
               
                     

	
    	aadd(aRotina, {"Vinculo TISS" , "MsgRun('',,{||PLVINCTIS('BLR',BLR->BLR_CODINT, 1)})", 0 ,K_Visualizar})
		aadd(aRotina, {"Excluir Vinculo TISS" , "MsgRun('',,{||PLVINCTIS('BLR',BLR->BLR_CODINT, 0)})", 0 ,K_Visualizar})                  

										
											
											
Return(aRotina)

/*/


Ŀ
Funcao     PLSA206Del  Autor  Angelo Sperandio       Data  16.03.07 
Ĵ
Descricao  Validacao de exclusao                                        
ٱ


/*/

Static Function PLSA206Del(nOpc)

LOCAL lRet		:= .T.
LOCAL aChaves 	:= {}

If  nOpc # K_Excluir
	Return .T.
Endif

aadd(aChaves,{"BMR","BMR_OPERDA",BLR->BLR_CODINT,"BMR_CODLAN",BLR->BLR_PROPRI+BLR->BLR_CODLAN})

lRet := PLSCHKDEL(aChaves)

Return(lRet)