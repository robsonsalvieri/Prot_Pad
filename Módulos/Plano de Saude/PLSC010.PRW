#INCLUDE "PROTHEUS.CH"
#INCLUDE "PLSMGER.CH"
STATIC cMenu := 0 //Variavel estatica para controlar o MenuDef e o aRotina

/*/


ͻ
Programa   PLSC010   Autor  Angelo Sperandio    Data   27/03/05   
͹
Descricao  Consulta receita x despesa (sinistralidade)                
͹
Uso        Protheus                                                   
ͼ


/*/

Function PLSC010()

//Ŀ
// Inicializa variaveis                                                
//
Private cTipo
Private dDatDe
Private dDatAte
Private lGruEmp   := .F.
Private lSub      := .F.
Private lUsuario  := .F.
Private lJuridico := .F.
Private lFisico   := .F.
Private cPerg     := "PLC010"
//Ŀ
// Atualiza SX1                                                             
//
CriaSX1()
//Ŀ
// Solicita parametros                                                 
//
If  ! Pergunte(cPerg,.T.) 
	Return()
Endif
cTipo   := mv_par01
dDatDe  := mv_par02
dDatAte := mv_par03
//Ŀ
//                                                                     
//
If     cTipo == 1
	   //Ŀ
	   // Cadastra pessoa juridica...                                         
	   //
	   lJuridico := .T.
	   C010Juri()
Elseif cTipo == 2
	   //Ŀ
	   // Cadastra pessoa fisica...                                           
	   //
	   lFisico   := .T.
	   C010Fisi()   
Else
	   lUsuario  := .T.	
	   C010Usu()
Endif                                 
//Ŀ
// Limpa filtros                                                       
//
BA1->( dbClearFilter() )
BQC->( dbClearFilter() )
BA3->( dbClearFilter() )
//Ŀ
// Fim do programa                                                     
//
Return()

/*/


Ŀ
Funo     C010Juri  Autor  Angelo Sperandio       Data  27.03.05 
Ĵ
Descrio  Consulta pessoa juridica                                   
ٱ


/*/

Static Function C010Juri()

//Ŀ
// Inicializa variaveis                                                
//
PRIVATE lPermAbr  := .T.
Private cCadastro := "Cadastro de Familias - Pessoa Juridica"
//Ŀ
// Inicializa variaveis                                                
//
Private aRotina  := {}
PRIVATE aCdCores := {{'BR_VERDE'    ,'Subcontrato Ativo'    },; 
					  {'BR_VERMELHO', 'Subcontrato Bloqueado'}}
							
Private cString := "BQC"

cMenu := 1 //Define menu pessoa juridica
aRotina := MenuDef()

dbSelectArea("BQC")
dbSetOrder(3)

dbSelectArea(cString)

cFiltro := "@BQC_FILIAL = '" + xFilial("BQC") + "' AND D_E_L_E_T_ = ' '"
DbSelectArea("BQC")
SET FILTER TO &cFiltro
BQC->(DbSeek(xFilial("BQC")))

BQC->(mBrowse( 6,1,22,75,cString,,"BQC->BQC_CODBLO<>Space(03)",,,,,,,,, .T. ))
BQC->(DbClearFilter())
//Ŀ
// Fim da funcao                                                       
//
Return()

/*/


Ŀ
Funo     C010Fisi  Autor  Angelo Sperandio       Data  27.03.05 
Ĵ
Descrio  Consulta pessoa fisica                                     
ٱ


/*/

Static Function C010Fisi()

//Ŀ
// Inicializa variaveis                                                
//
Local aCores := {	{ "(nOk := Plsa660Blq()) = 4",'BR_PRETO'   },;
					{ "nOk = 3"                  ,'BR_AMARELO' },;
	             	{ ".T."                      ,'BR_VERDE'   } }
//Ŀ
// Inicializa variaveis                                                
//
PRIVATE lPermAbr  := .T.
Private cCadastro := "Cadastro de Familias - Pessoa Fisica"
//Ŀ
// Incializa variaveis                                                 
//
Private aRotina := { {STRPL01       ,"AxPesqui"  ,0,1} ,;
             		  {STRPL02     ,"AxVisual"  ,0,2} ,;
 					  {"Selecionar"     ,"C010Usu"   ,0,3} ,;
 					  {"Receita/Despesa","C010Chama" ,0,2} ,;
  					  {"Legenda"        ,"PLSA660LEG",0,K_Incluir }} 
PRIVATE aCdCores  	:= { 	{ 'BR_VERDE'    ,'Empresa OK' },; 
							{ 'BR_AMARELO'  ,'Familia(s) Bloqueada(s) Parcial(s)' },;
							{ 'BR_PRETO' 	,'Familia(s) Bloqueada(s)' } }

Private cString := "BG9"

cFiltro := "@BG9_FILIAL = '" + xFilial("BG9") + "' AND BG9_TIPO = '1' AND D_E_L_E_T_ = ' '"
DbSelectArea("BG9")  
dbSetOrder(1)
SET FILTER TO &cFiltro
BG9->(DbSeek(xFilial("BG9")))

dbSelectArea(cString)

BG9->(DbSeek(xFilial("BG9")))
//Ŀ
// Coloca o subcontrato em EOF() por causa dos inicializadores padroes 
//
BQC->(dbGoto(LastRec()+1))

BG9->(mBrowse( 6,1,22,75,cString,,,,,,aCores,,,,, .T. ))
BG9->(dbClearFilter())                                                                 
//Ŀ
// Fim da funcao                                                       
//
Return()

/*/


Ŀ
Funo     C010Usu   Autor  Angelo Sperandio       Data  27.03.05 
Ĵ
Descrio  Consulta usuario                                           
ٱ


/*/

Function C010Usu()

//Ŀ
// Inicializa variaveis                                                     
//
LOCAL   aCores 	  := {}
PRIVATE aCdCores  := {}
PRIVATE aRotina   :=    {}
PRIVATE lPermAbr  := .T.

aRotina := { { STRPL01       ,"AxPesqui"  , 0 , K_Pesquisar   },;
		 	 { STRPL02      ,"PLSA260MOV", 0 , K_Visualizar 	},;
			 { "Receita/Despesa" ,"C010Chama" , 0 , 3            	},;
			 { "Legenda"    	 ,"PLSA260LEG", 0 , K_Incluir      } }
//Ŀ
// Inicializa variaveis                                                     
//
PRIVATE cAlias    := "BA3"
PRIVATE cCadastro := ""
PRIVATE cFilBA1	  := ""
//Ŀ
// Monta o filtro dos usuarios de acondo com o contrato(PJ) ou Empresa(PF)  
//
If     lJuridico
	   cFilBA1 := "@BA1_FILIAL = '" + xFilial("BA1") + "' AND "
	   cFilBA1 += " BA1_CODINT = '" + Left(BQC->BQC_CODIGO,4) + "' AND "
	   cFilBA1 += " BA1_CODEMP = '" + Substr(BQC->BQC_CODIGO,5,4) + "' AND "
	   cFilBA1 += " BA1_CONEMP = '" + BQC->BQC_NUMCON + "' AND "
	   cFilBA1 += " BA1_VERCON = '" + BQC->BQC_VERCON + "' AND "
	   cFilBA1 += " BA1_SUBCON = '" + BQC->BQC_SUBCON + "' AND "
	   cFilBA1 += " BA1_VERSUB = '" + BQC->BQC_VERSUB + "' AND "
	   cFilBA1 += " D_E_L_E_T_ = ' '"
Elseif lFisico
       cFilBA1 := "@BA1_CODINT = '" + BG9->BG9_CODINT + "' AND BA1_CODEMP = '" + BG9->BG9_CODIGO + "' "
Endif
//Ŀ
// Chama mBrowse padrao...                                                  
//
dbSelectArea("BA1")
If  ! lUsuario
	SET FILTER TO &cFilBA1                             
Endif
aCores   :=	{ 	{ "(BA1->BA1_MOTBLO<>Space(03))",'BR_VERMELHO' },;
				{ "BA1->BA1_MOTBLO==Space(03)"  ,'BR_VERDE'    } }
aCdCores := { 	{ 'BR_VERDE'    ,'Usuario ativo'     },; 
				{ 'BR_VERMELHO' ,'Usuario Bloqueado' } }
//Ŀ
// Browse                                                                   
//
BA1->(DbSetOrder(1))
BA1->(DbSeek(xFilial("BA1")))
BA1->(mBrowse(006,001,022,075,'BA1',,,,,,aCores,,,,, .T. ))
//Ŀ
// Fim da funcao                                                            
//
Return()

/*/


Ŀ
Funo     C010Chama Autor  Angelo Sperandio       Data  27.03.05 
Ĵ
Descrio  Chama funcao padrao de consulta receita/despesa            
ٱ


/*/

Function C010Chama(cAlias,nReg,nOpc)

//Ŀ
// Inicializa variaveis                                                     
//
PLMOVGEN("6",'Custo/Receita',dDatDe,dDatAte,cAlias)
//Ŀ
// Fim da funcao                                                            
//
Return()

/*/


Ŀ
Funcao     CriaSX1   Autor  Angelo Sperandio       Data  05/02/05 
Ĵ
Descricao  Atualiza perguntas                                         
Ĵ
Sintaxe    CriaSX1()                                                  
ٱ


/*/

Static Function CriaSX1()

//Ŀ
// Iniciliza variaveis                                                      
//
Local aRegs	:=	{}
aadd(aRegs,{cPerg,"01","Tipo"             ,"","","mv_ch1","N", 1,0,0,"C","","mv_par01","Juridica" ,"","","","","Fisica","","","","","Pesquisar","","","","","","","","","","","","","","",""})
aadd(aRegs,{cPerg,"02","Data De"          ,"","","mv_ch1","D", 8,0,0,"G","","mv_par02",""         ,"","","","",""      ,"","","","",""         ,"","","","","","","","","","","","","","",""})
aadd(aRegs,{cPerg,"03","Data Ate"         ,"","","mv_ch2","D", 8,0,0,"G","","mv_par03",""          ,"","","","",""      ,"","","","",""         ,"","","","","","","","","","","","","","",""})
//Ŀ
// Atualiza SX1                                                             
//
PlsVldPerg(aRegs)
//Ŀ
// Fim da funcao                                                            
//
Return

/*/


Ŀ
Programa  MenuDef    Autor  Darcio R. Sporl        Data 09/01/2007
Ĵ
Descrio  Utilizacao de menu Funcional                               
                                                                      
                                                                      
Ĵ
Retorno   Array com opcoes da rotina.                                 
Ĵ
ParametrosParametros do array a Rotina:                               
          1. Nome a aparecer no cabecalho                             
          2. Nome da Rotina associada                                 
          3. Reservado                                                
          4. Tipo de Transao a ser efetuada:                        
          		1 - Pesquisa e Posiciona em um Banco de Dados           
              2 - Simplesmente Mostra os Campos                       
              3 - Inclui registros no Bancos de Dados                 
              4 - Altera o registro corrente                          
              5 - Remove o registro corrente do Banco de Dados        
          5. Nivel de acesso                                          
          6. Habilita Menu Funcional                                  
Ĵ
   DATA    Programador   Manutencao efetuada                         
Ĵ
                                                                     
ٱ


/*/
Static Function MenuDef()
Private aRotina := {}

if cMenu == 1 
	aadd(aRotina,{ STRPL01          ,"AxPesqui"  ,0,1		 , 0, .F. })
    aadd(aRotina,{ STRPL02          ,"AxVisual"  ,0,2		 , 0, Nil })
 	aadd(aRotina,{ "Selecionar"     ,"C010Usu"   ,0,3		 , 0, Nil })
 	aadd(aRotina,{ "Receita/Despesa","C010Chama" ,0,1		 , 0, Nil })
  	aadd(aRotina,{ "Legenda"        ,"PLSA660LEG",0,K_Incluir , 0, .F. })
else
	//Pessoa Juridica	
	aadd(aRotina,{ STRPL01          ,"AxPesqui"  ,0,1		 , 0, .F. })
    aadd(aRotina,{ STRPL02          ,"AxVisual"  ,0,2		 , 0, Nil })
 	aadd(aRotina,{ "Selecionar"     ,"C010Usu"   ,0,3		 , 0, Nil })
 	aadd(aRotina,{ "Receita/Despesa Pessoa Juridica","C010Chama" , 0, 1, 0, Nil })
  	aadd(aRotina,{ "Legenda"        ,"PLSA660LEG",0,K_Incluir , 0, .F. })
	
	//Pessoa Fisica
	aadd(aRotina,{ "Receita/Despesa Pessoa Fisica","C010Chama" ,0, 2 })
	
	//Usuario
	aadd(aRotina,{ "Visualizar Usuario"      ,"PLSA260MOV", 0 , K_Visualizar })
	aadd(aRotina,{ "Receita/Despesa Usuario" ,"C010Chama" , 0 , 3            })
	aadd(aRotina,{ "Legenda Usuario"         ,"PLSA260LEG", 0 , K_Incluir    })
endIf

Return(aRotina)