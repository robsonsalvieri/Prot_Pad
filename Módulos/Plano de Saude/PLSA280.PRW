
#include "PLSMGER.CH" 
#include "PLSA280.CH"
#include "PROTHEUS.CH"

/*/


Ŀ
Programa   PLSA280  Autor  Tulio Cesar           Data  24.03.2000 
Ĵ
Descrio  Cadastro de abrangencias                                   
Ĵ
Uso        Advanced Protheus                                          
Ĵ
Parametros Nenhum                                                     
Ĵ
            ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL           
Ĵ
Programador  Data    BOPS   Motivo da Alterao                     
Ĵ
|Michele Tata|17/12/01|      |Retirada do folder de Abrangencia         |
|giba        |        |      |Relacionada                               |
ٱ


/*/
Function PLSA280
//Ŀ
// Declaracao de variaveis...                                          
//
PRIVATE aRotina     := MenuDef()
PRIVATE cCadastro 	:= PlsRetTit("BF7")
//Ŀ
// Chama funcao de Browse...                                           
//
BF7->(DbSetOrder(1))
BF7->(dbGoTop())
BF7->(mBrowse(06,01,22,75,"BF7"))
//Ŀ
// Fim da Rotina Principal...                                          
//
Return Nil
/*/


Ŀ
Funcao     PL280MOV  Autor  Tulio                  Data  23.02.01 
Ĵ
Descricao  Modulo de Manutencao das Abrangencias...                   
Ĵ
Sintaxe    PL280MOV(cAlias,nReg,nOpc)                                 
ٱ


/*/
Function PL280MOV(cAlias,nReg,nOpc)
Local I__f := 0
//Ŀ
// Uso na enchoice...                                                  
//
LOCAL nOpca := 0
LOCAL cChave
//Ŀ
// Dados da Enchoice...                                                
//
PRIVATE aTELA[0][0]
PRIVATE aGETS[0]
PRIVATE oEncBF7
PRIVATE oDlg
//Ŀ
// Genericos...                                                        
//
PRIVATE nOpcx	    := nOpc
PRIVATE nAlt := 015
aSize := MsAdvSize(.T.)
//Ŀ
// Monta Dialogo...                                                    
//
If Val(GetVersao(.F.)) >= 12 //Valida verso 12
	DEFINE MSDIALOG oDlg TITLE cCadastro FROM aSize[7],0 To aSize[6],aSize[5] OF oMainWnd PIXEL
	nAlt := 030
Else
	DEFINE MSDIALOG oDlg TITLE cCadastro FROM 008.2,010.3 TO 034.4,100.3 OF GetWndDefault()
EndIf
//Ŀ
// Define folder...                                                    
//
@ nAlt,003 FOLDER oFolder SIZE 350,175 OF oDlg PIXEL PROMPTS  OemtoAnsi(STR0006) //Abrangencia"

//Ŀ
// ENCHOICE (BF7)                                                      
//
If nOpcx == K_Incluir
	Copy "BF7" TO Memory Blank
Else
	Copy "BF7" TO Memory
Endif
//Ŀ
// MSMGET -> CONTRATO                                                  
//
cAlias:="BF7";nReg:=BF7->(RecNo());oEncBF7 := MSMGet():New(cAlias,nReg,nOpcx,,,,,{005,005,156,343},,,,,,oFolder:aDialogs[1],,,.F.)
//Ŀ
// ABRANGENCIAS RELACIONADAS (BDA)                                     
//
cChave := BF7->BF7_CODORI

//Ŀ
// Ativa Dialog                                                        
//
ACTIVATE MSDIALOG oDlg ON INIT(A280Init(oDlg,{|| nOpca := 1,if(Obrigatorio(aGets,aTela) .And. PLSA280Del(nOpc), Eval({|| oDlg:End()}) ,(nOpca:=3,.F.))},{|| nOpca := 3,oDlg:End()}))
//Ŀ
// Inicio da Rotina de Gravacao dos Dados...                           
//
If 	nOpca == K_OK
	If nOpcx <> K_Visualizar
		BF7->(DbGoTo(nReg))
		PLUPTENC("BF7",nOpcx)
	Endif
Endif
//Ŀ
// Fim da Rotina Principal de Movimentacao                             
//
Return
/*/


Ŀ
Funcao     A280Init    Autor  Tulio Cesar          Data  23.02.01 
Ĵ
Descricao  Barra de Ferramentas                                       
ٱ


/*/
Static Function A280Init(oDlg,bOk,bCancel,lMessageDel)
LOCAL aButtons    := {}
Return(EnchoiceBar(oDlg,bOk,bCancel,.F.,aButtons))

/*/


Ŀ
Funcao     PLSA280Del  Autor  Wagner Mobile Costa  Data  03.10.03 
Ĵ
Descricao  Validacao de delecao do cadastro de acomodacoes            
ٱ


/*/
Function PLSA280Del(nOpc)

LOCAL lRet		:= .T.
LOCAL aChaves 	:= {}


If nOpc # K_Excluir
	Return .T.
Endif

aadd(aChaves,{"BA3","BA3_ABRANG",BF7->(BF7_CODORI)}) //Familias
aadd(aChaves,{"BI3","BI3_ABRANG",BF7->(BF7_CODORI)}) //Produto
aadd(aChaves,{"BL2","BL2_ABRANG",BF7->(BF7_CODORI)}) //Propostas
aadd(aChaves,{"BT6","BT6_ABRANG",BF7->(BF7_CODORI)}) //SubContrato X Produto

lRet := PLSCHKDEL(aChaves)


Return(lRet)

/*/


Ŀ
Programa  MenuDef    Autor  Darcio R. Sporl        Data 02/01/2007
Ĵ
Descrio  Utilizacao de menu Funcional                               
                                                                      
                                                                      
Ĵ
Retorno   Array com opcoes da rotina.                                 
Ĵ
ParametrosParametros do array a Rotina:                               
          1. Nome a aparecer no cabecalho                             
          2. Nome da Rotina associada                                 
          3. Reservado                                                
          4. Tipo de Transao a ser efetuada:                        
          		1 - Pesquisa e Posiciona em um Banco de Dados           
              2 - Simplesmente Mostra os Campos                       
              3 - Inclui registros no Bancos de Dados                 
              4 - Altera o registro corrente                          
              5 - Remove o registro corrente do Banco de Dados        
          5. Nivel de acesso                                          
          6. Habilita Menu Funcional                                  
Ĵ
   DATA    Programador   Manutencao efetuada                         
Ĵ
                                                                     
ٱ


/*/
Static Function MenuDef()
	       Private aRotina := {	{ STR0001	,'AxPesqui' , 0, K_Pesquisar , 0, .F.},; // Pesquisar
	                            { STR0002	,'pl280Mov' , 0, K_Visualizar, 0, Nil},;
									{ STR0003	,'pl280Mov' , 0, K_Incluir   , 0, Nil},;
									{ STR0004 	,'pl280Mov' , 0, K_Alterar   , 0, Nil},;
									{ STR0005 	,'pl280Mov' , 0, K_Excluir   , 0, Nil},;
									{ STR0007 	,'PL280Mun' , 0, K_Alterar   , 0, Nil},;//"Grupo de Municpios"
									{ STR0008 	,'PL280Est' , 0, K_Alterar   , 0, Nil} }//"Grupo de Estados"
Return(aRotina)

/*/


Ŀ
Funcao     PL280Mun   Autor  Microsiga            Data  11.05.15 
Ĵ
Descricao  Validacao de delecao do cadastro de acomodacoes            
ٱ


/*/
Function PL280Mun()    
Local bOK        := {|| nOpca := 1, Eval({|| oDlg:End()})}
Local aDadMunic  := {}    
Local aTrbMunic  := {} 
Local aChave     := {}
Local oDlgMun                   
Local nOpca      := 0     

Private oBrwMunic
Private aCabMunic  := {}
//Ŀ
// Verifica se e um grupo de municipios                                
// 
If BF7->BF7_CODEDI <> "4"
	MsgInfo(STR0009)//"Esta abrangncia no est parametrizada como '4=Regional B - Grupo de Municpios'"
	Return
EndIf
//Ŀ
// Monta a GetDados de municipios                                      
//
If PlsAliasExi("B9B")
	Store Header "B9B" TO aCabMunic For .T.
	                    
	B9B->(DbSetOrder(1))
	If ! B9B->(DbSeek(xFilial("B9B")+BF7->BF7_CODORI))
	   Store COLS Blank "B9B" TO aDadMunic FROM aCabMunic
	Else
	   Store COLS "B9B" TO aDadMunic FROM aCabMunic VETTRAB aTrbMunic While xFilial("B9B")+BF7->BF7_CODORI == B9B->(B9B_FILIAL+B9B_CODORI)
	EndIf
EndIf

DEFINE MSDIALOG oDlgMun TITLE STR0007 FROM 009,000 TO 029,060 OF GetWndDefault() //"Grupo de Municipios"
oDlgMun:lEscClose := .F.

//Ŀ
// Monta o Browse dos Procedimentos                                    
//
oBrwMunic  := TPLSBrw():New(0031,003,237,148,nil  ,oDlgMun,nil    , nil      ,nil    ,nil  , nil, .T.  ,nil   ,.T.   ,nil   ,aCabMunic ,aDadMunic ,.F. ,"B9B" ,3,STR0007 ,,nil,nil,aTrbMunic,/*'PlsVldBHC'*/)

ACTIVATE DIALOG oDlgMun CENTERED ON INIT ( EnchoiceBar(oDlgMun, {|| nOpca:=1,oDlgMun:End()},{|| nOpca:= 0,oDlgMun:End()} ))

If nOpca == 1
	aCabMunic := aClone(oBrwMunic:aHeader)
	aDadMunic := aClone(oBrwMunic:aCols)
	//Ŀ
	// Inicio da Transacao...                                              
	// 
	Begin Transaction
          
	aChave := {}
	aadd(aChave,{"B9B_CODORI",BF7->BF7_CODORI})
	oBrwMunic:nOpc := K_Alterar
	oBrwMunic:Grava(aChave)
	//Ŀ
	// Fim da Transacao...                                                 
	//
	End Transaction   
EndIf

Return      

/*/


Ŀ
Funcao     PL280Est    Autor  Microsiga            Data  11.05.15 
Ĵ
Descricao  Validacao de delecao do cadastro de acomodacoes            
ٱ


/*/
Function PL280Est()    
Local bOK        := {|| nOpca := 1, Eval({|| oDlg:End()})}
Local aDadEstad  := {}    
Local aTrbEstad  := {} 
Local aChave     := {}
Local oDlgEst                   
Local nOpca      := 0    

Private oBrwEstad  
Private aCabEstad  := {}
//Ŀ
// Verifica se e um grupo de municipios                                
// 
If BF7->BF7_CODEDI <> "2"
	MsgInfo(STR0010)//"Esta abrangncia no est parametrizada como '2=Regional A - Grupo de Estados'" 
	Return
EndIf
//Ŀ
// Monta a GetDados de Estadipios                                      
//
If PlsAliasExi("B9C")
	Store Header "B9C" TO aCabEstad For .T.
	                    
	B9C->(DbSetOrder(1))
	If ! B9C->(DbSeek(xFilial("B9C")+BF7->BF7_CODORI))
	   Store COLS Blank "B9C" TO aDadEstad FROM aCabEstad
	Else
	   Store COLS "B9C" TO aDadEstad FROM aCabEstad VETTRAB aTrbEstad While xFilial("B9C")+BF7->BF7_CODORI == B9C->(B9C_FILIAL+B9C_CODORI)
	EndIf
EndIf

DEFINE MSDIALOG oDlgEst TITLE STR0008 FROM 009,000 TO 029,060 OF GetWndDefault() //"Grupo de Estados"
oDlgEst:lEscClose := .F.

//Ŀ
// Monta o Browse dos Procedimentos                                    
//
oBrwEstad  := TPLSBrw():New(0031,003,237,148,nil  ,oDlgEst,nil    , nil      ,nil    ,nil  , nil, .T.  ,nil   ,.T.   ,nil   ,aCabEstad ,aDadEstad ,.F. ,"B9C" ,3,STR0008,,nil,nil,aTrbEstad,/*'PlsVldBHC'*/)

ACTIVATE DIALOG oDlgEst CENTERED ON INIT ( EnchoiceBar(oDlgEst, {|| nOpca:=1,oDlgEst:End()},{|| nOpca:= 0,oDlgEst:End()} ))

If nOpca == 1
	aCabEstad := aClone(oBrwEstad:aHeader)
	aDadEstad := aClone(oBrwEstad:aCols)
	//Ŀ
	// Inicio da Transacao...                                              
	// 
	Begin Transaction
          
	aChave := {}
	aadd(aChave,{"B9C_CODORI",BF7->BF7_CODORI})
	oBrwEstad:nOpc := K_Alterar
	oBrwEstad:Grava(aChave)
	//Ŀ
	// Fim da Transacao...                                                 
	//
	End Transaction   
EndIf

Return               
/*/


Ŀ
Funcao     PL280VEST   Autor  Microsiga            Data  11.05.15 
Ĵ
Descricao  Validacao de estado ja adicionado                          
ٱ


/*/
Function PL280VEST()
Local lRet := .T.
Local nX   := 0
Local nPosEstHea := aScan(oBrwEstad:aHeader,{|x|x[2] == "B9C_ESTADO"})

For nX := 1 to len (oBrwEstad:aCols)
	If oBrwEstad:aCols[nX][nPosEstHea] == M->B9C_ESTADO  
		MsgInfo(STR0011)//"Este estado j foi adicionado"
		lRet := .F.
	EndIf
Next

Return(lRet)  
/*/


Ŀ
Funcao     PL280VMUN   Autor  Microsiga            Data  11.05.15 
Ĵ
Descricao  Validacao de municipio ja adicionado                       
ٱ


/*/
Function PL280VMUN()
Local lRet := .T.
Local nX   := 0
Local nPosEstHea := aScan(oBrwMunic:aHeader,{|x|x[2] == "B9B_CODMUN"})

For nX := 1 to len (oBrwMunic:aCols)
	If oBrwMunic:aCols[nX][nPosEstHea] == M->B9B_CODMUN  
		MsgInfo(STR0012)//"Este municpio j foi adicionado"
		lRet := .F.
	EndIf
Next

Return(lRet)

