
#include "PROTHEUS.CH"
#include "PLSMGER.CH"


//Ŀ
// As funcoes abaixo sao utilizadas no browse de Filme para uma Especialidade.   |
// Sao chamadas na validacao e exclusao de uma linha do Browse oGet42            |
//


/*/


Ŀ
Funcao     PLSBPQVld   Autor  Michele Tatagiba     Data  22.08.02 
Ĵ
Descricao  Valida a inclusao de uma linha no browse de Filme da       
           Especialidade.                                             
ٱ


/*/
Function PLSBPQVld()

LOCAL lRet       := .T.

/*
//Ŀ
// Se foi informado uma valor, e obrigatorio o codigo da Unidade de Medida |
//
If M->BPQ_VLRFIL <> 0 .And. Empty(M->BPQ_CODDOC)
   MsgInfo("Informe uma Unidade de Medida de Valor para o Filme.")
   Return(.F.)
Endif

//Ŀ
// Verifico se o nivel zero e valido                                       |
//
If M->BPQ_VLRFIL == 0 .And. M->BPQ_PERFIL == 0 .And. Empty(M->BPQ_NIVVAL)
   MsgInfo("Informe se o nivel zero e valido.")
   Return(.F.)
Endif
          
BNQ->(DBSetOrder(1))
//Ŀ
// Verifico se existe alguma data de vigencia anterior a essa.             |
//
If BNQ->(DBSeek(xFilial("BNQ")+cCodigo+M->BPQ_CODINT+M->BPQ_CODLOC+M->BPQ_CODESP+M->BPQ_CODSUB+M->BPQ_CODFIL))
   If M->BPQ_VIGDE < BNQ->BNQ_DATDE
      MsgInfo("A data de vigencia do Filme e menor que a ultima data de vigencia "+dtoc(BNQ->BNQ_DATDE))
      Return(.F.)
   Else
      //Ŀ
      // Caso a data de vigencia seja igual a data de, entao verifico o valor da diaria|
      //
      If M->BPQ_VIGDE == BNQ->BNQ_DATDE
         //Ŀ
         // Se o valor do filme for diferente, nao consigo colocar a data final |
         //
         If M->BPQ_VLRFIL <> BNQ->BNQ_VLRFIL
       	    MsgInfo("A data de vigencia do Filme e igual a data da vigencia anterior.")
       	    Return(.F.)
         Else
            //Ŀ
            // Se o percentual da taxa for diferente, nao consigo colocar a data final |
            //         
            If M->BPQ_PERFIL <> BNQ->BNQ_PERFIL
         	   MsgInfo("A data de vigencia do filme e igual a data da vigencia anterior.")
        	   Return(.F.)
            Else
        	   lRet := .T.
        	Endif
         Endif
      Else
         //Ŀ
         // Crio uma nova vigencia de filme                                   |
         //
         nPosScan := aScan(aVetBNQ,{|x| x[2] == M->BPQ_CODINT .And. x[3] == M->BPQ_CODLOC .And.;
                           x[4] == M->BPQ_CODESP .And. x[5] == M->BPQ_CODSUB .And. x[6] == M->BPQ_CODFIL})
         If nPosScan == 0
            aadd(aVetBNQ,{cCodigo,M->BPQ_CODINT,M->BPQ_CODLOC,M->BPQ_CODESP,M->BPQ_CODSUB,M->BPQ_CODFIL,M->BPQ_SEQFIL,M->BPQ_VIGFIL,M->BPQ_VLRFIL,M->BPQ_PERFIL,M->BPQ_NIVVAL,M->BPQ_CODDOC,M->BPQ_VIGDE,ctod("")})
         Else
            aVetBNQ[nPosScan,7]  := M->BPQ_SEQFIL
            aVetBNQ[nPosScan,8]  := M->BPQ_VIGFIL
            aVetBNQ[nPosScan,9]  := M->BPQ_VLRFIL
            aVetBNQ[nPosScan,10] := M->BPQ_PERFIL
            aVetBNQ[nPosScan,11] := M->BPQ_NIVVAL
            aVetBNQ[nPosScan,12] := M->BPQ_CODDOC
            aVetBNQ[nPosScan,13] := M->BPQ_VIGDE
         Endif
            
         lRet := .T.
      Endif
   Endif
Else
   //Ŀ
   // Crio uma nova vigencia do filme                                   |
   //
   nPosScan := aScan(aVetBNQ,{|x| x[2] == M->BPQ_CODINT .And. x[3] == M->BPQ_CODLOC .And.;
                      x[4] == M->BPQ_CODESP .And. x[5] == M->BPQ_CODSUB .And. x[6] == M->BPQ_CODFIL})
   If nPosScan == 0
      aadd(aVetBNQ,{cCodigo,M->BPQ_CODINT,M->BPQ_CODLOC,M->BPQ_CODESP,M->BPQ_CODSUB,M->BPQ_CODFIL,M->BPQ_SEQFIL,M->BPQ_VIGFIL,M->BPQ_VLRFIL,M->BPQ_PERFIL,M->BPQ_NIVVAL,M->BPQ_CODDOC,M->BPQ_VIGDE,ctod("")})
   Else
      aVetBNQ[nPosScan,7]  := M->BPQ_SEQFIL
      aVetBNQ[nPosScan,8]  := M->BPQ_VIGFIL
      aVetBNQ[nPosScan,9]  := M->BPQ_VLRFIL
      aVetBNQ[nPosScan,10] := M->BPQ_PERFIL
      aVetBNQ[nPosScan,11] := M->BPQ_NIVVAL
      aVetBNQ[nPosScan,12] := M->BPQ_CODDOC
      aVetBNQ[nPosScan,13] := M->BPQ_VIGDE
   Endif

   lRet := .T.
Endif
*/
Return(lRet)


/*/


Ŀ
Funcao     PLSBPQDel   Autor  Michele Tatagiba     Data  22.08.02 
Ĵ
Descricao  Valida a exclusao de uma linha no browse de Filme do       
           Local de Atendimento                                       
ٱ


/*/
Function PLSBPQDel()

LOCAL nPosScan
LOCAL nTamCols := 1
/*
If M->BPQ_FLAG == "1"
   lRet := .F.
Endif
*/
nPosScan := aScan(aVetBNQ,{|x| x[1] == cCodigo .And. x[2] == cCodInt .And. x[3] == cCodLoc .And.;
            x[4] == cCodEsp .And. x[5] == cCodSub .And.;
            x[6] == oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_CODFIL")]})
//Ŀ
// Se for exclusao da linha, tiro o dado do vetor                    |
//      
If oGet42:aCols[oGet42:Linha(),Len(oGet42:aHeader)+1]
   If nPosScan <> 0
      aadd(aVetDelBNQ,aVetBNQ[nPosScan])
      nTamCols   := Len(aVetBNQ)
      aDel(aVetBNQ,nPosScan)
      aSize(aVetBNQ,nTamCols-1)
   Endif
Else
   //Ŀ
   // Se for retirar a exclusao, tenho que verificar se os dados daquele linha estavam no vetor   |
   //
   nPosScan := aScan(aVetBNQ,{|x| x[1] == cCodigo .And. x[2] == cCodInt .And. x[3] == cCodLoc .And.;
               x[4] == cCodEsp .And. x[5] == cCodSub .And.;
               x[6] == oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_CODFIL")]})
                
   If nPosScan <> 0
      aadd(aVetBNQ,{cCodigo,cCodInt,cCodLoc,cCodEsp,cCodSub,oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_CODFIL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_SEQFIL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_VIGFIL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_VLRFIL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_PERFIL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_NIVVAL")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_CODDOC")],;
                     oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_VIGDE")],;
                     ctod("")})
                                                    
      nTamCols   := Len(aVetDelBNQ)
      aDel(aVetDelBNQ,nPosScan)
      aSize(aVetDelBNQ,nTamCols-1)
   Endif
Endif

Return(.T.)


/*/


Ŀ
Funcao     PLSBPQWhen  Autor  Michele Tatagiba     Data  22.08.02 
Ĵ
Descricao  Valida o X3_WHEN para os campos do BPQ.                    
ٱ


/*/
Function PLSBPQWhen(cTipo)

LOCAL lRet    := .T.
DEFAULT cTipo := ""
/*
If M->BPQ_FLAG == "1" .And. Empty(cTipo)
   lRet := .F.
Endif
*/
If lRet .And. cTipo == "V" .And. !Empty(M->BPQ_PERFIL)
   lRet := .F.
Endif

If lRet .And. cTipo == "P" .And. !Empty(M->BPQ_VLRFIL)
   lRet := .F.
Endif

If lRet .And. cTipo == "N" .And. (!Empty(M->BPQ_PERFIL) .Or. !Empty(M->BPQ_VLRFIL))
   lRet := .F.
Endif

Return(lRet)

                                 
/*/


Ŀ
Funcao     PLSBPQRet   Autor  Michele Tatagiba     Data  02.10.02 
Ĵ
Descricao  Retorna a data da vigencia em aberto do Filme              
Ĵ
Parametros cCampo - Campo que vai ser retornado                       
ٱ


/*/
Function PLSBPQRet(cCampo)
    
LOCAL cConteu
LOCAL lRet    := .F.

If ValType(&(cCampo)) == "D"
   cConteu := ctod("")
Else
   If ValType(&(cCampo)) == "C"
      cConteu := ""
   Else
      If ValType(&(cCampo)) == "N"
         cConteu := 0
      Endif
   Endif
Endif
      
BP8->(DBSetOrder(1))
If BP8->(DBSeek(xFilial("BP8")+M->BPQ_CODINT+M->BPQ_CODFIL))
   While !BP8->(EOF()) .And. xFilial("BP8")+M->BPQ_CODINT+M->BPQ_CODFIL == BP8->(BP8_FILIAL+BP8_CODINT+BP8_CODIGO) .And.;
         !lRet
         If Empty(BP8->BP8_VIGATE)
            cConteu := &(cCampo)
            lRet    := .T.
         Endif
   BP8->(DBSkip())
   Enddo
Endif

Return(cConteu)


/*/


Ŀ
Funcao     PLSPOSBNQ   Autor  Michele Tatagiba     Data  02.10.02 
Ĵ
Descricao  Verifica se ja existe vigencia para esse registro e se     
           essa esta e menor que a que esta sendo digitada            
ٱ


/*/
Function PLSPOSBNQ()

LOCAL lRet := .T.

BNQ->(DBSetOrder(2))
BNQ->(DBSeek(xFilial("BNQ")+cCodigo+cCodInt+cCodLoc+cCodEsp+cCodSub+M->BPQ_CODFIL))
If M->BPQ_VIGDE < BNQ->BNQ_DATDE
   MsgInfo("A data de vigencia do Filme e menor que a data inicial("+dtoc(BNQ->BNQ_DATDE)+") da vigencia anterior.")
   lRet := .F.
Endif

Return(lRet)

/*/


Ŀ
Funcao     PLSBPQPad   Autor  Michele Tatagiba     Data  06.11.02 
Ĵ
Descricao  Verifica se o filme e padrao                               
ٱ


/*/
Function PLSBPQPad(cOpc)

LOCAL lRet   := .T.
LOCAL nInd   := 1
LOCAL nQtd   := 0

If cOpc == "1"
   While nInd <= Len(oGet42:aCols) .And. lRet

       If (oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODINT")] == cCodInt .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODLOC")] == cCodLoc .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODESP")] == cCodEsp .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODSUB")] == cCodSub .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_PADRAO")] == "1") .Or.;
          (nInd == oGet42:Linha() .And. oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_PADRAO")] == "0")
          If MsgYesNo("Ja existe outro filme cadastrado como padrao. Deseja altera-lo?")
             oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_PADRAO")] := "0"
             oGet42:Atualiza()
          Else
             lRet := .F.
          Endif
       Endif

   nInd ++
   Enddo
Endif

If cOpc == "0"
   While nInd <= Len(oGet42:aCols)

       If (oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODINT")] == cCodInt .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODLOC")] == cCodLoc .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODESP")] == cCodEsp .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_CODSUB")] == cCodSub .And.;
          oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_PADRAO")] == "0") .Or.;
          (nInd == oGet42:Linha() .And. oGet42:aCols[nInd,oGet42:PlRetPos("BPQ_PADRAO")] == "1")
          nQtd ++
       Endif

   nInd ++
   Enddo
      
   If nQtd == Len(oGet42:aCols) .Or. Empty(oGet42:aCols[oGet42:Linha(),oGet42:PlRetPos("BPQ_PADRAO")])
      If MsgYesNo("Nao existe nenhum filme cadastrado como Padrao. Deseja tornar esse padrao?")
         M->BPQ_PADRAO := "1"
      Else
         lRet := .F.
      Endif
   Endif
Endif


Return(lRet)
