#include "tlpp-core.th"
#include "fwmvcdef.ch"

#define SEND_ERROR "3" // Erro de envio
#define PENDING_SEND "1" // Pendente de envio
#define SEND_COMPLETED "2" // Envio finalizado

namespace totvs.protheus.health.plan.unimed

using namespace totvs.protheus.health.plan.api.util

/*/{Protheus.doc} chatauditSendAudit
Realiza a comunicação com o servidor do CHATAUDIT 
@type function
@version 12.1.2410
@author jose.paulo
@since 06/04/2025
@param lShowMessage, logical, exibir mensagem do status do envio
@param lUpdate, logical, atualiza o status do lote após o envio do beneficiário
@return json, objeto com os dados do status do envio
/*/
function chatauditSendAudit() as json

    local oChatAuditApi as object
    local jStatus as json
    local laudit := .T.   
    default lShowMessage := .T.
    default lUpdate := .T.

    jStatus:={"status": "","sendMessage": "","responseMessage": "","showMessage": "","transactionCode": "","sendDate": "","sendTime": "","responseTime": ""}

    if BIU->BIU_STAPRO = "P"       //"A=Aberta;F=Fechada;P=Pendente;T=Enviada;E=Fallha;N=Recebido Não Lido;L=Recebido Lido"
        nRec:= BIU->(RECNO())

        BIU->(RECLOCK("BIU",.F.))
        BIU->BIU_DATGER:=strtran(substr(fwTimeStamp(5, dDataBase),1,19),"T"," ")
        BIU->(MsUnlock())
        
        oChatAuditApi := ChatAuditApiAudit():new(BIV->BIV_DESTCB)

        jStatus["transactionCode"] := BIU->BIU_CODCTR
        lAudit := oChatAuditApi:addChatAudit(BIU->BIU_DESMSG, "1", BIU->BIU_CODCTR)

        if lAudit
            jStatus["responseTime"] := time()
            jStatus["status"] := iif(oChatAuditApi:send(), SEND_COMPLETED, SEND_ERROR)             
            jStatus["responseTime"] := elapTime(jStatus["responseTime"], time())
        endif    
        jStatus["status"] := iif(!lAudit, SEND_ERROR, jStatus["status"])

        jStatus["showMessage"]     := oChatAuditApi:getMessage()
        jStatus["sendMessage"]     := oChatAuditApi:getRequest():toJson()
        jStatus["responseMessage"] := oChatAuditApi:getResponse():toJson()
        jStatus["transactionCode"] := jStatus["transactionCode"]
        jStatus["sendDate"]        := dDataBase
        jStatus["sendTime"]        := time()     

        BIU->(RECLOCK("BIU",.F.))

        BIU->BIU_DATENV := jStatus["sendDate"]
        BIU->BIU_HORENV := jStatus["sendTime"]
        BIU->BIU_MSGRES := jStatus["responseMessage"]
        BIU->BIU_RESULT := jStatus["showMessage"]
        BIU->BIU_TIMERP := jStatus["responseTime"]

        If jStatus["status"] == "3"
            BIU->BIU_STAPRO := "E" // Erro de envio            
            BIU->BIU_MSGERR := jStatus["showMessage"]
        else
            BIU->BIU_STAPRO := "T" 
        EndIf        
        BIU->(MsUnlock())

        Reclock("BIV", .F.)
            BIV->BIV_STAPRO := BIU->BIU_STAPRO
        BIV->(MsUnlock())

        oChatAuditApi:destroy()
        freeObj(oChatAuditApi)

    endif

    if lShowMessage
        iif(jStatus["status"] == SEND_COMPLETED,;
            fwAlertSuccess(jStatus["showMessage"], ""),;
            fwAlertError(jStatus["showMessage"], ""))
    endif

return jStatus

