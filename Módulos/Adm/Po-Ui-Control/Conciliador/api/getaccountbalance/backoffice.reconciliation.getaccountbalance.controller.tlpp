#include "tlpp-core.th"
#include "backoffice.reconciliation.getaccountbalance.controller.ch"

namespace totvs.protheus.backoffice.reconciliation.getaccountbalance
using namespace totvs.protheus.backoffice.reconciliation.util

//-------------------------------------------------------------------
/*/{Protheus.doc} GetAccountBalance
Classe principal de controle, onde é inicializado o EndPoint

@author Totvs
/*/
//-------------------------------------------------------------------
class GetAccountBalance
    public method new()

    @Get("/api/tc/getaccountbalance/")
    public method getAccountBalance()
endclass

//-------------------------------------------------------------------
/*/{Protheus.doc} GetAccountBalance
Metodo construtor

@author Totvs
/*/
//-------------------------------------------------------------------
method new() class GetAccountBalance
return

//-------------------------------------------------------------------
/*/{Protheus.doc} getAccountBalance
Metodo que inicia a chamada das configuracoes de match do conciliador

@author Totvs
/*/
//-------------------------------------------------------------------
method getAccountBalance() class GetAccountBalance
    Local oService  As Object
    Local oField    As Object
    Local jResposta As Json
    Local jProfile  As Json
    Local nPage     As Numeric
    Local nPageSize As Numeric
    Local lResponse As Logical
    Local cChaveRes As Character
    Local cResponse As Character
    Local cRespErro As Character
    Local cDateCQ1 As Character
    Local cTable As Character
    Local cTpSald As Character

    //Inicilaiza variaveis
    oService  := GetAccountBalanceService():getInstance()
    oField    := tcTreatsFilter():new()
    jResposta := JsonObject():new()
    jProfile  := JsonObject():new()
    nPage     := 1
    nPageSize := 1000
    lResponse := .F.
    cChaveRes := "message"
    cResponse := STR0001 //"Resposta inválida."
    cRespErro := STR0002 //"Parâmetros inválidos"

    tcGetPageAndPageSize(nPage,nPageSize)
    cDateCQ1     := oRest:getQueryRequest():GetJsonText("dateCQ1") //Periodo saldo
    cTable       := oRest:getQueryRequest():GetJsonText("table") //Tabela temporaria que vem do front
    cTpSald      := oRest:getQueryRequest():GetJsonText("tpsald") //Tabela temporaria que vem do front

    If !Empty(cDateCQ1) .And. cDateCQ1 <> "null" .And. !Empty(cTable) .And. cTable <> "null"
        jResposta:fromJson(oService:getAccountBalance(nPage, nPageSize, cTable, cDateCQ1, cTpSald))
        If ValType(jResposta:GetJsonText("items")) <> "U" .And. jResposta:GetJsonText("items") <> "null"
            tcAnswerRest(jResposta, .T.)
        EndIf
    Else
        tcSetResponse(lResponse, cChaveRes, cRespErro, .F.)
    EndIf

Return
