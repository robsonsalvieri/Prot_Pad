#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "backoffice.accountingclosing.closingdata.service.ch"

namespace backoffice.accountingclosing.closingdata
using namespace totvs.protheus.backoffice.reconciliation.util
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Classe de serviço, realizada instância e chamada de métodos de serviços

@author Totvs
/*/

//-------------------------------------------------------------------
class AccountClosingService
    Private Data _data as object

    public method new()
    public method getInstance()
    public method checkMandatoryParams()
    
    public method service_post()
    public method service_get()
endclass
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Metodo construtor

@author Totvs
/*/
//-------------------------------------------------------------------
method new() class AccountClosingService
return
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Responsável por instanciar a classe controller

@author Totvs
/*/
//-------------------------------------------------------------------
method getInstance() class AccountClosingService
    static __instance As Object
    
    If ValType(__instance) == "U"
        __instance := AccountClosingService():new()
    EndIf
return
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Responsável por chamar a consulta e parsear o retorno no formato JSON

@author Totvs
/*/
//-------------------------------------------------------------------
method service_get( oJsUriParams as json, nPage as numeric, nPageSize as numeric ) class AccountClosingService
    local jResponse     := JsonObject():new() As Json
    local oData     :=  AccountClosingData():new() as object

    jResponse := oData:data_get(oJsUriParams, nPage, nPageSize)

    iif(oData:lOk,; 
            jResponse := oData:getJSONResponse(),; 
            jResponse := SetRestFault(oData:GetCode(), oData:getMessage())  )

    oData:DeActivate()
    FreeObj(oData)
return jResponse
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Responsável por efetuar o post dos dados fechamento

@author Totvs
/*/
//-------------------------------------------------------------------
method service_post( oJBody as json) class AccountClosingService
    Local jResponse := JsonObject():new() As Json
    local oData     :=  AccountClosingData():getInstance() as object

    jResponse := oData:data_post( oJBody )

    oData:DeActivate()
    FreeObj(oData)
return jResponse
//-------------------------------------------------------------------
/*/{Protheus.doc} AccountClosingService
Responsável por chamar a consulta e parsear o retorno no formato JSON

@author Totvs
/*/
//-------------------------------------------------------------------
method checkMandatoryParams( oJBody as json) class AccountClosingService
    local cMsg   as character
    local lOK    as logical
    local oJRes  as json
    local aItens as array
    local i      as numeric

    aItens := { "range", "currency", "blkcalendar", "blkprocess"}
    oJRes :=  JsonObject():new()
    cMSg  := ""
    lOk   := .T.
    
    for i:=1 to len(aItens)
        if( ojBody[ aItens[i]] == Nil )
            cMsg+= STR0001 + aItens[i] + STR0002 + ", " // Campo aItens[i] nao foi enviado
            lOK := .F.
        endif   
    next

    oJRes["items"]  := {}
    oJRes["result"]   := lOk
    oJRes["message"]:= substr(cMsg, 1, len(cMsg)-2)
return oJRes
