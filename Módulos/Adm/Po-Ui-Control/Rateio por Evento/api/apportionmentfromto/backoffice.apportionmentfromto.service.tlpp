#include "tlpp-core.th"
namespace totvs.protheus.backoffice.apportionmentFromTo

//-------------------------------------------------------------------
/*/{Protheus.doc} ApportionmentFromToService
Classe de serviço, realizada instância e chamada de métodos de serviços

@author Totvs
/*/
//-------------------------------------------------------------------
class ApportionmentFromToService

    private Data aFields as array
    private Data aItemsAux  as array

    public method new()
    public method getInstance()
    public method getAllApportionmentFromTo()
    public method setApportionmentFromTo()
    private method setStruQLL()
endclass

//-------------------------------------------------------------------
/*/{Protheus.doc} getApportionmentFromToService
Metodo construtor

@author Totvs
/*/
//-------------------------------------------------------------------
method new() class ApportionmentFromToService    
return

//-------------------------------------------------------------------
/*/{Protheus.doc} ApportionmentFromToService
Responsável por instanciar a classe controller

@author Totvs
/*/
//-------------------------------------------------------------------
method getInstance() class ApportionmentFromToService
    static __instance As Object
    
    If ValType(__instance) == "U"
        __instance := ApportionmentFromToService():new()
    EndIf
return


//-------------------------------------------------------------------
/*/{Protheus.doc} getApportionmentFromTo
Responsável por chamar o post e parsear o retorno no formato JSON

@author Totvs
/*/
//-------------------------------------------------------------------
method getAllApportionmentFromTo(nPage as Numeric, nPageSize as Numeric, cId as character) class ApportionmentFromToService
    Local oSettings := ApportionmentFromToProtheusData():getData() As Object
    Local jResponse := JsonObject():new() As Json

    oSettings:getAll(nPage, nPageSize, cId)

    IIf(oSettings:lOk,; 
            jResponse := oSettings:getJSONResponse(),; 
            jResponse := SetRestFault(oSettings:GetCode(), oSettings:getMessage()))
    
    oSettings:DeActivate()
    FreeObj(oSettings)
return jResponse



//-------------------------------------------------------------------
/*/{Protheus.doc} setApportionmentFromTo
Responsavel por chamar a consulta e parsear o retorno no formato JSON

@author Totvs
/*/
//-------------------------------------------------------------------
method setApportionmentFromTo(jBody as Json, nOpcAuto as numeric) class ApportionmentFromToService
    Local oDataSettings := ApportionmentFromToProtheusData():getData()    
    Local aResponse := {} as Array

    ::setStruQLL(jBody, @nOpcAuto) 
    aResponse := oDataSettings:setApportionmentFromTo(jBody, nOpcAuto)

    FreeObj(oDataSettings)
return aResponse

//-------------------------------------------------------------------
/*/{Protheus.doc} setStruQLL
Alimenta arrays de header e itens para Cadastro de Rateio - QLL

@author Totvs
/*/
//-------------------------------------------------------------------
method setStruQLL(jBody as Json, nOpcAuto as numeric) class ApportionmentFromToService
    Local nI        := 0  as numeric
    Local nX        := 0  as numeric

    QLL->(dbSetOrder(1))                                                                                                                              

    If jBody:hasProperty("items") 
        
        ::aFields := jBody["items"][1]:GetNames()                                   
           
        //Armazena itens
        For nI := 1 To Len(jBody["items"])
            ::aFields := jBody["items"][nI]:GetNames()            
            ::aItemsAux := {}                         
            For nX := 1 To Len(::aFields)
                If !("FILIAL" $ Upper(::aFields[nI]))
                    aAdd(::aItemsAux, {AllTrim(Upper(::aFields[nX])),; 
                                     jBody["items"][nI][::aFields[nX]],;
                                     Nil})
                EndIf
            Next nX
            aAdd(::aFields, ::aItemsAux)
        Next nI
    EndIf
return
