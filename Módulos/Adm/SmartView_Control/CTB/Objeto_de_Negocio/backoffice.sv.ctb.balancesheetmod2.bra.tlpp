#include "totvs.ch"
#include "msobject.ch"
#include "totvs.framework.treports.integratedprovider.th"
#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "backoffice.sv.ctb.balancesheetmod2.bra.ch"

namespace totvs.protheus.ctb.smartviewintegratedprovider
using namespace control.sv.functions.utils

@totvsFrameworkTReportsIntegratedProvider(active=.T.,team="SIGACTB",tables="CT1, CT2, CT7", NAME="Balanço Modelo 2", country="ALL", initialRelease="12.1.2210")

class BalanceSheetMod2SmartViewBusinessObject from totvs.protheus.ctb.smartviewintegratedprovider.SmartviewCtbFunctions
   
    public method new()                     as object
    public method getDescription()          as character
    public method getCtgGerPlanData()       as object
    public method getCtGerPlanSchema()      as object
    
    public method handleCtgGerPlanParams() 
    public method handleCtgGerPlanAppend()  as object
    public method handleExeCtgGerPlan()     as object

    public method processData()             as json
    public method preSchema()               as object
    public method preData()                 as object     

    public method processCustomData()       as json
    
endclass

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Método de instância da classe
@author author 
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method new() as object class BalanceSheetMod2SmartViewBusinessObject
    _Super:new()
    //Define o nome do Objeto de Negócio
    self:setDisplayName(STR0001)    //"Balanço Modelo 2"
    self:setPergunte("CTR160")      //Indica o pergunte que será utilizado no relatório
return self

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Retorna descrição do objeto
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method getDescription() as character class BalanceSheetMod2SmartViewBusinessObject
return STR0002 //"Objeto contendo informações sobre o Balanço Modelo 2"

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Prepara a estrutura dos campos
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method getCtGerPlanSchema() as object class BalanceSheetMod2SmartViewBusinessObject
    
    self:oSchema:addProperty("COLDB", STR0003, "number", STR0003, "COLDB")  // Saldo Debito
    self:oSchema:addProperty("COLCR", STR0004, "number", STR0004, "COLCR")  // Saldo Credito

return self:oSchema

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Carrega lista de parametros para a memória
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method getCtgGerPlanData(nPage as numeric, oFilter as object) as object class BalanceSheetMod2SmartViewBusinessObject
    //Carrega lista de parametros para a memória
    CTBsetValueMVPAR(oFilter:getParameters(),self:cPergunte)    
    self:handleCtgGerPlanParams( oFilter )
    FreeObj(oFilter:getParameters()) 
return self:oData

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Método para execução do CTGERPLAN
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method handleExeCtgGerPlan(oFilter as object) as object class BalanceSheetMod2SmartViewBusinessObject
//execução da CTGERPLAN
return self:oData

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Método para execução do append
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method handleCtgGerPlanAppend(oFilter as object) as object class BalanceSheetMod2SmartViewBusinessObject
//execução do Append
return self:oData

//-------------------------------------------------------------------
//https://tdn.totvs.com.br/display/tec/ProtheusDOC
/*{Protheus.doc} "backoffice.sv.ctb.balancesheetmod2
Define para os atributos conforme parâmetros informados
@author  author
@since   11/12/2024
@version version
*/
//-------------------------------------------------------------------

method handleCtgGerPlanParams( oFilter ) class BalanceSheetMod2SmartViewBusinessObject
   
    local cContaIni         as Character
    local cContaFim         as Character
    local cMoeda  :=  "01"  as Character
    local cTpsald :=  "1"   as Character
    
    local nIniPage := 1     as Numeric
    Local nDivide := 1      as numeric

    local lImpAntLP         as logical
    Local lImpSint          as Logical 
    Local lPrintZero        as Logical
    Local lSldZerado        as Logical
    Local lQuebrNat         as Logical
    Local lsaltSint         as Logical
    Local lTotG             as Logical
    
    local aSetOfBook        as array
    local aSelFil           as array

    local dDataIni          as Date
    local dDataFim          as Date
    local dDataLP           as Date
    
    ///Parametros do relatorio
    dDataIni    := MV_PAR01                                              // Data Inicial ?                	
    dDataFim    := MV_PAR02                                              // Data Final ?                  	
    cContaIni   := MV_PAR03                                              // Conta Inicial ?               	
    cContaFim   := MV_PAR04                                              // Conta Final ?                 	
    lImpSint    := iIf(MV_PAR05==1 .Or. MV_PAR05==3,.T.,.F.)             // Imprime Contas ?              	
    aSetOfBook  := iIf(!Empty(MV_PAR06),CTBSetOf(MV_PAR06),CTBSetOf("")) // Cod. Config. Livros ?
    lSldZerado  := iIf(MV_PAR07==1,.T.,.F.)                              // Saldos Zerados ?
    cMoeda      := iIf(!empty(MV_PAR08),MV_PAR08,cMoeda)                 // Moeda ?
    nIniPage    := MV_PAR09                                              // Folha  Inicial ?
    cTpsald     := IIf(!Empty(MV_PAR10), PadR(AllTrim(MV_PAR10), TamSX3("CT2_TPSALD")[1]), cTpsald)  // Tipo de Saldo ?
    lQuebrNat   := MV_PAR11                                              // Quebra por Natureza ?         	       
    cFilSeg     := MV_PAR12                                              // Filtra Segmento No. ?
    cConteudIni := MV_PAR13                                              // Conteudo Ini Segmen ?
    cConteudFim := MV_PAR14                                              // Conteudo Fim Segmen ?
    cConteudCont:= MV_PAR15                                              // Conteudo Contido em ?
    lsaltSint   := Iif(MV_PAR16==1,.T.,.F.)                              // Salta Linha Sintet. ?
    lPrintZero  := Iif(MV_PAR17==1,.T.,.F.)                              // Imprime Valor 0.00  ?
    lImpCod     := Iif(MV_PAR18==1,.T.,.F.)                              // Imprime Codigo ?
    nDivide     := IIf(Empty(MV_PAR19),1,MV_PAR19)                       // Divide por ?
    
    //utilizado na seção do antigo R4 mv_par20                           // Imprimir ate o seg. ?
    lImpAntLP   := Iif(MV_PAR21 == 1,.T.,.F.)                            // Posicao Ant. L/P ?
    dDataLP     := MV_PAR22                                              // Data Lucros/Perdas ?
    //Não será utilizado por enquanto treport mv_par23                   // Imprimir ? termos                   	       
    lTotG       := mv_par24                                              // Total geral sera ?  //Se totaliza pelas sinteticas    

    aSelFil     := {xFilial('CT2')}
    
    self:dDataIni       := dDataIni
    self:dDataFim       := dDataFim
    self:cAlias         := "CT7"    //são obrigatórios
    self:cIdent         := ""       //são obrigatórios   
    self:cContaIni      := cContaIni
    self:cContaFim      := cContaFim
    self:cMoeda         := cMoeda
    self:cSaldos        := cTpsald
    self:aSetOfBook     := aSetOfBook
    self:cSegmento      := cFilSeg     
    self:cSegIni        := cConteudIni 
    self:cSegFim        := cConteudFim 
    self:cFiltSegm      := cConteudCont
    self:lNImpMov       := .F.
    self:lImpConta      := .F.
    self:lImpAntLP      := lImpAntLP     
    self:dDataLP        := dDataLP  
    self:nDivide        := nDivide
    self:lVlrZerado     := lSldZerado
    self:aSelFil        := aSelFil
    self:lTodasFil      := .F.
    self:lImpSint       := lImpSint
    
return 

/*/{Protheus.doc} BalanceSheetMod2SmartViewBusinessObject::preSchema
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method preSchema() as object class BalanceSheetMod2SmartViewBusinessObject 
return self:oSchema

/*/{Protheus.doc} BalanceSheetMod2SmartViewBusinessObject::preData
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method preData() as object class BalanceSheetMod2SmartViewBusinessObject 
return self:oData

/*/{Protheus.doc} BalanceSheetMod2SmartViewBusinessObject::processData
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method processData() as json class BalanceSheetMod2SmartViewBusinessObject
return ::jDados

//-------------------------------------------------------------------
/*{Protheus.doc} processCustomData
Utilizado antes do append no data
 
@return object: self:oData
 
@author loex
@since 12/13/2024
@version 1.0
*/
//-------------------------------------------------------------------

method processCustomData() as json class BalanceSheetMod2SmartViewBusinessObject

    ::jDados["COLDB"] := IIF( cArqTmp->(SALDOATUCR - SALDOATUDB) < 0,ABS(cArqTmp->(SALDOATUCR - SALDOATUDB)),0)
    ::jDados["COLCR"] := IIF( cArqTmp->(SALDOATUCR - SALDOATUDB) > 0,ABS(cArqTmp->(SALDOATUCR - SALDOATUDB)),0)

return ::jDados
