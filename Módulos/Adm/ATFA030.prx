STATIC lAtfCont
STATIC lCalcula
STATIC nParCorrec
STATIC lAF030Brw
STATIC __lStruPrj
// *******************************
// Controle de multiplas moedas  *
// *******************************
Static lMultMoed := .T.

//AVP
//Verifica de o AVP esta implantado na base
Static lAvpAtf := .F.
Static lAvpAtf2 := NIL
Static aRecCtb	:= {}
Static lBxProvis := .F.
Static lIsRussia	:= If(cPaisLoc$"RUS",.T.,.F.) // CAZARINI - Flag to indicate if is Russia location

#INCLUDE "ATFA030.CH"
#Include "Protheus.ch"
#Define CONFIRMA 1
#Define REDIGITA 2
#Define ABANDONA 3

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё ATFA030	  Ё Autor Ё Wagner Xavier		  Ё Data Ё 03/08/93 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Baixa de Ativos											 	Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё Generico 													Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function ATFA030(xAutoCab,nOpc,aParamAuto)
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Define Variaveis 																			Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Local nDecimais  	:= Set( _SET_DECIMALS )
Local lAf030Auto 	:= (xAutoCab <> NIL)
Local aAutoCab
Local nX		 	:= 0
Local aArea      	:= GetArea()
Local aAreaSN1		:= SN1->(GetArea())
Local aAreaSN3		:= SN3->(GetArea())
Local lContOn		:= .F.

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Salva a Integridade dos dados de Entrada 								  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Set( _SET_DECIMALS ,20 )
SetKey( VK_F12, { || Pergunte("AFA030",.T.) })

//здддддддддддддддддддддддддддддддддддддддд©
//Ё Define Vari═veis para filtro do browse Ё
//юдддддддддддддддддддддддддддддддддддддддды
Private aIndexFil	:= {}
Private bFiltraBrw
Private cFilPad		:= ""
Private cFilEsp		:= ""

Private cMoedaAtf 	:= GetMV("MV_ATFMOEDA")
Private cMoeda
Private aRotina 	:= MenuDef()
PRIVATE cMarca   	:= GetMark( )
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Define o cabecalho da tela de atualizacoes											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Private cCadastro := STR0006    //"Baixa de Ativos"

Private lPrimlPad := .T.
Private nTotal 	  := 0
Private nHdlPrv   := 0

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Regra de integracao com o modulo SIGAMNT - PARCEIRO NG    Ё
//Ё "N" -- NAO INTEGRA                                        Ё
//Ё "1" -- ALTERACOES NO ATF REPLICARAO NO MNT                Ё
//Ё "2" -- ALTERACOES NO MNT REPLICARAO NO ATF                Ё
//Ё "3" -- ALTERACOES ATUALIZARAO ATF E MNT                   Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Private lUsaMNTAT	:= IIF(ALLTRIM(GETMV("MV_NGMNTAT",.F.,"N")) $ "1/3",.T.,.F.)

//InclusЦo de mesagem de alerta notificando quanto a descontinuaГЦo da rotina ATFA030
//Deve-se utilizar a rotina ATFA036
If !IsInCallStack("AF36Can030") .and. !IsInCallStack("AF060Canc") .and. !IsInCallStack("A320CanBxa") 
	Alert(STR0097)
	Return .F.
EndIf

//AVP
//Verifica de o AVP esta implantado na base
lAvpAtf := AFAvpAtf()

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Interrompe a execuГЦo, caso O pais nЦo utilize o recurso de baixas proporcionais Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cPaisLOC $ "PTG,"
	Help(" ",1,"AF030M01")
	Return .F.
EndIf

ATFXKERNEL()

lAuto 	:= .F.	 // Se for Baixa Automatica recebe .T.
lPrim 	:= .T.
aPos	:= {  8,  4, 11, 74 }
aRotina[1,2] := "AxPesqui"
lAtfCont := IIf(Trim(GetMv("MV_ATFCONT"))="O",.T.,.F.)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Valida configuracao do parametro MV_TIPDEPR                               Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

If cPaisLoc == "BRA"
	If GetMv("MV_TIPDEPR") == "1"
		Help("  ",1,"AF030WRMNU")
		Return .F.
	EndIf
Else
	If GetMv("MV_TIPDEPR") $ "12"
		Help("  ",1,"AF030WRMNU")
		Return .F.
	EndIf
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Se estiver usando o parametro MV_ATFCONT como off-line, nao permite o uso Ё
//Ё desta rotina.                                                             Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Trim(GetMv("MV_ATFCONT"))!="O" 
	IW_MSGBOX(STR0083+Chr(13)+chr(10)+STR0084,STR0066,"STOP") // 'Nao И permitido o uso desta rotina com o parБmetro MV_ATFCONT diferente de "O" (On-Line).' ## 'Altere o parБmetro MV_ATFCONT para "O" (On-Line)' ## "AtenГЦo"
	Return
Endif


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ativa tecla F10 para ativar parametros de lan┤amentos contab.             Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
SetKey( VK_F12, { || Pergunte("AFA030",.T.) } )

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Carrega as perguntas selecionadas:                                     Ё
//Ё mv_par01 - 1 Mostra lan┤amentos cont═beis                              Ё
//Ё            2 NAO Mostra lan┤amentos cont═beis                          Ё
//Ё            3 NAO Contabiliza                                           Ё
//Ё mv_par02 - 1 Aglutina                                                  Ё
//Ё            2 Nao Aglutina                                              Ё
//Ё mv_par03 - ParБmetro utilizado pela localizaГЦo PTG						 Ё
//Ё mv_par04 - 1 ContabilizaГЦo Online											 Ё
//Ё            2 ContabilizaГЦo Off-line										 Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Pergunte("AFA030",.F.)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁCarrega as variaveis publicas com o parametro passado pela rotinaЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If aParamAuto != Nil
	For nX := 1 to Len(aParamAuto)
		cVarParam := Alltrim(Upper(aParamAuto[nX][1]))
		If "MV_PAR" $ cVarParam
			&(cVarParam) := aParamAuto[nX][2]
		EndIf
	Next nX
EndIf

/*
 * Habilita/Desabilita a Contabiliza On-Line da Baixa de Ativo
 */
lContOn	:= Iif(Type("MV_PAR04") == "N",(MV_PAR04 == 1),Iif(Type("MV_PAR03") == "N",(MV_PAR03 == 1),.F.))

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ponto de Entrada                                             Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Default lAF030Brw := ExistBlock("AF030BRW")
If lAF030Brw
	cFilEsp := ExecBlock( "AF030BRW", .F., .F. )
	cFilPad := IIF(ValType(cFilEsp) == "C", cFilEsp, cFilPad )
Endif

// Se nao for rotina automatica
If !lAf030Auto
	If lAtfCont
		Aadd( aRotina, { STR0055, 'AF030Auto("SN3",SN3->(Recno()),6,.T.)' , 0 , 5} )  // "Cancela Autom."
		mBrowse( 6, 1,22,75,"SN3",,,,,, AtfLegenda("SN3"),,,,,,,,cFilPad)
	Else		
		mBrowse( 6, 1,22,75,"SN4",,"N4_MOTIVO",,,,AtfLegenda("SN4"),,,,,,,,cFilPad)
	EndIf
Else
	If lAtfCont
		DbSelectArea("SN3")
		aAutoCab := SN3->(MSArrayXDB(xAutoCab,nil,4))
	Else
		DbSelectArea("SN4")
		aAutoCab := SN4->(MSArrayXDB(xAutoCab,nil,4))
	Endif
	If Len(aAutoCab) > 0
		If nOpc == 4 			// Baixa
			AF030Baixa(If(lAtfCont,"SN3","SN4"),Recno(),4,,,aAutoCab,lAf030Auto,,,lContOn)
		ElseIf nOpc == 5 		// Cancelamento
			IF AF030Cance(If(lAtfCont,"SN3","SN4"),Recno(),5,,.F.,aAutoCab,lAf030Auto)
				If !IsInCallStack("AF060Canc")
					Help(" ",1, "AF036AF030",,STR0106,1, 0,,,,,,{STR0107})//"A baixa  foi realizada pel]a rotina ATFA030 e o cancelamento da mesma sera realizada pelo modelo antigo | Nenhuma aГЦo И necessaria o cancelamento ocorreu com sucesso"
				Endif 
			Endif  
		Endif
	Endif
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Recupera a Integridade dos dados														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
SET( _SET_DECIMALS , nDECIMAIS )
SET KEY VK_F12 TO

RestArea(aAreaSN3)
RestArea(aAreaSN1)
RestArea(aArea)

Return
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Baixa Ё Autor Ё Wagner Xavier		  Ё Data Ё 03/08/93 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Baixa de Ativos											    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё Generico 													Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Baixa(cAlias,nReg,nOpc,aM,lAut,aAutoCab,lAf030Auto,aValidMot,lRetExt,lContOn)
Local onvlVend, lVlVend := .T.
Local cCapital
Local nOpt		 	:= 0
Local nUfir 	 	:= 0
Local lBxFilho  	:= .F.
Local nPosSN4 := 0
Local cChave    	:= ""
Local cBxFilho  	:= "S"
Local lTipo02   	:= .F.
Local nRegAtu   	:= ""
Local nRegProx  	:= ""
Local cBase 	 	:= CriaVar("N1_CBASE")
Local cItem 	 	:= Criavar("N1_ITEM")
Local cTipo     	:= ""
Local cTpSld     	:= ""
Local cSeqReav  	:= CriaVar("N4_SEQREAV")
Local cSeq      	:= CriaVar("N4_SEQ")
Local cNota 	 	:= CriaVar("N1_NFISCAL")
Local cSerie	 	:= CriaVar("N1_NSERIE")
Local cNFItem 	 	:= .T.

// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
Local nX		 := 0
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aVlrOrig 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVlrAcum 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVlrBx   	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVlrDesp 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

Local nVlrCorBem	:= 0,nVlrCorDep := 0
Local nQuant    	:= 0
Local nQtdOrig	 	:= 0, lBaixa := .F.
Local nOrig1 		:= 0
Local cSeekSN4
Local lAF030VLBX	:=  ExistBlock("AF030VLBX")
Local lRet			:= .F.
Local cTipoReav	:= "02/10/12/13/16/17/41/42/50/51/52/53/54"
Local cMoed 		:= ""

//AVP
Local lTemTp14		:= .F.
Local cIdMov 		:= ""
Local nSaveSx8Len	:= GetSx8Len()

//MRG
Local lMargem 		:= .T.
Local lTemTp15		:= .F.

//Verifica a GestЦo de Armas
Local lValArma 		:= .T.

Local cTypesNM		:= IIF(lIsRussia,"/" + AtfNValMod({3,4}, "/"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - main and recoverable models
Local cTypes10		:= IIF(lIsRussia,"/" + AtfNValMod({1}, "/"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - main models
Local cTypes12		:= IIF(lIsRussia,"/" + AtfNValMod({2}, "/"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - recoverable models
Private aVRDACM  := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

Private lSN7      	:= .F.
Private nVlVend		:= Iif(ExistBlock( "AF030VAL" ),ExecBlock("AF030VAL",.F.,.F.), 0)
Private nPercBaixa	:= 100, nValCorDep := 0, nValCorr := 0
Private dBaixa030 	:= dDataBase

// *******************************
// Controle de multiplas moedas  *
// *******************************
Private cPictQtd	:= ""
Private aPicture	:= {}
Private aVlrAtual	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aVlResid 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aValBaixa	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aValDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aDepr 		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private cMotivo		:= "01-Venda"
Private aMotivos	:= {}
Private cArquivo	:= ""
Private nTotal 		:= 0
Private nHdlPrv		:= 0
Private cPadrao		:= ""
Private lQuant    	:= .T.
Private nPercAtiv 	:= 0, lUmaVez := .T.

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Regra de integracao com o modulo SIGAMNT - PARCEIRO NG    Ё
//Ё "N" -- NAO INTEGRA                                        Ё
//Ё "1" -- ALTERACOES NO ATF REPLICARAO NO MNT                Ё
//Ё "2" -- ALTERACOES NO MNT REPLICARAO NO ATF                Ё
//Ё "3" -- ALTERACOES ATUALIZARAO ATF E MNT                   Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Private lUsaMNTAT := IIF(ALLTRIM(GETMV("MV_NGMNTAT",.F.,"N")) $ "1/3",.T.,.F.)
Private cMoedaAtf := GetMV("MV_ATFMOEDA")

Set( _SET_DECIMALS ,20 )
lAuto := .F.
lPrim := .T.

DEFAULT aAutoCab 	:= {}
DEFAULT lAf030Auto 	:= .F.
DEFAULT aValidMot	:= {}
DEFAULT lRetExt		:= .F. // Retorno para chamada externa
DEFAULT lContOn	:= Iif(Type("MV_PAR04") == "N",(MV_PAR04 == 1),Iif(Type("MV_PAR03") == "N",(MV_PAR03 == 1),.F.))
cTipoReav += cTypes10 + cTypesNM + cTypes12
//AVP2
//Verifica implementacao do AVP e AVP parcela
If lAvpAtf2 == NIL
	lAvpAtf2 := AFAvpAtf2()
Endif

If Type("lAtfCont") != "L"
	lAtfCont := IIf(Trim(GetMv("MV_ATFCONT"))="O",.T.,.F.)
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se o registro n└o est═ em uso por outra esta┤└o. Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !SoftLock(cAlias)
	Return .t.
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se o controle de solicitaГУes estА ativado, se sim encerra baixaЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( SuperGetMv( "MV_ATFSOLD", .F. ,"2" ) == "1" ) .And. ( !lAf030Auto ) .And. Alltrim(FunName()) == "ATFA030"
	HELP(" ",1,"AF030SOLD",,STR0065 ,1,0)    //"Utilize a opГЦo Solic. Baixa/Transf, parБmetro de controle de solicitaГУes (MV_ATFSOLD) ativado."
	Return .F.
EndIf

//Valida a existЙncia de uma taxa vАlida para o cАlculo da depreciaГЦo por Мndice
If Upper(AllTrim(SN3->N3_TPDEPR)) == "A"
	lValInd := ATFVALIND()
	If !lValInd
		Return(lValInd)
	EndIf
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica o numero do Lote do modulo Ativo Fixo 						Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cLoteAtf := LoteCont("ATF")

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica tabela de motivos para baixa 							 Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SX5")
dbSeek(xFilial("SX5")+"16")
While SX5->X5_FILIAL+SX5->X5_TABELA == cFilial+"16"
	If Len(aValidMot) > 0
		If aScan(aValidMot,{|cMot| Alltrim(cMot) == Alltrim(SX5->X5_CHAVE) }) > 0
			cCapital := Capital(X5Descri())
			cMotivo := Left(SX5->X5_CHAVE, 2) + "-" + SubStr(cCapital,1,12 )
			AAdd( aMotivos, cMotivo )
		EndIf
	Else
		If !( Alltrim(SX5->X5_CHAVE) $ '08/13/14/15/16/17/18')
			If Alltrim(SX5->X5_CHAVE) = '23'
				If cPaisLoc = "BRA" .and. SuperGetMV("MV_AF30NDV", .F., .F.)   // somente se for brasil e controle de CIAP
					cCapital := Capital(X5Descri())
					AAdd( aMotivos, Left(SX5->X5_CHAVE, 2) + "-" + SubStr(cCapital,1,12) )
				EndIf
			Else
				cCapital := Capital(X5Descri())
				AAdd( aMotivos, Left(SX5->X5_CHAVE, 2) + "-" + SubStr(cCapital,1,12) )
				If SubStr(SX5->X5_CHAVE,1,2 ) = "01"
					cMotivo := Left(SX5->X5_CHAVE, 2) + "-" + SubStr(cCapital,1,12 )
				Endif
			EndIf
		EndIf
	EndIf
	SX5->(dbSkip())
End

//NЦo permite realizar a baixa se a Arma com ativo nЦo estА descartada
lValArma := At710Ativo(SN1->N1_PRODUTO,SN1->N1_NFISCAL,SN1->N1_NSERIE,SN1->N1_ITEM)

If !lValArma
	Return(lValArma)
EndIf


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Pesquisa picture para valores do ativo										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cPictQtd  := PesqPict("SN1","N1_QUANTD", 09)

// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	AtfMultMoe(,,{|x| aAdd( aPicture , PesqPict("SN3","N3_VORIG" + Alltrim(Str(x)), 20) ) })
Else
	aPicture[1] := PesqPict("SN3","N3_VORIG1", 20)
	aPicture[2] := PesqPict("SN3","N3_VORIG2", 20)
	aPicture[3] := PesqPict("SN3","N3_VORIG3", 20)
	aPicture[4] := PesqPict("SN3","N3_VORIG4", 20)
	aPicture[5] := PesqPict("SN3","N3_VORIG5", 20)
EndIf

dbSelectArea(cAlias)
dbSetOrder(1)

If lAtfCont   //cAlias == "SN3"
	
	PcoIniLan("000370")
	While .T.
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Recebe codigo do ativo 	      										 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cBase := SN3->N3_CBASE
		cItem := SN3->N3_ITEM
		cTipo := SN3->N3_TIPO
		cTpSld:= SN3->N3_TPSALDO
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica existencia do Ativo 							        		Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN1")
		dbSetOrder(1)
		dbSeek(xFilial("SN1")+cBase+cItem)
		IF !Found()
			Help(" ",1,"020ATIVO")
			EXIT
		EndIf
		
		If Empty(SN3->N3_CCONTAB)
			Help(" ",1,"A030CTAV")   //Este bem nao tem a conta do bem preenchida. Verifique se ja foi classifcado
			EXIT
		EndIf
		
		nQtdOrig 	:= IIF(SN1->N1_QUANTD == 0,1,SN1->N1_QUANTD)
		nQuant		:= nQtdOrig
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se ativo n└o est═ baixado 				   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF Val( SN3->N3_BAIXA ) # 0
			Help(" ",1,"020BAIXADO")
			EXIT
		EndIf

		If lIsRussia
			If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
				Help(" ",1,"SN3NOOPER") // This asset is not in operation. Put it into operation
				
				EXIT
			Endif
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF lUsaMNTAT .AND. !AFVLBXIntMnt(SN1->N1_CODBEM,dDataBase,"ATFA030")
			EXIT
		ENDIF
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Avalia retorno do ponto de entrada AF030VLBX        Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF lAF030VLBX
			lRet := ExecBlock("AF030VLBX",.F.,.F.,{"ATFA030","MAN"})
			IF ValType(lRet) == "L" .AND. !lRet
				EXIT
			ENDIF
		ENDIF
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Avalia se o ativo possui data de bloqueio           Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		If !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase 
			Help(" ",1,"A030BLOQ")   //Este bem esta bloqueado, nao poder sofrer baixas.
			EXIT
		EndIf
		
		If SN1->N1_STATUS $ "2|3"
			Help(" ",1,"A030BLOQ")   //Este bem esta bloqueado, nao poder sofrer baixas.
			EXIT
		EndIf
	
		If !IsInCallStack("ATFA320")
			If SN1->N1_TPCTRAT $ "2/3"
				Help(" ",1,"AfA030TERC",,STR0072 ,1,0)//"Bens em controle de terceiro somente podem ser baixados pela rotina especifica (ATFA320)"
				EXIT
			EndIf
		Endif

		//AVP
		//Se for Tipo 14, nao sera permitida a baixa a partir dele
		//O correto e fazer a baixa a partir do Tipo 10. 
		If SN3->N3_TIPO == '14'
			Help(" ",1,"A030TP14",, STR0078 +CHR(10)+STR0079,1,0)
			EXIT
		EndIf
		
		If ATFXVerPrj(SN1->N1_CBASE,SN1->N1_ITEM, .T. )
			Exit
		EndIf 
		
		//AVP2
		//Verifica se o bem foi gerado por AVP Parcela
		If Alltrim(SN1->N1_ORIGEM) == 'ATFA460' .and. !lBxProvis
			Help(" ",1,"AF010A460B",,STR0086+CRLF+STR0087+SN1->N1_BASESUP +"-"+SN1->N1_ITEMSUP ,1,0)  //'Este ativo foi gerado a partir do processo de constituiГЦo de provisЦo. Este tipo de ativo nЦo poderА ser baixado diretamente. Baixe o ativo superior (PAI).'###"C.Base-Item: "
			EXIT
		Endif		
	
		aVlrAtual[1] := Iif(SN1->N1_PATRIM # "C", SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1, SN3->N3_VORIG1+SN3->N3_AMPLIA1)
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe(,,{|x| if(x=1,.F.,aVlrAtual[x] := SN3->(&( "N3_VORIG"+Alltrim(Str(x)) )+&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) ) ) })
		Else
			aVlrAtual[2] := SN3->N3_VORIG2+SN3->N3_AMPLIA2
			aVlrAtual[3] := SN3->N3_VORIG3+SN3->N3_AMPLIA3
			aVlrAtual[4] := SN3->N3_VORIG4+SN3->N3_AMPLIA4
			aVlrAtual[5] := SN3->N3_VORIG5+SN3->N3_AMPLIA5
		EndIf
		dDindepr := SN3->N3_DINDEPR
		

		//AVP
		//Tipo 10 e Tipo 14 funcionam em par 
		//Se a baixa for realizada a partir do Tipo 10, os valores de ambos devem ser somados
		If lAvpAtf .and. SN3->N3_TIPO $ ('10' + cTypes10)
			lTemTp14 := AFVerTp14(SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TPSALDO)
		Endif			

		//MRG
		//Tipo 10 e Tipo 15 funcionam em par 
		//Se a baixa for realizada a partir do Tipo 10, os valores de ambos devem ser somados
		If lMargem .and. SN3->N3_TIPO $ ('10#13' + cTypes10)
			lTemTp15 := AFVerTp15(SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TPSALDO)
		Endif			

		dbSelectArea("SN7")
		dbSetOrder(1)
		If dbSeek(xFilial("SN7")+cBase+cItem)
			If Empty(SN7->N7_DTBAIXA)
				nVlVend    := SN7->N7_VLSIMU1
				dBaixa030  := SN7->N7_DTSIMUL
				cMotivo    := SN7->N7_MOTIVO
				cNota      := SN7->N7_NOTA
				cSerie     := SN7->N7_SERIE
				lSN7       := .T.
			EndIf
		Endif
		
		nOpt := 0
		AF030Resid(dDataBase,nQuant,nQtdOrig)
		
		nOpt := Af030DadosBx(	@cBase, @cItem, @cTipo, @nQuant, @nQtdOrig, @nUfir,;
		@onVlVend,@lBxFilho,@lVlVend,@cBxFilho, @cNota, @cSerie,,,lAf030Auto, aAutoCab,.F., aValidMot,@cTpSld,@cNFItem)
		
		IF nOpt == REDIGITA
			Loop
		EndIf
		
		IF nOpt == ABANDONA .OR. nOpt == 0
			Exit
		End
		
		If nOpt == CONFIRMA

			//AVP2
			//Se o bem for classificado como Orcamento, os filhos serao baixados 
			//independendo da escolha do usuacio
			If SN1->N1_PATRIM == 'O' 
				lBxFilho := .T.
			Endif		

			dbSelectArea("SN3")
			If lBxFilho    //Baixa os agregados tipos 1-2-4
				dbSelectArea("SN3")
				cChave := xFilial("SN3")+cBase+cItem
				dbSeek(cChave)
				While !Eof() .And. cChave = SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM
					
					If Val(SN3->N3_BAIXA) != 0
						dbSelectArea("SN3")
						dbSkip()
						Loop
					Endif

					If lIsRussia
						If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
							dbSelectArea("SN3")
							dbSkip()
							Loop
						Endif
					Endif
					
					// Atualiza variavel com a data de inicio de depreciaГЦo
					dDindepr := SN3->N3_DINDEPR
					
					If SN3->N3_TIPO $ cTipoReav
						nRegAtu := SN3->(Recno())
						dbskip()
						If SN3->N3_TIPO $ cTipoReav
							nRegProx := SN3->(Recno())
							lTipo02  := .T.
						Endif
						SN3->(dbGoto(nRegAtu))
					EndIf
					
					If !lUmaVez
						SN1->(MsSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM))
						AF030Resid(dBaixa030,nQuant,nQtdOrig)
						
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						
						aValBaixa[1] := Round((SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1) * nPercAtiv,X3Decimal("N3_VORIG1"))
						aVlrAtual[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
						For nX := 2 to __nQuantas
							
							cMoed	:= Alltrim(Str(nX))
							aValBaixa[nX] := Round((SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)) * nPercAtiv,X3Decimal("N3_VORIG"+cMoed))
							aVlrAtual[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
						Next
						
					Endif

					//AVP
					//Alimento o identificador do movimento para ser gravado no N4_IDMOV
					//Desta forma, todo o processo de baixa tera apenas um identificador
					If Empty(cIdMov)
						cIdMov	:= GetSXENum("SN4","N4_IDMOV",,6)
					Endif
					
					AF030Calc(cAlias, cNota, cSerie, lBxFilho, nQuant,nQtdOrig,,cIDMOV,,,cNFItem)

					If lTipo02
						SN3->(dbGoto(nRegProx))
						lTipo02 := .f.
					Else
						dbSkip()
					EndIf
				EndDo

			//AVP
			//Baixa de Tipos relacionados a AVP
			ElseIf !lBxFilho .and. lAvpAtf .and. SN3->N3_TIPO $ ('10' + cTypes10) .and. lTemTp14

				dbSelectArea("SN3")
				cChave := xFilial("SN3")+cBase+cItem
				dbSeek(cChave)
				While !Eof() .And. cChave = SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM
	                
					// Atualiza variavel com a data de inicio de depreciaГЦo
					dDindepr := SN3->N3_DINDEPR
					
					If Val(SN3->N3_BAIXA) != 0
						dbSelectArea("SN3")
						dbSkip()
						Loop
					Endif

					If lIsRussia
						If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
							dbSelectArea("SN3")
							dbSkip()
							Loop
						Endif
					Endif
					
					//Baixar apenas tipos relacionados a AVP
					If !(SN3->N3_TIPO $ ("10/14" + cTypes10) )
						dbSelectArea("SN3")
						dbSkip()
						Loop
					Endif
	
					If !lUmaVez
						SN1->(MsSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM))
						AF030Resid(dDataBase,nQuant,nQtdOrig)
						
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aValBaixa[1] := Round((SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1) * nPercAtiv,X3Decimal("N3_VORIG1"))
						aVlrAtual[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
						For nX := 2 to __nQuantas

							cMoed	:= Alltrim(Str(nX))
							aValBaixa[nX] := Round((SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)) * nPercAtiv,X3Decimal("N3_VORIG"+cMoed))
							aVlrAtual[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
						Next
						
					Endif

					//AVP
					//Alimento o identificador do movimento para ser gravado no N4_IDMOV
					//Desta forma, todo o processo de baixa tera apenas um identificador
					If Empty(cIdMov)
						cIdMov	:= GetSXENum("SN4","N4_IDMOV",,6)
					Endif

					AF030Calc(cAlias, cNota, cSerie, .T., nQuant,nQtdOrig,,cIDMOV,,,cNFItem)

					SN3->(dbSkip())

				EndDo
			//MRG
			//Baixa de Tipos relacionados a Margem Gerencial
			ElseIf !lBxFilho .and. lMargem .and. SN3->N3_TIPO $ ('10#13' + cTypes10) .and. lTemTp15

				dbSelectArea("SN3")
				cChave := xFilial("SN3")+cBase+cItem
				dbSeek(cChave)
				While !Eof() .And. cChave = SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM
	                
					// Atualiza variavel com a data de inicio de depreciaГЦo
					dDindepr := SN3->N3_DINDEPR
					
					If Val(SN3->N3_BAIXA) != 0
						dbSelectArea("SN3")
						dbSkip()
						Loop
					Endif

					If lIsRussia
						If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
							dbSelectArea("SN3")
							dbSkip()
							Loop
						Endif
					Endif
					
					//Baixar apenas tipos relacionados a AVP
					If !(SN3->N3_TIPO $ ("10#13#15" + cTypes10) )
						dbSelectArea("SN3")
						dbSkip()
						Loop
					Endif
	
					If !lUmaVez
						SN1->(MsSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM))
						AF030Resid(dDataBase,nQuant,nQtdOrig)
						
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aValBaixa[1] := Round((SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1) * nPercAtiv,X3Decimal("N3_VORIG1"))
						aVlrAtual[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
						For nX := 2 to __nQuantas

							cMoed	:= Alltrim(Str(nX))
							aValBaixa[nX] := Round((SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)) * nPercAtiv,X3Decimal("N3_VORIG"+cMoed))
							aVlrAtual[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
						Next
						
					Endif

					//MRG
					//Alimento o identificador do movimento para ser gravado no N4_IDMOV
					//Desta forma, todo o processo de baixa tera apenas um identificador
					If Empty(cIdMov)
						cIdMov	:= GetSXENum("SN4","N4_IDMOV",,6)
					Endif

					AF030Calc(cAlias, cNota, cSerie, .T., nQuant,nQtdOrig,,cIDMOV,,,cNFItem)

					SN3->(dbSkip())

				EndDo


			Else
				AF030Calc(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,,,,,cNFItem)
			Endif

			//AVP
			//Contabilizacao do AVP
			If lAvpAtf .and. Len(aRecCtb) > 0             
				//Contabiliza os movimentos de AVP gerados pela baixa
				AF450CtbAvp (aRecCTB,.F.,@nTotal,@nHdlPrv,@cArquivo,"ATFA030")
				aRecCtb := {}
			Endif

			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Envia para Lancamento Contabil							  Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If nHdlPrv > 0 .AND. lContOn
				RodaProva(nHdlPrv,nTotal)
				cA100Incl(cArquivo,nHdlPrv,3,cLoteAtf,mv_par01 == 1,mv_par02 == 1)
			Endif
			
			lRetExt	:= .T.
			
			Exit
		Endif
	EndDo
	
	PcoFinLan("000370")
Else
	While .T.
		cBase   := SN4->N4_CBASE
		cItem   := SN4->N4_ITEM
		cTipo   := SN4->N4_TIPO
		cSeq    := SN4->N4_SEQ
		cSeqReav:= SN4->N4_SEQREAV
		nPosSN4 := Recno()
		//здддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se ativo n└o est═ baixado 					 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF !Empty(SN4->N4_MOTIVO)
			Help(" ",1,"020BAIXADO")
			EXIT
		EndIf
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF lUsaMNTAT .AND. !AFVLBXIntMnt(SN1->N1_CODBEM,dDataBase,"ATFA030")
			EXIT
		ENDIF
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Avalia retorno do ponto de entrada AF030VLBX        Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF lAF030VLBX
			lRet := ExecBlock("AF030VLBX",.F.,.F.,{"ATFA030","MAN"})
			IF ValType(lRet) == "L" .AND. !lRet
				EXIT
			ENDIF
		ENDIF
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica existencia do Ativo 										   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN1")
		dbSetOrder(1)
		dbSeek(xFilial("SN1")+cBase+cItem)
		IF !Found()
			Help(" ",1,"020ATIVO")
			EXIT
		EndIf
		
		If !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase 
			Help(" ",1,"A030BLOQ")   //Este bem esta bloqueado, nao poder sofrer baixas.
			EXIT
		EndIf
		
		If SN1->N1_STATUS $ "2|3"
			Help(" ",1,"A030BLOQ")   //Este bem esta bloqueado, nao poder sofrer baixas.
			EXIT
		EndIf
	
		If !IsInCallStack("ATFA320")
			If SN1->N1_TPCTRAT $ "2/3"
				Help(" ",1,"AfA030TERC",,STR0072 ,1,0)//"Bens em controle de terceiro somente podem ser baixados pela rotina especifica (ATFA320)"
				EXIT
			EndIf
		EndIf
		
		//AVP2
		//Verifica se o bem foi gerado por AVP Parcela
		If Alltrim(SN1->N1_ORIGEM) == 'ATFA460' .and. !lBxProvis
			Help(" ",1,"AF010A460B",,STR0086+CRLF+STR0087+SN1->N1_BASESUP +"-"+SN1->N1_ITEMSUP ,1,0)  //'Este ativo foi gerado a partir do processo de constituiГЦo de provisЦo. Este tipo de ativo nЦo poderА ser baixado diretamente. Baixe o ativo superior (PAI).'###"C.Base-Item: "
			EXIT
		Endif		

		If ATFXVerPrj(SN1->N1_CBASE,SN1->N1_ITEM, .T. )
			Exit
		EndIf 
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica existencia do Ativo no Arquivo de saldos e valores            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN3")
		dbSetOrder(1)
		If dbSeek(xFilial("SN3")+cBase+cItem+cTipo)
			While !Eof() .And. xFilial()+cBase+cItem+cTipo=SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO
				If SN3->N3_SEQREAV=cSeqReav  .And. cSeq=SN3->N3_SEQ
					If Empty(SN3->N3_CCONTAB)
						Help(" ",1,"A030CTAV")   //Este bem nao tem a conta do bem preenchida. Verifique se ja foi classifcado
						Return
					Else
						Exit
					EndIf
				EndIf
				dbSkip()
			EndDo
		EndIf
		nQtdOrig 	:= IIF(SN1->N1_QUANTD == 0,1,SN1->N1_QUANTD)
		nQuant		:= nQtdOrig
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Procuro por qtdades baixadas                       Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN4")
		nPosSN4 := Recno()
		cSeekSN4 := xFilial()+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO
		If dbSeek(cSeekSN4)
			nQuantAux := 0
			While !Eof() .And. cSeekSN4=N4_FILIAL+N4_CBASE+N4_ITEM+N4_TIPO .And.;
				Dtos(N4_DATA) <=	Dtos(LastDay(GetMv("MV_ULTDEPR")+1))
				
				If SN4->N4_OCORR="01" .And. SN4->N4_TIPOCNT="1" .And.;
					!Empty(SN4->N4_MOTIVO) .And. Dtos(N4_DATA) > Dtos(GetMv("MV_ULTDEPR"))
					If SN3->N3_SEQ != SN4->N4_SEQ .And. nQtdOrig != SN4->N4_QUANTD // baixa Parcial
						nQuantAux += SN4->N4_QUANTD
					EndIf
				EndIf
				dbSkip()
			EndDo
		EndIf
		SN4->(dbGoto(nPosSN4))
		If (Round(NoRound(nQuantAux,5),4)) != (Round(NoRound(nQtdOrig,5),4)) .And. (Round(NoRound(nQuantAux,5),4)) != 0.0000
			nQtdOrig := nQtdOrig - nQuantAux
			nQuant   := nQtdOrig
		EndIf
		//здддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se ativo n└o est═ baixado 					 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN3")
		IF Val( SN3->N3_BAIXA ) # 0
			Help(" ",1,"020BAIXADO")
			EXIT
		EndIf

		If lIsRussia
			If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
				Help(" ",1,"SN3NOOPER") // This asset is not in operation. Put it into operation
				EXIT
			Endif
		Endif
		
		dbSelectArea("SN7")
		dbSetOrder(1)
		If dbSeek(xFilial("SN7")+cBase+cItem)
			If Empty(SN7->N7_DTBAIXA)
				nVlVend    := SN7->N7_VLSIMU1
				dBaixa030  := SN7->N7_DTSIMUL
				cMotivo    := SN7->N7_MOTIVO
				cNota      := SN7->N7_NOTA
				cSerie     := SN7->N7_SERIE
				lSN7       := .T.
			EndIf
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se existem baixas parciais no SN4 - Os valores Originais sem a bai-Ё
		//Ё xa sao do SN3 pois em arquivos importados pode nao ter os valores originais Ё
		//Ё no arquivo de movimentos SN4 - nVlrOrig1,..,5                               Ё
		//Ё Em seguida,localizar as baixas que foram efetuadas para cada tipo de bem -  Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		aVlrOrig[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
		aVlrAcum[1] := SN3->N3_VRDACM1+SN3->N3_VRCDA1
		
		For nX := 2 To __nQuantas
			cMoed	:= Alltrim(Str(nX))
			aVlrOrig[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
			aVlrAcum[nX] := SN3->&(If(nX>9,"N3_VRDAC","N3_VRDACM")+cMoed)
		Next
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Localizar Baixas que ocorreram apos o ultimo calculo (MV_UTLDEPR)paraЁ
		//Ё que seus valores, valores do custo e das depreciacoes, sejam subtrai-Ё
		//Ё dos do Valor Atual- nVlrAtual1,..,5. e das depreciacoes acumuladas.  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN4")
		dbSeek(xFilial("SN4")+cBase+cItem+cTipo)
		While !Eof() .And. xFilial("SN4")+cBase+cItem+cTipo=SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO
			If Dtos(SN4->N4_DATA)<= Dtos(GetMv("MV_ULTDEPR"))
				dbSkip()
				Loop
			Endif
			If cSeqReav != SN4->N4_SEQREAV .Or. Empty(SN4->N4_MOTIVO)
				dbSkip()
				Loop
			EndIf
			If SN4->N4_TIPOCNT == "1"     //CONTA DO BEM
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVlrBx[x] += SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
				Else
					aVlrBx[1] += SN4->N4_VLROC1
					aVlrBx[2] += SN4->N4_VLROC2
					aVlrBx[3] += SN4->N4_VLROC3
					aVlrBx[4] += SN4->N4_VLROC4
					aVlrBx[5] += SN4->N4_VLROC5
				EndIf
			ElseIf SN4->N4_TIPOCNT =="2"  //CONTA DE CORRECAO DO BEM
				
				nVlrCorBem+= SN4->N4_VLROC1
			ElseIf SN4->N4_TIPOCNT =="3"  //CONTA DE DESPESA
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVlrDesp[x] += SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
				Else
					aVlrDesp[1]+= SN4->N4_VLROC1
					aVlrDesp[2]+= SN4->N4_VLROC2
					aVlrDesp[3]+= SN4->N4_VLROC3
					aVlrDesp[4]+= SN4->N4_VLROC4
					aVlrDesp[5]+= SN4->N4_VLROC5
				EndIf
			ElseIf SN4->N4_TIPOCNT =="4"  .And. SN4->N4_OCORR=="01" //CONTA DE DEPREC ACUMULADA
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVlrAcum[x] -= SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
				Else
					aVlrAcum[1]-= SN4->N4_VLROC1
					aVlrAcum[2]-= SN4->N4_VLROC2
					aVlrAcum[3]-= SN4->N4_VLROC3
					aVlrAcum[4]-= SN4->N4_VLROC4
					aVlrAcum[5]-= SN4->N4_VLROC5
				EndIf
			ElseIf SN4->N4_TIPOCNT =="5"  //CONTA DE CORRECAO DA DEP ACUMULADA
				nVlrCorDep+= SN4->N4_VLROC1
			EndIf
			dbSkip()
		EndDo
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe(,,{|x| aVlrAtual[x] := aVlrOrig[x] - aVlrBx[x] })
		Else
			aVlrAtual[1] := aVlrOrig[1] - aVlrBx[1]
			aVlrAtual[2] := aVlrOrig[2] - aVlrBx[2]
			aVlrAtual[3] := aVlrOrig[3] - aVlrBx[3]
			aVlrAtual[4] := aVlrOrig[4] - aVlrBx[4]
			aVlrAtual[5] := aVlrOrig[5] - aVlrBx[5]
		EndIf
		
		If aVlrAtual[1] <= 0
			Help(" ",1,"020BAIXADO")
			EXIT
		Endif
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aVlrAcum[1] += aVlrDesp[1]+nVlrCorDep
			AtfMultMoe(,,{|x| If( x=1 , .F. , aVlrAcum[x] += aVlrDesp[x] ) })
		Else
			aVlrAcum[1] += aVlrDesp[1]+nVlrCorDep
			aVlrAcum[2] += aVlrDesp[2]
			aVlrAcum[3] += aVlrDesp[3]
			aVlrAcum[4] += aVlrDesp[4]
			aVlrAcum[5] += aVlrDesp[5]
		EndIf
		
		dDindepr   := SN3->N3_DINDEPR
		nOpt := 0
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		AF030Depre(dDataBase,nQuant,nQtdOrig,@nPercBaixa,@nUfir,aVlrAcum)
		nOpt := Af030DadosBx(	@cBase, @cItem, @cTipo, @nQuant, @nQtdOrig, @nUfir,;
		@onVlVend,@lBxFilho,@lVlVend,@cBxFilho, @cNota, @cSerie,,,,,.F., @cNFItem)
		
		IF nOpt == REDIGITA
			Loop
		End
		
		IF nOpt == ABANDONA .OR. nOpt == 0
			Exit
		End
		
		If nOpt == CONFIRMA

			//AVP2
			//Se o bem for classificado como Orcamento, os filhos serao baixados 
			//independendo da escolha do usuacio
			If SN1->N1_PATRIM == 'O' 
				lBxFilho := .T.
			Endif		

			dbSelectArea("SN3")
			If lBxFilho    //Baixa os agregados tipos 1-2-4
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Se solitada a baixa de agregados - devo posicionar no tipo '01' e ir Ё
				//Ё calculando para cada um dos tipos encontrados no SN3 os valores atua-Ё
				//Ё zados e depreciacoes acumuladas,nVlrAtual1,..5 e depr. Acumuladas.   Ё
				//Ё Estes 2 ultimos devem ter os valores das baixas subtraidas.          Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea("SN3")
				cTipo    := "01"
				cChave := xFilial("SN3")+cBase+cItem+cTipo
				dbSeek(cChave)
				cSeqReav := SN3->N3_SEQREAV
				cSeq     := SN3->N3_SEQ
				While !Eof() .And. cChave=SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM
					If Val(SN3->N3_BAIXA) != 0
						dbSkip()
						Loop
					Endif

					If lIsRussia
						If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
							dbSelectArea("SN3")
							dbSkip()
							Loop
						Endif
					Endif
					
					If SN3->N3_TIPO $ cTipoReav
						nRegAtu := SN3->(Recno())
						dbskip()
						If SN3->N3_TIPO $ cTipoReav
							nRegProx := SN3->(Recno())
							lTipo02  := .T.
						Endif
						SN3->(dbGoto(nRegAtu))
					EndIf
					cTipo    := SN3->N3_TIPO
					cSeq     := SN3->N3_SEQ
					cSeqReav := SN3->N3_SEQREAV
					
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					aVlrOrig	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
					aVlrAcum	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
					aVlrBx		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
					aVlrDesp	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
					nVlrCorBem:=0;	nVlrCorDep:=0
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Verifica se existem baixas parciais no SN4 - Os valores Originais sem a bai-Ё
					//Ё xa sao do SN3 pois em arquivos importados pode nao ter os valores originais Ё
					//Ё no arquivo de movimentos SN4 - nVlrOrig1,..,5                               Ё
					//Ё Em seguida,localizar as baixas que foram efetuadas para cada tipo de bem -  Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					aVlrOrig[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
					aVlrAcum[1] := SN3->N3_VRDACM1+SN3->N3_VRCDA1
					For nX := 2 To __nQuantas
						cMoed	:= Alltrim(Str(nX))
						aVlrOrig[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
						aVlrAcum[nX] := SN3->&(If(nX>9,"N3_VRDAC","N3_VRDACM")+cMoed)
					Next
					
					dbSelectArea("SN4")
					dbSetOrder(1)
					If dbSeek(xFilial()+cBase+cItem+cTipo)
						While !Eof() .And.xFilial()+cBase+cItem+cTipo=SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO
							If cSeqReav != SN4->N4_SEQREAV
								dbSkip()
								Loop
							EndIf
							If Empty(SN4->N4_MOTIVO)  // Motivo da baixa
								dbSkip()
								Loop
							Endif
							//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
							//Ё Verificar se a baixa nao e anterior a data do ultimo calculo         Ё
							//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
							If Dtos(SN4->N4_DATA)<= Dtos(GetMv("MV_ULTDEPR"))
								dbSkip()
								Loop
							Endif
							
							If SN4->N4_TIPOCNT == "1"     //CONTA DO BEM
								lBaixa := .T.
								
								// *******************************
								// Controle de multiplas moedas  *
								// *******************************
								If lMultMoed
									AtfMultMoe(,,{|x| aVlrBx[x] += SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
								Else
									aVlrBx[1] += SN4->N4_VLROC1
									aVlrBx[2] += SN4->N4_VLROC2
									aVlrBx[3] += SN4->N4_VLROC3
									aVlrBx[4] += SN4->N4_VLROC4
									aVlrBx[5] += SN4->N4_VLROC5
								EndIf
							ElseIf SN4->N4_TIPOCNT =="2"  //CONTA DE CORRECAO DO BEM
								nVlrCorBem+= SN4->N4_VLROC1
							ElseIf SN4->N4_TIPOCNT =="3"  //CONTA DE DESPESA
								
								// *******************************
								// Controle de multiplas moedas  *
								// *******************************
								If lMultMoed
									AtfMultMoe(,,{|x| aVlrDesp[x] += SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
								Else
									aVlrDesp[1]+= SN4->N4_VLROC1
									aVlrDesp[2]+= SN4->N4_VLROC2
									aVlrDesp[3]+= SN4->N4_VLROC3
									aVlrDesp[4]+= SN4->N4_VLROC4
									aVlrDesp[5]+= SN4->N4_VLROC5
								EndIf
							ElseIf SN4->N4_TIPOCNT =="4"  .And. SN4->N4_OCORR=="01" //CONTA DE DEPREC ACUMULADA
								
								// *******************************
								// Controle de multiplas moedas  *
								// *******************************
								If lMultMoed
									AtfMultMoe(,,{|x| aVlrAcum[x] -= SN4->&("N4_VLROC" + Alltrim(Str(x)) ) })
								Else
									aVlrAcum[1]-= SN4->N4_VLROC1
									aVlrAcum[2]-= SN4->N4_VLROC2
									aVlrAcum[3]-= SN4->N4_VLROC3
									aVlrAcum[4]-= SN4->N4_VLROC4
									aVlrAcum[5]-= SN4->N4_VLROC5
								EndIf
							ElseIf SN4->N4_TIPOCNT =="5"  //CONTA DE CORRECAO DA DEP ACUMULADA
								nVlrCorDep+= SN4->N4_VLROC1
							EndIf
							dbSkip()
						EndDo
					EndIf
					
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					If lMultMoed
						AtfMultMoe(,,{|x| aVlrAtual[x] := aVlrOrig[x] - aVlrBx[x] })
					Else
						aVlrAtual[1] := aVlrOrig[1] - aVlrBx[1]
						aVlrAtual[2] := aVlrOrig[2] - aVlrBx[2]
						aVlrAtual[3] := aVlrOrig[3] - aVlrBx[3]
						aVlrAtual[4] := aVlrOrig[4] - aVlrBx[4]
						aVlrAtual[5] := aVlrOrig[5] - aVlrBx[5]
					EndIf
					nOrig1 := aVlrOrig[1] - aVlrBx[1]
					
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					If lMultMoed
						aVlrAcum[1] += aVlrDesp[1]+nVlrCorDep
						AtfMultMoe(,,{|x| If( x=1 , .F. , aVlrAcum[x] += aVlrDesp[x] ) })
					Else
						aVlrAcum[1] += aVlrDesp[1]+nVlrCorDep
						aVlrAcum[2] += aVlrDesp[2]
						aVlrAcum[3] += aVlrDesp[3]
						aVlrAcum[4] += aVlrDesp[4]
						aVlrAcum[5] += aVlrDesp[5]
					EndIf
					dDindepr   := SN3->N3_DINDEPR
					
					
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					If lMultMoed
						AtfMultMoe(,,{|x| aVlrAtual[x]	:= Round(aVlrAtual[x]	*nPercBaixa,X3Decimal("N3_VORIG"+Alltrim(Str(x)) )) })
						AtfMultMoe(,,{|x| aVlrAcum[x]	:= Round(aVlrAcum[x]	*nPercBaixa,X3Decimal("N3_VORIG"+Alltrim(Str(x)) )) })
					Else
						aVlrAtual[1] := Round(aVlrAtual[1]*nPercBaixa,X3Decimal("N3_VORIG1"))
						aVlrAtual[2] := Round(aVlrAtual[2]*nPercBaixa,X3Decimal("N3_VORIG2"))
						aVlrAtual[3] := Round(aVlrAtual[3]*nPercBaixa,X3Decimal("N3_VORIG3"))
						aVlrAtual[4] := Round(aVlrAtual[4]*nPercBaixa,X3Decimal("N3_VORIG4"))
						aVlrAtual[5] := Round(aVlrAtual[5]*nPercBaixa,X3Decimal("N3_VORIG5"))
						aVlrAcum[1]  := Round(aVlrAcum[1]*nPercBaixa,X3Decimal("N3_VORIG1"))
						aVlrAcum[2]  := Round(aVlrAcum[2]*nPercBaixa,X3Decimal("N3_VORIG2"))
						aVlrAcum[3]  := Round(aVlrAcum[3]*nPercBaixa,X3Decimal("N3_VORIG3"))
						aVlrAcum[4]  := Round(aVlrAcum[4]*nPercBaixa,X3Decimal("N3_VORIG4"))
						aVlrAcum[5]  := Round(aVlrAcum[5]*nPercBaixa,X3Decimal("N3_VORIG5"))
					EndIf
					
					
					// *******************************
					// Controle de multiplas moedas  *
					// *******************************
					AF030Depre(dDataBase,nQuant,nQtdOrig,@nPercBaixa,@nUfir,aVlrAcum)
					
					AF030CAOFF(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,aVlrAcum,nOrig1)
					
					If lTipo02
						SN3->(dbGoto(nRegProx))
						lTipo02 := .f.
					Else
						dbSkip()
					EndIf
				EndDo
			Else
				If nPercBaixa >= 100
					nPercBaixa := nPercBaixa/100
				EndIf
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				nVorig1    := aVlrOrig[1] - aVlrBx[1]
				If lMultMoed
					
					AtfMultMoe(,,{|x| aVlrAtual[x] := Round( aVlrAtual[x]*nPercBaixa , X3Decimal("N3_VORIG"+Alltrim(Str(x))) ) })
					AtfMultMoe(,,{|x| aVlrAcum[x]  := Round( aVlrAcum[x]*nPercBaixa	 , X3Decimal("N3_VORIG"+Alltrim(Str(x))) ) })
				Else
					aVlrAtual[1] := Round(aVlrAtual[1]*nPercBaixa,X3Decimal("N3_VORIG1"))
					aVlrAtual[2] := Round(aVlrAtual[2]*nPercBaixa,X3Decimal("N3_VORIG2"))
					aVlrAtual[3] := Round(aVlrAtual[3]*nPercBaixa,X3Decimal("N3_VORIG3"))
					aVlrAtual[4] := Round(aVlrAtual[4]*nPercBaixa,X3Decimal("N3_VORIG4"))
					aVlrAtual[5] := Round(aVlrAtual[5]*nPercBaixa,X3Decimal("N3_VORIG5"))
					aVlrAcum[1]  := Round(aVlrAcum[1]*nPercBaixa,X3Decimal("N3_VORIG1"))
					aVlrAcum[2]  := Round(aVlrAcum[2]*nPercBaixa,X3Decimal("N3_VORIG2"))
					aVlrAcum[3]  := Round(aVlrAcum[3]*nPercBaixa,X3Decimal("N3_VORIG3"))
					aVlrAcum[4]  := Round(aVlrAcum[4]*nPercBaixa,X3Decimal("N3_VORIG4"))
					aVlrAcum[5]  := Round(aVlrAcum[5]*nPercBaixa,X3Decimal("N3_VORIG5"))
				EndIf
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				AF030Depre(dDataBase,nQuant,nQtdOrig,@nPercBaixa,@nUfir,aVlrAcum)
				AF030CAOFF(cAlias, cNota, cSerie, lBxFilho, nQuant,nQtdOrig,aVlrAcum,nVorig1)
			Endif
			Exit
			
			lRetExt	:= .T.
		Endif
	EndDo
Endif

//AVP
//Confirma o IDMOV
While (GetSx8Len() > nSaveSx8Len)
	ConfirmSX8()
EndDo

//AVP2
If lAvpAtf2 .and. nOpt == CONFIRMA
	//Se o bem for classificado como Orcamento e o AVP deste for por parcela
	//Verifico se ouve depreciacao e gero o ativo de provisao
	If SN1->N1_PATRIM == 'O' .and. SN1->N1_TPAVP == '2'
		BEGIN TRANSACTION

			AF460Apur(.T.,SN1->N1_GRUPO,SN4->N4_IDMOV,dDatabase)	
			Pergunte("AFA030",.F.)		
	
			//Baixo os filhos gerados pelas apuracoes
			MsgRun(STR0090,"",{|| AFBxProvis(SN1->N1_CBASE, SN1->N1_ITEM,SN4->N4_IDMOV,SN4->N4_MOTIVO)  })    //"Baixando os bens de provisao (AVP parcela)..."

	    END TRANSACTION
	Endif

Endif

dbSelectArea("SN3")
msUnlock()

Return
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030Auto Ё Autor Ё Alice Yamamoto		Ё Data Ё		  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Baixa Automatica de Bens									  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё AF030AUTO()												  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030													  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function AF030Auto(cAlias,nReg,nOpc,lCancela)
Local oDlg, oDlg1, oQtda
Local oMark			:=0
Local lInverte 		:= .f.
Local cCapital
Local nOpt		 	:= 0
Local cNota 	 	:= Space(TamSX3("N1_NFISCAL")[1])
Local cSerie	 	:= Space(3)
Local nUfir 	 	:= 0
Local cIndex		:="",cChave:=""
Local nSavOrd1		:=IndexOrd()
Local nQuant      	:= 0
Local nQtdOrig		:= 0

// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas 	:= If(lMultMoed,AtfMoedas(),5)
Local nX
Local aVlrOrig		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVlrBx  	 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVlrDesp 		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local nVlrCorBem	:= 0,	 nVlrCorDep:=0
Local lF030Fil 		:= ExistBlock("F030FIL")

Local bFirst	:= { || SN3->(MsSeek(cFilIni+cBaseI+cItemI, .T.)) }

Local bFor 		:= { || SN3->N3_OK == cMarca .And. ((!lCancela .And. SN3->N3_BAIXA < "1") .Or. (lCancela .And. SN3->N3_BAIXA >= "1")) .And. (!lF030Fil 	.Or. &(ExecBlock("F030FIL",.f.,.f.))) }

Local bPulaItem := { ||	SN3->N3_ITEM  < cItemI .Or.;
					  	SN3->N3_ITEM   > cItemF }
					  	
Local bWhile 	:= { ||	!(SN3->(EOF())) .And.;
						  SN3->N3_FILIAL <= cFilFim .And.;
						  SN3->N3_CBASE  <= cBaseF  }

Local bCond 	:= { ||	!(SN3->(EOF())) .And.;
						  SN3->N3_FILIAL >= AllTrim(cFilIni) .And. SN3->N3_FILIAL <= AllTrim(cFilFim) .And.;
						  SN3->N3_CBASE  >= cBaseI .And. SN3->N3_CBASE <= cBaseF .And.;
						  SN3->N3_ITEM   >= cItemI .And. SN3->N3_ITEM  <= cItemF }
						
Local aCampos		:= {}
Local lRet			:= .T.
Local cFiltroAux	:= ""

Local nRecSM0 		:= SM0->(RECNO())        
Local lAutoOld      := .F.
Local nRecSN3 

//AVP
Local nSaveSx8Len 	:= GetSx8Len()
Local cIDMOV		:= ""
Local cKeyBem		:= ""

//AVP2
Local aIdMovSN4		:= {}
Local aAreaSN1		:= SN1->(GetArea())
Local aAreaSN4		:= SN4->(GetArea())

Private cMarca		:= GetMark()
Private cArquivo	:= ""
Private nTotal 		:= 0
Private nHdlPrv		:= 0
Private nBkpHandle	:= 0
Private cPadrao   	:= ""
Private nPercBaixa	:= 100
Private dDInDepr	:= CTOD("  /  /  ")
// *******************************
// Controle de multiplas moedas  *
// *******************************
Private aPicture,cPictQtd
Private aVlrAtual	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aVlResid 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aValBaixa	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aVrdAcm		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aValDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aDepr 		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private cMotivo		:= "01-Venda"
Private aMotivos	:= {}
Private cBasei 		:= CriaVar( "N1_CBASE" , .f. )
Private cItemI 		:= CriaVar( "N1_ITEM" , .f. )
Private cBasef 		:= Replicate("Z",Len(cBasei))
Private cItemF 		:= Replicate("Z",Len(cItemI))
Private cFilialI	:= CriaVar( "N1_FILIAL" , .f. )
Private cFilialF	:= Replicate("Z",Len(cFilialI))
Private cFilIni     := CriaVar( "N1_FILIAL" , .f. )
Private cFilFim		:= CriaVar( "N1_FILIAL" , .f. )
Private nQtdBens
Private dBaixa030  	:= dDataBase
Private nValCorr 	:= 0, nValCorDep := 0
Private lSN7 		:= .F.
Private lQuant 		:= .T.

lPrimlPad := .T.

Set( _SET_DECIMALS ,20 )
lUmaVez := .F.
lAutoOld:= lAuto
lAuto 	:= .T.

lPrim	:= .T.

//AVP
//Verifica de o AVP esta implantado na base
lAvpAtf := AFAvpAtf()

//AVP2
//Verifica implementacao do AVP e AVP parcela
If lAvpAtf2 == NIL
	lAvpAtf2 := AFAvpAtf2()
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se o registro n└o est═ em uso por outra esta┤└o. Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !SoftLock("SN3")
	lAuto := lAutoOld
	Return .t.
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se o controle de solicitaГУes estА ativado, se sim encerra baixaЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
If ( SuperGetMv( "MV_ATFSOLD", .F. ,"2" ) == "1" ) .And. !lCancela .And. Alltrim(FunName()) == "ATFA030"
	lAuto := lAutoOld
	HELP(" ",1,"AF030SOLD",,STR0065 ,1,0)    //"Utilize a opГЦo Solic. Baixa/Transf, parБmetro de controle de solicitaГУes (MV_ATFSOLD) ativado."
	Return .F.
EndIf

//NЦo permite realizar a baixa se a Arma com ativo nЦo estА descartada
If !At710Ativo(SN1->N1_PRODUTO,SN1->N1_NFISCAL,SN1->N1_NSERIE,SN1->N1_ITEM)
	lAuto := lAutoOld
	Return .F.
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica o numero do Lote do modulo Ativo Fixo 									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cLoteAtf := LoteCont("ATF")
aCampos := {}
AADD(aCampos,{"N3_OK","","  ",""})
dbSelectArea("SX3")
DbSetorder(1)
dbSeek ("SN3")
Do While !EOF() .And. (x3_arquivo == "SN3")
	IF (X3USO(x3_usado)  .AND. cNivel >= x3_nivel .and. SX3->X3_context # "V") .Or.;
		(X3_PROPRI == "U" .AND. X3_CONTEXT!="V" .AND. X3_TIPO<>'M') .Or.;
		Alltrim(X3_CAMPO) $ "N3_FILIAL#N3_CBASE#N3_ITEM"
		AADD(aCampos,{X3_CAMPO,"",X3Titulo(),X3_PICTURE})
	Endif
	dbSkip()
Enddo

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica tabela de motivos para baixa 												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SX5")
dbSeek(xFilial("SX5")+"16")
While SX5->X5_FILIAL+SX5->X5_TABELA == cFilial+"16"
	If !( Alltrim(SX5->X5_CHAVE) $ '08/13/14/15/16/17/18/23')   //'23' - Devolucao somente se brasil/CIAP e baixa normal
		cCapital := Capital(X5Descri())
		AAdd( aMotivos, SubStr(SX5->X5_CHAVE,1,2 ) + "-" + SubStr(cCapital,1,12 ) )
	EndIf
	dbSkip()
EndDo

dbSelectArea("SN3")
DEFINE MSDIALOG oDlg FROM	If(!lCancela,18,29),1 TO 160,560 TITLE STR0033 + If(lCancela,STR0068,"")PIXEL  //"Baixas Autom═ticas"##"- Cancelamento"
@	1, 3 	TO If(!lCancela,70,60), 242 OF oDlg  PIXEL
nLi := 11

If !lCancela
	nLi := 0
	@ 11, 5		SAY STR0027 SIZE 24, 7 OF oDlg PIXEL  //"Num.NF"
	@ 11, 95  	SAY STR0028 SIZE 16, 7 OF oDlg PIXEL  //"S┌rie"
	@ 11, 146 	SAY STR0026 SIZE 21, 7 OF oDlg PIXEL  //"Motivo"
	@ 38, 146 	SAY STR0036 SIZE 42, 7 OF oDlg PIXEL  //"Data da Baixa"
Endif
@ 22-nLi, 5	 	SAY STR0034 SIZE 32, 7 OF oDlg PIXEL  //"Do C╒digo"
@ 23-nLi, 146 	SAY STR0035 SIZE 32, 7 OF oDlg PIXEL  //"Ao C╒digo"
@ 38-nLi, 5	 	SAY STR0051 SIZE 32, 7 OF oDlg PIXEL  //"Do Item"
@ 38-nLi, 80 	SAY STR0052	SIZE 32, 7 OF oDlg PIXEL  // "AtИ"

@ 52-nLi, 5	 	SAY STR0073 SIZE 32, 7 OF oDlg PIXEL  //"De Filial"
@ 52-nLi, 80 	SAY STR0052	SIZE 32, 7 OF oDlg PIXEL  //"AtИ"

If !lCancela
	@ 09, 37  	MSGET cNota	  SIZE	46, 9 OF oDlg PIXEL
	@ 09, 113 	MSGET cSerie	  SIZE	21, 9 OF oDlg PIXEL
Endif

@ 23-nLi, 37  	MSGET cBasei	  SIZE 	38.5, 9 OF oDlg PIXEL F3 "SN1" HASBUTTON
@ 23-nLi, 190 	MSGET cBasef	  SIZE 	46, 9 OF oDlg PIXEL F3 "SN1" Valid cBasef >= cBaseI  HASBUTTON
@ 37-nLi, 37		MSGET cItemI	  OF oDlg PIXEL
@ 37-nLi, 100	MSGET cItemF	  OF oDlg PIXEL

@ 51-nLi, 37	MSGET cFilialI	  OF oDlg PIXEL F3 "SM0_01" Valid Af030RetFil(1)   HASBUTTON
@ 51-nLi, 100	MSGET cFilialF	  OF oDlg PIXEL F3 "SM0_01" Valid Af030RetFil(2)   HASBUTTON

If !lCancela
	@ 37, 190 	MSGET dBaixa030 SIZE	46, 9 OF oDlg PIXEL  HASBUTTON
	@ 09, 190 	COMBOBOX oCbx VAR cMotivo ITEMS aMotivos SIZE 46, 27 OF oDlg PIXEL
Endif

DEFINE SBUTTON FROM 02,246 TYPE 1  ENABLE OF oDlg ACTION  (nOpt:=TudOkA(cMotivo,cNota,cSerie,lCancela),IIf(nOpt == 1,Odlg:End(),.F.))
DEFINE SBUTTON FROM 16,246 TYPE 2 ENABLE OF oDlg ACTION ( nOpt:=0,oDlg:End() )

//здддддддддддддддддддддддддддддддддддддддд©
//ЁPONTO DE ENTRADA QUE A CUSTOMIZACAO DA  Ё
//ЁTELA DE PARAMETROS                      Ё
//юдддддддддддддддддддддддддддддддддддддддды

If ExistBlock("AF030AUTBT")
	ExecBlock("AF030AUTBT",.F.,.F., {oDlg})
Endif

ACTIVATE MSDIALOG oDlg CENTERED

If nOpt == 0 .Or. !(AF030DtBx(dBaixa030))
	lAuto := lAutoOld
	dbSetOrder(nSavOrd1)
	Return
Endif

dbSelectArea("SN3")
dbSetOrder(1)
nQtdBens := 0	  // quantidade de Bens,mostrado no rodap┌ do browse

//AVP
//Caso seja a Filial inicial da tela inicial esteja vazia (vazio a ZZ) e
//Filial do SN3 Exclusiva
//Localizo o xFilial() da primeira filial da empresa
If Empty(cFilialI)
	If !Empty(xFilial("SN3"))
		SM0->(dbGotop())
		SM0->(MsSeek(cEmpAnt))
		cFilialI := SM0->M0_CODFIL
		While !(SM0->(EOF())) .AND. SM0->M0_CODIGO == cEmpAnt
			cFilialF := SM0->M0_CODFIL
			SM0->(dbSkip())
		Enddo
		SM0->(dbGoto(nRecSM0))	
	Endif
Endif

//Preenche as variaveis private cFilIni e CFilFin
Af030RetFil(1)
Af030RetFil(2)

Eval(bFirst)

If SN3->(!Eof())
	//зддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPONTO DE ENTRADA QUE VERIFICA SE O USUARIO   Ё
	//ЁDEFINIU ALGUM FILTRO ADICIONAL. CASO TENHA   Ё
	//ЁDEFINIDO ALGUM FILTRO, OS DADOS SELECIONADOS Ё
	//ЁSAO FILTRADOS CONFORME A FILTRO DEFINIDO.    Ё
	//юддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("AF03AUTFIL")
		cFiltroAux := ExecBlock("AF03AUTFIL",.F.,.F.)
		If Valtype(cFiltroAux) == "C" .And. !EMPTY(cFiltroAux)
			EVAL({ || FilBrowse("SN3",@aIndexFil,cFiltroAux ) })
		EndIf
	Endif
	
	nOpca := 0
	aF030Marca("SN3",cMarca,.F.,,lF030Fil,bFirst,bWhile,,lCancela,bCond,,bPulaItem)
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Faz o calculo automatico de dimensoes de objetos     Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aSize := MSADVSIZE()
	
	DEFINE MSDIALOG oDlg1 TITLE STR0033 From aSize[7],0 TO aSize[6],aSize[5] OF oMainWnd  PIXEL //"Baixas Autom═ticas"
	oDlg1:lMaximized := .T.
	
	oPanel := TPanel():New(0,0,'',oDlg1,, .T., .T.,, ,40,40,.T.,.T. )
	oPanel:Align := CONTROL_ALIGN_TOP
	
	@1.9,.8 Say If(lCancela,STR0056,STR0039)  OF oPanel  //"Total de Bens a Baixar..." ## "Total de Baixas a cancelar..."
	@1.9,11 Say oQtda VAR nQtdBens  SIZE 50,10 OF oPanel
	oMark := MsSelect():New("SN3","N3_OK",,aCampos,@lInverte,@cMarca,{35,oDlg1:nLeft,oDlg1:nBottom,oDlg1:nRight},'Atf030Fil(1)', 'Atf030Fil(2)')
	oMark:oBrowse:bAllMark := {| | aF030Marca("SN3",cMarca,.T.,oQtda,lF030Fil,bFirst,bWhile,,lCancela,bCond,oMark,bPulaItem)}
	oMark:bMark := { | | Af030Display(cMarca,lInverte,oQtda)}
	oMark:bAval	:= { | | aF030Marca("SN3",cMarca,.T.,oQtda,lF030Fil,bFirst,bWhile, .F.,lCancela,bCond,oMark,bPulaItem) }
	oMark:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT
	
	ACTIVATE MSDIALOG oDlg1 ON INIT EnchoiceBar(oDlg1,{|| IIF(AF030VLAUTO(),(nOpca := 1,oDlg1:End()),)},{|| nOpca := 0,ODlg1:End()})
	
	If nOpca == 1
		
		Eval(bFirst)
		
		If lAtfCont
			
			While Eval(bWhile)
			
				If Eval(bPulaItem)
					dbSelectArea("SN3")
					dbSkip()
					Loop
				EndIf
			    
			    PcoIniLan("000370")	
                AjustFil(SN3->N3_FILIAL) 

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifica existencia do Ativo 														Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea("SN1")
				dbSeek(cFilial+SN3->N3_CBASE+SN3->N3_ITEM)
				IF !Found()
					Help(" ",1,"020ATIVO")
					EXIT
				End
				
				IF !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase     // Se o bem estiver bloqueado nao permite baixa
					dbSelectArea("SN3")
					dbSkip()
					loop
				End
				
				If SN1->N1_STATUS $ "2|3"
					dbSelectArea("SN3")
					dbSkip()
					loop
				EndIf
			
				If !IsInCallStack("ATFA320")
					If SN1->N1_TPCTRAT $ "2/3"
						dbSelectArea("SN3")
						dbSkip()
						loop
					EndIf
				Endif

				If ATFXVerPrj(SN1->N1_CBASE,SN1->N1_ITEM)
					dbSelectArea("SN3")
					dbSkip()
					loop
				EndIf
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
				IF lUsaMNTAT .AND. !AFVLBXIntMnt(SN1->N1_CODBEM,dDataBase,"ATFA030")
					dbSelectArea("SN3")
					dbSkip()
					loop
				ENDIF

				If lIsRussia
					If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
						dbSelectArea("SN3")
						dbSkip()
						loop
					Endif
				Endif
				
				If Eval(bFor)
					dbSelectArea("SN3")
					cChave := &(IndexKey())
					nQtdOrig   := IIF(SN1->N1_QUANTD == 0,1,SN1->N1_QUANTD)
					nQuant	   := nQtdOrig

					If lCancela
						nRecSN3 := SN3->(Recno())
						lRet := AF030Cance("SN3",SN3->(Recno()),,,.T.)
						SN3->(dbGoto(nRecSN3))
					Else
						//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Caso tenha sido escolhido, processa a baixa do bem					  Ё
						//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						nRecSN3 := SN3->(Recno())
						
						//AVP
						//Ao mudar de bem, gero um novo IDMOV
						If cKeyBem != xFilial("SN1")+SN1->(N1_CBASE+N1_ITEM)
							cKeyBem	:= xFilial("SN1")+SN1->(N1_CBASE+N1_ITEM)
							//Alimento o identificador do movimento para ser gravado no N4_IDMOV
							//Desta forma, todo o processo de baixa tera apenas um identificador
							cIdMov	:= GetSXENum("SN4","N4_IDMOV",,6)

							//AVP2
							If lAvpAtf2 .AND. SN1->N1_PATRIM == 'O' .and. SN1->N1_TPAVP == '2'
								AADD(aIdMovSN4, {SN1->(RECNO()),cIdMov})
            				Endif

						Endif

						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aVlrAtual[1] := Iif(SN1->N1_PATRIM # "C", SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1, SN3->N3_VORIG1+SN3->N3_AMPLIA1 )
						For nX := 2 To __nQuantas
							aVlrAtual[nX] := SN3->&("N3_VORIG"+Alltrim(Str(nX)))+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(nX)))
						Next
						
						AF030Resid(dBaixa030,nQuant,nQtdOrig)
						Af030Calc(cAlias, cNota, cSerie,,nQuant,nQtdOrig, ,cIDMOV)
						SN3->(dbGoto(nRecSN3))
						
					Endif
				Else
					cChave := " "
				End
				
				dbSelectArea("SN3")
				If !(Empty(IndexKey( 12 )))
	              DBsetOrder(12)
				EndIf	
								
				dbSkip()
				
				PcoFinLan("000370")
				
				If nBkpHandle > 0
					nHdlPrv 	:= nBkpHandle
				EndIf

				//AVP
				//Contabilizacao do AVP
				If lAvpAtf .and. Len(aRecCtb) > 0             
					//Contabiliza os movimentos de AVP gerados pela baixa
					AF450CtbAvp (aRecCTB,.F.,@nTotal,@nHdlPrv,@cArquivo,"ATFA030")
					aRecCtb := {}
				Endif
		
			 	If nQtdBens != 0 .and. nHdlPrv > 0 .and. ( (Alltrim(SN3->N3_FILIAL) != "" .and. SN3->N3_Filial != Substr(cFilAnt,1,Len(Alltrim(SN3->N3_Filial)))) .or. SN3->(EOF()))
					RodaProva(nHdlPrv,nTotal)
					cA100Incl(cArquivo,nHdlPrv,2,cLoteAtf,mv_par01 == 1,mv_par02 == 1)
				  	nTotal 		:= 0
				 	nBkpHandle	:= 0 
				EndIf

			Enddo
			//Quando sair do loop verifica se contabilizou, senao chama cA100Incl 
			//se esta baixando na mesma filial e nao chamou cA100Incl por nЦo ter atingido final de arquivo -- SN3 EXCLUSIVO
			If !Empty(xFilial("SN3")) .And.  SN3->(!EOF()) .And. nQtdBens != 0 .and. nHdlPrv > 0 .And. nTotal != 0 
				RodaProva(nHdlPrv,nTotal)
				cA100Incl(cArquivo,nHdlPrv,2,cLoteAtf,mv_par01 == 1,mv_par02 == 1)
				nTotal 		:= 0
				nBkpHandle	:= 0
			EndIf

			//AVP2
			//Efetuo a geracao do bem de provisao referente a parcela de depreciacao desta baixa
			//Baixo os bens de provisao filhos do bem de orcamento que foi baixado
			If lAvpAtf2 .and. Len(aIdMovSN4) > 0
				AF030BxPr(aIdMovSN4)
				aIdMovSN4 := {}
			Endif
			
		Else   //lAtfCont = .F. - OFF LINE
			While Eval(bWhile)

				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifica existencia do Ativo 										   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				dbSelectArea("SN1")
				dbSeek(cFilial+SN3->N3_CBASE+SN3->N3_ITEM)
				IF !Found()
					Help(" ",1,"020ATIVO")
					EXIT
				End
				IF !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase     // Se o bem estiver bloqueado nao permite baixa
					dbSelectArea("SN3")
					dbSkip()
					loop
				End
				
				// Se o bem estiver bloqueado nao permite baixa
				If SN1->N1_STATUS $ "2|3"
					dbSelectArea("SN3")
					dbSkip()
					loop
				EndIf
			
				If !IsInCallStack("ATFA320")
					If SN1->N1_TPCTRAT $ "2/3"
						dbSelectArea("SN3")
						dbSkip()
						loop
					EndIf
				Endif

				If ATFXVerPrj(SN1->N1_CBASE,SN1->N1_ITEM)
					dbSelectArea("SN3")
					dbSkip()
					loop
				EndIf
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
				IF lUsaMNTAT .AND. !AFVLBXIntMnt(SN1->N1_CODBEM,dDataBase,"ATFA030")
					dbSelectArea("SN3")
					dbSkip()
					loop
				ENDIF

				If lIsRussia
					If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
						dbSelectArea("SN3")
						dbSkip()
						loop
					Endif
				Endif
				
				If Eval(bFor)
					//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Caso tenha sido escolhido, processa a baixa do bem					  Ё
					//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If lCancela
						AF030Cance("SN3",SN3->(Recno()),,,.T.)
					Else
						cChave 	 := &(IndexKey())
						nQtdOrig := IIF(SN1->N1_QUANTD == 0,1,SN1->N1_QUANTD)
						nQuant	 := nQtdOrig
						cBase    := SN3->N3_CBASE
						cItem    := SN3->N3_ITEM
						cTipo    := SN3->N3_TIPO
						cSeqReav := SN3->N3_SEQREAV
						
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aVlrOrig	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
						aVlrAcum	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
						aVlrBx		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
						aVlrDesp	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
						nVlrCorBem:=0;	nVlrCorDep:=0
						
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aVlrAtual[1] := Iif(SN1->N1_PATRIM # "C", SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1, SN3->N3_VORIG1+SN3->N3_AMPLIA1 )
						aVlrAcum[1] := SN3->N3_VRDACM1+SN3->N3_VRCDA1
						For nX := 2 To __nQuantas
							aVlrAtual[nX] := SN3->&("N3_VORIG"+Alltrim(Str(nX)))+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(nX)))
							aVlrAcum[nX] := SN3->&(If(nX>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(nX)))
						Next
						
						//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
						//Ё Verifica se existem baixas parciais no SN4 - Os valores Originais sem a bai-Ё
						//Ё xa sao do SN3 pois em arquivos importados pode nao ter os valores originais Ё
						//Ё no arquivo de movimentos SN4 - nVlrOrig1,..,5                               Ё
						//Ё Em seguida,localizar as baixas que foram efetuadas para cada tipo de bem -  Ё
						//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aVlrOrig[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
						aVlrAcum[1] := SN3->N3_VRDACM1+SN3->N3_VRCDA1
						For nX := 2 To __nQuantas
							aVlrOrig[nX] := SN3->&("N3_VORIG"+Alltrim(Str(nX)))+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(nX)))
							aVlrAcum[nX] := SN3->&(If(nX>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(nX)))
						Next
						dbSelectArea("SN4")
						dbSetOrder(1)
						If dbSeek(xFilial()+cBase+cItem+cTipo)
							While !Eof() .And.xFilial()+cBase+cItem+cTipo=SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO
								If cSeqReav != SN4->N4_SEQREAV
									dbSkip()
									Loop
								EndIf
								If Empty(SN4->N4_MOTIVO)  // Motivo da baixa
									dbSkip()
									Loop
								Endif
								//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
								//Ё Verificar se a baixa nao e anterior a data do ultimo calculo         Ё
								//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
								If Dtos(SN4->N4_DATA)<= Dtos(GetMv("MV_ULTDEPR"))
									dbSkip()
									Loop
								Endif
								If SN4->N4_TIPOCNT == "1"     //CONTA DO BEM
									lBaixa := .T.
									// *******************************
									// Controle de multiplas moedas  *
									// *******************************
									If lMultMoed
										AtfMultMoe(,,{|x| aVlrBx[x] += SN4->&("N4_VLROC"+Alltrim(Str(x))) })
									Else
										aVlrBx[1] += SN4->N4_VLROC1
										aVlrBx[2] += SN4->N4_VLROC2
										aVlrBx[3] += SN4->N4_VLROC3
										aVlrBx[4] += SN4->N4_VLROC4
										aVlrBx[5] += SN4->N4_VLROC5
									EndIf
								ElseIf SN4->N4_TIPOCNT =="2"  //CONTA DE CORRECAO DO BEM
									nVlrCorBem+= SN4->N4_VLROC1
								ElseIf SN4->N4_TIPOCNT =="3"  //CONTA DE DESPESA
									// *******************************
									// Controle de multiplas moedas  *
									// *******************************
									If lMultMoed
										AtfMultMoe(,,{|x| aVlrDesp[x] += SN4->&("N4_VLROC"+Alltrim(Str(x))) })
									Else
										aVlrDesp[1]+= SN4->N4_VLROC1
										aVlrDesp[2]+= SN4->N4_VLROC2
										aVlrDesp[3]+= SN4->N4_VLROC3
										aVlrDesp[4]+= SN4->N4_VLROC4
										aVlrDesp[5]+= SN4->N4_VLROC5
									EndIf
								ElseIf SN4->N4_TIPOCNT =="4"  .And. SN4->N4_OCORR=="01" //CONTA DE DEPREC ACUMULADA
									// *******************************
									// Controle de multiplas moedas  *
									// *******************************
									If lMultMoed
										AtfMultMoe(,,{|x| aVlrAcum[x] -= SN4->&("N4_VLROC"+Alltrim(Str(x))) })
									Else
										aVlrAcum[1]-= SN4->N4_VLROC1
										aVlrAcum[2]-= SN4->N4_VLROC2
										aVlrAcum[3]-= SN4->N4_VLROC3
										aVlrAcum[4]-= SN4->N4_VLROC4
										aVlrAcum[5]-= SN4->N4_VLROC5
									EndIf
								ElseIf SN4->N4_TIPOCNT =="5"  //CONTA DE CORRECAO DA DEP ACUMULADA
									nVlrCorDep+= SN4->N4_VLROC1
								EndIf
								dbSkip()
							EndDo
						EndIf
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						If lMultMoed
							AtfMultMoe(,,{|x| aVlrAtual[x] := aVlrOrig[x] - aVlrBx[x] })
						Else
							aVlrAtual[1] := aVlrOrig[1] - aVlrBx[1]
							aVlrAtual[2] := aVlrOrig[2] - aVlrBx[2]
							aVlrAtual[3] := aVlrOrig[3] - aVlrBx[3]
							aVlrAtual[4] := aVlrOrig[4] - aVlrBx[4]
							aVlrAtual[5] := aVlrOrig[5] - aVlrBx[5]
						EndIf
						// *******************************
						// Controle de multiplas moedas  *
						// *******************************
						aVlrAcum[1] += aVlrDesp[1]+nVlrCorDep
						If lMultMoed
							AtfMultMoe(,,{|x| If(x==1,NIL,aVlrAcum[x] += aVlrDesp[x]) })
						Else
							aVlrAcum[2] += aVlrDesp[2]
							aVlrAcum[3] += aVlrDesp[3]
							aVlrAcum[4] += aVlrDesp[4]
							aVlrAcum[5] += aVlrDesp[5]
						EndIf
						
						If aVlrAtual[1] # 0
							// *******************************
							// Controle de multiplas moedas  *
							// *******************************
							AF030Depre(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir,aVlrAcum)
							Af030CAOFF(cAlias, cNota, cSerie,,nQuant,nQtdOrig,aVlrAcum,aVlrAtual[1])
						Else
							cChave := " "
						EndIf
					Endif
				Else
					cChave := " "
				End
				
				dbSelectArea("SN3")
				If Empty(cChave) .Or. ( lCancela .And. !lRet )
					dbSkip()
				Else
					dbSeek(cChave,.T.)
				Endif
			EndDo
		Endif
	Endif
Else
	Help(" ",1,"RECNO")
Endif

//ProteГЦo Ponto de entrada

IF ExistBlock("AF03AUTFIL")
	If Valtype(cFiltroAux) == "C" .And. !EMPTY(cFiltroAux)
 		EndFilBrw("SN3",aIndexFil)
	EndIf
ENDIF

//здддддддддддддддд©
//ЁConfirma o IDMOVЁ
//юдддддддддддддддды
While (GetSx8Len() > nSaveSx8Len)
	ConfirmSX8()
Enddo

//Apagar Indeces temporarios
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Restaura os ║ndices 													  Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
RetIndex("SN3")
dbSetOrder(nSavOrd1)
Set Filter to  

lAuto := lAutoOld

Return

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё af030Quant Ё Autor Ё Wagner Xavier		  Ё Data Ё 03/08/93 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Valida quantidade a ser baixada								Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Quant(nQuant,nPerc,nQtdOrig)
Local lRet		  := .T.
Local cAlias	  := Alias()

IF nQuant > nQtdOrig .Or. nQuant < 0
	Help(" ",1,"FA020QUANT")
	lRet := .F.
End
nPerc := nQuant * 100 / nQtdOrig
If nQuant != nQtdOrig
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValBaixa[x] := Round(aVlrAtual[x] * (nPerc /100), X3Decimal("N3_VORIG"+Alltrim(Str(x)))) })
	Else
		aValBaixa[1] := Round(aVlrAtual[1] * (nPerc /100), X3Decimal("N3_VORIG1"))
		aValBaixa[2] := Round(aVlrAtual[2] * (nPerc /100), X3Decimal("N3_VORIG2"))
		aValBaixa[3] := Round(aVlrAtual[3] * (nPerc /100), X3Decimal("N3_VORIG3"))
		aValBaixa[4] := Round(aVlrAtual[4] * (nPerc /100), X3Decimal("N3_VORIG4"))
		aValBaixa[5] := Round(aVlrAtual[5] * (nPerc /100), X3Decimal("N3_VORIG5"))
	EndIf
Endif
dbSelectArea(cAlias)
Return lRet

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Valor Ё Autor Ё Cesar C S Prado		  Ё Data Ё 04/02/94 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Valida o valor da baixa 										Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё Generico 													Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Valor(nValor,nMoeda,nQtdOrig,nQuant)
Local lRet	 := .T.
Local cAlias := Alias()
Local nComp1 := 0
Local nComp2 := 0
Local cN1TipoNeg := Alltrim(SuperGetMv("MV_N1TPNEG",.F.,"")) // Tipos de N1_PATRIM que aceitam Valor originais negativos
Local cN3TipoNeg := Alltrim(SuperGetMv("MV_N3TPNEG",.F.,"")) // Tipos de N3_TIPO que aceitam Valor originais negativos

cMoeda		 := Str(nMoeda,1,0)
nComp1		 := Round(nValor, X3Decimal("N3_VORIG"+cMoeda))
nComp2		 := Round(aVlrAtual[nMoeda], X3Decimal("N3_VORIG"+cMoeda))
//	Teste para Cetesb - 13/01/99
IF SN3->N3_TIPO # "05" .And. !(SN1->N1_PATRIM $ cN1TipoNeg) .And. !(SN3->N3_TIPO $ cN3TipoNeg) .And. (nValor < 0 .Or. nComp1 > nComp2)  //nValor <= 0 .Or. nComp1 > nComp2
	Help(" ",1,"FA020VALOR")
	lRet:=.F.
End
//Baixa de Reavaliacao Negativa deve validar :
//quando o valor atualizado for negativo --> valor da baixa deve ser menor que zero e valor da baixa >= valor atualizado
IF SN3->N3_TIPO == "05" .And. nComp2 < 0 .And. ( nValor >= 0 .Or. nComp1 < nComp2 )
	Help(" ",1,"FA030VALOR")
	lRet:=.F.
End

IF lRet .And. nMoeda = 1						// BOPS 10292 - Somente recalculo se for a 1. Moeda
	nPerc	   := nValor / aVlrAtual[nMoeda]
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValBaixa[x] := Round(aVlrAtual[x] * nPerc, X3Decimal("N3_VORIG"+Alltrim(Str(x)))) })
	Else
		aValBaixa[1] := Round(aVlrAtual[1] * nPerc, X3Decimal("N3_VORIG1"))
		aValBaixa[2] := Round(aVlrAtual[2] * nPerc, X3Decimal("N3_VORIG2"))
		aValBaixa[3] := Round(aVlrAtual[3] * nPerc, X3Decimal("N3_VORIG3"))
		aValBaixa[4] := Round(aVlrAtual[4] * nPerc, X3Decimal("N3_VORIG4"))
		aValBaixa[5] := Round(aVlrAtual[5] * nPerc, X3Decimal("N3_VORIG5"))
	EndIf
	nPercBaixa := nPerc * 100
Endif
dbSelectArea(cAlias)
Return lRet

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030DtBx  Ё Autor Ё Wagner Xavier		  Ё Data Ё 03/08/93 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Verifica validade da data da baixa							Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё Generico 													Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030DtBx(dBaixa030)
Local cAlias	:= Alias()
Local lRet		:= .T.
Local lOcorr	:= .F.
Local dUltDepr 	:= '19800101'
Local lGspInUseM:= If(Type('lGspInUse')=='L', lGspInUse, .F.)
Local cRegraBx 	:= ALLTRIM(GETMV("MV_ATFBXDP",.F.,"0"))
Local cCalcDep	:= GetNewPar("MV_CALCDEP",'0') //-> '0'-Mensal, '1'-Anual
//Data de Bloqueio da MovimentaГЦo - MV_ATFBLQM
Local dDataBloq := GetNewPar("MV_ATFBLQM",CTOD(""))

dUltDepr := GetMV("MV_ULTDEPR")

If lGspInUseM
	//Se for GSP, pega o ultimo dia do mes anterior
	dUltDepr := MsSomaMes(dUltDepr,-1,.T.)
Endif


If !Empty(dBaixa030) .AND. (dBaixa030 <= dDataBloq)
	HELP(" ",1,"AF030BLQM",,STR0064 + DTOC(dDataBloq) ,1,0)    //"A data de aquisiГЦo do bem И igual ou menor que a data de bloqueio de movimentaГЦo : "
	lRet := .F.
ElseIF Empty(dBaixa030) .OR. dBaixa030 < SN3->N3_AQUISIC
	If cCalcDep == "0"
		Help(" ",1,"AFDTBAIXA")
	Else
		Help(" ",1,"AFDTBAIXA2")
	EndIf
	lRet := .F.
	
ElseIf cRegraBx == "0"
	
	If cCalcDep == "0"
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Conforme regra padrao, nao aceita movimentos fora do mes posterior     Ё
		//Ё ao ultimo calculo de depreciacao, e nem anteriores ao ultimo calculo   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If dBaixa030 >  LastDay(dUltDepr+1) .OR. dBaixa030 <= dUltDepr
			Help(" ",1,"AFDTBAIXA")
			lRet := .F.
		EndIf
	Else
		If Year(dBaixa030) >  Year(dUltDepr)+1 .OR. dBaixa030 <= dUltDepr
			Help(" ",1,"AFDTBAIXA2")
			lRet := .F.
		EndIf
	EndIf
	
	IF lRet
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se a data da baixa nao e' anterior a ultima baixa do bem   Ё
		//Ё Caso encontre alguma movimentacao com a data da ultima depreciacao, Ё
		//Ё significa que, existem movimentacoes de calculos de depreciacao ou  Ё
		//Ё correcao.                                                           Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN4")
		dbSeek(cFilial+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO+DtoS(dULTDEPR),.T.)
		While !EOF() .And. SN4->N4_FILIAL =  cFilial 		 .And. ;
			SN4->N4_CBASE  =  SN3->N3_CBASE  .And. ;
			SN4->N4_ITEM	 =  SN3->N3_ITEM	 .And. ;
			SN4->N4_TIPO	 =  SN3->N3_TIPO
			IF SN4->N4_DATA > dBaixa030
				lOcorr := .T.
				Exit
			End
			dbSkip()
		End
		dbSelectArea(cAlias)
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Nao aceita a data da baixa se houver ocorrencia de baixa a posterior   Ё
		//Ё ou movimentacao com a data da ultima depreciacao. Verificar a data da  Ё
		//Ё baixa.                                                                 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF lOcorr
			If cCalcDep == "0"
				Help(" ",1,"AFDTBAIXA")
			Else
				Help(" ",1,"AFDTBAIXA2")
			EndIf
			lRet := .F.
		EndIF
	ENDIF
	
ELSEIF cRegraBx == "1"
	
	If cCalcDep == "0"
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica se a data da baixa estА entre os meses imediatamente       Ё
		//Ё anterior e imediatamente posterior ao ultimo calculo de depreciacao Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If 	dBaixa030 > LastDay(dUltDepr+1)
			Help(" ",1,"AFDTBAIXA")
			lRet := .F.
		EndIf
	Else
		If Year(dBaixa030) >  Year(dUltDepr)+1
			Help(" ",1,"AFDTBAIXA2")
			lRet := .F.
		EndIf
	EndIf
	
ENDIF

dbSelectArea(cAlias)
Return lRet

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Resid Ё Autor Ё Cesar C S Prado		  Ё Data Ё 03/06/94 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Acha o valor residual baseado na data da baixa				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030	- Usada somente na baixa de um item                 Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Resid(dData,nQuant,nQtdOrig)
Local nMoeda, nTaxa
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aDias     := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aTxMedia  := If(lMultMoed, AtfMultMoe(,,{|x| if(x=1,1,0) }) , {1,0,0,0,0} )
Local aVrdacm	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local nDias     := Day(LastDay(dData))   //nro de dias no mes da baixa
Local nDiasDepr := Day(dData)            // Nro de dias a depreciar
Local nResidual := 0
Local nTaxaCorr := 0                     //Taxa para corre┤фo
Local i
Local dBloqueio
Local cN1TipoNeg := Alltrim(SuperGetMv("MV_N1TPNEG",.F.,"")) // Tipos de N1_PATRIM que aceitam Valor originais negativos
Local cN3TipoNeg := Alltrim(SuperGetMv("MV_N3TPNEG",.F.,"")) // Tipos de N3_TIPO que aceitam Valor originais negativos
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
Local aDiferenca := Array( If(lMultMoed,AtfMoedas(),5) )

Local aTaxaMes		:= If(lMultMoed, AtfMultMoe("SN3","N3_TXDEPR") , {SN3->N3_TXDEPR1,SN3->N3_TXDEPR2,SN3->N3_TXDEPR3,SN3->N3_TXDEPR4,SN3->N3_TXDEPR5} )
Local cCalcDep	:= GetNewPar("MV_CALCDEP",'0') //-> '0'-Mensal, '1'-Anual
Local cTipDepr	:= AllTrim(GetMv("MV_TIPDEPR"))  //-> '0'-Proporcional, '1'-Mes Cheio, '2'-Mes Posterior (NAO calc deprec de bens baixados(RIPASA) no mes de calc), '3'-Ano proporcional com mes de aquisicao proporcional, '4'-Ano proporcional com mes de aquisicao cheio, '5'-Ano posterior
Local nTaxaMes

Local nPropBase		:= 0
Local lVlrMxDp		:= .F.
Local nMoedaVMax	:= Iif(Val(GetMv("MV_ATFMDMX",.F.," "))>0, Val(GetMv("MV_ATFMDMX")), Val(cMoedaAtf))
Local lVlrSalv		:= SN3->N3_TPDEPR=='2'
Local nVlrOriSal	:= 0 // Valor original - Valor de salvamento
Local nCusto
Local nDecTax
Local lAtfctap		:= IIF(GetNewPar("MV_ATFCTAP","0")=="0",.F.,.T.)

// VerificaГЦo da classificaГЦo de Ativo se sofre depreciaГЦo
Local lAtClDepr := .F.

Local lCalcInd   := AF050IND()  // Verifica se o mИtodo de depreciaco И por indice calculado
Local nCustOrig := 0

lVlrMxDp := nMoedaVMax > 0 .AND. SN3->N3_VMXDEPR > 0

If lVlrMxDp
	lVlrMxDp := Alltrim(SN3->N3_TPDEPR) == '7'
EndIf

/*Define regra de proporcionalizacao para outras moedas*/
If lVlrMxDp .AND. nMoedaVMax > 9
	nPropBase 	:= SN3->N3_VMXDEPR /(&("SN3->N3_VORIG"  + Str(nMoedaVMax,1)) + &("SN3->N3_AMPLI" + Str(nMoedaVMax,1)))
ElseIf lVlrMxDp .AND. nMoedaVMax <= 9
	nPropBase 	:= SN3->N3_VMXDEPR /(&("SN3->N3_VORIG"  + Str(nMoedaVMax,1)) + &("SN3->N3_AMPLIA" + Str(nMoedaVMax,1)))
ElseIf lVlrSalv
	nPropBase 	:= SN3->N3_VLSALV1 / SN3->(N3_VORIG1+N3_AMPLIA1)
Endif

AFill(aDiferenca, 0)

If Alltrim(Upper(FunName())) == "ATFA031"
	Return .T.
EndIf
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё																								Ё
//Ё						  V A L O R   R E S I D U A L 								Ё
//Ё																								Ё
//цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
//Ё																								Ё
//Ё Valor residual e' a quantia a ser depreciada de um bem.                Ё
//Ё																								Ё
//Ё Se o valor da baixa for superior ao valor residual, a diferenca entre	Ё
//Ё esses valores representa LUCRO a ser devidamente contabilizado.			Ё
//Ё																								Ё
//Ё Custo da Baixa = Valor Original em Moeda Forte 								Ё
//Ё																								Ё
//цддддддддддбдддддддддбддддддддддбдддддддддбддддддддддбдддддддддбддддддддд╢
//Ё Valor	 Ё Depr.   Ё Depr.ate Ё Depr.   Ё Valor	 Ё Valor   Ё Lucro(+)Ё
//Ё Original Ё Acum.   Ё Dt Baixa Ё Acum.   Ё Residual Ё Baixa   Ё			Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 1.000,00 Ё  300,00 Ё	 20,00 Ё  320,00 Ё	680,00 Ё  680,00 Ё	 0,00 Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 1.000,00 Ё  300,00 Ё	 20,00 Ё  320,00 Ё	680,00 Ё  780,00 Ё  100,00 Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 2.000,00 Ё2.000,00 Ё	  0,00 Ё 	0,00 Ё	  0,00 Ё  200,00 Ё  200,00 Ё
//юддддддддддадддддддддаддддддддддадддддддддаддддддддддадддддддддаддддддддды

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula a taxa media para cada moeda												Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dDataI := FirstDay(dData)
dDataI := IIF(SN3->N3_DINDEPR > dDataI, SN3->N3_DINDEPR, dDataI)
dbSelectArea("SM2")
dbSeek(dDataI,.T.)
aTxMedia[1] := 1
// *******************************
// Controle de multiplas moedas  *
// *******************************
aDias := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
While !Eof() .And. SM2->M2_DATA <= dData
	For i := 2 To __nQuantas
		cMoeda := Alltrim(Str(i))
		IF &('SM2->M2_MOEDA'+cMoeda) > 0
			aDias[i] += 1
			aTxMedia[i] += &('SM2->M2_MOEDA'+cMoeda)
		EndIf
	Next
	dbSkip()
EndDo
// *******************************
// Controle de multiplas moedas  *
// *******************************
For i := 2 To __nQuantas
	cMoeda:=Alltrim(Str(i))
	IF aTxMedia[i] = 0 .Or. aDias[i] = 0
		aDias[i]	 := 1
		aTxMedia[i] := 1
	Else
		aTxMedia[i]:=aTxMedia[i] / aDias[i]
	End
Next

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Efetua a deprecia┤└o por moedas apenas se a data de in║cio de depre-	Ё
//Ё cia┤└o j═ tenha chegado.																Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
aValDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
aDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

dbSelectArea("SN3")

If cTipDepr == "0" .And. (MesAnoAtf(DDATAI) == MesAnoAtf(dData))
	nDiasDepr = DAY(dData) - (DAY(DDATAI)-1)
EndIf

// Tipos de ativo em formaГЦo (adiantamento), nЦo deve ser depreciado
If (!lAtfctap .Or. ! (cTipDepr $ '4/5/8/9')) .And. !(SN3->N3_TIPO $ '03/13' )
	lAtClDepr := AtClssVer(SN1->N1_PATRIM)
	IF lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
		AtfBloqueio(SN3->N3_CBASE + SN3->N3_ITEM, @(dBloqueio := Ctod("")))
		If (Empty(dBloqueio) .Or. Left(Dtos(dBloqueio), 6) <= Left(Dtos(dBaixa030), 6)) .And. !SN1->N1_STATUS $ "2|3" 
			If SN3->N3_DINDEPR <= dBaixa030
				
				aTaxaMes    := AFatorCalc(aTaxaMes, SN3->N3_DINDEPR, dDataBase, cTipDepr, cCalcDep, .T.)
				
				aValDepr[1] := 0
				If Abs(SN3->N3_VRDACM1 + SN3->N3_VRCDA1) < Abs(SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1)
					If aTaxaMes[1] > 0
						nDecTax		:= TamSX3("N3_VORIG1")[2]
						nCusto		:= SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
						
						If nMoedaVMax==1 .And. lVlrMxDp
							//habilita o "Valor maximo de depreciaГЦo" no calculo de depreciaГЦo na moeda definida
							nCusto := IIf(Empty(SN3->N3_VMXDEPR), nCusto, SN3->N3_VMXDEPR)
						ElseIf nMoedaVMax!=1 .And. lVlrMxDp
							// Proporcionaliza a base para as outras moedas
							nCusto := Round(NoRound(nCusto * Round(NoRound(nPropBase,nDecTax+1),nDecTax), nDecTax+1), nDecTax)
						EndIf
						
						If lVlrSalv
							nVlrOriSal := nCusto - SN3->N3_VLSALV1
							nCusto := Abs(nCusto - SN3->N3_VRDACM1)
						EndIf
						
						// No calculo de curva de trafego a depreciacao И sobre o valor contabil ( Aquisicao - Depreciacao Acumulada)
						If lCalcInd
							nCustOrig := nCusto
							nCusto    := Abs(nCusto - SN3->N3_VRDACM1 )
						EndIf
						
						If SN3->N3_TIPO == "05" .Or. (SN1->N1_PATRIM $ cN1TipoNeg) .Or. (SN3->N3_TIPO $ cN3TipoNeg)
							aValDepr[1]   := Round(nCusto * aTaxaMes[1], X3Decimal("N3_VORIG1"))
						Else
							If	!Empty( SN3->N3_FIMDEPR ) 
								aValDepr[1] := 0
							Else
								aValDepr[1]   := Round(Abs(nCusto) * aTaxaMes[1], X3Decimal("N3_VORIG1"))
							EndIf							
						EndIf
						
						// Verifica se o valor da cota eh maior do que o valor residual.
						If cTipDepr == '0'
							aValDepr[1]   := Round((aValDepr[1] / nDias) * nDiasDepr , X3Decimal("N3_VORIG1"))
						EndIf
						// Verifica se o valor da cota eh maior do que o valor residual.
						If lCalcInd
							aDiferenca[1] 	:= Abs(nCustOrig) - (aValDepr[1] + Abs(SN3->N3_VRDACM1+ SN3->N3_VRCDA1))
						ElseIf lVlrSalv
							aDiferenca[1] 	:= Abs(nVlrOriSal) - (aValDepr[1] + Abs(SN3->N3_VRDACM1+ SN3->N3_VRCDA1))
						Else
							aDiferenca[1] 	:= Abs(nCusto) - (aValDepr[1] + Abs(SN3->N3_VRDACM1+ SN3->N3_VRCDA1))
						EndIf
						
						// Residuo inferior a 1 (uma) unidade monetaria sera adicionado a cota atual.
						If lCalcInd .And. Round( aDiferenca[1] , X3Decimal("N3_VORIG1") ) <= 0.99
							aDepr[1]  := Abs(nCustOrig) - Abs(SN3->N3_VRDACM1 + SN3->N3_VRCDA1)
						ElseIf !lVlrSalv .And. Round( aDiferenca[1] , X3Decimal("N3_VORIG1") ) <= 0.99
							aDepr[1]  := Abs(nCusto)-Abs(SN3->N3_VRDACM1 + SN3->N3_VRCDA1)
						ElseIf lVlrSalv .And. Round( aDiferenca[1] , X3Decimal("N3_VORIG1") ) <= 0.99
							aDepr[1]  := Abs(nVlrOriSal)-Abs(SN3->N3_VRDACM1 + SN3->N3_VRCDA1)
						Endif
					EndIf
				EndIf
				
				// *******************************
				// Controle de multiplas moedas  *
				// *******************************
				For i:= 2 to __nQuantas
					cMoed	:= Alltrim(Str(i))
					aValDepr[i] := 0
					If Abs(SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed))) < Abs(SN3->(&("N3_VORIG"+cMoed))+SN3->(&(If(i>9,"N3_AMPLI","N3_AMPLIA")+cMoed)))
						If aTaxaMes[i] > 0
							nDecTax	:= TamSX3("N3_VORIG"  + Alltrim(Str(i)))[2]
							nCusto	:= SN3->(&("N3_VORIG"+cMoed))+SN3->(&(If(i>9,"N3_AMPLI","N3_AMPLIA")+cMoed))
							
							If  i == nMoedaVMax .And. lVlrMxDp
								//habilita o "Valor maximo de depreciaГЦo" no calculo de depreciaГЦo na moeda definida
								nCusto := IIf(Empty(SN3->N3_VMXDEPR), nCusto, SN3->N3_VMXDEPR)
							ElseIf i != nMoedaVMax .And. lVlrMxDp
								// Proporcionaliza a base para as outras moedas
								nCusto := Round(NoRound(nCusto * Round(NoRound(nPropBase,nDecTax+1),nDecTax), nDecTax+1), nDecTax)
							EndIf
							
							If lVlrSalv
								nVlrOriSal := nCusto - ROUND(NOROUND(nCusto * Round(NoRound(nPropBase,nDecTax+1),nDecTax),nDecTax+1),nDecTax)
								nCusto := Abs(nCusto - SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)))
							EndIf

							// No calculo de curva de trafego a depreciacao И sobre o valor contabil ( Aquisicao - Depreciacao Acumulada)
							If lCalcInd
								nCustOrig := nCusto
								nCusto    := Abs(nCusto - SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)))
							EndIf
							
							If SN3->N3_TIPO = "05" .Or. (SN1->N1_PATRIM $ cN1TipoNeg) .Or. (SN3->N3_TIPO $ cN3TipoNeg)
								aValDepr[i]   := Round(nCusto * aTaxaMes[i], X3Decimal("N3_VORIG"+cMoed))
							Else
								aValDepr[i]   := Round(Abs(nCusto) * aTaxaMes[i], X3Decimal("N3_VORIG"+cMoed))
							EndIf
							
							If cTipDepr == '0'
								aValDepr[i]   := Round((aValDepr[i] / nDias) * nDiasDepr , X3Decimal("N3_VORIG"+cMoed))
							EndIf
							
							// Verifica se o valor da cota eh maior do que o valor residual.
							If lCalcInd
								aDiferenca[i] 	:= Abs(nCustOrig)-(aValDepr[i] + Abs(SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)))) 
							ElseIf lVlrSalv
								aDiferenca[i] 	:= Abs(nVlrOriSal)-(aValDepr[i] + Abs(SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed))))
							Else
								aDiferenca[i] 	:= Abs(nCusto)-(aValDepr[i] + Abs(SN3->(&(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed))))
							EndIf
							
							// Residuo inferior a 1 (uma) unidade monetaria sera adicionado a cota atual.
							If !lCalcInd .And. Round( aDiferenca[i] , X3Decimal("N3_VORIG2") ) <= 0.99
								aValDepr[i] := Abs(nCustOrig) - SN3->(&(iif(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)) 
							ElseIf !lVlrSalv .And. Round( aDiferenca[i] , X3Decimal("N3_VORIG2") ) <= 0.99
								aValDepr[i] := Abs(nCusto) - SN3->(&(iif(i>9,"N3_VRDAC","N3_VRDACM")+cMoed))
							ElseIf lVlrSalv .And. Round( aDiferenca[i] , X3Decimal("N3_VORIG2") ) <= 0.99
								aValDepr[i] := Abs(nVlrOriSal) - SN3->(&(iif(i>9,"N3_VRDAC","N3_VRDACM")+cMoed))
							Endif
						EndIf
					EndIf
				Next
			EndIf
		EndIf
	EndIf
Else
	lCalcula := .F.
EndIf

If lCalcula = Nil
	lCalcula := If(GetMv("MV_CORREC") == "S" .and. !Empty(GetMv("MV_VALCORR")),.T.,.F.)
	If lCalcula
		nParCorrec := ( ( GetMv("MV_VALCORR") / 100 ) + 1 )
	Endif
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё CALC. DE DEPRECIA─гO NA MOEDA1.                                      Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lCalcula  // BOBS
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Se NAO tiver residuo na moeda 3                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If aDepr[Val(cMoedaAtf)] = 0
		aValDepr[1] := Round(aValDepr[val(cMoedaAtf)] * nParCorrec,X3Decimal("N3_VORIG1"))
	Endif
	aDiferenca[1] := (SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1+nValCorr) - (aValDepr[1]+SN3->N3_VRDACM1+SN3->N3_VRCDA1)
	If Round(aDiferenca[1],X3Decimal("N3_VORIG1")) < 0
		aDepr[1] := (SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1)-(SN3->N3_VRDACM1 + SN3->N3_VRCDA1)
	Endif
Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁRegra Geral a Depr na Moeda1 ┌ calculada pela taxa media do m┬s,   Ё
	//Ёenquanto existe uma taxa de referencia (UFIR). A partir de 01/01/96Ё
	//Ёa referncia ┌ o pr╒prio real. Dessa forma nфo ha necessidade de    Ё
	//Ёconverter a deprecia┤фo pela Ufir de referencia.                   Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If Dtos(dData) < "19960101"
		aValDepr[1] := Round(aValDepr[Val(cMoedaAtf)] * aTxMedia[Val(cMoedaAtf)],;
		X3Decimal("N3_VORIG1"))
		aDiferenca[1] := (SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1) - (aValDepr[1]+SN3->N3_VRDACM1+SN3->N3_VRCDA1)
		If Round(aDiferenca[1],X3Decimal("N3_VORIG1")) <= 0
			aDepr[1] := (SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1)-(SN3->N3_VRDACM1+SN3->N3_VRCDA1)
		Endif
	EndIf
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Trata os res║duos de deprecia┤ao.                                     Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If SN3->N3_DINDEPR <= dBaixa030
	If aDepr[1] != 0
		aValDepr[1] := aDepr[1]
	Endif
Endif

If lCalcula
	nTaxaCorr  := nParCorrec + 1
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	nValCorr   := Round(Abs((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nTaxaCorr),X3Decimal("N3_VORIG1")) - ;
	Abs(SN3->N3_VRCACM1+SN3->N3_VORIG1+SN3->N3_AMPLIA1)
	nValCorDep := Round(Abs(&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf)+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG1")) - ;
	Abs(SN3->N3_VRDACM1+SN3->N3_VRCDA1+aValDepr[1])
	//nValCorr   := Round(Abs((&('SN3->N3_VORIG'+cMoedaAtf)+&('SN3->N3_AMPLIA'+cMoedaAtf))*nTaxaCorr),X3Decimal("N3_VORIG1")) - ;
	//			  Abs(SN3->N3_VRCACM1+SN3->N3_VORIG1+SN3->N3_AMPLIA1)
	//nValCorDep := Round(Abs(&('SN3->N3_VRDACM'+cMoedaAtf)+nValDepr&cMoedaAtf)*nTaxaCorr,X3Decimal("N3_VORIG1")) - ;
	//	          Abs(SN3->N3_VRDACM1+SN3->N3_VRCDA1+nValDepr1)
Else
	If DtoS(dData) < "19941001"
		nTaxaCorr := RecMoeda(dData,cMoedaAtf)
	Else
		nTaxaCorr := 0
	Endif
	If nTaxaCorr != 0
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		nValCorr   := Round(Abs((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nTaxaCorr),X3Decimal("N3_VORIG1")) - ;
		Abs(SN3->N3_VRCACM1+SN3->N3_VORIG1+SN3->N3_AMPLIA1)
		nValCorr   := IIF(nQuant < nQtdOrig, nValCorr / nQtdOrig * nQuant, nValCorr)
		nValCorr   := (nValCorr, X3Decimal("N3_VRCACM1"))
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		nValCorDep := Round(Abs(&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf)+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG1")) - ;
		Abs(SN3->N3_VRDACM1+SN3->N3_VRCDA1+aValDepr[1])
		
		nValCorDep := IIF(nQuant< nQtdOrig, nValCorDep / nQtdOrig* nQuant, nValCorDep)
		nValCorDep := Round(nValCorDep, X3Decimal("N3_VRCDA1" ))
	EndIf
EndIf
// *******************************
// Controle de multiplas moedas  *
// *******************************
aVlrAtual[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1+nValCorr

// *******************************
// Controle de multiplas moedas  *
// *******************************
For nMoeda := 1 To __nQuantas
	cMoeda    := Alltrim(Str(nMoeda))
	
	If cMoeda =="1"
		nResidual := SN3->N3_VRDACM1+SN3->N3_VRCDA1
		If SN3->N3_TIPO = "05" .Or. (SN1->N1_PATRIM $ cN1TipoNeg) .Or. (SN3->N3_TIPO $ cN3TipoNeg)
			nResidual := SN3->N3_VORIG1+SN3->N3_AMPLIA1+SN3->N3_VRCACM1+Abs(nResidual)
		Else
			nResidual := Abs(SN3->N3_VORIG1+SN3->N3_AMPLIA1+SN3->N3_VRCACM1-nResidual)
		Endif
	Else
		nResidual := &(If(nMoeda>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoeda)
		If SN3->N3_TIPO = "05" .Or. (SN1->N1_PATRIM $ cN1TipoNeg) .Or. (SN3->N3_TIPO $ cN3TipoNeg)
			nResidual := &('SN3->N3_VORIG'+cMoeda)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf)+Abs(nResidual)
		Else
			nResidual := Abs(&('SN3->N3_VORIG'+cMoeda)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf)-nResidual)
		Endif
	End
	aVlResid[nMoeda] := nResidual
	
	If cCalcDep == '0' .Or. !cPaisLoc $ "BRA|ANG"
		If cPaisLoc == "ARG"
			If SN1->N1_CONSAB == "1"
				nDiasDepr := 0
			Else
				nDiasDepr := (LastDay(dData)-FirstDay(dData))+1
			EndIf
		Else
			If Month(SN3->N3_DINDEPR) == Month(dData) .And.;
				Year(SN3->N3_DINDEPR) == Year(dData)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Nro de dias a depreciar qdo a baixa ┌ feita no mesmo m┬s e ano daЁ
				//Ё data de in║cio de deprecia┤ao.                                   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				nDiasDepr := IIf(cTipDepr == "0", (dData-SN3->N3_DINDEPR)+1, 1)
			ElseIf Month(SN3->N3_DINDEPR) > Month(dData) .And.;
				Year(SN3->N3_DINDEPR) == Year(dData)
				nDiasDepr := 0
			Endif
		EndIf
	Else
		
		If Year(SN3->N3_DINDEPR)==Year(dData)
			If Month(SN3->N3_DINDEPR)==Month(dData)
				nTaxaMes        := ( aValDepr[nMoeda] / 12 ) * IIf( cTipDepr $ "4|5", 1, ( (SN3->N3_DINDEPR-dData) + 1 ) / Day(LastDay(dData)) )
				aValDepr[nMoeda] := aValDepr[nMoeda] * ( ( Month(dData) - Month(SN3->N3_DINDEPR) ) / 12 ) + nTaxaMes
			Else
				nTaxaMes        := ( aValDepr[nMoeda] / 12 ) * IIf( cTipDepr $ "4|5", 1, ( (LastDay(SN3->N3_DINDEPR)-SN3->N3_DINDEPR) + 1 ) / Day(LastDay(SN3->N3_DINDEPR)) )
				nTaxaBx         := ( aValDepr[nMoeda] / 12 ) * IIf( cTipDepr $ "4|5", 0, Day(dData) / Day(LastDay(dData)) )
				aValDepr[nMoeda]:= aValDepr[nMoeda] * ( ( Month(dData) - Month(SN3->N3_DINDEPR) - 1 ) / 12 ) + nTaxaMes + nTaxaBx
			EndIf
		EndIf
		
	EndIf
	
	If SN3->N3_TIPO = "05" .Or. (SN1->N1_PATRIM $ cN1TipoNeg) .Or. (SN3->N3_TIPO $ cN3TipoNeg)
		aVlResid[nMoeda] += aValDepr[nMoeda]
	Else
		aVlResid[nMoeda] -= aValDepr[nMoeda]
	Endif
	aVRDACM[nMoeda]  := &(If(nMoeda>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoeda)
	
	If nQuant < nQtdOrig
		aValDepr[nMoeda]  := Round(aValDepr[nMoeda]  / nQtdOrig * nQuant, X3Decimal(If(nMoeda>9,"N3_VRDME","N3_VRDMES")+cMoeda))
		aVlResid[nMoeda]  := Round(aVlResid[nMoeda]  / nQtdOrig * nQuant, X3Decimal("N3_VORIG"+cMoeda))
		aValBaixa[nMoeda] := Round(aValBaixa[nMoeda] / nQtdOrig * nQuant, X3Decimal("N3_VORIG"+cMoeda))
		aVRDACM[nMoeda]   := Round(aVRDACM[nMoeda]	 / nQtdOrig * nQuant, X3Decimal(If(nMoeda>9,"N3_VRDAC","N3_VRDACM")+cMoeda))
	EndIf
	
	If aDepr[nMoeda] != 0
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Baixa de bem com residuo de depreciacao em uma ou outra moeda    Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aValDepr[nMoeda]  := Round(aDepr[nMoeda] , X3Decimal(If(nMoeda>9,"N3_VRDME","N3_VRDMES")+cMoeda))
	Endif
	aValBaixa[nMoeda] := Round(aVlrAtual[nMoeda] / nQtdOrig * nQuant, X3Decimal("N3_VORIG"+cMoeda))
	aValBaixa[nMoeda] := Round(aValBaixa[nMoeda], X3Decimal("N3_VORIG"+cMoeda))
	aVlResid[nMoeda]  := Round(aVlResid[nMoeda] , X3Decimal("N3_VORIG"+cMoeda))
	aVRDACM[nMoeda]   := Round(aVRDACM[nMoeda]	, X3Decimal(If(nMoeda>9,"N3_VRDAC","N3_VRDACM")+cMoeda))
	If nMoeda == 1
		nVRCDA1  := SN3->N3_VRCDA1
	EndIf
	
Next

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calculo de Correcao da correcao do bem e da depreciacao.              Ё
//Ё A taxa de correcao e a mesma para o custo e p/ depr acumulada.        Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lCalcula
	nTaxaCorr  := nParCorrec
	nValCorr   := Round(Abs((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nTaxaCorr),X3Decimal("N3_VORIG1")) - ;
	Abs(SN3->N3_VRCACM1+SN3->N3_VORIG1+SN3->N3_AMPLIA1)
	nValCorr   := IIF(nQuant < nQtdOrig, nValCorr / nQtdOrig * nQuant, nValCorr)
	nValCorDep := Round((&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf) + aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG1")) - ;
	(SN3->N3_VRDACM1 + SN3->N3_VRCDA1 + aValDepr[1])
	nValCorDep := IIF(nQuant< nQtdOrig, nValCorDep / nQtdOrig* nQuant, nValCorDep)
	nValCorDep := Round(nValCorDep, X3Decimal("N3_VRCDA1" ))
Else
	If DtoS(dData) < "19941001"
		nTaxaCorr := RecMoeda(dData,cMoedaAtf)
	Else
		nTaxaCorr := 0
	Endif
	If nTaxaCorr != 0
		nValCorr   := Round(Abs((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nTaxaCorr),X3Decimal("N3_VORIG1")) - ;
		Abs(SN3->N3_VRCACM1+SN3->N3_VORIG1+SN3->N3_AMPLIA1)
		nValCorr   := IIF(nQuant < nQtdOrig, nValCorr / nQtdOrig * nQuant, nValCorr)
		nValCorr   := (nValCorr, X3Decimal("N3_VRCACM1"))
		nValCorDep := Round((&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf) + aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG1")) - ;
		(SN3->N3_VRDACM1 + SN3->N3_VRCDA1 + aValDepr[1])
		nValCorDep := IIF(nQuant< nQtdOrig, nValCorDep / nQtdOrig* nQuant, nValCorDep)
		nValCorDep := Round(nValCorDep, X3Decimal("N3_VRCDA1" ))
	End
EndIf

Return .T.

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Perc  Ё Autor Ё Cesar C S Prado		  Ё Data Ё 06/06/94 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Valida o percentual informado 								Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Perc(nPerc,nQtd,nQtdOrig)
Local lRet:=.T.
IF nPerc < 0 .Or. nPerc > 100
	Help(" ",1,"AFPERCBAIX")
	lRet := .F.
Else
	nQtd := nQtdOrig * (nPerc / 100)
End
Return lRet

/*
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ёaf030MarcaЁ Autor Ё Alice Y. Yamamoto	  Ё Data Ё 04/03/97   Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё marcar e desmarcar item 									  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 Ё Af030Marca(ExpN1,ExpD1,ExpD2) 							  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё atfa030													  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC Function Af030Marca(cAlias,cMarca,lInverte,oQtda,lF030Fil,bFirst,bWhile, lTodos, lCancela, bCond,oMark,bPulaItem)
LOCAL lSavTTS
LOCAL nRec
LOCAL cAliasAnt := Alias()
Local aAreaSN1	:= SN1->(GetArea())
Local aAreaSN4	:= SN4->(GetArea())

//MRG
//Verifica implementacao da Margem Gerencial
Local lMargem 		:= AFMrgAtf()

//AVP2
//Verifica implementacao do AVP e AVP parcela
If lAvpAtf2 == NIL
	lAvpAtf2 := AFAvpAtf2()
Endif

DEFAULT lInverte := .F.
DEFAULT lTodos := .T.
DEFAULT bCond := {|| .T.}
DEFAULT oMark	:= NIL 
lSavTTS := __TTSInUse
__TTSInUse := .F.

dbSelectArea(cAlias)
nRec := Recno()

If lTodos
	Eval(bFirst)
Endif

dbSelectArea("SN1")
SN1->(dbGoTop())
SN1->(dbSetOrder(1))	//N1_FILIAL+N1_CBASE+N1_ITEM
SN4->(dbSetOrder(1)) //N4_FILIAL+N4_CBASE+N4_ITEM+N4_TIPO+DTOS(N4_DATA)+N4_OCORR+N4_SEQ

While !lTodos .Or. Eval(bWhile)

	If Eval(bPulaItem)
		SN3->(dbSkip())
		loop
	EndIf
	
	AjustFil(SN3->N3_FILIAL)
	//ValidaГЦo de controle de bens de terceiros
	If !IsInCallStack("ATFA320")
		If SN1->(dbSeek(xFilial("SN1") + SN3->(N3_CBASE+N3_ITEM)))
			If SN1->N1_TPCTRAT $ "2/3"
				If !lTodos
					Help(" ",1,"AFA030TERC",,STR0072 ,1,0)//"Bens em controle de terceiro somente podem ser baixados ou cancelados pela rotina especifica (ATFA320)"
					Exit
				Else
					SN3->(dbSkip())
					loop
				EndIf
			EndIf
		EndIf
	Endif
	
	If lCancela
		SN4->(dbSeek(xFilial("SN4")+SN3->(N3_CBASE+N3_ITEM+N3_TIPO+DTOS(N3_DTBAIXA))+"01"+SN3->N3_SEQ))
		If SN4->N4_MOTIVO == '13' .And. !IsInCallStack("AF010CVMet")
			If !lTodos
				Help(" ",1,"AF030CCONV",,STR0067,1,0)//"Baixas com motivo 13-ConversЦo apenas podem ser cancelado pela rotina de cancelamento de conversЦo(ATFA010)"
				Exit
			Else
				SN3->(dbSkip())
				Loop
			EndIf
		EndIf
		
		If SN4->N4_MOTIVO $ '18'
			If !lTodos
				Help(" ",1,"AF030FILAUT",,STR0077,1,0)//"Baixas com motivo 18-Transferencia Interna de Filial nЦo pode ser cancelada"
				Exit
			Else
				SN3->(dbSkip())
				Loop
			EndIf
		EndIf

		If SN4->N4_MOTIVO == '14' .And. !IsInCallStack("A103GrvAtf")
			If !lTodos
				Help(" ",1,"AF030DEB",,STR0082,1,0)//"Baixas com motivo 14 apenas podem ser cancelado pela exclusЦo da nota de crИdito/dИbito"
				Exit
			Else
				SN3->(dbSkip())
				Loop
			EndIf
		EndIf
		
		If SN4->N4_MOTIVO $ "01/10" .And. !Empty(SN4->N4_NOTA)
			If !A030VlNota(SN4->N4_NOTA,SN4->N4_SERIE)
				If !lTodos
					Help(" ",1,"AF030CNOTA",,STR0074 + SN4->N4_NOTA + STR0075 + SN4->N4_SERIE + STR0076  ,1,0)//"Baixa de Ativo atrelado ao documento de saМda : " ## " Serie: " ## ".Por favor exclua a nota fiscal "
					Exit
				Else
					SN3->(dbSkip())
					Loop
				EndIf
			EndIf
		EndIf
	EndIf

	If ATFXVerPrj(SN3->N3_CBASE,SN3->N3_ITEM, !lTodos )
		If !lTodos
			Exit
		Else
			SN3->(dbSkip())
			Loop
		EndIf 
	EndIf   
	//AVP
	If lAvpAtf
	//Tipo 14 nao pode ser marcado diretamente
		If SN3->N3_TIPO == '14'
			If !lTodos
				Help(" ",1,"AF030MRK14 ",, STR0078 +CHR(10)+;
					STR0079 ,1,0)
				Exit
			EndIf
		EndIf

		//Valida se cancelamento da baixa e possivel
		If lCancela .and. AFNoCanAvp(SN4->N4_CBASE,SN4->N4_ITEM,SN4->N4_TIPO,SN4->N4_IDMOV,SN4->N4_DATA,SN4->N4_TPSALDO)
			If !lTodos
				Help(" ",1,"AF030NOCAN",,STR0081,1,0)
				Exit
			Else
				SN3->(dbSkip())
				Loop
			Endif
		Endif
	
		//AVP2
		//Verifica a tentativa de marcar um bem de provisao gerado a partir de um bem de orcamento
		//Nao deve permitir a selecao.
		If lAvpAtf2
			//Posiciono no SN1 para verificar se o bem provisao possui bem superior
			SN1->(MsSeek(xFilial("SN1")+SN3->(N3_CBASE+N3_ITEM)))
			If SN1->N1_PATRIM == 'V' .AND. !(EMPTY(SN1->N1_BASESUP))	
				//Valida se cancelamento da baixa e possivel
				If lCancela
					If !lTodos
						Help(" ",1,"AF030NOCPR",,STR0088+CRLF+STR0087+SN1->N1_BASESUP +"-"+SN1->N1_ITEMSUP,1,0) //'Este ativo foi gerado a partir do processo de constituiГЦo de provisЦo. Este tipo de ativo nЦo poderА ser selecionado diretamente. Selecione o ativo superior (PAI) para que o cancelamento da baixa ocorra.'##
						Exit
					Else
						SN3->(dbSkip())
						Loop
					Endif
				Else
					If !lTodos
						Help(" ",1,"AF030MRKV",,STR0088+CRLF+STR0087+SN1->N1_BASESUP +"-"+SN1->N1_ITEMSUP,1,0) //'Este ativo foi gerado a partir do processo de constituiГЦo de provisЦo. Este tipo de ativo nЦo poderА ser selecionado diretamente. Selecione o ativo superior (PAI) para que o cancelamento da baixa ocorra.'##
						Exit
					Else
						SN3->(dbSkip())
						Loop
					Endif
	            Endif
			Endif
    	Endif
	EndIf

	//MRG
	//Tipo 15 nao pode ser marcado diretamente
	If lMargem .and. SN3->N3_TIPO == '15' .and. !lTodos
		Help(" ",1,"AF030MRK15 ",, STR0095 +CHR(10)+STR0096 ,1,0)  //"Os registros do Tipo 15 somente poderЦo ser selecionados atravИs do Tipo 10 ou Tipo 13."###"Selecione o Tipo 10 ou o Tipo 13 correspontende e o Tipo 15, serА selecionado automaticamente para o processo."
		Exit
	EndIf
	
	If Eval(bCond) .And. ((!lCancela .And. SN3->N3_BAIXA < "1") .Or. (lCancela .And. SN3->N3_BAIXA >= "1")) .And. (!lF030Fil 	.Or. &(ExecBlock("F030FIL",.f.,.f.)))
		RecLock("SN3")
		If lInverte
			If SN3->N3_OK == cMarca
				SN3->N3_OK := ""
				nQtdBens--
				nQtdBens:= Iif (nQtdBens <=0,0,nQtdBens)
				//AVP
				Fa030Mark14(lTodos,@nQtdBens,cMarca,lF030Fil,.F.)		 		 
				//MRG
				Fa030Mk15(lTodos,@nQtdBens,cMarca,lF030Fil,.F.,lCancela)		 		 
			Else
				If SN1->(FieldPos("N1_STATUS")) > 0
					If SN1->(dbSeek(SN3->(N3_FILIAL+N3_CBASE+N3_ITEM)))
						If SN1->N1_STATUS $ "2|3" .Or. (SN1->N1_STATUS $ "1" .And. !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase)
							If !lTodos
								If !lCancela
									Help(" ",1,"A030BLOQ")
								Else
									Help(" ",1,"A030BLOQ2")
								EndIf
							EndIf
						Else
							SN3->N3_OK := cMarca
							nQtdBens++
							//AVP
							//Marca registros do Tipo 14
							Fa030Mark14(lTodos,@nQtdBens,cMarca,lF030Fil)
							//MRG
							//Marca registros do Tipo 15
							Fa030Mk15(lTodos,@nQtdBens,cMarca,lF030Fil,,lCancela)
						EndIf
					EndIf
				Else
					SN3->N3_OK := cMarca
					nQtdBens++
					//AVP
					//Marca registros do Tipo 14
					Fa030Mark14(lTodos,@nQtdBens,cMarca,lF030Fil)
					//MRG
					//Marca registros do Tipo 15
					Fa030Mk15(lTodos,@nQtdBens,cMarca,lF030Fil,,lCancela)		 		 
				EndIf
			EndIf
			oQtda:Refresh()
		Else
			If SN1->(dbSeek(SN3->(N3_FILIAL+N3_CBASE+N3_ITEM)))
				If SN1->N1_STATUS $ "2|3" .Or. (SN1->N1_STATUS $ "1" .And. !Empty(SN1->N1_DTBLOQ) .and. SN1->N1_DTBLOQ >= dDataBase)
					If !lTodos
						If !lCancela
							Help(" ",1,"A030BLOQ")
						Else
							Help(" ",1,"A030BLOQ2")
						EndIf
					EndIf
				Else
					SN3->N3_OK := cMarca
					nQtdBens++
					//AVP
					//Marca registros do Tipo 14
					Fa030Mark14(lTodos,@nQtdBens,cMarca,lF030Fil)
					//MRG
					//Marca registros do Tipo 15
					Fa030Mk15(lTodos,@nQtdBens,cMarca,lF030Fil,,lCancela)
				EndIf
			EndIf
			oQtda:Refresh()
		EndIf
		MsUnLock()
	Else
		If ! lTodos .And. (!lF030Fil 	.Or. &(ExecBlock("F030FIL",.f.,.f.)))
			Aviso(STR0033,If(lCancela,STR0057,STR0053), {"Ok"}) // "Este bem nЦo pode ser selecionado, pois estА baixado!" ## "Este bem nЦo pode ser selecionado, pois nЦo estА baixado!"
		Endif
	Endif
	If !lTodos
		Exit
	Endif
	SN3->(dbSkip())
EndDo

RestArea(aAreaSN4)
RestArea(aAreaSN1)

SN3->(dbGoTo(nRec))

If Valtype(oMark) == 'O'
	oMark:oBrowse:Refresh(.t.)
Endif

__TTSInUse := lSavTTS
dbSelectArea(cAliasAnt)

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030DisplayЁ Autor Ё Alice Yamamoto 		  Ё Data Ё 04/03/97 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁAtualiza tela de sele┤ao de registros da baixa autom═tica 	Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAf030Display( cMarca,lInverte,oQtda,cArquivo) 				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function af030Display(cMarca,lInverte,oQtda,cArquivo)
Local cFieldMarca := "N3_OK"

If IsMark(cFieldMarca,cMarca,lInverte)
	nQtdBens++
Else
	nQtdBens--
	nQtdBens:= Iif(nQtdBens<0,0,nQtdBens)
End
oQtda:Refresh()

Return

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030Calc Ё Autor Ё Alice Yamamoto		Ё Data Ё 17.11.97 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Calcular os valores para a Baixa                           Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё AF030CALC												  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ Af030Calc(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig) Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030													  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030Calc(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig, lCtbBxInt,cIDMOV,lMovCiap,cPadraoAut,cNFItem)
Local nDiasDepr
Local i
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)

// VerificaГЦo da classificaГЦo de Ativo se sofre depreciaГЦo
Local lAtClDepr := .F.

Private lCalcChi	:= Iif(Alltrim(Upper(FunName()))="ATFA031",.T.,.F.)
// *******************************
// Controle de multiplas moedas  *
// *******************************
Private aTxMedia 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aVRDACM 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )


Default lCtbBxInt := .F. // contabiliza baixa na integraГЦo
Default cIDMOV := ""
Default lMovCiap := .T.
Default cPadraoAut := ""
Default cNFItem    := " "

If lAtfCont==Nil
	lAtfCont := IIf(Trim(GetMv("MV_ATFCONT"))="O",.T.,.F.)
EndIf

lBxFilho := IIf(lBxFilho == Nil , .F., lBxFilho)
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Formula para c═lculo da propor┤└o da baixa						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
nValorBaixa := 0
// *******************************
// Controle de multiplas moedas  *
// *******************************
Private aValBx		:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

dbSelectArea("SN3")

/*Variaveis private declaradas apenas se ja nao existirem
pois se existerem nao dever ser sobrepostas para que nЦo  comprometa a contabilizacao */
If type( 'dBaixa030' ) == 'U'
	Private dBaixa030  := dDataBase
EndIf
If type( 'dDindepr' ) == 'U'
	Private dDindepr   := SN3->N3_DINDEPR
EndIf
If type( 'lUmaVez' ) == 'U'
	Private lUmaVez   := .T.
EndIf
If type( 'nValCorr' ) == 'U'
	Private nValCorr   := 0
EndIf
If type( 'nValCorDep' ) == 'U'
	Private nValCorDep   := 0
EndIf
If type( 'nHdlPrv' ) == 'U'
	Private nHdlPrv   := 0
EndIf
If type( 'cLoteAtf' ) == 'U'
	Private cLoteAtf  := LoteCont("ATF")
EndIf
If type( 'cArquivo' ) == 'U'
	Private cArquivo  := ""
EndIf
If type( 'cPadrao' ) == 'U'
	Private cPadrao  := ""
EndIf
If type( 'nTotal' ) == 'U'
	Private nTotal 	  := 0
EndIf


nDiasDepr  := Day(dBaixa030)

// Carrega o valor da deprecia┤└o acumulada
If lCalcChi
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	aVRDACM 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Else
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVRDACM 	:= AtfMultMoe("SN3","N3_VRDACM")
	Else
		aVRDACM[1]  := SN3->N3_VRDACM1
		aVRDACM[2]  := SN3->N3_VRDACM2
		aVRDACM[3]  := SN3->N3_VRDACM3
		aVRDACM[4]  := SN3->N3_VRDACM4
		aVRDACM[5]  := SN3->N3_VRDACM5
	EndIf
EndIf
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula a taxa media para cada moeda												Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dDataI := FirstDay(dBaixa030)
dDataI := IIF(dDindepr > dDataI, dDindepr, dDataI)
dbSelectArea("SM2")
dbSeek(dDataI,.T.)
aTxMedia[1] := 1
// *******************************
// Controle de multiplas moedas  *
// *******************************
aDias := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

While !Eof() .And. SM2->M2_DATA <= dBaixa030
	For i := 2 To __nQuantas
		cMoeda := Alltrim(Str(i))
		IF &('SM2->M2_MOEDA'+cMoeda) > 0
			aDias [i] += 1
			aTxMedia[i] += &('SM2->M2_MOEDA'+cMoeda)
		End
	Next
	dbSkip()
End

// *******************************
// Controle de multiplas moedas  *
// *******************************
For i := 2 To __nQuantas
	cMoeda := Alltrim(Str(i))
	IF aTxMedia[i] == 0 .Or. aDias[i] == 0
		aDias[i] 	:= 1
		aTxMedia[i] := 1
	Else
		aTxMedia[i] := aTxMedia[i] / aDias[i]
	End
Next
If !lCalcChi
	If Dtos(SN3->N3_AQUISIC) >= "19960701"  //At┌ os dias de hoje
		dbSelectArea("SM2")
		If dbSeek(SN3->N3_AQUISIC)
			nTaxaCorr := &("M2_MOEDA"+cMoedaAtf)
		Else
			nTaxaCorr := 0.8287
		EndIf
	Else
		If Dtos(dDataBase) >= "19960101"	.or. aTxMedia[Val(cMoedaAtf)] = 0
			nTaxaCorr := 0.8287
		Else
			nTaxaCorr := aTxMedia[Val(cMoedaAtf)]
		Endif
	Endif
Else
	nTaxaCorr := 1
EndIf
nTaxaCorr := IIf(ExistBlock("A30EMBRA"),ExecBlock("A30EMBRA",.F.,.F.),nTaxaCorr)

If lUmaVez
	nPercentual := aValBaixa[1] / aVlrAtual[1]
	nPercAtiv   := nPercentual
	lUmaVez     := If(AllTrim(Upper(FunName()))=="MATA466N", .T., .F.)
Endif

If lAuto
	nPercentual := aValBaixa[1] / aVlrAtual[1]
EndIf

If lBxFilho
	nPercentual := nPercAtiv
Endif

nValCC	:= Round((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nTaxaCorr, X3Decimal("N3_VORIG1"))
nValDPR	:= Round((&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf) + aValDepr[Val(cMoedaAtf)]) * nTaxaCorr,X3Decimal("N3_VORIG1"))

If nQuant == nQtdOrig
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValDepr[x] := Round(aValDepr[x]*nPercentual, X3Decimal("N3_VORIG"+Alltrim(Str(x))) ) })
	Else
		aValDepr[1] := Round(aValDepr[1]*nPercentual, X3Decimal("N3_VORIG1"))
		aValDepr[2] := Round(aValDepr[2]*nPercentual, X3Decimal("N3_VORIG2"))
		aValDepr[3] := Round(aValDepr[3]*nPercentual, X3Decimal("N3_VORIG3"))
		aValDepr[4] := Round(aValDepr[4]*nPercentual, X3Decimal("N3_VORIG4"))
		aValDepr[5] := Round(aValDepr[5]*nPercentual, X3Decimal("N3_VORIG5"))
	EndIf
	nValCorDep:= Round(nValCorDep*nPercentual,X3Decimal("N3_VRCMES1"))
	nValCorr  := Round(nValCorr*nPercentual,  X3Decimal("N3_VRCACM1"))
Endif

If &(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf) < &('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf)
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё nValBaixTot - Valor da deprec do mes na moeda do ativo          Ё
	//Ё nValBaixPro - Valor da deprec do mes proporcional ao nro de     Ё
	//Ё             - de dias na Moeda do Ativo.                        Ё
	//Ё nValDeprPro - Valor da deprec do mes na Moeda Corrente(Real)    Ё
	//Ё nValorBaixa - Valor da deprec acum a baixar na Moeda do Ativo   Ё
	//Ё             - (UFIR) j═ proporcional ao nёmero de dias.         Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If cPaisLoc == "ARG"
		If SN1->N1_CONSAB == "1"
			nDiasDepr := 0
		Else
			nDiasDepr := (LastDay(dBaixa030)-FirstDay(dBaixa030))+1
		EndIf
	ElseIf lCalcChi
		nDiasDepr := 0
	Else
		If Month(SN3->N3_DINDEPR) == Month(dBaixa030) .And.;
			Year(SN3->N3_DINDEPR) == Year(dBaixa030)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Nro de dias a depreciar qdo a baixa ┌ feita no mesmo m┬s e ano daЁ
			//Ё data de in║cio de deprecia┤ao.                                   Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			nDiasDepr := (dBaixa030-SN3->N3_DINDEPR)+1
		ElseIf Month(SN3->N3_DINDEPR) > Month(dBaixa030) .And.;
			Year(SN3->N3_DINDEPR) == Year(dBaixa030)
			nDiasDepr := 0
		EndIf
	EndIf
	
	nValBaixTot := aValBaixa[Val(cMoedaAtf)] * (SN3->N3_TXDEPR1/1200)
	nValBaixPro := Round(nValBaixTot * ( nDiasDepr / Day(LastDay(dBaixa030))),x3Decimal("N3_VORIG"+cMoedaAtf))
	nValDeprPro := Round(nValBaixPro * nTaxaCorr,x3Decimal("N3_VORIG1"))
	nValorBaixa := Round(&(If(Val(cMoedaAtf)>9,'SN3->N3_VRDAC','SN3->N3_VRDACM')+cMoedaAtf) * nPercentual+;
	(aValDepr[Val(cMoedaAtf)]),x3Decimal("N3_VORIG"+cMoedaAtf))
Else
	nValorBaixa:= &('SN3->N3_VRDACM'+cMoedaAtf) * nPercentual
	nValCorDep := nValCorr
Endif

// *******************************
// Controle de multiplas moedas  *
// *******************************
aValBx[1] := Round(nValorBaixa * nTaxaCorr,x3Decimal("N3_VORIG1"))
For i :=2 to __nQuantas
	cMoed	:= Alltrim(Str(i))
	If cMoedaAtf # cMoed
		aValBx[i]  := Round((SN3->&(If(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)*nPercentual)+aValDepr[i], X3Decimal("N3_VORIG"+cMoed))
	Else
		aValBx[i] := nValorBaixa
	EndIf
Next

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё nValorBaixa <= SN3->N3 ... ,no caso em que a baixa ┌ feita sobre  Ё
//Ё um bem quase totalmente depreciado.O valor da baixa nao pode ul-  Ё
//Ё trapassar o valor original em moeda forte. nVlrAtual1 = nValbaixa1Ё
//Ё no casos de baixa por valor.    											 Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
lAtClDepr := AtClssVer(SN1->N1_PATRIM)
IF lAtClDepr .OR. EMPTY(SN1->N1_PATRIM) .and. !lCalcChi
	If nValorBaixa <= Round((&('SN3->N3_VORIG'+cMoedaAtf)+&(If(Val(cMoedaAtf)>9,'SN3->N3_AMPLI','SN3->N3_AMPLIA')+cMoedaAtf))*nPercentual,X3Decimal("N3_VORIG"+cMoedaAtf))
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If aVlrAtual[1] == aValBaixa[1]
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Na baixa total se o valor da depreciacao acumulada + correcao da  Ё
			//Ё depreciacao acumulada + a depreciacao do mes for > que o valor oriЁ
			//Ё ginal + a correcao do bem, a depreciacao do mes e = valor originalЁ
			//Ё + a sua correcao - deprec acum+ a sua correcao p/ evitar q a depreЁ
			//Ё ciacao acumulada seja maior que o valor original.                 Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			// *******************************
			// Controle de multiplas moedas  *
			// *******************************
			If (SN3->N3_VRDACM1+SN3->N3_VRCDA1+ aValDepr[1]) > (SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1)
				aValDepr[1] := SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1 - (SN3->N3_VRDACM1+SN3->N3_VRCDA1)
			EndIf
			For i :=2 to __nQuantas
				cMoed := Alltrim(Str(i))
				If (SN3->&(If(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)+ aValDepr[i]) > (SN3->&("N3_VORIG"+cMoed)+SN3->&(If(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)+SN3->&(If(i>9,"N3_AMPLI","N3_AMPLIA")+cMoed))
					aValDepr[i] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(i>9,"N3_AMPLI","N3_AMPLIA")+cMoed) - SN3->&(If(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)
				EndIf
			Next
		Endif
	Endif
Endif
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Baixa a partir de outubro de 1994 - IOB Ir/Legisla┤└o Societ═ria  Ё
//Ё P═gina 466 - A partir de outubro de 1994 n└o haver═ mais corre┤└o Ё
//Ё monet═ria na baixa, pois esta j═ ocorreu no c═lculo da corre┤└o	 Ё
//Ё pela ufir do m┬s seguinte.													 Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Dtos(dBaixa030)>=Dtos(cTod("01/10/94")).And. !lCalcula
	nValCorr := 0
	nValCorDep := 0
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Se o bem j═  estiver totalmente depreciado, cancela os c═lculos de de- Ё
//Ё precia┤└o. Obs: A F╒rmula de c═lculo est═  muito complicada.				Ё
//Ё																								Ё
//Ё Aten┤└o: S╒ deve manter a deprecia┤└o se a data de in║cio de depreci-	Ё
//Ё a┤└o tenha sido alcan┤ada.															Ё
//Ё																								Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
If Abs( SN3->N3_VRDACM1 + SN3->N3_VRCDA1 ) >= Abs( SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1) .or. dDindepr > dBaixa030
	aValDepr[1] := 0
Endif
For i :=1 to __nQuantas
	cMoed := Alltrim(Str(i))
	If Abs( SN3->&(If(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)) >= Abs( SN3->&("N3_VORIG"+cMoed)+SN3->&(If(i>9,"N3_AMPLI","N3_AMPLIA")+cMoed) ) .or. dDindepr > dBaixa030
		aValDepr[i] := 0
	Endif
Next

Af030Grava(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,lCtbBxInt,@cIDMOV,lMovCiap,cPadraoAut, cNFItem)
//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё  Libera o softlock instalado antes do while acima.  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SN3")

If Type('nBkpHandle') == 'N' .and.  nHdlPrv > 0
	nBkpHandle := nHdlPrv
EndIf

msUnlock()

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030Grava  Ё Autor Ё Alice Yamamoto 		  Ё Data Ё 17/11/97 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁAtualiza tela de sele┤ao de registros da baixa autom═tica 	Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAf030Display( cMarca,lInverte,oQtda,cArquivo) 				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030Grava(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,lCtbBxInt,cIDMOV,lMovCiap,cPadraoAut, cNFItem)

Local lPadrao	 := .F.
Local cOldArea  := Alias()
Local nPropSF9  := 0
Local nVlrSFA   := 0
Local nFatorSFA := 0
Local nRegSN3   := 0
Local nVlOrig   := 0
Local cTipoCorr := ""
Local cBase     :=""
Local cItem     := ""
Local lCredito  := .F.
Local dLei102 	:= GetNewPar("MV_DATCIAP",ctod("01/01/2001"))
Local cTipoImob	:= ""
Local nX
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := AtfMoedas()
Local aValorMoed


Local cTpSaldo	:= ""
Local lSN3Saldo := .T.
Local cOcorr 	:= ""
Local aDadosComp :={}
Local aValores   := {}

//Acrescentado por Fernando Radu Muscalu em 11/05/2011
//rateio e sua contabilizacao da ficha de ativo
Local aRateio	:= {}
Local lCtbRat 	:= .F.
Local lLP_Rat	:= VerPadrao("81E")
Local cCodMot  := SubStr(cMotivo,1,2)

//AVP
Local lAtfa060 := ISINCALLSTACK("ATFA060")

// VerificaГЦo se a classificaГЦo de ativo sofre depreciaГЦo
Local lAtClDepr := .F.
Local cMotSF9   := "" // Motivos a serem gravados no f9_motivo/fa_motivo
Local nValFis   := 0

/*
 * Define se a contabilizaГЦo serА ON/OFF Line
 */
Local lContOn	:= Iif(Type("MV_PAR04") == "N",(MV_PAR04 == 1),Iif(Type("MV_PAR03") == "N",(MV_PAR03 == 1),.F.))
Local cTypesNM	:= IIF(lIsRussia,"*" + AtfNValMod({3,4}, "*"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - main and recoverable models
Local cTypes10	:= IIF(lIsRussia,"*" + AtfNValMod({1}, "*"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - main models
Local cTypes12	:= IIF(lIsRussia,"*" + AtfNValMod({2}, "*"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - recoverable models

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera um novo sequencial a apartir do ёltimo sequencial gerado 			Ё
//цддддддддддбддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

Default lCtbBxInt := .F. // contabiliza baixa na integraГЦo
Default cIDMOV	:= ""
Default lMovCiap	:= .T.
Default cPadraoAut := ""
Default cNFItem := " "
Private cPadrao := ""

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica qual o lancamento padronizado que devera ser utilizado			Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Empty(cPadraoAut)
	If SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)   // Aquisi┤└o
		cPadrao := "810"
	ElseIf SN3->N3_TIPO $ "02,05"    // Reavalia┤└o
		cPadrao := "811"
	ElseIf SN3->N3_TIPO $ "03*13"      // Adiantamento
		cPadrao := "812"
	ElseIf SN3->N3_TIPO == "04"      // Lei 8200 (Dif. BTN/IPC)
		cPadrao := "813"
	Else
		cPadrao := "81A" 					// Baixa de outros tipos de ativos
	EndIf
Else
	cPadrao := cPadraoAut
EndIf

lCalcChi:= Iif (Type("lCalcChi") == "U" , .F.,lCalcChi)
dbSelectArea("SN3")
cSeqReav 	:= SN3->N3_SEQREAV
nSavRec 	:= SN3->( Recno() )
cBase 		:= SN3->N3_CBASE
cItem 		:= SN3->N3_ITEM
cSeq  		:= SN3->N3_SEQ
****************** CIAP ********************
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza o Cadastro de CIAP                                            Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SF9")
dbSetOrder(1)
If ( dbSeek(xFilial("SF9")+SN1->N1_CODCIAP) ) .And. lMovCiap
	If ( SF9->F9_DTENTNE >= dLei102 )
		lCredito:= .T.
	Else
		lCredito:= .F.
	EndIf
	dbSelectArea("SN3")
	dbSetOrder(1)
	nRegSN3 := SN3->(Recno())
	dbSeek(xFilial("SN3")+SN1->N1_CBASE+SN1->N1_ITEM)
	While ( !Eof() .And. xFilial("SN3")==SN3->N3_FILIAL .And.;
		SN1->N1_CBASE ==SN3->N3_CBASE  .And.;
		SN1->N1_ITEM  ==SN3->N3_ITEM )
		If ( SN3->N3_TIPO $ ("01*03*10*16*17" + cTypes10 + cTypesNM) )
			nVlOrig += &('SN3->N3_VORIG'+cMoedaAtf)
		EndIf
		dbSelectArea("SN3")
		dbSkip()
	EndDo
	dbSelectArea("SN3")
	dbGoto(nRegSN3)
	nValFis   := aValBaixa[Val(cMoedaAtf)] //Armazena o valor do bem do tipo Fiscal
	nPropSF9  := NoRound(nValFis * SN1->N1_ICMSAPR/nValFis,2) //ICMS deve ser calculado em cima do valor do bem tipo Fiscal

	nFatorSFA:= (Year(SF9->F9_DTENTNE)+If(lCredito,4,5)-Year(dBaixa030))
	nVlrSFA  := Round(nPropSF9*nFatorSFA*IIf(lCredito,0.25,0.20),4)
	/* ---------------------------------------------------------------------
		Motivos a serem gravados no F9_MOTIVO, FA_MOTIVO - OrientaГЦo Fiscal
		motivo de baixa          -  F9(A)_MOTIVO
		'01' - Venda             - '2'
		'10' - Transferencia     - '3'
		'23' - DevoluГЦo de nota - '4'
		'02|03|05|06|07|   - '1'
			-'02' - Extravio
			-'03' - Roubo
			-'05' - VariaГЦo
			-'06' - Obsolencia
			-'07' - Sucateamento
		 '04|09|12'              - '5'
		     04 - DoaГЦo
		     09 - ReavaliaГЦo
		     12 - Penhora
	   --------------------------------------------------------------------- */	
	If Substring(cMotivo,1,2) == "01"
		cMotSF9 := "2"
	ElseIf Substring(cMotivo,1,2) == "10"
		cMotSF9 := "3"
	ElseIf Substring(cMotivo,1,2) == "23"
		cMotSF9 := "4"
	ElseIf Substring(cMotivo,1,2) $ "02|03|05|06|07"
		cMotSF9 := "1"
	Else    //Outros , exemplo ->12-penhora/04-DoaГЦo/09-ReavaliaГЦo
		cMotSF9 := "5"
	EndIf
	
	RecLock("SF9")
	SF9->F9_DOCNFS := cNota
	SF9->F9_SERNFS := cSerie
	SF9->F9_ITEMNFS := cNFItem
	SF9->F9_DTEMINS:= dBaixa030
	SF9->F9_MOTIVO := cMotSF9
	SF9->F9_BXICMS += nPropSF9
	//Tratamento para indicar que eh uma baixa parcial - Utilizado para montar a legenda
	If SF9->(F9_BXICMS>0 .And. F9_BXICMS+F9_VLESTOR<F9_VALICMS)
		SF9->F9_BAIXAPR := "1"
	Else
		SF9->F9_BAIXAPR := "0"
	EndIf
	MsUnLock()
	if SN3->N3_TIPO = '01' // So grava SFA se o tipo for 01 - FISCAL
		RecLock("SFA",.T.)
		SFA->FA_FILIAL := xFilial("SFA")
		SFA->FA_DATA   := dBaixa030
		SFA->FA_TIPO   := "2"
		SFA->FA_VALOR  := nVlrSFA
		SFA->FA_FATOR  := nFatorSFA * IIf(lCredito,0.25,0.20)
		SFA->FA_CODIGO := SF9->F9_CODIGO
		SFA->FA_ROTINA := "ATFA030"
		SFA->FA_CREDIT := Iif(lCredito,"1","2") //1-Credito; 2-Debito
		//Tratamento para indicar que eh uma baixa parcial - Utilizado para montar a legenda
		If SF9->(F9_BXICMS>0 .And. F9_BXICMS+F9_VLESTOR<F9_VALICMS)
			SFA->FA_BAIXAPR := "1"
		Else
			SFA->FA_BAIXAPR := "0"
		EndIf
		//Segundo Vitor N3-FISCAL no campo FA_MOTIVO deve gravar mesmo conteudo do F9_MOTIVO para uso SPED PIS/COFINS
		SFA->FA_MOTIVO := SF9->F9_MOTIVO
	
		MsUnLock()
	endif
	RecLock("SN3")
	SN3->N3_BXICMS := nPropSF9
	MsUnlock()
EndIf
dbSelectArea("SN3")
****************** CIAP ********************
If lAuto
	nVlVend := 0
Else
	nVlVend := IIf(Type("nVlVend") != "N", 0, nVlVend)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Executa rdmake espec║fico para a Localiza, quando este existir em		Ё
//Ё disco. Observa┤ao: este rdmake solicita o valor de venda do bem			Ё
//Ё para efeitos de contabilizacao. 													Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

If ExistBlock("ATFA030")
	ExecBlock("ATFA030",.F.,.F.)
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza quantidade do ativo no caso de baixas por quantidade.			Ё
//Ё Nas baixas por valor, parciais ou totais, nao altero a quantidade no	Ё
//Ё SN1. 																						Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// Apenas Baixa de Bens do tipo 01,03 e gerencial alteram a quantidade do bem, outros tipo sЦo controles contАbeis e sС influenciam no valor do bem
If SN3->N3_TIPO $ '01/03' .Or. AFXVLGer(SN3->N3_FILIAL,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_TPSALDO)
	If nQuant != nQtdorig  //Somente na Baixa Parcial por Qtde
		If lQuant
			Reclock("SN1")
			SN1->N1_QUANTD -= nQuant
			msUnlock()
			
			If lBxFilho
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Se for baixa de seus agregados atualiza as quantidades uma vez   Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				lQuant := .F.
			Endif
		Endif
		
	Else
		If Round(aVlrAtual[1],X3Decimal("N3_VORIG1")) = Round(aValBaixa[1],X3Decimal("N3_VORIG1"))
			
			If !SN3->N3_TIPO $ "02|04"
				cOldArea := Alias()
				RecLock("SN1")
				SN1->N1_QUANTD := 0
				SN1->N1_BAIXA	:= dBaixa030
				msUnlock()
				dbSelectArea(cOldArea)
			EndIf
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If lUsaMNTAT .AND. !EMPTY(SN1->N1_CODBEM)
				AFGRBXIntMnt(SN1->N1_CODBEM,SN1->N1_BAIXA,"ATFA030",.F.,cNota)
			EndIf
			
		Endif
	Endif
EndIf


//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se houve baixa parcial ou total.										Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SN3")
IF Str(aValBaixa[1],18,2) = Str(aVlrAtual[1],18,2)	// Baixa Total

	//AVP
	//Se for um tipo AVP efetuo os movimentos de AVP
	//Exceto quando for uma transferencia entre filiais (lAtfa060) pois neste caso
	//Os processos sao diferentes de uma baixa comum
	If lAvpAtf .and. SN3->N3_TIPO == '14' .and. !lAtfa060
		aRecCtb := AF030AVP(.T.,dBaixa030,,cIdMov)
	Endif	

	RecLock("SN3")
	SN3->N3_BAIXA	:= "1"
	SN3->N3_IDBAIXA := "1"
	SN3->N3_DTBAIXA := dBaixa030
	SN3->N3_VRCMES1 := Round( nValCorr , X3Decimal("N3_VRCMES1") )
	SN3->N3_VRCBAL1 += SN3->N3_VRCMES1
	SN3->N3_VRCACM1 += SN3->N3_VRCMES1
	
	SN3->N3_VRCDM1  := Round( nValCorDep, X3Decimal("N3_VRCDM1") )
	SN3->N3_VRCDB1  += SN3->N3_VRCDM1
	SN3->N3_VRCDA1  += SN3->N3_VRCDM1
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe("SN3","N3_VRDMES",{|x| Round( aValDepr[x] , X3Decimal( If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)) )) })
	Else
		SN3->N3_VRDMES1 := Round( aValDepr[1] , X3Decimal("N3_VRDMES1") )
		SN3->N3_VRDMES2 := Round( aValDepr[2] , X3Decimal("N3_VRDMES2") )
		SN3->N3_VRDMES3 := Round( aValDepr[3] , X3Decimal("N3_VRDMES3") )
		SN3->N3_VRDMES4 := Round( aValDepr[4] , X3Decimal("N3_VRDMES4") )
		SN3->N3_VRDMES5 := Round( aValDepr[5] , X3Decimal("N3_VRDMES5") )
	EndIf
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe("SN3","N3_VRDBAL",{|x| SN3->&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x))) + SN3->&(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x))) })
	Else
		SN3->N3_VRDBAL1 += SN3->N3_VRDMES1
		SN3->N3_VRDBAL2 += SN3->N3_VRDMES2
		SN3->N3_VRDBAL3 += SN3->N3_VRDMES3
		SN3->N3_VRDBAL4 += SN3->N3_VRDMES4
		SN3->N3_VRDBAL5 += SN3->N3_VRDMES5
	EndIf
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe("SN3","N3_VRDACM",{|x| SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) + aValDepr[x] })
	Else
		SN3->N3_VRDACM1 += aValDepr[1]
		SN3->N3_VRDACM2 += aValDepr[2]
		SN3->N3_VRDACM3 += aValDepr[3]
		SN3->N3_VRDACM4 += aValDepr[4]
		SN3->N3_VRDACM5 += aValDepr[5]
	EndIf
	SN3->N3_SEQ     := SN3->N3_SEQ
	SN3->N3_SEQREAV := cSeqReav
	MsUnlock()
	
	//Atualiza as informaГУes do projeto de imobilizado
	AF030AtProj(SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_TPSALDO,aValDepr)
	
Else
	Af030Parcial(cBase, cItem, cSeq, dBaixa030,,,cIDMOV)
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Na baixa parcial o valor a ser baixado da conta (nValBaixa1,..,Ё
	//Ё nValBaixa5) ┌ SN3->N3_VORIG1+SN3->N3_VRCACM1 na moeda1 e SN3-> Ё
	//Ё N3_VORIG&cMoeda nas outras moedas. Isto para garantir a grava- Ё
	//Ё cao dos mesmos valores em todos os arquivos.                   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lCalcChi
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		aValBx[1] := SN3->N3_VORIG1+SN3->N3_AMPLIA1+SN3->N3_VRCACM1
		For nX := 2 to __nQuantas
			cMoed := Alltrim(Str(nX))
			aValBx[nX] := SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
		Next
	EndIf
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Garantir que grave os mesmos nros no SN5 							Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

// *******************************
// Controle de multiplas moedas  *
// *******************************
If !lCalcChi
	aValBx[1] := SN3->N3_VRDACM1+SN3->N3_VRCDA1
	If lMultMoed
		AtfMultMoe(,,{|x| If(x=1,.F.,aValBx[x] := SN3->&( If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)) )) })
	Else
		aValBx[2] := SN3->N3_VRDACM2
		aValBx[3] := SN3->N3_VRDACM3
		aValBx[4] := SN3->N3_VRDACM4
		aValBx[5] := SN3->N3_VRDACM5
	EndIf
Else
	If lMultMoed
		aValBx := AtfMultMoe(,,{|x| 0 })
	Else
		aValBx := {0,0,0,0,0}
	EndIf
EndIf


//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Deprecia┤└o)									Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
nTotDepr := 0
If lMultMoed
	AtfMultMoe(,,{|x| nTotDepr += aValDepr[x] })
Else
	nTotDepr += aValDepr[1]
	nTotDepr += aValDepr[2]
	nTotDepr += aValDepr[3]
	nTotDepr += aValDepr[4]
	nTotDepr += aValDepr[5]
EndIf
If nTotDepr # 0
	cOcorr 	   := IIF( SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "20", IIF(SN3->N3_TIPO == "07","10",IIF(SN3->N3_TIPO=="08","12",IIF(SN3->N3_TIPO == "09","11","06"))))
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"3",nQuant,cTpSaldo,,aValDepr,aDadosComp,,,,,lContOn,cPadrao)
EndIf

// *******************************
// Controle de multiplas moedas  *
// *******************************
If nTotDepr # 0
	cOcorr 	   := IIF( SN3->N3_TIPO $ ("10,12,16,17,14,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "20", IIF(SN3->N3_TIPO == "07","10",IIF(SN3->N3_TIPO=="08","12",IIF(SN3->N3_TIPO == "09","11","06"))))
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",nQuant,cTpSaldo,,aValDepr,aDadosComp,,,,,lContOn,cPadrao)
EndIf

//Acrescentado por Fernando Radu Muscalu em 10/05/2011
If nTotDepr # 0
		
	If lLP_Rat
		
		If lPrim 	 //Se for 1a vez.
			
			nHdlPrv := HeadProva(cLoteAtf,"ATFA030",Substr(cUsername,1,6),@cArquivo)
			
			If lAuto .Or. lBxFilho
				lPrim := .F.
			Endif
			
			lCtbRat := .t.
		Endif
		
	Endif
	
	lCtbAux := .T.
	If Valtype(mv_par01) == "N"
		lCtbAux := mv_par01 <> 3
	EndIf
	
	aRateio := ATFRTMOV(	SN3->N3_FILIAL,;
	SN3->N3_CBASE,;
	SN3->N3_ITEM,;
	SN3->N3_TIPO,;
	SN3->N3_SEQ,;
	dBaixa030,;
	cIdMov,;
	aValDepr,;
	lCtbAux,;
	"1",;
	nHdlPrv,;
	cLoteATF,;
	@nTotal,;
	"1" )
	
	If Len(aRateio) > 0
		//baixar o rateio, se o bem foi baixado por completo
		If SN3->N3_BAIXA == "1"
			Af011AtuStatus(aRateio[1],aRateio[2],"4")
		Endif
		
	Endif
Endif
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo movimenta┤└o (Corre┤└o) 										Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
IF nValCorr # 0
	cOcorr 	   := "07"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round( nValCorr , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"2",nQuant,cTpSaldo,,aValores,aDadosComp)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Corre┤└o da Deprecia┤└o)					Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorDep # 0
	cOcorr 	   := "08"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorDep , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",0,cTpSaldo,,aValores,aDadosComp)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Corre┤└o da Deprecia┤└o)					Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorDep # 0
	cOcorr 	   := "08"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorDep , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"5",0,cTpSaldo,,aValores,aDadosComp)
	
End

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera registro de movimenta┤└o														Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
nTotBaix := 0
If lMultMoed
	AtfMultMoe(,,{|x| nTotBaix += aValBaixa[x] })
Else
	nTotBaix += aValBaixa[1]
	nTotBaix += aValBaixa[2]
	nTotBaix += aValBaixa[3]
	nTotBaix += aValBaixa[4]
	nTotBaix += aValBaixa[5]
EndIf
If ! SN3->N3_TIPO $ "07, 08,09" .And.;// NЦo considerar o item de depreciaГЦo acelerada incentivada
	(nTotBaix # 0)
	
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM) .And. cCodMot == '01',Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	
	cOcorr 	   := "01"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"1",nQuant,cTpSaldo,,aValBaixa,aDadosComp,,,,,lContOn,cPadrao)
	PcoDetLan("000370","01","ATFA030")
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera registro de movimenta┤└o														Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorr # 0
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM) .And. cCodMot == '01',Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	cOcorr 	   := "07"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorr , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"1",nQuant,cTpSaldo,,aValores,aDadosComp)
Endif

// *******************************
// Controle de multiplas moedas  *
// *******************************
nTotBaix := 0
If lMultMoed
	AtfMultMoe(,,{|x| nTotBaix += aValBx[x] })
Else
	nTotBaix += aValBx[1]
	nTotBaix += aValBx[2]
	nTotBaix += aValBx[3]
	nTotBaix += aValBx[4]
	nTotBaix += aValBx[5]
EndIf
If nTotBaix # 0
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM) .And. cCodMot == '01',Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	cOcorr 	   := "01"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",nQuant,cTpSaldo,,aValBx,aDadosComp,,,,,lContOn,cPadrao)
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza o arquivo de simulacoes, caso este exista  	Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды

If lSN7
	dbSelectArea("SN7")
	dbSetOrder(1)
	If dbSeek(xFilial("SN7")+SN3->N3_CBASE+SN3->N3_ITEM)
		If Empty(SN7->N7_VLREAL)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Atualiza o arquivo de simulacoes, desde que o valor 	Ё
			//Ё Real nao esteja preenchido. Pois caso o bem possua a-Ё
			//Ё gregados sera gravado o valor do bem de tipo 01.    	Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			RecLock("SN7")
			SN7->N7_DTBAIXA := dBaixa030
			SN7->N7_MOTIVO  := cMotivo
			SN7->N7_NOTA    := cNota
			SN7->N7_SERIE   := cSerie
			SN7->N7_VLREAL  := Round( aValBaixa[1] , X3Decimal("N4_VLROC1") )
		EndIf
		MsUnlock()
	Endif
EndIf


If lSN3Saldo
	cTpSaldo := SN3->N3_TPSALDO
EndIf

// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
lAtClDepr := AtClssVer(SN1->N1_PATRIM)

If ! SN3->N3_TIPO $ "07,08,09"
	cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr/*.AND. EMPTY(SN1->N1_PATRIM)*/,"5","D"))
	cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .AND. EMPTY(SN1->N1_PATRIM),"6","6"))
	ATFSaldo(	SN3->N3_CCONTAB,dBaixa030,cTipoImob,aValBaixa[1],aValBaixa[2],aValBaixa[3],aValBaixa[4],aValBaixa[5],;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValBaixa,cTpSaldo,cCodMot)
Endif
// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	aValorMoed := AtfMultMoe(,,{|x| If(x=1,nValCorr,0) })
EndIf

cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr/* .AND. EMPTY(SN1->N1_PATRIM)*/,"5","D"))
cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .AND. EMPTY(SN1->N1_PATRIM),"6","6"))
ATFSaldo(	SN3->N3_CCONTAB,dBaixa030,cTipoCorr,nValCorr,0,0,0,0,;
"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValorMoed ,cTpSaldo,cCodMot)

If lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aValorMoed := AtfMultMoe(,,{|x| If(x=1,nValCorr,0) })
	EndIf
	cTipoCorr := "6"
	ATFSaldo(	SN3->N3_CCORREC,dBaixa030,cTipoCorr,nValCorr,0,0,0,0,;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCOR,,SN3->N3_CLVLCOR,SN3->N3_CCCORR,"2", aValorMoed ,cTpSaldo,cCodMot)
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	// Deprecia┤└o e deprecia┤└o acumulada
	cTipoImob := If( !SN3->N3_TIPO $ ("08,09,10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "4", If(SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM),"Y",If(SN3->N3_TIPO=="09","L","K")))
	ATFSaldo(	SN3->N3_CDEPREC,dBaixa030,cTipoImob,aValDepr[1],aValDepr[2],aValDepr[3],aValDepr[4],aValDepr[5],;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCDEP,,SN3->N3_CLVLDEP,SN3->N3_CCDESP,"3", aValDepr ,cTpSaldo,cCodMot)
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aValorMoed := AtfMultMoe(,,{|x| If(x=1,nValCorDep,0) })
	EndIf
	
	cTipoCorr := "7"
	ATFSaldo(	SN3->N3_CDESP  ,dBaixa030,cTipoCorr,nValCorDep,0,0,0,0,;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCDES,,SN3->N3_CLVLDES,SN3->N3_CCCDES,"5", aValorMoed ,cTpSaldo,cCodMot)
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	cTipoImob := If( !SN3->N3_TIPO $ ("08,09,10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "4", If(SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM),"Y",If(SN3->N3_TIPO=="09","L","K")))
	ATFSaldo(	SN3->N3_CCDEPR ,dBaixa030,cTipoImob,aValDepr[1],aValDepr[2],aValDepr[3],aValDepr[4],aValDepr[5],;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValDepr, cTpSaldo ,cCodMot)
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	cTipoImob := "5"
	ATFSaldo(	SN3->N3_CCDEPR ,dBaixa030,cTipoImob,aValBx[1],aValBx[2],aValBx[3],aValBx[4],aValBx[5],;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValBx,cTpSaldo,cCodMot)
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aValorMoed := AtfMultMoe(,,{|x| If(x=1,nValCorDep,0) })
	EndIf
	cTipoCorr := "7"
	ATFSaldo(	SN3->N3_CCDEPR ,dBaixa030,cTipoCorr,nValCorDep,0,0,0,0,;
	"+",aTxMedia[Val(cMoedaAtf)],SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMoed ,cTpSaldo,cCodMot)
EndIf

If ExistBlock("AF030GRV")
	ExecBlock("AF030GRV",.F.,.F.)
Endif

//Verifica se existe algum SN3 Ativo para o bem e caso nЦo tenha, marca o SN1 como baixado
AFXVlBxN1(SN3->N3_CBASE,SN3->N3_ITEM,dBaixa030)

If IsInCallStack("ATFA440") .Or. IsInCallStack("ATFA004")
	MV_PAR01	:= 2		//Mostra lanГamento contАbil = NЦo
	lPrim		:= .F.		//NЦo criar o nHandle pois jА foi inicializado
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se existe lancamento padrao. 											Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !(IsInCallStack("ATFA060")) // Transferencia Interna И contabilizada pelos lanГamentos da rotina atfa060
	If lAtfCont .And. mv_par01 # 3
		lPadrao := VerPadrao(cPadrao)
		IF lPadrao
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Envia para lan┤amento cont═bil, desde que exista lan┤amento padro-	Ё
			//Ё nizado para o ativo cadastrado. 												Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If Type('nBkpHandle') == 'N' .and.  nHdlPrv == 0
				nHdlPrv := nBkpHandle
			EndIf
			
			If nHdlPrv <= 0 .Or. lPrim
				If !lCtbRat
					nHdlPrv := HeadProva(cLoteAtf,"ATFA030",Substr(cUsername,1,6),@cArquivo)
					If lAuto .Or. lBxFilho
						lPrim := .F.
					Endif
				Endif
			Endif
			nTotal += DetProva(nHdlPrv,cPadrao,"ATFA030",cLoteAtf)
			
			If lCtbBxInt // Contabiliza baixa na integraГЦo
				If nHdlPrv > 0 .And. ( nTotal > 0 )
					RodaProva(nHdlPrv, nTotal)
					cA100Incl(cArquivo,nHdlPrv,3,cLoteAtf,mv_par01 == 1,mv_par02 == 1)
				Endif
			Endif
		EndIf
	EndIf
EndIf
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Final da Protecal via TTS 															Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

dbSelectArea(cOldArea)
Return



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁTudOk    ╨Autor  ЁMicrosiga           ╨ Data Ё  11/18/11   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё ValidaГЦo de confirmaГЦo da rotina                         ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function TudOk(nOpt,nValorVend,lBxFilho,cMotivo,cNota,cSerie,lBx,cNFItem,lCancela,nQuant)
Local lValidaNFD := SuperGetMV("MV_AF30NDV", .F., .F.)
Local aAreaSav := GetArea()
Local cMotSF9  := ''
Local cTypesNM		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cTypes10		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models

Default lCancela := .T.

If lIsRussia // CAZARINI - Flag to indicate if is Russia location
	cTypesNM := "*" + AtfNValMod({3,4}, "*")
	cTypes10 := "*" + AtfNValMod({1}, "*")
Endif

nOpt := 1
If SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)
	If Subs(cMotivo,1,2) == '01' // Motivo de Venda
		If nValorVend == 0.00
			Help(" ",1,"AF030VLVEN")
			nOpt := 0
		Endif
	Endif
Else
	If lBxFilho .And. SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)
		If Subs(cMotivo,1,2) == '01' // Motivo de Venda
			If nValorVend == 0.00
				Help(" ",1,"AF030VLVEN")   //O Valor de Venda nao pode ser zero
				nOpt := 0
			Endif
		Endif
	Endif
Endif
If nOpt == 1
	//Bem em Penhora-> nЦo pode ser baixado pelo motivo "01-Venda"
	//Bem Penhorado -> somente poderА ser baixado pelo motivo "12-Penhora"
	If SN1->N1_PENHORA == "2" .And. Subs(cMotivo,1,2) == "01"			//Em Penhora
		HELP(" ",1,"AF030EMPE")
		nOpt := 0
	ElseIf SN1->N1_PENHORA == "3" .And. Subs(cMotivo,1,2) != "12"		//Penhorado
		HELP(" ",1,"AF030PENH")
		nOpt := 0
	EndIf
EndIf
If nOpt == 1 .And. ExistBlock("AF030VBX")
	If !ExecBlock("AF030VBX",.F.,.F.,{cMotivo,cNota,cSerie,lBx})
		nOpt := 0
	Endif
Endif
If nOpt == 1
	If cPaisloc == "BRA" .and. lValidaNFD  // somente qdo brasil e tiver controle de ciap 
		If !lCancela
			If cMotivo = '23' //DevoluГЦo de Item da Nota
				If Empty(cNota) .or. Empty(cSerie) .or. Empty(cNFItem)
					Help(" ",1, "AF030NFDV",,STR0093,1,0)  //'O Nro/SИrie/Item da Nota devem ser informados se o parБmetro MV_AF30NDV for T e o motivo da baixa for 23-DevoluГЦo'
					nOpt := 0
				EndIf
			EndIf
		EndIf
	EndIf
Endif
if nOpt == 1                       

	if If(lBxFilho .and. SN3->N3_TIPO <> '01', AF030HASN3(), SN3->N3_TIPO = '01') .and. !Empty(SN1->N1_CODCIAP)
		If Substring(cMotivo,1,2) == "01"
			cMotSF9 := "2"
		ElseIf Substring(cMotivo,1,2) == "10"
			cMotSF9 := "3"
		ElseIf Substring(cMotivo,1,2) == "23"
			cMotSF9 := "4"
		ElseIf Substring(cMotivo,1,2) $ "02|03|05|06|07"
			cMotSF9 := "1"
		Else    //Outros , exemplo ->12-penhora/04-DoaГЦo/09-ReavaliaГЦo
			cMotSF9 := "5"
		EndIf

		dbSelectArea("SFA") 
		SFA->(dbSetOrder(1))
		if AF30HASAF( SN1->N1_CODCIAP, dBaixa030, '2' , cMotSF9)
			Help("",1, "AFA030CIAP")
			nOpt := 0
		endif	
	endif
endif   

if nOpt == 1                       
  if nQuant = SN1->N1_QUANTD .and. AF30NITEM( SN1->N1_CBASE, SN1->N1_ITEM) > 1 .and.  !lBxFilho
  	Help("",1,"AFA030BXTO")
	nOpt := 0
  endif

endif   

RestArea(aAreaSav)
Return nOpt


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁCheckCombo ╨Autor  ЁMicrosiga           ╨ Data Ё  09/04/09   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁValida o combo Box                                          ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function CheckCombo(onVlVend,lBxFilho,lVlVend,cBxFilho)
Local cOldArea := Alias()
Local nPosSN3  := RECNO()
Local aTiposReav := {}
Local nX		:= 0

Local cTypesNM		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cTypes10		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models

If lIsRussia // CAZARINI - Flag to indicate if is Russia location
	cTypesNM := "*" + AtfNValMod({3,4}, "*")
	cTypes10 := "*" + AtfNValMod({1}, "*")
Endif

//Tipos de reavaliaГЦo
AAdd(aTiposReav,"02") //reavaliacao
AAdd(aTiposReav,"04") //Lei 8.200
AAdd(aTiposReav,"41") // ReavaliaГЦo anual de bens nЦo totalmente depreciados
AAdd(aTiposReav,"42") // ReavaliaГЦo anual de bens totalmente depreciados
AAdd(aTiposReav,"50") // Colombia: Depreciacao gerencial "metodo linear"
AAdd(aTiposReav,"51") // Colombia: Depreciacao gerencial "soma dos digitos"
AAdd(aTiposReav,"52") // Colombia: Depreciacao gerencial "reducao de saldos"
AAdd(aTiposReav,"53") // Colombia: Depreciacao gerencial "soma dos anos"
AAdd(aTiposReav,"54") // Colombia: Depreciacao gerencial "unidades produzidas"

For nX := 1 to Len(aTiposReav)
	If dbSeek(xFilial("SN3")+SN3->N3_CBASE+ SN3->N3_ITEM+aTiposReav[nX])
		lVlVend := .T.
		Exit
	Endif
Next nX

dbGoto(nPosSN3)
lBxFilho := IIf(cBxFilho=="N",.F.,.T.)

If SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)
	If Subs(cMotivo,1,2) = Subs(aMotivos[1],1,2)
		lVlVend := .T.
	Else
		nVlVend := 0
		lVlVend := .F.
	Endif
Else
	If lBxFilho
		If Subs(cMotivo,1,2) = Subs(aMotivos[1],1,2)
			lVlVend := .T.
		Else
			lVlVend := .F.
		Endif
	Else
		lVlVend := .F.
	Endif
Endif
dbSelectArea(cOldArea)
If lVlVend
	onVlVend:Enable()
Else
	onVlVend:Disable()
Endif
onVlVend:Refresh()
Return


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁCheckOK   ╨Autor  ЁMicrosiga           ╨ Data Ё  09/04/09   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Valida o checbox Baixa Filhos                              ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function CheckOK(lBxFilho,onVlVend,olBxFilho)
Local cTypesNM		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cTypes10		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models

If lIsRussia // CAZARINI - Flag to indicate if is Russia location
	cTypesNM := "*" + AtfNValMod({3,4}, "*")
	cTypes10 := "*" + AtfNValMod({1}, "*")
Endif

If SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)
	If Subs(cMotivo,1,2) = Subs(aMotivos[1],1,2)
		onVlVend:Enable()
	Else
		onVlVend:Disable()
	Endif
Else
	If Subs(cMotivo,1,2) = Subs(aMotivos[1],1,2)
		If lBxFilho
			onVlVend:Enable()
		Else
			onVlVend:Disable()
		Endif
	Else
		onVlVend:Disable()
	Endif
Endif

onVlVend:Refresh()
Return lBxFilho

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Cance ЁAutor  Ё Wagner Xavier		  Ё Data Ё 03/08/93 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Cancelamento de uma determinada baixa do ativo				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё Generico 													Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Cance(cAlias,nReg,nOpc,aM,lAutomatico,aAutoCab,lAf030Auto,lRetExt)

Local oNVlVend
Local nOpt := 0
Local cBase
Local cItem
Local cTipo 		:= ""
Local cSeq  		:= ""
Local nMainRec 		:= RecNo()
Local nAscan 		:= 0
Local lCancFilho 	:= .F.   //Se .T., cancela os filhos (agregados -tipos 1-2-4)
Local aSeq    		:= {}
Local nTam
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local nX
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
Local lRet := .T.
Local cTpSld		:= ""

//AVP2
Local aRecnoFNO := {}
Local cIdMovSN4 := ""

//MRG
//Verifica implementacao da Margem Gerencial
Local lMargem 	:= AFMrgAtf()
Local lIsTipo10 := .F.
Local lIsTipo13 := .F.
Local cTypes10		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models
Local cTypesNM		:= "" // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cFilSN4 		:= ""
Private lAtuQuant  	:= .T.   //Ja atualizou as qtds no cance/o de baixas parciais
// *******************************
// Controle de multiplas moedas  *
// *******************************
Private cPictQtd,aPicture := {}
Private aValBaixa 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

Private aMotivos	:={}
Private lPadrao 	:= .F.
Private cPadrao  := ""
Private cArquivo 	:= ""
Private cMoeda
Private dBaixa030 	:= dDataBase
Private cMotivo 	:= ""
Private nPercBaixa	:= 100

If Type("lAtfCont") != "L"
	lAtfCont := IIf(Trim(GetMv("MV_ATFCONT"))="O",.T.,.F.)
Endif

DEFAULT lAutomatico	:= .F.
DEFAULT lAf030Auto	:= .F.
DEFAULT lRetExt		:= .F. // Retorno para chamada externa

If lIsRussia // CAZARINI - Flag to indicate if is Russia location
	cTypes10 := "|" + AtfNValMod({1}, "|")
	cTypesNM := "|" + AtfNValMod({3,4}, "|")
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica se o registro est═ em uso por outra esta┤└o Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !SoftLock(cAlias)
	lRet := .T.	
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se podera cancelar a baixa do ativo conforme oЁ
//Ёparametro MV_ATFBXDP                                   Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lRet .And. lAtfCont
	If !AF030DtBx( DDATABASE )
		lRet := .F.	
	EndIf
EndIf

If lRet .And. SN1->N1_STATUS $ "2|3"
	Help(" ",1,"A030BLOQ")   //Este bem esta bloqueado, nao poder sofrer baixas.
	lRet := .F.	
EndIf

If lRet
	//AVP
	//Verifica de o AVP esta implantado na base
	lAvpAtf := AFAvpAtf()
	
	//AVP2
	//Verifica implementacao do AVP e AVP parcela
	If lAvpAtf2 == NIL
		lAvpAtf2 := AFAvpAtf2()
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifica o numero do Lote do modulo Ativo Fixo 				  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cLoteAtf := LoteCont("ATF")
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifica tabela de motivos para baixa 												Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SX5")
	dbSeek(xFilial("SX5")+"16")
	While X5_FILIAL+X5_TABELA == cFilial+"16"
		If !( Alltrim(SX5->X5_CHAVE) $ '13|08|18')
			cCapital := Capital(X5Descri())
			AAdd( aMotivos, SubStr(X5_CHAVE,1,2 ) + "-" + SubStr(cCapital,1,12 ) )
		EndIf
		dbSkip()
	End
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Pesquisa picture para valores do ativo												Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cPictQtd  := PesqPict("SN1","N1_QUANTD", 10)
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe(,,{|x| aAdd(aPicture, PesqPict("SN3", "N3_VORIG"+Alltrim(Str(x)) , 20) ) })
	Else
		aPicture := {nil,nil,nil,nil,nil}
		aPicture[1] := PesqPict("SN3","N3_VORIG1", 20)
		aPicture[2] := PesqPict("SN3","N3_VORIG2", 20)
		aPicture[3] := PesqPict("SN3","N3_VORIG3", 20)
		aPicture[4] := PesqPict("SN3","N3_VORIG4", 20)
		aPicture[5] := PesqPict("SN3","N3_VORIG5", 20)
	EndIf
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Nфo permite o cancelamento da baixa se esta for anterior	  Ё
	//Ё ao ёltimo c═lculo														  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If lAtfCont   //cAlias == "SN3"
		cBase 	 := SN3->N3_CBASE
		cItem 	 := SN3->N3_ITEM
		cTipo 	 := SN3->N3_TIPO
	Else
		lCancFilho := .T.
		cBase    := SN4->N4_CBASE
		cItem    := SN4->N4_ITEM
		cTipo    := SN4->N4_TIPO
		cSeq     := SN4->N4_SEQ
		dBaixa030:= SN4->N4_DATA
		
		dbSelectArea("SN3")
		dbSetOrder(1)
		dbSeek(xFilial()+cBase+cItem+cTipo)
	EndIf
	
	cFilSN4 := xFilial("SN4")
	
	dbSelectArea("SN4")//N4_FILIAL+N4_CBASE+N4_ITEM+N4_TIPO+DTOS(N4_DATA)+N4_OCORR+N4_SEQ
	
	SN4->(dbSeek(cFilSN4 + SN3->N3_CBASE + SN3->N3_ITEM + SN3->N3_TIPO))
	
	While SN4->(!EOF()) .And. SN4->N4_FILIAL ==  cFilSN4 .And. ;
			SN4->N4_CBASE	==  SN3->N3_CBASE	.And. ;
			SN4->N4_ITEM	==  SN3->N3_ITEM	.And. ;
			SN4->N4_TIPO	==  SN3->N3_TIPO
	
		If SN4->N4_TIPOCNT $ "3|4" .AND. Dtos(SN4->N4_DATA) < Dtos(SuperGetMv("MV_ULTDEPR"))
			HELP("",1,"AF030CANCE",,STR0111,1,0)//O cancelamento da baixa nЦo pode ser realizado! Existem depreciaГУes realizadas apСs a efetivaГЦo da baixa do bem.					
			lRet := .F.	
			Exit	 
		EndIf
	
		SN4->(dbSkip())
	EndDo
Endif

If lRet
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Inicio do bloco protegido via TTS									  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	Begin Transaction
	
	PcoIniLan("000370")
	While .T.
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica existencia do Ativo 										  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN1")
		dbSetOrder(1)
		dbSeek(cFilial+cBase+cItem)
		IF !Found()
			Help(" ",1,"020ATIVO")
			lRet := .F.
			EXIT
		EndIf
		
		If lAtfCont   //cAlais=="SN3"
			dbSelectArea("SN3")
			cBase 	  := SN3->N3_CBASE
			cItem 	  := SN3->N3_ITEM
			cTipo 	  := SN3->N3_TIPO
			cTpSld	  := SN3->N3_TPSALDO
			cSeq      := SN3->N3_SEQ
			dBaixa030 := SN3->N3_DTBAIXA
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verifica se se trata de uma baixa									  Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			dbSelectArea("SN3")
			IF Val( SN3->N3_BAIXA ) == 0
				Help(" ",1,"NAOBAIXA")
				lRet := .F.
				Exit
			ElseIf SN3->N3_BAIXA == "2"
				Help(" ",1,"BAIXADIANT")
				lRet := .F.
				Exit
			EndIf
		EndIf
	
		If lIsRussia
			If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
				Help(" ",1,"SN3NOOPER") // This asset is not in operation. Put it into operation
				lRet := .F.
				Exit
			Endif
		Endif
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Pesquisa baixa no arquivo de movimenta┤└o					  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SN4")
		dbSetOrder(1)//N4_FILIAL+N4_CBASE+N4_ITEM+N4_TIPO+DTOS(N4_DATA)+N4_OCORR+N4_SEQ
		If !dbSeek(xFilial("SN4")+cBase+cItem+cTipo+DTOS(dBaixa030)+"01"+cSeq)
			Help(" ",1,"AF020BAIXA")
			lRet := .F.
			Exit
		EndIf
		
		If SN4->N4_MOTIVO $ "01/10" .And. !Empty(SN4->N4_NOTA)
			lRet := A030VlNota(SN4->N4_NOTA,SN4->N4_SERIE)
			If !lRet
				Help(" ",1,"AF030CNOTA",,STR0074 + SN4->N4_NOTA + STR0075 + SN4->N4_SERIE + STR0076  ,1,0)//"Baixa de Ativo atrelado ao documento de saМda : " ## " Serie: " ## ".Por favor exclua a nota fiscal "
				Exit
			EndIf
		EndIf
	
		//AVP
		//Verifico se e um Tipo 10
		lIsTipo10 := (SN4->N4_TIPO $ ('10' + cTypes10) )
		lIsTipo13 := (SN4->N4_TIPO == '13')	
		If SN4->N4_TIPO == '14'
			Help(" ",1,"A030TP14",, STR0080 +CHR(10)+STR0079 ,1,0)	
	  		Exit
		Endif	
	
		//MRG
		//Verifico se e um Tipo 15 e se tem o tipo 10 baixado na mesma sequencia (baixei o Tipo 15 atraves do Tipo 10)
		If SN4->N4_TIPO == '15' .and. AfVerTp10(SN4->N4_CBASE,SN4->N4_ITEM,SN4->N4_TPSALDO,SN4->N4_DATA,SN4->N4_IDMOV)
			Exit
		Endif		
	
		If lAtfCont   
			// *******************************
			// Controle de multiplas moedas  *
			// *******************************
			aValBaixa[1] 	:= SN3->N3_VORIG1+SN3->N3_VRCACM1+SN3->N3_AMPLIA1
			For nX := 2 to __nQuantas
				cMoed	:= Alltrim(Str(nX))
				aValBaixa[nX] 	:= SN3->&("N3_VORIG"+cMoed)+SN3->&(If(nX>9,"N3_AMPLI","N3_AMPLIA")+cMoed)
			Next
		Else
			// *******************************
			// Controle de multiplas moedas  *
			// *******************************
			If lMultMoed
				AtfMultMoe(,,{|x| aValBaixa[x] 	:= SN4->&( "N4_VLROC"+Alltrim(Str(x)) ) })
			Else
				aValBaixa[1] := SN4->N4_VLROC1
				aValBaixa[2] := SN4->N4_VLROC2
				aValBaixa[3] := SN4->N4_VLROC3
				aValBaixa[4] := SN4->N4_VLROC4
				aValBaixa[5] := SN4->N4_VLROC5
			EndIf
		EndIf
		
		nVlVend			:= SN4->N4_VENDA
		
		cMotivo := ""
		For nAscan := 1 to Len( aMotivos )
			If SN4->N4_MOTIVO == Left( aMotivos[nAscan] ,2)
				cMotivo := aMotivos[ nAscan ]
			Endif
		Next
		
		// Apenas serА possivel cancelar a baixa de um bem convertido pela rotina de cancelamento de conversЦo (ATFA010)
		If SN4->N4_MOTIVO == '13' .And. !IsInCallStack("AF010CVMet")
			Help(" ",1,"AF030CCONV",,STR0067,1,0)//"Baixas com motivo 13-ConversЦo apenas podem ser cancelado pela rotina de cancelamento de conversЦo(ATFA010)"
			lRet := .F.
			Exit
		EndIf
	
		If SN4->N4_MOTIVO == '14' .And. !IsInCallStack("A103GrvAtf")
			Help(" ",1,"AF030DEB",,STR0082,1,0)//"Baixas com motivo 14 apenas podem ser cancelado pela exclusЦo da nota de crИdito/dИbito"
			lRet := .F.
			Exit
		EndIf
	
		If SN4->N4_MOTIVO $ '13/15/16/17' .And. !IsInCallStack("ATFA320")
			Help(" ",1,"AF030TERC",,STR0071,1,0)//"Baixas com motivo de bens de terceiro apenas podem ser canceladas pela rotina de Controle De Terceiros(ATFA320)"
			lRet := .F.
			Exit
		EndIf
		
		If SN4->N4_MOTIVO $ '18' .And. !IsInCallStack("AF060Canc")
			Help(" ",1,"AF030FILAUT",,STR0077,1,0)//"Baixas com motivo 18-Transferencia Interna de Filial nЦo pode ser cancelada"
			lRet := .F.
			Exit
		EndIf
	
		If ATFXVerPrj(SN3->N3_CBASE,SN3->N3_ITEM, .T. )
			lRet := .F.
			Exit
		EndIf 
		
		//AVP
		//Valida se cancelamento da baixa e possivel
		If lAvpAtf .and. AFNoCanAvp(cBase,cItem,cTipo,SN4->N4_IDMOV,SN4->N4_DATA,SN4->N4_TPSALDO)
			Help(" ",1,"AF030NOCAN",,STR0081,1,0)
			lRet := .F.
			Exit
		Endif
		
		//AVP2
		//Verifica se o bem foi gerado por AVP Parcela
		If SN1->N1_PATRIM == 'V' .and. Alltrim(SN1->N1_ORIGEM) == 'ATFA460' .and. !lAf030Auto
			Help(" ",1,"AF010A460B",,STR0086+CRLF+STR0087+SN1->N1_BASESUP +"-"+SN1->N1_ITEMSUP ,1,0)  //'Este ativo foi gerado a partir do processo de constituiГЦo de provisЦo. Este tipo de ativo nЦo poderА ser baixado diretamente. Baixe o ativo superior (PAI).'###"C.Base-Item: "		lRet := .F.
			EXIT
		Endif
	
		If !lAutomatico .And. !lAf030Auto
			nOpt := Af030DadosBx(	cBase, cItem, cTipo, SN4->N4_QUANTD, SN4->N4_QUANTD, 0.00,;
			@onVlVend,@lCancFilho,.F.,"S", SN4->N4_NOTA,;
			SN4->N4_SERIE, .T.,,,,.T.,,cTpSld)
		Else
			nOpt := CONFIRMA
		Endif
		IF nOpt == ABANDONA .or. nOpt == 0
			lRet := .F.
			Exit
		EndIf
		
		If nOpt == REDIGITA
			Loop
		Endif
		
		//AVP2
		//Se o bem for classificado como Orcamento, os filhos serao baixados 
		//independendo da escolha do usuacio
		If SN1->N1_PATRIM $ 'O|V' 
			lCancFilho := .T.
		Endif		
	
		//Cancela os filhos - agregados tipos "01"/"02"/"04"
		If lCancFilho
			If lAtfCont   //cAlias == "SN3"
				dbSelectarea("SN3")
				dbSetOrder(1)
				cTipo := "01"
				dbSelectArea("SN4")
				dbSetOrder(1)
				cChaveSN4 :=xFilial("SN4")+cBase+cItem
				
				dData := ""
				If dbSeek(cChaveSN4)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Procuro a data em que foi baixado este bem          Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
					While !Eof() .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
						If cSeq = SN4->N4_SEQ .and. SN4->N4_OCORR = "01"
							dData := SN4->N4_DATA
							Exit
						EndIf
						dbSkip()
					EndDo
				EndIf
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Posicionado  tipo 01 Baixado na mesma data e procuroЁ
				//Ё pelos sequencias que foram baixadas nesta DATA.     Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
				cSeq  := "   "
				If dbSeek(cChaveSN4)
					While SN4->(!Eof()) .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
						If SN4->N4_DATA != dData
							dbSkip()
							Loop
						EndIf
						
						If cSeq != SN4->N4_SEQ .And. SN4->N4_OCORR = "01"
							AADD( aSeq,{ SN4->N4_CBASE,SN4->N4_ITEM,SN4->N4_TIPO,SN4->N4_SEQ,;
							SN4->N4_DATA,SN4->N4_SEQREAV })
							cSeq  := SN4->N4_SEQ
		
							//AVP2					
							//Obtenho o ID do movimento para cancelamento
							If SN1->N1_PATRIM == 'O' .and. SN1->N1_TPAVP == '2'
								cIdMovSN4 := SN4->N4_IDMOV					
							Endif					
		
						EndIf
						SN4->(dbSkip())
					EndDo
				EndIf
				
				nTamSeq := Len(aSeq)
				dbSelectArea("SN3")
				dbSetOrder(1)
				dbSeek(cChaveSN4)
				nTam := 0
				For nTam := 1  to nTamSeq
					//                       cbase        + nItem       +cTipo   +"1"
					If dbSeek(xFilial()+aSeq[nTam][1]+aSeq[nTam][2]+aSeq[nTam][3]+"1")
						While !Eof() .And. SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO+"1"=;
							xFilial("SN3")+aSeq[nTam][1]+aSeq[nTam][2]+aSeq[nTam][3]+"1"
							If SN3->N3_SEQ = aSeq[nTam][4]
								dBaixa030 := dData
								a030AtuArq(cAlias,lCancFilho,dBaixa030, aSeq[nTam][4], aSeq[nTam][5], aSeq[nTam][6])
								Exit
							Endif
							dbSkip()
						EndDo
					EndIf
				Next
			Else    //cAlias=="SN4" e Cancela Filhos (01-02-04)
				dbSelectArea("SN4")
				dbSetOrder(1)
				cChaveSN4 :=xFilial()+cBase+cItem
				If dbSeek(cChaveSN4)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Procuro a data em que foi baixado este bem          Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
					While !Eof() .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
						If !Empty(SN4->N4_MOTIVO) .And. DTOS(SN4->N4_DATA)==(Dtos(dBaixa030))
							a030AtuArq(cAlias,lCancFilho,dBaixa030, SN4->N4_SEQ,dBaixa030,SN4->N4_SEQREAV)
						EndIf
						dbSkip()
					EndDo
				EndIf
			EndIf
		//AVP
		//Se for cancelamento de Tipo 10 e nao informado para cancelar Filhos
		//forco o cancelamento de Tipo 10 e 14.
		//MRG
		//Se for cancelamento de Tipo 10 e nao informado para cancelar Filhos
		//forco o cancelamento de Tipo 10 e 15.
		ElseIf (lAvpAtf .and. lIsTipo10) .or. (lMargem .and. (lIsTipo10 .or. lIsTipo13) )
	
			lCancFilho := .T.
	
			If lAtfCont   //cAlias == "SN3"
				dbSelectarea("SN3")
				dbSetOrder(1)
				cTipo := If(lIsTipo13,"13","10")
				dbSelectArea("SN4")
				dbSetOrder(1)
				cChaveSN4 :=xFilial()+cBase+cItem
		
				dData := ""
				If dbSeek(cChaveSN4)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Procuro a data em que foi baixado este bem          Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
					While !Eof() .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
						If cSeq = SN4->N4_SEQ .and. SN4->N4_OCORR = "01"
							dData := SN4->N4_DATA
							Exit
						EndIf
						dbSkip()
					EndDo
				EndIf
	   	
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Posicionado  tipo 01 Baixado na mesma data e procuroЁ
				//Ё pelos sequencias que foram baixadas nesta DATA.     Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
				cSeq  := "   "
				While !Eof() .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
					If SN4->N4_DATA != dData
						dbSkip()
						Loop
					EndIf
				
					If cSeq != SN4->N4_SEQ .And. SN4->N4_OCORR = "01" .and. SN4->N4_TIPO $ ("10/13/14/15/16/17" + cTypes10 + cTypesNM) 
	
						AADD( aSeq,{ SN4->N4_CBASE,SN4->N4_ITEM,SN4->N4_TIPO,SN4->N4_SEQ,;
										SN4->N4_DATA,SN4->N4_SEQREAV,SN4->N4_IDMOV })
						cSeq  := SN4->N4_SEQ
	
					EndIf
					dbSkip()
				EndDo
		
				nTamSeq := Len(aSeq)
				dbSelectArea("SN3")
				dbSetOrder(1)
				dbSeek(cChaveSN4)
				nTam := 0
				For nTam := 1  to nTamSeq
					//                       cbase        + nItem       +cTipo   +"1" 
					If dbSeek(xFilial()+aSeq[nTam][1]+aSeq[nTam][2]+aSeq[nTam][3]+"1")
						While !Eof() .And. SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO+"1"=;
												xFilial("SN3")+aSeq[nTam][1]+aSeq[nTam][2]+aSeq[nTam][3]+"1"
							If SN3->N3_SEQ = aSeq[nTam][4]
								dBaixa030 := dData
								a030AtuArq(cAlias,lCancFilho,dBaixa030, aSeq[nTam][4], aSeq[nTam][5], aSeq[nTam][6])
								Exit
							Endif
							dbSkip()
						EndDo
					EndIf
				Next
			Else    //cAlias=="SN4" 
				dbSelectArea("SN4")
				dbSetOrder(1)
				cChaveSN4 :=xFilial()+cBase+cItem
				If dbSeek(cChaveSN4)
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Procuro a data em que foi baixado este bem          Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
					While !Eof() .And. cChaveSN4 = SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM
						If !Empty(SN4->N4_MOTIVO) .And. DTOS(SN4->N4_DATA)==(Dtos(dBaixa030))
							a030AtuArq(cAlias,lCancFilho,dBaixa030, SN4->N4_SEQ,dBaixa030,SN4->N4_SEQREAV)
						EndIf
						dbSkip()
					EndDo
				EndIf
			EndIf
	
		Else
			a030AtuArq(cAlias,lCancFilho,dBaixa030)
		Endif
		
		If !lAuto .and. ( nTotal != 0 )
			RodaProva(nHdlPrv,nTotal)
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Envia para Lancamento Contabil											Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cA100Incl(cArquivo,nHdlPrv,3,cLoteAtf,mv_par01 == 1,mv_par02 == 1)
		Endif
		
		lRetExt := .T.
		
		Exit
	EndDo
	PcoFinLan("000370")
	
	//AVP2 - cancelamento
	If lAvpAtf2 .and. nOpt == CONFIRMA
		//Se o bem for classificado como Orcamento e o AVP deste for por parcela
		//Cancelo a baixa dos filhos
		//Excluo o bem provisСrio gerado pela baixa em cancelamento
		If SN1->N1_PATRIM == 'O' .and. SN1->N1_TPAVP == '2' .and. !Empty(cIdMovSN4)
			BEGIN TRANSACTION
	
				MsgRun(STR0091,"",{|| AFCanProv(SN1->N1_CBASE, SN1->N1_ITEM,SN4->N4_MOTIVO,cIdMovSN4)  })//"Excluindo bens de provisao (AVP parcela)"
	
				Pergunte("AFA030",.F.)		
	
		    END TRANSACTION
		Endif
	
	Endif

	//зддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Libera o softlock instalado acima do while. Ё
	//юддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea(cAlias)
	dbGoTo( nMainRec )
	MSUnlock()
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Final  do bloco protegido via TTS									  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	End Transaction
Endif

Return lRet

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁA030AtuArq  Ё Autor Ё Alice Yamamoto 		  Ё Data Ё 30/12/97 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁCancela a(s) baixa(s) efetuada(s)  e atualiza os Arquivos 	Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁA030AtuArq(cBase,cItem,cTipo,dDtBaixa)        				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function A030AtuArq(cAlias,lCancFilho,dDtBaixa, cSeqSN3, dData, cSeqReav,lMovCiap, cPadraoAut)

Local aArea   		:= GetArea()
Local aAreaSN3    := SN3->(GetArea())
Local aAreaSN4    := SN4->(GetArea())
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aValorMoed
Local aVrdAcm 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aOrig   	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVrdBal 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aVrdMes	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local nVRCDA1 := 0,nVrcBal1 := 0,nVrcMes1 := 0,nVrcAcm1 := 0
Local cChave   := ""
Local nQtdIni  := 0, nRegSN4  := 0
Local cBase    := ""
Local cItem    := ""
Local cTipo    := ""
Local lParc    := .F.
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aValDepr := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local nValCorr := 0, nValcorDep := 0
Local cTipoCorr:= ""
Local dUltDepr	:= GetMv("MV_ULTDEPR")
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aUltDepr := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local cTipoImob	:= ""
Local cTypes10	:= IIF(lIsRussia,"*" + AtfNValMod({1}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models
Local cTypes12	:= IIF(lIsRussia,"*" + AtfNValMod({2}, "*"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - recoverable models
Local cTypesNM	:= IIF(lIsRussia,"*" + AtfNValMod({3,4}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cOcorr	:= IIF( SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54"+cTypes10+cTypes12+cTypesNM), "20", IIF(SN3->N3_TIPO == "07","10",IIF(SN3->N3_TIPO=="08","12",IIF(SN3->N3_TIPO == "09","11","06"))))

// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
Local lAtClDepr := .F.

//Acrescentado por Fernando Radu Muscalu em 12/05/2011
//estorno do movimento do rateio da ficha de ativo
Local cIdMov 	:= ""
Local cRevAtu 	:= ""
Local lLP_Rat	:= VerPadrao("81F")
Local cCodMot  := SubStr(cMotivo,1,2)
Local lSN3Saldo:= .T.
Local cTpSaldo := ""

Default lPrimlPad := .T.
Default nTotal := 0
Default nHdlPrv := 0
Default lMovCiap := .T.
Default cPadraoAut := ""

dbSelectArea(cAlias)

If lSN3Saldo
	cTpSaldo := SN3->N3_TPSALDO
EndIf

If Type("lAtfCont") != "L"
	lAtfCont := IIf(Trim(GetMv("MV_ATFCONT"))="O",.T.,.F.)
Endif

If lAtfCont
	cBase    := SN3->N3_CBASE
	cItem    := SN3->N3_ITEM
	cTipo    := SN3->N3_TIPO
	cSeq     := IIf(Empty(cSeqSN3),SN3->N3_SEQ,cSeqSN3)
	dData    := IIf(Empty(dData),dDtBaixa,dData)
	cSeqReav := IIf(Empty(SN3->N3_SEQREAV) .Or. cSeqReav = Nil,SN3->N3_SEQREAV,cSeqReav)
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Mostra descri┤└o e quantidade										  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		AtfMultMoe(,,{|x| aVRDACM[x] := SN3->&( If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)) ) })
	Else
		aVRDACM[1] := SN3->N3_VRDACM1
		aVRDACM[2] := SN3->N3_VRDACM2
		aVRDACM[3] := SN3->N3_VRDACM3
		aVRDACM[4] := SN3->N3_VRDACM4
		aVRDACM[5] := SN3->N3_VRDACM5
	EndIf
	nVRCDA1  := SN3->N3_VRCDA1
	
	// Inicializacao das variaveis utilizadas
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	aValDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	
	nValCorr  	:= 0.00
	nValCorDep 	:= 0.00
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	aValBaixa 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValBx	 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	nQtdBaixa := 0.00
	
	// Variaveis disponiveis para contabilizacao do valor da baixa e motivo
	
	VALOR		:= 0.00
	HISTORICO	:= ""
	
	// Procura os movimentos da ultima depreciacao
	dbSelectArea("SN4")
	dbSetOrder(1)
	cChaveSN4 := xFilial()+cBase+cItem+cTipo+DTOS(dUltDepr)+cOcorr+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial()+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dUltDepr)+cOcorr+SN4->N4_SEQ
			If SN4->N4_SEQ != cSeq
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aUltDepr := AtfMultMoe("SN4","N4_VLROC")
		Else
			aUltDepr[1] := SN4->N4_VLROC1
			aUltDepr[2] := SN4->N4_VLROC2
			aUltDepr[3] := SN4->N4_VLROC3
			aUltDepr[4] := SN4->N4_VLROC4
			aUltDepr[5] := SN4->N4_VLROC5
		EndIf
	EndIf
	
	dbSelectArea("SN4")
	dbSetOrder(1)
	cChaveSN4 := xFilial()+cBase+cItem+cTipo+DTOS(dDtBaixa)+cOcorr+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial()+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dDtBaixa)+"06"+SN4->N4_SEQ
			If SN4->N4_SEQ != cSeq
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aValDepr := AtfMultMoe("SN4","N4_VLROC")
		Else
			aValDepr[1] := SN4->N4_VLROC1
			aValDepr[2] := SN4->N4_VLROC2
			aValDepr[3] := SN4->N4_VLROC3
			aValDepr[4] := SN4->N4_VLROC4
			aValDepr[5] := SN4->N4_VLROC5
		EndIf
	EndIf
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Corre┤└o Monet═ria																		Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")
	cChaveSN4 := xFilial()+cBase+cItem+cTipo+DTOS(dDtBaixa)+"07"+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial("SN4")+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dDtBaixa)+"07"+SN4->N4_SEQ
			If SN4->N4_SEQ != cSeq
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		nValCorr := SN4->N4_VLROC1
	EndIf
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Corre┤└o Monet═ria da Deprecia┤└o													Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")
	cChaveSN4 := xFilial()+cBase+cItem+cTipo+DTOS(dDtBaixa)+"08"+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial()+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dDtBaixa)+"08"+SN4->N4_SEQ
			If SN4->N4_SEQREAV != cSeq
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		nValCorDep := SN4->N4_VLROC1
	Endif
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Valor da Baixa																			Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")     // Valor da Baixa
	cChaveSN4 := xFilial("SN4")+cBase+cItem+cTipo+DTOS(dDtBaixa)+"01"+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial()+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dDtBaixa)+"01"+SN4->N4_SEQ
			If !(SN4->N4_SEQREAV = cSeqReav .And. SN4->N4_TIPOCNT = "1")
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		HISTORICO	:= SN4->N4_MOTIVO
		VALOR		:= SN4->N4_VENDA
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aValBaixa := AtfMultMoe("SN4","N4_VLROC")
		Else
			aValBaixa[1] 	:= SN4->N4_VLROC1
			aValBaixa[2] 	:= SN4->N4_VLROC2
			aValBaixa[3] 	:= SN4->N4_VLROC3
			aValBaixa[4] 	:= SN4->N4_VLROC4
			aValBaixa[5] 	:= SN4->N4_VLROC5
		EndIf
		nQtdIni 		:= SN4->N4_QUANTD
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Valor da Baixa Depr Acum.                                              Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")     // Valor da Baixa
	cChaveSN4 := xFilial()+cBase+cItem+cTipo+DTOS(dDtBaixa)+"01"+cSeq
	If dbSeek(cChaveSN4)
		nRegSn4 := SN4->(RECNO())
		While !Eof() .And. cChaveSN4 = xFilial()+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(dDtBaixa)+"01"+SN4->N4_SEQ
			If !(SN4->N4_SEQREAV = cSeqReav .And. SN4->N4_TIPOCNT = "4" )
				dbSkip()
				Loop
			Else
				Exit
			Endif
			dbSkip()
		EndDo
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aValBx := AtfMultMoe("SN4","N4_VLROC")
		Else
			aValBx[1] := SN4->N4_VLROC1
			aValBx[2] := SN4->N4_VLROC2
			aValBx[3] := SN4->N4_VLROC3
			aValBx[4] := SN4->N4_VLROC4
			aValBx[5] := SN4->N4_VLROC5
		EndIf
	Endif
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Atualiza quantidade do ativo - SN1                                  Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")
	Reclock("SN1",.F.)
	
	// Apenas Baixa de Bens do tipo 01,03 e gerencial alteram a quantidade do bem, outros tipo sЦo controles contАbeis e sС influenciam no valor do bem
	If SN3->N3_TIPO $ '01/03' .Or. AFXVLGer(SN3->N3_FILIAL,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_TPSALDO)
		SN1->N1_QUANTD += nQtdIni
	EndIf
	SN1->N1_BAIXA	:= Ctod("")
	msUnlock()
	
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
	IF lUsaMNTAT .AND. !EMPTY(SN1->N1_CODBEM)
		AFGRBXIntMnt(SN1->N1_CODBEM,SN1->N1_BAIXA,"ATFA030",.T.)
	ENDIF
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVRDACM := AtfMultMoe(,,{|x|  aVRDACM[x] - aValdepr[x] })
	Else
		aVRDACM[1] := aVRDACM[1] - aValdepr[1]
		aVRDACM[2] := aVRDACM[2] - aValdepr[2]
		aVRDACM[3] := aVRDACM[3] - aValdepr[3]
		aVRDACM[4] := aVRDACM[4] - aValdepr[4]
		aVRDACM[5] := aVRDACM[5] - aValdepr[5]
	EndIf
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	aVrdMes := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	nVrcMes1 := 0; nVrcdM1	 := 0
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Atualiza saldos do Ativos 											  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN3")
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aOrig := AtfMultMoe("SN3","N3_VORIG")
	Else
		aOrig[1]	:= SN3->N3_VORIG1
		aOrig[2]	:= SN3->N3_VORIG2
		aOrig[3]	:= SN3->N3_VORIG3
		aOrig[4]	:= SN3->N3_VORIG4
		aOrig[5]	:= SN3->N3_VORIG5
	EndIf
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aAmplia	 := AtfMultMoe("SN3","N3_AMPLIA")
	Else
		aAmplia := {nil,nil,nil,nil,nil}
		aAmplia[1] := SN3->N3_AMPLIA1
		aAmplia[2] := SN3->N3_AMPLIA2
		aAmplia[3] := SN3->N3_AMPLIA3
		aAmplia[4] := SN3->N3_AMPLIA4
		aAmplia[5] := SN3->N3_AMPLIA5
	EndIf
	
	nVrcMes1 := SN3->N3_VRCMES1
	nVrcBal1 := SN3->N3_VRCBAL1 - nVrcMes1
	nVrcAcm1 := SN3->N3_VRCACM1 - nVrcMes1
	
	nVrcdM1	:= SN3->N3_VRCDM1
	nVrcdB1	:= SN3->N3_VRCDB1 - nVrcdM1
	nVrcdA1	:= SN3->N3_VRCDA1 - nVrcdM1
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVrdMes	 := AtfMultMoe("SN3","N3_VRDMES")
	Else
		aVrdMes[1] := SN3->N3_VRDMES1
		aVrdMes[2] := SN3->N3_VRDMES2
		aVrdMes[3] := SN3->N3_VRDMES3
		aVrdMes[4] := SN3->N3_VRDMES4
		aVrdMes[5] := SN3->N3_VRDMES5
	EndIf
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVrdBal	 := AtfMultMoe("SN3","N3_VRDBAL")
		AtfMultMoe(,,{|x| aVrdBal[x]-= aVrdMes[x] })
	Else
		aVrdBal[1] := SN3->N3_VRDBAL1 - aVrdMes[1]
		aVrdBal[2] := SN3->N3_VRDBAL2 - aVrdMes[2]
		aVrdBal[3] := SN3->N3_VRDBAL3 - aVrdMes[3]
		aVrdBal[4] := SN3->N3_VRDBAL4 - aVrdMes[4]
		aVrdBal[5] := SN3->N3_VRDBAL5 - aVrdMes[5]
	EndIf
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVrdAcm	 := AtfMultMoe("SN3","N3_VRDACM")
		AtfMultMoe(,,{|x| aVrdAcm[x] -= aVrdMes[x] })
	Else
		aVrdAcm[1] := SN3->N3_VRDACM1 - aVrdMes[1]
		aVrdAcm[2] := SN3->N3_VRDACM2 - aVrdMes[2]
		aVrdAcm[3] := SN3->N3_VRDACM3 - aVrdMes[3]
		aVrdAcm[4] := SN3->N3_VRDACM4 - aVrdMes[4]
		aVrdAcm[5] := SN3->N3_VRDACM5 - aVrdMes[5]
	EndIf
	
	If ExistBlock("AF030CAN")
		ExecBlock("AF030CAN",.F.,.F.)
	Endif
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Gera┤└o de lancamentos Contabeis conforme o tipo do ativo cadastrado	Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If Empty(cPadraoAut)
		IF SN3->N3_TIPO $ ("01*10*16*17" + cTypes10 + cTypesNM)
			cPadrao := "814"
		ElseIF	SN3->N3_TIPO $ "02,05"
			cPadrao := "815"
		ElseIF	SN3->N3_TIPO $ "03*13"
			cPadrao := "816"
		ElseIF	SN3->N3_TIPO == "04"
			cPadrao := "817"
		Else
			cPadrao := "81B" 					// Cancelamento da baixa de outros tipos de ativos
		EndIf
	Else
		cPadrao := cPadraoAut
	EndIf
	dbSelectArea("SN4")
	
	cChave :=xFilial("SN4")+cBase+cItem+cTipo+DTOS(dDtBaixa)
	SN4->(MsSeek(cChave))
	
	SN4->(RecLock("SN4",.F.))
	SN4->N4_LA 		:= iIf(mv_par01 # 3,"S","N")
	SN4->N4_ORIGEM 	:= FunName()
	SN4->N4_LP 		:= cPadrao
	SN4->(MsUnLock())
	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifica se existe lancamento padrao. 											Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	lPadrao := VerPadrao(cPadrao)
	IF ( lPadrao .or. lLP_Rat ) .And. mv_par01 # 3
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Envia p/ lanc. contabil, desde que exista lancam.padronizado			Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lPrimlPad
			If nHdlPrv == 0
				nHdlPrv := HeadProva(cLoteAtf,"ATFA030",Substr(cUsername,1,6),@cArquivo,! CtbInUse())
			Endif
			If lAuto .Or. lCancFilho
				lPrimlPad := .F.
			Endif
		Endif
		nTotal += DetProva(nHdlPrv,cPadrao,"ATFA030",cLoteAtf)
		
	EndIf
	
	// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
	lAtClDepr := AtClssVer(SN1->N1_PATRIM)

	If ! SN3->N3_TIPO $ "07,08,09"
		cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr/* .AND. EMPTY(SN1->N1_PATRIM)*/,"5","D"))
		cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .AND. EMPTY(SN1->N1_PATRIM),"6","6"))
		ATFSaldo(	SN3->N3_CCONTAB,dDtBaixa,cTipoImob,aValBaixa[1],aValBaixa[2],aValBaixa[3],aValBaixa[4],aValBaixa[5],;
		"-",,SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValBaixa, cTpSaldo,cCodMot )
		
	Endif
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aValorMoed	:= AtfMultMoe(,,{|x| If(x=1,nValCorr,0) })
	EndIf
	
	cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr/* .AND. EMPTY(SN1->N1_PATRIM)*/,"5","D"))
	cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .AND. EMPTY(SN1->N1_PATRIM),"6","6"))
	ATFSaldo(	SN3->N3_CCONTAB,dDtBaixa,cTipoCorr,	nValCorr,0,0,0,0,;
	"-",,SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValorMoed, cTpSaldo,cCodMot )
	
	cTipoImob := IIF(SN1->N1_PATRIM $ "CAS","C",IIF(lAtClDepr/* .AND. EMPTY(SN1->N1_PATRIM)*/,"5","D"))
	cTipoCorr := IIF(SN1->N1_PATRIM $ "CAS","O",IIF(lAtClDepr .AND. EMPTY(SN1->N1_PATRIM),"6","6"))
	ATFSaldo(	SN3->N3_CCORREC,dDtBaixa,cTipoCorr,nValCorr,0,0,0,0,;
	"-",,SN3->N3_SUBCCOR,,SN3->N3_CLVLCOR,SN3->N3_CCCORR,"2", aValorMoed,cTpSaldo,cCodMot )
	
	If lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		cTipoImob := If( !SN3->N3_TIPO $ ("08,09,10,16,17,12,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "4", If(SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM),"Y",If(SN3->N3_TIPO=="09","L","K")))
		ATFSaldo(	SN3->N3_CDEPREC,dDtBaixa,cTipoImob,aValDepr[1],aValDepr[2],aValDepr[3],aValDepr[4],aValDepr[5],;
		"-",,SN3->N3_SUBCDEP,,SN3->N3_CLVLDEP,SN3->N3_CCDESP,"3", aValDepr, cTpSaldo,cCodMot )
		
		cTipoImob := If( !SN3->N3_TIPO $ ("08,09,10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM), "4", If(SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54" + cTypes10 + cTypes12 + cTypesNM),"Y",If(SN3->N3_TIPO=="09","L","K")))
		ATFSaldo(	SN3->N3_CCDEPR ,dDtBaixa,cTipoImob,aValDepr[1],aValDepr[2],aValDepr[3],aValDepr[4],aValDepr[5],;
		"-",,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValDepr, cTpSaldo,cCodMot )
		
		cTipoImob := "5"
		ATFSaldo(	SN3->N3_CCDEPR ,dDtBaixa,cTipoImob,aValBx[1],aValBx[2],aValBx[3],aValBx[4],aValBx[5],;
		"-",,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValBx , cTpSaldo,cCodMot)
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			aValorMoed	:= AtfMultMoe(,,{|x| If(x=1,nValCorDep,0) })
		EndIf
		cTipoCorr := "7"
		ATFSaldo(	SN3->N3_CDESP	,dDtBaixa,cTipoCorr, nValCorDep,0,0,0,0 ,;
		"-",,SN3->N3_SUBCDES,,SN3->N3_CLVLDES,SN3->N3_CCCDES,"5", aValorMoed, cTpSaldo,cCodMot )
		
		cTipoCorr := "7"
		ATFSaldo(	SN3->N3_CCDEPR ,dDtBaixa,cTipoCorr, nValCorDep,0,0,0,0 ,;
		"-",,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMoed, cTpSaldo,cCodMot )
		
	EndIf
	
	dbSelectArea("SN7")
	dbSetOrder(1)
	If dbSeek(xFilial("SN7")+cBase+cItem)
		RecLock("SN7",.F.)
		SN7->N7_VLREAL  := 0
		SN7->N7_DTBAIXA := CtoD("  /  /  ")
		msUnlock()
	EndIf
	
	dbSelectArea("SN4")
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Exclui registro de movimenta┤└o da baixa 										Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cIdMov := ""
	While SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(N4_DATA)==cChave .And. !Eof()
		If cSeq == SN4->N4_SEQ .And. cSeqReav == SN4->N4_SEQREAV  .And.;
			(SN4->N4_OCORR $ "01/06/07/08/10/20")	// Removida implantacao, caso baixar
			PcoDetLan("000370","01","ATFA030",.T.)
			//AVP
			//Cancela movimentos de AVP da baixa que esta sendo cancelada
			If SN4->N4_TIPO == '14'
				AFCanAVP(SN4->N4_CBASE,SN4->N4_ITEM,SN4->N4_TPSALDO,SN4->N4_IDMOV,@nHdlPrv,@nTotal,@cArquivo,@cLoteAtf) //TO DO
			Endif			
			//acrescentado por Fernando Radu Muscalu em 12/05/2011
			//Tratamento do estorno dos movimentos de rateio
			If cIdMov <> SN4->N4_IDMOV
				If cPaisLoc $ "ARG|BRA|COS"
					
					ATFRTMOV(	SN4->N4_FILIAL,;
					SN4->N4_CBASE,;
					SN4->N4_ITEM,;
					SN4->N4_TIPO,;
					SN4->N4_SEQ,;
					SN4->N4_DATA,;
					SN4->N4_IDMOV,;
					,;
					mv_par01 <> 3,;
					"2",;
					nHdlPrv,;
					cLoteATF,;
					@nTotal)
					
				Endif
			Endif
			RecLock("SN4",.F.,.T.)				// e cancelar baixa no dia da implantacao
			SN4->(dbDelete())					// Excluiria indevidamente
			msUnlock()
			FKCOMMIT()
		EndIf
		cIdMov := SN4->N4_IDMOV
		
		SN4->(dbskip())
	EndDo
	
	dbSelectArea("SN3")
	nRec		:= Recno()
	dbSetOrder(1)
	dbSeek(xFilial("SN3")+cBase+cItem+cTipo)
	While !Eof() .And. xFilial("SN3")+cBase+cItem+cTipo = SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO
		
		If SN3->N3_BAIXA = "1"
			dbSkip()
			Loop
		EndIf

		If lIsRussia
			If SN3->N3_OPER <> '1' // CAZARINI - 20.01.2017 - Asset Into Operation?
				dbSkip()
				Loop
			Endif
		Endif
		
		If SN3->N3_TPSALDO != cTpSaldo
			SN3->(dbSkip())
			Loop
		EndIf
	
		If SN3->N3_SEQREAV != cSeqReav
			dbSkip()
			Loop
		Else
			lParc := .T.
			Exit
		EndIf
		
	EndDo
	
	If !lParc
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Caso n└o exista registro de baixa parcial, significa que o	  Ё
		//Ё bem sofreu apenas um baixa total, portanto os seus valores	  Ё
		//Ё estao ativos, sendo necess═rio apenas atualizar sua situa┤└o Ё
		//Ё (N3_BAIXA).Quando o bem esta totalmente baixado com v═rias   Ё
		//Ё parciais, no cancelamento da 1a delas ┌ como se fosse a de   Ё
		//Ё uma baixa total.                                             Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SN3->(dbGoto(nRec))
		Reclock("SN3")
		SN3->N3_OK 	  	:= "  "
		SN3->N3_BAIXA   := "0"
		SN3->N3_IDBAIXA := " "
		SN3->N3_DTBAIXA := Ctod("")
		SN3->N3_VRCBAL1 -= SN3->N3_VRCMES1
		SN3->N3_VRCACM1 -= SN3->N3_VRCMES1
		
		SN3->N3_VRCDB1  -= SN3->N3_VRCDM1
		SN3->N3_VRCDA1  -= SN3->N3_VRCDM1
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDBAL",{|x| SN3->&( If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)) ) - SN3->&( If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)) ) })
		Else
			SN3->N3_VRDBAL1 -= SN3->N3_VRDMES1
			SN3->N3_VRDBAL2 -= SN3->N3_VRDMES2
			SN3->N3_VRDBAL3 -= SN3->N3_VRDMES3
			SN3->N3_VRDBAL4 -= SN3->N3_VRDMES4
			SN3->N3_VRDBAL5 -= SN3->N3_VRDMES5
		EndIf
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDACM",{|x| SN3->&( If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)) ) - SN3->&( If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)) ) })
		Else
			SN3->N3_VRDACM1 -= (SN3->N3_VRDMES1)   //+SN3->N3_VRCDA1)
			SN3->N3_VRDACM2 -= SN3->N3_VRDMES2
			SN3->N3_VRDACM3 -= SN3->N3_VRDMES3
			SN3->N3_VRDACM4 -= SN3->N3_VRDMES4
			SN3->N3_VRDACM5 -= SN3->N3_VRDMES5
		EndIf
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDMES",{|x| aUltDepr[x] })
		Else
			SN3->N3_VRDMES1 := aUltDepr[1]
			SN3->N3_VRDMES2 := aUltDepr[2]
			SN3->N3_VRDMES3 := aUltDepr[3]
			SN3->N3_VRDMES4 := aUltDepr[4]
			SN3->N3_VRDMES5 := aUltDepr[5]
		EndIf
		****************** CIAP ********************
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atualiza o Cadastro de CIAP                                            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SF9")
		dbSetOrder(1)
		If ( dbSeek(xFilial("SF9")+SN1->N1_CODCIAP) ) .And. lMovCiap
			RecLock("SF9")
			SF9->F9_DOCNFS := ""
			SF9->F9_SERNFS := ""
			SF9->F9_ITEMNFS := ""
			SF9->F9_DTEMINS:= Ctod("")
			SF9->F9_MOTIVO := ""
			SF9->F9_BXICMS-= SN3->N3_BXICMS
			MsUnlock()
			dbSelectArea("SFA")
			If (dbSeek(xFilial("SFA")+SF9->F9_CODIGO+Dtos(dDtBaixa)+'2'))
				While !Eof() .and. (SFA->FA_FILIAL+SFA->FA_CODIGO+DTOS(SFA->FA_DATA)+SFA->FA_TIPO) == (xFilial("SFA")+SF9->F9_CODIGO+DTOS(dDtBaixa)+'2')
					RecLock("SFA")
					dbDelete()
					MsUnlock()
				dbSkip()
			EndDo
			EndIf
			SN3->N3_BXICMS := 0
		EndIf
		dbSelectArea("SN3")
		//acrescentado por Fernando radu Muscalu
		SN3->(MsUnlock())
		
		//acrescentado por Fernando Radu Muscalu em 12/05/2011
		//Tratamento do estorno dos movimentos de rateio
		If AFXVerRat()
			If SN3->N3_RATEIO == "1"
				cRevAtu := AF011GETREV(SN3->N3_CODRAT)
				Af011AtuStatus(SN3->N3_CODRAT,cRevAtu,"3")
			Endif
		Endif
		****************** CIAP ********************
	Else
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Deve retornar os valores da baixa parcial para o registro de aquisi┤└o Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Reclock("SN3")
		SN3->N3_IDBAIXA := "1"
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VORIG",{|x| Round( SN3->&("N3_VORIG"+Alltrim(Str(x)))  + aOrig[x]  , X3Decimal( "N3_VORIG"+Alltrim(Str(x)) ) ) })
		Else
			SN3->N3_VORIG1  := Round( SN3->N3_VORIG1  + aOrig[1]  , X3Decimal("N3_VORIG1") )
			SN3->N3_VORIG2  := Round( SN3->N3_VORIG2  + aOrig[2]  , X3Decimal("N3_VORIG2") )
			SN3->N3_VORIG3  := Round( SN3->N3_VORIG3  + aOrig[3]  , X3Decimal("N3_VORIG3") )
			SN3->N3_VORIG4  := Round( SN3->N3_VORIG4  + aOrig[4]  , X3Decimal("N3_VORIG4") )
			SN3->N3_VORIG5  := Round( SN3->N3_VORIG5  + aOrig[5]  , X3Decimal("N3_VORIG5") )
		EndIF
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_AMPLIA",{|x| Round( SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x)))  + aAmplia[x]  , X3Decimal( If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x)) ) ) })
		Else
			SN3->N3_AMPLIA1 := Round( SN3->N3_AMPLIA1 + aAmplia[1], X3Decimal("N3_AMPLIA1") )
			SN3->N3_AMPLIA2 := Round( SN3->N3_AMPLIA2 + aAmplia[2], X3Decimal("N3_AMPLIA2") )
			SN3->N3_AMPLIA3 := Round( SN3->N3_AMPLIA3 + aAmplia[3], X3Decimal("N3_AMPLIA3") )
			SN3->N3_AMPLIA4 := Round( SN3->N3_AMPLIA4 + aAmplia[4], X3Decimal("N3_AMPLIA4") )
			SN3->N3_AMPLIA5 := Round( SN3->N3_AMPLIA5 + aAmplia[5], X3Decimal("N3_AMPLIA5") )
		EndIf
		
		SN3->N3_VRCMES1 := Round( SN3->N3_VRCMES1 + nVrcMes1, X3Decimal("N3_VRCMES1") )
		SN3->N3_VRCBAL1 := Round( SN3->N3_VRCBAL1 + nVrcBal1, X3Decimal("N3_VRCBAL1") )
		SN3->N3_VRCACM1 := Round( SN3->N3_VRCACM1 + nVrcAcm1, X3Decimal("N3_VRCACM1") )
		
		SN3->N3_VRCDM1  := Round( SN3->N3_VRCDM1  + nVrcdM1 , X3Decimal("N3_VRCDM1") )
		SN3->N3_VRCDB1  := Round( SN3->N3_VRCDB1  + nVrcdB1 , X3Decimal("N3_VRCDB1") )
		SN3->N3_VRCDA1  := Round( SN3->N3_VRCDA1  + nVrcdA1 , X3Decimal("N3_VRCDA1") )
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDMES",{|x| Round( SN3->&(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)))  + aVrdMes[x]  , X3Decimal( If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)) ) ) })
		Else
			SN3->N3_VRDMES1 := Round( SN3->N3_VRDMES1 + aVrdMes[1], X3Decimal("N3_VRDMES1") )
			SN3->N3_VRDMES2 := Round( SN3->N3_VRDMES2 + aVrdMes[2], X3Decimal("N3_VRDMES2") )
			SN3->N3_VRDMES3 := Round( SN3->N3_VRDMES3 + aVrdMes[3], X3Decimal("N3_VRDMES3") )
			SN3->N3_VRDMES4 := Round( SN3->N3_VRDMES4 + aVrdMes[4], X3Decimal("N3_VRDMES4") )
			SN3->N3_VRDMES5 := Round( SN3->N3_VRDMES5 + aVrdMes[5], X3Decimal("N3_VRDMES5") )
		EndIf
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDBAL",{|x| Round( SN3->&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)))  + aVrdBal[x]  , X3Decimal( If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)) ) ) })
		Else
			SN3->N3_VRDBAL1 := Round( SN3->N3_VRDBAL1 + aVrdBal[1] , X3Decimal("N3_VRDBAL1") )
			SN3->N3_VRDBAL2 := Round( SN3->N3_VRDBAL2 + aVrdBal[2] , X3Decimal("N3_VRDBAL2") )
			SN3->N3_VRDBAL3 := Round( SN3->N3_VRDBAL3 + aVrdBal[3] , X3Decimal("N3_VRDBAL3") )
			SN3->N3_VRDBAL4 := Round( SN3->N3_VRDBAL4 + aVrdBal[4] , X3Decimal("N3_VRDBAL4") )
			SN3->N3_VRDBAL5 := Round( SN3->N3_VRDBAL5 + aVrdBal[5] , X3Decimal("N3_VRDBAL5") )
		EndIf
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		If lMultMoed
			AtfMultMoe("SN3","N3_VRDACM",{|x| Round( SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)))  + aVrdAcm[x]  , X3Decimal( If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)) ) ) })
		Else
			SN3->N3_VRDACM1 := Round( SN3->N3_VRDACM1 + aVrdAcm[1], X3Decimal("N3_VRDACM1") )
			SN3->N3_VRDACM2 := Round( SN3->N3_VRDACM2 + aVrdAcm[2], X3Decimal("N3_VRDACM2") )
			SN3->N3_VRDACM3 := Round( SN3->N3_VRDACM3 + aVrdAcm[3], X3Decimal("N3_VRDACM3") )
			SN3->N3_VRDACM4 := Round( SN3->N3_VRDACM4 + aVrdAcm[4], X3Decimal("N3_VRDACM4") )
			SN3->N3_VRDACM5 := Round( SN3->N3_VRDACM5 + aVrdAcm[5], X3Decimal("N3_VRDACM5") )
		EndIf
		
		****************** CIAP ********************
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atualiza o Cadastro de CIAP                                            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbSelectArea("SF9")
		dbSetOrder(1)
		If ( dbSeek(xFilial("SF9")+SN1->N1_CODCIAP) )
			RecLock("SF9")
			SF9->F9_DOCNFS := ""
			SF9->F9_SERNFS := ""
			SF9->F9_DTEMINS:= Ctod("")
			SF9->F9_MOTIVO := ""
			SF9->F9_BXICMS-= SN3->N3_BXICMS
			MsUnlock()
			dbSelectArea("SFA")
			If (dbSeek(xFilial("SFA")+SF9->F9_CODIGO+Dtos(dDtBaixa)+'2'))
				While !Eof() .and. (SFA->FA_FILIAL+SFA->FA_CODIGO+DTOS(SFA->FA_DATA)+SFA->FA_TIPO) == (xFilial("SFA")+SF9->F9_CODIGO+DTOS(dDtBaixa)+'2')
					RecLock("SFA")
					dbDelete()
					MsUnlock()
				dbSkip()
			EndDo
			EndIf
			SN3->N3_BXICMS := 0
		EndIf
		dbSelectArea("SN3")
		****************** CIAP ********************
		SN3->N3_BAIXA   := "0"
		SN3->N3_DTBAIXA := Ctod("")
		SN3->N3_OK 	  := "  "
		MsUnlock()
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Exclui registro da baixa                                     Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		dbGoTo( nRec )
		//acrescentado por Fernando Radu Muscalu em 12/05/2011
		//Tratamento do estorno dos movimentos de rateio
		If AFXVerRat()
			If SN3->N3_RATEIO == "1"
				AF011DEL({{SN3->N3_CODRAT}},.T.)
			Endif
		Endif
		
		Reclock( "SN3" ,.F.,.T.)
		SN3->(dbDelete())
		msUnlock()
	EndIf
	
Else    //cAlias SN4
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Atualiza quantidade do ativo 													Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SN4")
	nRegSN4 := Recno()
	If dbSeek(xFilial()+cBase+cItem+cTipo)
		nQtdIni := SN4->N4_QUANTD
		dbGoto(nRegSN4)
		If nQtdIni != SN1->N1_QUANTD
			Reclock("SN1")
			// Apenas Baixa de Bens do tipo 01,03 e gerencial alteram a quantidade do bem, outros tipo sЦo controles contАbeis e sС influenciam no valor do bem
			If SN3->N3_TIPO $ '01/03' .Or. AFXVLGer(SN3->N3_FILIAL,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_TPSALDO)
				SN1->N1_QUANTD += SN4->N4_QUANTD 	 // SN1->N1_QUANTD + SN4->N4_QUANTD
			EndIf
			SN1->N1_BAIXA	:= Ctod("")
			msUnlock()
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Avalia integracao com o modulo SIGAMNT - PARCEIRO NGЁ
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
			IF lUsaMNTAT .AND. !EMPTY(SN1->N1_CODBEM)
				AFGRBXIntMnt(SN1->N1_CODBEM,SN1->N1_BAIXA,"ATFA030",.T.)
			ENDIF
			
		Endif
	Endif
	//acrescentado por Fernando Radu Muscalu em 12/05/2011
	//Tratamento do estorno dos movimentos de rateio
		
	ATFRTMOV(	SN4->N4_FILIAL,;
	SN4->N4_CBASE,;
	SN4->N4_ITEM,;
	SN4->N4_TIPO,;
	SN4->N4_SEQ,;
	SN4->N4_DATA,;
	SN4->N4_IDMOV,;
	,;
	mv_par01 <> 3,;//ALTERAR AQUI
	"2",;
	nHdlPrv,;
	cLoteATF,;
	@nTotal)
	
	RecLock("SN4",.F.,.T.)
	SN4->(dbDelete())
	SN4->(msUnlock())
	dbSelectArea("SN3")
	dbSetOrder(1)
	If MsSeek(xFilial("SN3")+cBase+cItem)
		RecLock("SN3",.F.)
		SN3->N3_BAIXA    := "0"
		SN3->N3_DTBAIXA  := Ctod("")
		msUnlock()
		//acrescentado por Fernando Radu Muscalu em 12/05/2011
		//Tratamento do estorno dos movimentos de rateio
		If AFXVerRat()
			If SN3->N3_RATEIO == "1"
				cRevAtu := AF011GETREV(SN3->N3_CODRAT)
				Af011AtuStatus(SN3->N3_CODRAT,cRevAtu,"3")
			Endif
		Endif
		
	Endif
	dbSelectArea("SN7")
	dbSetOrder(1)
	If dbSeek(xFilial("SN7")+cBase+cItem)
		RecLock("SN7",.F.)
		SN7->N7_VLREAL  := 0
		SN7->N7_DTBAIXA := CtoD("  /  /  ")
		msUnlock()
	EndIf
	
Endif

RestArea(aAreaSN4)
RestArea(aAreaSN3)
RestArea(aArea)
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030BxValorЁ Autor Ё Alice Yamamoto 		  Ё Data Ё 27/01/98 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁNao permite baixas por qdtde quando houver agregados      	Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAF030BcFilho()                                 				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function AF030BxValor(nQuant,nQtdOrig)
Local lRet  := .T.
Local aArea := GetArea()
Local cBase := SN3->N3_CBASE
Local cItem := SN3->N3_ITEM
Local aTiposReav := {}
Local nX		:= 0

//Tipos de reavaliaГЦo
AAdd(aTiposReav,"02") //reavaliacao
AAdd(aTiposReav,"04") //Lei 8.200
AAdd(aTiposReav,"41") // ReavaliaГЦo anual de bens nЦo totalmente depreciados
AAdd(aTiposReav,"42") // ReavaliaГЦo anual de bens totalmente depreciados
AAdd(aTiposReav,"50") // Colombia: Depreciacao gerencial "metodo linear"
AAdd(aTiposReav,"51") // Colombia: Depreciacao gerencial "soma dos digitos"
AAdd(aTiposReav,"52") // Colombia: Depreciacao gerencial "reducao de saldos"
AAdd(aTiposReav,"53") // Colombia: Depreciacao gerencial "soma dos anos"
AAdd(aTiposReav,"54") // Colombia: Depreciacao gerencial "unidades produzidas"

SN3->(dbSetOrder(1))
If nQuant != nQtdOrig
	For nX := 1 to Len(aTiposReav)
		If SN3->( MSSeek(xFilial("SN3")+cBase+ cItem+aTiposReav[nX]) )
			Help(" ",1,"BXVALOR")  //Se houver agregados, a baixa deve ser por valor
			nQuant := nQtdOrig
			Exit
		Endif
	Next nX
Endif

RestArea(aArea)
Return lRet

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030Depre Ё Autor Ё Alice Y Yamamoto	  Ё Data Ё 11.07.01 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Calcula as depreciacoes e vls residuais na data  			Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030	- Usada somente na baixa de ativos oFF LINE - SN4   Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030Depre(dData,nQuant,nQtdOrig,nPerc,nUfir,aVlrAcum)
Local nMoeda, nTaxa
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)

Local aDias     := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local aTxMedia  := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Local nDias     := Day(LastDay(dData))   //nro de dias no mes da baixa
Local nDiasDepr := Day(dData)          // Nro de dias a depreciar
Local nResidual := 0
Local nTaxaCorr := 0                    //Taxa para corre┤фo
Local aDiferenca:= Array( If(lMultMoed,AtfMoedas(),5) )
Local i
Local aTaxaMes  := If(lMultMoed, AtfMultMoe("SN3","N3_TXDEPR"), {SN3->N3_TXDEPR1, SN3->N3_TXDEPR2,SN3->N3_TXDEPR3,SN3->N3_TXDEPR4,SN3->N3_TXDEPR5} )
Local cCalcDep  := GetNewPar("MV_CALCDEP",'0')
Local cTipDepr  := AllTrim(GetMv("MV_TIPDEPR"))

Local nPropBase		:= 0
Local lVlrMxDp		:= .F.
Local nMoedaVMax	:= Iif(Val(GetMv("MV_ATFMDMX",.F.," "))>0, Val(GetMv("MV_ATFMDMX")), Val(cMoedaAtf))
Local lVlrSalv		:= SN3->N3_TPDEPR=='2'
Local nCusto
Local nDecTax
Local lAtfctap		:= IIF(GetNewPar("MV_ATFCTAP","0")=="0",.F.,.T.)

// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
Local lAtClDepr := .F.

lVlrMxDp := nMoedaVMax > 0 .AND. SN3->N3_VMXDEPR > 0

If lVlrMxDp .And. nMoedaVMax > 9
	nPropBase 	:= SN3->N3_VMXDEPR / (&("SN3->N3_VORIG"  + Alltrim(Str(nMoedaVMax))) + &("SN3->N3_AMPLI" + Alltrim(Str(nMoedaVMax))))
ElseIf lVlrMxDp .And. nMoedaVMax <= 9
	nPropBase 	:= SN3->N3_VMXDEPR / (&("SN3->N3_VORIG"  + Alltrim(Str(nMoedaVMax))) + &("SN3->N3_AMPLIA" + Alltrim(Str(nMoedaVMax))))
EndIf

Afill(aDiferenca, 0)

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё																								Ё
//Ё						  V A L O R   R E S I D U A L 								Ё
//Ё																								Ё
//цдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢
//Ё																								Ё
//Ё Valor residual e' a quantia a ser depreciada de um bem.                Ё
//Ё																								Ё
//Ё Se o valor da baixa for superior ao valor residual, a diferenca entre	Ё
//Ё esses valores representa LUCRO a ser devidamente contabilizado.			Ё
//Ё																								Ё
//Ё Custo da Baixa = Valor Original em Moeda Forte 								Ё
//Ё																								Ё
//цддддддддддбдддддддддбддддддддддбдддддддддбддддддддддбдддддддддбддддддддд╢
//Ё Valor	 Ё Depr.   Ё Depr.ate Ё Depr.   Ё Valor	 Ё Valor   Ё Lucro(+)Ё
//Ё Original Ё Acum.   Ё Dt Baixa Ё Acum.   Ё Residual Ё Baixa   Ё			Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 1.000,00 Ё  300,00 Ё	 20,00 Ё  320,00 Ё	680,00 Ё  680,00 Ё	 0,00 Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 1.000,00 Ё  300,00 Ё	 20,00 Ё  320,00 Ё	680,00 Ё  780,00 Ё  100,00 Ё
//цддддддддддедддддддддеддддддддддедддддддддеддддддддддедддддддддеддддддддд╢
//Ё 2.000,00 Ё2.000,00 Ё	  0,00 Ё 	0,00 Ё	  0,00 Ё  200,00 Ё  200,00 Ё
//юддддддддддадддддддддаддддддддддадддддддддаддддддддддадддддддддаддддддддды

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula a taxa media para cada moeda												Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dDataI := FirstDay(dData)
dDataI := IIF(SN3->N3_DINDEPR > dDataI, SN3->N3_DINDEPR, dDataI)
dbSelectArea("SM2")
dbSeek(dDataI,.T.)
aTxMedia[1] := 1

// *******************************
// Controle de multiplas moedas  *
// *******************************
aDias     := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
While !Eof() .And. SM2->M2_DATA <= dData
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	For i := 2 To __nQuantas
		cMoeda := Alltrim(Str(i))
		IF &('SM2->M2_MOEDA'+cMoeda) > 0
			aDias[i] += 1
			aTxMedia[i] += &('SM2->M2_MOEDA'+cMoeda)
		EndIf
	Next
	dbSkip()
EndDo
// *******************************
// Controle de multiplas moedas  *
// *******************************
For i := 2 To __nQuantas
	cMoeda:=Alltrim(Str(i))
	IF aTxMedia[i] = 0 .Or. aDias[i] = 0
		aDias[i]	 := 1
		aTxMedia[i] := 1
	Else
		aTxMedia[i]:=aTxMedia[i] / aDias[i]
	End
Next

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Efetua a deprecia┤└o por moedas apenas se a data de in║cio de depre-	Ё
//Ё cia┤└o j═ tenha chegado.																Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
aValDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

// *******************************
// Controle de multiplas moedas  *
// *******************************
aDepr 	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
dbSelectArea("SN3")

aTaxaMes    := AFatorCalc(aTaxaMes, SN3->N3_DINDEPR, dDataBase, cTipDepr, cCalcDep, .T.)

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё nVlrAcum1,..,5 - Valor da depreciacao acumulada+correcao               Ё
//Ё nVlrAtual1,..5 - Valor do Bem + Ampliacao + Correcao do Bem e ja sub-  Ё
//Ё                - traida as depreciacoes mensais                        Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !lAtfctap .Or. ! (cTipDepr $ '4/5/8/9')
	// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
	lAtClDepr := AtClssVer(SN1->N1_PATRIM)
	
	If lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
		If SN3->N3_DINDEPR <= dBaixa030
			
			// *******************************
			// Controle de multiplas moedas  *
			// *******************************
			For i := 1 To __nQuantas
				cMoed := Alltrim(Str(i))
				aValDepr[i] := 0
				If aVlrAcum[i] < aVlrAtual[i]
					If aTaxaMes[i] > 0
						nDecTax	:= TamSX3("N3_VORIG"  + Alltrim(Str(i)))[2]
						nCusto	:= aVlrAtual[i]
						
						If i == nMoedaVMax .And. lVlrMxDp
							//habilita o "Valor maximo de depreciaГЦo" no calculo de depreciaГЦo na moeda definida
							nCusto := IIf(Empty(SN3->N3_VMXDEPR), nCusto, SN3->N3_VMXDEPR)
						ElseIf i != nMoedaVMax .And. lVlrMxDp
							// Proporcionaliza a base para as outras moedas
							nCusto := Round(NoRound(nCusto * Round(NoRound(nPropBase,nDecTax+1),nDecTax), nDecTax+1), nDecTax)
						EndIf
						
						If lVlrSalv
							nCusto := nCusto - &(if(i>9,"N3_VRDAC","N3_VRDACM")+cMoed)
						EndIf
						
						nTaxa 			:= aTaxaMes[i]
						aValDepr[i]		:= Round(nCusto*nTaxa,X3Decimal("N3_VORIG"+cMoed))
						aDiferenca[i]		:= nCusto-(aValDepr[i]+aVlrAcum[i])
						If Round(aDiferenca[i],X3Decimal("N3_VORIG"+cMoed)) < 0
							aDepr[i] := nCusto-(aVlrAcum[i])
						EndIf
					EndIf
				EndIf
				
			Next
		Endif
	EndIf
Else
	lCalcula := .F.
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё CALC. DE DEPRECIA─гO NA MOEDA1.                                      Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lCalcula  // BOBS
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Se NAO tiver residuo na moeda 3                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If aDepr[Val(cMoedaAtf)] = 0
		aValDepr[1] := Round(aValDepr[Val(cMoedaAtf)] * nParCorrec,X3Decimal("N3_VORIG1"))
	Endif
	aDiferenca[1] := (aVlrAtual[1]) - (aValDepr[1]+aVlrAcum[1])
	If Round(aDiferenca[1],X3Decimal("N3_VORIG1")) < 0
		aDepr[1] := (aVlrAtual[1])-(aVlrAcum[1])
	Endif
Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁRegra Geral a Depr na Moeda1 ┌ calculada pela taxa media do m┬s,   Ё
	//Ёenquanto existe uma taxa de referencia (UFIR). A partir de 01/01/96Ё
	//Ёa referncia ┌ o pr╒prio real. Dessa forma nфo ha necessidade de    Ё
	//Ёconverter a deprecia┤фo pela Ufir de referencia.                   Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If Dtos(dData) < "19960101"
		aValDepr[1] := Round(aValDepr[Val(cMoedaAtf)] * aTxMedia[Val(cMoedaAtf)],;
		X3Decimal("N3_VORIG1"))
		aDiferenca[1] := (aVlrAtual[1]) - (aValDepr[1]+aVlrAcum[1])
		If Round(aDiferenca[1],X3Decimal("N3_VORIG1")) <= 0
			aDepr[1] := (aVlrAtual[1])-(aVlrAtual[1])
		Endif
	EndIf
EndIf
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Trata os res║duos de deprecia┤ao.                                     Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If SN3->N3_DINDEPR <= dBaixa030
	If aDepr[1] != 0
		aValDepr[1] := aDepr[1]
	Endif
Endif

If lCalcula
	nTaxaCorr  := nParCorrec
	nValCorr   := Round(aVlrAtual[1] * nTaxaCorr,X3Decimal("N3_VORIG1")) - (aVlrAcum[1])
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	nValCorDep := Round(((aVlrAcum[Val(cMoedaAtf)])+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG"+cMoedaAtf)) - ;
	(aVlrAcum[Val(cMoedaAtf)]+aValDepr[Val(cMoedaAtf)])
	
Else
	If DtoS(dData) < "19941001"
		nTaxaCorr := RecMoeda(dData,cMoedaAtf)
	Else
		nTaxaCorr := 0
	Endif
	If nTaxaCorr != 0
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		nValCorr   := Round((aVlrAtual[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG1"))-(aVlrAtual[1])
		nValCorr   := IIF(nQuant < nQtdOrig, nValCorr / nQtdOrig * nQuant, nValCorr)
		nValCorr   := (nValCorr, X3Decimal("N3_VRCACM1"))
		
		nValCorDep := Round((aVlrAcum[Val(cMoedaAtf)]+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG"+cMoedaAtf))-;
		(aVlrAcum[Val(cMoedaAtf)]+aValDepr[Val(cMoedaAtf)])
		nValCorDep := IIF(nQuant< nQtdOrig, nValCorDep / nQtdOrig* nQuant, nValCorDep)
		nValCorDep := Round(nValCorDep, X3Decimal("N3_VRCDA1" ))
	EndIf
EndIf
aVlrAtual[1] := aVlrAtual[1]+nValCorr

// *******************************
// Controle de multiplas moedas  *
// *******************************
For nMoeda := 1 To __nQuantas
	cMoeda := Alltrim(Str(nMoeda))
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	nResidual := aVlrAcum[nMoeda]+aValDepr[nMoeda]
	nResidual := Abs(aVlrAtual[nMoeda]-nResidual)
	
	aVlResid[nMoeda] := nResidual
	
	If cPaisLoc == "ARG"
		If  SN1->N1_CONSAB == "1"
			nDiasDepr := 0
		Else
			nDiasDepr := (LastDay(dData)-FirstDay(dData))+1
		EndIf
	Else
		If Month(SN3->N3_DINDEPR) == Month(dData) .And.;
			Year(SN3->N3_DINDEPR) == Year(dData)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Nro de dias a depreciar qdo a baixa ┌ feita no mesmo m┬s e ano daЁ
			//Ё data de in║cio de deprecia┤ao.                                   Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			nDiasDepr := (dData-SN3->N3_DINDEPR)+1
		ElseIf Month(SN3->N3_DINDEPR) > Month(dData) .And.;
			Year(SN3->N3_DINDEPR) == Year(dData)
			nDiasDepr := 0
		Endif
	EndIf
	
	If (!Empty(aDiferenca[nMoeda])  .And. (Round(aDiferenca[nMoeda],X3Decimal("N3_VORIG"+cMoeda)) > 0)) .Or. (cTipDepr == "0")
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё nDias - nёmero de dias no m┬s em que se est═ efetuando o c═lc.   Ё
		//Ё nDiasDepr - nёmero efetivo de dias a depreciar no m┬s.           Ё
		//Ё   Somente deprecio proporcional ao nёmero de dias do m┬s quando  Ё
		//Ё o valor da deprecia┤└o NAO ┌ um res║duo de deprecia┤└o. Caso se- Ё
		//Ё ja um res║duo, este ser═ o valor da deprecia┤└o do m┬s, na oca - Ё
		//Ё si└o da baixa.                                                   Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		// *******************************
		// Controle de multiplas moedas  *
		// *******************************
		aValDepr[nMoeda] := aValDepr[nMoeda] / nDias * nDiasDepr
	Endif
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	aVRDACM[nMoeda]  := aVlrAcum[nMoeda]
	
	If aDepr[nMoeda] != 0
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Baixa de bem com residuo de depreciacao em uma ou outra moeda    Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aValDepr[nMoeda]  := Round(aDepr[nMoeda] , X3Decimal("N3_VRDMES"+cMoeda))
	Endif
	If nQuant = nQtdOrig
		aValBaixa[nMoeda] := Round(aVlrAtual[nMoeda] / nQtdOrig * nQuant, X3Decimal("N3_VORIG"+cMoeda))
	Endif
	aValBaixa[nMoeda] := Round(aValBaixa[nMoeda], X3Decimal("N3_VORIG"+cMoeda))
	aVlResid[nMoeda]  := Round(aVlResid[nMoeda]	, X3Decimal("N3_VORIG"+cMoeda))
	aVRDACM[nMoeda]   := Round(aVRDACM[nMoeda]	, X3Decimal("N3_VRDACM"+cMoeda))
Next

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calculo de Correcao da correcao do bem e da depreciacao.              Ё
//Ё A taxa de correcao e a mesma para o custo e p/ depr acumulada.        Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lCalcula
	nTaxaCorr  := nParCorrec
Else
	If DtoS(dData) < "19941001"
		nTaxaCorr := RecMoeda(dData,cMoedaAtf)
	Else
		nTaxaCorr := 0
	Endif
Endif
If nTaxaCorr != 0
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	nValCorr   := Round(aVlrAtual[Val(cMoedaAtf)]*nTaxaCorr,X3Decimal("N3_VORIG"+cMoedaAtf))-(aVlrAtual[1])
	nValCorDep := Round((aVlrAcum[Val(cMoedaAtf)]+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG"+cMoedaAtf))-(aVlrAtual[1])
	nValCorr   := IIF(nQuant < nQtdOrig, nValCorr / nQtdOrig * nQuant, nValCorr)
	nValCorDep := IIF(nQuant< nQtdOrig, nValCorDep / nQtdOrig* nQuant, nValCorDep)
	nValCorDep := Round(nValCorDep, X3Decimal("N3_VRCDA1" ))
Endif

Return .T.

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030CAOFFЁ Autor Ё Alice Yamamoto		Ё Data Ё17.11.97  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Calcular os valores para a Baixa                           Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe e Ё AF030CAOFF                                                 Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ 															  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030													  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030CAOFF(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,aVlrAcum,nOrig1)
Local nDiasDepr  := Day(dBaixa030)
Local i
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)

// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
Local lAtClDepr := .F.

Private aTxMedia := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
Private aVRDACM  := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

lBxFilho := IIf(lBxFilho == Nil , .F., lBxFilho)
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Formula para c═lculo da propor┤└o da baixa							  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
nValorBaixa := 0
// *******************************
// Controle de multiplas moedas  *
// *******************************
aValBx := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

dbSelectArea("SN3")

// Carrega o valor da deprecia┤└o acumulada

// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	AtfMultMoe(,,{|x| aVRDACM[x]  := aVlrAcum[x]})
Else
	aVRDACM[1]  := aVlrAcum[1]
	aVRDACM[2]  := aVlrAcum[2]
	aVRDACM[3]  := aVlrAcum[3]
	aVRDACM[4]  := aVlrAcum[4]
	aVRDACM[5]  := aVlrAcum[5]
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula a taxa media para cada moeda												Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dDataI := FirstDay(dBaixa030)
dDataI := IIF(dDindepr > dDataI, dDindepr, dDataI)
dbSelectArea("SM2")
dbSeek(dDataI,.T.)
aTxMedia[1] := 1
// *******************************
// Controle de multiplas moedas  *
// *******************************
aDias := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
While !Eof() .And. SM2->M2_DATA <= dBaixa030
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	For i := 2 To __nQuantas
		cMoeda := Alltrim(Str(i))
		IF &('SM2->M2_MOEDA'+cMoeda) > 0
			aDias[i] += 1
			aTxMedia[i] += &('SM2->M2_MOEDA'+cMoeda)
		End
	Next
	dbSkip()
End

// *******************************
// Controle de multiplas moedas  *
// *******************************
For i := 2 To __nQuantas
	cMoeda := Alltrim(Str(i))
	IF aTxMedia[i] == 0 .Or. aDias[i] == 0
		aDias[i] 	:= 1
		aTxMedia[i] := 1
	Else
		aTxMedia[i] := aTxMedia[i] / aDias[i]
	End
Next

If Dtos(SN3->N3_AQUISIC) >= "19960701"  //At┌ os dias de hoje
	dbSelectArea("SM2")
	If dbSeek(SN3->N3_AQUISIC)
		nTaxaCorr := &("M2_MOEDA"+cMoedaAtf)
	Else
		nTaxaCorr := 0.8287
	EndIf
Else
	If Dtos(dDataBase) >= "19960101"	.or. aTxMedia[Val(cMoedaAtf)] = 0
		nTaxaCorr := 0.8287
	Else
		nTaxaCorr := aTxMedia[Val(cMoedaAtf)]
	Endif
Endif
nTaxaCorr := IIf(ExistBlock("A30EMBRA"),ExecBlock("A30EMBRA",.F.,.F.),nTaxaCorr)

If lUmaVez
	nPercentual := aValBaixa[1] / aVlrAtual[1]
	nPercAtiv   := nPercentual
	lUmaVez     := If(AllTrim(Upper(FunName()))=="MATA466N", .T., .F.)
Endif

If lAuto
	nPercentual := aValBaixa[1] / aVlrAtual[1]
EndIf

If lBxFilho
	nPercentual := nPercAtiv
Endif

// *******************************
// Controle de multiplas moedas  *
// *******************************
nValCC	:= Round(aVlrAtual[Val(cMoedaAtf)]*nTaxaCorr, X3Decimal("N3_VORIG"+cMoedaAtf))
nValDPR	:= Round((aVlrAcum[Val(cMoedaAtf)]+aValDepr[Val(cMoedaAtf)])*nTaxaCorr,X3Decimal("N3_VORIG"+cMoedaAtf))

If nQuant = nQtdOrig
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aValDepr := AtfMultMoe(,,{|x| Round(aValDepr[x]*nPercentual, X3Decimal( "N3_VORIG"+Alltrim(Str(x)) )) })
	Else
		aValDepr[1] := Round(aValDepr[1]*nPercentual, X3Decimal("N3_VORIG1"))
		aValDepr[2] := Round(aValDepr[2]*nPercentual, X3Decimal("N3_VORIG2"))
		aValDepr[3] := Round(aValDepr[3]*nPercentual, X3Decimal("N3_VORIG3"))
		aValDepr[4] := Round(aValDepr[4]*nPercentual, X3Decimal("N3_VORIG4"))
		aValDepr[5] := Round(aValDepr[5]*nPercentual, X3Decimal("N3_VORIG5"))
	EndIf
	nValCorDep:= Round(nValCorDep*nPercentual,X3Decimal("N3_VRCMES1"))
	nValCorr  := Round(nValCorr*nPercentual,  X3Decimal("N3_VRCACM1"))
Endif

If Month(SN3->N3_DINDEPR) == Month(dBaixa030) .And.;
	Year(SN3->N3_DINDEPR) == Year(dBaixa030)
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Nro de dias a depreciar qdo a baixa ┌ feita no mesmo m┬s e ano daЁ
	//Ё data de in║cio de deprecia┤ao.                                   Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	nDiasDepr := (dBaixa030-SN3->N3_DINDEPR)+1
ElseIf Month(SN3->N3_DINDEPR) > Month(dBaixa030) .And.;
	Year(SN3->N3_DINDEPR) == Year(dBaixa030)
	nDiasDepr := 0
EndIf
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё nValBaixTot - Valor da deprec do mes na moeda do ativo          Ё
//Ё nValBaixPro - Valor da deprec do mes proporcional ao nro de     Ё
//Ё             - de dias na Moeda do Ativo.                        Ё
//Ё nValDeprPro - Valor da deprec do mes na Moeda Corrente(Real)    Ё
//Ё nValorBaixa - Valor da deprec acum a baixar na Moeda do Ativo   Ё
//Ё             - (UFIR) j═ proporcional ao nёmero de dias.         Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
If aVlrAcum[Val(cMoedaAtf)] < aVlrAtual[Val(cMoedaAtf)]
	nValBaixTot := aValBaixa[Val(cMoedaAtf)]*(SN3->N3_TXDEPR1/1200)
	nValBaixPro := Round(nValBaixTot*( nDiasDepr / Day(LastDay(dBaixa030))),x3Decimal("N3_VORIG"+cMoedaAtf))
	nValDeprPro := Round(nValBaixPro*nTaxaCorr,x3Decimal("N3_VORIG1"))
	nValorBaixa := Round((aVlrAcum[Val(cMoedaAtf)]*nPercentual)+aValDepr[Val(cMoedaAtf)],x3Decimal("N3_VORIG"+cMoedaAtf))
Else
	nValorBaixa:= aVlrAcum[Val(cMoedaAtf)]*nPercentual
	nValCorDep := nValCorr
EndIf

// *******************************
// Controle de multiplas moedas  *
// *******************************
aValBx[1] := Round(nValorBaixa * nTaxaCorr,x3Decimal("N3_VORIG1"))
For i :=2 to __nQuantas
	cMoed := Alltrim(Str(i))
	If cMoedaAtf # cMoed
		aValBx[i]  := Round((aVlrAcum[i]*nPercentual)+aValDepr[i], X3Decimal("N3_VORIG"+cMoed))
	Else
		aValBx[i] := nValorBaixa
	Endif
	
Next

// Verifica se a classificaГЦo de ativo sofre depreciaГЦo
lAtClDepr := AtClssVer(SN1->N1_PATRIM)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё nValorBaixa <= SN3->N3 ... ,no caso em que a baixa ┌ feita sobre  Ё
//Ё um bem quase totalmente depreciado.O valor da baixa nao pode ul-  Ё
//Ё trapassar o valor original em moeda forte. nVlrAtual1 = nValbaixa1Ё
//Ё no casos de baixa por valor.    											 Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lAtClDepr .OR. EMPTY(SN1->N1_PATRIM)
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If nValorBaixa <= Round((aVlrAtual[Val(cMoedaAtf)])*nPercentual,X3Decimal("N3_VORIG"+cMoedaAtf))
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Na baixa total se o valor da depreciacao acumulada + correcao da  Ё
		//Ё depreciacao acumulada + a depreciacao do mes for > que o valor oriЁ
		//Ё ginal + a correcao do bem, a depreciacao do mes e = valor originalЁ
		//Ё + a sua correcao - deprec acum+ a sua correcao p/ evitar q a depreЁ
		//Ё ciacao acumulada seja maior que o valor original.                 Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If aVlrAtual[1] = aValBaixa[1]
			
			For i:=1 to __nQuantas
				If (aVlrAcum[i]+aValDepr[i]) > (aVlrAtual[i])
					aValDepr[i] := aVlrAtual[i]-aVlrAcum[i]
				EndIf
			Next
		Endif
	EndIf
Endif
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Baixa a partir de outubro de 1994 - IOB Ir/Legisla┤└o Societ═ria  Ё
//Ё P═gina 466 - A partir de outubro de 1994 n└o haver═ mais corre┤└o Ё
//Ё monet═ria na baixa, pois esta j═ ocorreu no c═lculo da corre┤└o	 Ё
//Ё pela ufir do m┬s seguinte.													 Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Dtos(dBaixa030)>=Dtos(cTod("01/10/94")).And. !lCalcula
	nValCorr := 0
	nValCorDep := 0
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Se o bem j═  estiver totalmente depreciado, cancela os c═lculos de de- Ё
//Ё precia┤└o. Obs: A F╒rmula de c═lculo est═  muito complicada.				Ё
//Ё																								Ё
//Ё Aten┤└o: S╒ deve manter a deprecia┤└o se a data de in║cio de depreci-	Ё
//Ё a┤└o tenha sido alcan┤ada.															Ё
//Ё																								Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	AtfMultMoe(,,{|x| If(aVlrAcum[x] >= aVlrAtual[x] .or. dDindepr > dBaixa030,aValDepr[x] := 0,.F.) })
Else
	If aVlrAcum[1] >= aVlrAtual[1] .or. dDindepr > dBaixa030
		aValDepr[1] := 0
	Endif
	If aVlrAcum[2] >= aVlrAtual[2] .or. dDindepr > dBaixa030
		aValDepr[2] := 0
	Endif
	If aVlrAcum[3] >= aVlrAtual[3] .or. dDindepr > dBaixa030
		aValDepr[3] := 0
	Endif
	If aVlrAcum[4] >= aVlrAtual[4] .or. dDindepr > dBaixa030
		aValDepr[4] := 0
	Endif
	If aVlrAcum[5] >= aVlrAtual[5] .or. dDindepr > dBaixa030
		aValDepr[5] := 0
	Endif
EndIf
Af030GrOFF(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,nOrig1)
//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё  Libera o softlock instalado antes do while acima.  Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SN3")
msUnlock()
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030GrOFF  Ё Autor Ё Alice Yamamoto 		  Ё Data Ё          Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁAtualiza tela de sele┤ao de registros da baixa OFF LINE       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAf030GROFF( cMarca,lInverte,oQtda,cArquivo) 	   				Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030GrOFF(cAlias, cNota, cSerie, lBxFilho,nQuant,nQtdOrig,nOrig1)
Local aArea     := GetArea()
Local nPropSF9  := 0
Local nVlrSFA   := 0
Local nFatorSFA := 0
Local nRegSN3   := 0
Local nPosSN4   := 0
Local nVlOrig   := 0
Local cBase     :=""
Local cItem     := ""
Local cSeqReav  := ""
Local cSeq      := ""
Local cSeekSN4  := ""
Local nMaior    := 0
Local cIDMOV	:= ""
Local cTpSaldo	:= ""
Local lSN3Saldo := .T.
Local cOcorr 	:= ""
Local aDadosComp :={}
Local aValores   := {}
Local cTypes10	:= IIF(lIsRussia,"*" + AtfNValMod({1}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models
Local cTypesNM	:= IIF(lIsRussia,"*" + AtfNValMod({3,4}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Local cTypes12	:= IIF(lIsRussia,"/" + AtfNValMod({2}, "/"),"") // CAZARINI - 10/04/2017 - If is Russia, add new valuations models - recoverable models

lCalcChi:= Iif (Type("lCalcChi") == "U" , .F.,lCalcChi)

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera um novo sequencial a apartir do ёltimo sequencial gerado 			Ё
//цддддддддддбддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Begin TRANSACTION
dbSelectArea("SN3")
cSeqReav := SN3->N3_SEQREAV
nSavRec := SN3->( Recno() )
cBase := SN3->N3_CBASE
cItem := SN3->N3_ITEM
cSeq  := SN3->N3_SEQ
****************** CIAP ********************
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza o Cadastro de CIAP                                            Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SF9")
dbSetOrder(1)
If ( dbSeek(xFilial("SF9")+SN1->N1_CODCIAP) )
	dbSelectArea("SN3")
	dbSetOrder(1)
	nRegSN3 := SN3->(Recno())
	dbSeek(xFilial("SN3")+SN1->N1_CBASE+SN1->N1_ITEM)
	While ( !Eof() .And. xFilial("SN3")==SN3->N3_FILIAL .And.;
		SN1->N1_CBASE ==SN3->N3_CBASE  .And.;
		SN1->N1_ITEM  ==SN3->N3_ITEM )
		If ( SN3->N3_TIPO $ ("01*03*10*16*17" + cTypes10 + cTypesNM) )
			nVlOrig += &('SN3->N3_VORIG'+cMoedaAtf)
		EndIf
		dbSelectArea("SN3")
		dbSkip()
	EndDo
	dbSelectArea("SN3")
	dbGoto(nRegSN3)
	nPropSF9 := NoRound(aValBaixa[Val(cMoedaAtf)]*SN1->N1_ICMSAPR/nVlOrig,2)
	nFatorSFA:= (Year(SF9->F9_DTENTNE)+5-Year(dBaixa030))
	nVlrSFA  := Round(nPropSF9*nFatorSFA*.20,4)
	dbSelectArea("SFA")
	dbSetOrder(1)
	dbSeek(xFilial("SFA")+SF9->F9_CODIGO+Dtos(Ctod("01/01/"+StrZero(Year(dBaixa030),4),"ddmmyy")),.T. )
	While ( !Eof() .And. xFilial("SFA")==SFA->FA_FILIAL .And.;
		SFA->FA_CODIGO==SF9->F9_CODIGO  )
		If ( SFA->FA_TIPO == "1" )
			nVlrSFA -= SFA->FA_VALOR
		EndIf
		dbSelectArea("SFA")
		dbSkip()
	EndDo
	RecLock("SF9")
	SF9->F9_DOCNFS := cNota
	SF9->F9_SERNFS := cSerie
	SF9->F9_ITEMNFS := cNFItem
	SF9->F9_DTEMINS:= dBaixa030
	SF9->F9_MOTIVO := If(Val(SubStr(cMotivo,1,2))==1,"2",If(Val(SubStr(cMotivo,1,2))==10,"3",If(Val(SubStr(cMotivo,1,2))==23,"4","1")))
	SF9->F9_BXICMS += nPropSF9
	If SF9->(F9_BXICMS>0 .And. F9_BXICMS+F9_VLESTOR<F9_VALICMS)
		SF9->F9_BAIXAPR := "1"
	Else
		SF9->F9_BAIXAPR := "0"
	EndIf
	MsUnlock()
	RecLock("SFA",.T.)
	SFA->FA_FILIAL := xFilial("SFA")
	SFA->FA_DATA   := dBaixa030
	SFA->FA_TIPO   := "2"
	SFA->FA_VALOR  := nVlrSFA
	SFA->FA_FATOR  := nFatorSFA
	SFA->FA_CODIGO := SF9->F9_CODIGO
	SFA->FA_ROTINA := "ATFA030"
	If SF9->(F9_BXICMS>0 .And. F9_BXICMS+F9_VLESTOR<F9_VALICMS)
		SFA->FA_BAIXAPR := "1"
	Else
		SF9->F9_BAIXAPR := "0"
	EndIf
	//Segundo Vitor N3-FISCAL no campo FA_MOTIVO deve gravar mesmo conteudo do F9_MOTIVO para uso SPED PIS/COFINS
	SFA->FA_MOTIVO := SF9->F9_MOTIVO
	MsUnlock()
EndIf

If lAuto
	nVlVend := 0
Else
	nVlVend := IIf(nVlVend = NIL, 0, nVlVend)
EndIf

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Garantir que grave os mesmos nros no SN5 							Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
aValBx[1] := Iif(!lCalcChi,SN3->N3_VRDACM1+SN3->N3_VRCDA1,0)
If lMultMoed
	AtfMultMoe(,,{|x| aValBx[x] := Iif(!lCalcChi,SN3->&( If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)) ),0) })
Else
	aValBx[2] := Iif(!lCalcChi,SN3->N3_VRDACM2,0)
	aValBx[3]:= Iif(!lCalcChi,SN3->N3_VRDACM3,0)
	aValBx[4] := Iif(!lCalcChi,SN3->N3_VRDACM4,0)
	aValBx[5] := Iif(!lCalcChi,SN3->N3_VRDACM5,0)
EndIf
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Executa rdmake espec║fico para a Localiza, quando este existir em		Ё
//Ё disco. Observa┤ao: este rdmake solicita o valor de venda do bem			Ё
//Ё para efeitos de contabilizacao. 													Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

If ExistBlock("ATFA030")
	ExecBlock("ATFA030",.F.,.F.)
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Se for baixa parcial devo criar uma nova sequencia no SN4           	Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

dbSelectArea("SN4")
nPosSN4 := Recno()
cSeekSN4 := xFilial()+SN3->N3_CBASE+SN3->N3_ITEM
If Round(NoRound(nOrig1,3),2)!= Round(NoRound(aVlrAtual[1],3),2)
	dbSeek(xFilial()+SN3->N3_CBASE+SN3->N3_ITEM)
	nMaior := 0
	dbEval({ || nMaior:=If( Val(SN4->N4_SEQ)>nMaior, Val(SN4->N4_SEQ), nMaior )},,;
	{ || cSeekSN4 == SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM })
	cSeq := StrZero(nMaior+1,3)
Else
	cSeq := SN3->N3_SEQ
EndIf
SN4->(dbGoto(nPosSN4))

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Deprecia┤└o)									Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
nTotDepr	:= 0
If lMultMoed
	AtfMultMoe(,,{|x| nTotDepr += aValDepr[x] })
Else
	nTotDepr += aValDepr[1]
	nTotDepr += aValDepr[2]
	nTotDepr += aValDepr[3]
	nTotDepr += aValDepr[4]
	nTotDepr += aValDepr[5]
EndIf
If nTotDepr # 0
	cOcorr 	   := IIF( SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54"+cTypes10+cTypes12+cTypesNM), "20", IIF(SN3->N3_TIPO == "07","10",IIF(SN3->N3_TIPO=="08","12",IIF(SN3->N3_TIPO == "09","11","06"))))
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"3",nQuant,cTpSaldo,,aValDepr,aDadosComp)
EndIf

// *******************************
// Controle de multiplas moedas  *
// *******************************
nTotDepr	:= 0
If lMultMoed
	AtfMultMoe(,,{|x| nTotDepr += aValDepr[x] })
Else
	nTotDepr += aValDepr[1]
	nTotDepr += aValDepr[2]
	nTotDepr += aValDepr[3]
	nTotDepr += aValDepr[4]
	nTotDepr += aValDepr[5]
EndIf

If nTotDepr # 0
	cOcorr 	   := IIF( SN3->N3_TIPO $ ("10,12,16,17,50,51,52,53,54"+cTypes10+cTypes12+cTypesNM), "20", IIF(SN3->N3_TIPO == "07","10",IIF(SN3->N3_TIPO=="08","12",IIF(SN3->N3_TIPO == "09","11","06"))))
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",nQuant,cTpSaldo,,aValDepr,aDadosComp)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo movimenta┤└o (Corre┤└o) 										Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
IF nValCorr # 0
	cOcorr 	   := "07"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, IIf(SN3->(FieldPos("N3_PRODMES"))>0,SN3->N3_PRODMES,0) )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorr , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"2",nQuant,cTpSaldo,,aValores,aDadosComp)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Corre┤└o da Deprecia┤└o)					Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorDep # 0
	cOcorr 	   := "08"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, IIf(SN3->(FieldPos("N3_PRODMES"))>0,SN3->N3_PRODMES,0) )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorDep , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",0,cTpSaldo,,aValores,aDadosComp)
	
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza arquivo Movimenta┤■es (Corre┤└o da Deprecia┤└o)					Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorDep # 0
	cOcorr 	   := "08"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, IIf(SN3->(FieldPos("N3_PRODMES"))>0,SN3->N3_PRODMES,0) )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorDep , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"5",0,cTpSaldo,,aValores,aDadosComp)
End

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera registro de movimenta┤└o														Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
// *******************************
// Controle de multiplas moedas  *
// *******************************
nBaixa	:= 0
If lMultMoed
	AtfMultMoe(,,{|x| nBaixa += aValBaixa[x] })
Else
	nBaixa += aValBaixa[1]
	nBaixa += aValBaixa[2]
	nBaixa += aValBaixa[3]
	nBaixa += aValBaixa[4]
	nBaixa += aValBaixa[5]
EndIf

If nBaixa # 0
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	cOcorr 	   := "01"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"1",nQuant,cTpSaldo,,aValBaixa,aDadosComp)
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gera registro de movimenta┤└o														Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nValCorr # 0
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	cOcorr 	   := "07"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aValores[1] := Round(nValCorr , X3Decimal("N4_VLROC1") )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"1",nQuant,cTpSaldo,,aValores,aDadosComp)
Endif

// *******************************
// Controle de multiplas moedas  *
// *******************************
nBaixa	:= 0
If lMultMoed
	AtfMultMoe(,,{|x| nBaixa += aValBx[x] })
Else
	nBaixa += aValBx[1]
	nBaixa += aValBx[2]
	nBaixa += aValBx[3]
	nBaixa += aValBx[4]
	nBaixa += aValBx[5]
EndIf

If nBaixa # 0
	//Gerar registro de baixa da depreciacao
	If lAuto
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( aValBaixa[1], X3Decimal("N4_VENDA")),0 )
	Else
		nVenda  := Iif(SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM),Round( nVlVend  , X3Decimal("N4_VENDA")),0 )
	Endif
	cOcorr 	   := "01"
	aDadosComp := ATFXCompl(aTxMedia[Val(cMoedaAtf)] , &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),cMotivo,/*cCodBaix*/,/*cFilOrig*/,cSerie,cNota,nVenda,/*cLocal*/, SN3->N3_PRODMES )
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dBaixa030,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,cSeqReav,"4",nQuant,cTpSaldo,,aValBx,aDadosComp)
	
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza o arquivo de simulacoes, caso este exista  	Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lSN7
	dbSelectArea("SN7")
	dbSetOrder(1)
	If dbSeek(xFilial("SN7")+SN3->N3_CBASE+SN3->N3_ITEM)
		If Empty(SN7->N7_VLREAL)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Atualiza o arquivo de simulacoes, desde que o valor 	Ё
			//Ё Real nao esteja preenchido. Pois caso o bem possua a-Ё
			//Ё gregados sera gravado o valor do bem de tipo 01.    	Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддды
			RecLock("SN7")
			SN7->N7_DTBAIXA := dBaixa030
			SN7->N7_MOTIVO  := cMotivo
			SN7->N7_NOTA    := cNota
			SN7->N7_SERIE   := cSerie
			SN7->N7_VLREAL  := Round( aValBaixa[1] , X3Decimal("N4_VLROC1") )
		EndIf
		MsUnlock()
	Endif
EndIf

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica qual o lancamento padronizado que devera ser utilizado			Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SN3")

If SN3->N3_TIPO $ ("01*10*16*17"+cTypes10+cTypesNM)			// Aquisi┤└o
	cPadrao := "810"
ElseIf SN3->N3_TIPO $ "02,05"    // Reavalia┤└o
	cPadrao := "811"
ElseIf SN3->N3_TIPO $ "03*13"      // Adiantamento
	cPadrao := "812"
ElseIf SN3->N3_TIPO == "04"      // Lei 8200 (Dif. BTN/IPC)
	cPadrao := "813"
ElseIf Alltrim(cMotivo) == "13" // Baixa por conversЦo
	cPadrao := "81C"
Else
	cPadrao := "81A"
EndIf


If ExistBlock("AF030GRV")
	ExecBlock("AF030GRV",.F.,.F.)
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Final da Protecal via TTS
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
End Transaction

RestArea(aArea)
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030DadosBxЁ Autor Ё Wagner Mobile Costa   Ё Data Ё21.03.2002Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁMonta tela para confirmacao dos dados da baixa                Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAf030DadosBx( Parametros locais da rotina Af030Baixa) 		Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё SigaAtf														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function Af030DadosBx(	cBase, cItem, cTipo, nQuant, nQtdOrig, nUfir,;
onVlVend,lBxFilho,lVlVend,cBxFilho, cNota, cSerie,;
lCancela, lInforma,lAf030Auto, aAutoCab, lBx, aValidMot, cTpSld,cNFItem)

Local oDlg, nOpt 	 := 0
// *******************************
// Controle de multiplas moedas  *
// *******************************
Local aDescMoeda 	 := {}
Local aValidGet  	 := {}
Local oBaixa030
Local lInfBx		:= .F.
Local lValidaNFD := SuperGetMV("MV_AF30NDV", .F., .F.) //controle de CIAP
Local nQtdOld	 := nQuant
Local nPercOld	 := nPercBaixa

DEFAULT lCancela 	 := .F.
DEFAULT lInforma 	 := .T.
DEFAULT lAf030Auto := .F.
DEFAULT aAutoCab 	 := {}
DEFAULT aValidMot	:= {}
DEFAULT cNFItem      := " "  

cPictQtd  := PesqPict("SN1","N1_QUANTD")

//Utilizado pela baixa direta do ATFA320
If IsInCallStack("ATFA320")
	lInfBx := .T.
	lInforma := .F.
	lBxFilho := .T.
EndIf

// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	AtfMultMoe(,,{|x| aAdd(aDescMoeda,GETMV( "MV_SIMB"+Alltrim(Str(x)) )) })
Else
	aDescMoeda := { GETMV("MV_SIMB1"),GETMV("MV_SIMB2"),GETMV("MV_SIMB3"),GETMV("MV_SIMB4"),GETMV("MV_SIMB5") }
EndIf

If ! lAf030Auto
	DEFINE MSDIALOG oDlg FROM	55,6 TO 400,640 TITLE STR0013 PIXEL  //"Baixa de Ativos Imobilizados"
	@ 000, 003 	TO 025, 315 LABEL STR0014 OF oDlg PIXEL  //"Dados do Bem"
	@ 027, 003	TO 069, 315 LABEL STR0015 OF oDlg PIXEL  //"Informa┤■es Complementares"
	@ 074, 003 	TO 154, 038 LABEL STR0016 OF oDlg PIXEL  //"Moedas"
	If ! lCancela
		@ 074, 040 	TO 154, 109 LABEL STR0017 OF oDlg PIXEL  //"Valor Atualizado"
		@ 074, 115 	TO 154, 187 LABEL STR0018 OF oDlg PIXEL  //"Valor Residual"
	Endif
	@ 074, 193 	TO 154, 265 LABEL STR0019 OF oDlg PIXEL   //"Valor da Baixa"
	@ 013, 004 	SAY STR0020  SIZE 025, 07 OF oDlg PIXEL   //"C╒digo"
	@ 010, 024 	MSGET cBase  SIZE 040, 10 OF oDlg PIXEL When .F.
	@ 013, 065 	SAY STR0021  SIZE 015, 07 OF oDlg PIXEL   //"Item"
	@ 010, 077 	MSGET cItem  SIZE 020, 10 OF oDlg PIXEL READONLY F3 "ATFRDO" HASBUTTON
	@ 013, 110 	SAY STR0022  SIZE 012, 07 OF oDlg PIXEL   //"Tipo"
	@ 010, 123 	MSGET cTipo  SIZE 04,  10 OF oDlg PIXEL When .F.
	@ 013, 139 	SAY STR0023  SIZE 035, 07 OF oDlg PIXEL   //"Descri┤└o"
	@ 010, 170 	MSGET SN1->N1_DESCRIC  SIZE 090, 10 OF oDlg PIXEL When .F.
	@ 013, 260 	SAY STR0094 SIZE 025, 07 OF oDlg PIXEL   //"Tp. Sld."
	@ 010, 285 	MSGET cTpSld  SIZE 020, 10 OF oDlg PIXEL When .F.
	@ 041, 005 	SAY STR0024  SIZE 033, 07 OF oDlg PIXEL   //"Qtde.Atual"
	@ 037, 035 	MSGET SN1->N1_QUANTD SIZE 055, 10 OF oDlg PIXEL Picture cPictQtd When .F. HASBUTTON
	@ 041, 095 	SAY STR0025  SIZE 025, 07 OF oDlg PIXEL   //"Data"
	@ 037, 110 	MSGET oBaixa030 VAR dBaixa030 SIZE 048, 10 OF oDlg PIXEL When !lCancela HASBUTTON ;
	Valid !Empty(dBaixa030)	 .And. AF030DtBx(dBaixa030) .And.;
	AF030Resid(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir)
	
	@ 041, 160 	SAY STR0026 	SIZE 022, 07 OF oDlg PIXEL   //"Motivo"
	@ 037, 179 	MSCOMBOBOX oCbx VAR cMotivo ITEMS aMotivos SIZE 061, 65 OF oDlg PIXEL;
	ON CHANGE CheckCombo(onVlVend,lBxFilho,@lVlVend,cBxFilho);
	WHEN ! lCancela .And. (lInforma .Or. lInfBx) ;
	VALID AF030VLDMOT(aValidMot,cMotivo)
	@ 041, 244 	SAY STR0027 	SIZE 025, 07 OF oDlg PIXEL  //"Num.NF"
	@ 037, 266 	MSGET cNota		SIZE 024, 10 OF oDlg PIXEL Picture "@!" When ! lCancela .And. ! lInfBx Valid Af030Nota(cNota, cMotivo )
	  // SOMENTE COM CONTROLE DE CIAP
	If cPaisloc == "BRA" .and. lValidaNFD
		@ 056, 005 	SAY STR0028 	SIZE 017, 07 OF oDlg PIXEL  //"S┌rie"
		@ 054, 020 	MSGET cSerie 	SIZE 014, 10 OF oDlg PIXEL Picture "@!" When ! lCancela .And. ! lInfBx Valid Af030Serie(cNota, cSerie, cMotivo )
		
		@ 056, 050 	SAY STR0092 	SIZE 017, 07 OF oDlg PIXEL  //"Item"
		@ 054, 070 	MSGET cNFItem 	SIZE 014, 10 OF oDlg PIXEL Picture "@!" When ! lCancela .And. ! lInfBx Valid Af030Item(cNota, cSerie, cNFItem, cMotivo )
		
		@ 056, 100 	SAY STR0029 	SIZE 055, 07 OF oDlg PIXEL  //"Qtde.Baixada"
		@ 054, 135 	MSGET nQuant 	SIZE 040, 10 OF oDlg PIXEL  Picture cPictQtd When ! lCancela .And. ! lInfBx ;
		Valid AF030BxValor(@nQuant,nQtdOrig) .And. AF030Quant(nQuant,@nPercBaixa,nQtdOrig)	.And. ;
		AF030Resid(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir) hasbutton
		
		@ 056, 187 	SAY STR0030 	OF oDlg PIXEL   //"% Baixado"
		@ 054, 217 	MSGET nPercBaixa SIZE 035, 10 OF oDlg PIXEL Picture "@E 999.9999" HASBUTTON When ! lCancela .And. nQuant == 0 .And. ! lInfBx  ;
		Valid AF030Perc(nPercBaixa,@nQuant,nQtdOrig) .And. ;
		AF030Resid(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir)
	
		@ 056,265 	CHECKBOX olBxFilho   VAR lBxFilho;
		PROMPT If(lCancela, STR0047, STR0031) SIZE 65,10 OF oDlg PIXEL;  //"Baixar Filhos" # //"Cancelar Filhos"
		ON CHANGE (CheckOK(lBxFilho, onVlVend,olBxFilho)) Font oDlg:oFont;
		When lInforma
	Else		
		@ 056, 005 	SAY STR0028 	SIZE 017, 07 OF oDlg PIXEL  //"S┌rie"
		@ 054, 035 	MSGET cSerie 	SIZE 014, 10 OF oDlg PIXEL Picture "@!" When ! lCancela .And. ! lInfBx
		
		@ 056, 070 	SAY STR0029 	SIZE 055, 07 OF oDlg PIXEL  //"Qtde.Baixada"
		@ 054, 110 	MSGET nQuant 	SIZE 040, 10 OF oDlg PIXEL  Picture cPictQtd When ! lCancela .And. ! lInfBx ;
		Valid AF030BxValor(@nQuant,nQtdOrig) .And. AF030Quant(nQuant,@nPercBaixa,nQtdOrig)	.And. ;
		AF030Resid(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir) hasbutton
		
		@ 056, 167 	SAY STR0030 	OF oDlg PIXEL   //"% Baixado"
		@ 054, 197 	MSGET nPercBaixa SIZE 035, 10 OF oDlg PIXEL Picture "@E 999.9999" When ! lCancela .And. nQuant == 0 .And. ! lInfBx HASBUTTON;
		Valid AF030Perc(nPercBaixa,@nQuant,nQtdOrig) .And. ;
		AF030Resid(dBaixa030,nQuant,nQtdOrig,@nPercBaixa,@nUfir)
	
		@ 056,245 	CHECKBOX olBxFilho   VAR lBxFilho;
		PROMPT If(lCancela, STR0047, STR0031) SIZE 65,10 OF oDlg PIXEL;  //"Baixar Filhos" # //"Cancelar Filhos"
		ON CHANGE (CheckOK(lBxFilho, onVlVend,olBxFilho)) Font oDlg:oFont;
		When lInforma
	EndIf
	// 1. Moeda
	
	@ 085, 006 	MSGET aDescMoeda[1]   SIZE 30, 10 OF oDlg PIXEL When .f.
	If ! lCancela
		@ 085, 044 	MSGET aVlrAtual[1]	  SIZE 060, 10 OF oDlg PIXEL Picture aPicture[1] When .F.
		@ 085, 119 	MSGET aVlResid[1] 	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[1] When .F.
		@ 085, 197 	MSGET aValBaixa[1]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[1]	When lInforma ;
		Valid AF030Valor(aValBaixa[1],1,nQtdOrig,nQuant) hasbutton
	Else
		@ 085, 197 	MSGET aValBaixa[1]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[1]	WHEN .F. hasbutton
	Endif
	
	// 2. Moeda
	
	@ 098, 006 	MSGET aDescMoeda[2]   SIZE 30, 10 OF oDlg PIXEL When .f.
	If ! lCancela
		@ 098, 044 	MSGET aVlrAtual[2]	  SIZE 060, 10 OF oDlg PIXEL Picture aPicture[2] When .F.
		@ 098, 119 	MSGET aVlResid[2] 	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[2] When .F.
		@ 098, 197 	MSGET aValBaixa[2]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[2] When aVlrAtual[2] != 0 .And. lInforma;
		Valid AF030Valor(aValBaixa[2],2,nQtdOrig,nQuant) hasbutton
	Else
		@ 098, 197 	MSGET aValBaixa[2]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[2] WHEN .F. hasbutton
	Endif
	
	// 3. Moeda
	
	@ 111, 006 	MSGET aDescMoeda[3]	  SIZE 30, 10 OF oDlg PIXEL When .f.
	If ! lCancela
		@ 111, 044 	MSGET aVlrAtual[3]	  SIZE 060, 10 OF oDlg PIXEL Picture aPicture[3] When .F.
		@ 111, 119 	MSGET aVlResid[3] 	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[3] When .F.
		@ 111, 197 	MSGET aValBaixa[3]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[3] When aVlrAtual[3] != 0 .And. lInforma;
		Valid AF030Valor(aValBaixa[3],3,nQtdOrig,nQuant) hasbutton
	Else
		@ 111, 197 	MSGET aValBaixa[3]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[3]	WHEN .F. hasbutton
	Endif
	
	// 4. Moeda
	@ 125, 006 	MSGET aDescMoeda[4]   SIZE 30, 10 OF oDlg PIXEL WHEN .F.
	If ! lCancela
		@ 125, 044 	MSGET aVlrAtual[4]	  SIZE 060, 10 OF oDlg PIXEL Picture aPicture[4] When .F.
		@ 125, 119 	MSGET aVlResid[4] 	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[4] When .F.
		@ 125, 197 	MSGET aValBaixa[4]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[4] When aVlrAtual[4] != 0 .And. lInforma;
		Valid AF030Valor(aValBaixa[4],4,nQtdOrig,nQuant) hasbutton
	Else
		@ 125, 197 	MSGET aValBaixa[4]	  SIZE 063, 10 OF oDlg PIXEL Picture aPicture[4] WHEN .F. hasbutton
	Endif
	
	// 5. Moeda
	
	@ 138, 006 	MSGET aDescMoeda[5]   SIZE 30, 10 OF oDlg PIXEL When .f.
	If ! lCancela
		@ 138, 044 	MSGET aVlrAtual[5]	  	SIZE 060, 10 OF oDlg PIXEL Picture aPicture[5] When .F.
		@ 138, 119 	MSGET aVlResid[5] 	  	SIZE 063, 10 OF oDlg PIXEL Picture aPicture[5] When .F.
		@ 138, 197 	MSGET aValBaixa[5]	  	SIZE 063, 10 OF oDlg PIXEL Picture aPicture[5]	When aVlrAtual[5] != 0 .And. lInforma;
		Valid AF030Valor(aValBaixa[5],5,nQtdOrig,nQuant) hasbutton
	Else
		@ 135, 197 	MSGET aValBaixa[5]	  	SIZE 063, 10 OF oDlg PIXEL Picture aPicture[5]	WHEN .F. hasbutton
	Endif
	
	@ 160, 150 	SAY STR0011 		SIZE 063, 10 OF oDlg PIXEL  //"Valor de Venda"
	@ 159, 197 	MSGET onVlVend 		VAR nVlVend 	SIZE 063, 10 OF oDlg PIXEL PICTURE aPicture[1] hasbutton ;
	VALID nVlVend > 0.00 WHEN ! lCancela .And. lInforma .And. lVlVend
	
	If ! lCancela .And. ExistBlock("AF030CHA")
		ExecBlock("AF030CHA",.F.,.F.)
	Endif
	
	DEFINE SBUTTON FROM 075, 270 TYPE 1 ENABLE OF oDlg ACTION ( nOpt:=TudOk(nOpt,nVlVend,lBxFilho,cMotivo,cNota,cSerie,lBx,cNFItem, lCancela,nQuant),IIf(nOpt ==1,Odlg:End(),.F.))
	DEFINE SBUTTON FROM 090, 270 TYPE 2 ENABLE OF oDlg ACTION ( nOpt:=0,oDlg:End() )
	ACTIVATE MSDIALOG oDlg ON INIT (oBaixa030:SetFocus(),CheckCombo(onVlVend,lBxFilho,@lVlVend))
Else
	aValidGet:= {}
	nQuant := 0
	lBxFilho := .F.
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTQUANT'})) > 0
		nQuant	:=	aAutoCab[nT,2]
		Aadd(aValidGet,{'nQuant' ,aAutoCab[nT,2],"!Empty(dBaixa030) .And. AF030DtBx(dBaixa030) .And. AF030Resid(dBaixa030,nQuant,"+Str(nQtdOrig)+","+Str(nPercBaixa,17,2)+","+Str(nUfir,17,2)+")",.T.})
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTDTBX'})) > 0
		dBaixa030 :=	aAutoCab[nT,2]
		Aadd(aValidGet,{'dBaixa030' ,aAutoCab[nT,2],"!Empty(dBaixa030)	 .And. AF030DtBx(dBaixa030) .And. AF030Resid(dBaixa030,nQuant,"+Str(nQtdOrig)+",@nPercBaixa,"+Str(nUfir)+")",.T.})
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTMOTBX'})) > 0
		cMotivo :=	aAutoCab[nT,2]
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTPERCBX'})) > 0
		If nQuant == 0
			nPercBaixa :=	aAutoCab[nT,2]
			Aadd(aValidGet,{'nPercBaixa' ,aAutoCab[nT,2],"AF030Perc(nPercBaixa,@nQuant,nQtdOrig) .And. AF030Resid(dBaixa030,nQuant,"+Str(nQtdOrig)+",@nPercBaixa,"+Str(nUfir)+")",.T.})
		Endif
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTNOTA'})) > 0
		cNota :=	aAutoCab[nT,2]
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTSERIE'})) > 0
		cSerie := aAutoCab[nT,2]
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTBXFILHOS'})) > 0
		lBxFilho := aAutoCab[nT,2]
	EndIf
	If (nT := ascan(aAutoCab,{|x| x[1]='AUTVLRVENDA'})) > 0
		nVlVend := aAutoCab[nT,2]
		Aadd(aValidGet,{'nVlVend' ,aAutoCab[nT,2],"nVlVend > 0",.T.})
	EndIf
	
	If ! SN3->(MsVldGAuto(aValidGet))  .Or. TudOk(nOpt,nVlVend,lBxFilho,cMotivo,cNota,cSerie,lBx) != 1		// consiste os gets
		nOpt := 0 // Cancela
	Else
		nOpt := 1  // Confirma
	EndIf
Endif

//AVP2
//Nao permite baixa parcial para bens classificados como ORCAMENTO
If nOpt == 1 .and. SN1->N1_PATRIM == 'O' .and. nPercBaixa < 100
	Help(" ",1,"AFBXTPORC",,STR0085,1,0) //"Bens classificados como OrГamento somente podem sofrer baixa total"
	nOpt := 2  // Redigita
ElseIf nOpt == 0
	nQuant := nQtdOld
	nPercBaixa	 := nPercOld
Endif
	
Return nOpt

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030ParcialЁ Autor Ё Wagner Mobile Costa   Ё Data Ё18.04.2002Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁFaz geracao do novo registro do SN3 e baixa o atual           Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe	 ЁAf030Parcial(cBase, cItem, cSeq, cTpBaixa, bComple, dBaixa)   Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё SigaAtf														Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Function Af030Parcial(cBase, cItem, cSeq, dBaixa, bComple, cTpBaixa, cIdMov)

Local aSN3Cmp := {}, nMaior, nSavRec := SN3->(Recno())
Local nDifDep   := 0
Local i
Local nSuf

// *******************************
// Controle de multiplas moedas  *
//    variavel nao declarada     *
// *******************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
Local aAmplia	 := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )

//Acrescentado por Fernando Radu Muscalu em 11/05/2011
//Implementacao de Rateio da ficha do ativo
Local cRatAnt	:= ""
Local cRevAnt	:= ""
Local aRateio	:= {}

DEFAULT cTpBaixa := "1"		// 1=Baixa Normal, 2=Baixa Adiantamento

//AVP
DEFAULT cIDMOV := ""

lCalcChi:= Iif (Type("lCalcChi") == "U" , .F.,lCalcChi)
DbSelectArea("SN3")

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Procuro por baixas Parciais.                                    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSeek(XFilial("SN3") + cBase + cItem)
cSeekSN3 := xFilial("SN3") + cBase + cItem
nMaior := 0
dbEval(	{ || nMaior := If( Val(SN3->N3_SEQ) > nMaior, Val(SN3->N3_SEQ), nMaior )},,;
{ || cSeekSN3 == SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM })

SN3->(dbGoto(nSavRec))
//Acrescentado por Fernando Radu Muscalu em 11/05/2011
If AFXVerRat()
	If SN3->N3_RATEIO == "1"
		cRatAnt	:= SN3->N3_CODRAT
		cRevAnt	:= AF011GETREV(SN3->N3_CODRAT)
		aRateio := Af030LoadRat(cRatAnt,cRevAnt)
		DBSELECTAREA("SN3")
	Endif
EndIf
cSeq := StrZero(nMaior+1,3)

aSN3Cmp	:= {}
For i:=1 To FCount()
	cNomCmp := FieldName(i)
	AAdd(aSN3Cmp,{cNomCmp, &cNomCmp})
Next
nVrcBal1 := SN3->N3_VRCBAL1
nVrcAcm1 := SN3->N3_VRCACM1

nPercAux := aValBaixa[Val(cMoedaAtf)] / aVlrAtual[Val(cMoedaAtf)]
If !lUmaVez .and. !lCalcChi
	nPercAux := nPercAtiv
Endif

Reclock("SN3")
// *******************************
// Controle de multiplas moedas  *
// *******************************
For i:= 1 To __nQuantas
	cMoeda := Alltrim(Str(i))
	If !lCalcChi
		If i>9
			&('SN3->N3_VRDME'+cMoeda) -= Round(N3_VRDME&cMoeda * nPercAux, X3Decimal("N3_VRDME"+cMoeda))
			&('SN3->N3_VRDBA'+cMoeda) -= Round(N3_VRDBA&cMoeda * nPercAux, X3Decimal("N3_VRDBA"+cMoeda))
			&('SN3->N3_VRDAC'+cMoeda) -= Round(N3_VRDAC&cMoeda * nPercAux, X3Decimal("N3_VRDAC"+cMoeda))
		Else
			&('SN3->N3_VRDMES'+cMoeda) -= Round(N3_VRDMES&cMoeda * nPercAux, X3Decimal("N3_VRDMES"+cMoeda))
			&('SN3->N3_VRDBAL'+cMoeda) -= Round(N3_VRDBAL&cMoeda * nPercAux, X3Decimal("N3_VRDBAL"+cMoeda))
			&('SN3->N3_VRDACM'+cMoeda) -= Round(N3_VRDACM&cMoeda * nPercAux, X3Decimal("N3_VRDACM"+cMoeda))
		EndIf
	EndIf
	&('SN3->N3_VORIG'+cMoeda)  -= Round(N3_VORIG&cMoeda  * nPercAux, X3Decimal("N3_VORIG" +cMoeda))
	If i>9
		aAmplia[i] 		:= Round(N3_AMPLI&cMoeda * nPercAux, X3Decimal("N3_AMPLI" +cMoeda))
		&('SN3->N3_AMPLI'+cMoeda) 	-= aAmplia[i]
	Else
		aAmplia[i] 		:= Round(N3_AMPLIA&cMoeda * nPercAux, X3Decimal("N3_AMPLIA"+cMoeda))
		&('SN3->N3_AMPLIA'+cMoeda) 	-= aAmplia[i]
	EndIf
Next	// Proporcionalizar o valor da ampliacao no caso de baixa parcial BOPS 9613
SN3->N3_IDBAIXA := "1"
SN3->N3_VRCACM1 -= Round(SN3->N3_VRCACM1 * nPercAux, X3Decimal("N3_VRCACM1"))
If !lCalcChi
	SN3->N3_VRCMES1 -= Round(SN3->N3_VRCMES1 * nPercAux, X3Decimal("N3_VRCMES1"))
	SN3->N3_VRCBAL1 -= Round(SN3->N3_VRCBAL1 * nPercAux, X3Decimal("N3_VRCBAL1"))
	SN3->N3_VRCDM1  -= Round(SN3->N3_VRCDM1  * nPercAux, X3Decimal("N3_VRCDM1"))
	SN3->N3_VRCDB1  -= Round(SN3->N3_VRCDB1  * nPercAux, X3Decimal("N3_VRCDB1"))
	SN3->N3_VRCDA1  -= Round(SN3->N3_VRCDA1  * nPercAux, X3Decimal("N3_VRCDA1"))
EndIf
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Grava Registro de Baixa (N3_BAIXA="1") em separado qdo esta parcial.Ё
//Ё O reg.de baixa ( N3_BAIXA="1" ) ser═ gravado pela diferenca entre o Ё
//Ё reg. original salvo em aSN3Cmp e o reg. acima. Este ┌ o reg. que fi-Ё
//Ё car═ para futuras baixas ou c═lculos.                               Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	aVRDMES	:= AtfMultMoe("SN3","N3_VRDMES")
Else
	aVRDMES := {0,0,0,0,0}
	aVRDMES[1] := SN3->N3_VRDMES1
	aVRDMES[2] := SN3->N3_VRDMES2
	aVRDMES[3] := SN3->N3_VRDMES3
	aVRDMES[4] := SN3->N3_VRDMES4
	aVRDMES[5] := SN3->N3_VRDMES5
EndIf
// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	aVORIG	:= AtfMultMoe("SN3","N3_VORIG")
Else
	aVORIG := {0,0,0,0,0}
	aVORIG[1]  := SN3->N3_VORIG1
	aVORIG[2]  := SN3->N3_VORIG2
	aVORIG[3]  := SN3->N3_VORIG3
	aVORIG[4]  := SN3->N3_VORIG4
	aVORIG[5]  := SN3->N3_VORIG5
EndIf
nVRCACM1 := SN3->N3_VRCACM1
// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	aAmplia	:= AtfMultMoe("SN3","N3_AMPLIA")
Else
	aAmplia := {0,0,0,0,0}
	aAmplia[1] := SN3->N3_AMPLIA1
	aAmplia[2] := SN3->N3_AMPLIA2
	aAmplia[3] := SN3->N3_AMPLIA3
	aAmplia[4] := SN3->N3_AMPLIA4
	aAmplia[5] := SN3->N3_AMPLIA5
EndIf

If !lCalcChi
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVRDACM	:= AtfMultMoe("SN3","N3_VRDACM")
	Else
		aVRDACM := {0,0,0,0,0}
		aVRDACM[1] := SN3->N3_VRDACM1
		aVRDACM[2] := SN3->N3_VRDACM2
		aVRDACM[3] := SN3->N3_VRDACM3
		aVRDACM[4] := SN3->N3_VRDACM4
		aVRDACM[5] := SN3->N3_VRDACM5
	EndIf
	
	// *******************************
	// Controle de multiplas moedas  *
	// *******************************
	If lMultMoed
		aVRDBAL	:= AtfMultMoe("SN3","N3_VRDBAL")
	Else
		aVRDBAL := {0,0,0,0,0}
		aVRDBAL[1] := SN3->N3_VRDBAL1
		aVRDBAL[2] := SN3->N3_VRDBAL2
		aVRDBAL[3] := SN3->N3_VRDBAL3
		aVRDBAL[4] := SN3->N3_VRDBAL4
		aVRDBAL[5] := SN3->N3_VRDBAL5
	EndIf
	
	nVRCMES1 := SN3->N3_VRCMES1
	nVRCBAL1 := SN3->N3_VRCBAL1
	nVRCDM1  := SN3->N3_VRCDM1
	nVRCDB1  := SN3->N3_VRCDB1
	nVRCDA1  := SN3->N3_VRCDA1
Else
	aVRDACM	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	aVRDBAL	:= If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
	
	nVRCMES1 := 0
	nVRCBAL1 := 0
	nVRCDM1  := 0
	nVRCDB1  := 0
	nVRCDA1  := 0
EndIf

If bComple <> Nil
	Eval(bComple)
Endif

MsUnlock()

nRemanesc := SN3->(RECNO())

//AVP
//Se for um tipo AVP
If lAvpAtf .and. SN3->N3_TIPO == '14'
	aRecCtb := AF030AVP(.F.,dBaixa030,nPercAux,cIdMov)
Endif	

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Grava Registro de Baixa em separado qdo esta parcial 					Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Reclock("SN3",.T.)
For i:=1 To FCount()
	cNomCmp := aSN3Cmp[i][1]
	Replace &cNomCmp With aSN3Cmp[i][2]
Next
SN3->N3_BAIXA	:= cTpBaixa
SN3->N3_IDBAIXA := "1"
SN3->N3_DTBAIXA	:= dBaixa

If !lCalcChi .and. SN3->(FieldPos("N3_USACRED"))> 0
	SN3->N3_USACRED:=" "
EndIf
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Grava valores de Deprecia┤└o e Corre┤└o										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
nRecBx := SN3->(RECNO())
// *******************************
// Controle de multiplas moedas  *
// *******************************
If lMultMoed
	aVRDMES	:= AtfMultMoe("SN3","N3_VRDMES")
Else
	aVRDMES := {0,0,0,0,0}
	aVRDMES[1] := SN3->N3_VRDMES1
	aVRDMES[2] := SN3->N3_VRDMES2
	aVRDMES[3] := SN3->N3_VRDMES3
	aVRDMES[4] := SN3->N3_VRDMES4
	aVRDMES[5] := SN3->N3_VRDMES5
EndIf

For nSuf := 1 To __nQuantas
	If nSuf>9
		cSuf := Alltrim(Str(nSuf))
		&('SN3->N3_VORIG'+cSuf)	 -= aVORIG[nSuf]
		&('SN3->N3_VRDME'+cSuf) := Iif(!lCalcChi,Round( aValDepr[nSuf], X3Decimal("N3_VRDME"+cSuf) ),0)
		&('SN3->N3_VRDAC'+cSuf) := Iif(!lCalcChi,&('SN3->N3_VRDAC'+cSuf)-aVRDACM[nSuf]+Round(	aValDepr[nSuf], X3Decimal("N3_VORIG"+cSuf)),0)
		&('SN3->N3_VRDBA'+cSuf) := Iif(!lCalcChi,&('SN3->N3_VRDBA'+cSuf)-aVRDBAL[nSuf]+Round(	aValDepr[nSuf], X3Decimal("N3_VORIG"+cSuf)),0)
		&('SN3->N3_AMPLI'+cSuf) -= aAmplia[nSuf]
		// Proporcionalizar o valor da ampliacao no caso de baixa parcial BOPS 9613
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Caso a deprec acum for > que o valor original tiro a diferen-Ё
		//Ё ┤a do valor da deprec do mes para as moedas diferentes de 1  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nSuf != 1 .and. !lCalcChi
			
			If &('SN3->N3_VRDAC'+cSuf) > &('SN3->N3_VORIG'+cSuf)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё RESIDUO TIPO 01 EM OUTRAS MOEDAS                             Ё
				//Ё Caso a deprec acum for > que o valor original tiro a diferen-Ё
				//Ё ┤a do valor da deprec do mes.                                Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				nDifDep := &('SN3->N3_VRDAC'+cSuf) - &('SN3->N3_VORIG'+cSuf)
				&('SN3->N3_VRDAC'+cSuf) -= aValDepr[nSuf]
				&('SN3->N3_VRDME'+cSuf) -= aValDepr[nSuf]
				&('SN3->N3_VRDBA'+cSuf) -= aValDepr[nSuf]
				aValDepr[nSuf]            -= aValDepr[nSuf]
				aValDepr[nSuf] :=  &('SN3->N3_VORIG'+cSuf) - &('SN3->N3_VRDAC'+cSuf)
				&('SN3->N3_VRDAC'+cSuf) += aValDepr[nSuf]
				&('SN3->N3_VRDBA'+cSuf) += aValDepr[nSuf]
				&('SN3->N3_VRDME'+cSuf) := aValDepr[nSuf]
			Else
				If aDepr[nSuf] != 0
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё RESIDUO TIPO 02 EM OUTRAS MOEDAS                          Ё
					//ЁSe a Dep Acum < Vlr Orig, mas nDepr1 != 0 ┌ res║duo de deprЁ
					//Ёe Depr Acum dever ser IGUAL ao Vl Orig Corrigido           Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					nDifDep := &('SN3->N3_VORIG'+cSuf) - &('SN3->N3_VRDAC'+cSuf)
					&('SN3->N3_VRDAC'+cSuf) += nDifDep
					&('SN3->N3_VRDME'+cSuf) += nDifDep
					&('SN3->N3_VRDBA'+cSuf) += nDifDep
					aValDepr[nSuf]            += Iif(!lCalcChi, nDifDep,0)
				Endif
			Endif
			nDifDep := 0
		Endif
	Else
		cSuf := Alltrim(Str(nSuf))
		&('SN3->N3_VORIG'+cSuf)	 -= aVORIG[nSuf]
		&('SN3->N3_VRDMES'+cSuf) := Iif(!lCalcChi,Round( aValDepr[nSuf], X3Decimal("N3_VRDMES"+cSuf) ),0)
		&('SN3->N3_VRDACM'+cSuf) := Iif(!lCalcChi,&('SN3->N3_VRDACM'+cSuf)-aVRDACM[nSuf]+Round(	aValDepr[nSuf], X3Decimal("N3_VORIG"+cSuf)),0)
		&('SN3->N3_VRDBAL'+cSuf) := Iif(!lCalcChi,&('SN3->N3_VRDBAL'+cSuf)-aVRDBAL[nSuf]+Round(	aValDepr[nSuf], X3Decimal("N3_VORIG"+cSuf)),0)
		&('SN3->N3_AMPLIA'+cSuf) -= aAmplia[nSuf]
		// Proporcionalizar o valor da ampliacao no caso de baixa parcial BOPS 9613
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Caso a deprec acum for > que o valor original tiro a diferen-Ё
		//Ё ┤a do valor da deprec do mes para as moedas diferentes de 1  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If nSuf != 1 .and. !lCalcChi
			
			If &('SN3->N3_VRDACM'+cSuf) > &('SN3->N3_VORIG'+cSuf)
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё RESIDUO TIPO 01 EM OUTRAS MOEDAS                             Ё
				//Ё Caso a deprec acum for > que o valor original tiro a diferen-Ё
				//Ё ┤a do valor da deprec do mes.                                Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				nDifDep := &('SN3->N3_VRDACM'+cSuf) - &('SN3->N3_VORIG'+cSuf)
				&('SN3->N3_VRDACM'+cSuf) -= aValDepr[nSuf]
				&('SN3->N3_VRDMES'+cSuf) -= aValDepr[nSuf]
				&('SN3->N3_VRDBAL'+cSuf) -= aValDepr[nSuf]
				aValDepr[nSuf]            -= aValDepr[nSuf]
				aValDepr[nSuf] :=  &('SN3->N3_VORIG'+cSuf) - &('SN3->N3_VRDACM'+cSuf)
				&('SN3->N3_VRDACM'+cSuf) += aValDepr[nSuf]
				&('SN3->N3_VRDBAL'+cSuf) += aValDepr[nSuf]
				&('SN3->N3_VRDMES'+cSuf) := aValDepr[nSuf]
			Else
				If aDepr[nSuf] != 0
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё RESIDUO TIPO 02 EM OUTRAS MOEDAS                          Ё
					//ЁSe a Dep Acum < Vlr Orig, mas nDepr1 != 0 ┌ res║duo de deprЁ
					//Ёe Depr Acum dever ser IGUAL ao Vl Orig Corrigido           Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					nDifDep := &('SN3->N3_VORIG'+cSuf) - &('SN3->N3_VRDACM'+cSuf)
					&('SN3->N3_VRDACM'+cSuf) += nDifDep
					&('SN3->N3_VRDMES'+cSuf) += nDifDep
					&('SN3->N3_VRDBAL'+cSuf) += nDifDep
					aValDepr[nSuf]            += Iif(!lCalcChi, nDifDep,0)
				Endif
			Endif
			nDifDep := 0
		Endif
	EndIf
Next

SN3->N3_VRCACM1 := SN3->N3_VRCACM1 - nVRCACM1 + Round( nValCorr  				, X3Decimal("N3_VRCACM1"))
SN3->N3_VRCMES1 :=Iif(!lCalcChi,Round( nValCorr							 	, X3Decimal("N3_VRCMES1")),0)
SN3->N3_VRCBAL1 :=Iif(!lCalcChi, SN3->N3_VRCBAL1 - nVRCBAL1 + Round( nValCorr	, X3Decimal("N3_VRCBAL1")),0)
SN3->N3_VRCDM1  :=Iif(!lCalcChi,Round( nValCorDep								, X3Decimal("N3_VRCDM1" )),0)
SN3->N3_VRCDB1  :=Iif(!lCalcChi, SN3->N3_VRCDB1  - nVRCDB1 + Round( nValCorDep	, X3Decimal("N3_VRCDB1" )),0)
SN3->N3_VRCDA1  :=Iif(!lCalcChi, SN3->N3_VRCDA1  - nVRCDA1 + Round( nValCorDep	, X3Decimal("N3_VRCDA1" )),0)
SN3->N3_SEQ 	:= cSeq
SN3->N3_SEQREAV := cSeqReav

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Caso a deprec acum for > que o valor original tiro a diferen-Ё
//Ё ┤a do valor da deprec do mes para a moeda 1.                 Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If (SN3->N3_VRDACM1+SN3->N3_VRCDA1) > (SN3->N3_VORIG1+SN3->N3_VRCACM1)
	nDifDep := (SN3->N3_VRDACM1+SN3->N3_VRCDA1) - (SN3->N3_VORIG1+SN3->N3_VRCACM1)
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё TRATAMENTO DE RESIDUOS NA BAIXA PARCIAL NA MOEDA 1.          Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lCalcChi
		SN3->N3_VRDACM1 -= aValDepr[1]
		SN3->N3_VRDMES1 -= aValDepr[1]
		SN3->N3_VRDBAL1 -= aValDepr[1]
		aValDepr[1]       -= aValDepr[1]
		aValDepr[1] := (SN3->N3_VORIG1+SN3->N3_VRCACM1) - (SN3->N3_VRDACM1+SN3->N3_VRCDA1)
		SN3->N3_VRDACM1 += aValDepr[1]
	Else
		SN3->N3_VRDACM1 := 0
		SN3->N3_VRDMES1 := 0
		SN3->N3_VRDBAL1 := 0
		aValDepr[1]       := 0
		aValDepr[1] := 0
		SN3->N3_VRDACM1 := 0
	EndIf
	If aValDepr[1] < 0
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё RESжDUO TIPO 01 NA MOEDA 1 ACUM MAIOR QUE VALOR ORIG           Ё
		//Ё Caso o nValDepr1 seja negativo (o acumulado e maior que o ori- Ё
		//Ё ginal) tiro o valor de depreciacao a mais (nValdepr1) do regis-Ё
		//Ё tro de baixa e somo essa quantidade no registro remanescente.  Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		SN3->N3_VRDMES1 := 0
		dbGoto(nRemanesc)
		Reclock("SN3",.F.)
		SN3->N3_VRDACM1 += (aValDepr[1])*(-1)
		SN3->N3_VRDMES1 += (aValDepr[1])*(-1)
		MsUnlock()
		aValDepr[1] := 0
	Else
		SN3->N3_VRDBAL1 += aValDepr[1]
		SN3->N3_VRDMES1 := aValDepr[1]
	Endif
	dbGoto(nRecBx)
Else
	If aDepr[1] != 0
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё RESIDUO TIPO 02 EM MOEDA 1                                Ё
		//ЁSe a Dep Acum < Vlr Orig, mas nDepr1 != 0 ┌ res║duo de deprЁ
		//Ёe Depr Acum dever ser IGUAL ao Vl Orig Corrigido           Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		nDifDep := (SN3->N3_VORIG1+SN3->N3_VRCACM1) - (SN3->N3_VRDACM1+SN3->N3_VRCDA1)
		SN3->N3_VRDACM1 += nDifDep
		SN3->N3_VRDMES1 += nDifDep
		SN3->N3_VRDBAL1 += nDifDep
		aValDepr[1]       += nDifDep
	Endif
Endif

If bComple <> Nil
	Eval(bComple)
Endif

MsUnlock()

//Acrescentado por Fernando Radu Muscalu em 11/05/2011
//Inclusao do rateio para a nova sequencia do item da ficha de ativo
//de acordo com o rateio da sequencia anterior, pois trata-se de uma baixa parcial da ficha do ativo
If AFXVerRat()
	If len(aRateio) > 0
		Begin Transaction
		If AF011Grv(3,aRateio)
			Reclock("SN3",.F.)
			SN3->N3_RATEIO := "1"
			SN3->N3_CODRAT := aRateio[1,1]
			SN3->(MsUnlock())
		Endif
		End Transaction
	EndIf
Endif
Return .T.


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAtf030Fil Ё Autor Ё Claudio Donizete      Ё Data Ё22/09/06  Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o ЁDefine Topo da MsSelect()   								  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function Atf030Fil(nTipo)
Local cChave

// nTipo = 1 -> Verificando o topo da MsSelect
// nTipo = 2 -> Verificando o fim da Msselect
If nTipo==1
	//	cChave := cFilialI+cBasei+cItemi
	cChave := cFilIni+cBasei+cItemi
	
ElseIf nTipo==2
	//	cChave := cFilialF+cBasef+cItemf
	cChave := cFilFim+cBasef+cItemf
EndIf
	
Return cChave

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁPrograma  ЁMenuDef   Ё Autor Ё Ana Paula N. Silva     Ё Data Ё08/12/06 Ё╠╠
?╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Utilizacao de menu Funcional                               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁArray com opcoes da rotina.                                 Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁParametros do array a Rotina:                               Ё╠╠
╠╠Ё          Ё1. Nome a aparecer no cabecalho                             Ё╠╠
╠╠Ё          Ё2. Nome da Rotina associada                                 Ё╠╠
╠╠Ё          Ё3. Reservado                                                Ё╠╠
╠╠Ё          Ё4. Tipo de Transa┤└o a ser efetuada:                        Ё╠╠
╠╠Ё          Ё		1 - Pesquisa e Posiciona em um Banco de Dados     Ё╠╠
╠╠Ё          Ё    2 - Simplesmente Mostra os Campos                       Ё╠╠
╠╠Ё          Ё    3 - Inclui registros no Bancos de Dados                 Ё╠╠
╠╠Ё          Ё    4 - Altera o registro corrente                          Ё╠╠
╠╠Ё          Ё    5 - Remove o registro corrente do Banco de Dados        Ё╠╠
╠╠Ё          Ё5. Nivel de acesso                                          Ё╠╠
╠╠Ё          Ё6. Habilita Menu Funcional                                  Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Static Function MenuDef()
Local aRotina := { 	{ STR0001, "AF030Pesq"  , 0 , 1 , ,.F.},;  //"Pesquisar"
{ STR0002, "ATFVISUAL"  , 0 , 2},;  //"Visualizar"
{ STR0003, "AF030Baixa" , 0 , 4},;  //"Baixar"
{ STR0004, "AF030Cance" , 0 , 5},;  //"Cancelar"
{ STR0054, 'AF030Auto("SN3",SN3->(Recno()),6,.F.)'  , 0 , 6}}//,;  // "Baixa Autom."
//						{ STR0062, "AtfLegenda", 0 , 2 , ,.F. } }		// "Legenda"
Return(aRotina)


Static Function TudOkA(cMotivo,cNota,cSerie,lCancela)
Local nOPt:=1
If ExistBlock("AT030BX")
	If !ExecBlock("AT030BX",.F.,.F.,{cMotivo,cNota,cSerie,lCancela})
		nOPt:=0
	Else
		nOPt:=1
	EndIf
EndIf
Return(nOPt)
/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030VLAUTOЁ Autor Ё ARNALDO RAYMUNDO JR.  Ё Data Ё 20/08/08 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё VALIDACAO DOS ITENS SELECIONADOS PARA BAIXA AUTOMATICA	   Ё╠╠
╠╠цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
STATIC FUNCTION AF030VLAUTO()

LOCAL lRet := .T.
Local lAF030VLBX	:=  ExistBlock("AF030VLBX")

//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Avalia retorno do ponto de entrada AF030VLBX        Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
IF lAF030VLBX
	lRet := ExecBlock("AF030VLBX",.F.,.F.,{"ATFA030","AUTO"})
	IF ValType(lRet) != "L"
		lRet := .T.
	ENDIF
ENDIF

RETURN lRet

/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030VLDMOTЁ Autor Ё FELIPE C. SEOLIN      Ё Data Ё 30/11/10 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё VALIDACAO DO MOTIVO DE BAIXA INFORMADO                 	   Ё╠╠
╠╠цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Static Function AF030VLDMOT(aValidMot,cMotivo)
Local lRet		:= .T.
Local cValidMot	:= ArrToStr(aValidMot,",")	// Converter array para string

If !Empty(aValidMot) .and. aScan(aValidMot,{|x| x == SubStr(cMotivo,1,2)}) == 0
	lRet := .F.
	Help(" ",1,"ATFNOMOTVLD",,STR0069 + CRLF + STR0070 + cValidMot,1,0) //"Motivo da baixa nЦo И vАlido."###"Utilizar um dos motivos vАlidos:"
EndIf
Return lRet

/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё ARRTOSTR  Ё Autor Ё FELIPE C. SEOLIN      Ё Data Ё 01/12/10 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё CONVERTE ARRAY PARA STRING			                 	   Ё╠╠
╠╠цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Static Function ARRTOSTR(aValidMot,cSepara)
Local cStr := ""
Local nInd := 0

For nInd := 1 to Len(aValidMot)
	cStr += aValidMot[nInd] + cSepara
Next

cStr := SubStr(cStr,1,Len(cStr) - 1)
Return cStr


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁA030VlNota╨Autor  ЁMicrosiga           ╨ Data Ё  07/26/11   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Valida se a nota fiscal de saida foi estornada/excluida    ╨╠╠
╠╠╨          Ё para permitir cancelar a baixa                             ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function A030VlNota(cNota,cSerie)
Local lRet := .T.
Local aArea := GetArea()
Local aAreaSF2 := SF2->(GetArea())    
Local lVldNF	:= SuperGetMv("MV_ATFVLNF",.F.,.T.) // Parametro que habilita/desabilita a validacao da nota fiscal na SF2

If lVldNF
	SF2->(dbSetOrder(1)) //F2_FILIAL+F2_DOC+F2_SERIE+F2_CLIENTE+F2_LOJA+F2_FORMUL+F2_TIPO
	If SF2->(dbSeek( xFilial("SF2") + cNota + cSerie ))
		lRet:= .F.	
	EndIf
Endif

RestArea(aAreaSF2)
RestArea(aArea)
Return lRet


/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030LoadRatЁ Autor Ё FERNANDO RADU MUSCALUЁ Data Ё 20/08/08 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Function Af030LoadRat(cCodRat,cRevAtu)

Local aHeader	:= {}
Local aCols		:= {}
Local aAreaSNV	:= {}
Local aNewRat	:= {}
Local aRateio	:= {}

Local nI		:= 0

Local cBusca	:= ""

If AFXVerRat()
	
	aHeader		:= AF011HeadSNV()
	aAreaSNV	:= SNV->(GetArea())
	aNewRat		:= AF011COD()
	
	SNV->(DbSetOrder(1))
	
	cBusca := xFilial("SNV") +;
	PadR(cCodRat,TamSx3("NV_CODRAT")[1])+;
	PadR(cRevAtu,TamSx3("NV_REVISAO")[1])
	
	If SNV->(DbSeek(cBusca))
		
		While SNV->(!Eof()) .and. cBusca == SNV->NV_FILIAL +;
			PadR(SNV->NV_CODRAT,TamSx3("NV_CODRAT")[1])+;
			PadR(SNV->NV_REVISAO,TamSx3("NV_REVISAO")[1])
			
			aAdd(aCols,Array(Len(aHeader)+1))
			
			For nI := 1 to len(aHeader)
				aCols[len(aCols),nI] := CriaVar(aHeader[nI,2])
				aCols[len(aCols),nI] := SNV->&(aHeader[nI,2])
			Next nI
			
			aCols[len(aCols),len(aHeader)+1] := .F.
			
			SNV->(DbSkip())
		EndDo
	EndIf
	
	RestArea(aAreaSNV)
	
	aAdd(aRateio, {aNewRat[1],aNewRat[2],"3",1,aCols,.F.})
	
	If aNewRat[3]
		SNV->(ConfirmSX8())
	Endif
	
Endif
Return(aRateio)

/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAf030RetFilЁ Autor Ё TOTVS			     Ё Data Ё 28/12/11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Static Function Af030RetFil(nOpc)
Local lRet			:= .T.
Local cFil			:= ""
Local nTamFil := TamSx3("N1_FILIAL")[1]

If nOpc == 1
	cFil := cFilialI
Else
	If cFilialF < cFilialI
		lRet := .F.
	Else
		cFil := cFilialF
	Endif
Endif

If lRet	

	cFil := Substr(cFil,1,nTamFil)
	
	If nOpc == 1
		cFilIni := xFilial("SN1",cFil) 
	Else
		cFilFim := xFilial("SN1",cFil) 
	Endif
Endif



Return lRet


/*
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAjustFil   Ё Autor Ё TOTVS			     Ё Data Ё 23/03/12 Ё╠╠
╠╠цддддддддддедддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠Ё Uso		 Ё ATFA030 												  	   Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Static Function AjustFil(cFil)
Local cFilAux		:= ""
Local aModoCompSN1	:= {}
Local cLayoutEmp    := FWSM0Layout()
Local nPosEmpresa	:= At("E",cLayoutEmp)
Local nPosUnidade 	:= At("U",cLayoutEmp)
Local nPosFilial 	:= At("F",cLayoutEmp)
Local nTamFilial 	:= Len(Alltrim(cLayoutEmp))
Local lGestao		:= ( "E" $ FWSM0Layout() .And. "U" $ FWSM0Layout() )	// Indica se usa Gestao Corporativa
Local cEmp			:= ""
Local cUnid			:= ""
Local nX	        := 0
Local aSM0	    	:= AdmAbreSM0()

If lGestao
	cEmp  	:=  Subs(cFil,nPosEmpresa, nPosUnidade-nPosEmpresa)  
	cUnid 	:=  Subs(cFil,nPosUnidade, nPosFilial-nPosUnidade)  
	cFilAux	:=	Subs(cFil,nPosFilial, nTamFilial)  
		
	aAdd(aModoCompSN1, FWModeAccess("SN1",1) )
	aAdd(aModoCompSN1, FWModeAccess("SN1",2) )
	aAdd(aModoCompSN1, FWModeAccess("SN1",3) )
		
  	If aModoCompSN1[1] == 'E'     
		For nX := 1 to Len(aSM0) 
			If aSM0[nX][3] == cEmp
				cFilAnt := aSM0[nX][2]
				Exit
			Endif	
		Next
	EndIf
		
	If aModoCompSN1[2] == 'E'     
		For nX := 1 to Len(aSM0) 
			If aSM0[nX][3] == cEmp .And. aSM0[nX][4] == cUnid
				cFilAnt := aSM0[nX][2]
				Exit
			Endif	
		Next
	EndIf

	If aModoCompSN1[3] == 'E'     
		For nX := 1 to Len(aSM0) 
			If aSM0[nX][3] == cEmp .And. aSM0[nX][4] == cUnid .And. aSM0[nX][5] == cFilAux
				cFilAnt := aSM0[nX][2]
				Exit
			Endif	
		Next
	EndIf     
Else
	cFilAnt := cFil
Endif

Return

/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 Ё AF030AVP  Ё Autor Ё Mauricio Pequim Jr	  Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Processa a apuracao do AVP para a filial atual				  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ lTotal = Indica se a baixa eh total ou parcial             Ё╠╠
╠╠Ё          Ё dBaixa = Data da baixa                                     Ё╠╠
╠╠Ё          Ё nPerc  = Percentual baixado (baixa parcial)                Ё╠╠
╠╠Ё          Ё cIdMov = Id do movimento do bem (SN4->N4_IDMOV)            Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA450																	  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Function AF030AVP(lTotal,dBaixa,nPerc,cIdMov)

Local nValAvp		:= 0
Local nValVp		:= 0
Local aAreaAvp		:= GetArea()
Local nRecConst	:= 0 
Local cIdProcAvp	:= ""

DEFAULT lTotal := .F.
DEFAULT dBaixa := dDataBase
DEFAULT nPerc	:= 0
DEFAULT cIdMov	:= ""

//Posiciono tabela FNF no registro de constituicao ativo
dbSelectArea("FNF")
FNF->(dbSetOrder(4)) //FNF_FILIAL+FNF_CBASE+FNF_ITEM+FNF_TPMOV+FNF_STATUS
If MsSeek(xFilial("FNF")+SN3->(N3_CBASE+N3_ITEM)+"1"+"1")

	//Identificador de processo atual
	cIdProcAVP	:= GetSxeNum('FNF','FNF_IDPROC','FNF_IDPROC'+cEmpAnt,3)

	//Guardo registro da constituicao do AVP atual
	nRecConst := FNF->(RECNO())
	
	//Posiciono na Ficha do ativo
	SN1->(dbSetOrder(1))
	SN1->(MsSeek(xFilial("SN1")+FNF->(FNF_CBASE+FNF_ITEM)))		

	//Apuro o AVP ate a data da baixa
	AFCalcAVP("A",FNF->FNF_TAXA,FNF->FNF_INDAVP,,FNF->FNF_PERIND,dBaixa,@nValVP,@nValAVP,SN1->N1_DTAVP)		

	//Gravo a apropriacao do AVP por baixa
	AfGrvAvp(cFilAnt,"3",dDataBase,FNF->FNF_CBASE,FNF->FNF_ITEM,FNF->FNF_TIPO,FNF->FNF_TPSALDO,' ',FNF->FNF_SEQ,,nValAvp,.F.,,,,,cIdProcAVP,aRecCTB,,cIdMov)

	//Se baixa total, realizo o AVP
	If lTotal

		//Posiciono no registro de constituicao atual
		FNF->(dbGoto(nRecConst))
		
		nValAVP := FNF->FNF_BASE - ( FNF->(FNF_AVPVLP + FNF_ACMAVP) )

		//Gravo a realizacao do AVP por baixa - TOTAL
		AfGrvAvp(cFilAnt,"4",dDataBase,FNF->FNF_CBASE,FNF->FNF_ITEM,FNF->FNF_TIPO,FNF->FNF_TPSALDO,' ',FNF->FNF_SEQ,,nValAvp,.F.,,,,,cIdProcAVP,aRecCTB,.T.,cIdMov)

	Else

		//Posiciono no registro de constituicao atual
		FNF->(dbGoto(nRecConst))
		
		nValAVP := ( FNF->(FNF_VALOR - FNF_ACMAVP) ) * nPerc

		//Gravo a realizacao do AVP por baixa - PARCIAL
		//Gravo a baixa do AVP - Parcial ((AVP Constituido - AVP Acumulado) * Percentual de baixa
		AfGrvAvp(cFilAnt,"4",dDataBase,FNF->FNF_CBASE,FNF->FNF_ITEM,FNF->FNF_TIPO,FNF->FNF_TPSALDO,' ',FNF->FNF_SEQ,,nValAvp,.F.,,,,,cIdProcAVP,aRecCTB,.F. /*lBxTotal*/,cIdMov)

		//Posiciono no registro de constituicao atual
		FNF->(dbGoto(nRecConst))

		//Gravo constituicao do saldo restante do AVP
		AfGrvAvp(cFilAnt,"1",dDataBase,FNF->FNF_CBASE,FNF->FNF_ITEM,FNF->FNF_TIPO,FNF->FNF_TPSALDO,' ',FNF->FNF_SEQ,,nValAvp,.F.,,,,,cIdProcAVP,aRecCTB,.F. /*lBxTotal*/,cIdMov)
	Endif	

	// Confirma o cIdProcAVP
	ConfirmSX8()

Endif

RestArea(aAreaAVP)

Return aRecCTB


/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁFa030Mark14Ё Autor Ё Mauricio Pequim Jr	  Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua marcacao do Tipo 14 quando Tipo 10 for marcado      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ lTodos   = Marca todos os registros								  Ё╠╠
╠╠Ё          Ё nQtdBens = Quantidade de bens marcados (controle de tela)  Ё╠╠
╠╠Ё          Ё cMarca	= Controle de marcacao de registros			        Ё╠╠
╠╠Ё          Ё lF030Fil	= Informa existencia do ponto de entrada "F030FIL"Ё╠╠
╠╠Ё          Ё lMarca	= Define se marca ou desmarca o Tipo 14 			  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA450																	  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/

Function Fa030Mark14(lTodos,nQtdBens,cMarca,lF030Fil,lMarca)

Local aArea		:= GetArea()
Local aSN3Area	:= SN3->(GetArea())
Local nRecAtual	:= SN3->(Recno())
Local cSN3Fil		:= xFilial("SN3")
Local cSN3Seq		:= ""
Local cTypes10		:= IIF(lIsRussia,"*" + AtfNValMod({1}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models

DEFAULT lTodos	:= .F.
DEFAULT nQtdBens	:= 0
DEFAULT lMarca	:= .T.
DEFAULT lF030Fil	:= .F.

If SN3->N3_BAIXA == '0'
	cSN3Seq := AFULTSEQ(cSN3Fil,SN3->N3_CBASE,SN3->N3_ITEM,'14',SN3->N3_TPSALDO,.F.,0)
Else
	cSN3Seq := AFULTSEQ(cSN3Fil,SN3->N3_CBASE,SN3->N3_ITEM,'14',SN3->N3_TPSALDO,.F.,1)
EndIf

//AVP
//Ao selecionar o Tipo 10, ja sera marcado o Tipo 14
If !lTodos .and. lAvpAtf .and. SN3->N3_TIPO $ ('10' + cTypes10)
	SN3->(dbSetOrder(11)) //N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO+N3_BAIXA+N3_TPSALDO+N3_SEQ+N3_SEQREAV
	If	SN3->(MsSeek( cSN3Fil+SN3->N3_CBASE+SN3->N3_ITEM+'14'+SN3->N3_BAIXA + SN3->N3_TPSALDO + cSN3Seq ) ) ;
		.AND. 	(!lF030Fil 	.Or. &(ExecBlock("F030FIL",.f.,.f.)))
		RecLock("SN3")
		IF lMarca
	 		SN3->N3_OK := cMarca 
	 		nQtdBens++
		Else
	 		SN3->N3_OK := ""
	 		nQtdBens--
	 		nQtdBens:= Iif (nQtdBens <=0,0,nQtdBens)
		Endif
		MsUnlock()
	Endif
Endif			

RestArea(aSN3Area)
RestArea(aArea)
SN3->(dbGoto(nRecAtual))

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁAF030AtProj╨Autor  ЁAlvaro Camillo Neto╨ Data Ё  14/11/11   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁAtualiza as informaГУes do projeto de imobilizado           ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function AF030AtProj(cBase,cItem,cTipo,cTipoSld,aValDepr)

Local aArea 	:= GetArea()
Local aAreaSN1 := SN1->(GetArea()) 
Local nMoeda	:= 0

If __lStruPrj == Nil
	__lStruPrj := .T.
EndIf

If __lStruPrj
	SN1->(DBSetOrder(1)) //N1_FILIAL+N1_CBASE+N1_ITEM
	FNE->(DBSetOrder(2)) //FNE_FILIAL+FNE_CODPRJ+FNE_REVIS+FNE_ETAPA+FNE_ITEM+FNE_TPATF+FNE_TPSALD
	If SN1->(MsSeek( xFilial("SN1") + cBase + cItem))   
		// Acumula tambИm o tipo 14 que complementa o tipo 10
		cTipo := IIF( cTipo == '14','10', cTipo )
		
		If FNE->(MsSeek( xFilial("FND") + SN1->(N1_PROJETO + N1_PROJREV + N1_PROJETP + N1_PROJITE) + cTipo + cTipoSld ))
			nMoeda := Val(FNE->FNE_MOEDRF)
			RecLock("FNE",.F.)
				FNE->FNE_VRDACM += aValDepr[nMoeda]
			MsUnLock() 
		EndIf	
	EndIf
EndIf

RestArea(aAreaSN1)
RestArea(aArea)
Return

//--------------------------------------------------------------------------------------
//AVP2
//--------------------------------------------------------------------------------------

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAF030BxPr  Ё Autor Ё Mauricio Pequim Jr   Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua baixa dos bens de provisao gerados por apuracao de  Ё╠╠
╠╠Ё          Ё  provisao de bens orcamento 								  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ aIdMovSN4 = Array com informacoes para baixa				  Ё╠╠
╠╠Ё          Ё    aIdMovSN4[nX][1] = recno do SN1                         Ё╠╠
╠╠Ё          Ё    aIdMovSN4[nX][2] = Id do movimento do SN4   		      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA030/ATFA035  										  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AF030BxPr(aIdMovSN4,lAtfa030)

Local nX := 1
Local aAreaSN1 := SN1->(GetArea())
Local aAreaSN4 := SN4->(GetArea())

DEFAULT lAtfa030  := .T.
DEFAULT aidMovSN4 := {}

BEGIN TRANSACTION

lBxProvis := .T.

For nX := 1 to Len(aIdMovSN4)

	//Posiciono o SN1 
	SN1->(dbGoTo(aIdMovSN4[nX][1]))

	//Posiciono o SN4
	SN4->(dbSetOrder(6)) //N4_IDMOV+N4_OCORR
	SN4->(MsSeek(xFilial("SN4")+aIdMovSN4[nX][2]))
	
	If lAtfa030
		AF460Apur(.T.,SN1->N1_GRUPO,SN4->N4_IDMOV,dDatabase)	
		Pergunte("AFA030",.F.)		
	Endif

	//Baixo os filhos gerados pelas apuracoes
	AFBxProvis(SN1->N1_CBASE, SN1->N1_ITEM,SN4->N4_IDMOV,SN4->N4_MOTIVO) 

Next

lBxProvis := .F.

END TRANSACTION

RestArea(aAreaSN4)
RestArea(aAreaSN1)

Return



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAFBxProvis Ё Autor Ё Mauricio Pequim Jr   Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua baixa dos bens de provisao gerados por apuracao     Ё╠╠
╠╠Ё          Ё de provisao de bens orcamento 							  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ cBaseSup = Codigo base do bem de orcamento				  Ё╠╠
╠╠Ё          Ё cItemSup = Item do bem de orcamento                        Ё╠╠
╠╠Ё          Ё cIdMovSN4 = Id do movimento do SN4            		      Ё╠╠
╠╠Ё          Ё cMotBx  	= Motiva da baixa do bem                          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA030/ATFA035  										  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AFBxProvis(cBaseSup, cItemSup,cIdMovSN4,cMotBx) 

Local lRet 		:= .T.
Local cQuery 	:= ""
Local aArea		:= GetArea()
Local aAreaSN1	:= SN1->(GetArea())
Local aAreaSN3	:= SN3->(GetArea())
Local nX		:= 0
Local aRecnos	:= {}
Local aBaixa	:= {}
Local aParam030 := {}
Local aLog		:= {}
Local cNextAlias:= "TRBATF030"

//Controle de rotina automatica
Private lMsErroAuto := .F.
Private lAutoErrNoFile := .T.

DEFAULT cBaseSup := ""
DEFAULT cItemSup := ""
DEFAULT cIdMovSN4 := ""
DEFAULT cMotBx	  := ""

aAdd( aParam030, {"MV_PAR01", 2} )
aAdd( aParam030, {"MV_PAR02", 2} )


If Empty(cBaseSup) .or. Empty(cItemSup) .or. Empty(cIdMovSN4)
	lRet := .F.
Endif

If lRet

	//Selecao de bens constituidos para apuracao do AVP
	//- Bens com constituicao ativa e
	//- que nao possuam movimentos posteriores a data de processamento	
	cQuery := "SELECT SN1.R_E_C_N_O_ RECSN1, N1_FILIAL, N1_CBASE, N1_ITEM FROM "+RetSQLTab("SN1")
	cQuery += "WHERE "
	cQuery += " SN1.N1_FILIAL = '"+xFilial("SN1")+"' AND "
	cQuery += " SN1.N1_BASESUP = '"+cBaseSup+"' AND "
	cQuery += " SN1.N1_ITEMSUP = '"+cItemSup+"' AND "
	cQuery += " SN1.N1_PATRIM IN ('V') AND "
	cQuery += " SN1.N1_BAIXA = ' ' AND "
	cQuery += " SN1.D_E_L_E_T_ = ' ' "

	cQuery += " ORDER BY N1_FILIAL, N1_CBASE, N1_ITEM "

	cQuery := ChangeQuery(cQuery)  

	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cNextAlias,.T.,.T.)

	While !( (cNextAlias)->(Eof()) )

		aadd(aRecnos,(cNextAlias)->RECSN1)

		(cNextAlias)->(dbSkip())		

	Enddo

	//Fecho o temporario
	(cNextAlias)->(dbCloseArea())

	//Efetuo as baixas 
	For nX := 1 to Len(aRecnos)

		SN1->(DBGOTO(aRecnos[nX]))

		If SN3->(MsSeek( xFilial("SN3") + SN1->(N1_CBASE + N1_ITEM) )) 
			AADD( aBaixa, { "N3_CBASE"	 , SN1->N1_CBASE   , NIL } )
			AADD( aBaixa, { "N3_ITEM"	 , SN1->N1_ITEM	   , NIL } )
			AADD( aBaixa, { "N3_TIPO"	 , SN3->N3_TIPO	   , NIL } )
			AADD( aBaixa, { "AUTVLRVENDA", SN3->N3_VORIG1  , NIL } )			
			AADD( aBaixa, { "AUTQUANT"	 , SN1->N1_QUANTD  , NIL } )
			AADD( aBaixa, { "AUTMOTBX"	 , cMotBx		   , Nil } )
			AADD( aBaixa, { "AUTBXFILHOS", .T.			   , Nil } )

			//AVP2
			lBxProvis := .T.
			
			//ЁExecuta a Baixa do Bem Ё
			If IsInCallStack("ATFA030")
				MSExecAuto( { |x, y,w| Atfa030( x, y, w ) }, aBaixa, 4 , aParam030 )
			ElseIf IsInCallStack("ATFA035")
				MSExecAuto( { |x, y,w| Atfa035( x, y, w ) }, aBaixa, 4 , aParam030 )
			EndIf

			aBaixa := {}
			
			If lMsErroAuto
				cFileLog := NomeAutoLog()
				cPath := ""
				If !Empty(cFileLog)
					MostraErro(cPath,cFileLog)
				Endif
				lMsErroAuto := .F.
				DisarmTransaction()
				lRet := .F.
				Exit
			Endif
	    Endif
	Next		
Endif

RestArea(aAreaSN3)
RestArea(aAreaSN1)
RestArea(aArea)

//AVP2
lBxProvis := .F.

Return lRet


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAFCanProv  Ё Autor Ё Mauricio Pequim Jr   Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua cancelamento da baixa dos bens de provisao gerados  Ё╠╠
╠╠Ё          Ё por apuracao de provisao de bens orcamento 				  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ cBaseSup = Codigo base do bem de orcamento				  Ё╠╠
╠╠Ё          Ё cItemSup = Item do bem de orcamento                        Ё╠╠
╠╠Ё          Ё cMotBx  	= Motiva da baixa do bem                          Ё╠╠
╠╠Ё          Ё cIdMovSN4 = Id do movimento do SN4            		      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA030/ATFA035  										  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AFCanProv(cBaseSup, cItemSup,cMotBx, cIdMovSN4) 

Local aRecnoFNO := {}
                     
DEFAULT cBaseSup	:= ""
DEFAULT cItemSup	:= ""
DEFAULT cMotBx		:= ""
DEFAULT cidMovSN4	:= ""

//Cancelo a baixa dos filhos gerados pelas apuracoes
AFCanBxProv(cBaseSup, cItemSup,cMotBx) 
	
//Excluo o bem de provisao gerado pela baixa
dbSelectArea("FNO")
FNO->(dbSetOrder(2))
If msSeek(xFilial("FNO") + cIdMovSN4 + cBaseSup + cItemSup)
	aadd(aRecnoFNO,{FNO->(RECNO())})
	AF460EstPrv(aRecnoFNO,1,.T.)	
Endif

Return .T.


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁAFCanBxProvЁ Autor Ё Mauricio Pequim Jr   Ё Data Ё 24.10.11 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua cancelamento da baixa dos bens de provisao gerados  Ё╠╠
╠╠Ё          Ё por apuracao de provisao de bens orcamento 				  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ cBaseSup = Codigo base do bem de orcamento				  Ё╠╠
╠╠Ё          Ё cItemSup = Item do bem de orcamento                        Ё╠╠
╠╠Ё          Ё cIdMovSN4 = Id do movimento do SN4            		      Ё╠╠
╠╠Ё          Ё cMotBx  	= Motiva da baixa do bem                          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA030/ATFA035  										  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function AFCanBxProv(cBaseSup, cItemSup,cMotBx) 

Local lRet 		:= .T.
Local cQuery 	:= ""
Local cRotBaixa := AllTrim(GetNewPar("MV_ATFRTBX", "ATFA030"))
Local aArea		:= GetArea()
Local aAreaSN1	:= SN1->(GetArea())
Local aAreaSN3	:= SN3->(GetArea())
Local aAreaSN4	:= SN4->(GetArea())
Local nX		:= 0
Local aRecnos	:= {}
Local aBaixa	:= {}
Local aParam030 := {}
Local aLog		:= {}

//Controle de rotina automatica
Private lMsErroAuto := .F.
Private lMsHelpAuto := .T.
Private lAutoErrNoFile := .F.

DEFAULT cBaseSup := ""
DEFAULT cItemSup := ""
DEFAULT cMotBx	  := ""

aAdd( aParam030, {"MV_PAR01", 2} )
aAdd( aParam030, {"MV_PAR02", 2} )


If Empty(cBaseSup) .or. Empty(cItemSup)
	lRet := .F.
Endif

If lRet

	//Selecao de bens constituidos para apuracao do AVP
	//- Bens com constituicao ativa e
	//- que nao possuam movimentos posteriores a data de processamento	
	cQuery := "SELECT SN1.R_E_C_N_O_ RECSN1, N1_FILIAL, N1_CBASE, N1_ITEM FROM "+RetSQLTab("SN1")
	cQuery += "WHERE "
	cQuery += " SN1.N1_FILIAL = '"+xFilial("SN1")+"' AND "
	cQuery += " SN1.N1_BASESUP = '"+cBaseSup+"' AND "
	cQuery += " SN1.N1_ITEMSUP = '"+cItemSup+"' AND "
	cQuery += " SN1.N1_PATRIM IN ('V') AND "
	cQuery += " SN1.N1_BAIXA <> ' ' AND "
	cQuery += " SN1.D_E_L_E_T_ = ' ' "

	cQuery += " ORDER BY N1_FILIAL, N1_CBASE, N1_ITEM "

	cQuery := ChangeQuery(cQuery)  

	cNextAlias := GetNextAlias()
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cNextAlias,.T.,.T.)

	While !( (cNextAlias)->(Eof()) )

		aadd(aRecnos,(cNextAlias)->RECSN1)

		(cNextAlias)->(dbSkip())		

	Enddo

	//Fecho o temporario
	(cNextAlias)->(dbCloseArea())

	//Efetuo as baixas 
	For nX := 1 to Len(aRecnos)

		SN1->(DBGOTO(aRecnos[nX]))

		If SN3->(MsSeek( xFilial("SN3") + SN1->(N1_CBASE + N1_ITEM) )) 
			AADD( aBaixa, { "N3_CBASE"	 , SN1->N1_CBASE   , NIL } )
			AADD( aBaixa, { "N3_ITEM"	 , SN1->N1_ITEM	   , NIL } )
			AADD( aBaixa, { "N3_TIPO"	 , SN3->N3_TIPO	   , NIL } )
			AADD( aBaixa, { "AUTVLRVENDA", SN3->N3_VORIG1  , NIL } )			
			AADD( aBaixa, { "AUTQUANT"	 , SN1->N1_QUANTD  , NIL } )
			AADD( aBaixa, { "AUTMOTBX"	 , cMotBx		   , Nil } )
			AADD( aBaixa, { "AUTBXFILHOS", .T.			   , Nil } )

			//AVP2
			lBxProvis := .T.
			
			//ЁExecuta a Baixa do Bem Ё
			If cRotBaixa == "ATFA030"
				MSExecAuto( { |x, y,w| Atfa030( x, y, w ) }, aBaixa, 5 , aParam030 )
			Else
				MSExecAuto( { |x, y,w| Atfa035( x, y, w ) }, aBaixa, 5 , aParam030 )
			EndIf

			aBaixa := {}
			
			If lMsErroAuto
				cFileLog := NomeAutoLog()
				cPath := ""
				If !Empty(cFileLog)
					MostraErro(cPath,cFileLog)
				Endif
				lMsErroAuto := .F.
				DisarmTransaction()
				lRet := .F.
				Exit
			Endif
	    Endif
	Next		
Endif

RestArea(aAreaSN4)
RestArea(aAreaSN3)
RestArea(aAreaSN1)
RestArea(aArea)

//AVP2
lBxProvis := .F.

Return lRet

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё Af030Nota   Ё Autor Ё                      Ё Data Ё 13.06.12 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Exige a digitaГЦo do Numero da Nota caso o motivo da baixa   Ё╠╠
╠╠             23-DevoluГЦo e a Pergunta 'Valida Nota de DevoluГЦo' seja    Ё╠╠
╠╠             'Sim'                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё Af030Nota                                                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё ATFA030                                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030Nota(cNota, cMotivo )
Local aArea := GetArea()
Local lValidaNFD := SuperGetMV("MV_AF30NDV", .F., .F.)

If cPaisLoc == "BRA"
	If lValidaNFD 	// Sim -> Valida Nota de DevoluГЦo
		If cMotivo = '23' //DevoluГЦo de Item da Nota
			If Empty(cNota)
				Help(" ",1, "AF030NFDV",, STR0093,1,0)  //'O Nro/SИrie/Item da Nota devem ser informados se o parБmetro MV_AF30NDV for T e o motivo da baixa for 23-DevoluГЦo'
				Return(.F.)
			EndIf
		EndIf
	EndIf
EndIf
RestArea(aArea)
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё Af030Serie  Ё Autor Ё                      Ё Data Ё 13.06.12 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Exige a digitaГЦo da Serie da Nota caso o motivo da baixa    Ё╠╠
╠╠             23-DevoluГЦo e a Pergunta 'Valida Nota de DevoluГЦo' seja    Ё╠╠
╠╠             'Sim'                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё Af030Serie(cNota, cSerie, cMotivo )                          Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё ATFA030                                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030Serie(cNota, cSerie, cMotivo )
Local aArea := GetArea()
Local lValidaNFD := SuperGetMV("MV_AF30NDV", .F., .F.)
     
If cPaisLoc == "BRA"
	If lValidaNFD	// Sim -> Valida Nota de DevoluГЦo
		If cMotivo = '23' //DevoluГЦo de Item da Nota
			If !Empty(cNota) .and. Empty(cSerie)
				Help(" ",1, "AF030NFDV",,STR0093,1,0)  //'O Nro/SИrie/Item da Nota devem ser informados se o parБmetro MV_AF30NDV for T e o motivo da baixa for 23-DevoluГЦo'
				Return( .F.)
			EndIf
		EndIf
	EndIf
EndIf
RestArea(aArea)
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё Af030Item   Ё Autor Ё                      Ё Data Ё 13.06.12 Ё╠╠
╠╠цддддддддддеддддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Exige a digitaГЦo do Item  da Nota caso o motivo da baixa    Ё╠╠
╠╠             23-DevoluГЦo e a Pergunta 'Valida Nota de DevoluГЦo' seja    Ё╠╠
╠╠             'Sim'                                                        Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё Af030Serie(cNota, cSerie, cNFItem, cMotivo )                 Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё ATFA030                                                      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function Af030Item(cNota, cSerie, cNFItem, cMotivo )
Local aArea := GetArea()
Local lValidaNFD := SuperGetMV("MV_AF30NDV", .F., .F.)

If cPaisLoc == "BRA"
	If lValidaNFD	// Sim -> Valida Nota de DevoluГЦo
		If cMotivo = '23' //DevoluГЦo de Item da Nota
			If !Empty(cNota) .and. !Empty(cSerie) .and. Empty(cNFItem)
				Help(" ",1, "AF030NFDV",,STR0093,1,0)  //'O Nro/SИrie/Item da Nota devem ser informados se o parБmetro MV_AF30NDV for T e o motivo da baixa for 23-DevoluГЦo'
				Return( .F.)
			EndIf
		EndIf
	EndIf
EndIf
RestArea(aArea)
Return



/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбдддддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o	 ЁFa030Mk15  Ё Autor Ё Mauricio Pequim Jr	Ё Data Ё 11.09.12 Ё╠╠
╠╠цддддддддддедддддддддддадддддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Efetua marcacao do Tipo 15 quando Tipo 10 for marcado      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁ lTodos   = Marca todos os registros						  Ё╠╠
╠╠Ё          Ё nQtdBens = Quantidade de bens marcados (controle de tela)  Ё╠╠
╠╠Ё          Ё cMarca	= Controle de marcacao de registros			      Ё╠╠
╠╠Ё          Ё lF030Fil	= Informa existencia do ponto de entrada "F030FIL"Ё╠╠
╠╠Ё          Ё lMarca	= Define se marca ou desmarca o Tipo 15 		  Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁUso		 Ё ATFA030													  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
//MRG
Function Fa030Mk15(lTodos,nQtdBens,cMarca,lF030Fil,lMarca,lCancela)

Local aArea		:= GetArea()	
Local aAreaSN3	:= SN3->(GetArea())
Local nRecAtual := SN3->(Recno())
Local lMargem 	:= AFMrgAtf() //Verifica implementacao da Margem Gerencial
Local cBaixa	:= "0"
Local cTypes10		:= IIF(lIsRussia,"*" + AtfNValMod({1}, "*"),"") // CAZARINI - 14/03/2017 - If is Russia, add new valuations models - main models

DEFAULT lTodos		:= .F.
DEFAULT nQtdBens	:= 0
DEFAULT lMarca		:= .T.
DEFAULT lF030Fil	:= .F.
DEFAULT lCancela	:= .F.

If lCancela
	cBaixa := "1"
Endif

//Ao selecionar o Tipo 10, ja sera marcado o Tipo 15
If !lTodos .and. lMargem .and. SN3->N3_TIPO $ ('10#13' + cTypes10)
	SN3->(dbSetOrder(11)) //N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO+N3_BAIXA+N3_TPSALDO
	If	SN3->(MsSeek( xFilial("SN3")+SN3->(N3_CBASE+N3_ITEM)+'15'+cBaixa+SN3->N3_TPSALDO)) .AND. ;
			(!lF030Fil 	.Or. &(ExecBlock("F030FIL",.f.,.f.)))
		RecLock("SN3")
		IF lMarca
	 		SN3->N3_OK := cMarca 
	 		nQtdBens++
		Else
	 		SN3->N3_OK := ""
	 		nQtdBens--
	 		nQtdBens:= Iif (nQtdBens <=0,0,nQtdBens)
		Endif
		MsUnlock()
	Endif
Endif			

RestArea(aArea)
SN3->(RestArea(aAreaSN3))
SN3->(dbGoto(nRecAtual))

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁAF30HASAF ╨Autor  ЁAlexandre Circenis  ╨ Data Ё  27/01/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁVerifica se existem os dados da baixa na tabela SFA         ╨╠╠
╠╠╨          Ё.T. se nЦo houver dados e .F. se houver                     ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function AF30HASAF( cCodigo, dDBaixa, cTipo, cMotivo)
Local lRet := .F.
Local aArea := GetArea()          
Local aAreaSFA := SFA->(GetArea())          
Local cNextAlias := GetNextAlias()
Local cQuery
                                 
dbSelectArea("SFA")
cQuery := "Select R_E_C_N_O_ Regno
cQuery += " FROM "+RetSQLTab("SFA")
cQuery += " WHERE FA_FILIAL = '"+xFilial("SFA")+"'"
cQuery += " AND FA_CODIGO = '"+cCodigo+"'"
cQuery += " AND FA_DATA = '"+Dtos(dDBaixa)+"'"
cQuery += " AND FA_TIPO = '"+cTipo+"'"
cQuery += " AND FA_MOTIVO = '"+cMotivo+"'"
cQuery += " AND D_E_L_E_T_ = ' ' "
cQuery := ChangeQuery(cQuery)  

dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cNextAlias,.T.,.T.)  

lRet := !(cNextAlias)->(Eof())

(cNextAlias)->(dbCloseArea())

RestArea(aAreaSFA)
RestArea(aArea)

Return lRet          

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁAF030HASN3╨Autor  ЁAlexandre Circenis  ╨ Data Ё  01/27/14   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Verifca se existe um item do tipo 01 ainda nЦo baixado no  ╨╠╠
╠╠╨          Ё cadastro do ativo                                          ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/

Static Function AF030HASN3()
Local aArea     := GetArea()
Local aAreaSN3  := SN3->(GetArea())

SN3->(dbSetOrder(1))
// Busca o registro de tipo 01 que ainda nЦo foi baixado.
lRet := SN3->(dbSeek(xFilial("SN3")+SN1->(N1_CBASE+N1_ITEM)+"010"))

RestArea(aAreaSN3)
RestArea(aArea)
	
Return lRet
           

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁAF30NITEM ╨Autor  ЁAlexandre Circenis  ╨ Data Ё  27/01/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁRetora o numero de itens de saldo (SN3) que estao amarradas ╨╠╠
╠╠╨          Ёao ativo                                                    ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function AF30NITEM( cCBase, cItem)
Local nRet := 0
Local aArea := GetArea()          
Local aAreaSN3 := SN3->(GetArea())
Local cNextAlias := GetNextAlias()
Local cQuery

cQuery := "Select Count(N3_CBASE) nItem"
cQuery += " FROM "+RetSQLTab("SN3")
cQuery += " WHERE N3_FILIAL = '"+xFilial("SFA")+"'"
cQuery += " AND N3_CBASE = '"+cCbase+"'"
cQuery += " AND N3_ITEM = '"+cItem+"'"
cQuery += " AND D_E_L_E_T_ = ' ' "
cQuery := ChangeQuery(cQuery)  

dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cNextAlias,.T.,.T.)  

nRet := (cNextAlias)->nItem

(cNextAlias)->(dbCloseArea())
 
RestArea(aAreaSN3)
RestArea(aArea)

Return nRet 