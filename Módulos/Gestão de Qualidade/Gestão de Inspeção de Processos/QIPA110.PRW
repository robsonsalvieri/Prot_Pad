#include "qipa110.CH"
#include "PROTHEUS.CH"

/*/


Ŀ
Funo     qipa110   Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Programa Atualizacao de Informativo sobre Produtos         
Ĵ
 Uso       Generico               (MODELO 2)                          
Ĵ
 PROGRAMADOR   DATA    BOPS   MOTIVO DA ALTERACAO                   
Ĵ
Marcelo       25/04/00------ Incluido o quinto parametro como 3 no  
Marcelo       25/04/00------ array aRotina.                         
Paulo Emidio  25/07/00------ Retirada da Funcao HotAreas            
ٱ


/*/
Static Function MenuDef()

Local aRotina := {	{ OemToAnsi(STR0004),"AxPesqui", 0 , 1,,.F.},;			//"Pesquisar"
					  	{ OemToAnsi(STR0005),"Qip110Vis", 0 , 6},;			//"Visualizar"
						{ OemToAnsi(STR0006),"Qip110Incl", 0 , 3},;		//"Incluir"
						{ OemToAnsi(STR0007),"Qip110Alte", 0 , 4, 6},;		//"Alterar"
						{ OemToAnsi(STR0008),"Qip110Dele", 0 , 6 , 3 } }	//"Excluir"
						
Return aRotina

Function qipa110()

Private axTextos	:= {}	// Vetor que contem os textos dos Topicos
Private cEspecie	:= 'qipa110 '	// Deve ter tamanho 8
Private lEdita		:= .T.
Private lFase3      := ChkFile("QQ4") 
Private __cPRODUTO  := CriaVar("QP6_PRODUT") //Codigo do Produto, quando a Especificacao for em Grupo      
Private lProduto    := .F.

PRIVATE cCadastro := OemtoAnsi(STR0009) // "Informativo s/ Produtos"
//Ŀ
// Endereca a funcao de BROWSE                                  
//

//Ŀ
// Define Array contendo as Rotinas a executar do programa      
// ----------- Elementos contidos por dimensao ------------     
// 1. Nome a aparecer no cabecalho                              
// 2. Nome da Rotina associada                                  
// 3. Usado pela rotina                                         
// 4. Tipo de Transao a ser efetuada                          
//    1 - Pesquisa e Posiciona em um Banco de Dados             
//    2 - Simplesmente Mostra os Campos                         
//    3 - Inclui registros no Bancos de Dados                   
//    4 - Altera o registro corrente                            
//    5 - Remove o registro corrente do Banco de Dados          
//    6 - Altera determinados campos sem incluir novos Regs     
//
PRIVATE aRotina := MenuDef()

mBrowse( 6, 1,22,75,"QPB")

Return

/*/


Ŀ
Funo    Qip110Vis  Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Programa atualizacao Informativo sobre Itens - Visualizacao
Ĵ
Sintaxe    Qip110Vis(ExpC1,ExpN1,ExpN2)                               
Ĵ
Parametros ExpC1 = Alias do arquivo                                   
           ExpN1 = Numero do registro                                 
           ExpN2 = Numero da opcao selecionada                        
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
FUNCTION Qip110Vis(cAlias,nReg,nOpcx)
LOCAL oDlg
LOCAL oGet
LOCAL oData
Local nCnt			:=0
Local aAlter 		:={"QPC_TXTTOP"}
LOCAL nOpca			:=0
LOCAL aButtons		:={}       
Local cWhile  		:= ""
Local cSeek   		:= ""
Private nPosTop		:=0
Private nPosDTo		:=0
Private	cIE080Prod	:=QPB_PRODUT
Private cIE080Desc	:=QPB_DESCRI

//Ŀ
// Verifica os Topicos ja' existentes                           
//
dbSelectArea("QPC")
dbSeek( xFilial("QPC") + QPB->QPB_PRODUT )

nCnt := 0
While !EOF() .And. QPC_FILIAL+QPC_PRODUT == xFilial("QPC")+QPB->QPB_PRODUT
	nCnt++
	dbSkip()
EndDo
If nCnt == 0
	dbselectarea(calias)
	Return .T.
Endif

//Ŀ
// Monta a entrada de dados do arquivo                          
//
Private nUsado := 0	// Getdados

cWhile  := Alltrim(RetSIX("QPC","1",.T.,{"QPC_TOPICO"}))
cSeek   := "xFilial('QPC')+cIE080Prod"
//Ŀ
// Monta o cabecalho                                            
//
dbSelectArea("QPC")	// Posiciona pq. rotinas internas utilizam inf. do SX2
FillGetDados(	nOpcx,; 							// numero correspondente  operao a ser executada, exemplo: 3 - incluso, 4 alterao e etc;
               	"QPC",;       					// area a ser utilizada;
               	1,;      						// nOrdem - ordem correspondente a chave de ndice para preencher o  acols;
               	Iif((nOpcx == 3),"",&cSeek),;  	// chave utilizada no posicionamento da rea para preencher o acols; 
               	{|| &cWhile},; 					// bloco contendo a expresso a ser comparada com cSeekKey na condio  do While. 
               	{|| .T.},;  					// uSeekFor
               	,;  						 	// aNoFields - array contendo os campos que no estarao no aHeader;
               	,;  							// aYesFields - array contendo somente os campos que estarao no aHeader;
               	.F.,;      						// se verdadeiro, exibe apenas os campos de usurio;
                '',;      						// cQuery - query a ser executada para preencher o acols;
               	,;    				   			// bloco contendo funcao especifica para preencher o aCols; 
               	Iif((nOpcx == 3),.T.,.F.),;  	// lEmpty 
               	,; 								// aHeaderAux
               	,; 		   						// aColsAux
               	,; 								// bAfterCols
               	,; 								// bBeforeCols
               	,; 								// bAfterHeader
               	'') 							// cAliasQry

nUsado := Len(aHeader)
//Ŀ
// Verifica a posicao dos campos no aHeader p/ posterior consistencia   
//
nPosTop := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_TOPICO"})
nPosDTo := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_DESTOP"})

QIP110Cols(@aCols, @aHeader)

//Ŀ
// No deixa editar o texto.                                    
//
lEdita := .F.

//Ŀ
// Posiciona ponteiro do arquivo cabeca e inicializa variaveis  
//
dbSelectArea("QPC")
dbSeek( xFilial("QPC") + QPB->QPB_PRODUT )

nOpca 		:= 0
ShowPrd(cIE080Prod)
DEFINE MSDIALOG oDlg TITLE OemtoAnsi(STR0009) From 150,1 To 416,601 OF oMainWnd PIXEL	 // "Informativo s/ Produtos"

@ 43,2 TO 130, 299 LABEL "" OF oDlg PIXEL
@ 19,4  SAY OemToAnsi(STR0010) SIZE 29,7 OF oDlg PIXEL 		//"&Produto"
@ 18,40 SAY cIE080Prod SIZE  61,10 OF oDlg PIXEL
@ 19,117 SAY QP6->QP6_DESCPO SIZE 153,7 OF oDlg PIXEL
@ 31,4 SAY OemToAnsi(STR0011) SIZE 35,7 OF oDlg PIXEL 		//"&Descritivo"
@ 31,40 SAY cIE080Desc SIZE 153,7 OF oDlg PIXEL
@ 31,208 SAY OemToAnsi(STR0013) SIZE 18,7 OF oDlg PIXEL		//"Data"
@ 31,228 SAY oData VAR QPB->QPB_DTATU  SIZE 30,10 OF oDlg PIXEL

dbSelectArea("QPC")
dbseek(xFilial("QPC") + cIE080Prod)
oGet := MSGetDados():New(50,5,128,296,nOpcx,"AllwaysTrue","AllwaysTrue","",,aAlter)

//Ŀ
// Cria botao utilizado na Enchoicebar        	    
//
AAdd(aButtons,{"RELATORIO",	{|| A110Text()},STR0027,STR0029}) //"Observacao do Informativo"###"Obs Info"

ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{||oDlg:End()},,aButtons)
lEdita := .T.

dbSelectArea(cAlias)
Return(.T.)
/*/


Ŀ
Funo    Qip110Incl Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Programa Atualizacao Informativo sobre Produtos - Inclusao 
Ĵ
Sintaxe    Void Qip110Incl(ExpC1,ExpN1,ExpN2)                         
Ĵ
Parametros ExpC1 = Alias do arquivo                                   
           ExpN1 = Numero do registro                                 
           ExpN2 = Opcao selecionada                                  
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
FUNCTION Qip110Incl(cAlias,nReg,nOpcx)

LOCAL nOpca:=0 
LOCAL oDlg, oGet, cVarPrd := CriaVar("QP6_DESCPO",.F.)
LOCAL lGravaOk := .T., cPictPro := '@!'
LOCAL aButtons	:= {}
Local cWhile  		:= ""
Local cSeek   		:= ""
Local oSize

Private cIE080Prod := CriaVar("QPB_PRODUT"), cIE080Desc := CriaVar("QPB_DESCRI")
Private nPosTop, nPosDTo

//Ŀ
// Monta a entrada de dados do arquivo                          
//
Private Continua, nUsado:=0

dbSelectArea("QPC")

cWhile  := Alltrim(RetSIX("QPC","1",.T.,{"QPC_TOPICO"}))
cSeek := "xFilial('QPC')+cIE080Prod"
//Ŀ
// Monta o cabecalho                                            
//
dbSelectArea("QPC")	// Posiciona pq. rotinas internas utilizam inf. do SX2
FillGetDados(	nOpcx,; 							// numero correspondente  operao a ser executada, exemplo: 3 - incluso, 4 alterao e etc;
               	"QPC",;       					// area a ser utilizada;
               	1,;      						// nOrdem - ordem correspondente a chave de ndice para preencher o  acols;
               	Iif((nOpcx == 3),"",&cSeek),;  	// chave utilizada no posicionamento da rea para preencher o acols; 
               	{|| &cWhile},; 					// bloco contendo a expresso a ser comparada com cSeekKey na condio  do While. 
               	{|| .T.},;  					// uSeekFor
               	,;  						 	// aNoFields - array contendo os campos que no estarao no aHeader;
               	,;  							// aYesFields - array contendo somente os campos que estarao no aHeader;
               	.F.,;      						// se verdadeiro, exibe apenas os campos de usurio;
                '',;      						// cQuery - query a ser executada para preencher o acols;
               	,;    				   			// bloco contendo funcao especifica para preencher o aCols; 
               	Iif((nOpcx == 3),.T.,.F.),;  	// lEmpty 
               	,; 								// aHeaderAux
               	,; 		   						// aColsAux
               	,; 								// bAfterCols
               	,; 								// bBeforeCols
               	,; 								// bAfterHeader
               	'') 							// cAliasQry

nUsado := Len(aHeader)

//Ŀ
// Verifica a posicao dos campos no aHeader p/ posterior consistencia   
//
nPosTop := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_TOPICO"})
nPosDTo := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_DESTOP"})    
//Ŀ
// Obtem a picture do campo Produto                          
//
cPictPro := PesqPict("QPB","QPB_PRODUT")

Continua := .F.
nOpca 	:= 0

oSize := FwDefSize():New(.T.) 
                 
oSize:AddObject( "CABECALHO" ,  100, 35, .T.,.F.)
oSize:AddObject( "GETDADOS" ,  100, 65, .T.,.T.)  
           
oSize:aMargins := { 3, 3, 3, 3 }

oSize:Process() // Dispara os calculos  

DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0009) ; // "Informativo"	 
						FROM oSize:aWindSize[1],oSize:aWindSize[2] TO oSize:aWindSize[3],oSize:aWindSize[4] OF oMainWnd PIXEL

@ oSize:GetDimension('CABECALHO'  , 'LININI'),oSize:GetDimension('CABECALHO'  , 'COLINI') TO ;
  oSize:GetDimension('CABECALHO'  , 'LINEND'),oSize:GetDimension('CABECALHO'  , 'COLEND') LABEL "" OF oDlg PIXEL					

@ oSize:GetDimension('CABECALHO'  , 'LININI')+5,4  SAY OemToAnsi(STR0010) SIZE 29,7 OF oDlg PIXEL 		//"&Produto"
@ oSize:GetDimension('CABECALHO'  , 'LININI')+5,40	MSGET cIE080Prod	PICTURE cPictPro VALID CheckSX3("QPB_PRODUT") .AND.;
		ExistCpo("QP6",cIE080Prod) .AND. ExistChav("QPB",cIE080Prod) .AND.;
		ShowPrd  (cIE080Prod,@cVarPrd) WHEN  VisualSX3("QPB_PRODUT") F3 "QP6" SIZE  61,10 OF oDlg PIXEL
@ oSize:GetDimension('CABECALHO'  , 'LININI')+5,117 SAY cVarPrd SIZE 153,7 OF oDlg PIXEL
@ oSize:GetDimension('CABECALHO'  , 'LININI')+20,4 SAY OemToAnsi(STR0011) SIZE 35,7 OF oDlg PIXEL 		//"&Descritivo"
@ oSize:GetDimension('CABECALHO'  , 'LININI')+20,40 MSGET cIE080Desc VALID CheckSX3("QPB_DESCRI") WHEN VisualSX3("QPB_DESCRI") SIZE 162,10 OF oDlg PIXEL
@ oSize:GetDimension('CABECALHO'  , 'LININI')+20,208 SAY OemToAnsi(STR0013) SIZE 18,7 OF oDlg PIXEL		//"Data"
@ oSize:GetDimension('CABECALHO'  , 'LININI')+20,228 MSGET dDataBase VALID CheckSX3("C7_CONTATO") SIZE  42,10 OF oDlg PIXEL
dbSelectArea("QPC")
dbseek(xFilial("QPC") + cIE080Prod)


oGet := MSGetDados():New(oSize:GetDimension('GETDADOS'  , 'LININI'),oSize:GetDimension('GETDADOS'  , 'COLINI'),;
							oSize:GetDimension('GETDADOS'  , 'LINEND'),oSize:GetDimension('GETDADOS'  , 'COLEND'),;
							nOpcx,"Qip110lOk","Qip110TOk",,.T.)						

//Ŀ
// Cria botao utilizado na Enchoicebar        	    
//
AAdd(aButtons,{"RELATORIO",	{|| A110Text()},STR0027,STR0029}) //"Observacao do Informativo"###"Obs Info"

ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{||oDlg:End()},,aButtons)

If nOpcA == 1
	Begin Transaction
	lGravaOk := Qip110Grav(cAlias)
	If !lGravaOk
		Help(" ",1,"A010NAOGRV")
	Else
		//Processa Gatilhos
		EvalTrigger()
	EndIf
	End Transaction
Endif
axTextos := {}
dbSelectArea(cAlias)
Return nOpca

/*/


Ŀ
Funo    Qip110Alte Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Programa atualizacao Informativos s/ Produtos - Alteracao  
Ĵ
Sintaxe e  Void Qip110Alte(ExpC1,ExpN1,ExpN2)                         
Ĵ
Parametros ExpC1 = Alias do arquivo                                   
           ExpN1 = Numero do registro                                 
           ExpN2 = Opcao selecionada no menu                          
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
FUNCTION Qip110Alte(cAlias,nReg,nOpcx)

LOCAL nCnt, nSavRec
LOCAL nOpca:=0, nRecSqc
LOCAL oDlg, oGet
LOCAL lGravaOk := .T.
LOCAL aButtons	:= {}
Local cWhile  		:= ""
Local cSeek   		:= ""

Private nPosTop, nPosDTo

//Ŀ
// Verifica se existe algum dado no arquivo                     
//
dbSelectArea(cAlias)
If RecCount() == 0
	Return .T.
Endif

PRIVATE cIE080Prod := QPB_PRODUT, cIE080Desc := QPB_DESCRI

dbSelectArea("QPC")
//Ŀ
// Monta a entrada de dados do arquivo                          
//
Private Continua:=.F.,nOpc:=3,nUsado:=0

//Ŀ
// Salva a integridade dos campos de Bancos de Dados            
//
dbSelectArea("QPC")	// Posiciona pq. rotinas internas utilizam inf. do SX2

cWhile  := Alltrim(RetSIX("QPC","1",.T.,{"QPC_TOPICO"}))
cSeek := "xFilial('QPC')+cIE080Prod"
//Ŀ
// Monta o cabecalho                                            
//
dbSelectArea("QPC")	// Posiciona pq. rotinas internas utilizam inf. do SX2
FillGetDados(	nOpcx,; 							// numero correspondente  operao a ser executada, exemplo: 3 - incluso, 4 alterao e etc;
               	"QPC",;       					// area a ser utilizada;
               	1,;      						// nOrdem - ordem correspondente a chave de ndice para preencher o  acols;
               	Iif((nOpcx == 3),"",&cSeek),;  	// chave utilizada no posicionamento da rea para preencher o acols; 
               	{|| &cWhile},; 					// bloco contendo a expresso a ser comparada com cSeekKey na condio  do While. 
               	{|| .T.},;  					// uSeekFor
               	,;  						 	// aNoFields - array contendo os campos que no estarao no aHeader;
               	,;  							// aYesFields - array contendo somente os campos que estarao no aHeader;
               	.F.,;      						// se verdadeiro, exibe apenas os campos de usurio;
                '',;      						// cQuery - query a ser executada para preencher o acols;
               	,;    				   			// bloco contendo funcao especifica para preencher o aCols; 
               	Iif((nOpcx == 3),.T.,.F.),;  	// lEmpty 
               	,; 								// aHeaderAux
               	,; 		   						// aColsAux
               	,; 								// bAfterCols
               	,; 								// bBeforeCols
               	,; 								// bAfterHeader
               	'') 							// cAliasQry

nUsado := Len(aHeader)
//Ŀ
// Verifica a posicao dos campos no aHeader p/ posterior consistencia   
//
nPosTop := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_TOPICO"})
nPosDTo := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_DESTOP"})

QIP110Cols(@aCols, @aHeader)

Continua 	:= .F.
nOpca 		:= 0

ShowPrd(cIE080Prod)

DEFINE MSDIALOG oDlg TITLE OemtoAnsi(STR0009) From 150,1 To 416,601 OF oMainWnd PIXEL	 // "Informativo s/ Produtos"

@ 43,2 TO 130, 299 LABEL "" OF oDlg PIXEL
@ 19,4  SAY OemToAnsi(STR0010) SIZE 29,7 OF oDlg PIXEL 		//"&Produto"
@ 18,40 SAY cIE080Prod SIZE  61,10 OF oDlg PIXEL
@ 19,117 SAY QP6->QP6_DESCPO SIZE 153,7 OF oDlg PIXEL
@ 31,4 SAY OemToAnsi(STR0011) SIZE 35,7 OF oDlg PIXEL 		//"&Descritivo"
@ 31,40 MSGET cIE080Desc ;
VALID CheckSX3("QPB_DESCRI") ;
WHEN VisualSX3("QPB_DESCRI") SIZE 162,10 OF oDlg PIXEL

@ 31,208 SAY OemToAnsi(STR0013) SIZE 18,7 OF oDlg PIXEL		//"Data"
@ 31,228 MSGET dDataBase;
VALID CheckSX3("C7_CONTATO");
SIZE  42,10;
OF    oDlg PIXEL

dbSelectArea("QPC")
dbseek(xFilial("QPC") + cIE080Prod)
oGet := MSGetDados():New(50,5,128,296,nOpcx,"Qip110lOk","Qip110TOk",,.T.)
//Ŀ
// Cria botao utilizado na Enchoicebar        	    
//
AAdd(aButtons,{"RELATORIO",	{|| A110Text()},STR0027,STR0029}) //"Observacao do Informativo"###"Obs Info"

ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{||oDlg:End()},,aButtons)

If nOpcA == 1
	Begin Transaction
	lGravaOk :=Qip110Grav(cAlias)
	If !lGravaOK
		Help(" ",1,"A010NAOGRV")
	Else
		EvalTrigger()
	EndIf
	End Transaction
Endif

dbSelectArea(cAlias)
Return nOpca

/*/


Ŀ
Funo    Qip110Dele Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Programa atualizacao Informativo sobre Produtos - Delecao  
Ĵ
Sintaxe    Qip110Dele(ExpC1,ExpN1,ExpN2)                              
Ĵ
Parametros ExpC1 = Alias do arquivo                                   
           ExpN1 = Numero do registro                                 
           ExpN2 = Numero da opcao selecionada                        
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
FUNCTION Qip110Dele(cAlias,nReg,nOpcx)
LOCAL nCnt
LOCAL nOpca  :=0
LOCAL aAlter := {"QPC_TXTTOP"}
LOCAL oDlg
LOCAL oGet			
LOCAL aButtons := {}
LOCAL nX     
Local cWhile  		:= ""
Local cSeek   		:= ""

Private nPosTop, nPosDTo

lEdita := .F.
	
//Ŀ
// Verifica se existe algum dado no arquivo                     
//
dbSelectArea(cAlias)
If RecCount() == 0
	Return .T.
Endif

PRIVATE cIE080Prod := QPB_PRODUT, cIE080Desc := QPB_DESCRI

//Ŀ
// Monta a entrada de dados do arquivo                          
//
Private nOpc:=3,nUsado:=0

dbSelectArea("QPC")
cWhile  := Alltrim(RetSIX("QPC","1",.T.,{"QPC_TOPICO"}))
cSeek := "xFilial('QPC')+cIE080Prod"
//Ŀ
// Monta o cabecalho                                            
//
dbSelectArea("QPC")	// Posiciona pq. rotinas internas utilizam inf. do SX2
FillGetDados(	nOpcx,; 							// numero correspondente  operao a ser executada, exemplo: 3 - incluso, 4 alterao e etc;
               	"QPC",;       					// area a ser utilizada;
               	1,;      						// nOrdem - ordem correspondente a chave de ndice para preencher o  acols;
               	Iif((nOpcx == 3),"",&cSeek),;  	// chave utilizada no posicionamento da rea para preencher o acols; 
               	{|| &cWhile},; 					// bloco contendo a expresso a ser comparada com cSeekKey na condio  do While. 
               	{|| .T.},;  					// uSeekFor
               	,;  						 	// aNoFields - array contendo os campos que no estarao no aHeader;
               	,;  							// aYesFields - array contendo somente os campos que estarao no aHeader;
               	.F.,;      						// se verdadeiro, exibe apenas os campos de usurio;
                '',;      						// cQuery - query a ser executada para preencher o acols;
               	,;    				   			// bloco contendo funcao especifica para preencher o aCols; 
               	Iif((nOpcx == 3),.T.,.F.),;  	// lEmpty 
               	,; 								// aHeaderAux
               	,; 		   						// aColsAux
               	,; 								// bAfterCols
               	,; 								// bBeforeCols
               	,; 								// bAfterHeader
               	'') 							// cAliasQry

nUsado := Len(aHeader)
//Ŀ
// Verifica a posicao dos campos no aHeader p/ posterior consistencia   
//
nPosTop := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_TOPICO"})
nPosDTo := Ascan(aHeader,{|x| AllTrim(x[2]) = "QPC_DESTOP"})

QIP110Cols(@aCols, @aHeader)

nOpca 	  := 0
ShowPrd(cIE080Prod)
DEFINE MSDIALOG oDlg TITLE OemtoAnsi(STR0009) From 150,1 To 416,601 OF oMainWnd PIXEL	 // "Informativo s/ Produtos"
@ 43,2 TO 130, 299 LABEL "" OF oDlg PIXEL
@ 19,4  SAY OemToAnsi(STR0010) SIZE 29,7 OF oDlg PIXEL 		//"&Produto"
@ 18,40 SAY cIE080Prod SIZE  61,10 OF oDlg PIXEL
@ 19,117 SAY cIE080Desc SIZE 153,7 OF oDlg PIXEL
@ 31,4 SAY OemToAnsi(STR0011) SIZE 35,7 OF oDlg PIXEL 		//"&Descritivo"
@ 31,40 SAY cIE080Desc SIZE 153,7 OF oDlg PIXEL
@ 31,208 SAY OemToAnsi(STR0013) SIZE 18,7 OF oDlg PIXEL		//"Data"
@ 31,228 SAY oData VAR QPB->QPB_DTATU  SIZE 30,10 OF oDlg PIXEL
dbSelectArea("QPC")
dbseek(xFilial("QPC") + cIE080Prod)
oGet := MSGetDados():New(50,5,128,296,nOpcx,"AllwaysTrue","AllwaysTrue","",,aAlter)
//Ŀ
// Cria botao utilizado na Enchoicebar        	    
//
AAdd(aButtons,{"RELATORIO",	{|| A110Text()},STR0027,STR0029}) //"Observacao do Informativo"###"Obs Info"

ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{||oDlg:End()},,aButtons)
lEdita := .T.
If nOpcA <> 1
	dbSelectArea("QPC")
	Return
EndIf
Begin Transaction
	//Ŀ
	// Cancela os Topicos no QPC             
	//
	dbSelectArea("QPC") // Topicos
	For nx := 1 to Len(aCols)
		dbSeek( xFilial("QPC")+cIE080Prod+aCols[nx,nPosTop])
		RecLock("QPC",.F.,.T.)
		dbDelete()
	 	//Ŀ
		// Cancela o Texto do Topico no QA2      
		//
		QA_DelTxt(xFilial("QPC")+QPC->QPC_PRODUT+QPC->QPC_TOPICO,cEspecie)	// QAXFUN
		dbSelectArea("QPC") // Topicos
	Next nx
	//Ŀ
	// Cancela o Informativo no QPB          
	//
	dbSelectArea("QPB") // Informativo
	RecLock("QPB",.F.,.T.)
	dbDelete()
End Transaction
dbSelectArea(cAlias)
Return

/*/


Ŀ
Funo    QIP110Cols Autor  Cicero Odilio Cruz     Data  30/01/07 
Ĵ
Descrio  Programa de verificacao do aCols                           
ٱ


/*/
Function QIP110Cols(aCols, aHeader)
Local nX := 0

For nX := 1 to Len(aCols)
	aCols[nX,nPosDTo] := Iif(Empty(AllTrim(aCols[nX,nPosTop])),"",A110DTOP(aCols[nX,nPosTop])) 
Next

Return 

/*/


Ŀ
                                                                       
                                                                       
                   ROTINAS DE CRITICA DE CAMPOS                        
                                                                       
                                                                       
ٱ




Ŀ
Funo    Qip110lOk  Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Critica se a linha digitada esta' Ok                       
Ĵ
Parametros ExpC1 = Objeto a ser verificado.                           
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
Function Qip110lOk(o)

Local lRet := .T.
Local nAchou:=0
Local cProcura:=aCols[n,nPosTop]

If !(aCols[n,Len(aCols[n])])
	//Ŀ
	// Verifica se campo Topico esta' preenchido                   
	//
	If !aCols[n,nUsado+1] .And. LastKey() != 5 .And. LastKey() != 27 .And. lRet
		If Empty(aCols[n,nPosTop])
			Help(" ",1,"QA_CPOOBR")
			lRet:=.F.	
		EndIf
	EndIf
	If lRet
		//Ŀ
		// Verifica se o Topico ja' existe                 
		//
		nAchou := Ascan(aCols,{|x| x[nPosTop] == cProcura .And. !(x[Len(aCols[n])])})
		If nAchou > 0 .And. nAchou # n
			Help(" ",1,"A080EXITOI")
			lRet:=.F.
		EndIf
	EndIf

	//Ŀ
	// Verifica se o Topico esta' cadastrado           
	//
	If lRet
		If ! Empty(aCols[n,nPosTop])
			If ! ExistCpo("SX5",'Q3'+aCols[n,nPosTop])
				lRet := .f.
			EndIf
		EndIf
	EndIf
EndIf
Return lRet

/*/


Ŀ
Funo    Qip110TOk  Autor  Vera Lucia S. Simoes   Data  20/01/98 
Ĵ
Descrio  Critica se toda a getdados esta' Ok                        
Ĵ
Parametros ExpC1 = Objeto a ser verificado.                           
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
Function Qip110TOk(o)
Local nI, lRet := .t.

For nI := 1 to Len(aCols)
	If ! Qip110lOk(o)
		lRet := .f.
		Exit
	EndIf
Next

Return(lRet)

/*/


Ŀ
Funo    Qip110Grav Autor  Vera Lucia S. Simoes   Data  21/11/97 
Ĵ
Descrio  Grava as informacoes dos Informativos                      
Ĵ
 Uso       qipa110                                                    
ٱ


/*/
Function Qip110Grav(cAlias)
Local nx ,ny , nMaxArray := Len(aCols)
Local n080Del:=0
Local nPosTop := 0, lOk := .t.

dbSelectArea("QPC")

//Ŀ
// Verifica qual a posicao do campo Topico no aHeader         
//
nPosTop := ASCAN(aHeader,{|x|x[2] = "QPC_TOPICO"})

//Ŀ
// Conta no. de Topicos deletados         
//
For nx := 1 to nMaxArray
	If aCols[nx,Len(aCols[nx])]	// Deletou	
		n080Del++
	EndIf
Next nx

If n080Del >= nMaxArray
	If Inclui
		Help(" ",1,"A080DTOPIN")
	Else
		Help(" ",1,"A080DTOPAL")
	EndIf
	lOk := .f.
Endif

If lOk
	//Ŀ
	// Grava o arquivo QPC        
	//
	For nX := 1 to nMaxArray
		If ! Empty(aCols[nX,nPosTop]) // Cod. Topico nao vazio
			If !Acols[nX,nUsado+1]	// Nao esta deletado
				If dbSeek(xFilial("QPC") + cIE080Prod + aCols[nX,nPosTop])			
					RecLock("QPC",.F.)	// Lock
				Else
					RecLock("QPC",.T.)	// Append
					QPC->QPC_PRODUT := cIE080Prod
					QPC->QPC_FILIAL := xFilial("QPC")
				Endif
				For ny := 1 to Len(aHeader)
					If aHeader[ny,10] # "V"
						cVar := Trim(aHeader[ny,2])
						Replace &cVar. With aCols[nx,ny]
					Endif
				Next ny

 			Else
			 	//Ŀ
				// Cancela o Topico no QPC               
				//
				If dbSeek(xFilial("QPC") + cIE080Prod + aCols[nX,nPosTop])			
					RecLock("QPC",.F.)
					dbDelete()
				 	//Ŀ
					// Cancela o Texto do Topico no QA2      
					//
					QA_DelTxt(xFilial("QPC")+QPC->QPC_PRODUT+QPC->QPC_TOPICO,cEspecie)	// QAXFUN
					dbSelectArea("QPC") // Topicos
				EndIf
			EndIf
		EndIf
	Next nx

	//  Se cancelou todos os Topicos, cancela o Informativo
	If ! QPC->(dbSeek(xFilial("QPC") + cIE080Prod))
		//Ŀ
		// Cancela o Informativo no QPB        
		//
		dbSelectArea("QPB")
		if dbseek(xFilial("QPB") + cIE080Prod)
			RecLock("QPB",.F.)
			dbDelete()
		EndIf
	Else
		//Ŀ
		// Grava o arquivo QPB        
		//
		dbSelectArea("QPB")
		if dbseek(xFilial("QPB") + cIE080Prod)
			RecLock("QPB",.F.)
		Else
			RecLock("QPB",.t.)
			QPB->QPB_FILIAL := xFilial("QPB")
			QPB->QPB_PRODUT := cIE080Prod
		EndIf	
		QPB->QPB_DESCRI := cIE080Desc
		QPB->QPB_DTATU  := dDataBase
	EndIf

EndIf
Return .T.
/*/


Ŀ
Funo     A110VlTo  Autor  Vera Lucia S. Simoes   Data  28/11/97 
Ĵ
Descrio  Valida campo Topico                                        
Ĵ
 Uso       qipa110 - E' chamada no X3_VALID do cpo. QPC_TOPICO - SX3  
ٱ


/*/
Function A110VlTo()
Local lRetu := .t., nI,;
		cVar := &(readvar()) // Conteudo da variavel do campo Topico
//Ŀ
// Verifica se mudou o Topico (Alterou o campo ja' digitado)      
//
If !Empty(aCols[n,nPosTop]) .and. !Empty(cVar) .and. aCols[n,nPosTop] <> cVar
	Help(" ",1,"A010ALTCHA")	// Campo nao pode ser alterado	
	lRetu := .f.
EndIf

//Ŀ
// Verifica se o Topico esta' cadastrado           
//
If lRetu
	aCols[n,nPosTop] := M->QPC_TOPICO
	If ! ExistCpo("SX5",'Q3'+aCols[n,nPosTop])
		lRetu := .f.
	EndIf
EndIf

//Ŀ
// Verifica se o Topico ja' existe                 
//
If lRetu
	For nI := 1 to len(aCols)
		If cVar == acols[nI,nPosTop] .and. nI <> n // Se ja' existir este cod. topico
			Help(" ",1,"A080EXITOP")
			lRetu := .f.
		EndIf
	Next nI
EndIf

//Ŀ
// Preenche a Descricao do Topico                  
//
If lRetu
	aCols[n,nPosDTo] := A110DTOP(aCols[n,nPosTop])
EndIf

Return(lRetu)
/*/


Ŀ
Funo     A110Text  Autor  Vera Lucia S. Simoes   Data  03/12/97 
Ĵ
Descrio  Chama funcao que edita texto do topico                     
Ĵ
 Uso       qipa110 - E' chamada no X3_VALID do cpo. QPC_TXTTOP - SX3  
ٱ


/*/
Static Function A110Text()
Local cChave	:= ''
Local nTamLin	:= TamSX3('QA2_TEXTO')[1]
Local nPosChave:= Ascan(aHeader,{|x| AllTrim(x[2]) == 'QPC_CHAVE' })
Local lRetTex   := .t.
axtextos		:= {} 	//Vetor que contem os textos dos Produtos

If Empty(aCols[n,nPosChave])
	cChave := QA_CvKey(xFilial("QPC")+cIE080Prod+aCols[n,nPosTop],"QPC",2)
	aCols[n,nPosChave] := cChave
Else
	cChave := aCols[n,nPosChave]
Endif

//Ŀ
// Digita o Texto do Produto    							 
//
lRetTex := QA_TEXTO(cChave,cEspecie,nTamLin,OemToAnsi(STR0018),aCols[n,nPosTop]+" - "+aCols[n,nPosDTo],@axTextos,1,OemToAnsi( STR0019),lEdita)		//"Tpico"###"Texto do Tpico"

//Ŀ
// Grava Texto do Produto no QA2							 
//
If lRetTex
	QA_GrvTxt(cChave,cEspecie,1,@axtextos)
EndIf
Return .t.
/*/


Ŀ
Funo     A110DTOP  Autor  Vera Lucia S. Simoes   Data  05.12.97 
Ĵ
Descrio  Retorna a descricao do Topico                              
Ĵ
 Uso       Generico                                                   
ٱ


/*/
Function A110DTOP(cCodTop)
SX5->(dbSeek(xFilial("SX5") + 'Q3' + cCodTop))	// Topico posicionado na getdados
Return(X5Descri())

/*/


Ŀ
Funo     SHOWPRD   Autor  Alessandro B. Freire   Data  16.01.98 
Ĵ
Descrio  Retorna a descricao do Produto                             
Ĵ
 Uso       Generico                                                   
ٱ


/*/
STATIC Function ShowPrd( cIE080Prod, cVarPrd )
	
Local nB1OldOrd := QP6->(IndexOrd())
	
QP6->(dbSetOrder(1))
QP6->(dbSeek(xFilial("QP6")+cIE080Prod))
If cVarPrd != NIL
	cVarPrd := QP6->QP6_DESCPO
EndIf
QP6->(dbSetOrder(nB1OldOrd))
Return(.T.)
