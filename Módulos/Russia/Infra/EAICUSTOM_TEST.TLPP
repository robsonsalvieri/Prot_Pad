#INCLUDE "PROTHEUS.CH"    
#DEFINE SEND_OPER '2'

/*/{Protheus.doc} EAITEST(cTGet1,cTGet2)
    Function to TEST EAI sending messages
    @type  Function
    @author idashkov
    @since 04.06.24
    @param cTGet1
    @param cTGet2
/*/
User Function EAITEST(cTGet1,cTGet2) as Logical 

    Local lRet := .F.
    Local aAdapters := {}
    Default cTGet1 := space(250)
    Default cTGet2 := space(250)

    np.framework.eai.TrySetEnv()

    aAdapters := np.framework.eai.RU99X20001_GetADAPTERS(cModelOper="")
    
    If Len(aAdapters) > 0
        DEFINE MSDIALOG oDlg FROM 0,0 TO 15,75 TITLE "Test EAI"
            nLin := 40
            nList := 1
            // Usando New
            cTGet1 := aAdapters[1]
            oCombo1 := TComboBox():New(nLin,01, {|u|if(PCount()>0,cTGet1:=u,cTGet1)},;
            aAdapters,100,20,oDlg,,{||Alert('Mudou item da combo')},,,,.T.,,,,,,,,,'cTGet1')
            nLin += 30
            //Message
            oTGet2 := TGet():New( nLin+10,01, bSetGet( cTGet2 ),oDlg, 250,009,"",;
                /* [ bValid ]*/,/**nClrFore */,/**nClrBack */,/**oFont */,/**uParam12 */,;
                /**uParam13 */, .t.,/**uParam15 */,/**uParam16 */, {|| .T.},/*uParam18*/ ,;
                /**uParam19 */, /*bChange*/, /* lReadOnly */, /* lPassword */,;
                /* uParam23 */, /* cReadVar */, /* uParam25 */, /* uParam26 */,;
                /* uParam27 */, /* lHasButton */, /* lNoButton */, /* uParam30 */,;
                "Message to be send"/* cLabelText */,;
                1/* nLabelPos */, /* oLabelFont */, /* nLabelColor */, /* cPlaceHold */,;
                /* lPicturePriority */, /* lFocSel */; 
            )
        ACTIVATE MSDIALOG oDlg CENTER ON INIT EnchoiceBar(;
            oDlg,{;
                || nOpcA:= 1,;
                FWMsgRun(;
                    , {|oSay| ProcessQueue(oSay, oDlg, cTGet1, cTGet2) },;
                    "Processando", "Creating and sending message via EAI";
                );
            }, {|| oDlg:End()};
        )
    Else
        lRet := .F.
        ConOut("EAITEST Exited: No adapters, defined! Define one to send first!")
        MsgAlert("No adapters, defined! Define one to send first!")
    EndIf

Return lRet

/*/{Protheus.doc} ProcessQueue(oSay,oDlg,cAdapter, cMessage)
    
    @type  Function
    @author idashkov
    @since 04.06.24
    @param 
    @param 
/*/
Static Function ProcessQueue(oSay,oDlg,cAdapter, cMessage)

    Local lRet := .F.
    Local oJson := JsonObject():New()
    Local lSend := .F.
    Local aAdapters := {}
    Default cMessage := "test message"

    cAdapter := AllTrim(cAdapter)
    If Empty(cAdapter)
        cAdapter := '1CAdapterS'
    EndIf
    aAdapters := {cAdapter}
    cMessage := AllTrim(cMessage)

    //oSay:cCaption := "Searching for required adapter"
    //ProcessMessages()

    oJson['message'] := cMessage

    //oSay:cCaption := "Creating message for EAI Queue"
    //ProcessMessages()
    lRet := np.framework.eai.EAISendQueue(aAdapters,/*oModel*/,oJson:toJson(),nOperation=3) // Add message to EAI Queue
    If lRet
        lSend := MsgYesNo("Send EAI messages?")
        If lSend
            //oSay:cCaption := "Sending message to endpoint from EAI Queue"
            //ProcessMessages()
            NP.FRAMEWORK.EAI.MA3EAISched() // Process EAI Queue to send all messages
        EndIf
    EndIf

    FreeObj(oJson)

    oDlg:End() // Message text is not updated between "Confirm" button pushes, so just exit and input onther message

Return lRet
