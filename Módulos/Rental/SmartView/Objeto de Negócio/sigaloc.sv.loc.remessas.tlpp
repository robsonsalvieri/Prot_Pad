#include "msobject.ch"
#include "TOTVS.ch"
#include "totvs.framework.treports.integratedprovider.th"

/*/{PROTHEUS.DOC} sigaloc.sv.loc.remessas.tlpp
ITUP BUSINESS - TOTVS RENTAL
Relatório de Remessas
@TYPE FUNCTION
@AUTHOR LEONARDO PACHECO FUGA
@SINCE 16/06/2025
/*/

namespace totvs.protheus.rental.manutencao.integratedprovider

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGALOC", tables="FP0,SC6,FPY,FPZ,CTT", name="Rental", country="ALL", initialRelease="12.1.2210")
class remessas from totvs.framework.treports.integratedprovider.integratedprovider
public method new() as object
public method getData() as object
public method getSchema() as object 
endclass

/*/{Protheus.doc} remessas
Processamento do relatório
@type method
@author Leonardo Pacheco Fuga
@since 19/09/2025
/*/
method new() class remessas
	_Super:new()
	//Define a Área
	self:appendArea("Rental")

	//Define o nome do Objeto de Negócio
	self:setDisplayName("remessas")

	//Define a descrição do Objeto de Negócio
	self:setDescription("remessas")
return self

/*/{Protheus.doc} getData
Processamento das querys
@type method
@author Leonardo Pacheco Fuga
@since 19/09/2025
/*/
method getData(nPage as numeric, oFilter as object) as object class remessas
local cQuery as character
local cAlias as character
local oExec as object
local cComando := ""
Local cLinha := ""

	//Define a quantidade máxima por página (Default 100)
	self:setPageSize(20)

	jParams := oFilter:getParameters() //metodo para retorno do json dos parâmetros

	If type("jParams['01'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['01'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf
	If empty(jParams['01'][1])
		jParams['01'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf

	If type("jParams['02'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['02'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf
	If empty(jParams['02'][1])
		jParams['02'][1] := space(TamSx3("FP0_PROJET")[1])
	EndIf

	If type("jParams['03'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['03'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['03'][1])
		jParams['03'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

	If type("jParams['04'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['04'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf
	If empty(jParams['04'][1])
		jParams['04'][1] := space(TamSx3("FP0_CLI")[1])
	EndIf

	If type("jParams['05'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['05'][1] := space(TamSx3("FPZ_OBRA")[1])
	EndIf
	If empty(jParams['05'][1])
		jParams['05'][1] := space(TamSx3("FPZ_OBRA")[1])
	EndIf

	If type("jParams['06'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['06'][1] := space(TamSx3("FPZ_OBRA")[1])
	EndIf
	If empty(jParams['06'][1])
		jParams['06'][1] := space(TamSx3("FPZ_OBRA")[1])
	EndIf

	If type("jParams['07'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['07'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['07'][1])
		jParams['07'][1] := space(TamSx3("B1_COD")[1])
	EndIf

	If type("jParams['08'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf
	If empty(jParams['08'][1])
		jParams['08'][1] := space(TamSx3("B1_COD")[1])
	EndIf

	If type("jParams['09'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['09'][1] := space(TamSx3("FPZ_FROTA")[1])
	EndIf
	If empty(jParams['09'][1])
		jParams['09'][1] := space(TamSx3("FPZ_FROTA")[1])
	EndIf

	If type("jParams['10'][1]") <> "C" .or. file("\SYSTEM\LOCSV009.TXT")
		jParams['10'][1] := space(TamSx3("FPZ_FROTA")[1])
	EndIf
	If empty(jParams['10'][1])
		jParams['10'][1] := space(TamSx3("FPZ_FROTA")[1])
	EndIf

	jParams['11'][1] := StrTran(SubStr(jParams["11"][1],1,10),"-","") // "20000101"
	If empty(jParams['11'][1])
		jParams['11'][1] := space(8)
	EndIf

	jParams['12'][1] := StrTran(SubStr(jParams["12"][1],1,10),"-","") // "20000101"
	If empty(jParams['12'][1])
		jParams['12'][1] := space(8)
	EndIf

	cQuery := " SELECT "
	cQuery += " FP0.FP0_CLI, FP0.FP0_LOJA, FP0.FP0_CLINOM, "
	cQuery += " SC6.C6_ITEM, "
	cQuery += " COALESCE(SB1.B1_COD,'SEM PRODUTO') B1_COD, "
	cQuery += " COALESCE(SB1.B1_DESC,'SEM PRODUTO') B1_DESC, "
	cQuery += " SC6.C6_UM, SC6.C6_LOCAL, " 
	cQuery += " COALESCE(SF4.F4_CODIGO,'SEM TES') F4_CODIGO, "
	cQuery += " COALESCE(SF4.F4_TEXTO,'SEM TES') F4_TEXTO, "
	cQuery += " SC6.C6_NOTA, SC6.C6_SERIE, SC6.C6_DATFAT, SC6.C6_CLVL, SC6.C6_ITEMCTA, "
	cQuery += " FPY.FPY_FILIAL, FPY.FPY_PROJET, FPY_NFDEVO, "
	cQuery += " CASE "
	cQuery += " WHEN FPY.FPY_TIPFAT = 'P' THEN 'PADRAO' "
    cQuery += " WHEN FPY.FPY_TIPFAT = 'M' THEN 'MEDICAO' "
	cQuery += " ELSE '' "
    cQuery += " END FPY_TIPFAT, "
	cQuery += " FPZ.FPZ_AS, FPZ.FPZ_PEDVEN, FPZ.FPZ_DTPED, FPZ.FPZ_DTINI, FPZ.FPZ_DTFIM, FPZ.FPZ_PROJET, FPZ.FPZ_ITEM,FPZ.FPZ_ROMAN, FPZ.FPZ_FROTA, "
	cQuery += " FPZ.FPZ_PERLOC, FPZ.FPZ_GERAEM, FPZ.FPZ_ITMFPZ, FPZ.FPZ_QUANT, FPZ.FPZ_VALUNI, FPZ.FPZ_TOTAL, FPZ.FPZ_VIAGEM, "
	cQuery += " FPZ.FPZ_DIAS, FPZ.FPZ_CLVL, FPZ.FPZ_OBRA, FPZ.FPZ_MEDICA, "
	cQuery += " COALESCE(CTT.CTT_CUSTO,'SEM CENTRO DE CUSTO') CTT_CUSTO, "
	cQuery += " COALESCE(CTT.CTT_DESC01,'SEM CENTRO DE CUSTO') CTT_DESC01 "	
	cQuery += " FROM "+RetSqlName("FPZ")+" FPZ "
	cQuery += " INNER JOIN " + RetSQLName("FP0") + " FP0 ON "
	cQuery += " FP0.FP0_FILIAL = '"+xFilial("FP0")+"' AND "
	cQuery += " FP0.FP0_PROJET = FPZ.FPZ_PROJET AND "
	cLinha := " FP0.FP0_PROJET >= '"+jParams['01'][1]+"' AND "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " FP0.FP0_PROJET <= '"+jParams['02'][1]+"' AND "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " FP0.FP0_CLI >= '"+jParams['03'][1]+"' AND "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cLinha := " FP0.FP0_CLI <= '"+jParams['04'][1]+"' AND "
    cComando := 'cQuery += cLinha '
    &(cComando)
	cQuery += " FP0.D_E_L_E_T_ = ' ' "
	cQuery += " INNER JOIN " + RetSQLName("FPY") + " FPY ON "
	cQuery += " FPY.FPY_FILIAL = '"+xFilial("FPY")+"' AND "
	cQuery += " FPY.FPY_PEDVEN = FPZ.FPZ_PEDVEN AND "
	cQuery += " FPY.FPY_STATUS = '1 ' AND "
	cQuery += " FPY.FPY_TIPFAT = 'R' AND "
	cQuery += " FPY.D_E_L_E_T_ = ' ' "
	cQuery += " INNER JOIN " + RetSQLName("SC6") + " SC6 ON "
	cQuery += " SC6.C6_FILIAL = '"+xFilial("SC6")+"' AND "
	cQuery += " SC6.C6_NUM = FPZ.FPZ_PEDVEN AND "
	cQuery += " SC6.C6_ITEM = FPZ.FPZ_ITEM AND "
	Do Case
	Case jParams['13'][1] == "1"
		cQuery += " SC6.C6_NOTA <> ' ' AND "
		cLinha := " SC6.C6_DATFAT >= '"+jParams['11'][1]+"' AND "
		cComando := 'cQuery += cLinha '
		&(cComando)
		cLinha := " SC6.C6_DATFAT <= '"+jParams['12'][1]+"' AND "
		cComando := 'cQuery += cLinha '
		&(cComando)
	Case jParams['13'][1] == "2"
		cQuery += " SC6.C6_NOTA = ' ' AND "
	Case jParams['13'][1] == "3"
		cQuery += " ((SC6.C6_NOTA <> ' ' AND "
		cLinha := " SC6.C6_DATFAT >= '"+jParams['11'][1]+"' AND "
		cComando := 'cQuery += cLinha '
		&(cComando)
		cLinha := " SC6.C6_DATFAT <= '"+jParams['12'][1]+"') OR "
		cComando := 'cQuery += cLinha '
		&(cComando)
		cQuery += " SC6.C6_NOTA = ' ') AND "
	EndCase
	cQuery += " SC6.D_E_L_E_T_ = ' ' "
	cQuery += " LEFT JOIN " + RetSQLName("CTT") + " CTT ON "
	cQuery += " CTT.CTT_FILIAL = '"+xFilial("CTT")+"' AND "
	cQuery += " CTT.CTT_CUSTO = FPZ.FPZ_CCUSTO AND "
	cQuery += " CTT.D_E_L_E_T_ = ' ' "
	cQuery += " LEFT JOIN " + RetSQLName("SB1") + " SB1 ON "
	cQuery += " SB1.B1_FILIAL = '"+xFilial("SB1")+"' AND "
	cQuery += " SB1.B1_COD = FPZ.FPZ_PROD AND "
	cLinha := " SB1.B1_COD >= '"+jParams['07'][1]+"' AND "
	cComando := 'cQuery += cLinha '
	&(cComando)
	cLinha := " SB1.B1_COD <= '"+jParams['08'][1]+"' AND "
	cComando := 'cQuery += cLinha '
	&(cComando)
	cQuery += " SB1.D_E_L_E_T_ = ' ' "
	cQuery += " LEFT JOIN  " + RetSQLName("SF4") + " SF4 ON "
	cQuery += " SF4.F4_FILIAL = '"+xFilial("SF4")+"' AND "
	cQuery += " SF4.F4_CODIGO = SC6.C6_TES AND "
	cQuery += " SF4.D_E_L_E_T_ = ' ' "
	cQuery += " WHERE FPZ.FPZ_FILIAL = '"+xFilial("FPZ")+ "' AND FPZ.D_E_L_E_T_ = ' ' "
	cLinha := " AND FPZ.FPZ_OBRA >= '"+jParams['05'][1]+"' "
	cComando := 'cQuery += cLinha '
	&(cComando)
	cLinha := " AND FPZ.FPZ_OBRA <= '"+jParams['06'][1]+"' "
	cComando := 'cQuery += cLinha '
	&(cComando)
	cLinha := " AND FPZ.FPZ_FROTA >= '"+jParams['09'][1]+"' "
	cComando := 'cQuery += cLinha '
	&(cComando)
	cLinha := " AND FPZ.FPZ_FROTA <= '"+jParams['10'][1]+"' " 
	cComando := 'cQuery += cLinha '
	&(cComando)

	oExec  := FwExecStatement():New(ChangeQuery(cQuery))
	cAlias := oExec:OpenAlias()

	(cAlias)->(DBCloseArea())
	self:setQuery(cQuery)

	//Define o campo de ordenação da query
	self:setOrder("FPY.FPY_PROJET")

return self:oData

/*/{Protheus.doc} remessas
Declaração dos parâmetros
@type method
@author Leonardo Pacheco Fuga
@since 19/09/2025
/*/
method getSchema() as object class remessas
 
	self:addProperty("Cliente",           "Cliente",              "string", "Cliente",                      "FP0_CLI")
	self:addProperty("NomeCliente",       "Nome Cliente",         "string", "Nome Cliente",                 "FP0_CLINOM")
	self:addProperty("Loja",              "Loja",                 "string", "Loja",                         "FP0_LOJA")
	self:addProperty("ItemDoPV",          "Item Do PV",           "string", "Item Do PV",                   "C6_ITEM")
	self:addProperty("Produto",           "Produto do Contrato",  "string", "Produto do Contrato",          "B1_COD")
	self:addProperty("DescricaoProduto",  "Descricao do Produto", "string", "Descricao do Produto",         "B1_DESC")
	self:addProperty("UnidadeDeMedida",   "Unidade De Medida",    "string", "Unidade De Medida",            "C6_UM")
	self:addProperty("TES",               "TES",                  "string", "TES",                          "F4_CODIGO")
	self:addProperty("DescricaoTES",      "Descricao da TES",     "string", "Descricao da TES",             "F4_TEXTO")
	self:addProperty("Armazem",           "Armazem",              "string", "Armazem",                      "C6_LOCAL")
	self:addProperty("NotaFiscal",        "Nota Fiscal",          "string", "Nota Fiscal",                  "C6_NOTA")
	self:addProperty("SerieDaNota",       "Serie Da Nota",        "string", "Serie Da Nota",                "C6_SERIE")
	self:addProperty("DataDaEmissao",     "Data Da Emissao",      "date",   "Data Da Emissao",              "C6_DATFAT")
	self:addProperty("ItemConta",         "Item Conta",           "string", "Item Conta",                   "C6_ITEMCTA")
	self:addProperty("Filial",            "Filial",               "string", "Filial",                       "FPY_FILIAL")
	self:addProperty("TipoDeFaturamento", "Tipo De Faturamento",  "string", "Tipo De Faturamento",          "FPY_TIPFAT")
	self:addProperty("Romaneio",          "Romaneio",             "string", "Romaneio",                     "FPY_NFDEVO")
	self:addProperty("NrAS",              "Nr A.S.",              "string", "Nr A.S.",                      "FPZ_AS")
	self:addProperty("PedidoDeVenda",     "Pedido De Venda",      "string", "Pedido De Venda",              "FPZ_PEDVEN")
	self:addProperty("Projeto",           "Projeto",              "string", "Projeto",                      "FPZ_PROJET")
	self:addProperty("DtPedido",          "Dt. Pedido",           "date",   "Dt. Pedido",                   "FPZ_DTPED")
	self:addProperty("DataInicio ",       "Data Inicio",          "date",   "Data Inicio ",                 "FPZ_DTINI")
	self:addProperty("DataFim",           "Data Fim",             "date",   "Data Fim",                     "FPZ_DTFIM")
	self:addProperty("Item",              "Item",                 "string", "Item",                         "FPZ_ITEM")
	self:addProperty("Frota",             "Frota",                "string", "Frota",                        "FPZ_FROTA")
	self:addProperty("PeriodoLoc",        "Periodo Loc.",         "string", "Periodo Loc.",                 "FPZ_PERLOC")
	self:addProperty("Geraem",            "Gera em",              "date",   "Gera em",                      "FPZ_GERAEM")
	self:addProperty("ItemFPZ",           "Item FPZ",             "string", "Item FPZ",                     "FPZ_ITMFPZ")
	self:addProperty("Quantidade",        "Quantidade",           "number", "Quantidade",                   "FPZ_QUANT")
	self:addProperty("ValorUnit",         "Valor Unit",           "number", "Valor Unit",                   "FPZ_VALUNI")
	self:addProperty("Total",             "Total",                "number", "Total",                        "FPZ_TOTAL")
	self:addProperty("Viagem",            "Viagem",               "string", "Viagem",                       "FPZ_VIAGEM")
	self:addProperty("NumeroDias ",       "Numero Dias",          "number", "Numero Dias",                  "FPZ_DIAS")
	self:addProperty("ClasseValor",       "Classe Valor",         "string", "Classe Valor",                 "FPZ_CLVL")
	self:addProperty("Obra",              "Obra",                 "string", "Obra",                         "FPZ_OBRA")
	self:addProperty("Medicao",           "Medicao",              "string", "Medicao",                      "FPZ_MEDICA")
	self:addProperty("CentroDeCusto",     "Centro De Custo",      "string", "Centro De Custo",              "CTT_CUSTO")
	self:addProperty("DescCentro",        "Desc. Centro",         "string", "Desc. Centro",                 "CTT_DESC01")
	
	self:addParameter("01", "Projeto de",      "string", .F., "", .F., .T., "FP0", "MV_PAR01")
	self:addParameter("02", "Projeto até",     "string", .F., "", .F., .T., "FP0", "MV_PAR02")
	self:addParameter("03", "Cliente de",      "string", .F., "", .F., .T., "SA1", "MV_PAR03")
	self:addParameter("04", "Cliente até",     "string", .F., "", .F., .T., "SA1", "MV_PAR04")
	self:addParameter("05", "Obra de",         "string", .F., "", .F., .F., ""   , "MV_PAR05")
	self:addParameter("06", "Obra até",        "string", .F., "", .F., .F., ""   , "MV_PAR06")
	self:addParameter("07", "Produto de",      "string", .F., "", .F., .T., "SB1", "MV_PAR07")
	self:addParameter("08", "Produto até",     "string", .F., "", .F., .T., "SB1", "MV_PAR08")
	self:addParameter("09", "Equipamento de",  "string", .F., "", .F., .T., "ST9", "MV_PAR09")
	self:addParameter("10", "Equipamento até", "string", .F., "", .F., .T., "ST9", "MV_PAR10")
	self:addParameter("11", "DT Ult.Fat. de",  "date"  , .F., "", .F., .F., ""   , "MV_PAR11")
	self:addParameter("12", "DT Ult.Fat. até", "date"  , .F., "", .F., .F., ""   , "MV_PAR12")
	self:addParameter("13", "Tem Nota Fiscal", "string", .F., "", .F., .F., ""   , "MV_PAR13", "1=Sim, 2=Nao, 3=Todos Ex:1", .F., {"1"})

return self:oSchema
