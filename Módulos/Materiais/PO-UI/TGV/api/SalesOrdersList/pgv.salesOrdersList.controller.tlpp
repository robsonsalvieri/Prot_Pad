#include 'tlpp-core.th'
#include 'tlpp-rest.th'
#include 'pgv.salesorderslist.controller.ch'

namespace totvs.protheus.backoffice.pgvSalesOrdersList
using namespace tgv.util

Class pgvSalesOrdersList
	data nPage as Numeric
	data nPageSize as Numeric
	data jResponse as Json
	data oService as Object

	public method new() as Object

	@Get("/api/pgv/salesorderslist")
	public method getSalesOrdersList() as Logical

	@Get("/api/pgv/salesorderslist/:dDataDe/:dDataAte")
	public method getListSalesOrderPeriod() as Logical

	@Get("/api/pgv/salesorderscard/")
	public method getSalesOrdersCard() as Logical

	@Get("/api/pgv/salesorderscard/:dDataDe/:dDataAte")
	public method getSalesOrdersCardPeriod() as Logical

	@Get("/api/pgv/salesordersbox/")
	public method getSalesOrdersBox() as Logical

	@Get("/api/pgv/salesordersbox/:dDataDe/:dDataAte")
	public method getSalesOrdersBoxPeriod() as Logical

	@Get("/api/pgv/salesorderstotval/")
	public method getSalesOrdersTotVal() as Logical

	@Get("/api/pgv/salesorderstotvalperiod/")
	public method getSalesOrdersTotValPeriod() as Logical

	@Get("/api/pgv/salesorderstopsellers/")
	public method getSalesOrdersTopSellers() as Logical

EndClass

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::new() as object
    Obter uma nova instancia da class pgvSalesOrdersList
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return @return object, retorna uma nova instancia da classe
/*/
//-----------------------------------------------------------------------
Method new() as object Class pgvSalesOrdersList
	::nPage     := 1
	::nPageSize := 10
	::jResponse := JsonObject():new()
	::oService  := pgvSalesOrdersListService():getInstance()
Return Self

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersList() as logical
    Obtem todos os itens da SC9 do mês atual referente ao vendedor logado
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersList() as logical Class pgvSalesOrdersList
	Local aItems        := {}                            as Array
	Local aURLFilter    := getFilterParam()              as Array
	Local cFields       := getQueryParam('FIELDS')       as Character
	Local cSort         := getQueryParam('SORT')         as Character
	Local cStatusFilter := getQueryParam('STATUSFILTER') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage         , ::nPageSize  , aURLFilter        , cFields           , ;
										cSort           , /*dDataDe*/  , /*dDataAte*/      , /*lCard*/         , ;
										/*lBox*/        , /*lTotVal*/  , /*lTotValPeriod*/ , /*lTopSellers*/   , ;
										 cStatusFilter))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) 
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getListSalesOrderPeriod() as logical
    Obtem todos os itens da SC9 do periodo referente ao vendedor logado
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getListSalesOrderPeriod() as logical Class pgvSalesOrdersList
	Local aItems        := {}                              as Array
	Local aURLFilter    := getFilterParam()                as Array
	Local cFields       := getQueryParam('FIELDS')         as Character
	Local cSort         := getQueryParam('SORT')           as Character
	Local dDataDe       := CTOD(getPathParams("dDataDe"))  as Date
	Local dDataAte      := CTOD(getPathParams("dDataAte")) as Date
	Local cStatusFilter := getQueryParam('STATUSFILTER')   as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage         , ::nPageSize  , aURLFilter       , cFields         , ;
										cSort           , dDataDe      , dDataAte         , /*lCard*/       , ;
										/*lBox*/        , /*lTotVal*/ , /*lTotValPeriod*/ , /*lTopSellers*/ , ;
										cStatusFilter))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) 
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getListOfInvoicedOrders() as logical
    Obtem todos os itens da SD2 do periodo referente ao vendedor logado
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersCard() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, NIL, NIL, .T. ))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersCardPeriod() as logical
    Obtem os dados dos Pedido de Vendas através de status (Aberto,Bloqueado,Faturado)
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersCardPeriod() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character
	Local dDataDe    := CTOD(getPathParams("dDataDe")) as Date
	Local dDataAte   := CTOD(getPathParams("dDataAte")) as Date

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, dDataDe, dDataAte, .T. ))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersBox() as logical
    Obtem os dados dos Produtos e clientes faturados
    @author Squad CRM & Faturamento
    @since 10/01/2024
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersBox() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, NIL, NIL, NIL, .T. ))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.


//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersBoxPeriod() as logical
    Obtem os dados dos Pedido de Vendas através de status (Aberto,Bloqueado,Faturado)
    @author Squad CRM & Faturamento
    @since 17/11/2023
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersBoxPeriod() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character
	Local dDataDe    := CTOD(getPathParams("dDataDe")) as Date
	Local dDataAte   := CTOD(getPathParams("dDataAte")) as Date

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, dDataDe, dDataAte, NIL, .T. ))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersTotVal() as logical
    Obtem os dados dos Produtos e clientes faturados
    @author Squad CRM & Faturamento
    @since 10/01/2024
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersTotVal() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, NIL, NIL, NIL, NIL, .T.))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersTotValPeriod() as logical
    Obtem os dados dos Produtos e clientes faturados
    @author Squad CRM & Faturamento
    @since 10/01/2024
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersTotValPeriod() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, NIL, NIL, NIL, NIL, .T., .T.))
	
	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.

//-----------------------------------------------------------------------
/*/{Protheus.doc} pgvSalesOrdersList::getSalesOrdersTopSellers() as logical
    Obtem os dados dos Produtos mais vendidos
    @author Squad CRM & Faturamento
    @since 23/01/2024
    @version 12.1.2310
    @return .T., boolean, retorno da requisição
/*/
//-----------------------------------------------------------------------
Method getSalesOrdersTopSellers() as logical Class pgvSalesOrdersList
	Local aItems := {} as Array
	Local aURLFilter := getFilterParam() as Array
	Local cFields    := getQueryParam('FIELDS') as Character
	Local cSort      := getQueryParam('SORT') as Character

	oRest:setKeyHeaderResponse('Content-Type','application/json')
	getPageAndPageSize(@::nPage, @::nPageSize)

	::jResponse:fromJson(::oService:get(::nPage, ::nPageSize, aURLFilter, cFields, cSort, NIL, NIL, NIL, NIL , NIL, NIL, .T.))

	aItems := ::jResponse:GetJsonObject( "items" )

	aItems := IIF( !Empty( aItems ), aItems, {})

	If ( !Empty( aItems ) .And. Len( aItems ) > 0 )
		oRest:setResponse(::jResponse)
	Else
		SetRestFault(404, FWhttpEncode(STR0001) ) //Nenhum dado encontrado
	EndIf

	aSize(aURLFilter, 0)
	aSize(aItems, 0)
Return .T.
