#INCLUDE "PROTHEUS.CH"
#INCLUDE "tlpp-core.th"
#INCLUDE "tlpp-rest.th"

class pshMonitorAnaliseTempoObj

	Public Method New()                 as Object
	Public Method SetAnaliseTempo()     as Variant
    Public Method GetJsonReturn()       as Object

    Private Method GetTempo()           as Array

    Public Data oJsonRet                as Object

EndClass

/*/{Protheus.doc} New
Metodo construtor da classe
@author Eduardo Sales
@since  13/06/2024
/*/
Method New() as Object Class pshMonitorAnaliseTempoObj

    Self:oJsonRet := JsonObject():New()
    Self:SetAnaliseTempo()

Return Self

/*/{Protheus.doc} SetAnaliseTempo
Seta o JSON de retorno
@author Eduardo Sales
@since  13/06/2024
/*/
Method SetAnaliseTempo() Class pshMonitorAnaliseTempoObj

    Local aTabelas  := Self:GetTempo() as Array
    
    Self:oJsonRet["tempo"] := JsonObject():New()
    Self:oJsonRet["tempo"] := aTabelas

Return

/*/{Protheus.doc} GetJsonReturn
Retorna o JSON de Retorno da API
@author Eduardo Sales
@since  13/06/2024
/*/
Method GetJsonReturn() as Object Class pshMonitorAnaliseTempoObj
Return EncodeUtf8( Self:oJsonRet:ToJson() )

/*/{Protheus.doc} GetTabelas
Retorna as tabelas que estão cadastradas nos grupos de tabelas ativos
@author Eduardo Sales
@since  13/06/2024
/*/
Method GetTempo() as Array Class pshMonitorAnaliseTempoObj

    Local cQuery    := ""   as Character
    Local cAliasQry := ""   as Character
    Local aTabelas  := {}   as Array

    cQuery += " SELECT TOP 10 MIY_TABELA, MIY_TEMPO "   + CRLF
    cQuery += " FROM " + RetSqlname("MIY")  + CRLF
    cQuery += " WHERE MIY_TPMED = 'GER' "   + CRLF
    cQuery += " AND D_E_L_E_T_ = ' '  "     + CRLF
    cQuery += " ORDER BY MIY_TEMPO DESC "   + CRLF

    cAliasQry := MPSysOpenQuery(cQuery)
    
    Do While (cAliasQry)->(!Eof())
        aAdd(aTabelas, {"Tabela " + AllTrim((cAliasQry)->MIY_TABELA), Val((cAliasQry)->MIY_TEMPO)})
        (cAliasQry)->(DbSkip())
    EndDo

Return aTabelas
