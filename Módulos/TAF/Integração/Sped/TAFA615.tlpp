#INCLUDE "TLPP-CORE.TH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "TAFA615.CH"

#DEFINE AQUISICAO_CANA 								"aquisicaoCana"
#DEFINE ARMAS_FOGO 									"armasFogo"
#DEFINE ARMAZENAMENTO_COMBUSTIVEIS					"armazenamentoCombustiveis"
#DEFINE CANCELAMENTOS								"cancelamentos"
#DEFINE CARGA_TRANSPORTA_DA_COLETA_ENTREGA			"cargaTransportadaColetaEntrega"
#DEFINE COMBUSTIVEL 								"combustivel"
#DEFINE COMPLEMENTO_DOCUMENTOS_INFORMADOS 			"complementoDocumentosInformados"
#DEFINE COMUNICACAO_TELECOMUNICACAO					"comunicacaoTelecomunicacao"
#DEFINE CONHECIMENTO_AEREO_CARGAS 					"conhecimentoAereoCargas"
#DEFINE CONHECIMENTO_AQUAVIARIO_CARGAS 				"conhecimentoAquaviarioCargas"
#DEFINE CONHECIMENTO_RODOVIARIO_MULTIMODAL_CARGAS	"conhecimentoRodoviarioMultimodalCargas"
#DEFINE CONHECIMENTO_TRANSPORTE						"conhecimentoTransporte"
#DEFINE CREDITO_ICMS_ACUMULADO						"creditoICMSAcumulado"
#DEFINE CUPOM_FISCAL_REFERENCIADO  					"cupomFiscalReferenciado"
#DEFINE DEDUCAO										"deducao"
#DEFINE DEDUCOES									"deducoes"
#DEFINE DEDUCOES_TAXAS_CONTRIBUICOES				"deducoesTaxasContribuicoes"
#DEFINE DEPENDENTES									"dependentes"
#DEFINE DEPENDENTES_BENEFICIARIOS					"dependentesBeneficiarios" 
#DEFINE DOCUMENTOS_ARRECADACAO_REFERENCIADOS		"documentosArrecadacaoReferenciados"
#DEFINE DOCUMENTOS_FISCAIS							"documentosFiscais"
#DEFINE DOCUMENTOS_FISCAIS_REFERENCIADOS			"documentosFiscaisReferenciados"
#DEFINE ENERGIA_ELETRICA_AGUA_GAS					"energiaEletricaAguaGas"
#DEFINE ENERGIA_ELETRICA_GAS_AGUA					"energiaEletricaGasAgua"
#DEFINE FATURAS										"faturas"
#DEFINE FORNECIMENTO_DIARIO_CANA					"fornecimentoDiarioCana"		
#DEFINE ICMSST_RECOLHIDO_OUTRAS_UFS					"icmsSTRecolhidoOutrasUFs"
#DEFINE IDENTIFICACAO_DOCUMENTOS_FISCAIS			"identificacaoDocumentosFiscais"
#DEFINE IMPORTACAO 									"importacao"
#DEFINE INFORMACOES_COMPLEMENTARES 					"informacoesComplementares"
#DEFINE INFORMACOES_ESPECIFICAS_COMPLEMENTARES		"informacoesEspecificasComplementares"
#DEFINE ISENSAO										"isensao"
#DEFINE ITENS 										"itens"
#DEFINE LANCAMENTOS_FISCAIS							"lancamentosFiscais"
#DEFINE LOCAL_COLETA_ENTREGA						"localColetaEntrega"
#DEFINE MEDICAMENTOS 								"medicamentos"
#DEFINE MODAIS_TRANSPORTE							"modaisTransporte"				
#DEFINE OBSERVACOES_LANCAMENTOS_FISCAIS				"observacoesLancamentosFiscais"
#DEFINE PROCESSOS_REFERENCIADOS						"processosReferenciados"
#DEFINE RESSARCIMENTOS_ICMSST						"ressarcimentosICMSST"
#DEFINE SERVICO_TRANSPORTE							"servicoTransporte"
#DEFINE TOTAIS 										"totais"
#DEFINE TRIBUTOS 									"tributos"
#DEFINE VALORES_TRIBUTO								"valoresTributo"
#DEFINE VEICULOS_NOVOS								"veiculosNovos"
#DEFINE VENCIMENTOS									"vencimentos"
#DEFINE INF_ADIC_AJUSTES_APURACAO_IPI				"infAdicAjustesIpi"

#DEFINE PENDING_STATUS 								"0"
#DEFINE SUCCESS_STATUS 								"2"
#DEFINE FLUSH_DATA_LIMIT 							500
#DEFINE COMMIT_DATA_LIMIT 							50

Static __aStringSize	:= Nil as array
Static __jFields 		:= Nil as json
Static __jIndexes 		:= Nil as json
Static __jBulks 		:= Nil as json
Static __oError 		:= Nil as object
Static __oStatusUpdate	:= Nil as object
Static __oUpdateC20		:= Nil as object

//-----------------------------------------------------------------------------------
/*/{Protheus.doc} TAFFiscalDocumentInsert
@type			function
@description	Inicia o processo de gravação dos documentos fiscais respeitando
				o limite definido na constante COMMIT_DATA_LIMIT
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          jDocumentos - JSON contendo os documentos fiscais a serem integrados
@return			Nil 
/*/
//-----------------------------------------------------------------------------------
Function TAFFiscalDocumentInsert(jDocumentos as json)

	Local aDocumentos := {} as array
	Local iDocumentos := 0 as integer
	Local iDataCount := 0 as integer
	Local iX := 0 as integer
	Local iTamCliFor := 0 as integer
	Local iTamLoja := 0 as integer

	Private aDadosLog := {} as array
	Private cKeyErp := "" as character

	Default jDocumentos := Nil

	If jDocumentos != Nil
		iTamCliFor 	:= GetSX3Cache("FT_CLIEFOR", "X3_TAMANHO")
	 	iTamLoja 	:= GetSX3Cache("FT_LOJA", "X3_TAMANHO")
		
		InitError()

		iDocumentos := Len(jDocumentos[DOCUMENTOS_FISCAIS])

		For iX := 1 To iDocumentos
			If jDocumentos[DOCUMENTOS_FISCAIS][iX] != Nil
				//Guardo a chave do documento fiscal atual, para ser usado na gravação do log caso ocorra algum erro.
				cKeyErp	:= jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_INDOPE'] + '|' 
				cKeyErp += jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_DTDOC' ] + '|' 
				cKeyErp += jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_SERIE' ] + '|'  
				cKeyErp += jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_NUMDOC'] + '|' 
				cKeyErp += SubStr(LTrim(jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_CODPAR']), 2, iTamCliFor) + '|' //Cliente ou fornecedor
				cKeyErp += Right(RTrim(jDocumentos[DOCUMENTOS_FISCAIS][iX]['C20_CODPAR']), iTamLoja) //Loja

				iDataCount++
				AAdd(aDocumentos, jDocumentos[DOCUMENTOS_FISCAIS][iX])
			EndIf

			If iDataCount == COMMIT_DATA_LIMIT .Or. iX == iDocumentos
				ClearError()
				InitTransaction(aDocumentos)

				iDataCount := 0
				aDocumentos := {}
			EndIf
		Next

		FWFreeArray(aDocumentos)
		FWFreeOBJ(__oError)
	EndIf

Return


//---------------------------------------------------------------------
/*/{Protheus.doc} InitError
@type			function
@description	Cria uma estância da classe ErrorClass()
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function InitError()

	If __oError == Nil
		__oError := ErrorClass():New()
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} ClearError
@type			function
@description	Limpa o atributo __oError:Description
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function ClearError()

	__oError:Description := ""

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} SetStatus
@type			static function
@description	Atualiza o status do documento fiscal
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          aDocumentos - Documentos fiscais que terão seus status alterados
@param          cStatus - Status a ser atualizado
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function SetStatus(aDocumentos as array, cStatus as character)

	Local aCHVNF := {} as array
	Local cQuery := "" as character
	Local cIN := "" as character
	Local iDataCount := 0 as integer
	Local iDocumentos := 0 as integer
	Local iX := 0 as integer

	Default cStatus := ""
	Default aDocumentos := {}

	If !Empty(cStatus) .And. !Empty(aDocumentos)
		If __oStatusUpdate == Nil
			cQuery := " UPDATE " + RetSQLName("C20")
			cQuery += " SET C20_STATUS = ? "
			cQuery += " WHERE D_E_L_E_T_ = ' ' AND C20_FILIAL = ? AND C20_CHVNF IN (?)"

			__oStatusUpdate := FwExecStatement():New(cQuery)
		EndIf

		iDocumentos := Len(aDocumentos)

		For iX := 1 To iDocumentos
			iDataCount++

			If aDocumentos[iX] != Nil .And. aDocumentos[iX]:HasProperty("C20_CHVNF") .And. !Empty(aDocumentos[iX]["C20_CHVNF"])
				AAdd(aCHVNF, aDocumentos[iX]["C20_CHVNF"])
			EndIf

			If !Empty(aCHVNF) .And. (iDataCount == COMMIT_DATA_LIMIT .Or. iX == iDocumentos)
				BEGIN TRANSACTION

					TRY

						If __oStatusUpdate != Nil
							__oStatusUpdate:SetString(1, cStatus)
							__oStatusUpdate:SetString(2, xFilial("C20"))
							__oStatusUpdate:SetIn(3, aCHVNF)

							cQuery 	:= __oStatusUpdate:GetFixQuery()
							
							If !TAFExecQuery(cQuery)
								THROW __oError
							EndIf
						EndIf

					CATCH __oError

						DisarmTransaction()
						TAFConout(__oError:Description, 3)

						FINALLY

						aCHVNF		:= {}
						cIN 		:= ""
						iDataCount 	:= 0

					ENDTRY

				END TRANSACTION
			EndIf
		Next
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} TAFExecQuery
@type			function
@description	Executa a query informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cQuery - Query a ser executada
@param          lBulk - .T. se query possui múltiplos UPDATEs ou DELETEs
@param          cError - Retorno da mensagem de erro passada por referência
@return			lRet - .T. se a query foi executada com sucesso
/*/
//---------------------------------------------------------------------
Function TAFExecQuery(cQuery as character, lBulk as logical, cError as character) as logical

	Local lRet := .F. as logical

	Default cQuery 	:= ""
	Default lBulk 	:= .F.
	
	If TAFGetDB() == "ORACLE" .And. lBulk
		cQuery := " BEGIN " + cQuery + " END; "
	EndIf

	lRet := TCSQLExec(cQuery) >= 0

	If TAFGetDB() == "ORACLE" .And. lRet .And. lBulk
		lRet := TCSQLExec("COMMIT") >= 0
	EndIf

	If !lRet
		cError := TCSQLError()
	EndIf

Return lRet

//---------------------------------------------------------------------
/*/{Protheus.doc} InitTransaction
@type			function
@description	Inicia a transação de gravação dos documentos fiscais
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          aDocumentos - Array contendo os documentos fiscais a serem integrados
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function InitTransaction(aDocumentos as array)

	Local cError := "" as character

	Private oStPesquisaLog 	:= Nil as object

	Default aDocumentos := {}

	If !Empty(aDocumentos)
		BEGIN TRANSACTION

			TRY

				If !TAFExecQuery(UpdateC20FieldsQuery(aDocumentos), .T., @cError)
					THROW __oError
				EndIf

				FlushDocumentsData(aDocumentos)
				
			CATCH __oError

				DisarmTransaction()
				LogIntegra({"C20", "", STR0009, cError, .F.}, "")
				TAFConout(__oError:Description, 3)
				SetStatus(aDocumentos, PENDING_STATUS)

			FINALLY

				ClearCachedData()

			ENDTRY

		END TRANSACTION
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} FlushDocumentsData
@type			function
@description	Realiza o despejo dos dados referentes aos documentos fiscais
				respeitando o limite definido na constante FLUSH_DATA_LIMIT
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          aData - Array contendo os dados dos documentos fiscais
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function FlushDocumentsData(aData as array) as logical

	Local aC21 := {} as array
	Local aC22 := {} as array
	Local aC23 := {} as array
	Local aC24 := {} as array
	Local aC25 := {} as array
	Local aC26 := {} as array
	Local aC27 := {} as array
	Local aC28 := {} as array
	Local aC2A := {} as array
	Local aC2B := {} as array
	Local aC2C := {} as array
	Local aC2D := {} as array
	Local aC2E := {} as array
	Local aC2F := {} as array
	Local aC2G := {} as array
	Local aC2H := {} as array
	Local aC2I := {} as array
	Local aC30 := {} as array
	Local aC31 := {} as array
	Local aC32 := {} as array
	Local aC33 := {} as array
	Local aC34 := {} as array
	Local aC35 := {} as array
	Local aC36 := {} as array
	Local aC37 := {} as array
	Local aC38 := {} as array
	Local aC39 := {} as array
	Local aC3A := {} as array
	Local aC3F := {} as array
	Local aC3G := {} as array
	Local aC3H := {} as array
	Local aC3I := {} as array
	Local aC6W := {} as array
	Local aC7B := {} as array
	Local aCAI := {} as array
	Local aCH1 := {} as array
	Local aCH2 := {} as array
	Local aT00 := {} as array
	Local aT60 := {} as array
	Local aT9Q := {} as array
	Local aV84 := {} as array
	Local aV88 := {} as array
	Local aV94 := {} as array
	Local aV4C := {} as array
	Local aV4D := {} as array
	Local aCWW := {} as array
	Local aErrors := {} as array
	Local iC21 := 0 as integer
	Local iC22 := 0 as integer
	Local iC23 := 0 as integer
	Local iC24 := 0 as integer
	Local iC25 := 0 as integer
	Local iC26 := 0 as integer
	Local iC27 := 0 as integer
	Local iC28 := 0 as integer
	Local iC2A := 0 as integer
	Local iC2B := 0 as integer
	Local iC2C := 0 as integer
	Local iC2D := 0 as integer
	Local iC2E := 0 as integer
	Local iC2F := 0 as integer
	Local iC2G := 0 as integer
	Local iC2H := 0 as integer
	Local iC2I := 0 as integer
	Local iC30 := 0 as integer
	Local iC31 := 0 as integer
	Local iC32 := 0 as integer
	Local iC33 := 0 as integer
	Local iC34 := 0 as integer
	Local iC35 := 0 as integer
	Local iC36 := 0 as integer
	Local iC37 := 0 as integer
	Local iC38 := 0 as integer
	Local iC39 := 0 as integer
	Local iC3A := 0 as integer
	Local iC3F := 0 as integer
	Local iC3G := 0 as integer
	Local iC3H := 0 as integer
	Local iC3I := 0 as integer
	Local iC6W := 0 as integer
	Local iC7B := 0 as integer
	Local iCAI := 0 as integer
	Local iCH1 := 0 as integer
	Local iCH2 := 0 as integer
	Local iT00 := 0 as integer
	Local iT60 := 0 as integer
	Local iT9Q := 0 as integer
	Local iV84 := 0 as integer
	Local iV88 := 0 as integer
	Local iV94 := 0 as integer
	Local iV4C := 0 as integer
	Local iV4D := 0 as integer
	Local iCWW as integer
	Local iData := 0 as integer
	Local jC29 := Nil as json
	Local jData := Nil as json
	Local oC21 := Nil as object
	Local oC22 := Nil as object
	Local oC23 := Nil as object
	Local oC24 := Nil as object
	Local oC25 := Nil as object
	Local oC26 := Nil as object
	Local oC27 := Nil as object
	Local oC28 := Nil as object
	Local oC29 := Nil as object
	Local oC2A := Nil as object
	Local oC2B := Nil as object
	Local oC2C := Nil as object
	Local oC2D := Nil as object
	Local oC2E := Nil as object
	Local oC2F := Nil as object
	Local oC2G := Nil as object
	Local oC2H := Nil as object
	Local oC2I := Nil as object
	Local oC30 := Nil as object
	Local oC31 := Nil as object
	Local oC32 := Nil as object
	Local oC33 := Nil as object
	Local oC34 := Nil as object
	Local oC35 := Nil as object
	Local oC36 := Nil as object
	Local oC37 := Nil as object
	Local oC38 := Nil as object
	Local oC39 := Nil as object
	Local oC3A := Nil as object
	Local oC3F := Nil as object
	Local oC3G := Nil as object
	Local oC3H := Nil as object
	Local oC3I := Nil as object
	Local oC6W := Nil as object
	Local oC7B := Nil as object
	Local oCAI := Nil as object
	Local oCH1 := Nil as object
	Local oCH2 := Nil as object
	Local oT00 := Nil as object
	Local oT60 := Nil as object
	Local oT9Q := Nil as object
	Local oV84 := Nil as object
	Local oV88 := Nil as object
	Local oV94 := Nil as object
	Local oV4C := Nil as object
	Local oV4D := Nil as object
	Local oCWW as object

	Default aData := {}

	If !Empty(aData)
		For iData := 1 To Len(aData)
			jData := aData[iData]
			aData[iData]["C20_STATUS"] := SUCCESS_STATUS

			If jData != Nil
				If jData:HasProperty(INFORMACOES_ESPECIFICAS_COMPLEMENTARES)
					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(INFORMACOES_COMPLEMENTARES)
						aC21 := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][INFORMACOES_COMPLEMENTARES]

						GetBulk("C21", @oC21)

						For iC21 := 1 To Len(aC21)
							aC21[iC21]["C21_FILIAL"] := jData["C20_FILIAL"]
							aC21[iC21]["C21_CHVNF"]  := jData["C20_CHVNF"]

							If oC21:AddData(GetValues("C21", aC21[iC21]))
								If aC21[iC21]:HasProperty(PROCESSOS_REFERENCIADOS)
									aC22 := aC21[iC21][PROCESSOS_REFERENCIADOS]

									GetBulk("C22", @oC22)

									For iC22 := 1 To Len(aC22)
										aC22[iC22]["C22_FILIAL"] := jData["C20_FILIAL"]
										aC22[iC22]["C22_CHVNF"] := jData["C20_CHVNF"]
										aC22[iC22]["C22_CODINF"] := aC21[iC21]["C21_CODINF"]

										If !oC22:AddData(GetValues("C22", aC22[iC22]))
											Exit
										EndIf
									Next

									If !Empty(oC22:GetError()) .Or. !oC22:Flush()
										ErrorHandler(oC22:GetError(), "C22", aC22, @aErrors)
										InitBulk("C22", @oC22)
									EndIf
								EndIf

								If aC21[iC21]:HasProperty(DOCUMENTOS_ARRECADACAO_REFERENCIADOS)
									aC25 := aC21[iC21][DOCUMENTOS_ARRECADACAO_REFERENCIADOS]

									GetBulk("C25", @oC25)

									For iC25 := 1 To Len(aC25)
										aC25[iC25]["C25_FILIAL"] := jData["C20_FILIAL"]
										aC25[iC25]["C25_CHVNF"] := jData["C20_CHVNF"]
										aC25[iC25]["C25_CODINF"] := aC21[iC21]["C21_CODINF"]

										If !oC25:AddData(GetValues("C25", aC25[iC25]))
											Exit
										EndIf
									Next

									If !Empty(oC25:GetError()) .Or. !oC25:Flush()
										ErrorHandler(oC25:GetError(), "C25", aC25, @aErrors)
										InitBulk("C25", @oC25)
									EndIf
								EndIf

								If aC21[iC21]:HasProperty(DOCUMENTOS_FISCAIS_REFERENCIADOS)
									If aC21[iC21][DOCUMENTOS_FISCAIS_REFERENCIADOS]:HasProperty(DOCUMENTOS_FISCAIS)
										aC26 := aC21[iC21][DOCUMENTOS_FISCAIS_REFERENCIADOS][DOCUMENTOS_FISCAIS]

										GetBulk("C26", @oC26)

										For iC26 := 1 To Len(aC26)
											aC26[iC26]["C26_FILIAL"] := jData["C20_FILIAL"]
											aC26[iC26]["C26_CHVNF"] := jData["C20_CHVNF"]
											aC26[iC26]["C26_CODINF"] := aC21[iC21]["C21_CODINF"]

											If !oC26:AddData(GetValues("C26", aC26[iC26]))
												Exit
											EndIf
										Next

										If !Empty(oC26:GetError()) .Or. !oC26:Flush()
											ErrorHandler(oC26:GetError(), "C26", aC26, @aErrors)
											InitBulk("C26", @oC26)
										EndIf
									EndIf

									If aC21[iC21][DOCUMENTOS_FISCAIS_REFERENCIADOS]:HasProperty(CUPOM_FISCAL_REFERENCIADO)
										aC27 := aC21[iC21][DOCUMENTOS_FISCAIS_REFERENCIADOS][CUPOM_FISCAL_REFERENCIADO]

										GetBulk("C27", @oC27)

										For iC27 := 1 To Len(aC27)
											aC27[iC27]["C27_FILIAL"] := jData["C20_FILIAL"]
											aC27[iC27]["C27_CHVNF"] := jData["C20_CHVNF"]
											aC27[iC27]["C27_CODINF"] := aC21[iC21]["C21_CODINF"]

											If !oC27:AddData(GetValues("C27", aC27[iC27]))
												Exit
											EndIf
										Next

										If !Empty(oC27:GetError()) .Or. !oC27:Flush()
											ErrorHandler(oC27:GetError(), "C27", aC27, @aErrors)
											InitBulk("C27", @oC27)
										EndIf
									EndIf
								EndIf

								If aC21[iC21]:HasProperty(LOCAL_COLETA_ENTREGA)
									aC28 := aC21[iC21][LOCAL_COLETA_ENTREGA]

									GetBulk("C28", @oC28)

									For iC28 := 1 To Len(aC28)
										aC28[iC28]["C28_FILIAL"] := jData["C20_FILIAL"]
										aC28[iC28]["C28_CHVNF"] := jData["C20_CHVNF"]
										aC28[iC28]["C28_CODINF"] := aC21[iC21]["C21_CODINF"]

										If !oC28:AddData(GetValues("C28", aC28[iC28]))
											Exit
										EndIf
									Next

									If !Empty(oC28:GetError()) .Or. !oC28:Flush()
										ErrorHandler(oC28:GetError(), "C28", aC28, @aErrors)
										InitBulk("C28", @oC28)
									EndIf
								EndIf
							Else
								Exit
							EndIf
						Next

						If !Empty(oC21:GetError()) .Or. !oC21:Flush()
							ErrorHandler(oC21:GetError(), "C21", aC21, @aErrors)
							InitBulk("C21", @oC21)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(IMPORTACAO)
						aC23 := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][IMPORTACAO]

						GetBulk("C23", @oC23)

						For iC23 := 1 To Len(aC23)
							aC23[iC23]["C23_FILIAL"] := jData["C20_FILIAL"]
							aC23[iC23]["C23_CHVNF"] := jData["C20_CHVNF"]

							If !oC23:AddData(GetValues("C23", aC23[iC23]))
								Exit
							EndIf
						Next

						If !Empty(oC23:GetError()) .Or. !oC23:Flush()
							ErrorHandler(oC23:GetError(), "C23", aC23, @aErrors)
							InitBulk("C23", @oC23)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(MODAIS_TRANSPORTE)
						aC24 := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][MODAIS_TRANSPORTE]

						GetBulk("C24", @oC24)

						For iC24 := 1 To Len(aC24)
							aC24[iC24]["C24_FILIAL"] := jData["C20_FILIAL"]
							aC24[iC24]["C24_CHVNF"] := jData["C20_CHVNF"]

							If !oC24:AddData(GetValues("C24", aC24[iC24]))
								Exit
							EndIf
						Next

						If !Empty(oC24:GetError()) .Or. !oC24:Flush()
							ErrorHandler(oC24:GetError(), "C24", aC24, @aErrors)
							InitBulk("C24", @oC24)
						EndIf
					EndIf
					
					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(COMBUSTIVEL)
						aC2B := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][COMBUSTIVEL]

						GetBulk("C2B", @oC2B)

						For iC2B := 1 To Len(aC2B)
							aC2B[iC2B]["C2B_FILIAL"] := jData["C20_FILIAL"]
							aC2B[iC2B]["C2B_CHVNF"] := jData["C20_CHVNF"]

							If !oC2B:AddData(GetValues("C2B", aC2B[iC2B]))
								Exit
							EndIf
						Next

						If !Empty(oC2B:GetError()) .Or. !oC2B:Flush()
							ErrorHandler(oC2B:GetError(), "C2B", aC2B, @aErrors)
							InitBulk("C2B", @oC2B)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(OBSERVACOES_LANCAMENTOS_FISCAIS)
						aC2C := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][OBSERVACOES_LANCAMENTOS_FISCAIS]

						GetBulk("C2C", @oC2C)

						For iC2C := 1 To Len(aC2C)
							aC2C[iC2C]["C2C_FILIAL"] := jData["C20_FILIAL"]
							aC2C[iC2C]["C2C_CHVNF"] := jData["C20_CHVNF"]

							If !oC2C:AddData(GetValues("C2C", aC2C[iC2C]))
								Exit
							EndIf
						Next

						If !Empty(oC2C:GetError()) .Or. !oC2C:Flush()
							ErrorHandler(oC2C:GetError(), "C2C", aC2C, @aErrors)
							InitBulk("C2C", @oC2C)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(LANCAMENTOS_FISCAIS)
						aC2D := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][LANCAMENTOS_FISCAIS]

						GetBulk("C2D", @oC2D)

						For iC2D := 1 To Len(aC2D)
							aC2D[iC2D]["C2D_FILIAL"] := jData["C20_FILIAL"]
							aC2D[iC2D]["C2D_CHVNF"] := jData["C20_CHVNF"]

							If oC2D:AddData(GetValues("C2D", aC2D[iC2D]))
								If aC2D[iC2D]:HasProperty(CREDITO_ICMS_ACUMULADO)
									aT00 := aC2D[iC2D][CREDITO_ICMS_ACUMULADO]

									GetBulk("T00", @oT00)

									For iT00 := 1 To Len(aT00)
										aT00[iT00]["T00_FILIAL"] := jData["C20_FILIAL"]
										aT00[iT00]["T00_CHVNF"] := jData["C20_CHVNF"]
										aT00[iT00]["T00_ID"] := aC2D[iC2D]["C2D_ID"]
										aT00[iT00]["T00_IDSUBI"] := aC2D[iC2D]["C2D_IDSUBI"]

										If !oT00:AddData(GetValues("T00", aT00[iT00]))
											Exit
										EndIf
									Next

									If !Empty(oT00:GetError()) .Or. !oT00:Flush()
										ErrorHandler(oT00:GetError(), "T00", aT00, @aErrors)
										InitBulk("T00", @oT00)
									EndIf
								EndIf
							Else
								Exit
							EndIf
						Next

						If !Empty(oC2D:GetError()) .Or. !oC2D:Flush()
							ErrorHandler(oC2D:GetError(), "C2D", aC2D, @aErrors)
							InitBulk("C2D", @oC2D)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(INF_ADIC_AJUSTES_APURACAO_IPI)
						aCWW := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][INF_ADIC_AJUSTES_APURACAO_IPI]

						GetBulk("CWW", @oCWW)

						For iCWW := 1 To Len(aCWW)
							aCWW[iCWW]["CWW_FILIAL"] := jData["C20_FILIAL"]
							aCWW[iCWW]["CWW_CHVNF" ] := jData["C20_CHVNF"]

							If !oCWW:AddData(GetValues("CWW", aCWW[iCWW]))
								Exit
							EndIf							
						Next

						If !Empty(oCWW:GetError()) .Or. !oCWW:Flush()
							ErrorHandler(oCWW:GetError(), "CWW", aCWW, @aErrors)
							InitBulk("CWW", @oCWW)
						EndIf
					EndIf					

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(ENERGIA_ELETRICA_GAS_AGUA)
						aC2E := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][ENERGIA_ELETRICA_GAS_AGUA]

						GetBulk("C2E", @oC2E)

						For iC2E := 1 To Len(aC2E)
							aC2E[iC2E]["C2E_FILIAL"] := jData["C20_FILIAL"]
							aC2E[iC2E]["C2E_CHVNF"] := jData["C20_CHVNF"]

							If !oC2E:AddData(GetValues("C2E", aC2E[iC2E]))
								Exit
							EndIf
						Next

						If !Empty(oC2E:GetError()) .Or. !oC2E:Flush()
							ErrorHandler(oC2E:GetError(), "C2E", aC2E, @aErrors)
							InitBulk("C2E", @oC2E)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(COMUNICACAO_TELECOMUNICACAO)
						aC2G := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][COMUNICACAO_TELECOMUNICACAO]

						GetBulk("C2G", @oC2G)

						For iC2G := 1 To Len(aC2G)
							aC2G[iC2G]["C2G_FILIAL"] := jData["C20_FILIAL"]
							aC2G[iC2G]["C2G_CHVNF"] := jData["C20_CHVNF"]

							If !oC2G:AddData(GetValues("C2G", aC2G[iC2G]))
								Exit
							EndIf
						Next

						If !Empty(oC2G:GetError()) .Or. !oC2G:Flush()
							ErrorHandler(oC2G:GetError(), "C2G", aC2G, @aErrors)
							InitBulk("C2G", @oC2G)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(ICMSST_RECOLHIDO_OUTRAS_UFS)
						aC2H := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][ICMSST_RECOLHIDO_OUTRAS_UFS]

						GetBulk("C2H", @oC2H)

						For iC2H := 1 To Len(aC2H)
							aC2H[iC2H]["C2H_FILIAL"] := jData["C20_FILIAL"]
							aC2H[iC2H]["C2H_CHVNF"] := jData["C20_CHVNF"]

							If !oC2H:AddData(GetValues("C2H", aC2H[iC2H]))
								Exit
							EndIf
						Next

						If !Empty(oC2H:GetError()) .Or. !oC2H:Flush()
							ErrorHandler(oC2H:GetError(), "C2H", aC2H, @aErrors)
							InitBulk("C2H", @oC2H)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(CANCELAMENTOS)
						aC2I := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][CANCELAMENTOS]

						GetBulk("C2I", @oC2I)

						For iC2I := 1 To Len(aC2I)
							aC2I[iC2I]["C2I_FILIAL"] := jData["C20_FILIAL"]
							aC2I[iC2I]["C2I_CHVNF"] := jData["C20_CHVNF"]

							If !oC2I:AddData(GetValues("C2I", aC2I[iC2I]))
								Exit
							EndIf
						Next

						If !Empty(oC2I:GetError()) .Or. !oC2I:Flush()
							ErrorHandler(oC2I:GetError(), "C2I", aC2I, @aErrors)
							InitBulk("C2I", @oC2I)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(CARGA_TRANSPORTA_DA_COLETA_ENTREGA)
						aC3A := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][CARGA_TRANSPORTA_DA_COLETA_ENTREGA]

						GetBulk("C3A", @oC3A)

						For iC3A := 1 To Len(aC3A)
							aC3A[iC3A]["C3A_FILIAL"] := jData["C20_FILIAL"]
							aC3A[iC3A]["C3A_CHVNF"] := jData["C20_CHVNF"]

							If !oC3A:AddData(GetValues("C3A", aC3A[iC3A]))
								Exit
							EndIf
						Next

						If !Empty(oC3A:GetError()) .Or. !oC3A:Flush()
							ErrorHandler(oC3A:GetError(), "C3A", aC3A, @aErrors)
							InitBulk("C3A", @oC3A)
						EndIf
					EndIf
					
					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(CONHECIMENTO_RODOVIARIO_MULTIMODAL_CARGAS)
						aC3F := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][CONHECIMENTO_RODOVIARIO_MULTIMODAL_CARGAS]

						GetBulk("C3F", @oC3F)

						For iC3F := 1 To Len(aC3F)
							aC3F[iC3F]["C3F_FILIAL"] := jData["C20_FILIAL"]
							aC3F[iC3F]["C3F_CHVNF"] := jData["C20_CHVNF"]

							If !oC3F:AddData(GetValues("C3F", aC3F[iC3F]))
								Exit
							EndIf
						Next

						If !Empty(oC3F:GetError()) .Or. !oC3F:Flush()
							ErrorHandler(oC3F:GetError(), "C3F", aC3F, @aErrors)
							InitBulk("C3F", @oC3F)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(CONHECIMENTO_AQUAVIARIO_CARGAS)
						aC3G := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][CONHECIMENTO_AQUAVIARIO_CARGAS]

						GetBulk("C3G", @oC3G)

						For iC3G := 1 To Len(aC3G)
							aC3G[iC3G]["C3G_FILIAL"] := jData["C20_FILIAL"]
							aC3G[iC3G]["C3G_CHVNF"] := jData["C20_CHVNF"]

							If !oC3G:AddData(GetValues("C3G", aC3G[iC3G]))
								Exit
							EndIf
						Next

						If !Empty(oC3G:GetError()) .Or. !oC3G:Flush()
							ErrorHandler(oC3G:GetError(), "C3G", aC3G, @aErrors)
							InitBulk("C3G", @oC3G)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(CONHECIMENTO_AEREO_CARGAS)
						aC3H := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][CONHECIMENTO_AEREO_CARGAS]

						GetBulk("C3H", @oC3H)

						For iC3H := 1 To Len(aC3H)
							aC3H[iC3H]["C3H_FILIAL"] := jData["C20_FILIAL"]
							aC3H[iC3H]["C3H_CHVNF"] := jData["C20_CHVNF"]

							If !oC3H:AddData(GetValues("C3H", aC3H[iC3H]))
								Exit
							EndIf
						Next

						If !Empty(oC3H:GetError()) .Or. !oC3H:Flush()
							ErrorHandler(oC3H:GetError(), "C3H", aC3H, @aErrors)
							InitBulk("C3H", @oC3H)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(IDENTIFICACAO_DOCUMENTOS_FISCAIS)
						aC3I := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][IDENTIFICACAO_DOCUMENTOS_FISCAIS]

						GetBulk("C3I", @oC3I)

						For iC3I := 1 To Len(aC3I)
							aC3I[iC3I]["C3I_FILIAL"] := jData["C20_FILIAL"]
							aC3I[iC3I]["C3I_CHVNF"] := jData["C20_CHVNF"]

							If !oC3I:AddData(GetValues("C3I", aC3I[iC3I]))
								Exit
							EndIf
						Next

						If !Empty(oC3I:GetError()) .Or. !oC3I:Flush()
							ErrorHandler(oC3I:GetError(), "C3I", aC3I, @aErrors)
							InitBulk("C3I", @oC3I)
						EndIf
					EndIf
					
					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(PROCESSOS_REFERENCIADOS)
						aC6W := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][PROCESSOS_REFERENCIADOS]

						GetBulk("C6W", @oC6W)

						For iC6W := 1 To Len(aC6W)
							aC6W[iC6W]["C6W_FILIAL"] := jData["C20_FILIAL"]
							aC6W[iC6W]["C6W_CHVNF"] := jData["C20_CHVNF"]

							If !oC6W:AddData(GetValues("C6W", aC6W[iC6W]))
								Exit
							EndIf
						Next

						If !Empty(oC6W:GetError()) .Or. !oC6W:Flush()
							ErrorHandler(oC6W:GetError(), "C6W", aC6W, @aErrors)
							InitBulk("C6W", @oC6W)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(COMPLEMENTO_DOCUMENTOS_INFORMADOS)
						aC7B := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][COMPLEMENTO_DOCUMENTOS_INFORMADOS]

						GetBulk("C7B", @oC7B)

						For iC7B := 1 To Len(aC7B)
							aC7B[iC7B]["C7B_FILIAL"] := jData["C20_FILIAL"]
							aC7B[iC7B]["C7B_CHVNF"] := jData["C20_CHVNF"]

							If !oC7B:AddData(GetValues("C7B", aC7B[iC7B]))
								Exit
							EndIf
						Next

						If !Empty(oC7B:GetError()) .Or. !oC7B:Flush()
							ErrorHandler(oC7B:GetError(), "C7B", aC7B, @aErrors)
							InitBulk("C7B", @oC7B)
						EndIf
					EndIf

					If jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES]:HasProperty(AQUISICAO_CANA)
						aCAI := jData[INFORMACOES_ESPECIFICAS_COMPLEMENTARES][AQUISICAO_CANA]

						GetBulk("CAI", @oCAI)

						For iCAI := 1 To Len(aCAI)
							aCAI[iCAI]["CAI_FILIAL"] := jData["C20_FILIAL"]
							aCAI[iCAI]["CAI_CHVNF"] := jData["C20_CHVNF"]

							If oCAI:AddData(GetValues("CAI", aCAI[iCAI]))
								If aCAI[iCAI]:HasProperty(FORNECIMENTO_DIARIO_CANA)
									aCH1 := aCAI[iCAI][FORNECIMENTO_DIARIO_CANA]

									GetBulk("CH1", @oCH1)

									For iCH1 := 1 To Len(aCH1)
										aCH1[iCH1]["CH1_FILIAL"] := jData["C20_FILIAL"]
										aCH1[iCH1]["CH1_CHVNF"] := jData["C20_CHVNF"]
										aCH1[iCH1]["CH1_SAFRA"] := aCAI[iCAI]["CAI_SAFRA"]
										aCH1[iCH1]["CH1_REFER"] := aCAI[iCAI]["CAI_REFER"]

										If !oCH1:AddData(GetValues("CH1", aCH1[iCH1]))
											Exit
										EndIf
									Next

									If !Empty(oCH1:GetError()) .Or. !oCH1:Flush()
										ErrorHandler(oCH1:GetError(), "CH1", aCH1, @aErrors)
										InitBulk("CH1", @oCH1)
									EndIf
								EndIf

								If aCAI[iCAI]:HasProperty(DEDUCOES_TAXAS_CONTRIBUICOES)
									aCH2 := aCAI[iCAI][DEDUCOES_TAXAS_CONTRIBUICOES]

									GetBulk("CH2", @oCH2)

									For iCH2 := 1 To Len(aCH2)
										aCH2[iCH2]["CH2_FILIAL"] := jData["C20_FILIAL"]
										aCH2[iCH2]["CH2_CHVNF"] := jData["C20_CHVNF"]
										aCH2[iCH2]["CH2_SAFRA"] := aCAI[iCAI]["CAI_SAFRA"]
										aCH2[iCH2]["CH2_REFER"] := aCAI[iCAI]["CAI_REFER"]

										If !oCH2:AddData(GetValues("CH2", aCH2[iCH2]))
											Exit
										EndIf
									Next

									If !Empty(oCH2:GetError()) .Or. !oCH2:Flush()
										ErrorHandler(oCH2:GetError(), "CH2", aCH2, @aErrors)
										InitBulk("CH2", @oCH2)
									EndIf
								EndIf
							Else
								Exit
							EndIf
						Next

						If !Empty(oCAI:GetError()) .Or. !oCAI:Flush()
							ErrorHandler(oCAI:GetError(), "CAI", aCAI, @aErrors)
							InitBulk("CAI", @oCAI)
						EndIf
					EndIf
				EndIf

				If jData:HasProperty(ITENS)
					aC30 := jData[ITENS]

					If aC30 != Nil
						GetBulk("C30", @oC30)

						For iC30 := 1 To Len(aC30)
							aC30[iC30]["C30_FILIAL"] := jData["C20_FILIAL"]
							aC30[iC30]["C30_CHVNF"] := jData["C20_CHVNF"]

							If oC30:AddData(GetValues("C30", aC30[iC30]))
								If aC30[iC30]:HasProperty(TRIBUTOS)
									aC35 := aC30[iC30][TRIBUTOS]

									GetBulk("C35", @oC35)

									For iC35 := 1 To Len(aC35)
										aC35[iC35]["C35_FILIAL"] := jData["C20_FILIAL"]
										aC35[iC35]["C35_CHVNF"] := jData["C20_CHVNF"]
										aC35[iC35]["C35_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC35[iC35]["C35_CODITE"] := aC30[iC30]["C30_CODITE"]

										If oC35:AddData(GetValues("C35", aC35[iC35]))
											If aC35[iC35]:HasProperty(DEDUCAO)
												aV4C := aC35[iC35][DEDUCAO]

												GetBulk("V4C", @oV4C)

												For iV4C := 1 To Len(aV4C)
													aV4C[iV4C]["V4C_FILIAL"] := jData["C20_FILIAL"]
													aV4C[iV4C]["V4C_CHVNF"] := jData["C20_CHVNF"]
													aV4C[iV4C]["V4C_NUMITE"] := aC30[iC30]["C30_NUMITE"]
													aV4C[iV4C]["V4C_CODITE"] := aC30[iC30]["C30_CODITE"]
													aV4C[iV4C]["V4C_CODTRI"] := aC35[iC35]["C35_CODTRI"]

													If oV4C:AddData(GetValues("V4C", aV4C[iV4C]))
														If aV4C[iV4C]:HasProperty(DEPENDENTES)
															aV84 := aV4C[iV4C][DEPENDENTES]

															GetBulk("V84", @oV84)

															For iV84 := 1 To Len(aV84)
																aV84[iV84]["V84_FILIAL"] := jData["C20_FILIAL"]
																aV84[iV84]["V84_CHVNF"] := jData["C20_CHVNF"]
																aV84[iV84]["V84_IDPART"] := jData["C20_CODPAR"]
																aV84[iV84]["V84_NUMITE"] := aC30[iC30]["C30_NUMITE"]
																aV84[iV84]["V84_CODITE"] := aC30[iC30]["C30_CODITE"]
																aV84[iV84]["V84_CODTRI"] := aC35[iC35]["C35_CODTRI"]
																aV84[iV84]["V84_TPDEDU"] := aV4C[iV4C]["V4C_TPDEDU"]

																If !oV84:AddData(GetValues("V84", aV84[iV84]))
																	Exit
																EndIf
															Next

															If !Empty(oV84:GetError()) .Or. !oV84:Flush()
																ErrorHandler(oV84:GetError(), "V84", aV84, @aErrors)
																InitBulk("V84", @oV84)
															EndIf
														EndIf
													Else
														Exit
													EndIf
												Next

												If !Empty(oV4C:GetError()) .Or. !oV4C:Flush()
													ErrorHandler(oV4C:GetError(), "V4C", aV4C, @aErrors)
													InitBulk("V4C", @oV4C)
												EndIf
											EndIf

											If aC35[iC35]:HasProperty(ISENSAO)
												aV4D := aC35[iC35][ISENSAO]

												GetBulk("V4D", @oV4D)

												For iV4D := 1 To Len(aV4D)
													aV4D[iV4D]["V4D_FILIAL"] := jData["C20_FILIAL"]
													aV4D[iV4D]["V4D_CHVNF"] := jData["C20_CHVNF"]
													aV4D[iV4D]["V4D_NUMITE"] := aC30[iC30]["C30_NUMITE"]
													aV4D[iV4D]["V4D_CODITE"] := aC30[iC30]["C30_CODITE"]
													aV4D[iV4D]["V4D_CODTRI"] := aC35[iC35]["C35_CODTRI"]

													If !oV4D:AddData(GetValues("V4D", aV4D[iV4D]))
														Exit
													EndIf
												Next

												If !Empty(oV4D:GetError()) .Or. !oV4D:Flush()
													ErrorHandler(oV4D:GetError(), "V4D", aV4D, @aErrors)
													InitBulk("V4D", @oV4D)
												EndIf
											EndIf
										Else
											Exit
										EndIf
									Next

									If !Empty(oC35:GetError()) .Or. !oC35:Flush()
										ErrorHandler(oC35:GetError(), "C35", aC35, @aErrors)
										InitBulk("C35", @oC35)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(MEDICAMENTOS)
									aC31 := aC30[iC30][MEDICAMENTOS]

									GetBulk("C31", @oC31)

									For iC31 := 1 To Len(aC31)
										aC31[iC31]["C31_FILIAL"] := jData["C20_FILIAL"]
										aC31[iC31]["C31_CHVNF"] := jData["C20_CHVNF"]
										aC31[iC31]["C31_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC31[iC31]["C31_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC31:AddData(GetValues("C31", aC31[iC31]))
											Exit
										EndIf
									Next

									If !Empty(oC31:GetError()) .Or. !oC31:Flush()
										ErrorHandler(oC31:GetError(), "C31", aC31, @aErrors)
										InitBulk("C31", @oC31)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(ENERGIA_ELETRICA_AGUA_GAS)
									aC32 := aC30[iC30][ENERGIA_ELETRICA_AGUA_GAS]

									GetBulk("C32", @oC32)

									For iC32 := 1 To Len(aC32)
										aC32[iC32]["C32_FILIAL"] := jData["C20_FILIAL"]
										aC32[iC32]["C32_CHVNF"] := jData["C20_CHVNF"]
										aC32[iC32]["C32_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC32[iC32]["C32_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC32:AddData(GetValues("C32", aC32[iC32]))
											Exit
										EndIf
									Next

									If !Empty(oC32:GetError()) .Or. !oC32:Flush()
										ErrorHandler(oC32:GetError(), "C32", aC32, @aErrors)
										InitBulk("C32", @oC32)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(ARMAS_FOGO)
									aC33 := aC30[iC30][ARMAS_FOGO]

									GetBulk("C33", @oC33)

									For iC33 := 1 To Len(aC33)
										aC33[iC33]["C33_FILIAL"] := jData["C20_FILIAL"]
										aC33[iC33]["C33_CHVNF"] := jData["C20_CHVNF"]
										aC33[iC33]["C33_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC33[iC33]["C33_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC33:AddData(GetValues("C33", aC33[iC33]))
											Exit
										EndIf
									Next

									If !Empty(oC33:GetError()) .Or. !oC33:Flush()
										ErrorHandler(oC33:GetError(), "C33", aC33, @aErrors)
										InitBulk("C33", @oC33)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(VEICULOS_NOVOS)
									aC34 := aC30[iC30][VEICULOS_NOVOS]

									GetBulk("C34", @oC34)

									For iC34 := 1 To Len(aC34)
										aC34[iC34]["C34_FILIAL"] := jData["C20_FILIAL"]
										aC34[iC34]["C34_CHVNF"] := jData["C20_CHVNF"]
										aC34[iC34]["C34_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC34[iC34]["C34_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC34:AddData(GetValues("C34", aC34[iC34]))
											Exit
										EndIf
									Next

									If !Empty(oC34:GetError()) .Or. !oC34:Flush()
										ErrorHandler(oC34:GetError(), "C34", aC34, @aErrors)
										InitBulk("C34", @oC34)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(ARMAZENAMENTO_COMBUSTIVEIS)
									aC36 := aC30[iC30][ARMAZENAMENTO_COMBUSTIVEIS]

									GetBulk("C36", @oC36)

									For iC36 := 1 To Len(aC36)
										aC36[iC36]["C36_FILIAL"] := jData["C20_FILIAL"]
										aC36[iC36]["C36_CHVNF"] := jData["C20_CHVNF"]
										aC36[iC36]["C36_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC36[iC36]["C36_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC36:AddData(GetValues("C36", aC36[iC36]))
											Exit
										EndIf
									Next

									If !Empty(oC36:GetError()) .Or. !oC36:Flush()
										ErrorHandler(oC36:GetError(), "C36", aC36, @aErrors)
										InitBulk("C36", @oC36)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(RESSARCIMENTOS_ICMSST)
									aC37 := aC30[iC30][RESSARCIMENTOS_ICMSST]

									GetBulk("C37", @oC37)

									For iC37 := 1 To Len(aC37)
										aC37[iC37]["C37_FILIAL"] := jData["C20_FILIAL"]
										aC37[iC37]["C37_CHVNF"] := jData["C20_CHVNF"]
										aC37[iC37]["C37_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC37[iC37]["C37_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC37:AddData(GetValues("C37", aC37[iC37]))
											Exit
										EndIf
									Next

									If !Empty(oC37:GetError()) .Or. !oC37:Flush()
										ErrorHandler(oC37:GetError(), "C37", aC37, @aErrors)
										InitBulk("C37", @oC37)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(COMUNICACAO_TELECOMUNICACAO)
									aC38 := aC30[iC30][COMUNICACAO_TELECOMUNICACAO]

									GetBulk("C38", @oC38)

									For iC38 := 1 To Len(aC38)
										aC38[iC38]["C38_FILIAL"] := jData["C20_FILIAL"]
										aC38[iC38]["C38_CHVNF"] := jData["C20_CHVNF"]
										aC38[iC38]["C38_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC38[iC38]["C38_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC38:AddData(GetValues("C38", aC38[iC38]))
											Exit
										EndIf
									Next

									If !Empty(oC38:GetError()) .Or. !oC38:Flush()
										ErrorHandler(oC38:GetError(), "C38", aC38, @aErrors)
										InitBulk("C38", @oC38)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(SERVICO_TRANSPORTE)
									aC39 := aC30[iC30][SERVICO_TRANSPORTE]

									GetBulk("C39", @oC39)

									For iC39 := 1 To Len(aC39)
										aC39[iC39]["C39_FILIAL"] := jData["C20_FILIAL"]
										aC39[iC39]["C39_CHVNF"] := jData["C20_CHVNF"]
										aC39[iC39]["C39_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aC39[iC39]["C39_CODITE"] := aC30[iC30]["C30_CODITE"]

										If !oC39:AddData(GetValues("C39", aC39[iC39]))
											Exit
										EndIf
									Next

									If !Empty(oC39:GetError()) .Or. !oC39:Flush()
										ErrorHandler(oC39:GetError(), "C39", aC39, @aErrors)
										InitBulk("C39", @oC39)
									EndIf
								EndIf

								If aC30[iC30]:HasProperty(PROCESSOS_REFERENCIADOS)
									aT9Q := aC30[iC30][PROCESSOS_REFERENCIADOS]

									GetBulk("T9Q", @oT9Q)

									For iT9Q := 1 To Len(aT9Q)
										aT9Q[iT9Q]["T9Q_FILIAL"] := jData["C20_FILIAL"]
										aT9Q[iT9Q]["T9Q_CHVNF"] := jData["C20_CHVNF"]
										aT9Q[iT9Q]["T9Q_NUMITE"] := aC30[iC30]["C30_NUMITE"]
										aT9Q[iT9Q]["T9Q_ID"] := aC30[iC30]["C30_CODITE"]

										If oT9Q:AddData(GetValues("T9Q", aT9Q[iT9Q]))
											If aT9Q[iT9Q]:HasProperty(DEDUCOES)
												aV88 := aT9Q[iT9Q][DEDUCOES]

												GetBulk("V88", @oV88)

												For iV88 := 1 To Len(aV88)
													aV88[iV88]["V88_FILIAL"] := jData["C20_FILIAL"]
													aV88[iV88]["V88_CHVNF"] := jData["C20_CHVNF"]
													aV88[iV88]["V88_NUMITE"] := aC30[iC30]["C30_NUMITE"]
													aV88[iV88]["V88_IDPROC"] := aC30[iC30]["C30_CODITE"]
													aV88[iV88]["V88_NUMPRO"] := aT9Q[iT9Q]["T9Q_NUMPRO"]
													aV88[iV88]["V88_IDSUSP"] := aT9Q[iT9Q]["T9Q_IDSUSP"]
													aV88[iV88]["V88_CODTRI"] := aT9Q[iT9Q]["T9Q_CODTRI"]
													aV88[iV88]["V88_TPPROC"] := aT9Q[iT9Q]["T9Q_TPPROC"]

													If oV88:AddData(GetValues("V88", aV88[iV88]))
														If aV88[iV88]:HasProperty(DEPENDENTES_BENEFICIARIOS)
															aV94 := aV88[iV88][DEPENDENTES_BENEFICIARIOS]

															GetBulk("V94", @oV94)

															For iV94 := 1 To Len(aV94)
																aV94[iV94]["V94_FILIAL"] := jData["C20_FILIAL"]
																aV94[iV94]["V94_CHVNF"] := jData["C20_CHVNF"]
																aV94[iV94]["V94_IDPART"] := jData["C20_CODPAR"]
																aV94[iV94]["V94_NUMITE"] := aC30[iC30]["C30_NUMITE"]
																aV94[iV94]["V94_IDPROC"] := aC30[iC30]["C30_CODITE"]
																aV94[iV94]["V94_NUMPRO"] := aT9Q[iT9Q]["T9Q_NUMPRO"]
																aV94[iV94]["V94_IDSUSP"] := aT9Q[iT9Q]["T9Q_IDSUSP"]
																aV94[iV94]["V94_CODTRI"] := aT9Q[iT9Q]["T9Q_CODTRI"]
																aV94[iV94]["V94_TPPROC"] := aT9Q[iT9Q]["T9Q_TPPROC"]
																aV94[iV94]["V94_TPDEDU"] := aV88[iV88]["V88_TPDEDU"]

																If !oV94:AddData(GetValues("V94", aV94[iV94]))
																	Exit
																EndIf
															Next

															If !Empty(oV94:GetError()) .Or. !oV94:Flush()
																ErrorHandler(oV94:GetError(), "V94", aV94, @aErrors)
																InitBulk("V94", @oV94)
															EndIf
														EndIf
													Else
														Exit
													EndIf
												Next

												If !Empty(oV88:GetError()) .Or. !oV88:Flush()
													ErrorHandler(oV88:GetError(), "V88", aV88, @aErrors)
													InitBulk("V88", @oV88)
												EndIf
											EndIf
										Else
											Exit
										EndIf
									Next

									If !Empty(oT9Q:GetError()) .Or. !oT9Q:Flush()
										ErrorHandler(oT9Q:GetError(), "T9Q", aT9Q, @aErrors)
										InitBulk("T9Q", @oT9Q)
									EndIf
								EndIf
							Else
								Exit
							EndIf
						Next

						If !Empty(oC30:GetError()) .Or. !oC30:Flush()
							ErrorHandler(oC30:GetError(), "C30", aC30, @aErrors)
							InitBulk("C30", @oC30)
						EndIf
					EndIf
				EndIf

				If jData:HasProperty(CONHECIMENTO_TRANSPORTE)
					aT60 := jData[CONHECIMENTO_TRANSPORTE]

					If aT60 != Nil
						GetBulk("T60", @oT60)

						For iT60 := 1 To Len(aT60)
							aT60[iT60]["T60_FILIAL"] := jData["C20_FILIAL"]
							aT60[iT60]["T60_CHVNF"] := jData["C20_CHVNF"]

							If !oT60:AddData(GetValues("T60", aT60[iT60]))
								Exit
							EndIf
						Next

						If !Empty(oT60:GetError()) .Or. !oT60:Flush()
							ErrorHandler(oT60:GetError(), "T60", aT60, @aErrors)
							InitBulk("T60", @oT60)
						EndIf
					EndIf
				EndIf

				If jData:HasProperty(FATURAS)
					jC29 := jData[FATURAS]
					jC29["C29_FILIAL"] := jData["C20_FILIAL"]
					jC29["C29_CHVNF"] := jData["C20_CHVNF"]

					GetBulk("C29", @oC29)

					If oC29:AddData(GetValues("C29", jC29))
						If jC29:HasProperty(VENCIMENTOS)
							aC2A := jC29[VENCIMENTOS]

							GetBulk("C2A", @oC2A)

							For iC2A := 1 To Len(aC2A)
								aC2A[iC2A]["C2A_FILIAL"] := jData["C20_FILIAL"]
								aC2A[iC2A]["C2A_CHVNF"] := jData["C20_CHVNF"]
								aC2A[iC2A]["C2A_INDEMI"] := jC29["C29_INDEMI"]
								aC2A[iC2A]["C2A_INDTIT"] := jC29["C29_INDTIT"]
								aC2A[iC2A]["C2A_NUMTIT"] := jC29["C29_NUMTIT"]

								If !oC2A:AddData(GetValues("C2A", aC2A[iC2A]))
									Exit
								EndIf
							Next

							If !Empty(oC2A:GetError()) .Or. !oC2A:Flush()
								ErrorHandler(oC2A:GetError(), "C2A", aC2A, @aErrors)
								InitBulk("C2A", @oC2A)
							EndIf
						EndIf


					EndIf

					If !Empty(oC29:GetError()) .Or. !oC29:Flush()
						ErrorHandler(oC29:GetError(), "C29", {jC29}, @aErrors)
						InitBulk("C29", @oC29)
					EndIf
				EndIf

				If jData:HasProperty(TOTAIS)
					If jData[TOTAIS]:HasProperty(VALORES_TRIBUTO)
						aC2F := jData[TOTAIS][VALORES_TRIBUTO]

						GetBulk("C2F", @oC2F)

						For iC2F := 1 To Len(aC2F)
							aC2F[iC2F]["C2F_FILIAL"] := jData["C20_FILIAL"]
							aC2F[iC2F]["C2F_CHVNF"] := jData["C20_CHVNF"]

							If !oC2F:AddData(GetValues("C2F", aC2F[iC2F]))
								Exit
							EndIf
						Next

						If !Empty(oC2F:GetError()) .Or. !oC2F:Flush()
							ErrorHandler(oC2F:GetError(), "C2F", aC2F, @aErrors)
							InitBulk("C2F", @oC2F)
						EndIf
					EndIf
				EndIf
			EndIf
		Next
	EndIf

	If !Empty(aErrors)
		THROW __oError
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} UpdateC20FieldsQuery
@type			function
@description	Gera a query para atualizar os dados dos campos da tabela C20
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          aData - Dados a serem considerados na query
@return			cQuery - Query que será executada
/*/
//---------------------------------------------------------------------
Static Function UpdateC20FieldsQuery(aData as array) as character

	Local aFields := {} as array
	Local aIndex := {} as array
	Local cQuery := "" as character
	Local cSet := "" as character
	Local iI := 0 as integer
	Local iX := 0 as integer
	Local jData := Nil as json
	Local lTotais := .F. as logical
	Local xValue := Nil as variant

	Default aData := {}

	If !Empty(aData)
		aFields := GetFields("C20")
		aIndex	:= GetIndex("C20")

		If __oUpdateC20 == Nil
			cQuery := " UPDATE " + RetSQLName("C20") + " SET ? "
			cQuery += " WHERE C20_FILIAL = ? AND C20_CHVNF = ? AND D_E_L_E_T_ = ' '"

			__oUpdateC20 := FwExecStatement():New(cQuery)
		EndIf

		If __oUpdateC20 != Nil
			cQuery := ""

			For iI := 1 To Len(aData)
				cSet := ""
				jData := aData[iI]

				If jData != Nil .And. jData:HasProperty("C20_FILIAL") .And. jData:HasProperty("C20_CHVNF")
					lTotais := jData:HasProperty(TOTAIS)

					For iX := 1 To Len(aFields)
						xValue := Nil

						If jData:HasProperty(aFields[iX][1])
							xValue := jData[aFields[iX][1]]
						ElseIf lTotais .And. jData[TOTAIS]:HasProperty(aFields[iX][1])
							xValue := jData[TOTAIS][aFields[iX][1]]
						EndIf

						If !Empty(xValue)
							If !Empty(cSet)
								cSet += ", "
							EndIf

							cSet += aFields[iX][1] + " = " + IIf(aFields[iX][2] == "N", cValToChar(xValue), "'" + xValue + "'")
						EndIf
					Next

					If !Empty(cSet)
						__oUpdateC20:SetUnsafe(1, cSet)
						__oUpdateC20:SetString(2, jData["C20_FILIAL"])
						__oUpdateC20:SetString(3, jData["C20_CHVNF"])

						cQuery += __oUpdateC20:GetFixQuery() + ";"
					EndIf
				EndIf
			Next
		EndIf
	EndIf

Return cQuery

//---------------------------------------------------------------------
/*/{Protheus.doc} GetFields
@type			function
@description	Retorna os campos da tabela informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cTable - Alias da tabela
@param          lVirtual - .T. para retornar campos virtuais; .F. para não retornar campos virtuais
@return			aFields - Campos ta tabela no formato: {{"CAMPO", "TIPO", "TAMANHO", "DECIMAIS"}}
/*/
//---------------------------------------------------------------------
Static Function GetFields(cTable as character, lVirtual as logical) as array

	Local aFields := {} as array

	Default cTable := ""
	Default lVirtual := .F.

	If !Empty(cTable)
		If __jFields == Nil
			__jFields := JsonObject():New()
		EndIf

		If __jFields:HasProperty(cTable) .And. !Empty(__jFields[cTable])
			aFields := __jFields[cTable]
		Else
			__jFields[cTable] := FWSX3Util():GetListFieldsStruct(cTable, lVirtual)
			aFields := __jFields[cTable]
		EndIf
	EndIf

Return aFields

//---------------------------------------------------------------------
/*/{Protheus.doc} GetIndex
@type			function
@description	Retorna a chave única da tabela informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cTable - Alias da tabela
@return			aIndex - Campos que compõem a chave única
/*/
//---------------------------------------------------------------------
Static Function GetIndex(cTable as character) as array

	Local aIndex := {} as array

	Default cTable := ""

	If !Empty(cTable)
		If __jIndexes == Nil
			__jIndexes := JsonObject():New()
		EndIf

		If __jIndexes:HasProperty(cTable) .And. !Empty(__jIndexes[cTable])
			aIndex := __jIndexes[cTable]
		Else
			__jIndexes[cTable] := StrTokArr2(FWX2Unico(cTable), "+")
			aIndex := __jIndexes[cTable]
		EndIf
	EndIf

Return aIndex

//---------------------------------------------------------------------
/*/{Protheus.doc} ErrorHandler
@type			static function
@description	Realiza o tratamento dos erros retornados pelo FWBulk()
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cError - Erro gerado pelo FWBulk()
@param          cTable - Alias da tabela em que o erro foi gerador
@param          aData - Dados que geraram o erro
@param          aErrors - Campos e conteúdos que compõe os registros com erro
@return			Nil
/*/
//---------------------------------------------------------------------
Using Namespace tlpp.regex
Static Function ErrorHandler(cError as character, cTable as character, aData as array, aErrors as array)

	Local aError := {} as array
	Local aCampos := {} as array
	Local aIndexes := {} as array
	Local aChave := {} as array
	Local cDescription := "" as character
	Local cShortError := "" as character
	Local iCampo := 0 as integer
	Local iIndexes := 0 as integer
	Local iOpenContent := 0 as integer
	Local iCloseContent := 0 as integer
	Local iI := 0 as integer
	Local iX := 0 as integer
	Local oRegex := Nil as object

	Default aData := {}
	Default aErrors := {}
	Default cError := ""
	Default cTable := ""

	If !Empty(cTable) .And. !Empty(aData)
		aCampos := GetFields(cTable)
		aChave := GetIndex(cTable)
		oRegex := Regex():New("")

		oRegex:SetMultiline(.T.)
		oRegex:SetCaseSensitive(.F.)

		oRegex:SetPattern("Invalid bind parameter size")

		If oRegex:Tokenizer(cError,, @aIndexes)
			nRow := Val(AllTrim(SubStr(cError, At("Row", cError) + 4, At("Col", cError) - (At("Row", cError) + 4))))
			nColumn := Val(AllTrim(SubStr(cError, At("Col", cError) + 4, At(")", cError) - (At("Col", cError) + 4))))

			For iX := 1 To Len(aChave)
				If aData[nRow]:HasProperty(aChave[iX])
					cError += aChave[iX] + ": " + aData[nRow][aChave[iX]] + CRLF

					AAdd(aError, {aChave[iX], aData[nRow][aChave[iX]]})
				EndIf
			Next

			AAdd(aErrors, aError)

			cError += CRLF + STR0003 + CRLF + CRLF // "O conteúdo incluído é maior que o tamanho do campo:"
			cError += STR0004 + aCampos[nColumn][1] + CRLF // "Campo: "
			cError += STR0005 + cValToChar(aCampos[nColumn][3]) + CRLF // "Tamanho do campo: "
			cError += STR0006 + aData[nRow][aCampos[nColumn][1]] + CRLF // "Conteúdo: "
			cError += STR0007 + cValToChar(Len(aData[nRow][aCampos[nColumn][1]])) + CRLF // "Tamanho do conteúdo: "
		Else
			For iI := 1 To Len(aChave)
				If Len(aData) == 1
					If aData[1]:HasProperty(aChave[iI])
						AAdd(aError, {{aChave[iI], aData[1][aChave[iI]]}})
					EndIf
				Else
					iCampo := AScan(aCampos, {|x| x[1] == aChave[iI]})

					oRegex:SetPattern("#" + cValToChar(iCampo))

					If oRegex:Tokenizer(cError,, @aIndexes)
						iIndexes := Len(aIndexes)

						For iX := 1 To iIndexes
							cShortError := SubStr(cError, aIndexes[iX], aIndexes[iIndexes] - 1)
							iOpenContent := At("[", cShortError)
							iCloseContent := At("]", cShortError)
							cConteudo := AllTrim(SubStr(cShortError, iOpenContent + 1, iCloseContent - iOpenContent - 1))
							cConteudo := IIf(cConteudo == "[", "", cConteudo)

							If Len(aError) < iIndexes
								AAdd(aError, {{aChave[iI], cConteudo}})
							Else
								AAdd(aError[iX], {aChave[iI], cConteudo})
							EndIf

						Next
					EndIf
				EndIf
			Next

			If !Empty(aError)
				For iI := 1 To Len(aError)
					AEVal(aError[iI], {|x| cDescription += x[1] + ": " + x[2] + CRLF})
					AAdd(aErrors, aError[iI])

					cDescription += CRLF
				Next
			EndIf
		EndIf

		FWFreeArray(aChave)
		FWFreeArray(aCampos)
		FWFreeArray(aIndexes)
		FWFreeObj(oRegex)
	EndIf

	__oError:Description := AllTrim(__oError:Description + CRLF + STR0008 + CRLF + CRLF + cDescription + CRLF + AllTrim(cError)) // "Não foi possível realizar a integração dos documentos fiscais, porque foram encontradas falhas nos registros."
	
	aDadosLog := {'C20', aData[1][cTable+'_CHVNF'], FwX2Nome(cTable), cDescription, .f. }

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} GetValues
@type			function
@description	Realiza o tratamento do conteúdo a ser gravado pelo FWBulk() 
				na tabela informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cTable - Alias da tabela
@param          jData - Dados a serem gravados na tabela informada
@return			aValues - Valores estruturados no formato e ordem correta para o FWBulk() 
/*/
//---------------------------------------------------------------------
Static Function GetValues(cTable as character, jData as json) as array

	Local aValues 	:= {} 	as array
	Local aFields 	:= {} 	as array
	Local iX		:= 0 	as integer

	Default cTable 	:= ""
	Default jData 	:= Nil

	If !Empty(cTable) .And. jData != Nil
		aFields := GetFields(cTable)

		For iX := 1 To Len(aFields)
			If jData:HasProperty(aFields[iX][1])
				AAdd(aValues, IIf(aFields[iX][2] $ "C|M", alltrim(jData[aFields[iX][1]]), jData[aFields[iX][1]]))
			Else
				Do Case
				Case aFields[iX][2] $ "C|M"
					AAdd(aValues, "")

				Case aFields[iX][2] == "D"
					AAdd(aValues, CToD(""))

				Case aFields[iX][2] == "N"
					AAdd(aValues, 0)

				EndCase
			EndIf
		Next
	EndIf

Return aValues

//---------------------------------------------------------------------
/*/{Protheus.doc} GetBulk
@type			function
@description	Instancia o objeto da classe FWBulk() para a respectiva tabela informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cTable - Alias da tabela
@param          oBulk - Objeto que retornará a instância da classe FWBulk() por referência
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function GetBulk(cTable as character, oBulk as object)

	Default cTable := ""
	Default oBulk := Nil

	If !Empty(cTable) .And. oBulk == Nil
		If __jBulks == Nil
			__jBulks := JsonObject():New()
		EndIf

		InitBulk(cTable, @oBulk)
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} GetBulk
@type			function
@description	Instancia um objeto da classe FWBulk() para a respectiva tabela informada
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@param          cTable - Alias da tabela
@param          oBulk - Objeto que retornará a instância da classe FWBulk() por referência
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function InitBulk(cTable as character, oBulk as object)

	Default cTable := ""
	Default oBulk := Nil

	If !Empty(cTable)
		__jBulks[cTable] := Nil
		__jBulks[cTable] := FwBulk():New(RetSQLName(cTable), FLUSH_DATA_LIMIT)

		__jBulks[cTable]:SetFields(GetFields(cTable))

		oBulk := __jBulks[cTable]
	EndIf

Return

//---------------------------------------------------------------------
/*/{Protheus.doc} ClearCachedData
@type			static function
@description	Limpa a variável em cache
@author			Melkz Siqueira
@since			12/06/2023
@version		1.0
@return			Nil
/*/
//---------------------------------------------------------------------
Static Function ClearCachedData()

	__jBulks 	:= Nil

Return
