#Include "tlpp-core.th"
#Include "tlpp-rest.th"
#Include "totvs.ch"
#Include "FWLIBVERSION.ch"
#Include "rh.sigagpe.integration.gestaofunc.ch"

class GPEGestaoFunc
	@Get("api/rh/v1/gestao-funcionario")
	public method getListaFuncionario()

	@Get("api/rh/v1/gestao-funcionario/arquivos-segundo-plano")
	public method getListaArquivosSegPlano()

	@Post("api/rh/v1/gestao-funcionario/arquivos-segundo-plano/notificacao")
	public method postVisualizacaoNotificacao()

	@Post("api/rh/v1/gestao-funcionario/delete-arquivos-antigos")
	public method postDeleteArquivosAntigos()

	@Get("api/rh/v1/gestao-funcionario/arquivo-segundo-plano/:NREGRU9")
	public method getArquivoSegPlano()

	@Get("api/rh/v1/gestao-funcionario/status-schedule")
	public method getStatusSchedule()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper011")
	public method getGPER011Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper014")
	public method getGPER014Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper030")
	public method getGPER030Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper084")
	public method getGPER084Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper130")
	public method getGPER130Report()

	@Get("api/rh/v1/gestao-funcionario/report/gper420")
    public method getGPER420Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper430")
	public method getGPER430Report()

	@Get("api/rh/v1/gestao-funcionario/report/gper440")
    public method getGPER440Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/gper460")
	public method getGPER460Report()
	
	@Get("api/rh/v1/gestao-funcionario/report/ponr010")
	public method getPONR010Report()

	@Get("api/rh/v1/gestao-funcionario/report/gpem580")
    public method getGPEM580Report()

	@Get("api/rh/v1/gestao-funcionario/report/gper270")
    public method getGPER270Report()

	@Get("api/rh/v1/gestao-funcionario/report/gper065")
    public method getGPER065Report()

	public method new() constructor
endclass

/*/{Protheus.doc} new
	Inicializador da classe.
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Instancia da classe
/*/
method new() class GPEGestaoFunc
return self

/*/{Protheus.doc} getListaFuncionario
	Retorna uma lista com os funcionarios da gestao de relatorios smartview
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
/*/
method getListaFuncionario() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local nParamOrder	:= 1						as Numeric
	Local cAlias		:= ""						as Character
	Local cQuery		:= ""						as Character
	Local aCatFunc		:= {}						as Array
	Local aSitFolh		:= {}						as Array
	Local aProcessos	:= {}						as Array
	Local aMatriculas	:= {}						as Array
	Local oStatement	:= NIL						as Object
	Local oItem			:= NIL						as Object
	Local nPage			:= 1						as Numeric
	Local nPageSize		:= 999						as Numeric
	Local nTotal		:= 0						as Numeric
	Local nCount		:= 1						as Numeric
	Local lHasNext		:= .F.						as Logical
	Local lGestPubl 	:= IIf( ExistFunc( "fUsaGFP" ), fUsaGFP(), .F. ) as Logical
	Local cSitLegend	:= ""						as Character

	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		oResponse["items"] := {}

		nPage := IIf(jQueryParams:hasProperty("page") .AND. Val(jQueryParams["page"]) > 0, Val(jQueryParams["page"]), nPage)
		nPageSize := IIf(jQueryParams:hasProperty("pageSize") .AND. Val(jQueryParams["pageSize"]) > 0, Val(jQueryParams["pageSize"]), nPageSize)
		
		cQuery := " SELECT SRA.RA_FILIAL, SRA.RA_MAT, SRA.RA_NOME, SRA.RA_CIC, SRA.RA_ADMISSA, SRA.RA_CATFUNC, SRA.RA_CC "
		cQuery += " , SRA.RA_PROCES, SRA.RA_SITFOLH, SRA.RA_RESCRAI "
		cQuery += " FROM "+RetSqlName("SRA")+" SRA "
		cQuery += " WHERE SRA.RA_FILIAL = ? "

		If jQueryParams:hasProperty("CRAMAT") .AND. !Empty(jQueryParams['CRAMAT'])
			cQuery += " AND SRA.RA_MAT IN (?) "
		Endif

		If jQueryParams:hasProperty("CRACC") .AND. !Empty(jQueryParams['CRACC'])
			cQuery += " AND SRA.RA_CC = ? "
		Endif

		If jQueryParams:hasProperty("CRACIC") .AND. !Empty(jQueryParams['CRACIC'])
			cQuery += " AND SRA.RA_CIC = ? "
		Endif

		If jQueryParams:hasProperty("CRACATFUNC") .AND. !Empty(jQueryParams['CRACATFUNC'])
			cQuery += " AND SRA.RA_CATFUNC IN (?) "
		Endif

		If jQueryParams:hasProperty("CRASITFOLH") .AND. !Empty(jQueryParams['CRASITFOLH'])
			cQuery += " AND SRA.RA_SITFOLH IN (?) "
		Endif

		If jQueryParams:hasProperty("CRAPROCES") .AND. !Empty(jQueryParams['CRAPROCES'])
			cQuery += " AND SRA.RA_PROCES IN (?) "
		Endif

		If jQueryParams:hasProperty("DRAADMISSADE") .AND. !Empty(jQueryParams['DRAADMISSADE'])
			cQuery += " AND SRA.RA_ADMISSA >= ? "
		Endif

		If jQueryParams:hasProperty("DRAADMISSAATE") .AND. !Empty(jQueryParams['DRAADMISSAATE'])
			cQuery += " AND SRA.RA_ADMISSA <= ? "
		Endif

		cQuery += "   AND SRA.D_E_L_E_T_ 	= ? "
		cQuery += " ORDER BY SRA.RA_MAT "
		cQuery := ChangeQuery(cQuery)

		// Instancia a classe
		oStatement := FwExecStatement():New(cQuery)

		oStatement:SetString(nParamOrder++, jQueryParams['CRAFILIAL'])

		If jQueryParams:hasProperty("CRAMAT") .AND. !Empty(jQueryParams['CRAMAT'])
			aMatriculas := StrTokArr(jQueryParams['CRAMAT'],',')
			oStatement:SetIN(nParamOrder++, aMatriculas)
		Endif
		
		If jQueryParams:hasProperty("CRACC") .AND. !Empty(jQueryParams['CRACC'])
			oStatement:SetString(nParamOrder++, jQueryParams['CRACC'])
		Endif

		If jQueryParams:hasProperty("CRACIC") .AND. !Empty(jQueryParams['CRACIC'])
			oStatement:SetString(nParamOrder++, jQueryParams['CRACIC'])
		Endif

		If jQueryParams:hasProperty("CRACATFUNC") .AND. !Empty(jQueryParams['CRACATFUNC'])
			aCatFunc := strtokarr(jQueryParams['CRACATFUNC'], ',')
			oStatement:SetIn(nParamOrder++, aCatFunc)
		Endif

		If jQueryParams:hasProperty("CRASITFOLH") .AND. !Empty(jQueryParams['CRASITFOLH'])
			aSitFolh := strtokarr(StrTran(jQueryParams['CRASITFOLH'],'N',' '), ',')
			oStatement:SetIn(nParamOrder++, aSitFolh)
		Endif

		If jQueryParams:hasProperty("CRAPROCES") .AND. !Empty(jQueryParams['CRAPROCES'])
			aProcessos := StrTokArr(jQueryParams['CRAPROCES'],',')
			oStatement:SetIn(nParamOrder++, aProcessos)
		Endif

		If jQueryParams:hasProperty("DRAADMISSADE") .AND. !Empty(jQueryParams['DRAADMISSADE'])
			oStatement:SetString(nParamOrder++, StrTran(SubStr(jQueryParams["DRAADMISSADE"],  1, 10), "-", ""))
		Endif

		If jQueryParams:hasProperty("DRAADMISSAATE") .AND. !Empty(jQueryParams['DRAADMISSAATE'])
			oStatement:SetString(nParamOrder++, StrTran(SubStr(jQueryParams["DRAADMISSAATE"],  1, 10), "-", ""))
		Endif

		oStatement:SetString(nParamOrder++, " ")

		// Executa a query e retorna o alias criado
		cAlias 	:= oStatement:OpenAlias()

		// Conta a quantidade total de registros da query
    	Count To nTotal
		If (nPage > 1)
			(cAlias)->(DBSkip((nPage - 1) * nPageSize))
		EndIf

		While (!(cAlias)->(EOF()) .and. nCount <= nPageSize)

			cSitLegend := ""
			If lGestPubl
				If (cAlias)->RA_SITFOLH == ' ' .AND. (cAlias)->RA_CATFUNC $ '78'
					cSitLegend := "AP"
				ElseIf (cAlias)->RA_SITFOLH == ' ' .AND. (cAlias)->RA_CATFUNC $ '9'
					cSitLegend := "PE"
				ElseIf (cAlias)->RA_SITFOLH == ' '
					cSitLegend := "N"
				ElseIf (cAlias)->RA_SITFOLH == 'D'
					cSitLegend := "D"
				ElseIf (cAlias)->RA_SITFOLH == 'A'
					cSitLegend := "A"
				ElseIf (cAlias)->RA_SITFOLH == 'F'
					cSitLegend := "F"
				Endif
			Else
				If (cAlias)->RA_SITFOLH == ' '
					cSitLegend := "N"
				ElseIf (cAlias)->RA_RESCRAI $ '30/31'
					cSitLegend := "TR"
				ElseIf (cAlias)->RA_SITFOLH == 'D'
					cSitLegend := "D"
				ElseIf (cAlias)->RA_SITFOLH == 'A'
					cSitLegend := "A"
				ElseIf (cAlias)->RA_SITFOLH == 'F'
					cSitLegend := "F"
				Endif
			Endif

			oItem := JSonObject():new()
			oItem["CRAFILIAL"] 	:= RTrim((cAlias)->RA_FILIAL)
			oItem["CRAMAT"] 	:= RTrim((cAlias)->RA_MAT)
			oItem["CRANOME"] 	:= RTrim((cAlias)->RA_NOME)
			oItem["CRACIC"] 	:= RTrim((cAlias)->RA_CIC)
			oItem["CRASITFOLH"] := RTrim((cAlias)->RA_SITFOLH)
			oItem["CRACATFUNC"]	:= RTrim((cAlias)->RA_CATFUNC)
			oItem["CRACC"] 		:= RTrim((cAlias)->RA_CC)
			oItem["CRAPROCES"] 	:= RTrim((cAlias)->RA_PROCES)
			oItem["CSITLEGEND"]	:= cSitLegend
			oItem["DRAADMISSA"] := fDateToJson(StoD((cAlias)->RA_ADMISSA))

			aadd(oResponse["items"], oItem)

			(cAlias)->(DbSkip())
			nCount++
		End

		lHasNext := (nCount > nPageSize .AND.!(cAlias)->(EOF()))
		oResponse["lHasNext"] := lHasNext

		(cAlias)->(DbCloseArea())
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"

		(cAlias)->(dbCloseArea())
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} getListaArquivosSegPlano
	Retorna uma lista com os arquivos gerados em segundo plano
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
/*/
method getListaArquivosSegPlano() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local nParamOrder	:= 1						as Numeric
	Local cAlias		:= ""						as Character
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oItem			:= NIL						as Object
	Local nPage			:= 1						as Numeric
	Local nPageSize		:= 999						as Numeric
	Local nTotal		:= 0						as Numeric
	Local nCount		:= 1						as Numeric
	Local lHasNext		:= .F.						as Logical
	
	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif
		
		// Necessário para criar a tabela caso ela ainda não tenha sido criada no banco
		DbSelectArea("RU9")

		nPage := IIf(jQueryParams:hasProperty("page") .AND. Val(jQueryParams["page"]) > 0, Val(jQueryParams["page"]), nPage)
		nPageSize := IIf(jQueryParams:hasProperty("pageSize") .AND. Val(jQueryParams["pageSize"]) > 0, Val(jQueryParams["pageSize"]), nPageSize)

		oResponse["items"] := {}
		
		cQuery := " SELECT RU9.RU9_USER, RU9.RU9_STATUS, RU9.RU9_ARQUIV, RU9.RU9_DATA, RU9.RU9_HORA, RU9.RU9_RELAT, "
		cQuery += " RU9.RU9_MAT, SRA.RA_NOME, RU9.RU9_DESC, RU9.RU9_NOTIF, RU9.RU9_DOWNL, RU9.R_E_C_N_O_ REGRU9 "
		cQuery += " FROM "+RetSqlName("RU9")+" RU9 "
		cQuery += " INNER JOIN "+RetSqlName("SRA")+" SRA "
		cQuery += "    ON SRA.RA_FILIAL 	= RU9.RU9_FILMAT "
		cQuery += "   AND SRA.RA_MAT 		= RU9.RU9_MAT "
		cQuery += "   AND SRA.D_E_L_E_T_ 	= ? "
		cQuery += " WHERE RU9.RU9_FILIAL 	= ? "
		cQuery += "   AND RU9.RU9_USER 		= ? "
		cQuery += "   AND RU9.RU9_STATUS	!= ? "
		cQuery += "   AND RU9.D_E_L_E_T_ 	= ? "
		cQuery += " ORDER BY RU9.R_E_C_N_O_ DESC "
		cQuery := ChangeQuery(cQuery)

		// Instancia a classe
		oStatement := FwExecStatement():New(cQuery)

		oStatement:SetString(nParamOrder++, " ")
		oStatement:SetString(nParamOrder++, xFilial("RU9"))
		oStatement:SetString(nParamOrder++, __cUserID)
		oStatement:SetString(nParamOrder++, "3")
		oStatement:SetString(nParamOrder++, " ")

		// Executa a query e retorna o alias criado
		cAlias 	:= oStatement:OpenAlias()

		// Conta a quantidade total de registros da query
    	Count To nTotal
		If (nPage > 1)
			(cAlias)->(DBSkip((nPage - 1) * nPageSize))
		EndIf

		While (!(cAlias)->(EOF()) .and. nCount <= nPageSize)
			oItem := JSonObject():new()
			oItem["CRU9USER"]	:= RTrim((cAlias)->RU9_USER)
			oItem["CRU9STATUS"]	:= RTrim((cAlias)->RU9_STATUS)
			oItem["CRU9ARQUIV"]	:= RTrim((cAlias)->RU9_ARQUIV)
			oItem["CRU9DATA"]	:= fDateToJson(StoD((cAlias)->RU9_DATA))
			oItem["CRU9HORA"]	:= RTrim((cAlias)->RU9_HORA)
			oItem["CRU9RELAT"]	:= RTrim((cAlias)->RU9_RELAT)
			oItem["CRU9MAT"]	:= RTrim((cAlias)->RU9_MAT)
			oItem["CRU9DESC"]	:= RTrim((cAlias)->RU9_DESC)
			oItem["CRU9NOTIF"]	:= RTrim((cAlias)->RU9_NOTIF)
			oItem["CRU9DOWNL"]	:= RTrim((cAlias)->RU9_DOWNL)
			oItem["CRANOME"]	:= RTrim((cAlias)->RA_NOME)
			oItem["NREGRU9"]	:= (cAlias)->REGRU9
			aadd(oResponse["items"], oItem)

			(cAlias)->(DbSkip())
			nCount++
		End

		lHasNext := (nCount > nPageSize .AND.!(cAlias)->(EOF()))
		oResponse["lHasNext"] := lHasNext

		(cAlias)->(DbCloseArea())
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"

		(cAlias)->(dbCloseArea())
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} postVisualizacaoNotificacao
	Altera o status da notificacao visualizada
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
/*/
method postVisualizacaoNotificacao() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local cQuery		:= ""						as Character

	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		cQuery := " UPDATE "+RetSqlName("RU9")+" SET RU9_NOTIF = '1' "
		cQuery += " WHERE RU9_FILIAL 	= '"+xFilial("RU9")+"' "
		cQuery += "   AND RU9_USER 		= '"+__cUserID+"' "
		cQuery += "   AND D_E_L_E_T_ 	= '' "

		TcSqlExec(cQuery)

	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} postDeleteArquivosAntigos
	Deleta os arquivos antigos conforme parametro MV_RHSVDEL
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
/*/
method postDeleteArquivosAntigos() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local nErroCod 		:= 0 						as Numeric
	Local nParamOrder	:= 1						as Numeric
	Local cAlias		:= ""						as Character
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local cQuery		:= ""						as Character
	Local nTempoDel		:= 0 						as Numeric
	Local dDtDel		:= dDatabase				as Date
	Local cFile			:= ""						as Character

	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		nTempoDel := SuperGetMV("MV_RHSVDEL", .F., 15)
		If nTempoDel > 0
			dDtDel := DaySub(dDatabase, nTempoDel)

			cQuery := " SELECT RU9.RU9_FILIAL, RU9.RU9_USER, RU9.RU9_MAT, RU9.RU9_ARQUIV "
			cQuery += " FROM "+RetSqlName("RU9")+" RU9 "
			cQuery += " WHERE RU9.RU9_FILIAL 	= ? "
			cQuery += "   AND RU9.RU9_DATA 		< ? "
			cQuery += "   AND RU9.D_E_L_E_T_	= ? "
			cQuery := ChangeQuery(cQuery)

			// Instancia a classe
			oStatement := FwExecStatement():New(cQuery)

			oStatement:SetString(nParamOrder++, xFilial("RU9"))
			oStatement:SetString(nParamOrder++, DtoS(dDtDel))
			oStatement:SetString(nParamOrder++, " ")

			// Executa a query e retorna o alias criado
			cAlias 	:= oStatement:OpenAlias()

			While !(cAlias)->(EOF())
				// Se o arquivo existir, o exclui
				cFile := RTrim((cAlias)->RU9_ARQUIV)
				FERASE(cFile)

				(cAlias)->(DbSkip())
			End

			(cAlias)->(dbCloseArea())

			nParamOrder := 1

			cQuery := " UPDATE "+RetSqlName("RU9")+" "
			cQuery += " SET RU9_STATUS 		= '3' "
			cQuery += " WHERE RU9_FILIAL 	= '"+xFilial("RU9")+"' "
			cQuery += "   AND RU9_STATUS	!= '3' "
			cQuery += "   AND RU9_DATA 		< '"+DtoS(dDtDel)+"' "
			cQuery += "   AND D_E_L_E_T_	= ' ' "

			TcSqlExec(cQuery)

		Endif

	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} getArquivoSegPlano
	Retorna o arquivo para download
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
/*/
method getArquivoSegPlano() class GPEGestaoFunc
	Local jPathParams 	:= oRest:getPathParamsRequest()	as Json
	Local jQueryParams 	:= oRest:getQueryRequest()		as Json
	Local nErroCod 		:= 0 							as Numeric
	Local cMsg			:= ""							as Character
	Local cMsgDesc		:= ""							as Character
	Local cMsgTipo		:= ""							as Character
	Local cFilePath		:= ""							as Character
	Local cFile											as Character
	Local oFile											as Object

	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		DbSelectArea("RU9")
		RU9->(DbGoTo(Val(jPathParams["NREGRU9"])))
		
		cFilePath := RU9->RU9_ARQUIV
		oFile := FwFileReader():New(cFilePath)
		
		RecLock("RU9",.F.)
		RU9->RU9_DOWNL = '1' // Fez o download
		If oFile:open()
			cFile := oFile:fullRead()
			oRest:setResponse(cFile)
		Else
			RU9->RU9_STATUS = '2'
			nErroCod 	:= 401
			cMsg 		:= STR0001
			cMsgDesc 	:= STR0002
			cMsgTipo	:= "error"
		Endif
		MsUnlock()
		oFile:close()
		FreeObj(oFile)
	RECOVER
	
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"

		(cAlias)->(dbCloseArea())
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getStatusSchedule
	Retorna se o novo schedule esta rodando
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getStatusSchedule() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()		as Json
	Local nErroCod 		:= 0 							as Numeric
	Local cMsg			:= ""							as Character
	Local cMsgDesc		:= ""							as Character
	Local cMsgTipo		:= ""							as Character
	Local cLibVersion as Character

	Private oResponse := JsonObject():New()			as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		cLibVersion := FwLibVersion()

		If (cLibVersion >= "20240408" .and. totvs.framework.smartschedule.startSchedule.smartSchedIsRunning() .and. totvs.framework.eventviewer.checkNewEventViewer())
			oResponse["lValidSchedule"] := .T.
		Else
			oResponse["lValidSchedule"] := .F.
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"

		(cAlias)->(dbCloseArea())
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER011Report
	Retorna o relatório GPER011 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER011Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local lValid									as Logical
	Local aMvPar									as Array
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	jPrintInfo['name'] := "GPER011SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	lValid := .F.
	cFilMat := ""

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			// Executa em segundo plano
			aMVPar := {;
				"GPER011",;
				Iif(jQueryParams:hasProperty("PAR_PROCESSO"), 		jQueryParams["PAR_PROCESSO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_PERIODO"), 		jQueryParams["PAR_PERIODO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_NROPAG"), 		jQueryParams["PAR_NROPAG"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_FILIAL"), 		jQueryParams["PAR_FILIAL"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_MAT"), 			jQueryParams["PAR_MAT"], 			""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper011.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)
			
			If jQueryParams:hasProperty("PAR_PROCESSO")
				oSmartView:setParam("PAR_PROCESSO"		, jQueryParams["PAR_PROCESSO"])
			Endif
			If jQueryParams:hasProperty("PAR_PERIODO")
				oSmartView:setParam("PAR_PERIODO"		, jQueryParams["PAR_PERIODO"])
			Endif
			If jQueryParams:hasProperty("PAR_NROPAG")
				oSmartView:setParam("PAR_NROPAG"		, jQueryParams["PAR_NROPAG"])
			Endif
			If jQueryParams:hasProperty("PAR_FILIAL")
				oSmartView:setParam("PAR_FILIAL"		, jQueryParams["PAR_FILIAL"])
			Endif
			If jQueryParams:hasProperty("PAR_MAT")
				oSmartView:setParam("PAR_MAT"	        , jQueryParams["PAR_MAT"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FILIAL"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MAT"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0004+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif

	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER014Report
	Retorna o relatório GPER014 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER014Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER014SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			// Executa em segundo plano
			aMVPar := {;
				"GPER014",;
				Iif(jQueryParams:hasProperty("filial"), 			jQueryParams["filial"], 			""),;
				Iif(jQueryParams:hasProperty("matricula"), 			jQueryParams["matricula"], 			""),;
				Iif(jQueryParams:hasProperty("mesAnoDe"), 			jQueryParams["mesAnoDe"], 			""),;
				Iif(jQueryParams:hasProperty("mesAnoAte"), 			jQueryParams["mesAnoAte"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_RELATORIO"), 		jQueryParams["PAR_RELATORIO"], 		""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper014.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("filial")
				oSmartView:setParam("filial"			, jQueryParams["filial"])
			Endif
			If jQueryParams:hasProperty("matricula")
				oSmartView:setParam("matricula"			, jQueryParams["matricula"])
			Endif
			If jQueryParams:hasProperty("mesAnoDe")
				oSmartView:setParam("mesAnoDe"			, jQueryParams["mesAnoDe"])
			Endif
			If jQueryParams:hasProperty("mesAnoAte")
				oSmartView:setParam("mesAnoAte"			, jQueryParams["mesAnoAte"])
			Endif
			If jQueryParams:hasProperty("PAR_RELATORIO")
				oSmartView:setParam("PAR_RELATORIO"		, jQueryParams["PAR_RELATORIO"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["filial"]))
					oStatement:SetString(nParamOrder++, jQueryParams["matricula"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0007+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif

	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER030Report
	Retorna o relatório GPER030 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER030Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER030SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER030",;
				Iif(jQueryParams:hasProperty("PAR_PROCESSO"), 		jQueryParams["PAR_PROCESSO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_ROTEIRO"), 		jQueryParams["PAR_ROTEIRO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_PERDE"), 			jQueryParams["PAR_PERDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_SEMDE"), 			jQueryParams["PAR_SEMDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_PERDE"), 			jQueryParams["PAR_PERDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_SEMDE"), 			jQueryParams["PAR_SEMDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_FIL"), 			jQueryParams["PAR_FIL"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATDE"), 			jQueryParams["PAR_MATDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATATE"), 		jQueryParams["PAR_MATATE"], 		""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper030.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("PAR_PROCESSO")
				oSmartView:setParam("PAR_PROCESSO", jQueryParams["PAR_PROCESSO"])
			Endif
			If jQueryParams:hasProperty("PAR_ROTEIRO")
				oSmartView:setParam("PAR_ROTEIRO", jQueryParams["PAR_ROTEIRO"])
			Endif
			If jQueryParams:hasProperty("PAR_PERDE")
				oSmartView:setParam("PAR_PERDE", jQueryParams["PAR_PERDE"])
				oSmartView:setParam("PAR_PERATE", jQueryParams["PAR_PERDE"])
			Endif
			If jQueryParams:hasProperty("PAR_SEMDE")
				oSmartView:setParam("PAR_SEMDE", jQueryParams["PAR_SEMDE"])
				oSmartView:setParam("PAR_SEMATE", jQueryParams["PAR_SEMDE"])
			Endif
			If jQueryParams:hasProperty("PAR_FIL")
				oSmartView:setParam("PAR_FIL", jQueryParams["PAR_FIL"])
			Endif
			If jQueryParams:hasProperty("PAR_MATDE")
				oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATATE")
				oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FIL"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0008+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER084Report
	Retorna o relatório GPER084 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER084Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER084SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER084",;
				Iif(jQueryParams:hasProperty("PAR_PROCESSO"), 		jQueryParams["PAR_PROCESSO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_ROTEIRO"), 		jQueryParams["PAR_ROTEIRO"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_PERDE"), 			jQueryParams["PAR_PERDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_SEMDE"), 			jQueryParams["PAR_SEMDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_PERDE"), 			jQueryParams["PAR_PERDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_SEMDE"), 			jQueryParams["PAR_SEMDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_FIL"), 			jQueryParams["PAR_FIL"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATDE"), 			jQueryParams["PAR_MATDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATATE"), 		jQueryParams["PAR_MATATE"], 		""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper084.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("PAR_PROCESSO")
				oSmartView:setParam("PAR_PROCESSO", jQueryParams["PAR_PROCESSO"])
			Endif
			If jQueryParams:hasProperty("PAR_ROTEIRO")
				oSmartView:setParam("PAR_ROTEIRO", jQueryParams["PAR_ROTEIRO"])
			Endif
			If jQueryParams:hasProperty("PAR_PERDE")
				oSmartView:setParam("PAR_PERDE", jQueryParams["PAR_PERDE"])
				oSmartView:setParam("PAR_PERATE", jQueryParams["PAR_PERDE"])
			Endif
			If jQueryParams:hasProperty("PAR_SEMDE")
				oSmartView:setParam("PAR_SEMDE", jQueryParams["PAR_SEMDE"])
				oSmartView:setParam("PAR_SEMATE", jQueryParams["PAR_SEMDE"])
			Endif
			If jQueryParams:hasProperty("PAR_FIL")
				oSmartView:setParam("PAR_FIL", jQueryParams["PAR_FIL"])
			Endif
			If jQueryParams:hasProperty("PAR_MATDE")
				oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATATE")
				oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FIL"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0009+" "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER130Report
	Retorna o relatório GPER130 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 07/05/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER130Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER130SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER130",;
				Iif(jQueryParams:hasProperty("FILDE"), 				jQueryParams["FILDE"], 				""),;
				Iif(jQueryParams:hasProperty("FILATE"), 			jQueryParams["FILATE"], 			""),;
				Iif(jQueryParams:hasProperty("MATDE"), 				jQueryParams["MATDE"], 				""),;
				Iif(jQueryParams:hasProperty("MATATE"), 			jQueryParams["MATATE"], 			""),;
				Iif(jQueryParams:hasProperty("CPERDE"), 			jQueryParams["CPERDE"], 			""),;
				Iif(jQueryParams:hasProperty("CPERATE"), 			jQueryParams["CPERATE"], 			""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

		// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper130.aviso.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("FILDE")
				oSmartView:setParam("FILDE", jQueryParams["FILDE"])
			Endif
			If jQueryParams:hasProperty("FILATE")
				oSmartView:setParam("FILATE", jQueryParams["FILATE"])
			Endif
			If jQueryParams:hasProperty("MATDE")
				oSmartView:setParam("MATDE", jQueryParams["MATDE"])
			Endif
			If jQueryParams:hasProperty("MATATE")
				oSmartView:setParam("MATATE", jQueryParams["MATATE"])
			Endif
			If jQueryParams:hasProperty("CPERDE")
				oSmartView:setParam("CPERDE", jQueryParams["CPERDE"])
			Endif
			If jQueryParams:hasProperty("CPERATE")
				oSmartView:setParam("CPERATE", jQueryParams["CPERATE"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FIL"]))
					oStatement:SetString(nParamOrder++, jQueryParams["MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0019+" "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER420Report
	Retorna o relatório GPER420 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 23/07/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER420Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER420SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER420",;
				Iif(jQueryParams:hasProperty("PAR_FILIALDE"), 		jQueryParams["PAR_FILIALDE"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_FILIALATE"), 		jQueryParams["PAR_FILIALATE"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_MATDE"), 			jQueryParams["PAR_MATDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATATE"), 		jQueryParams["PAR_MATATE"], 		""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper420.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("PAR_FILIALDE")
				oSmartView:setParam("PAR_FILIALDE", jQueryParams["PAR_FILIALDE"])
			Endif
			If jQueryParams:hasProperty("PAR_FILIALATE")
				oSmartView:setParam("PAR_FILIALATE", jQueryParams["PAR_FILIALATE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATDE")
				oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATATE")
				oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
			Endif

			oSmartView:setParam("PAR_IMPSDEP", "1") // "Sim"

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FILIALDE"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0021+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER430Report
	Retorna o relatório GPER430 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER430Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER430SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER430",;
				Iif(jQueryParams:hasProperty("referenceDate"), 		jQueryParams["referenceDate"], 		""),;
				Iif(jQueryParams:hasProperty("branchCodeFrom"), 	jQueryParams["branchCodeFrom"], 	""),;
				Iif(jQueryParams:hasProperty("branchCodeTo"), 		jQueryParams["branchCodeTo"], 		""),;
				Iif(jQueryParams:hasProperty("employeeCodeFrom"), 	jQueryParams["employeeCodeFrom"], 	""),;
				Iif(jQueryParams:hasProperty("employeeCodeTo"), 	jQueryParams["employeeCodeTo"], 	""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper430.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("referenceDate")
				oSmartView:setParam("ReferenceDate", jQueryParams["referenceDate"])
			Endif
			If jQueryParams:hasProperty("branchCodeFrom")
				oSmartView:setParam("BranchCodeFrom", jQueryParams["branchCodeFrom"])
			Endif
			If jQueryParams:hasProperty("branchCodeTo")
				oSmartView:setParam("BranchCodeTo", jQueryParams["branchCodeTo"])
			Endif
			If jQueryParams:hasProperty("employeeCodeFrom")
				oSmartView:setParam("EmployeeCodeFrom", jQueryParams["employeeCodeFrom"])
			Endif
			If jQueryParams:hasProperty("employeeCodeTo")
				oSmartView:setParam("EmployeeCodeTo", jQueryParams["employeeCodeTo"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["branchCodeFrom"]))
					oStatement:SetString(nParamOrder++, jQueryParams["employeeCodeFrom"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0010+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER440Report
	Retorna o relatório GPER440 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 23/07/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER440Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER440SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER440",;
				Iif(jQueryParams:hasProperty("PAR_FILIALDE"), 		jQueryParams["PAR_FILIALDE"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_FILIALATE"), 		jQueryParams["PAR_FILIALATE"], 		""),;
				Iif(jQueryParams:hasProperty("PAR_MATDE"), 			jQueryParams["PAR_MATDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATATE"), 		jQueryParams["PAR_MATATE"], 		""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper440.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("PAR_FILIALDE")
				oSmartView:setParam("PAR_FILIALDE", jQueryParams["PAR_FILIALDE"])
			Endif
			If jQueryParams:hasProperty("PAR_FILIALATE")
				oSmartView:setParam("PAR_FILIALATE", jQueryParams["PAR_FILIALATE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATDE")
				oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATATE")
				oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FILIALDE"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0020+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getGPER460Report
	Retorna o relatório GPER460 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getGPER460Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "GPER460SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"GPER460",;
				Iif(jQueryParams:hasProperty("PAR_DATAINI"), 		jQueryParams["PAR_DATAINI"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_DATAFIM"), 		jQueryParams["PAR_DATAFIM"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_FILIALDE"), 		jQueryParams["PAR_FILIALDE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_FILIALATE"), 		jQueryParams["PAR_FILIALATE"], 			""),;
				Iif(jQueryParams:hasProperty("PAR_MATDE"), 			jQueryParams["PAR_MATDE"], 				""),;
				Iif(jQueryParams:hasProperty("PAR_MATATE"), 		jQueryParams["PAR_MATATE"], 			""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 				""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 			"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],		"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper460.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("PAR_DATAINI")
				oSmartView:setParam("PAR_DATAINI", jQueryParams["PAR_DATAINI"])
			Endif
			If jQueryParams:hasProperty("PAR_DATAFIM")
				oSmartView:setParam("PAR_DATAFIM", jQueryParams["PAR_DATAFIM"])
			Endif
			If jQueryParams:hasProperty("PAR_FILIALDE")
				oSmartView:setParam("PAR_FILIALDE", jQueryParams["PAR_FILIALDE"])
			Endif
			If jQueryParams:hasProperty("PAR_FILIALATE")
				oSmartView:setParam("PAR_FILIALATE", jQueryParams["PAR_FILIALATE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATDE")
				oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
			Endif
			If jQueryParams:hasProperty("PAR_MATATE")
				oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FILIALDE"]))
					oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0011+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return


/*/{Protheus.doc} getPONR010Report
	Retorna o relatório PONR010 do SmartView conforme os parâmetros enviados
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 15/04/2025
	@return Variant, Retorno nulo pre-fixado
/*/
method getPONR010Report() class GPEGestaoFunc
	Local jQueryParams 	:= oRest:getQueryRequest()	as Json
	Local cQuery		:= ""						as Character
	Local oStatement	:= NIL						as Object
	Local oSmartView								as Object
	Local cAlias		:= ""						as Character
	Local nErroCod 		:= 0 						as Numeric
	Local cMsg			:= ""						as Character
	Local cMsgDesc		:= ""						as Character
	Local cMsgTipo		:= ""						as Character
	Local jPrintInfo	:= JsonObject():New()		as Json
	Local cFilePath									as Character
	Local cFile										as Character
	Local oFile										as Object
	Local lSuccess 									as Logical
	Local lEmailUsuario 							as Logical
	Local lEmailFuncionario 						as Logical
	Local cFilMat									as Character
	Local cMailUser									as Character
	Local cMailFunc									as Character
	Local cMailAssunto								as Character
	Local cMailHtml									as Character
	Local aFiles									as Array
	Local nParamOrder								as Numeric

	Private oResponse 	:= JsonObject():New()		as Json

	oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

	cFilMat := ""

	jPrintInfo['name'] := "PONR010SmartView_"+FWTimeStamp()
	jPrintInfo['path'] := "\spool\"
	jPrintInfo['extension'] := "pdf"

	BEGIN SEQUENCE
		If jQueryParams:hasProperty("forcaErro")
			BREAK
		Endif

		If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
			aMVPar := {;
				"PONR010",;
				Iif(jQueryParams:hasProperty("dateFrom"), 			jQueryParams["dateFrom"], 			""),;
				Iif(jQueryParams:hasProperty("dateTo"), 			jQueryParams["dateTo"], 			""),;
				Iif(jQueryParams:hasProperty("branchCodeFrom"), 	jQueryParams["branchCodeFrom"], 	""),;
				Iif(jQueryParams:hasProperty("branchCodeTo"), 		jQueryParams["branchCodeTo"], 		""),;
				Iif(jQueryParams:hasProperty("employeeCodeFrom"), 	jQueryParams["employeeCodeFrom"], 	""),;
				Iif(jQueryParams:hasProperty("employeeCodeTo"), 	jQueryParams["employeeCodeTo"], 	""),;
				Iif(jQueryParams:hasProperty("filMat"), 			jQueryParams["filMat"], 			""),;
				Iif(jQueryParams:hasProperty("lEmailUsuario"), 		jQueryParams["lEmailUsuario"], 		"false"),;
				Iif(jQueryParams:hasProperty("lEmailFuncionario"),	jQueryParams["lEmailFuncionario"],	"false");
			}
			fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
		Else

			lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
			lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

			// Instancia a classe callSmartView()
			oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.pon.ponr010.default.rep", "report")
			oSmartView:setNoInterface(.T.)
			oSmartView:setPrintType(1)
			oSmartView:setPrintInfo(jPrintInfo)

			If jQueryParams:hasProperty("dateFrom")
				oSmartView:setParam("DateFrom", jQueryParams["dateFrom"])
			Endif
			If jQueryParams:hasProperty("dateTo")
				oSmartView:setParam("DateTo", jQueryParams["dateTo"])
			Endif
			If jQueryParams:hasProperty("branchCodeFrom")
				oSmartView:setParam("BranchCodeFrom", jQueryParams["branchCodeFrom"])
			Endif
			If jQueryParams:hasProperty("branchCodeTo")
				oSmartView:setParam("BranchCodeTo", jQueryParams["branchCodeTo"])
			Endif
			If jQueryParams:hasProperty("employeeCodeFrom")
				oSmartView:setParam("EmployeeCodeFrom", jQueryParams["employeeCodeFrom"])
			Endif
			If jQueryParams:hasProperty("employeeCodeTo")
				oSmartView:setParam("EmployeeCodeTo", jQueryParams["employeeCodeTo"])
			Endif

			oSmartView:setForceParams(.T.)
			lSuccess := oSmartView:executeSmartView()  

			If !lSuccess
				nErroCod 	:= 500
				cMsg 		:= STR0001
				cMsgDesc 	:= STR0003
				cMsgTipo	:= "error"
			Else
				cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
				oFile := FwFileReader():New(cFilePath)

				If oFile:open()
					cFile := oFile:fullRead()
					oRest:setResponse(cFile)
				Else
					nErroCod 	:= 500
					cMsg 		:= STR0001
					cMsgDesc 	:= STR0002
					cMsgTipo	:= "error"
				Endif
				oFile:close()
				FreeObj(oFile)

				If lEmailUsuario .OR. lEmailFuncionario

					nParamOrder := 1

					cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
					cQuery += " FROM "+RetSqlName("SRA")+" SRA "
					cQuery += " WHERE SRA.RA_FILIAL 	= ? "
					cQuery += "   AND SRA.RA_MAT 		= ? "
					cQuery += "   AND SRA.D_E_L_E_T_	= ? "
					cQuery := ChangeQuery(cQuery)

					// Instancia a classe
					oStatement := FwExecStatement():New(cQuery)

					oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["branchCodeFrom"]))
					oStatement:SetString(nParamOrder++, jQueryParams["employeeCodeFrom"])
					oStatement:SetString(nParamOrder++, " ")

					// Executa a query e retorna o alias criado
					cAlias 	:= oStatement:OpenAlias()
					
					If !(cAlias)->(EOF())
						
						aFiles := {cFilePath}
						cMailAssunto := STR0012+" - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)

						cMailHtml := "<html>"
						cMailHtml += "<p>"
						cMailHtml += STR0006+", "
						cMailHtml += "</p>"
						cMailHtml += "<p>"
						cMailHtml += STR0005+" "+cMailAssunto+"."
						cMailHtml += "</p>"
						cMailHtml += "</html>"
						
						If lEmailUsuario
							cMailUser := UsrRetMail(__cUserID)
							GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
						Endif

						If lEmailFuncionario
							cMailFunc := (cAlias)->RA_EMAIL
							If !Empty(cMailFunc)
								GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
							Endif
						Endif

					End

					(cAlias)->(dbCloseArea())
				Endif
				FErase(cFilePath)
			Endif

			oSmartView:destroy()
			FwFreeObj(oSmartView)

			If jQueryParams:hasProperty("forcaMsg")
				cMsg 		:= "Success"
				cMsgDesc 	:= "Success"
				cMsgTipo	:= "success"
			Endif
		Endif
	RECOVER
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc 	:= "Internal Server Error"
		cMsgTipo	:= "error"
	END SEQUENCE

	fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} getGPEM580Report
    Retorna o relatório GPEM580 (Informe de Rendimentos) do SmartView conforme os parâmetros enviados
    @type Method
    @version 12.1.2410
    @author Guilherme Suttanni
    @since 24/06/2025
    @return Variant, Retorno nulo pre-fixado
/*/
method getGPEM580Report() class GPEGestaoFunc
    Local jQueryParams 	:= oRest:getQueryRequest()	as Json
    Local nErroCod 		:= 0 						as Numeric
    Local cMsg			:= ""						as Character
    Local cMsgDesc		:= ""						as Character
    Local cMsgTipo		:= ""						as Character
    Local jPrintInfo	:= JsonObject():New()		as Json
    Local cFilePath		:= ""						as Character
    Local cFile			:= ""						as Character
    Local oFile			:= NIL						as Object
    Local lSuccess 		:= .F.						as Logical
    Local oSmartView	:= NIL						as Object
    Local aMVPar        := {}                        as Array
    Local lEmailUsuario := .F.                       as Logical
    Local lEmailFuncionario := .F.                   as Logical
    Local cQuery        := ""                        as Character
    Local oStatement    := NIL                       as Object
    Local cAlias        := ""                        as Character
    Local nParamOrder   := 1                         as Numeric
    Local aFiles        := {}                        as Array
    Local cMailAssunto  := ""                        as Character
    Local cMailHtml     := ""                        as Character
    Local cMailUser     := ""                        as Character
    Local cMailFunc     := ""                        as Character

    Private oResponse := JsonObject():New()			as Json

    oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

    jPrintInfo['name'] := "GPEM580SmartView_"+FWTimeStamp()
    jPrintInfo['path'] := "\spool\"
    jPrintInfo['extension'] := "pdf"

    BEGIN SEQUENCE
        If jQueryParams:hasProperty("forcaErro")
            BREAK
        EndIf

        lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
        lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

        If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
            aMVPar := {;
                "GPEM580",;																							//1
                Iif(jQueryParams:hasProperty("FilialDe"),      jQueryParams["FilialDe"],      ""),;					//2
                Iif(jQueryParams:hasProperty("FilialAte"),     jQueryParams["FilialAte"],     ""),;					//3					
                Iif(jQueryParams:hasProperty("CNPJCPFDe"),     jQueryParams["CNPJCPFDe"],     ""),; 				//4			
                Iif(jQueryParams:hasProperty("CNPJCPFAte"),    jQueryParams["CNPJCPFAte"],    ""),;					//5
                Iif(jQueryParams:hasProperty("MatriculaDe"),   jQueryParams["MatriculaDe"],   ""),;					//6
                Iif(jQueryParams:hasProperty("MatriculaAte"),  jQueryParams["MatriculaAte"],  ""),;					//7
                Iif(jQueryParams:hasProperty("AnoBase"),       jQueryParams["AnoBase"],       ""),;					//8
                Iif(jQueryParams:hasProperty("NomeResp"),      jQueryParams["NomeResp"],      ""),;					//9
                Iif(jQueryParams:hasProperty("TipoImpressao"), jQueryParams["TipoImpressao"], "1"),;				//10
                Iif(jQueryParams:hasProperty("TipoPessoa"),    jQueryParams["TipoPessoa"],    "1"),;				//11
                Iif(jQueryParams:hasProperty("filMat"),        jQueryParams["filMat"],        ""),;					//12
                Iif(jQueryParams:hasProperty("lEmailUsuario"),      jQueryParams["lEmailUsuario"],      "false"),;	//13
                Iif(jQueryParams:hasProperty("lEmailFuncionario"),  jQueryParams["lEmailFuncionario"],  "false");	//14
            }
            fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
        Else
            oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gpem580.default.rep", "report")
            oSmartView:setNoInterface(.T.)
            oSmartView:setPrintType(1)
            oSmartView:setPrintInfo(jPrintInfo) 

            If jQueryParams:hasProperty("FilialDe")
                oSmartView:setParam("FilialDe", jQueryParams["FilialDe"])
            EndIf
            If jQueryParams:hasProperty("FilialAte")
                oSmartView:setParam("FilialAte", jQueryParams["FilialAte"])
            EndIf
            If jQueryParams:hasProperty("MatriculaDe")
                oSmartView:setParam("MatriculaDe", jQueryParams["MatriculaDe"])
            EndIf
            If jQueryParams:hasProperty("MatriculaAte")
                oSmartView:setParam("MatriculaAte", jQueryParams["MatriculaAte"])
            EndIf
            If jQueryParams:hasProperty("AnoBase")
                oSmartView:setParam("AnoBase", jQueryParams["AnoBase"])
            EndIf
            oSmartView:setParam("TipoImpressao", Iif(jQueryParams:hasProperty("TipoImpressao"), jQueryParams["TipoImpressao"], "1"))
            oSmartView:setParam("TipoPessoa",    Iif(jQueryParams:hasProperty("TipoPessoa"),    jQueryParams["TipoPessoa"],    "1"))

            oSmartView:setForceParams(.T.)
            lSuccess := oSmartView:executeSmartView()

            If !lSuccess
                nErroCod 	:= 500
                cMsg 		:= STR0001
                cMsgDesc 	:= STR0003
                cMsgTipo	:= "error"
            Else
                cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
                oFile := FwFileReader():New(cFilePath)

                If oFile:open()
                    cFile := oFile:fullRead()
                    oRest:setResponse(cFile)
                Else
                    nErroCod 	:= 500
                    cMsg 		:= STR0001
                    cMsgDesc 	:= STR0002
                    cMsgTipo	:= "error"
                Endif
                oFile:close()
                FreeObj(oFile)

                // Envio de e-mail
                If lEmailUsuario .OR. lEmailFuncionario
                    nParamOrder := 1
                    cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
                    cQuery += " FROM "+RetSqlName("SRA")+" SRA "
                    cQuery += " WHERE SRA.RA_FILIAL 	= ? "
                    cQuery += "   AND SRA.RA_MAT 		= ? "
                    cQuery += "   AND SRA.D_E_L_E_T_	= ? "
                    cQuery := ChangeQuery(cQuery)

                    oStatement := FwExecStatement():New(cQuery)
                    oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["FilialDe"]))
                    oStatement:SetString(nParamOrder++, jQueryParams["MatriculaDe"])
                    oStatement:SetString(nParamOrder++, " ")

                    cAlias := oStatement:OpenAlias()

                    If !(cAlias)->(EOF())
                        aFiles := {cFilePath}
                        cMailAssunto := "Informe de Rendimentos - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)
                        cMailHtml := "<html>"
                        cMailHtml += "<p>"+STR0006+", </p>"
                        cMailHtml += "<p>"+STR0005+" "+cMailAssunto+".</p>"
                        cMailHtml += "</html>"

                        If lEmailUsuario
                            cMailUser := UsrRetMail(__cUserID)
                            GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
                        Endif

                        If lEmailFuncionario
                            cMailFunc := (cAlias)->RA_EMAIL
                            If !Empty(cMailFunc)
                                GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
                            Endif
                        Endif
                    End

                    (cAlias)->(dbCloseArea())
                Endif

                FErase(cFilePath)
            Endif

            oSmartView:destroy()
            FwFreeObj(oSmartView)
        Endif
    RECOVER
        nErroCod 	:= 500
        cMsg 		:= STR0001
        cMsgDesc 	:= "Internal Server Error"
        cMsgTipo	:= "error"
    END SEQUENCE

    fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} getGPER270Report
    Retorna o relatório GPER270 (Ficha Financeira) do SmartView conforme os parâmetros enviados
    @type Method
    @version 12.1.2410
    @author Guilherme Suttanni
    @since 26/06/2025
    @return Variant, Retorno nulo pré-fixado
/*/
method getGPER270Report() class GPEGestaoFunc
    Local jQueryParams  := oRest:getQueryRequest()    as Json
    Local nErroCod      := 0                          as Numeric
    Local cMsg          := ""                         as Character
    Local cMsgDesc      := ""                         as Character
    Local cMsgTipo      := ""                         as Character
    Local jPrintInfo    := JsonObject():New()         as Json
    Local cFilePath     := ""                         as Character
    Local cFile         := ""                         as Character
    Local oFile         := NIL                        as Object
    Local lSuccess      := .F.                        as Logical
    Local oSmartView    := NIL                        as Object
    Local aMVPar        := {}                         as Array
    Local lEmailUsuario := .F.                        as Logical
    Local lEmailFuncionario := .F.                    as Logical
    Local cQuery        := ""                         as Character
    Local oStatement    := NIL                        as Object
    Local cAlias        := ""                         as Character
    Local nParamOrder   := 1                          as Numeric
    Local aFiles        := {}                         as Array
    Local cMailAssunto  := ""                         as Character
    Local cMailHtml     := ""                         as Character
    Local cMailUser     := ""                         as Character
    Local cMailFunc     := ""                         as Character

    Private oResponse := JsonObject():New()           as Json

    oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

    jPrintInfo['name'] := "GPER270SmartView_"+FWTimeStamp()
    jPrintInfo['path'] := "\spool\"
    jPrintInfo['extension'] := "pdf"

    BEGIN SEQUENCE
        If jQueryParams:hasProperty("forcaErro")
            BREAK
        EndIf

        lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
        lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

        If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
            aMVPar := {;
                "GPER270",;                                                                                       		// 1
                Iif(jQueryParams:hasProperty("PAR_FILIAL"),    		jQueryParams["PAR_FILIAL"],    ""),;                // 2
                Iif(jQueryParams:hasProperty("PAR_CCDE"),      		jQueryParams["PAR_CCDE"],      ""),;                // 3
                Iif(jQueryParams:hasProperty("PAR_CCATE"),     		jQueryParams["PAR_CCATE"],     ""),;                // 4
                Iif(jQueryParams:hasProperty("PAR_MATDE"),     		jQueryParams["PAR_MATDE"],     ""),;                // 5
                Iif(jQueryParams:hasProperty("PAR_MATATE"),    		jQueryParams["PAR_MATATE"],    ""),;                // 6
                Iif(jQueryParams:hasProperty("PAR_NOME"),      		jQueryParams["PAR_NOME"],      ""),;                // 7
                Iif(jQueryParams:hasProperty("PAR_ANOBASE"),   		jQueryParams["PAR_ANOBASE"],   ""),;                // 8
                Iif(jQueryParams:hasProperty("PAR_ROTEIRO"),   		jQueryParams["PAR_ROTEIRO"],   ""),;                // 9
                Iif(jQueryParams:hasProperty("filMat"),        		jQueryParams["filMat"],        ""),;                // 10
                Iif(jQueryParams:hasProperty("lEmailUsuario"),      jQueryParams["lEmailUsuario"],      "false"),; 		// 11
                Iif(jQueryParams:hasProperty("lEmailFuncionario"),  jQueryParams["lEmailFuncionario"],  "false");  		// 12
            }
            fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
        Else
            oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper270.default.rep", "report")
            oSmartView:setNoInterface(.T.)
            oSmartView:setPrintType(1)
            oSmartView:setPrintInfo(jPrintInfo)

            If jQueryParams:hasProperty("PAR_FILIAL")
                oSmartView:setParam("PAR_FILIAL", jQueryParams["PAR_FILIAL"])
            EndIf
            If jQueryParams:hasProperty("PAR_MATDE")
                oSmartView:setParam("PAR_MATDE", jQueryParams["PAR_MATDE"])
            EndIf
            If jQueryParams:hasProperty("PAR_MATATE")
                oSmartView:setParam("PAR_MATATE", jQueryParams["PAR_MATATE"])
            EndIf
            If jQueryParams:hasProperty("PAR_ANOBASE")
                oSmartView:setParam("PAR_ANOBASE", jQueryParams["PAR_ANOBASE"])
            EndIf
            If jQueryParams:hasProperty("PAR_ROTEIRO")
                oSmartView:setParam("PAR_ROTEIRO", jQueryParams["PAR_ROTEIRO"])
            EndIf

            oSmartView:setForceParams(.T.)
            lSuccess := oSmartView:executeSmartView()

            If !lSuccess
                nErroCod   := 500
                cMsg       := STR0001
                cMsgDesc   := STR0003
                cMsgTipo   := "error"
            Else
                cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
                oFile := FwFileReader():New(cFilePath)

                If oFile:open()
                    cFile := oFile:fullRead()
                    oRest:setResponse(cFile)
                Else
                    nErroCod   := 500
                    cMsg       := STR0001
                    cMsgDesc   := STR0002
                    cMsgTipo   := "error"
                Endif
                oFile:close()
                FreeObj(oFile)

                // Envio de e-mail
                If lEmailUsuario .OR. lEmailFuncionario
                    nParamOrder := 1
                    cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
                    cQuery += " FROM "+RetSqlName("SRA")+" SRA "
                    cQuery += " WHERE SRA.RA_FILIAL 	= ? "
                    cQuery += "   AND SRA.RA_MAT 		= ? "
                    cQuery += "   AND SRA.D_E_L_E_T_	= ? "
                    cQuery := ChangeQuery(cQuery)

                    oStatement := FwExecStatement():New(cQuery)
                    oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["PAR_FILIAL"]))
                    oStatement:SetString(nParamOrder++, jQueryParams["PAR_MATDE"])
                    oStatement:SetString(nParamOrder++, " ")

                    cAlias := oStatement:OpenAlias()

                    If !(cAlias)->(EOF())
                        aFiles := {cFilePath}
                        cMailAssunto := "Ficha Financeira - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)
                        cMailHtml := "<html>"
                        cMailHtml += "<p>"+STR0006+", </p>"
                        cMailHtml += "<p>"+STR0005+" "+cMailAssunto+".</p>"
                        cMailHtml += "</html>"

                        If lEmailUsuario
                            cMailUser := UsrRetMail(__cUserID)
                            GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
                        Endif

                        If lEmailFuncionario
                            cMailFunc := (cAlias)->RA_EMAIL
                            If !Empty(cMailFunc)
                                GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
                            Endif
                        Endif
                    End

                    (cAlias)->(dbCloseArea())
                Endif

                FErase(cFilePath)
            Endif

            oSmartView:destroy()
            FwFreeObj(oSmartView)
        Endif
    RECOVER
        nErroCod   := 500
        cMsg       := STR0001
        cMsgDesc   := "Internal Server Error"
        cMsgTipo   := "error"
    END SEQUENCE

    fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} getGPER065Report
    Retorna o relatório GPER065 (Outros Benefícios) do SmartView conforme os parâmetros enviados
    @type Method
    @version 12.1.2410
    @author Guilherme Suttanni
    @since 01/07/2025
    @return Variant, Retorno nulo pre-fixado
/*/
method getGPER065Report() class GPEGestaoFunc
    Local jQueryParams 	:= oRest:getQueryRequest()	as Json
    Local nErroCod 		:= 0 						as Numeric
    Local cMsg			:= ""						as Character
    Local cMsgDesc		:= ""						as Character
    Local cMsgTipo		:= ""						as Character
    Local jPrintInfo	:= JsonObject():New()		as Json
    Local cFilePath		:= ""						as Character
    Local cFile			:= ""						as Character
    Local oFile			:= NIL						as Object
    Local lSuccess 		:= .F.						as Logical
    Local oSmartView	:= NIL						as Object
    Local aMVPar        := {}                        as Array
    Local lEmailUsuario := .F.                       as Logical
    Local lEmailFuncionario := .F.                   as Logical
    Local cQuery        := ""                        as Character
    Local oStatement    := NIL                       as Object
    Local cAlias        := ""                        as Character
    Local nParamOrder   := 1                         as Numeric
    Local aFiles        := {}                        as Array
    Local cMailAssunto  := ""                        as Character
    Local cMailHtml     := ""                        as Character
    Local cMailUser     := ""                        as Character
    Local cMailFunc     := ""                        as Character

    Private oResponse := JsonObject():New()			as Json

    oRest:updateKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")

    jPrintInfo['name'] := "GPER065SmartView_"+FWTimeStamp()
    jPrintInfo['path'] := "\spool\"
    jPrintInfo['extension'] := "pdf"

    BEGIN SEQUENCE
        If jQueryParams:hasProperty("forcaErro")
            BREAK
        EndIf

        lEmailUsuario := jQueryParams:hasProperty("lEmailUsuario") .AND. jQueryParams['lEmailUsuario'] == "true"
        lEmailFuncionario := jQueryParams:hasProperty("lEmailFuncionario") .AND. jQueryParams['lEmailFuncionario'] == "true"

        If jQueryParams:hasProperty("lSched") .AND. jQueryParams['lSched'] == "true"
            aMVPar := {;
                "GPER065",;
                Iif(jQueryParams:hasProperty("filial"),    			jQueryParams["filial"],    			""		),; //1
                Iif(jQueryParams:hasProperty("processo"),  			jQueryParams["processo"],  			""		),;	//2
                Iif(jQueryParams:hasProperty("periodo"),   			jQueryParams["periodo"],   			""		),;	//3
                Iif(jQueryParams:hasProperty("matricula"), 			jQueryParams["matricula"], 			""		),; //4
				Iif(jQueryParams:hasProperty("filMat"),        		jQueryParams["filMat"],        		""		),; //5
                Iif(jQueryParams:hasProperty("lEmailUsuario"),      jQueryParams["lEmailUsuario"],      "false"	),; //6
                Iif(jQueryParams:hasProperty("lEmailFuncionario"),  jQueryParams["lEmailFuncionario"],  "false"	);	//7
            }
            fGeraReportSched("GPERSVSCH", 7, aMVPar, @nErroCod, @cMsg, @cMsgDesc, @cMsgTipo)
        Else
            oSmartView := totvs.framework.smartview.callSmartView():new("rh.sv.gpe.gper065.default.rep", "report")
            oSmartView:setNoInterface(.T.)
            oSmartView:setPrintType(1)
            oSmartView:setPrintInfo(jPrintInfo)

            If jQueryParams:hasProperty("filial")
                oSmartView:setParam("filial", jQueryParams["filial"])
            EndIf
            If jQueryParams:hasProperty("processo")
                oSmartView:setParam("processo", jQueryParams["processo"])
            EndIf
            If jQueryParams:hasProperty("periodo")
                oSmartView:setParam("periodo", jQueryParams["periodo"])
            EndIf
            If jQueryParams:hasProperty("matricula")
                oSmartView:setParam("matricula", jQueryParams["matricula"])
            EndIf

            oSmartView:setForceParams(.T.)
            lSuccess := oSmartView:executeSmartView()

            If !lSuccess
                nErroCod 	:= 500
                cMsg 		:= STR0001
                cMsgDesc 	:= STR0003
                cMsgTipo	:= "error"
            Else
                cFilePath := jPrintInfo['path']+jPrintInfo['name']+"."+jPrintInfo['extension']
                oFile := FwFileReader():New(cFilePath)

                If oFile:open()
                    cFile := oFile:fullRead()
                    oRest:setResponse(cFile)
                Else
                    nErroCod 	:= 500
                    cMsg 		:= STR0001
                    cMsgDesc 	:= STR0002
                    cMsgTipo	:= "error"
                Endif
                oFile:close()
                FreeObj(oFile)

                // Envio de e-mail
                If lEmailUsuario .OR. lEmailFuncionario
                    nParamOrder := 1
                    cQuery := " SELECT SRA.RA_MAT, SRA.RA_NOME, SRA.RA_EMAIL "
                    cQuery += " FROM "+RetSqlName("SRA")+" SRA "
                    cQuery += " WHERE SRA.RA_FILIAL 	= ? "
                    cQuery += "   AND SRA.RA_MAT 		= ? "
                    cQuery += "   AND SRA.D_E_L_E_T_	= ? "
                    cQuery := ChangeQuery(cQuery)

                    oStatement := FwExecStatement():New(cQuery)
                    oStatement:SetString(nParamOrder++, FWxFilial("SRA", jQueryParams["filial"]))
                    oStatement:SetString(nParamOrder++, jQueryParams["matricula"])
                    oStatement:SetString(nParamOrder++, " ")

                    cAlias := oStatement:OpenAlias()

                    If !(cAlias)->(EOF())
                        aFiles := {cFilePath}
                        cMailAssunto := "Outros Benefícios - "+RTrim((cAlias)->RA_MAT)+" - "+RTrim((cAlias)->RA_NOME)
                        cMailHtml := "<html>"
                        cMailHtml += "<p>"+STR0006+", </p>"
                        cMailHtml += "<p>"+STR0005+" "+cMailAssunto+".</p>"
                        cMailHtml += "</html>"

                        If lEmailUsuario
                            cMailUser := UsrRetMail(__cUserID)
                            GPEMail(cMailAssunto, cMailHtml, cMailUser, aFiles)
                        Endif

                        If lEmailFuncionario
                            cMailFunc := (cAlias)->RA_EMAIL
                            If !Empty(cMailFunc)
                                GPEMail(cMailAssunto, cMailHtml, cMailFunc, aFiles)
                            Endif
                        Endif
                    End

                    (cAlias)->(dbCloseArea())
                Endif

                FErase(cFilePath)
            Endif

            oSmartView:destroy()
            FwFreeObj(oSmartView)
        Endif
    RECOVER
        nErroCod 	:= 500
        cMsg 		:= STR0001
        cMsgDesc 	:= "Internal Server Error"
        cMsgTipo	:= "error"
    END SEQUENCE

    fSetResponse(nErroCod, cMsg, cMsgDesc, cMsgTipo)
return

/*/{Protheus.doc} fSetResponse
	Seta a resposta para o PO-UI.
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@return Variant, Retorno nulo pre-fixado
	@obs Foi necessaria a criacao para passar no issue x cobertura de todas as APIs.
/*/
Static Function fSetResponse(nErroCod As Numeric, cMsg As Character, cMsgDesc As Character, cMsgTipo As Character)
	if nErroCod > 0
		oRest:setStatusCode(nErroCod)
		oRest:setFault(fGetJsonErro(nErroCod, cMsg, cMsgDesc, cMsgTipo))
	else
		oRest:setResponse(fGetJsonMsg(cMsg, cMsgDesc, cMsgTipo))
	endif
Return

/*/{Protheus.doc} fGetJsonErro
	Retorna o json de erro para o POUI.
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@param nErroCod, Numeric, Código do erro
	@param cMsg, Character, Mensagem do erro
	@param cMsgDesc, Character, Descrição detalhada do erro
	@param cMsgTipo, Character, Tipo da mensagem
	@return Character, Mensagem de erro
/*/
Static Function fGetJsonErro(nErroCod As Numeric, cMsg As Character, cMsgDesc As Character, cMsgTipo As Character) As Character
	Local oPouiError 	:= JsonObject():new() as Json

	oPouiError["message"]         	:= cMsg
	oPouiError["detailedMessage"] 	:= cMsgDesc
	oPouiError["code"]            	:= nErroCod
	oPouiError["type"]            	:= cMsgTipo
Return EncodeUTF8(FwCutOff(oPouiError:toJson()))

/*/{Protheus.doc} fGetJsonMsg
	Retorna o JSON para o POUI (com alguma mensagem, se necessario).
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@param cMsg, Character, Mensagem do erro
	@param cMsgDesc, Character, Descrição detalhada do erro
	@param cMsgTipo, Character, Tipo da mensagem
	@return Character, Mensagem de erro
/*/
Static Function fGetJsonMsg(cMsg As Character, cMsgDesc As Character, cMsgTipo As Character)
	Local oItemMsg	as Json

	Default cMsg 		:= ""
	Default cMsgDesc 	:= ""
	Default cMsgTipo 	:= ""

	if !Empty(cMsg)
		oResponse["_messages"] 		:= {}
		oItemMsg                 	:= JsonObject():new()
		oItemMsg["code"]            := ""
		oItemMsg["message"]         := cMsg
		oItemMsg["detailedMessage"] := cMsgDesc
		oItemMsg["type"]            := cMsgTipo

		aadd(oResponse["_messages"],oItemMsg)
	Endif
Return EncodeUTF8(FwCutOff(oResponse:toJson()))

/*/{Protheus.doc} fDateToJson
	Converte data para o tipo lido no POUI.
	@type Method
	@version 12.1.2410
	@author Caio Kretzer
	@since 24/10/2024
	@param cData, Character, Data a ser convertida
	@return Character, Data no formato para o POUI
/*/
Static Function fDateToJson(cData)
	If ValType(cData) == "D"
		cData := DtoS(cData)
	Endif

	If !Empty(cData)
		cData := Left(cData,4) + '-' + Subs(cData,5,2) + '-' + Right(cData,2)
	Endif
Return cData

/*/{Protheus.doc} fGeraReportSched
	Gera task no novo schedule
	@type Method
	@version 12.1.2410
	@author caio.kretzer
	@since 29/11/2024
	@param cData, Character, Data a ser convertida
	@return Character, Data no formato para o POUI
/*/
Static Function fGeraReportSched(cRoutine As Character, nModule As Numeric, aMVPar As Array, nErroCod as Numeric, cMsg as Character, cMsgDesc as Character, cMsgTipo as Character)

	Local cLibVersion as Character
	Local lValid as Logical

	lValid := .F.

	cLibVersion := FwLibVersion()

	If (cLibVersion >= "20240408" .and. totvs.framework.smartschedule.startSchedule.smartSchedIsRunning() .and. totvs.framework.eventviewer.checkNewEventViewer())
		oTask := totvs.framework.schedule.utils.createTask(GetEnvServer(), cEmpAnt, cFilAnt, cRoutine, nModule, RetCodUsr(), NIL, aMVPar)

		// Verifica se a tarefa foi criada com sucesso
		If (oTask != NIL .and. !Empty(oTask:cID))
			lValid := .T.
		EndIf
	Else
		nErroCod 	:= 500
		cMsg 		:= STR0001
		cMsgDesc := IIf(cLibVersion < "20240408", STR0013 + CRLF + CRLF + STR0014,;
			IIf(!totvs.framework.smartschedule.startSchedule.smartSchedIsRunning(), STR0015 + CRLF + CRLF + STR0016,;
			STR0017 + CRLF + CRLF + STR0018))
		cMsgTipo	:= "error"
	EndIf
Return lValid
