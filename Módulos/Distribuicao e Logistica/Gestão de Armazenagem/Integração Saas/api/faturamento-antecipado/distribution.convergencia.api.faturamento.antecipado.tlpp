#include "tlpp-core.th"
#include "tlpp-rest.th"

#define INTEGRADO WMSSaasConvergencia():getStatusIntegrado()
#define CANCELADO WMSSaasConvergencia():getStatusCancelado()

@Post("/wms/api/v2/notasFiscaisSaida/atualizarParaIntegradoPorChaveExterna")
Function WMSSaasFaturamentoAntecipadoAtualizar()
Local oAdapter := WMSSaasFaturamentoAntecipadoAdapter():New()
    WMSSaasUpdateStatus(oRest, oAdapter, INTEGRADO)
Return

@Post("/wms/api/v2/notasFiscaisSaida/finalizarSeparacaoPorChaveExterna")
Function WMSaasFaturamentoAntecipadoFinalizar()
Local oAdapter := WMSSaasFaturamentoAntecipadoAdapter():New()
    WMSSaasFinish(oRest, oAdapter)
Return

@Post("/wms/api/v2/notasFiscaisSaida/cancelarPorChaveExterna")
Function WMSaasFaturamentoAntecipadoCancelar()
Local oAdapter := WMSSaasFaturamentoAntecipadoAdapter():New()
    WMSSaasUpdateStatus(oRest, oAdapter, CANCELADO)
Return

/*/{Protheus.doc} WMSSaasFaturamentoAntecipadoGetAll
    Servico de retorno da api de getAll FaturamentoAntecipados
    @author Filipe Mendes
    @since 16/10/2024
    @version 1.0
    @obs Funcao para tratar get dos pedidos de venda
    /*/
@Get("/wms/api/v2/notasFiscaisSaida")
Function WMSSaasFaturamentoAntecipadoGetAll()
Local oError
Local oSuccess := WMSSaasRestFinish():new(@oRest)
Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oFaturamentoAntecipado := WMSSaasFaturamentoAntecipadoAdapter():getAll(oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oFaturamentoAntecipado:GetJSONResponse())
        
        FwFreeObj(oFaturamentoAntecipado)
	Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return

/*/{Protheus.doc} WMSSaasFaturamentoAntecipadoGetById
    Servico de retorno da api de getId FaturamentoAntecipados
    @author Filipe Mendes
    @since 16/10/2024
    @version 1.0
    @obs funcao para pegar os pedidos de venda por Id
    /*/
@Post("/wms/api/v2/notasFiscaisSaida/buscarPorChaveExterna")
Function WMSSaasFaturamentoAntecipadoGetById()
Local oError
Local oSuccess := WMSSaasRestFinish():new(@oRest)
Local bError   := ErrorBlock( { |oError| WMSSaasErrorBlock( oError ) } )
    
    Begin Sequence
        oJsonBody := WMSSaasParseBodyFromRest(oRest)
        oQueryParams := WMSSaasGetQueryParamsFromRest(oRest)
        oFaturamentoAntecipado := WMSSaasFaturamentoAntecipadoAdapter():getById(oJsonBody['dadosExternos']['id'],oQueryParams['page'], oQueryParams['pageSize'])

        oSuccess:setStatus(200)
        oSuccess:setResponse(oFaturamentoAntecipado:GetJSONResponse())
        
        FwFreeObj(oFaturamentoAntecipado)
	Recover using oKnownError
		SetRestFault(oKnownError:getStatus(),oKnownError:getDescription(),.T.,oKnownError:getStatus(),oKnownError:getDetailedMessage())
		Return .F.
	End Sequence

    ErrorBlock( bError )
Return
