#include "msobject.ch"
#include "totvs.framework.treports.integratedprovider.th"
#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "FWLIBVERSION.CH"
#include "PROTHEUS.CH"
#include "rh.sv.gpe.gper070.ch"

namespace totvs.protheus.rh.treportsintegratedprovider

Static lItemClVl

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGAGPE", tables="SRA, SRT", name="Relatório de Provisões", country="ALL", initialRelease="12.1.2310")
class GPER070TReportsBusinessObject from totvs.framework.treports.integratedprovider.IntegratedProvider
    public method new() as object
    public method getDescription() as character
    public method getData() as object
    public method getSchema() as object
    private method getWherePar() as character
    private method SVProvisao() as variant
    public  method montaProv() as variant
    private method geraProv() as variant
    private method criaJsonProvFer() as logical
    private method criaJsonProv13() as logical
    private method totalizaProv() as variant
    private method montaTotalProv() as variant
    private method totalCcusto() as logical
    private method totalFilial() as logical
    private method totalEmpresa() as logical

    @Get("/api/rh/smartview/v1/options/gpersv070/:param")
    Public Method getComboBox() as variant
endclass
 
method new() class GPER070TReportsBusinessObject
    _Super:new()

    //Define a Área
    self:appendArea(STR0002) //"RH"

    //Define o nome do Objeto de Negócio
    self:setDisplayName(STR0001) //"Relatório de Provisões"

return self
 
method getDescription() as character class GPER070TReportsBusinessObject
return STR0003 //"Objeto com os registros das Provisões de férias e 13º"

method getData(nPage as numeric, oFilter as object) as object class GPER070TReportsBusinessObject
local nTamCC   := TamSX3("RA_CC")[1] as numeric
local nTamMat  := TamSX3("RA_MAT")[1] as numeric
local nTamNome := TamSX3("RA_NOME")[1] as numeric
local nI as numeric

Private jParams as json
Private jData := JSonObject():new() as json 
Private l13oSal  as logical
Private lFerias  := .T. as logical
Private cFilDe   := Space(FWGETTAMFILIAL) as character
Private cFilAte  := Replicate("Z", FWGETTAMFILIAL) as character
Private cCcDe    := Space(nTamCC) as character
Private cCcAte   := Replicate("Z", nTamCC) as character
Private cMatDe   := Space(nTamMat) as character
Private cMatAte  := Replicate("Z", nTamMat) as character
Private cNomeDe  := Space(nTamNome) as character
Private cNomeAte := Replicate("Z", nTamNome) as character
Private cVldPar as character
Private cCateg   := "" as character
Private dDtRef   := Date() as date
Private nOrdem   := 1 as numeric
Private nPar as numeric
Private nGerRes := 1 as numeric
Private aDataProv := {} as array

DEFAULT lItemClVl := GetMvRH("MV_ITMCLVL", .F., "2") $ "13"

jParams := oFilter:getParameters() //Método para retorno do json dos parâmetros

If jParams['TPPROV', 1] == "2"
    l13oSal := .T.
    lFerias := .F.
EndIf

If !Empty(jParams['TPFORMA', 1]) .And. jParams['TPRELA', 1] == "1"
    nGerRes := Val(jParams['TPFORMA', 1])
EndIf

If !Empty(jParams['ORDER', 1])
    nOrdem := Val(jParams['ORDER', 1])
    If nOrdem == 5  
        nOrdem := If(lItemClVl, 6, 2)
    EndIf    
EndIf

cVldPar := jParams['TPPROV', 1] + jParams['TPFORMA', 1] + jParams['TPRELA', 1] + cValToChar(nOrdem)

If !Empty(jParams['DTREFCALC', 1])
	dDtRef := sToD(StrTran( SubStr(jParams['DTREFCALC', 1], 1, 10), "-" ))
EndIf

self:SVProvisao(oFilter) //Provisão SV

For nI := 1 To Len(aDataProv)
    self:oData:appendData(aDataProv[nI])
Next nI

FwFreeObj(jParams)
FwFreeArray(aDataProv)

return self:oData

method getSchema() as object class GPER070TReportsBusinessObject
    
local aFerVen  := {} as array
local aFerProp := {} as array 
local aFerTot  := {} as array 
local aProv13  := {} as array
local aProv14  := {} as array 
local aTot1314 := {} as array 
local aToTCc1  := {} as array 
local aTotCc2  := {} as array 
local aTotCc3  := {} as array 
local aTotFil1 := {} as array 
local aTotFil2 := {} as array 
local aTotFil3 := {} as array 
local aTotEmp1 := {} as array 
local aTotEmp2 := {} as array 
local aTotEmp3 := {} as array 

self:oSchema:addProperty("filial", STR0004, "string", STR0004, "filial",,,, .F.)             //Filial
self:oSchema:addProperty("ccusto", STR0005, "string", STR0005, "ccusto",,,, .F.)             //Centro de Custo
self:oSchema:addProperty("matricula", STR0006, "string", STR0006, "matricula",,,, .F.)       //Matrícula
self:oSchema:addProperty("nome", STR0007, "string", STR0007, "nome",,,, .F.)                 //Nome
self:oSchema:addProperty("dataAdmissao", STR0008, "date", STR0008, "dataAdmissao",,,, .F.)   //Data de Admissão
self:oSchema:addProperty("dataDemissao", STR0009, "date", STR0009, "dataDemissao",,,, .F.)   //Data de Demissão
self:oSchema:addProperty("cidadeFilial", STR0010, "string", STR0010, "cidadeFilial",,,, .F.) //Cidade da Filial
self:oSchema:addProperty("nomeFilial", STR0011, "string", STR0011, "nomeFilial",,,, .F.)     //Nome da Filial
self:oSchema:addProperty("nomeEmpresa", STR0012, "string", STR0012, "nomeEmpresa",,,, .F.)   //Nome da Empresa
self:oSchema:addProperty("dataCalc", STR0014, "date", STR0014, "dataCalc",,,, .F.)           //Data Cálculo
self:oSchema:addProperty("ccustoProv", STR0013, "string", STR0013, "ccustoProv",,,, .F.)     //Centro de Custo Prov
self:oSchema:addProperty("dataBase", STR0018, "date", STR0018, "dataBase",,,, .F.)           //Data Base Ini. Férias
self:oSchema:addProperty("feriasVenc", STR0020, "number", STR0020, "feriasVenc",,,, .F.)     //Dias Férias Vencidas
self:oSchema:addProperty("feriasProp", STR0021, "number", STR0021, "feriasProp",,,, .F.)     //Dias Férias Proporcionais
self:oSchema:addProperty("feriasAnt", STR0022, "number", STR0022, "feriasAnt",,,, .F.)       //Dias de férias antecipadas
self:oSchema:addProperty("faltVenc", STR0023, "number", STR0023, "faltVenc",,,, .F.)         //Dias Faltas vencidas
self:oSchema:addProperty("falProp", STR0024, "number", STR0024, "falProp",,,, .F.)           //Dias Faltas Proporcionais
self:oSchema:addProperty("tpMovimento", STR0025, "number", STR0025, "tpMovimento",,,, .F.)   //Tipo Movimento 
self:oSchema:addProperty("salario", STR0026, "number", STR0026, "salario",,,, .F.)           //Salário
self:oSchema:addProperty("avos13", STR0027, "number", STR0027, "avos13",,,, .F.)             //Avos 13º Salário
self:oSchema:addProperty("sitfolh", STR0055, "string", STR0055, "sitfolh",,,, .F.)           //Situação
self:oSchema:addProperty("item", STR0029, "string", STR0029, "item",,,, .F.)                 //Item        
self:oSchema:addProperty("clvl", STR0030, "string", STR0030, "clvl",,,, .F.)                 //Classe Valor 
self:oSchema:addProperty("OrdemImp", "OrdemImp", "number", "OrdemImp", "OrdemImp",,,, .F.) //OrdemImp

//Férias venciadas
aAdd(aFerVen, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aFerVen, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aFerVen, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aFerVen, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aFerVen, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aFerVen, {"nVal1Te", STR0058, "number", STR0058})  //Valor 1/3 de Férias
aAdd(aFerVen, {"nTotFer", STR0059, "number", STR0059})  //Total Férias
aAdd(aFerVen, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aFerVen, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aFerVen, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aFerVen, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aFerVen, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aFerVen, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aFerVen, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetFerVen", STR0053, STR0053,, aFerVen) //Férias Vencidas 

//Férias proporcionais
aAdd(aFerProp, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aFerProp, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aFerProp, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aFerProp, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aFerProp, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aFerProp, {"nVal1Te", STR0058, "number", STR0058})  //Valor 1/3 de Férias
aAdd(aFerProp, {"nTotFer", STR0059, "number", STR0059})  //Total Férias
aAdd(aFerProp, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aFerProp, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aFerProp, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aFerProp, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aFerProp, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aFerProp, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aFerProp, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetFerPro", STR0054, STR0054,, aFerProp) //Férias proporcionais 

//Férias Totais
aAdd(aFerTot, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aFerTot, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aFerTot, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aFerTot, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aFerTot, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aFerTot, {"nVal1Te", STR0058, "number", STR0058})  //Valor 1/3 de Férias
aAdd(aFerTot, {"nTotFer", STR0059, "number", STR0059})  //Total Férias
aAdd(aFerTot, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aFerTot, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aFerTot, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aFerTot, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aFerTot, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aFerTot, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aFerTot, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetFerTot", STR0069, STR0069,, aFerTot) //Férias Totais 

//13º
aAdd(aProv13, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aProv13, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aProv13, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aProv13, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aProv13, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aProv13, {"nVal1Te", STR0067, "number", STR0067})  //Valor 1ª Parcela
aAdd(aProv13, {"nTotFer", STR0068, "number", STR0068})  //Total 13º
aAdd(aProv13, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aProv13, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aProv13, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aProv13, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aProv13, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aProv13, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aProv13, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADet13", STR0070, STR0070,, aProv13) //13º Salário

//14º
aAdd(aProv14, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aProv14, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aProv14, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aProv14, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aProv14, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aProv14, {"nVal1Te", STR0067, "number", STR0067})  //Valor 1ª Parcela
aAdd(aProv14, {"nTotFer", STR0071, "number", STR0071})  //Total 14º
aAdd(aProv14, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aProv14, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aProv14, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aProv14, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aProv14, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aProv14, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aProv14, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADet14", STR0072, STR0072,, aProv14) //14º Salário

//Total 13º/14º
aAdd(aTot1314, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTot1314, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTot1314, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTot1314, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTot1314, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTot1314, {"nVal1Te", STR0067, "number", STR0067})  //Valor 1ª Parcela
aAdd(aTot1314, {"nTotFer", STR0068, "number", STR0068})  //Total 13º
aAdd(aTot1314, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTot1314, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTot1314, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTot1314, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTot1314, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTot1314, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTot1314, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTot1314", STR0073, STR0073,, aTot1314) //Totais 13º Salário

//Totalizador centro de custo 1
aAdd(aToTCc1, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aToTCc1, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aToTCc1, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aToTCc1, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aToTCc1, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aToTCc1, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aToTCc1, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aToTCc1, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aToTCc1, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aToTCc1, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aToTCc1, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aToTCc1, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aToTCc1, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aToTCc1, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotCc1", STR0076, STR0076,, aToTCc1) //Totalizador centro de custo 1

//Totalizador centro de custo 2
aAdd(aToTCc2, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aToTCc2, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aToTCc2, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aToTCc2, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aToTCc2, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aToTCc2, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aToTCc2, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aToTCc2, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aToTCc2, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aToTCc2, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aToTCc2, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aToTCc2, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aToTCc2, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aToTCc2, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotCc2", STR0077, STR0077,, aToTCc2) //Totalizador centro de custo 2

//Totalizador centro de custo 3
aAdd(aToTCc3, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aToTCc3, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aToTCc3, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aToTCc3, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aToTCc3, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aToTCc3, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aToTCc3, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aToTCc3, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aToTCc3, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aToTCc3, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aToTCc3, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aToTCc3, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aToTCc3, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aToTCc3, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotCc3", STR0078, STR0078,, aToTCc3) //Totalizador centro de custo 3

//Totalizador Filial 1
aAdd(aTotFil1, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotFil1, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotFil1, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotFil1, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotFil1, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotFil1, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotFil1, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotFil1, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotFil1, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotFil1, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotFil1, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotFil1, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotFil1, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotFil1, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotFil1", STR0079, STR0079,, aTotFil1) //Totalizador Filial 1

//Totalizador Filial 2
aAdd(aTotFil2, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotFil2, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotFil2, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotFil2, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotFil2, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotFil2, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotFil2, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotFil2, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotFil2, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotFil2, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotFil2, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotFil2, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotFil2, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotFil2, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotFil2", STR0080, STR0080,, aTotFil2) //Totalizador Filial 2

//Totalizador Filial 3
aAdd(aTotFil3, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotFil3, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotFil3, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotFil3, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotFil3, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotFil3, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotFil3, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotFil3, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotFil3, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotFil3, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotFil3, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotFil3, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotFil3, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotFil3, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotFil3", STR0081, STR0081,, aTotFil3) //Totalizador Filial 3

//Totalizador Empresa 1
aAdd(aTotEmp1, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotEmp1, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotEmp1, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotEmp1, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotEmp1, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotEmp1, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotEmp1, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotEmp1, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotEmp1, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotEmp1, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotEmp1, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotEmp1, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotEmp1, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotEmp1, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotEmp1", STR0082, STR0082,, aTotEmp1) //Totalizador Empresa 1

//Totalizador Empresa 2
aAdd(aTotEmp2, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotEmp2, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotEmp2, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotEmp2, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotEmp2, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotEmp2, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotEmp2, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotEmp2, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotEmp2, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotEmp2, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotEmp2, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotEmp2, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotEmp2, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotEmp2, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotEmp2", STR0083, STR0083,, aTotEmp2) //Totalizador Empresa 2

//Totalizador Empresa 3
aAdd(aTotEmp3, {"tpProv", STR0015, "number", STR0015})   //Tipo de Provisão
aAdd(aTotEmp3, {"Filial", STR0004, "string", STR0004})   //Filial
aAdd(aTotEmp3, {"cCusto", STR0013, "string", STR0013})   //Centro de Custo Prov
aAdd(aTotEmp3, {"nValPro", STR0056, "number",STR0056})   //Valor Provisão
aAdd(aTotEmp3, {"nValAdi", STR0057, "number", STR0057})  //Valor Adicional
aAdd(aTotEmp3, {"nVal1Te", STR0074, "number", STR0074})  //Valor 1ª Parcela e 1/3 de Férias
aAdd(aTotEmp3, {"nTotFer", STR0075, "number", STR0075})  //Total 13º e Férias
aAdd(aTotEmp3, {"nValIns", STR0060, "number", STR0060})  //Total INSS
aAdd(aTotEmp3, {"nValFgt", STR0061, "number", STR0061})  //Total FGTS
aAdd(aTotEmp3, {"nValPis", STR0062, "number", STR0062})  //Valor PIS
aAdd(aTotEmp3, {"nValSalV", STR0063, "number", STR0063}) //Média Salário
aAdd(aTotEmp3, {"nTotEnc", STR0064, "number", STR0064})  //Total Encargos
aAdd(aTotEmp3, {"lPIS", STR0065, "boolean", STR0065})    //Tem PIS
aAdd(aTotEmp3, {"nTotGer", STR0066, "number", STR0066})  //Total Geral

self:addNestedProperty("ADetTotEmp3", STR0084, STR0084,, aTotEmp3) //Totalizador Empresa 3

//Parâmetros
self:addParameter("DTREFCALC", STR0032, "date", .F.)  //Data Ref. Calc. ?
self:addParameter("TPPROV", STR0033, "string", .F.)   //Tipo da Provisão ?
self:addParameter("FILDE", STR0034, "string", .F.)    //Filial De ?
self:addParameter("FILATE", STR0035, "string", .F.)   //Filial Até ?
self:addParameter("CCDE", STR0036, "string", .F.)     //Centro de Custo De ?
self:addParameter("CCATE", STR0037, "string", .F.)    //Centro de Custo Até ?
self:addParameter("MATDE", STR0038, "string", .F.)    //Matrícula De ?
self:addParameter("MATATE", STR0039, "string", .F.)   //Matrícula Até ?
self:addParameter("NOMEDE", STR0040, "string", .F.)   //Nome De ?
self:addParameter("NOMEATE", STR0041, "string", .F.)  //Nome Até ?
self:addParameter("TPRELA", STR0042, "string", .F.)   //Tipo de relação ?
self:addParameter("TPFORMA", STR0043, "string", .F.)  //Forma de Apresentação ?
self:addParameter("CATFUNC", STR0044, "string", .T.)  //Categoria do Funcionário ?
self:addParameter("ORDER", STR0045, "string", .F.)    //Ordem de Impressão ?

//setCustomURL disponível na LIB 20231121.
If FWLibVersion() >= "20231121" 
    self:setCustomURL("FILDE", "api/rh/smartview/v1/options/GPEParams/getBranches", 2)
    self:setCustomURL("FILATE", "api/rh/smartview/v1/options/GPEParams/getBranches", 2)
    self:setCustomURL("MATDE", "api/framework/v1/genericLookupService/smartview/SRA", 2)
    self:setCustomURL("MATATE", "api/framework/v1/genericLookupService/smartview/SRA", 2)
    self:setCustomURL("CCDE", "api/framework/v1/genericLookupService/smartview/CTT", 2)
    self:setCustomURL("CCATE", "api/framework/v1/genericLookupService/smartview/CTT", 2)
    self:setCustomURL("CATFUNC", "api/framework/v1/genericLookupService/smartview/28", 2)
    self:setCustomURL("ORDER", "/api/rh/smartview/v1/options/gpersv070/ORDER", 1)
    self:setCustomURL("TPPROV", "/api/rh/smartview/v1/options/gpersv070/TPPROV", 1) 
    self:setCustomURL("TPRELA", "/api/rh/smartview/v1/options/gpersv070/TPRELA", 1) 
    self:setCustomURL("TPFORMA", "/api/rh/smartview/v1/options/gpersv070/TPFORMA", 1)
EndIf    

return self:oSchema

/*/{Protheus.doc} getWherePar
Metodo que retorna a consulta conforme os parâmetros
@type  Metodo
@author Bruno Costa
@return character
@since 16/10/2024
/*/
method getWherePar(jPar as json) as character class GPER070TReportsBusinessObject
    
local cRet as character

If !Empty(jPar['FILDE', 1])
    cRet += " SRA.RA_FILIAL >= ? AND "
    cFilDe := jPar['FILDE', 1]
EndIf
If !Empty(jPar['FILATE', 1])
    cRet += " SRA.RA_FILIAL <= ? AND "
    cFilAte := jPar['FILATE', 1]
EndIf
If !Empty(jPar['MATDE', 1])
    cRet += " SRA.RA_MAT >= ? AND "
    cMatDe := jPar['MATDE', 1]
EndIf
If !Empty(jPar['MATATE', 1])
    cRet += " SRA.RA_MAT <= ? AND "
    cMatAte := jPar['MATATE', 1]
EndIf
If !Empty(jPar['CCDE', 1])
    cRet += " SRA.RA_CC >= ? AND "
    cCcDe := jPar['CCDE', 1]
EndIf
If !Empty(jPar['CCATE', 1])
    cRet += " SRA.RA_CC <= ? AND "
    cCCAte := jPar['CCATE', 1]
EndIf
If !Empty(jPar['NOMEDE', 1])
    cRet += " SRA.RA_NOME >= ? AND "
    cNomeDe := jPar['NOMEDE', 1]
EndIf
If !Empty(jPar['NOMEATE', 1])
    cRet += " SRA.RA_NOME <= ? AND "
    cNomeAte := jPar['NOMEATE', 1]
EndIf
If !Empty(jPar['CATFUNC'])
    cRet += " SRA.RA_CATFUNC IN (?) AND " 
EndIf  

Return cRet

/*/{Protheus.doc} getComboBox
Metodo que retorna o combobox dos parâmetros
@type  Metodo
@author Bruno Costa
@return Variant, Retorno nulo pré-fixado
@obs Path parameters: param (nome do parâmetro solicitado)
/*/
Method getComboBox() as Variant Class GPER070TReportsBusinessObject

local jPath     as JSON     
local jResponse as JSON      
local jItem     as JSON      
local nValues   as Numeric   
local cParam    As Character 
local aValues   as Array   

jPath     := oRest:getPathParamsRequest()
jResponse := JsonObject():new()
jItem     := NIL
nValues   := 0
cParam    := ""
aValues   := {}

If (jPath != NIL)
    cParam := jPath["param"]
EndIf

jResponse["data"] := {}

// Monta o vetor de valores do parâmetro
If cParam == "ORDER"
    AAdd(aValues, EncodeUTF8(STR0006)) //Matrícula
    AAdd(aValues, EncodeUTF8(STR0046)) //C.Custo
    AAdd(aValues, EncodeUTF8(STR0007)) //Nome
    AAdd(aValues, EncodeUTF8(STR0047)) //C.Custo + Nome 
    AAdd(aValues, EncodeUTF8(STR0088)) //C.Custo + Item + Classe
ElseIf cParam == "TPPROV"
    AAdd(aValues, EncodeUTF8(STR0019)) //Férias
    AAdd(aValues, EncodeUTF8(STR0070)) //13º Salário
ElseIf cParam == "TPRELA"
    AAdd(aValues, EncodeUTF8(STR0049)) //Analítica
    AAdd(aValues, EncodeUTF8(STR0050)) //Sintética
ElseIf cParam == "TPFORMA"
    AAdd(aValues, EncodeUTF8(STR0051)) //Geral
    AAdd(aValues, EncodeUTF8(STR0052)) //Resumida   
EndIf 

If (Len(aValues) > 0)
    For nValues := 1 To Len(aValues)
        jItem := {;
            "key":   CValToChar(nValues),;
            "label": aValues[nValues];
        }
        AAdd(jResponse["data"], jItem)
    Next nValues
EndIf

// Define a resposta da requisição
oRest:setResponse(jResponse)
oRest:setStatusCode(200)
oRest:setKeyHeaderResponse("Content-Type", "application/json; charset=utf-8")
oRest:setKeyHeaderResponse("Accept-Encoding", "UTF-8")

// Libera os objetos da memória
FwFreeObj(jPath)
FwFreeObj(jResponse)
FwFreeObj(jItem)
FwFreeArray(aValues)

Return NIL

/*-------------------------------------------------------------------
{Protheus.doc} SVProvisao
Inicia as variáveis privates para geração da provisão

@author	Bruno Costa
@since	21/10/2024
-------------------------------------------------------------------*/
Method SVProvisao(oFilter as object) Class GPER070TReportsBusinessObject

// INDICA O TIPO DE PROVISAO (SERA GRAVADO NO CAMPO RT_TIPPROV)
Private _FerVenc  := 1  // Ferias Vencidas
Private _FerProp  := 2  // Ferias Proporcionais
Private _13Salar  := 3  // 13o Salario
Private _14Salar  := 4  // 14o Salario
Private _FerVMes  := 5	// Ferias Provisao Mes
Private _13SVMes  := 6  // 13o Provisao Mes
Private _RecVenc  := 7	// Recesso Vencido
Private _RecProp  := 8	// Recesso Proporcional
Private _PlrSalar := 9  // PLR Provisao
Private _PlrSVMes := 10  //PLR Provisao Mes
Private _cPDPlr    := "XXX"
Private _cPdBxPLR  := "XX1"
Private _cPdMesPLR := "XX2"
Private _cPDTrfPLR := "XX3"
Private _cPDResPLR := "XX4"
// INDICA A LINHA NA ORDEM EM QUE SERA APRESENTADA NO RELATORIO
Private _Anter    := 01  // Mes Anterior
Private _Corre    := 02  // Correcao
Private _NoMes    := 03  // No Mes
Private _Atual    := 04  // Mes Atual
Private _BxTrf    := 05  // Baixa de Transferencia
Private _BxFer    := 06  // Baixa de Ferias
Private _BX13O    := 06  // Baixa de 13o Salario
Private _Bx14o    := 06  // Baixa de 14o Salario
Private _BxPLR    := 06  // Baixa de PLR
Private _BxRes    := 07  // Baixa de Rescisao
Private _TrfEnt   := 08  // Transferencia de Entrada
Private _TrfSai   := 09  // Transferencia de Saida
Private _BxTot    := 10  // Baixa Total
// INDICA A COLUNA NA ORDEM EM QUE SERA APRESENTADA NO RELATORIO
Private _Dias     := 1  // Dias de Ferias
Private _Avos     := 1  // Avos de 13o Salario
Private _Prov     := 2  // Valor da Provisao de Ferias ou Decimo Terceiro Salario
Private _Adic     := 3  // Adicionais
Private _1Ter     := 4  // Um Terco de Ferias
Private _1Par     := 4  // 1o Parcela do 13o Salario
Private _INSS     := 5  // INSS
Private _FGTS     := 6  // FGTS
Private _SalV	  := 7  // Media Salario Vac
Private _PIS      := 8  // PIS
// CONSTANTES QUE DEFINEM O NUMERO DE LINHAS E COLUNAS DO ARRAY
Private _Linhas   := 10  // Quantidade de Linhas ou Elementos
Private _Colunas  := 08  // Quantidade de colunas para cada Linha ou Elemento
// INDICA A POSICAO DAS INFORMACOES DE CABECALHO EM "aCabProv"
Private _DatCalc  :=  1  // Data do calculo
Private _CentroC  :=  2  // Data do calculo
Private _DBsProv  :=  3  // Data base de ferias
Private _DFerVen  :=  4  // Dias de ferias vencidas
Private _DFerPro  :=  5  // Dias de ferias proporcionais
Private _DFerAnt  :=  6  // Dias de ferias antecipadas
Private _DFalVen  :=  7  // Dias de faltas vencidas
Private _DFalPro  :=  8  // Dias de faltas proporcionais
Private _MovProv  :=  9  // Movimentacao no mes
Private _SalProv  := 10  // Salario da provisao no mes
Private _Avos13S  := 11  // Avos de 13o salario
Private _PStatus  := 12  // Status (Ativo/Excluido)
Private _CItem	  := 13  // Item Contabil
Private _Clvl	  := 14  // Classe de Valor
// INDICA OS TIPOS DE MOVIMENTACAO DO FUNCIONARIO NO MES
Private _Demitido := 1  // Demitido
Private _Cong_Fer := 2  // Congelado Ferias
Private _Cong_13s := 3  // Congelado 13 Salario
Private _Cong_F13 := 4  // Congelado Ferias e 13 Salario
Private _Trfe_Sai := 5  // Transferencia Saida
Private _Trfe_Ent := 6  // Transferencia Entrada
// INDICA AS POSICOES DENTRO DO ARRAY aTransf
Private _TAnter   := 1  // Centro de Custo Anterior
Private _TAtual   := 2  // Centro de Custo Atual
Private _TDest    := 3  // Centro de Custo Destino
Private _TEmp     := 1  // Empresa
Private _TFil     := 2  // Filial
Private _TCC      := 3  // Centro de Custo
Private _TMat     := 4  // Matricula
Private _TDta     := 5  // Data da Transferencia
Private _TInc     := 6  // Funcionario ja incluido no arquivo temporario
Private _TItem	  := 7  // Item Contabil
Private _TClvl	  := 8  // Classe de Valor

Private aFldRot 	:= {'RA_NOME'}
Private aOfusca	 	:= If(FindFunction('ChkOfusca'), ChkOfusca(), {.T.,.F.}) //[1] Acesso; [2]Ofusca
Private lOfuscaNom 	:= .F.
Private aFldOfusca	:= {}

If aOfusca[2]
	aFldOfusca := FwProtectedDataUtil():UsrNoAccessFieldsInList( aFldRot ) // CAMPOS SEM ACESSO
	IF aScan( aFldOfusca , { |x| x:CFIELD == "RA_NOME" } ) > 0
		lOfuscaNom := FwProtectedDataUtil():IsFieldInList( "RA_NOME" )
	EndIf
EndIf

self:geraProv(oFilter)

Return

/*-------------------------------------------------------------------
{Protheus.doc} geraProv
Gera a provisão de Férias ou 13º

@author	Bruno Costa
@since	21/10/2024
-------------------------------------------------------------------*/
Method geraProv(oFilter as object) Class GPER070TReportsBusinessObject
local nCnt2 as numeric
local nCnt1 as numeric
local nTemVal as numeric
local nOrderImp := 1 as numeric
local lRetu1 as logical
local lRetu2 as logical
local aAreaSRA   := SRA->(GetArea()) as array
local cAcessaSRA := "{ || " + ChkRH(If(lFerias, "GPER070", "GPER090"), "SRA", "2") + "}" as character
local cSitProv as character

Private aFerVenc   := Array(_Linhas,_Colunas)
Private aFerProp   := Array(_Linhas,_Colunas)
Private aTotVePr   := Array(_Linhas,_Colunas)
Private a13Salar   := Array(_Linhas,_Colunas)
Private a14Salar   := Array(_Linhas,_Colunas)
Private aTot1314   := Array(_Linhas,_Colunas)
Private aCabProv   := {} as array
Private aVerba     := {} as array
Private aTransf    := {} as array
Private aTotCc1    := {} as array
Private aTotCc2    := {} as array
Private aTotCc3    := {} as array
Private aTotFil1   := {} as array
Private aTotFil2   := {} as array
Private aTotFil3   := {} as array
Private aTotEmp1   := {} as array
Private aTotEmp2   := {} as array
Private aTotEmp3   := {} as array
Private aInfo	   := {} as array
Private aCodFol    := {} as array
Private aIndice	   := {} as array
Private lSalInc as logical
Private lINSSAut as logical
Private lTrataTrf as logical
Private lCalcPis as logical
Private lGeraPMes as logical
Private cTpRtProv as character
Private cFilialAnt as character
Private cCcAnt as character
Private cDescCc as character
Private cItAnt as character
Private cClAnt as character

self:montaProv(nOrdem, dDtRef, @lSalInc, @lTrataTrf, @aTransf, .T., cAcessaSRA, oFilter) //Monta o arquivo com os funcionários para provisão

dbSelectArea("SRA")
dbSetOrder(1)

dbSelectArea(cTBLXPROV)
dbGoTop()

cFilialAnt := Replicate("!", FWGETTAMFILIAL)
cCcAnt	   := "!!!!!!!!!"
While !Eof()
	dbSelectArea("SRA")
	dbSeek((cTBLXPROV)->PR_FILIAL + (cTBLXPROV)->PR_MAT)
	dbSelectArea(cTBLXPROV)

	If (cTBLXPROV)->PR_FILIAL != cFilialAnt //QUEBRA DE FILIAL       
		If !Fp_CodFol(@aCodFol, (cTBLXPROV)->PR_FILIAL) .Or. !fInfo(@aInfo, (cTBLXPROV)->PR_FILIAL); Exit 
        EndIF
		cFilialAnt := (cTBLXPROV)->PR_FILIAL
		//CARREGA OS IDENTIFICADORES DA PROVISAO
		fIdentProv(@aVerba, aCodFol, .T., .F.)
		//VERIFICA A EXISTENCIA DOS IDENTIFICADORES DO PIS
		lCalcPis := (!Empty(aCodFol[416,1]))
	EndIf

	//LIMPA O ARRAY COM O CONTEUDO ESPECIFICADO NO 2º PARAMETRO
	fLimpaArray(If(lFerias, @aTotVePr, @aTot1314), 0) 

	//BUSCA INFORMACOES DE CABECALHO NO SRT
	If !fBusCabSRT(dDtRef, @aCabProv)
        self:montaTotalProv(If(lFerias, _FerVenc, _13Salar), .T.) //Monta Totalizadores
		Loop
	EndIf

    cSitProv := If(aCabProv[_MovProv] == If(lFerias, _Cong_Fer, _Cong_13s) .Or. aCabProv[_MovProv] == _Cong_F13, STR0085, If(aCabProv[_MovProv] == _Trfe_Sai, STR0086, "")) //"Congelado"###"Transferência"

    jData := {;
        "filial":       (cTBLXPROV)->PR_FILIAL,;
        "nome":         If(lOfuscaNom, Replicate('*', 15), RTrim((cTBLXPROV)->PR_NOME)),;
        "matricula":    (cTBLXPROV)->PR_MAT,;
        "ccusto":       RTrim((cTBLXPROV)->PR_CC),;
        "sitfolh":      cSitProv,;
        "cidadeFilial": RTrim(aInfo[05]),; 
        "nomeFilial":   RTrim(aInfo[03]),;
        "dataAdmissao": FwTimeStamp(5, (cTBLXPROV)->PR_ADMISSA, "00:00:00" ),;
        "dataDemissao": Iif(!Empty((cTBLXPROV)->PR_DEMISSA), FwTimeStamp(5, (cTBLXPROV)->PR_DEMISSA, "00:00:00"), Nil),;
        "nomeEmpresa":  RTrim(aInfo[02]),;
        "dataCalc":     FwTimeStamp(5, aCabProv[_DatCalc], "00:00:00"),;
        "ccustoProv":   RTrim(aCabProv[_CentroC]),;
        "dataBase":     FwTimeStamp(5, aCabProv[_DBsProv], "00:00:00"),;
        "feriasVenc":   aCabProv[_DFerVen],;
        "feriasProp":   aCabProv[_DFerPro],;
        "feriasAnt":    aCabProv[_DFerAnt],;
        "faltVenc":     aCabProv[_DFalVen],;
        "falProp":      aCabProv[_DFalPro],;
        "tpMovimento":  aCabProv[_MovProv],;
        "salario":      aCabProv[_SalProv],;
        "avos13":       aCabProv[_Avos13S],;
        "item":         If(lItemClVl, aCabProv[_cItem], ""),;
        "clvl":         If(lItemClVl, aCabProv[_Clvl], ""),;
        "OrdemImp":     nOrderImp++;
            } 

	//BUSCA OS LANCAMENTOS DE FERIAS VENCIDAS E PROPORCIONAIS
	fQryDetSRT(aVerba, aTransf, dDtRef, lTrataTrf, .T., lFerias, l13oSal)

    If lFerias
        nTemVal := 0
        
        //TOTALIZADOR -> VENCIDAS + PROPORCIONAIS
        For nCnt1 := 1 To _Linhas
            For nCnt2 := 1 To _Colunas
                aTotVePr[nCnt1, nCnt2] := aFerVenc[nCnt1, nCnt2] + aFerProp[nCnt1, nCnt2]
                nTemVal += aFerVenc[nCnt1, nCnt2] + aFerProp[nCnt1, nCnt2]
            Next nCnt2
        Next nCnt1

        //Totaliza os arrays
        self:totalizaProv(@aToTCc1, @aTotCc2, @aTotCc3, aFerVenc, aFerProp, aTotVePr)    // Centro de Custo
        self:totalizaProv(@aTotFil1, @aTotFil2, @aTotFil3, aFerVenc, aFerProp, aTotVePr) // Filial
        self:totalizaProv(@aTotEmp1, @aTotEmp2, @aTotEmp3, aFerVenc, aFerProp, aTotVePr) // Empresa 
        
        If nTemVal > 0 
            jData["ADetFerVen"] := {}
            jData["ADetFerPro"] := {}
            jData["ADetFerTot"] := {}

            //Cria o Nested da provisão de férias
            lRetu1 := self:criaJsonProvFer(aFerVenc, "ADetFerVen")
            lRetu2 := self:criaJsonProvFer(aFerProp, "ADetFerPro")
            If lRetu1 .And. lRetu2
                self:criaJsonProvFer(aTotVePr, "ADetFerTot")
            EndIf
        EndIf

        self:montaTotalProv(_FerVenc, .F.) //Totais

    ElseIf l13oSal
        //TOTALIZADOR (13º + 14º)
        For nCnt1 := 1 To _Linhas
            For nCnt2 := 1 To _Colunas
                aTot1314[nCnt1,nCnt2] := a13Salar[nCnt1,nCnt2]+a14Salar[nCnt1,nCnt2]
            Next nCnt2
        Next nCnt1
        
        //Totaliza os arrays
        self:totalizaProv(@aToTCc1 , @aTotCc2 , @aTotCc3, a13Salar, a14Salar, aTot1314)  // Centro de Custo
        self:totalizaProv(@aTotFil1, @aTotFil2, @aTotFil3, a13Salar, a14Salar, aTot1314) // Filial
        self:totalizaProv(@aTotEmp1, @aTotEmp2, @aTotEmp3, a13Salar, a14Salar, aTot1314) // Empresa
      
        jData["ADet13"]      := {}
        jData["ADet14"]      := {}
        jData["ADetTot1314"] := {}

        //Cria o Nested da provisão de 13º
        lRetu1 := self:criaJsonProv13(a13Salar, "ADet13")
        lRetu2 := self:criaJsonProv13(a14Salar, "ADet14") 
        If lRetu1 .And. lRetu2
            self:criaJsonProv13(aTot1314, "ADetTot1314")
        EndIf

        self:montaTotalProv(_13Salar) //Totais

    EndIf
EndDo

(cTBLXPROV)->(dbCloseArea())

//Elimina arquivo temporário de provisão
fDelTMPPRV()

RestArea(aAreaSRA)

Return Nil

/*-------------------------------------------------------------------
{Protheus.doc} montaProv
Monta arquivo de provisão

@author	Bruno Costa
@since	22/10/2024
-------------------------------------------------------------------*/
method montaProv(nOrdem as numeric, dDataRef as date, lSalInc as logical, lTrataTrf as logical, aTransf as array, lIncDemit as logical, cAcessaArq as character, oFilter as object) as variant class GPER070TReportsBusinessObject
local aVerbaProv := {} as array
local aCodFol 	 := {} as array
local aStruSRA 	 := {} as array
local aSRASRT	 := {} as array
local aVerbasTPR := {} as array
local aCatE      := {"107", "108"} as array
local aParams as array
local aCategoria as array 
local bChkSRA as character
local bChkSRE as character
local cInicio as character
local cFim as character
local cSitFolh as character
local cTipAfas as character
local cCposQuery as character
local cCposSRA as character
local cCusto as character
local cCustoAtu as character
local cClvl as character
local cClvlAtu as character 
local cItem as character 
local cItemAtu  as character 
local cCateg as character
local cAliasSRA	:= "SRA" as character 
local cOrdem as character 
local cQuery as character  
local cWhere as character 
local dAfaIni := CtoD("") as date
local dAfaFim := CtoD("") as date
local nK1 as numeric
local nK2 as numeric
local nTpMv as numeric
local nPosFunc as numeric
local nTrfProc as numeric
local nPosFunc1 as numeric
local nReg as numeric
local nPR_TIPMOVI as numeric
local nPosTransf as numeric
local nPosFunc2 as numeric
local nPosFunc3	as numeric
local nTPosCc as numeric
local nPOrder as numeric
local nI as numeric
local lTransCC as logical
local lTransfEmp as logical

DEFAULT lItemClVl := GetMvRH("MV_ITMCLVL", .F., "2") $ "13"
DEFAULT aCcEmpTra := {}

Static oStatement
Static __cEmpAnt := cEmpAnt
Static _BkpFilial  := ""
Static __cWhere    := ""
Static __cVldPar   := ""
Static _aCodFol	   := {}
Static _lBkpTraTrf := .F.

cWhere     := self:getWherePar(jParams)
nPOrder    := 1
aParams    := {"FILDE", "FILATE", "MATDE", "MATATE", "CCDE", "CCATE", "NOMEDE", "NOMEATE", "CATFUNC"}
aCategoria := IIf(jParams:hasProperty("CATFUNC"), jParams["CATFUNC"], {})
 
For nI := 1 To Len(aCategoria)
    aCategoria[nI] := IIf(aCategoria[nI] == NIL .Or. Empty(aCategoria[nI]), "M", aCategoria[nI])
    cCateg += IIf(aCategoria[nI] == NIL .Or. Empty(aCategoria[nI]), "M", RTrim(aCategoria[nI]))
Next nI

cCateg     := If(!Empty(cCateg), cCateg, "ACDEGHIJMPST")
bChkSRE    := &(cAcessaArq)
cAcessaArq := StrTran(cAcessaArq, "SRA->","(cAliasSRA)->")
bChkSRA    := &(cAcessaArq)

// VERIFICA A EXISTENCIA DOS IDENTIFICADORES DE TRANSFERENCIA
If _BkpFilial != cFilAnt .Or. Empty(_aCodFol)
	If Fp_CodFol(@aCodFol, cFilAnt)
		// CARREGA OS IDENTIFICADORES DA PROVISAO E TESTA SE EXISTEM
		fIdentProv(@aVerbaProv, aCodFol)
		// VERIFICA A EXISTENCIA DOS IDENTIFICADORES DE TRANSFERENCIA
		lTrataTrf := (fChkIdent(aVerbaProv,_FerVenc,{_BxTrf},.F.) .And. fChkIdent(aVerbaProv,_13Salar,{_BxTrf},.F.))
	EndIf
	_aCodFol	:= aClone(aCodFol)
	_BkpFilial	:= cFilAnt
	_lBkpTraTrf	:= lTrataTrf
EndIf

aCodFol	   := aClone(_aCodFol)
lTrataTrf  := _lBkpTraTrf
lSalInc	   := SRA->(ColumnPos("RA_SALINCO")) > 0
lINSSAut   := SRA->(ColumnPos("RA_INSSAUT")) > 0
cCposQuery := If(lSalInc, "SRA.RA_SALINCO, ", "")
cCposQuery += If(lItemClVl, "SRA.RA_ITEM, RA_CLVL, ", "")
cCposQuery += If(lINSSAut, "SRA.RA_INSSAUT, ", "")
cCposSRA   := "SRA.RA_FILIAL, SRA.RA_MAT, SRA.RA_CC, SRA.RA_NOME, SRA.RA_ADMISSA, SRA.RA_DEMISSA, SRA.RA_SITFOLH, SRA.RA_TPCONTR, SRA.RA_CATFUNC, SRA.RA_AFASFGT, SRA.RA_SALARIO, SRA.RA_HRSMES, SRA.RA_PERICUL, SRA.RA_ADTPOSE, SRA.RA_INSMAX, SRA.R_E_C_N_O_  "
cCposQuery := If(!Empty(cCposQuery), cCposQuery+cCposSRA, cCposSRA) 
cAliasSRA  := "QSRA"

If(Select(cAliasSRA) > 0, (cAliasSRA)->(dbCloseArea()), Nil)

aStruSRA := SRA->(dbStruct())
cOrdem	 := SqlOrder(SRA->(IndexKey(If(nOrdem == 4, 8, nOrdem))))

If oStatement == Nil .Or. __cEmpAnt <> cEmpAnt .Or. !(__cWhere == cWhere) .Or. !(__cVldPar == cVldPar)
    cQuery := "SELECT " + cCposQuery + "FROM " + RetSqlName("SRA") + " SRA "
    cQuery += "WHERE "

    If !Empty(cWhere)
        cQuery += cWhere    
    EndIf

    cQuery += "SRA.RA_ADMISSA <= ? AND (SRA.RA_DEMISSA = ? OR SRA.RA_DEMISSA > ?) AND SRA.RA_TPCONTR <> ? AND " + If(cPaisloc == "BRA" , "SRA.RA_CATEFD NOT IN (?) AND ", "")
    cQuery += "SRA.D_E_L_E_T_ = ? "
    cQuery += "ORDER BY " + cOrdem

    cQuery     := ChangeQuery(cQuery)    
    __cEmpAnt  := cEmpAnt
    __cWhere   := cWhere
    __cVldPar  := cVldPar
    oStatement := FwExecStatement():New(cQuery)
EndIf

For nI := 1 To Len(aParams)
    If Len(jParams[aParams[nI]]) > 0 .And. !Empty(jParams[aParams[nI], 1]) 
        If(aParams[nI] $ "CATFUNC")
            oStatement:SetIn(nPOrder++, aCategoria)
        Else
            oStatement:SetString(nPOrder++, jParams[aParams[nI], 1]) 
        EndIf            
    EndIf
Next nI

oStatement:setDate(nPOrder++, dDataRef)
oStatement:SetString(nPOrder++, " ")
oStatement:setDate(nPOrder++, dDataRef-day(dDataRef)) 
oStatement:SetString(nPOrder++, "3")
If cPaisloc == "BRA" 
    oStatement:SetIn(nPOrder++, aCatE)
EndIf
oStatement:SetString(nPOrder++, " ") 

cAliasSRA := oStatement:OpenAlias() 

//AJUSTA A ESTRUTURA DOS CAMPOS
For nReg := 1 To Len(aStruSRA)
	If (aStruSRA[nReg][2] <> "C") .And. aStruSRA[nReg][1] $ cCposQuery
		TcSetField(cAliasSRA,aStruSRA[nReg][1],aStruSRA[nReg][2],aStruSRA[nReg][3],aStruSRA[nReg][4])
	EndIf
Next nReg

//ORDEM DO ARQUIVO TEMPORARIO
If nOrdem == 1
	cInicio  := "(cAliasSRA)->(RA_FILIAL+RA_MAT)"
	cFim	 := cFilAte + cMatAte
	aIndice  := {"PR_FILIAL", "PR_MAT"}
ElseIf nOrdem == 2
	cInicio  := "(cAliasSRA)->(RA_FILIAL+RA_CC+RA_MAT)" 
	cFim	 := cFilAte + cCcAte + cMatAte
	aIndice  := {"PR_FILIAL", "PR_CC", "PR_MAT"}
ElseIf nOrdem == 3
	cInicio  := "(cAliasSRA)->(RA_FILIAL+RA_NOME+RA_MAT)" 
	cFim	 := cFilAte + cNomeAte + cMatAte
	aIndice  := {"PR_FILIAL", "PR_NOME", "PR_MAT"}
ElseIf nOrdem == 4
	cInicio  := "(cAliasSRA)->(RA_FILIAL+RA_CC+RA_NOME)" 
	cFim	 := cFilAte + cCcAte + cNomeAte
	aIndice  := {"PR_FILIAL", "PR_CC", "PR_NOME"}
ElseIf nOrdem == 6
	cInicio  := "(cAliasSRA)->(RA_FILIAL+RA_CC+RA_MAT)" 
	cFim	 := cFilAte + cCcAte + cMatAte
	aIndice  := {"PR_FILIAL", "PR_CC", "PR_ITEM", "PR_CLVL", "PR_MAT"}
EndIf

aTransf := {}
fSeleTransf(@aTransf, dDataRef, "")

Cria_TPR(aIndice)

dbSelectArea(cAliasSRA)

While !(cAliasSRA)->(Eof()) .And. &cInicio <= cFim

	nTpMv 	   := 0
	lTransfEmp := .F.
	aSRASRT	   := {}
	aVerbasTPR := {}
    cCusto 	   :=  ""
    cCustoAtu  :=  ""
    cClvl 	   :=  ""
    cClvlAtu   :=  ""
    cItem 	   :=  ""
    cItemAtu   :=  ""

	SRA->(DbGoTo((cAliasSRA)->R_E_C_N_O_))

    If !((cAliasSRA)->RA_FILIAL $ fValidFil()) .Or. !Eval(bChkSRA); dbSkip(); Loop
    EndIf

    // CONSISTE DEMISSAO E TRANSFERENCIA (SE FOR TRANSFERENCIA SAIDA DESPREZA O FUNCIONARIO POIS SERA TRATADO NO ARRAY aTransf
    If (cAliasSRA)->RA_SITFOLH == "D"
        // SE TRANSF. SAIDA NO MES/ANO E NAO ENCONTRAR NO ARRAY OU O LTRANSFEMP FOR .T. (EMPRESA ANTERIOR E EMPRESA DESTINO
        // FOR DIFERENTE) INDICA QUE E UMA TRANSFERENCIA ENTRE EMPRESAS E DEVERA SER INCLUIDO MOV. SAIDA
        nPosFunc := Ascan(aTransf, { |X| X[_TAnter,_TEmp]+X[_TAnter,_TFil]+X[_TAnter,_TMat] == cEmpAnt+(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_MAT })
        If nPosFunc > 0
            lTransfEmp := aTransf[nPosFunc,_TAnter,_TEmp] <> aTransf[nPosFunc,_TDest,_TEmp] .And. aTransf[nPosFunc,_TAnter,_TEmp] <> aTransf[nPosFunc,_TAtual,_TEmp]
            cCusto     := aTransf[nPosFunc,_TAnter,_TCC] // Centro de custo anterior
            cCustoAtu  := aTransf[nPosFunc,_TAtual,_TCC] // Centro de custo atual
            If lItemClVl
                cItem  	 := aTransf[nPosFunc,_TAnter,_TItem] // Item anterior
                cItemAtu := aTransf[nPosFunc,_TAtual,_TItem] // Item atual
                cClvl    := aTransf[nPosFunc,_TAnter,_TClvl] // Classe anterior
                cClvlAtu := aTransf[nPosFunc,_TAtual,_TClvl] // Classe atual
            EndIf
        Else
            lTransfEmp := .F.
            cCusto := (cAliasSRA)->RA_CC
            If lItemClVl
                cItem := (cAliasSRA)->RA_ITEM
                cClvl := (cAliasSRA)->RA_CLVL
            EndIf        
        EndIf
        // NAO GRAVAR MOVIMENTO SE FOR MES\ANO DA TRANSFERENCIA, NAO UTILIZA IDENTIFICADOR
        // DE BAIXA DE TRANSFERENCIA E NAO SEJA TRANSFERENCIA ENTRE EMPRESAS
        If !lTrataTrf .And. !lTransfEmp .And. MesAno((cAliasSRA)->RA_DEMISSA) == MesAno(dDataRef) .And. (AllTrim((cAliasSRA)->RA_AFASFGT) $ "5*N*N1*N2") .And. (nPosFunc == 0 .Or. (nPosFunc > 0 .And. lTransfEmp)); dbSkip() ; Loop
        EndIf

        // NA TRANSFERENCIA POR EMPRESA, VERIFICAR SE MES\ANO TRANSF. E O MESMA QUE MES\ANO DE REF. PARA
        //GARANTIR NA EMPRESA ORIGEM A MOVIMENTACAO DE SAIDA, INDEPENDENTE DO DESTINO (ULTIMA TRANSF)
        If	(((nPosFunc > 0 .And.lTransfEmp).And. ;
                    (aTransf[nPosFunc,_TAnter,_TDta] == aTransf[nPosFunc,_TAtual,_TDta]) .And. ;
                    (aTransf[nPosFunc,_TAtual,_TDta] == MesAno(dDataRef))	);
                .Or. (MesAno((cAliasSRA)->RA_DEMISSA) == MesAno(dDataRef) .And. AllTrim((cAliasSRA)->RA_AFASFGT) $ "5*N*N1*N2" .And. (nPosFunc == 0 .Or.	(nPosFunc > 0 .And. lTransfEmp))))
            nTpMv := _Trfe_Sai
        ElseIf MesAno((cAliasSRA)->RA_DEMISSA) == MesAno(dDataRef) .And. !(AllTrim((cAliasSRA)->RA_AFASFGT) $ "5*N*N1*N2") .And. lIncDemit .And. (nPosFunc == 0 .Or. !Empty((cAliasSRA)->RA_AFASFGT))
            nTpMv := _Demitido
        ElseIf MesAno((cAliasSRA)->RA_DEMISSA) < MesAno(dDataRef) .Or. ((AllTrim((cAliasSRA)->RA_AFASFGT) $ "5*N*N1*N2" .Or. Empty((cAliasSRA)->RA_AFASFGT)) .And. nPosFunc > 0 .And. !lTransfEmp) .Or.;
                (MesAno((cAliasSRA)->RA_DEMISSA) == MesAno(dDataRef) .And. !lIncDemit) .Or. (MesAno((cAliasSRA)->RA_DEMISSA) > MesAno(dDataRef) .And. AllTrim((cAliasSRA)->RA_AFASFGT) $ "5*N*N1*N2" .And. !lTransfEmp .And. nPosFunc == 0)
            dbSkip()
            Loop
        EndIf
    EndIf
	
	// VERIFICA SE FUNCIONARIO FOI TRANSFERIDO APOS DATA REFERENCIA
    nPosFunc := Ascan(aTransf, { |X| X[_TDest,_TEmp]+X[_TDest,_TFil]+X[_TDest,_TCC]+X[_TDest,_TMat] == cEmpAnt+(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_CC+(cAliasSRA)->RA_MAT })

    // Verifica se houve transferencia para Outra Empresa e depois retorna para a Mesma
    nPosFunc2 := Ascan(aTransf, { |X| X[_TAnter,_TEmp]+X[_TAnter,_TFil]+X[_TAnter,_TMat] == cEmpAnt+(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_MAT .And. X[_TDest,_TEmp]+X[_TDest,_TFil]+X[_TDest,_TMat] <> cEmpAnt+(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_MAT})
    If nPosFunc2 > 0 .And. nPosFunc > 0 .And. nPosFunc2 <> nPosFunc
        
        // Apenas para Impressao
        If aTransf[nPosFunc2, _TAnter, _TEmp] <> aTransf[nPosFunc2, _TDest, _TEmp]; aTransf[nPosFunc2][_TAtual] := aClone(aTransf[nPosFunc2][_TAnter]); aTransf[nPosFunc2][_TAtual][_TInc] := .T.
        EndIf
    EndIf
    
    If nPosFunc > 0
        nPosFunc3 := Ascan(aTransf, { |X| X[_TDest,_TEmp]+X[_TDest,_TFil]+X[_TDest,_TCC]+X[_TDest,_TMat] == aTransf[nPosFunc,_TAnter,_TEmp]+aTransf[nPosFunc,_TAnter,_TFil]+aTransf[nPosFunc,_TAnter,_TCC]+aTransf[nPosFunc,_TAnter,_TMat]})
        If (nPosFunc3 == 0 .Or. aTransf[nPosFunc3,_TDest,_TDta] < MesAno(dDataRef) .Or. aTransf[nPosFunc,_TDest,_TDta] > MesAno(dDataRef) .Or.;
            (aTransf[nPosFunc,_TDest ,_TFil] <> aTransf[nPosFunc3,_TDest,_TFil] .And. aTransf[nPosFunc,_TDest ,_TEmp]+aTransf[nPosFunc,_TDest ,_TFil]+aTransf[nPosFunc,_TDest ,_TCC]+aTransf[nPosFunc,_TDest ,_TMat] == aTransf[nPosFunc3,_TAnter,_TEmp]+aTransf[nPosFunc3,_TAnter,_TFil]+aTransf[nPosFunc3,_TAnter,_TCC]+aTransf[nPosFunc3,_TAnter,_TMat])) .And.; 
            !(	aTransf[nPosFunc,_TAtual,_TEmp]+aTransf[nPosFunc,_TAtual,_TFil]+aTransf[nPosFunc,_TAtual,_TCC]+aTransf[nPosFunc,_TAtual,_TMat] == ;
                aTransf[nPosFunc,_TDest ,_TEmp]+aTransf[nPosFunc,_TDest ,_TFil]+aTransf[nPosFunc,_TDest ,_TCC]+aTransf[nPosFunc,_TDest ,_TMat]  ;
                )
            If aTransf[nPosFunc,_TDest,_TDta] > MesAno(dDataRef) // data de transferencia maior que data de processamento
                // Processa Transferencia de Saída para impressão de dados de baixa
                lTransCC := aTransf[nPosFunc,_TAnter,_TEmp] == aTransf[nPosFunc,_TDest,_TEmp] .And. aTransf[nPosFunc,_TAnter,_TFil] == aTransf[nPosFunc,_TDest ,_TFil] .And. aTransf[nPosFunc,_TAnter,_TCC] <> aTransf[nPosFunc,_TDest ,_TCC]
                If ( !((aTransf[nPosFunc,_TAnter,_TEmp] <> aTransf[nPosFunc,_TDest,_TEmp]) .And. (aTransf[nPosFunc,_TAnter,_TDta] == aTransf[nPosFunc,_TAtual,_TDta])) .And. !(lTransCC .And. nPosFunc3 == 0)) 
                    aTransf[nPosFunc,_TDest,_TInc] := .T.  // Marca funcionario para que nao seja incluido
                    dbSelectArea(cAliasSRA)
                    dbSkip()
                    Loop
                EndIf
            EndIf
        EndIf
        aTransf[nPosFunc,_TDest,_TInc] := .T.  // Marca funcionario para que nao seja incluido
    EndIf
	
	// VERIFICA SE E TRANSFERENCIA ENTRADA
	If nTpMv == 0 
		nPosFunc := Ascan(aTransf, { |X| X[_TAtual,_TEmp]+X[_TAtual,_TFil]+X[_TAtual,_TCC]+X[_TAtual,_TMat] == cEmpAnt+((cAliasSRA)->RA_FILIAL)+(cAliasSRA)->RA_CC+(cAliasSRA)->RA_MAT })
		If nPosFunc == 0 
			nPosFunc := Ascan(aTransf, { |X| X[_TAtual,_TEmp]+X[_TAtual,_TFil]+X[_TAtual,_TCC]+X[_TAtual,_TMat] == cEmpAnt+((cAliasSRA)->RA_FILIAL)+X[_TAnter,_TCC]+(cAliasSRA)->RA_MAT })
		EndIf
		//SE TRANSFERIDO APOS DATA DE REFERENCIA, DESPREZA FUNCIONARIO, CASO CONTRARIO, MARCA TRANSF. ENTRADA PARA CALCULO/IMPRESSAO
		If nPosFunc > 0
			If !(;
				( lItemClVl .And.;
				aTransf[nPosFunc,_TAtual,_TEmp]+aTransf[nPosFunc,_TAtual,_TFil]+aTransf[nPosFunc,_TAtual,_TCC]+aTransf[nPosFunc,_TAtual,_TMat]+aTransf[nPosFunc,_TAtual,_TItem]+aTransf[nPosFunc,_TAtual,_TClvl] == ;
				aTransf[nPosFunc,_TAnter,_TEmp]+aTransf[nPosFunc,_TAnter,_TFil]+aTransf[nPosFunc,_TAnter,_TCC]+aTransf[nPosFunc,_TAnter,_TMat]+aTransf[nPosFunc,_TAnter,_TItem]+aTransf[nPosFunc,_TAnter,_TClvl] .And. ;
				aTransf[nPosFunc,_TAtual,_TEmp]+aTransf[nPosFunc,_TAtual,_TFil]+aTransf[nPosFunc,_TAtual,_TCC]+aTransf[nPosFunc,_TAtual,_TMat]+aTransf[nPosFunc,_TAtual,_TItem]+aTransf[nPosFunc,_TAtual,_TClvl] == ;
				aTransf[nPosFunc,_TDest ,_TEmp]+aTransf[nPosFunc,_TDest ,_TFil]+aTransf[nPosFunc,_TDest ,_TCC]+aTransf[nPosFunc,_TDest ,_TMat]+aTransf[nPosFunc,_TDest ,_TItem]+aTransf[nPosFunc,_TDest ,_TClvl]  ;
				);
				.Or.;
				( !lItemClVl .And.;
				aTransf[nPosFunc,_TAtual,_TEmp]+aTransf[nPosFunc,_TAtual,_TFil]+aTransf[nPosFunc,_TAtual,_TCC]+aTransf[nPosFunc,_TAtual,_TMat] == ;
				aTransf[nPosFunc,_TAnter,_TEmp]+aTransf[nPosFunc,_TAnter,_TFil]+aTransf[nPosFunc,_TAnter,_TCC]+aTransf[nPosFunc,_TAnter,_TMat] .And. ;
				aTransf[nPosFunc,_TAtual,_TEmp]+aTransf[nPosFunc,_TAtual,_TFil]+aTransf[nPosFunc,_TAtual,_TCC]+aTransf[nPosFunc,_TAtual,_TMat] == ;
				aTransf[nPosFunc,_TDest ,_TEmp]+aTransf[nPosFunc,_TDest ,_TFil]+aTransf[nPosFunc,_TDest ,_TCC]+aTransf[nPosFunc,_TDest ,_TMat]  ;
				);
				)
				If aTransf[nPosFunc,_TAtual,_TDta] == MesAno(dDataRef)
					nTpMv := _Trfe_Ent 						 // Transferencia Entrada
					aTransf[nPosFunc,_TAtual,_TInc] := .T.  // Marca funcionario para que nao seja incluido
				ElseIf !(aTransf[nPosFunc,_TAtual,_TEmp] <> aTransf[nPosFunc,_TDest,_TEmp])
					dbSelectArea( cAliasSRA )
					dbSkip()
					Loop
				EndIf
			EndIf
		EndIf
	EndIf
	
	// VERIFICA SE ESTA AFASTADO NA DATA DE REFERENCIA DO CALCULO
    cSitFolh := cTipAfas := ""
    dAfaIni  := dAfaFim	 := CtoD("")
    fChkAfas((cAliasSRA)->RA_FILIAL,(cAliasSRA)->RA_MAT,dDataRef,@dAfaIni,@dAfaFim,@cTipAfas)
    cSitFolh := If(!Empty(cTipAfas) .And. cTipAfas # "F" .And. ( Empty(dAfaFim) .Or. dAfaFim >= dDataRef) , "A", cSitFolh)

	cCusto  := ""
	cItem   := ""
	cClvl   := ""
	nPos	:= aScan(aTransf, { |X| X[_TAtual,_TEmp]+X[_TAtual,_TFil]+X[_TAtual,_TMat]+X[_TAtual,_TDta] == cEmpAnt+(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_MAT+AnoMes(dDataRef) } )
	nTPosCc := If (!Empty(aCcEmpTra), aScan(aCcEmpTra, { |x| x[1,4] == SRA->RA_MAT .And. x[1,9] == .T.}),0)

	If nPos == 0
		nPos := aScan(aTransf, { |X| X[_TAtual,_TEmp]+X[_TAtual,_TFil]+X[_TAtual,_TMat] == cEmpAnt +(cAliasSRA)->RA_FILIAL+(cAliasSRA)->RA_MAT } )
		If nPos > 0
			cCusto := aTransf[nPos][_TAtual][_TCC]
			If lItemClVl
				cItem := aTransf[nPos][_TAtual][_TItem]
				cClvl := aTransf[nPos][_TAtual][_TClvl]
			EndIf
		EndIf
	Else
		cCusto := aTransf[nPos][_TAtual][_TCC]
		If lItemClVl
			cItem := aTransf[nPos][_TAtual][_TItem]
			cClvl := aTransf[nPos][_TAtual][_TClvl]
		EndIf
	EndIf

	dbSelectArea(cTBLXPROV)
    RecLock(cTBLXPROV, .T.)

	(cTBLXPROV)->PR_FILIAL := (cAliasSRA)->RA_FILIAL
	(cTBLXPROV)->PR_MAT    := (cAliasSRA)->RA_MAT
	(cTBLXPROV)->PR_NOME   := (cAliasSRA)->RA_NOME

     //Trans.Entrada ou Demissao ou Gravar c.custo atual ou Gravar c.custo da origem
    (cTBLXPROV)->PR_CC := IIf(Empty(cCusto) .And. nTpMv != 6 .And. nTPosCc == 0, (cAliasSRA)->RA_CC,;
     IIf(Empty(cCusto) .And. nTpMv != 6 .And. nTPosCc > 0 .And. !Empty(aCcEmpTra), aCcEmpTra[nTPosCc,1,6], IIf(nTpMv == 6 .Or. nTpMv == 1, If(Empty(cCustoAtu), cCusto, cCustoAtu), cCusto)))

	If lItemClVl 
         //Trans.Entrada ou Demissao ou  Gravar item/classe atual ou Gravar item/classe da origem
         (cTBLXPROV)->PR_ITEM := IIf(Empty(cItem) .And. nTpMv != 6, (cAliasSRA)->RA_ITEM, IIF(nTpMv == 6 .Or. nTpMv == 1, If(Empty(cItemAtu), cItem, cItemAtu), cItem))
         (cTBLXPROV)->PR_CLVL := IIf(Empty(cClvl) .And. nTpMv != 6, (cAliasSRA)->RA_CLVL, IIf(nTpMv == 6 .Or. nTpMv == 1, If(Empty(cClvlAtu), cClvl, cClvlAtu), cClvl))
    EndIf

	(cTBLXPROV)->PR_ADMISSA := (cAliasSRA)->RA_ADMISSA
	(cTBLXPROV)->PR_DEMISSA := If(mesano((cAliasSRA)->RA_DEMISSA) <= mesano(dDataRef) , (cAliasSRA)->RA_DEMISSA,cTod(" / / "))
	(cTBLXPROV)->PR_SITFOLH := cSitFolh
	(cTBLXPROV)->PR_AFASFGT := cTipAfas
	(cTBLXPROV)->PR_TPCONTR := If( Empty( (cAliasSRA)->RA_TPCONTR ), "1", (cAliasSRA)->RA_TPCONTR )
	(cTBLXPROV)->PR_HRSMES  := (cAliasSRA)->RA_HRSMES
	(cTBLXPROV)->PR_PERICUL := (cAliasSRA)->RA_PERICUL
	(cTBLXPROV)->PR_INSMAX	:= (cAliasSra)->RA_INSMAX
	(cTBLXPROV)->PR_ADTPOSE	:= (cAliasSra)->RA_ADTPOSE
	(cTBLXPROV)->PR_TIPMOVI := nTpMv  // Demitido, Transf. Saida ou Transf. Entrada
	(cTBLXPROV)->PR_CATFUNC := (cAliasSRA)->RA_CATFUNC
	If(lSalInc,	(cTBLXPROV)->PR_SALINCO := (cAliasSRA)->RA_SALINCO, Nil)
	If lINSSAut
		(cTBLXPROV)->PR_INSSAUT := (cAliasSRA)->RA_INSSAUT
	EndIf
	MsUnlock()

	dbSelectArea(cAliasSRA)
	(cAliasSRA)->(dbSkip())
EndDo

// GARANTE ORDEM 1 PARA BUSCA DOS FUNCIONARIOS
(cAliasSRA)->( DbCloseArea() )
SRA->( DbCloseArea() )
DbSelectArea("SRA")
SRA->( DbSetOrder(1) )

// INCLUI OS TRANSFERIDOS ENTRE CC NO ARQUIVO DE PROVISAO
For nK1 := 1 To Len(aTransf)
	If (SRA->( DbSeek(aTransf[nK1,_TDest,_TFil] + aTransf[nK1,_TDest,_TMat]) ) .And. ;
			 aTransf[nK1,_TDest,_TEmp] == cEmpAnt) .Or. ;
			 (SRA->( DbSeek(aTransf[nK1,_TAtual,_TFil] + aTransf[nK1,_TAtual,_TMat]) ) .And. ;
			 aTransf[nK1,_TAtual,_TEmp] == cEmpAnt) 
		
		If (SRA->RA_SITFOLH == "D" .And. (MesAno(SRA->RA_DEMISSA) <= MesAno(dDataRef) .And.;
			MesAno(SRA->RA_DEMISSA) < aTransf[nK1,_TAtual,_TDta]) .And. !(AllTrim(SRA->RA_AFASFGT) $ "5*N*N1*N2"))
			Loop
		EndIf
		// CONSISTE CATEGORIA E DEMISSAO DO FUNCIONARIO
		If !(SRA->RA_CATFUNC $ cCateg) .Or. (SRA->RA_SITFOLH == "D" .And.;
		   MesAno(SRA->RA_DEMISSA) < MesAno(dDataRef))
			Loop
		EndIf

		For nK2 := 1 To 2
			nTrfProc := If(nK2 == 1, _TAnter, _TAtual)
			// VERIFICACAO DO ELEMENTO ANTERIOR DO array aTransf
			If nK2 == 1
				// SE NAO TRATA TRANSFERIDO, NAO INCLUIR TRANSFERENCIA ORIGEM EFETUADA NO MES DE PROCESSAMENTO. SOMENTE INCLUIR POSTERIORES
				If !lTrataTrf .And. aTransf[nK1,_TAnter,_TDta] == MesAno(dDataRef); Loop
				EndIf
				// VERIFICA SE OS ELEMENTOS ANTERIOR E ATUAL SAO IGUAIS OU SE A TRANSFERENCIA ANTERIOR PARA ATUAL FOI ENTRE FILIAL
				If ( ( lItemClVl .And. aTransf[nK1,_TAnter,_TFil]+aTransf[nK1,_TAnter,_TCC]+aTransf[nK1,_TAnter,_TMat]+aTransf[nK1,_TAnter,_TItem]+aTransf[nK1,_TAnter,_TClvl] ==;
				    aTransf[nK1,_TAtual,_TFil]+aTransf[nK1,_TAtual,_TCC]+aTransf[nK1,_TAtual,_TMat]+aTransf[nK1,_TAtual,_TItem]+aTransf[nK1,_TAtual,_TClvl] ) ;
					.Or.;
					( !lItemClVl .And. aTransf[nK1,_TAnter,_TFil]+aTransf[nK1,_TAnter,_TCC]+aTransf[nK1,_TAnter,_TMat]==;
				    aTransf[nK1,_TAtual,_TFil]+aTransf[nK1,_TAtual,_TCC]+aTransf[nK1,_TAtual,_TMat] ) ) .Or. ;
				    aTransf[nK1,_TAnter,_TInc] .Or. ;
				    aTransf[nK1,_TAnter,_TEmp] <> cEmpAnt
				    Loop
				EndIf
			Else
				// VERIFICA SE ATUAL == DESTINO E JA INCLUI DESTINO OU SE A EMPRESA ATUAL E DIFERENTE DA EMPRESA CORRENTE
				If (;
					( lItemClVl .And. aTransf[nK1,_TAtual,_TFil]+aTransf[nK1,_TAtual,_TCC]+aTransf[nK1,_TAtual,_TMat]+aTransf[nK1,_TAtual,_TItem]+aTransf[nK1,_TAtual,_TClvl]==;
				     aTransf[nK1,_TDest,_TFil]+aTransf[nK1,_TDest,_TCC]+aTransf[nK1,_TDest,_TMat]+aTransf[nK1,_TDest,_TItem]+aTransf[nK1,_TDest,_TClvl] .And. aTransf[nK1,_TDest,_TInc]) .Or. ;
					( !lItemClVl .And. aTransf[nK1,_TAtual,_TFil]+aTransf[nK1,_TAtual,_TCC]+aTransf[nK1,_TAtual,_TMat]==;
				     aTransf[nK1,_TDest,_TFil]+aTransf[nK1,_TDest,_TCC]+aTransf[nK1,_TDest,_TMat] .And. aTransf[nK1,_TDest,_TInc]) ) .Or. ;
				     ( aTransf[nK1,_TAtual,_TEmp] <> cEmpAnt )
				    Loop
				EndIf
			EndIf
			// CONSISTE PARAMETROS SELECIONADO PELO USUARIO
			If 	(aTransf[nK1,nTrfProc,_TFil]  < cFilDe) .Or. (aTransf[nK1,nTrfProc,_TFil] > cFilAte) .Or. ;
				(aTransf[nK1,nTrfProc,_TCC]  < cCcDe)	.Or. (aTransf[nK1,nTrfProc,_TCC]  > cCCAte)  .Or. ;
				(aTransf[nK1,nTrfProc,_TMat] < cMatDe)	.Or. (aTransf[nK1,nTrfProc,_TMat] > cMatAte) .Or. ;
				(SRA->RA_NOME < cNomeDe) .Or. (SRA->RA_NOME > cNomeAte)
				Loop
			EndIf
			// CONSISTE CONTROLE DE ACESSOS E FILIAIS VALIDAS
			If !(aTransf[nK1,nTrfProc,_TFil] $ fValidFil()) .Or. !SRA->(Eval(bChkSRE)); Loop
			EndIf

			nPosTransf := AScan(aTransf, { |X| X[_TDest,_TEmp]+X[_TDest,_TFil]+X[_TDest,_TMat] == aTransf[nK1,_TAnter,_TEmp]+aTransf[nK1,_TAnter,_TFil]+aTransf[nK1,_TAnter,_TMat] })

			If nPosTransf > 0 .And. aTransf[nK1,_TDest,_TDta] > AnoMes(dDataRef) .And. nPosTransf < nK1; Loop
			EndIf

			// VERIFICA SE FUNCIONARIO JA FOI INCLUIDO
		   	dbSelectArea(cTBLXPROV)
			If !aTransf[nK1,nTrfProc,_TInc]
				nPR_TIPMOVI := 0
				// Se transferido no mes/ano da referencia, indica saida.³
				If nK2 == 1 .And. aTransf[nK1,_TAnter,_TDta] == MesAno(dDataRef)
					nPR_TIPMOVI := _Trfe_Sai
				ElseIf nK2 == 2 .And. aTransf[nK1,_TAtual,_TDta] == MesAno(dDataRef) .And.;
				  aTransf[nK1,_TAnter,_TEmp] + aTransf[nK1,_TAnter,_TFil] + aTransf[nK1,_TAnter,_TCC] + aTransf[nK1,_TAnter,_TMat] #;
				  aTransf[nK1,_TAtual,_TEmp] + aTransf[nK1,_TAtual,_TFil] + aTransf[nK1,_TAtual,_TCC] + aTransf[nK1,_TAtual,_TMat]
				    If nK1 == Len(aTransf) .Or. aTransf[nK1+1,_TAtual,_TEmp] == aTransf[nK1,_TAnter,_TEmp]; nPR_TIPMOVI := _Trfe_Ent; Else; Loop
                    EndIf
				EndIf

				//Verifica a situacao folha e o tipo de afastamento na competencia de calculo
				cSitFolh := cTipAfas := ""
				dAfaIni  := dAfaFim	 := CtoD("")
				fChkAfas( aTransf[nK1,nTrfProc,_TFil], aTransf[nK1,nTrfProc,_TMat], dDataRef, @dAfaIni,@dAfaFim, @cTipAfas)
				cSitFolh := If(!Empty(cTipAfas) .And. cTipAfas # "F" .And. ( Empty(dAfaFim) .Or. dAfaFim >= dDataRef) , "A", cSitFolh)

               If (nPR_TIPMOVI == _Trfe_Ent .Or. nPR_TIPMOVI == 0) .And.;
                        (;
                            (nOrdem == 1 .And. (cTBLXPROV)->( dbSeek( aTransf[nK1,nTrfProc,_TFil] + aTransf[nK1,nTrfProc,_TMat] ) ) ) .Or.;
                            (nOrdem == 2 .And. (cTBLXPROV)->( dbSeek( aTransf[nK1,nTrfProc,_TFil] + aTransf[nK1,nTrfProc,_TCC] + aTransf[nK1,nTrfProc,_TMat] ) ) ) .Or.;
                            (nOrdem == 3 .And. (cTBLXPROV)->( dbSeek( aTransf[nK1,nTrfProc,_TFil] + SRA->RA_NOME + aTransf[nK1,nTrfProc,_TMat] ) ) ) .Or.;
                            (nOrdem == 4 .And. (cTBLXPROV)->( dbSeek( aTransf[nK1,nTrfProc,_TFil] + aTransf[nK1,nTrfProc,_TCC] + SRA->RA_NOME ) ) ) .Or.;
                            (cTBLXPROV)->( dbSeek( aTransf[nK1,nTrfProc,_TFil] + aTransf[nK1,nTrfProc,_TCC] + Iif( lItemClVl, aTransf[nK1,nTrfProc,_TItem] + aTransf[nK1,nTrfProc,_TClvl], "" ) + aTransf[nK1,nTrfProc,_TMat] ) );
                        ) .And. (cTBLXPROV)->PR_CC == aTransf[nK1,nTrfProc,_TCC] .And. Iif(lItemClVl, (cTBLXPROV)->PR_ITEM + (cTBLXPROV)->PR_CLVL == aTransf[nK1,nTrfProc,_TItem] + aTransf[nK1,nTrfProc,_TClvl], .T.)
                    If nPR_TIPMOVI == _Trfe_Ent; RecLock(cTBLXPROV, .F.); (cTBLXPROV)->PR_TIPMOVI := nPR_TIPMOVI; Else; Loop
                    EndIf
                Else
                    RecLock(cTBLXPROV, .T.)
                    (cTBLXPROV)->PR_FILIAL  := aTransf[nK1,nTrfProc,_TFil] // Filial De
                    (cTBLXPROV)->PR_MAT     := aTransf[nK1,nTrfProc,_TMat] // Matricula De
                    (cTBLXPROV)->PR_CC      := aTransf[nK1,nTrfProc,_TCC]  // Centro de Custo De
                    (cTBLXPROV)->PR_NOME    := SRA->RA_NOME
                    (cTBLXPROV)->PR_ADMISSA := SRA->RA_ADMISSA
                    (cTBLXPROV)->PR_DEMISSA := SRA->RA_DEMISSA
                    (cTBLXPROV)->PR_SITFOLH := cSitFolh
                    (cTBLXPROV)->PR_AFASFGT := cTipAfas
                    (cTBLXPROV)->PR_TPCONTR := SRA->RA_TPCONTR
                    (cTBLXPROV)->PR_HRSMES  := SRA->RA_HRSMES
                    (cTBLXPROV)->PR_PERICUL := SRA->RA_PERICUL
                    (cTBLXPROV)->PR_TIPMOVI := nPR_TIPMOVI
                    (cTBLXPROV)->PR_CATFUNC := SRA->RA_CATFUNC
                    If(lSalInc, (cTBLXPROV)->PR_SALINCO := SRA->RA_SALINCO, Nil)
                    If lItemClVl
                        (cTBLXPROV)->PR_ITEM := aTransf[nK1,nTrfProc,_TItem] // Item Contabil
                        (cTBLXPROV)->PR_CLVL := aTransf[nK1,nTrfProc,_TClvl] // Classe de valor
                    EndIf
                MsUnlock()
				EndIf
				aTransf[nK1,nTrfProc,_TInc] := .T.
			EndIf
		Next nK2
	EndIf
Next nK1

Return

/*-------------------------------------------------------------------
{Protheus.doc} criaJsonProvFer
Cria Nested da provisão de férias

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method criaJsonProvFer(aPosicao as array, cNested as character, nTipo as numeric) as logical class GPER070TReportsBusinessObject
local nValIns as numeric
local nValFgt as numeric
local nValPis as numeric
local nTotFer as numeric
local nTotEnc as numeric
local nTotGer as numeric
local nPosImp as numeric
local nValPro as numeric
local nValAdi as numeric
local nVal1Te as numeric
local nTotImp := _Linhas - 1 as numeric
local bChkVal := { |nArg| ( aPosicao[nArg, _Prov] + aPosicao[nArg, _Adic] + aPosicao[nArg, _1Ter] + aPosicao[nArg, _INSS] + aPosicao[nArg, _FGTS] == 0 ) }

DEFAULT nTipo := 0

//NAO IMPRIME NENHUMA DAS COLUNAS SE O VALOR FOR ZERO
If Eval(bChkVal, _Anter) .And. Eval(bChkVal, _NoMes) .And. Eval(bChkVal, _Atual) .And. Eval(bChkVal, _BxTot)
	If nGerRes == 1
		Return .F.
	EndIf
EndIf

For nPosImp := 1 To nTotImp

	//NAO IMPRIME CORRECAO OU BAIXA SE O VALOR FOR ZERO
	If (nPosImp == _Corre .Or. nPosImp > _Atual) .And. Eval(bChkVal, nPosImp); Loop
	EndIf        	
	
    nTotFer  := aPosicao[nPosImp, _Prov] + aPosicao[nPosImp, _Adic] + aPosicao[nPosImp, _1Ter]
    nValIns  := aPosicao[nPosImp, _INSS]
    nValFgt  := aPosicao[nPosImp, _FGTS]
    nValPis  := aPosicao[nPosImp, _PIS]
	nTotEnc  := aPosicao[nPosImp, _INSS] + aPosicao[nPosImp, _FGTS]
    nTotEnc  := If(lCalcPis, nValPis, nTotEnc)
    nTotGer  := nTotFer + nValIns + nValFgt + If(lCalcPis, nValPis, 0)
    
    aAdd(jData[cNested], {;
                "tpProv":   nPosImp,;
                "Filial":   cFilialAnt,;
                "cCusto":   cDescCc,;
                "nValPro":  aPosicao[nPosImp, _Prov],;
                "nValAdi":  aPosicao[nPosImp, _Adic],;
                "nVal1Te":  aPosicao[nPosImp, _1Ter],;
                "nTotFer":  nTotFer,;
                "nValIns":  nValIns,;
                "nValFgt":  nValFgt,;
                "nValPis":  nValPis,;
                "nValSalV": aPosicao[nPosImp, _SalV],;
                "nTotEnc":  nTotEnc,;
                "lPIS":     lCalcPis,;
                "nTotGer":  nTotGer;
            })   

Next nPosImp

If nTipo == 3 .AND. !Eval(bChkVal, _BxTot)
		nValPro := aPosicao[_NoMes, _Prov] - aPosicao[_BxTot, _Prov] 
		nValAdi := aPosicao[_NoMes, _Adic] - aPosicao[_BxTot, _Adic]
		nVal1Te := aPosicao[_NoMes, _1Ter] - aPosicao[_BxTot, _1Ter]
		nTotFer := nValPro + nValAdi + nVal1Te
		nValIns := aPosicao[_NoMes, _INSS] - aPosicao[_BxTot, _INSS]
		nValFgt := aPosicao[_NoMes, _FGTS] - aPosicao[_BxTot, _FGTS]
		nValPis := aPosicao[_NoMes, _PIS] - aPosicao[_BxTot, _PIS]
	    nTotEnc := nValIns + nValFgt
   	    nTotEnc := If(lCalcPis, nValPis, nTotEnc)
	    nTotGer := nTotFer + nValIns + nValFgt + If(lCalcPis,nValPis,0)
		
        aAdd(jData[cNested], {;
                "tpProv":   _BxTot,;
                "Filial":   cFilialAnt,;
                "cCusto":   cDescCc,;
                "nValPro":  nValPro,;
                "nValAdi":  nValAdi,;
                "nVal1Te":  nVal1Te,;
                "nTotFer":  nTotFer,;
                "nValIns":  nValIns,;
                "nValFgt":  nValFgt,;
                "nValPis":  nValPis,;
                "nValSalV": aPosicao[_NoMes, _SalV] - aPosicao[_BxTot, _Salv],;
                "nTotEnc":  nTotEnc,;
                "lPIS":     lCalcPis,;
                "nTotGer":  nTotGer;
            })   
EndIf

Return .T.

/*-------------------------------------------------------------------
{Protheus.doc} criaJsonProv13
Cria Nested da provisão de 13º

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method criaJsonProv13(aPosicao as array, cNested as character, nTipo as numeric) as logical class GPER070TReportsBusinessObject
local nValIns as numeric
local nValFgt as numeric
local nValPis as numeric
local nTot13  as numeric
local nTotEnc as numeric
local nTotGer as numeric
local nPosImp as numeric
local nValPro as numeric
local nValAdi as numeric
local nVal1Pa as numeric
local nTotImp := _Linhas - 1 as numeric
local bChkVal := { |nArg| ( aPosicao[nArg,_Prov] + aPosicao[nArg,_Adic] + aPosicao[nArg,_1Par] + aPosicao[nArg,_INSS] + aPosicao[nArg,_FGTS] == 0 ) }

DEFAULT nTipo := 0

//NAO IMPRIME NENHUMA DAS COLUNAS SE O VALOR FOR ZERO
If Eval(bChkVal, _Anter) .And. Eval(bChkVal, _NoMes) .And. Eval(bChkVal, _Atual) .And. Eval(bChkVal, _BxTot)
	If nGerRes == 1
		Return .F.
	EndIf
EndIf

For nPosImp := 1 To nTotImp

	//NAO IMPRIME CORRECAO OU BAIXA SE O VALOR FOR ZERO
	If (nPosImp == _Corre .Or. nPosImp > _Atual) .And. Eval(bChkVal, nPosImp); Loop
	EndIf        	
	
    nTot13   := aPosicao[nPosImp,_Prov]+aPosicao[nPosImp,_Adic]-aPosicao[nPosImp,_1Par]
    nValIns  := aPosicao[nPosImp, _INSS]
    nValFgt  := aPosicao[nPosImp, _FGTS]
    nValPis  := aPosicao[nPosImp, _PIS]
	nTotEnc  := aPosicao[nPosImp, _INSS] + aPosicao[nPosImp, _FGTS]
    nTotEnc  := If(lCalcPis, nValPis, nTotEnc)
    nTotGer  := nTot13 + nValIns + nValFgt + If(lCalcPis, nValPis, 0)

    aAdd(jData[cNested], {;
                "tpProv":   nPosImp,;
                "Filial":   cFilialAnt,;
                "cCusto":   cDescCc,;
                "nValPro":  aPosicao[nPosImp, _Prov],;
                "nValAdi":  aPosicao[nPosImp, _Adic],;
                "nVal1Te":  aPosicao[nPosImp, _1Par],;
                "nTotFer":  nTot13,;
                "nValIns":  nValIns,;
                "nValFgt":  nValFgt,;
                "nValPis":  nValPis,;
                "nValSalV": aPosicao[nPosImp, _SalV],;
                "nTotEnc":  nTotEnc,;
                "lPIS":     lCalcPis,;
                "nTotGer":  nTotGer;
            })          

Next nPosImp

If nTipo == 3 .AND. !Eval(bChkVal, _BxTot)
		nValPro := aPosicao[_NoMes, _Prov] - aPosicao[_BxTot, _Prov]
		nValAdi := aPosicao[_NoMes, _Adic] - aPosicao[_BxTot, _Adic]
		nVal1Pa := aPosicao[_NoMes, _1Par] - aPosicao[_BxTot, _1Par]
		nTot13  := nValPro + nValAdi + nVal1Pa
		nValIns := aPosicao[_NoMes, _INSS] - aPosicao[_BxTot, _INSS]
		nValFgt := aPosicao[_NoMes, _FGTS] - aPosicao[_BxTot, _FGTS]
		nValPis := aPosicao[_NoMes, _PIS] - aPosicao[_BxTot, _PIS]
		nTotEnc := nValIns + nValFgt
		nTotEnc := If(lCalcPis, nValPis, nTotEnc)
	    nTotGer := nTot13 + nValIns + nValFgt + If(lCalcPis,nValPis,0)
		
        aAdd(jData[cNested], {;
                "tpProv":   _BxTot,;
                "Filial":   cFilialAnt,;
                "cCusto":   cDescCc,;
                "nValPro":  nValPro,;
                "nValAdi":  nValAdi,;
                "nVal1Te":  nVal1Pa,;
                "nTotFer":  nTot13,;
                "nValIns":  nValIns,;
                "nValFgt":  nValFgt,;
                "nValPis":  nValPis,;
                "nValSalV": aPosicao[_NoMes, _SalV] - aPosicao[_BxTot, _Salv],;
                "nTotEnc":  nTotEnc,;
                "lPIS":     lCalcPis,;
                "nTotGer":  nTotGer;
            })   
EndIf

Return .T.

/*-------------------------------------------------------------------
{Protheus.doc} totalizaProv
Totaliza arrays das provisões

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method totalizaProv(aTotal1 as array, aTotal2 as array, aTotal3 as array, aValor1 as array, aValor2 as array, aValor3 as array) as variant class GPER070TReportsBusinessObject
local x as numeric
local z as numeric

If Len(aTotal1) > 0
	For x := 1 To _Linhas
		For z := 1 To _Colunas
			aTotal1[x, z] += aValor1[x, z]
			aTotal2[x, z] += aValor2[x, z]
			aTotal3[x, z] += aValor3[x, z]
		Next z
	Next x
Else
	aTotal1 := Aclone(aValor1)
	aTotal2 := Aclone(aValor2)
	aTotal3 := Aclone(aValor3)
EndIf

Return 

/*-------------------------------------------------------------------
{Protheus.doc} montaTotalProv
Verifica os totais das provisões

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method montaTotalProv(nTipProv as numeric, lSkip as logical) as variant class GPER070TReportsBusinessObject
local cCusto as character

dbSelectArea(cTBLXPROV)
cFilialAnt := (cTBLXPROV)->PR_FILIAL
cCcAnt	   := (cTBLXPROV)->PR_CC 

If nOrdem == 6 //"C.Custo + Item + Classe"
    cItAnt := (cTBLXPROV)->PR_ITEM
	cClAnt := (cTBLXPROV)->PR_CLVL
EndIf

dbSkip()

If Eof()
	cCusto := (cTBLXPROV)->PR_CC 
	self:totalCcusto(nTipProv)
	self:totalFilial(nTipProv)
	self:totalEmpresa(nTipProv)
ElseIf cFilialAnt != (cTBLXPROV)->PR_FILIAL
	self:totalCcusto(nTipProv)
    self:totalFilial(nTipProv)
ElseIf nOrdem == 6 .And. cCcAnt + cItAnt + cClAnt != (cTBLXPROV)->PR_CC + (cTBLXPROV)->PR_ITEM + (cTBLXPROV)->PR_CLVL 
	self:totalCcusto(nTipProv)
ElseIf cCcAnt != (cTBLXPROV)->PR_CC
	cCusto := (cTBLXPROV)->PR_CC
	self:totalCcusto(nTipProv)
EndIf

If !lSkip
    aAdd(aDataProv, jData) //Add o jSon da provisão do funcionário para envio posterior no getData()
EndIf

Return

/*-------------------------------------------------------------------
{Protheus.doc} totalCcusto
Total do centro de custo

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method totalCcusto(nTipProv as numeric) as logical class GPER070TReportsBusinessObject
local lRetu1 as logical
local lRetu2 as logical

If Len(aTotCc1) == 0 .Or. (nOrdem != 2 .And. nOrdem != 4 .And. nOrdem != 6)
	Return .F.
Endif

jData["ADetTotCc1"] := {}
jData["ADetTotCc2"] := {}
jData["ADetTotCc3"] := {}

cDescCc := Rtrim(cCcAnt) + " - " + Rtrim(fDesc("CTT", cCcAnt, "CTT_DESC01", Nil, cFilialAnt))

If nOrdem == 6
	cDescCc += If(!Empty(cItAnt), Space(10) + STR0029 + ': ' + Rtrim(cItAnt) + " - " + AllTrim(fDesc("CTD", cItAnt, "CTD_DESC01", Nil, cFilialAnt)), "") //Item
	cDescCc += If(!Empty(cClAnt), Space(10) + STR0087 + ': ' + Rtrim(cClAnt) + " - " + AllTrim(fDesc("CTH", cClAnt, "CTH_DESC01", Nil, cFilialAnt)), "") //Classe
EndIf

If nTipProv == 1
    lRetu1 := self:criaJsonProvFer(aTotCc1, "ADetTotCc1")
    lRetu2 := self:criaJsonProvFer(aTotCc2, "ADetTotCc2")
    If lRetu1 .And. lRetu2
        self:criaJsonProvFer(aTotCc3, "ADetTotCc3", 3)
    EndIf
Else    
    lRetu1 := self:criaJsonProv13(aTotCc1, "ADetTotCc1")
    lRetu2 := self:criaJsonProv13(aTotCc2, "ADetTotCc2")
    If lRetu1 .And. lRetu2
        self:criaJsonProv13(aTotCc3, "ADetTotCc3", 3)
    EndIf
EndIf

aTotCc1 := {}
aTotCc2 := {}
aTotCc3 := {}

Return .T.

/*-------------------------------------------------------------------
{Protheus.doc} totalFilial
Total da Filial

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method totalFilial(nTipProv as numeric) as logical class GPER070TReportsBusinessObject
local lRetu1 as logical
local lRetu2 as logical

If Len(aTotFil1) == 0; Return .F.
EndIf

jData["ADetTotFil1"] := {}
jData["ADetTotFil2"] := {}
jData["ADetTotFil3"] := {}

If nTipProv == 1
    lRetu1 := self:criaJsonProvFer(aTotFil1, "ADetTotFil1")
    lRetu2 := self:criaJsonProvFer(aTotFil2, "ADetTotFil2")
    If lRetu1 .And. lRetu2
        self:criaJsonProvFer(aTotFil3, "ADetTotFil3", 3)
    EndIf
Else    
    lRetu1 := self:criaJsonProv13(aTotFil1, "ADetTotFil1")
    lRetu2 := self:criaJsonProv13(aTotFil2, "ADetTotFil2")
    If lRetu1 .And. lRetu2
        self:criaJsonProv13(aTotFil3, "ADetTotFil3", 3)
    EndIf
EndIf

aTotFil1 :={}
aTotFil2 :={}
aTotFil3 :={}

Return .T.

/*-------------------------------------------------------------------
{Protheus.doc} totalEmpresa
Total da Empresa

@author	Bruno Costa
@since	24/10/2024
-------------------------------------------------------------------*/
Method totalEmpresa(nTipProv as numeric) as logical class GPER070TReportsBusinessObject
local lRetu1 as logical
local lRetu2 as logical

If Len(aTotEmp1) == 0; Return .F.
EndIf

jData["ADetTotEmp1"] := {}
jData["ADetTotEmp2"] := {}
jData["ADetTotEmp3"] := {}

If nTipProv == 1
    lRetu1 := self:criaJsonProvFer(aTotEmp1, "ADetTotEmp1")
    lRetu2 := self:criaJsonProvFer(aTotEmp2, "ADetTotEmp2")
    If lRetu1 .And. lRetu2
        self:criaJsonProvFer(aTotEmp3, "ADetTotEmp3", 3)
    EndIf
Else 
    lRetu1 := self:criaJsonProv13(aTotEmp1, "ADetTotEmp1")
    lRetu2 := self:criaJsonProv13(aTotEmp2, "ADetTotEmp2")
    If lRetu1 .And. lRetu2
        self:criaJsonProv13(aTotEmp3, "ADetTotEmp3", 3)
    EndIf
EndIf

aTotEmp1 :={}
aTotEmp2 :={}
aTotEmp3 :={}

Return .T.
