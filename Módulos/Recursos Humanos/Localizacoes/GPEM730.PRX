#INCLUDE "Protheus.CH"
#INCLUDE "GPEM730.CH"

/*/


Ŀ
Funo     GPEM730   Autor  Silvia Taguti          Data  15/12/06 
Ĵ
Descrio  GERA ARQUIVO ASCII - DECLARACAO ANUAL - MEXICO             
Ĵ
         ATUALIZACOES SOFRIDAS DESDE A CONSTRUAO INICIAL.             
Ĵ
Programador  Data    BOPS   Motivo da Alteracao                     
ٱ
Silvia T    08/02/08140541Ajuste usando o campo RCP_SALMES          
Erika K     02/06/08------Alteracao do nome do pergunte para integra
                          cao de dicionarios Mexico e R1.2.         
Valdeci Lira23/01/091218/ Ajuste para nova vigencia de 26/12/2008   
                    2009                                            
Tiago Malta 30/12/0930785/Ajuste conteudo da variavel cFilAnterior  
			           2009  de "!!" para Replicate("!",FWGETTAMFILIAL)
Dora Vega   |27/04/17 MMI- Merge de replica del issue MMI-265.Nueva  
            |        4482  funcion fAniosTrb para el calculo correcto
            |              de anios trabajados en archivo DIM.(MEX)  

/*/
Function GPEM730()

Local nOpca
Local aSays		:=	{}
Local aButtons	:= 	{} //<== arrays locais de preferencia

Static nVez

Private cCadastro 	:= OemToAnsi(STR0001) //"Gerao do disco da Declaracao Anual
Private nSavRec		:= RECNO()

/*
Ŀ
Funcao verifica se existe alguma restrio de acesso para o
usurio que impea a execuo da rotina.                   
*/
If !(fValidFun({"RCV","RCW"}))
	Return( nil ) 
Endif

Pergunte("GPEM730",.F.)

nOpca := 0

AADD(aSays,OemToAnsi(STR0002) )  //" Este programa gera o arquivo da Declaracao Anual"

AADD(aButtons, { 5,.T.,{|| Pergunte("GPEM730",.T. ) } } )
AADD(aButtons, { 1,.T.,{|o| nOpca := 1,IF(gpconfOK(),FechaBatch(),nOpca:=0) }} )
AADD(aButtons, { 2,.T.,{|o| FechaBatch() }} )
	
FormBatch( cCadastro, aSays, aButtons )

//Ŀ
// Variaveis utilizadas para parametros                         
//
If nOpca == 1
    Processa({|lEnd| GPM730Processa(),STR0003})  // "Gerao do disco da Declaracao Anual
Endif

dbSelectArea("RCV")
SET FILTER TO
RetIndex("RCV")

Return Nil

/*


ͻ
FuncaoGPM730ProcessaAutor  Silvia Taguti        Data   15/12/06   
͹
Desc.                                                                 
                                                                      
͹
Uso    AP                                                             
ͼ


*/
Static Function Gpm730Processa()
//Ŀ
// Define Variaveis LOCAIS DO PROGRAMA                          
//
Local cFilAnterior
Local cGrava1  	:= ""
Local lFirst      := .T.
Local aFuncRed := {}
Local nx := 0

/*
Ŀ
 Variaveis de Acesso do Usuario                               
*/ 
Local cAcessaRCV	:= &( " { || " + IF( Empty( cAcessaRCV := ChkRH( "GPEM730" , "RCV" , "2" ) ) , ".T." , cAcessaRCV ) + " } " ) 
Local cAcessaRCW	:= &( " { || " + IF( Empty( cAcessaRCW := ChkRH( "GPEM730" , "RCW" , "2" ) ) , ".T." , cAcessaRCW ) + " } " ) 

//Ŀ
// Define Variaveis PRIVADAS BASICAS                            
//
Private aCRA := { STR0009,STR0010,STR0011 } //"Confirma"###"Redigita"###"Abandona"
Private aTA  := { STR0012,STR0008 }         //"Tenta Novamente"###"Abandona"
Private aInfo:= {}

//Ŀ
// Define Variaveis PRIVADAS DO PROGRAMA                        
//
Private cDrive  	:= " "
Private nReg    	:= 0
Private nReg2 		:= 0
Private nArq
Private aFunc		:= {}
Private nDiasTrab := 0
Private nAnosTrab  := 0
Private cMesIni	:= ""
Private aRCP        := {}

nVez := 0

//Ŀ
// Variaveis utilizadas para parametros                          
//

//Ŀ
//MV_PAR01 - RFC De?                                
//MV_PAR02 - RFC Ate?                               
//MV_PAR03 - Ano Referencia ?                       
//MV_PAR04 - Arquivo Destino ?                      
//MV_PAR05 - Tarifa Utilizada?                      
//MV_PAR06 - Proporcao Subsidio?                    
//MV_PAR07 - Valor Subsidio?                        
//

cRfcDe   	:= mv_par01				//RFC Empresa
cRfcAte  	:= mv_par02          //RFC Empresa
cAnoRef	 	:= mv_par03
cDrive   	:= mv_par04
cTarExerc  	:= If(mv_par05 == 1,"1","2")
cTar1991  	:= If(mv_par05 == 1,"2","1")
cPropSub 	:= mv_par06
nVlSubs  	:= mv_par07


//Ŀ
// Posiciona Ponteiro "DE" Informado                            
//
dbSelectArea( "RCV" )
cArqNtx  := CriaTrab(NIL,.f.)
cIndCond :="RCV_RFCFON + RCV_RFC"
IndRegua("RCV",cArqNtx,cIndCond,,,"Selecionando Registros...")

cRfcFonAnt := "!!!!!!!!!!!!!!"
nReg    := 0
nReg2   := 0

cFilAnterior  := Replicate("!",FWGETTAMFILIAL)
cRfcAnt    := "!!!!!!!!!!!!!!"

//Ŀ
// Desenha cursor para movimentacao                          
//
ProcRegua(RCV->(RecCount()))
dbSeek( cRfcDe , .T. )

While !Eof() .And. RCV->RCV_RFCFON <= cRfcAte
	//Ŀ
	// Movimenta Regua Processamento                                
	//
	IncProc(STR0007)	//"Declaracao anual
	/*
	Ŀ
	Consiste Controle de Acesso                                           
	*/
	If !(RCV->RCV_FILIAL $ fValidFil()) .Or. !Eval(cAcessaRCV)
		RCV->(dbSkip())
		Loop
  	EndIF
 	If RCV->RCV_RFC # cRfcAnt
  		cRfcAnt := RCV->RCV_RFC
  	Endif
	
   If RCV->RCV_RFCFON # cRFCFonAnt
   	cRfcFonAnt := RCV->RCV_RFCFON
	Endif
 	
 	cRfcAnt   := RCV->RCV_RFC
	If lFirst                                             
 		lFirst := .F.
  		cMesIni := RCV->RCV_MESINI
 	Endif	
    aRCP := {}
	fBuscaTraj(aRCP)
	fAniosTrb()

	//Ŀ
	// Monta Registro Tipo 2    Beneficiario                        
	//
	dbSelectArea("RCW")    // Preenche a matriz com os valores existentes
	dbSeek( RCV->RCV_FILIAL + RCV->RCV_MAT + RCV->RCV_RFC +RCV->RCV_ANO+RCV->RCV_MESINI+RCV->RCV_MESFIN )
	While ! Eof() .And. RCV->RCV_FILIAL + RCV->RCV_MAT + RCV->RCV_RFC + cAnoRef + RCV->RCV_MESINI + RCV->RCV_MESFIN == RCW->RCW_FILIAL + RCW->RCW_MAT + RCW->RCW_RFC + RCW->RCW_ANO + RCW->RCW_MESINI + RCW->RCW_MESFIN
		/*
		Ŀ
		Consiste Controlde de Acesso                                           
		*/
		If !(RCW->RCW_FILIAL $ fValidFil()) .Or. !Eval(cAcessaRCW)
			RCW->(dbSkip()) 
			Loop
		EndIF                     
		nPos := Ascan(aFunc,{ |x| x[1] = RCW->RCW_TIPORE})
		If nPos > 0
			aFunc[nPos,2] += RCW->RCW_VALOR
		Else
			Aadd(aFunc,{RCW->RCW_TIPORE,RCW->RCW_VALOR})	
		Endif
		RCW->(dbSkip())
	Enddo
//	nDiasTrab += Val(RCV->RCV_NUMDIA)
//	nAnosTrab += Val(RCV->RCV_NUMANO)
	//
	//Pula para verificar se o proximo tem o mesmo RFC   
	//
 	dbSelectArea("RCV")
  	RCV->(dbSkip())
   If RCV->RCV_RFC # cRFCAnt .Or. RCV->RCV_RFCFONT # cRfcFonAnt 
   	RCV->(dbSkip(-1))
		lFirst  := .T.
		//Ŀ
		//Funcao para gerar registro tipo 1 lay-out 
		//
		If Len(aFunc) > 0
			aFuncRed := aFunc          
			For nx := 1 to Len(aFuncRed)
				aFunc[nx,2] := Round(aFuncRed[nx,2],0)
			Next    
			aFuncRed := {}
			cGrava1 := MontaTipo1()      
  			If !Grava(cGrava1)
     			Return
	     	Endif
	   Endif  	
      dbSelectArea("RCV")
      dbSkip()
	Endif
	If RCV->RCV_RFC # cRfcAnt
  		cRfcAnt := RCV->RCV_RFC  
    Endif
	dbSelectArea("RCV")
Enddo

FClose(nArq)

dbSelectArea("RCV")
SET FILTER TO
RetIndex("SRA")
Return Nil

/*


Ŀ
Funo    Grava      Autor  R.H. -                 Data  26/01/01 
Ĵ
Descrio  Gravacao do registro TXT                                   
Ĵ
Sintaxe    Grava(cReg)  		                                      
Ĵ
Parametros creg := Registro texto				                      
Ĵ
 Uso       GPEM730                                                    
ٱ

*/
Static Function Grava(cRegistro)
Local cMsg 	:= ""

If nVez == Nil  .Or. nVez == 0
	nArq := MSFCREATE(cDrive,0) 
	IF Ferror() # 0 .AND. nArq = -1 
		cMsg := STR0006+STR(Ferror(),3) 			//-- " Erro de gravao, codigo DOS: " 
		Help('',1,,,cMsg,1)		
		Return(.F.)
	Endif
 	nVez := 1 
Endif

cRegistro := (cRegistro+CHR(13)+CHR(10))

Fwrite(nArq,cRegistro)
			  
If Ferror() # 0
	cMsg := STR0006+STR(Ferror(),3) 		//-- "Erro de gravao, codigo DOS:"
	Help('',1,,,cMsg,1)			
	Return(.F.)
Endif

Return( .T. )

/*


Ŀ
Funo    FDDIRF     Autor  R.H. -                 Data  26/01/01 
Ĵ
Descrio  SELECIONAR DIRETORIO PARA GRAVA ARQUIVO DIRF               
Ĵ
Sintaxe    FDDirf()     		                                      
Ĵ
Parametros                                                            
Ĵ
 Uso       GPEM730                                                    
ٱ

*/
Function FDir730()

Local mvRet:=Alltrim(ReadVar())

oWnd 	:= GetWndDefault()
cFile 	:= cGetFile(STR0005, OemToAnsi(STR0004)) //"Archivo Texto|*.TXT"
If Empty(cFile)
	Return(.F.)
Endif
cDrive := Alltrim(Upper(cFile))

&mvRet := cFile	
If oWnd != Nil
	GetdRefresh()
EndIf

Return( .T. )
/*


Ŀ
Funo    MONTATIPO1 Autor  R.H. -                 Data  26/01/01 
Ĵ
Descrio  MONTA REGISTRO TIPO 1                                      
Ĵ
Sintaxe    MONTATIPO1() 		                                      
Ĵ
Parametros aTotal - Array com os valore da filial                     
Ĵ
 Uso       GPEM730                                                    
ٱ

*/
Static Function MontaTipo1()

Local aCaracter
Local cZonEc
Local cPropApl
Local cEstado     
Local nAux
Local nAux1
Local nValorMercado	:= 0
Local nPrecAcTit	:= 0
Local nField56		:= 0
Local lPagSep 		:= .F.      
Local lPagPat 		:= .F.
Local lAsimSal		:= .F.  
Local lMonto 		:= .F.
Local lMonto33 		:= .F.

aCaracter		:= {"/",".","\","-",","," ","(",")"}     			// Caracteres nao aceitos no DIRF

If RCV->RCV_CVEZON == "A"
	cZonEc := "01"	
ElseIf RCV_CVEZON == "B"
	cZonEc := "02"	
ElseIf RCV_CVEZON == "C"
	cZonEc := "03"
Else
	cZonEc := "00"
Endif
	         
cPropApl := Transform(If(RCV->RCV_PROAPL > 0,RCV->RCV_PROAPL, nVlSubs),"@R #.####") 
cEstado := EstCurp(RCV->RCV_KEYLOC,"2")	      

//Ŀ
//Identificacao do Trabalhador
//
cGrava1 := RCV->RCV_MESINI															// Mes Inicial 			001 a 002        **
cGrava1 += "|"+RCV->RCV_MESFIN  													// Mes Final      		004 a 005        **

cGrava1 += "|"+AllTrim(Substr(RCV->RCV_RFC,1,13))    								// RFC s/Homoclave		007 a 016
cGrava1 += "|"+AllTrim(RCV->RCV_CURP)														// CURP           		018 a 035
cGrava1 += "|"+AllTrim(RCV->RCV_PRISOB)							// Apellido Paterno		037 a 080
cGrava1 += "|"+AllTrim(RCV->RCV_SEGSOB)							// Apellico Materno 		082 a 124 
cGrava1 += "|"+Alltrim(RCV->RCV_PRINOM)+" "+Alltrim(RCV->RCV_SEGNOM)// Prim. Seg.Nome    	126 a 168

cGrava1 += "|"+cZonEc																// Area Geografica   	170 a 171 
cGrava1 += "|"+If(RCV->RCV_EMCALA=="X","1","2")							// Emp.real.calc.Anual  173 a 173
cGrava1 += "|"+cTarExerc  															// Tar.util.Ejercicio   175 a 175 
cGrava1 += "|"+cTar1991 															// Tar.util. 1991       177 a 177
cGrava1 += "|"+cPropApl	 															// Prop.Subs.Aplicada   179 a 184
cGrava1 += "|"+If(RCV->RCV_SINDIC=="X","1","2")	 						// Sindicalizado        186 a 186
cGrava1 += "|"+If(!Empty(RCV->RCV_CLASIM),RCV->RCV_CLASIM,"0")		// Chave se asimilado   188 a 188		
cGrava1 += "|"+If(Val(cEstado) > 0,cEstado,"0")							// Entidade Federativa  190 a 191
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT1)										// RFC Outras Emp 01    193 a 205
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT2)										// RFC Outras Emp 02    207 a 219
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT3)										// RFC Outras Emp 03    221 a 233
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT4)										// RFC Outras Emp 04    235 a 247
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT5)										// RFC Outras Emp 05    249 a 261
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT6)										// RFC Outras Emp 06    263 a 275
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT7)										// RFC Outras Emp 07    277 a 289
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT8)										// RFC Outras Emp 08    291 a 303
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOT9)										// RFC Outras Emp 09    305 a 317
cGrava1 += "|"+Alltrim(RCV->RCV_RFCOTA)										// RFC Outras Emp 10    319 a 331  -25

nPos := Ascan(aFunc,{ |x| x[1] = "1A  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//MONTO DE LAS APORTACIONES VOLUNTARIAS EFECTUADAS

If ( Ascan(aFunc,{ |x| x[1] = "1B  " }) > 0 )							//Indique si el patrn aplic el monto de las aportaciones voluntarias en el clculo 
	cGrava1 += 	"|" + "1"
Else
	cGrava1 += 	"|" + "2"
EndIf

nPos := Ascan(aFunc,{ |x| x[1] = "1C  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//Monto de las aportaciones voluntarias deducibles para trabajadores que realizarn

nPos := Ascan(aFunc,{ |x| x[1] = "1D  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//Monto de las aportaciones voluntarias deducibles aplicadas por el patrn

//Ŀ
//Selecao de Temas    
//
If Ascan(aFunc,{ |x| x[1] = "3P  " }) > 0 .Or. Ascan(aFunc,{ |x| x[1] = "3Q  " }) > 0 .Or. Ascan(aFunc,{ |x| x[1] = "3A  " }) > 0
	lPagSep := .T.
Endif               

If Ascan(aFunc,{ |x| x[1] = "4I  " }) > 0
	lAsimSal := .T.
Endif	

If Ascan(aFunc,{ |x| x[1] = "5OE " .Or. x[1] = "5OG " .Or. x[1] = "5PE " .Or.  x[1] = "5PG " }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5QE " .Or. x[1] = "5QG " .Or. x[1] = "5RE " .Or.  x[1] = "5RG " }) > 0 .Or.;
 	Ascan(aFunc,{ |x| x[1] = "5SE " .Or. x[1] = "5SG " .Or. x[1] = "5TE " .Or.  x[1] = "5TG " }) > 0 .Or.;
 	Ascan(aFunc,{ |x| x[1] = "5UE " .Or. x[1] = "5UG " .Or. x[1] = "5VE " .Or.  x[1] = "5VG " }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5WE " .Or. x[1] = "5WG " .Or. x[1] = "5XE " .Or.  x[1] = "5XG " }) > 0 .Or.;
 	Ascan(aFunc,{ |x| x[1] = "5YE " .Or. x[1] = "5YG " .Or. x[1] = "5ZE " .Or.  x[1] = "5ZG " }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5A1E" .Or. x[1] = "5A1G" .Or. x[1] = "5B1E" .Or.  x[1] = "5B1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5C1E" .Or. x[1] = "5C1G" .Or. x[1] = "5D1E" .Or.  x[1] = "5D1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5E1E" .Or. x[1] = "5E1G" .Or. x[1] = "5F1E" .Or.  x[1] = "5F1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5G1E" .Or. x[1] = "5G1G" .Or. x[1] = "5H1E" .Or.  x[1] = "5H1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5I1E" .Or. x[1] = "5I1G" .Or. x[1] = "5J1E" .Or.  x[1] = "5J1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5K1E" .Or. x[1] = "5K1G" .Or. x[1] = "5L1E" .Or.  x[1] = "5L1G" }) > 0 .Or.;
 	Ascan(aFunc,{ |x| x[1] = "5M1E" .Or. x[1] = "5M1G" .Or. x[1] = "5N1E" .Or.  x[1] = "5N1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "5O1E" .Or. x[1] = "5O1G" .Or. x[1] = "5P1E" .Or.  x[1] = "5P1G" }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "6U1 " .Or.  x[1] = "6V1 " }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "6W1 " .Or. x[1] = "6X1 " .Or. x[1] = "6Y1 " .Or.  x[1] = "6Z1 " }) > 0 .Or.;
	Ascan(aFunc,{ |x| x[1] = "6A1 " .Or. x[1] = "6B1 " .Or. x[1] = "6S1 " .Or.  x[1] = "6T1 " }) > 0 
	lPagPat := .T.
Endif	
cGrava1 += "|"+ If(lPagSep,"1","2") 			        						// Pagos por separac    333 a 333	**
cGrava1 += "|"+ If(lAsimSal,"1","2")        			 						// Asim.a salarios      335 a 335   **
cGrava1 += "|"+ If(lPagPat,"1","2")              							// Pagos del Patr.      337 a 337   **

//Ŀ
//Pagamentos por Separacao
//
If lPagSep

	nPos := Ascan(aFunc,{ |x| x[1] = "3Q  " })
	If ( nPos > 0 )
		If ( aFunc[nPos,2] == 0 )
			lMonto33 := .T.
		EndIf
	EndIf

	If lMonto33	
		nPos := Ascan(aFunc,{ |x| x[1] = "3R  " })								
		cGrava1 += "|" + Alltrim(Str(Abs(aFunc[nPos,2])))						//Ingresos Totales por pago
		nPos := Ascan(aFunc,{ |x| x[1] = "3S  " })
		cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//Monto diario percibido por jubilacion 30
		nPos := Ascan(aFunc,{ |x| x[1] = "3T  " })
		cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//Cantidad que se hubiera percibido 31
		cGrava1 += "|0"		
	Else		 		
		cGrava1 += "|0|0|0"
		nPos := Ascan(aFunc,{ |x| x[1] = "3Q  " })
		cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")		//Monto Total del Pago en usa sola exhibicion 32 - 		
	EndIf
	
	cGrava1 += "|"+ Alltrim(Str(nDiasTrab))     			//Numero de dias - Dias trabalhados  33		
	nPos := Ascan(aFunc,{ |x| x[1] = "3V  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Exentos
	nPos := Ascan(aFunc,{ |x| x[1] = "3W  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Gravables
	nPos := Ascan(aFunc,{ |x| x[1] = "3X  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Acumulables
	nPos := Ascan(aFunc,{ |x| x[1] = "3Y  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos No acumulables
	nPos := Ascan(aFunc,{ |x| x[1] = "3Z  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto Retenido
	nPos := Ascan(aFunc,{ |x| x[1] = "3A  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Monto total pagado de otros pagos por separacion
	lMonto := If(nPos > 0, .T. , .F.)
	cGrava1 += "|"+ AllTrim(Str(Round(nAnosTrab,0)))								//Numero de anos de servicio del trabajador 40	
	nPos := Ascan(aFunc,{ |x| x[1] = "3C  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Isentos           41
	nPos := Ascan(aFunc,{ |x| x[1] = "3D  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Gravados        42
	nPos := Ascan(aFunc,{ |x| x[1] = "3E  " })
	cGrava1 += "|"+ If(lMonto .And. Len(aRCP)> 0,Alltrim(Str(Round(aRCP[1,3],0))),"0")	//3e - Ingresos Acumulables 43
	nPos := Ascan(aFunc,{ |x| x[1] = "3F  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Imp.corresp. ultimo sueldo mensual ordinario44
	nPos := Ascan(aFunc,{ |x| x[1] = "3G  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos no acumulables  45
	nPos := Ascan(aFunc,{ |x| x[1] = "3H  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto Retenido         46
Endif

//
//Ingresos Asimilados a Salarios
//
If lAsimSal
	nPos := Ascan(aFunc,{ |x| x[1] = "4I  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos Asimilados a Salarios   47
	nPos := Ascan(aFunc,{ |x| x[1] = "4J  " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto ret. durante ejercicio
Endif

//Ŀ
//Ingresos en Acciones o Titulos valor que representan bienes
//
nPos := Ascan(aFunc,{ |x| x[1] = "41K " })
If nPos > 0                                                             //49
	cGrava1 += "|"+ If(nPos > 0, "1","2") 								//Indique si ejerci la opcin otorgada por el empleador para adquirir acciones o titulos
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Valor de Mercado de las acciones 50
	nValorMercado	:= aFunc[nPos,2]
	nPos := Ascan(aFunc,{ |x| x[1] = "41L " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Precio estab.al otogarse la opcion 51
	nPrecAcTit		:= aFunc[nPos,2]
	If nValorMercado > nPrecAcTit
		nField56 := nValorMercado - nPrecAcTit
	EndIf
	cGrava1 += "|"+ Alltrim(Str(Abs(nField56)))	//Impuesto Retenido  53	
	nPos := Ascan(aFunc,{ |x| x[1] = "41N " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ingresos acumulables                 52	
Endif	
//Ŀ
//Pagos Del Patron Efectuados a sus Trabajadores
//
If lPagPat

	nAux := 0
	nAux1 := 0	

	nPos := Ascan(aFunc,{ |x| x[1] = "5OG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Sueldos Salarios Rayas Y Jornales  Gravado 54
	nAux := If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5OE " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Sueldos Salarios Rayas Y Jornales Exento 55
	nAux1 := If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5PG " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gratificacao Anual    56
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5PE " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gratificacao Anual    57
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5QG " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Viaticos e Gastos de Viagem 58
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )	
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5QE " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Viaticos e Gastos de Viagem 59
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )	
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5RG " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Tempo Extraordinario     60
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5RE " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Tempo Extraordinario    61
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5SG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima Vacacional        62
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5SE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima Vacacional       63
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5TG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima Dominical 
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5TE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima Dominical 
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5UG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//PTU             
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5UE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//PTU                
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5VG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gastos Medicos
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5VE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gastos Medicos
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5WG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Fondo de ahorro
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5WE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Fondo de ahorro    
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5XG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Caja de ahorro
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5XE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Caja de ahorro     
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5YG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para Despensa
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5YE " }) 
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para Despensa
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5ZG " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gastos Funeral
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5ZE " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Gastos Funeral     
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5A1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Contr.a cargo del trab.pag. patron
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5A1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Contr.a cargo del trab.pag. patron
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5B1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Premios por puntualidad   80
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5B1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Premios por puntualidad
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5C1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima de seguro de vida
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5C1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Prima de seguro de vida
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5D1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Seguro de gastos medicos mayores
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5D1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Seguro de gastos medicos mayores
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5E1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para restaurante
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5E1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para restaurante
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5F1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para gasolina
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5F1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para gasolina
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5G1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para ropa    
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5G1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para ropa    
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5H1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para renta   
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5H1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Vales para renta   
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5I1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Articulos escolares
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5I1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Articulos escolares
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5J1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Dotacion o ayuda para anteojos
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5J1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Dotacion o ayuda para anteojos
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5K1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ayuda para Transporte
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5K1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Ayuda para Transporte    
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5L1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Cuotas sindicales pagadas por el patron  100
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5L1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Cuotas sindicales pagadas por el patron
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5M1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Subsidio por incapacidad
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5M1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Subsidio por incapacidad
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5N1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Becas para trabajadores y/o sus hijos
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5N1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Becas para trabajadores y/o sus hijos
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5O1G" })
	cGrava1 += "|"+ If(nPos > 0 .And. RCV->RCV_EMCALA == "X",Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Pagos efetuados por otros empleadores
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5O1E" })
	cGrava1 += "|"+ If(nPos > 0 .And. RCV->RCV_EMCALA == "X",Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Pagos efetuados por otros empleadores
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5P1G" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Otros ingresos por salarios
	nAux += If( nPos > 0, aFunc[nPos,2], 0 )
	
	nPos := Ascan(aFunc,{ |x| x[1] = "5P1E" })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Otros ingresos por salarios                
	nAux1 += If( nPos > 0, aFunc[nPos,2], 0 )

	//6Q1     
	//nAux := 0
	/*If( nPos:=Ascan(aFunc,{ |x| x[1] = "5OG " }) ) > 0
		nAux += aFunc[nPos,2]
	EndIf 
	If( nPos:=Ascan(aFunc,{ |x| x[1] = "5P1G" }) ) > 0
		nAux += aFunc[nPos,2]
	EndIf */
	If !(nAux == 0)
		cGrava1 += "|"+AllTrim(Str(Abs(nAux)))  //Suma del ingreso gravado por sueldos y salarios             110
	Else
		cGrava1 += "|0"
	Endif

	//6R1
	//nAux1 := 0
	/*If( nPos:=Ascan(aFunc,{ |x| x[1] = "5OE " }) ) > 0
		nAux1 += aFunc[nPos,2]
	EndIf 
	If( nPos:=Ascan(aFunc,{ |x| x[1] = "5P1E" }) ) > 0
		nAux1 += aFunc[nPos,2]
	EndIf*/
	If !(nAux1 == 0)
		cGrava1 += "|"+AllTrim(Str(Abs(nAux1)))  //Suma del ingreso exento por sueldos y salarios              111
	Else
		cGrava1 += "|0"
	Endif	

	nPos := Ascan(aFunc,{ |x| x[1] = "6U1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto retenido durante el ejercicio                      113
	nPos := Ascan(aFunc,{ |x| x[1] = "6V1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto Retenido por otro(s)patrones durante el ejercicio   114
	nPos := Ascan(aFunc,{ |x| x[1] = "6W1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Saldo a favor det.en el ejerc.que declara                  115
	nPos := Ascan(aFunc,{ |x| x[1] = "6X1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Saldo a favor del ejer.anterior no compensado              116
	nPos := Ascan(aFunc,{ |x| x[1] = "6Y1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Suma de las cant.que por concep.de credito al salario      117
	nPos := Ascan(aFunc,{ |x| x[1] = "6Z1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Cr.al sal.entregado en efectivo al trabajador              118
	nPos := Ascan(aFunc,{ |x| x[1] = "6A1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Monto total de ingresos obt.por conc.de prest.prev.social   119
	nPos := Ascan(aFunc,{ |x| x[1] = "6B1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Suma de ing.exentos por conc.de pres.de prev.social         120
	/*nPos := Ascan(aFunc,{ |x| x[1] = "6S1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Suma del ingresos por sueldos y salarios*/
	cGrava1 += "|"+ If( (nAux+nAux1) > 0, AllTrim(Str(Abs(nAux+nAux1))), "0" )
	nPos := Ascan(aFunc,{ |x| x[1] = "6T1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Monto del imp.local a los ing. por sueldos y sal. y en gen.por prest.
	nPos := Ascan(aFunc,{ |x| x[1] = "6C1 " })
	cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Monto del subs.para el empleo entregado en efec. al trab. dur.el ejercicio
	//cGrava1 += "|"+ "0"													//Monto del subs.para nivelacion del empleo entregado en efectivo al trab. dur.el ej.
Endif	
//Ŀ
//Impuesto sobre la Renta (Resumen)
//
//nPos := Ascan(aFunc,{ |x| x[1] = "2B  " })
//cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Imp.Local a los ing.por sueldos, sal.y en general

nPos := Ascan(aFunc,{ |x| x[1] = "2D  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Total de Las Aportaciones Voluntarias Deducibles

/*nPos := Ascan(aFunc,{ |x| x[1] = "2F  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")*/	
nPos := Ascan(aFunc,{ |x| x[1] = "2G  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//ISR conforme a la tarifa anual
nPos := Ascan(aFunc,{ |x| x[1] = "2H  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Subsidio Acreditable
nPos := Ascan(aFunc,{ |x| x[1] = "2I  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Subsidio No Acreditable
/*nPos := Ascan(aFunc,{ |x| x[1] = "2L  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto sobre ingresos acumulables*/
nPos := Ascan(aFunc,{ |x| x[1] = "2M  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto sobre ingresos acumulables
nPos := Ascan(aFunc,{ |x| x[1] = "2N  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto sobre ingresos no acumulables

//nPos := Ascan(aFunc,{ |x| x[1] = "2I  " })
//cGrava1 += "|"	+If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Subs para el empleo entregado al trabajador													//Subs.para el empleo entregado al trabajador

/*nPos := Ascan(aFunc,{ |x| x[1] = "2B  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")*/	
nPos := Ascan(aFunc,{ |x| x[1] = "6T1 " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Imp.Local a los ing.por sueldos, sal.y en general

//cGrava1 += "|"	+"0"												//Subs.para la nivelacion del ingreso entregado al trabajador

nPos := Ascan(aFunc,{ |x| x[1] = "2J  " })
cGrava1 += "|"+ If(nPos > 0,Alltrim(Str(Abs(aFunc[nPos,2]))),"0")	//Impuesto sobre ingresos no acumulables

aFunc		:= {}
nDiasTrab:= 0
nAnoTrab := 0
cMesIni	:= ""

Return(cGrava1)

/*


Ŀ
Funcao     fAniosTrb   Autor  Alfredo Medrano        Data 13/10/2015
Ĵ
Descricao  calcular el nmero de aos reconocidos de acuerdo a la fecha 
           de reconocimiento (RA_DTREC), de reingreso (RA_FECREI) o de  
           admision (RA_ADMISSA)                                        
Ĵ
Sintaxe    fAniosTrb()                                                  
Ĵ
Parametros                                                              
Ĵ
Retorno    cReturn: cMat                                                
Ĵ
 Uso      CGPM740IMP                                                    
ٱ


*/
static function fAniosTrb()
	Local aArea		:= GetArea()
	Local cTempF 		:= CriaTrab(Nil, .F.)
	Local cMat		:= RCV->RCV_MAT
	Local cFil		:= RCV->RCV_FILIAL
	Local cBajLiq		:= SuperGetMv("MV_BAJLIQ",,"")
	Local cAplMes		:= SuperGetMv("MV_APLMES",,"N")
	Local dFech		:= CTOD("//")
	Local dFechIn		:= CTOD("//")
	Local dFechFi		:= CTOD("//")
	Local cCad		:= ''
	Local cValc		:= ''
	Local cQuery		:= ''
	Local nDias		:= 0
	Local nX			:= 0
	Local nAnioB		:= 0
	Local nMesB		:= 0
	Local aLiq		:= {}
	Local aDec		:= {}

	dFechIn := CTOD("01/01/" + Str(Val(cAnoRef) - 1))
	dFechFi := CTOD("31/12/" + cAnoRef)

	aLiq := STRTOKARR(ALLTRIM(cBajLiq), ',')
	If Len(aLiq) > 0 
		For nX:=1 to Len(aLiq)
			cCad += " '" + aLiq[nX]	+ "' ,"
		Next
			cBajLiq := Subs(cCad,1,len(cCad) - 1)
	EndIf
	
	cQuery := "SELECT RA_DTREC, RA_FECREI, RA_ADMISSA, RA_DEMISSA FROM " +  RetsqlName("SRA") + " SRA "
	cQuery += " WHERE RA_MAT = '" + cMat + "' AND D_E_L_E_T_='' "
	IF !Empty(cBajLiq)
		cQuery += " AND RA_TIPOFIN IN (" + cBajLiq + ") "
	EndIF
	cQuery += " AND RA_DEMISSA >= '" + DTOS(dFechIn) + "' AND RA_DEMISSA <= '"+ DTOS(dFechFi) +"'"
	cQuery += " ORDER BY RA_ADMISSA DESC "
	cQuery := ChangeQuery(cQuery)
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cTempF,.T.,.T.)
	TCSetField(cTempF,"RA_DTREC",	"D",8,0) // Formato de fecha Reconocimiento
	TCSetField(cTempF,"RA_FECREI",	"D",8,0) // Formato de fecha Reingreso
	TCSetField(cTempF,"RA_ADMISSA",	"D",8,0) // Formato de fecha Ingreso
	TCSetField(cTempF,"RA_DEMISSA",	"D",8,0) // Formato de fecha Baja
	count to nTotal
	
	nAnosTrab:= 0 // variable privada
	nAnosTTem:= 0
	(cTempF)->(dbGoTop())
	While (!(cTempF)->(EOF()))
	
		If !empty((cTempF)->RA_DTREC) // Fecha de Reconocimiento  
			
			nDias := ((cTempF)->RA_DEMISSA - (cTempF)->RA_DTREC + 1 )/365 
			nAnioB := NoRound(nDias, 0)
		
			IF cAplMes == 'S'
				//nDias := NoRound(nDias,2)
				aDec := STRTOKARR(ALLTRIM(str(nDias)), '.')
				If Len(aDec) = 2 
					cValc:= Substr(aDec[2],1,2)
					nMesB := (Val(cValc)/100) * 12
				EndIf
				nAnosTrab := nAnosTrab + nAnioB
				If nMesB	>= 6  
					nAnosTrab := nAnosTrab + 1
				EndIf	
			Else
				nAnosTrab := nAnosTrab + nAnioB
			EndIf
			
		ElseIf !empty((cTempF)->RA_FECREI) // Fecha de Reingreso   
			nDias := ((cTempF)->RA_DEMISSA - (cTempF)->RA_FECREI + 1 )/365 
			nAnioB := NoRound(nDias, 0)
		
			IF cAplMes == 'S'
				//nDias := NoRound(nDias,2)
				aDec := STRTOKARR(ALLTRIM(str(nDias)), '.')
				If Len(aDec) = 2 
					cValc:= Substr(aDec[2],1,2)
					nMesB := (Val(cValc)/100) * 12
				EndIf
				nAnosTrab := nAnosTrab + nAnioB
				If nMesB	>= 6  
					nAnosTrab := nAnosTrab + 1
				EndIf	
			Else
				nAnosTrab := nAnosTrab + nAnioB
			EndIf
			
		ElseIf !empty((cTempF)->RA_ADMISSA) // Fecha de Admision   
			nDias := ((cTempF)->RA_DEMISSA - (cTempF)->RA_ADMISSA + 1 )/365 
			nAnioB := NoRound(nDias, 0)
		
			IF cAplMes == 'S'
				//nDias := NoRound(nDias,2)
				aDec := STRTOKARR(ALLTRIM(str(nDias)), '.')
				If Len(aDec) = 2 
					cValc:= Substr(aDec[2],1,2)
					nMesB := (Val(cValc)/100) * 12
				EndIf
				nAnosTrab := nAnosTrab + nAnioB
				If nMesB	>= 6  
					nAnosTrab := nAnosTrab + 1
				EndIf	
			Else
				nAnosTrab := nAnosTrab + nAnioB
			EndIf
				
		EndIf

		( cTempF )->(dbSkip())
	EndDo
	
	nAnosTTem := nAnosTrab
	
	( cTempF )->(dbCloseArea())
	RestArea( aArea )
return
