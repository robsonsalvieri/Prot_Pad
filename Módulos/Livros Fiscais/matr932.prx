#INCLUDE "Matr932.ch"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "Matr930Def.ch"

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддддд©╠╠
╠╠ЁFun┤┘o    ЁMatr932      ЁAutorЁ Juan Jose Pereira    Ё Data Ё 06.01.97   Ё╠╠
╠╠цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁImprime Registro de Entradas P1A e Saidas P2A                 Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                       Ё╠╠
╠╠цддддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё PROGRAMADOR  Ё DATA   Ё BOPS Ё  MOTIVO DA ALTERACAO                     Ё╠╠
╠╠цддддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Marcos SimiduЁ26/11/97ЁXXXXXXЁImpressao de itens com Tes do livro ='Z'  Ё╠╠
╠╠Ё Marcos SimiduЁ27/11/97Ё13677AЁCorrecao de salto de pagina.              Ё╠╠
╠╠Ё Marcos SimiduЁ23/12/97Ё13855AЁCorrecao nas totalizacoes mes/periodos.   Ё╠╠
╠╠Ё Marcos SimiduЁ11/02/98ЁXXXXXXЁCompatibilizacao com Emissor Cupom Fiscal Ё╠╠
╠╠Ё Marcos SimiduЁ24/03/98Ё14621AЁInclusao parametro Totaliza por dia.      Ё╠╠
╠╠Ё Rodrigo Sart.Ё25/03/98Ё10385AЁAlteracao do parametro mv_par04  Lista:   Ё╠╠
╠╠Ё              Ё        Ё      Ё(1)Livros (2)Termos (3)Livros e Termos    Ё╠╠
╠╠Ё Rodrigo Sart.Ё27/03/98Ё14810AЁ Tratamento do estado origem no Resumo    Ё╠╠
╠╠Ё              Ё        Ё14810AЁ variavel (lLisEstOri).                   Ё╠╠
╠╠Ё Marcos SimiduЁ02/04/98Ё15022AЁImpressao de Termo Encerr. quando o perio-Ё╠╠
╠╠Ё              Ё        Ё15022AЁdo informado nao possuir movimento.       Ё╠╠
╠╠Ё Marcos SimiduЁ06/05/98ЁXXXXXXЁAcertos na impressao do termo de encerra- Ё╠╠
╠╠Ё              Ё        Ё      Ёmento do livro de saidas.                 Ё╠╠
╠╠Ё Marcos SimiduЁ11/08/98ЁXXXXXXЁZerar array acumulador dos resumos.       Ё╠╠
╠╠Ё Marcos SimiduЁ22/10/98Ё18419AЁAcertos no param.consid.UF no demonst.    Ё╠╠
╠╠Ё              Ё22/10/98Ё18419AЁpor estado de origem.                     Ё╠╠
╠╠Ё Marcos SimiduЁ03/11/98ЁXXXXXXЁAcertos no ano com 4 bytes.               Ё╠╠
╠╠Ё Andreia      Ё29/01/99ЁxxxxxxЁAlteracao do lay-out devido ao aumento do Ё╠╠
╠╠Ё              Ё        Ё      Ёcampo conta contabil.  	                Ё╠╠
╠╠Ё Andreia      Ё11/03/99ЁxxxxxxЁTratamento da especie das notas fiscais   Ё╠╠
╠╠Ё              Ё        Ё      Ёcanceladas atraves do parametro MV_ESPECIEЁ╠╠
╠╠Ё Andreia      Ё04/08/99Ё22553AЁTratamento do parametro MV_PAR21 que defi-Ё╠╠
╠╠Ё              Ё        Ё      Ёne em qual coluna sera impresso o imposto Ё╠╠
╠╠Ё              Ё        Ё      Ёretido.                                  	Ё╠╠
╠╠Ё Andreia      Ё05/11/99Ё24340AЁTroca de CGC por CNPJ.                    Ё╠╠
╠╠Ё Andreia      Ё14/12/99Ё19277AЁNo resumo por CFOP,trocar TOTAL por SUB-TOTALЁ╠╠
╠╠Ё              Ё        Ё      Ёe TOTAL GERAL por TOTAL(Portaria CAT 08/90).Ё╠╠
╠╠Ё Guilherme    Ё06/07/07Ё125854ЁInclusao do numero da Reducao Z para os   Ё╠╠
╠╠Ё Santos       Ё        Ё      Ёmovimentos gerados para ECF's.            Ё╠╠
╠╠Ё              Ё        Ё      Ё                                          Ё╠╠
╠╠Ё Vogas Junior Ё23/03/18ЁDSERFIS2-4167 Parametrizacao da informacao de UF Ё╠╠
╠╠Ё              Ё        Ё      Ё nas notas de conhecimento de transporte. Ё╠╠
╠╠юддддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC aSX6		:= R930LoadX6()

FUNCTION Matr932()

Local cArqCiap		:= ""
LOCAL nSvApurICM 	:= 0
LOCAL nSvApurIPI 	:= 0

Private aSX6		:= R930LoadX6()
Private cIndxSF3  	:=""
Private nCredAtivo	:=0
Private cPesqCFO	:= PESQPICT("SF3","F3_CFO")
Private cPesqICMRET := PESQPICT("SF3","F3_ICMSRET")
Private cPesqOBSI	:= PESQPICT("SF3","F3_OBSICM")
Private cPesqOBSS	:= PESQPICT("SF3","F3_OBSSOL")
Private cPesqCRPR	:= PESQPICT("SF3","F3_CRPRST")
                          
						  
//зддддддддддддддддддддддддддддддддд©
//Ё Flag de Movimentacao            Ё
//юддддддддддддддддддддддддддддддддды
lHouveMov:=.F.
//зддддддддддддддддддддддддддддддддд©
//Ё Largura do campo de observacoes Ё
//юддддддддддддддддддддддддддддддддды
nLargObs:=If(nTipoMov=1,42,36)
//здддддддддддддддддддддддддддддд©
//Ё Pictures de campos numericos Ё
//юдддддддддддддддддддддддддддддды
cPictVl:=If(nTipoMov==1,"@E 999,999,999,999.99","@E 999,999,999,999.99")	// Colunas Valores
//зддддддддддддддддддддддддддддддддддд©
//Ё Recebe layout do modelo escolhido Ё
//юддддддддддддддддддддддддддддддддддды
aL:=NIL
R932LayOut()
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Cria Arquivo a ser Impresso com um indice de mesmo nome            Ё
	//Ё Ordem (1) = F3_FILIAL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cArqTemp  :=EmiteLivro(If(nTipoMov==1,"E","S"),dDtIni,dDtFim,lLacuna,lServico,lDesconto,cNrLivro,cFilterUser,@cArqCiap,MV_PAR27,MV_PAR09,MV_PAR31,MV_PAR32,MV_PAR33,MV_PAR36,"MATR930",,MV_PAR30==1,lConjugada)
	//здддддддддддддддддддддддддддд©
	//Ё Salva periodos de Apuracao Ё
	//юдддддддддддддддддддддддддддды
	nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
	nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
EndIf
If !lAbortPrint
	If nTipoMov==1
		R932RegEntradas(nSvApurIcm,nSvApurIpi)
	Else
		R932RegSaidas(nSvApurIcm,nSvApurIpi)
	Endif
Endif
//зддддддддддддддд©
//Ё Restaura area Ё
//юддддддддддддддды
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dbCloseArea()
	Ferase(cArqTemp+GetDbExtension())
	Ferase(cArqTemp+OrdBagExt())
EndIf
If ( Select("CIAP")!=0 )
	dbSelectArea("CIAP")
	dbCloseArea()
	Ferase(cArqCiap+GetDbExtension())
	Ferase(cArqCiap+OrdBagExt())
EndIf
If ( Select(cArqSF3)!=0 )
	dbSelectArea(cArqSF3)
	dbCloseArea()
	Ferase(cArqSF3+GetDbExtension())
	Ferase(cIndxSF3+OrdBagExt())
EndIf
dbSelectArea(aSvArea[1])
dbSetOrder(aSvArea[2])
dbGoto(aSvArea[3])
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠здддддддддбдддддддддддддддбдддддбдддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o   ЁR932RegEntradasЁAutorЁJuan Jose Pereira    Ё Data Ё 18.12.96 Ё╠╠
╠╠цдддддддддедддддддддддддддадддддадддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘oЁImprime Registro de Entradas                                 Ё╠╠
╠╠юдддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932RegEntradas(nSvApurIcm,nSvApurIpi)

Local nTotICMS	:= 0

Local aProdutor	:= {}
Local dDataProd	:= cToD("  /  /  ")
Local lApur 	:= .F.
Local aAreaSM0	:= SM0->(GetArea())
Local lP1IcmST		:= aSX6[MV_P1ICMST]
Local lProcST	:= .T.
Local lAliqstn  := aSX6[MV_ALIQSTN] // parametro tem como objetivo nao imprimir aliquota de ICMS ST no relatorio
Local cChaval	:= ""
Local lEntAmb   := .F.
Local lImprZero	:= aSX6[MV_IMPZNFC]
Local cIdTipo   := ""							//Identifica Tipo CNPJ/CPF
Local cUltNF		:= ''								// зltima Nota para controle de total do valor contАbil no primeiro item
Local nVlrOrig		:= 0								// Valor original do campo para parametrizaГЦo de valor contАbil por item
Local cUfFornecedor	:= aSX6[MV_NFCTEUF]
Local nTamCon		:= 0
Local nMaxLin		:= 0
Local nMaxCol		:= 20
Local nIniPos		:= 0
Local nH			:= 0
Local nI			:= 0
Local cContaFor		:= ""


Private lMod55		:= aSX6[MV_SPED55]
Private aLinCont	:= {}

aGrade			:= NIL

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=(cArqTemp)->F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
		lTotGrade:=.F.
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Considera filtro do usuario                     Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o valor do ICMS Retido de acordo com a configuracao da TES     Ё
		//ЁQuando o campo F3_CREST existir e estiver configurado como "4",         Ё
		//Ёo valor do ICMS retido nao deve ser apresentado na coluna de observacoesЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		lProcST := .T.
		If (cArqTemp)->F3_CREDST == "4" .And. lP1IcmST
		       	lProcST := .T.
	       	Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST 
				lProcST := .F. 
		    Elseif (cArqTemp)->F3_CREDST == "4" .And. (cArqTemp)->F3_OBSSOL>0
   		       	lProcST := .F.
			Endif
		 lEntAmb := .F.
          
		//зддддддддддд©
		//Ё Cabecalho Ё
		//юддддддддддды
		If nLin>nLimPag .And. !(cArqTemp)->SEMMOV
			R932Cabec(dDia)
		Endif
		//зддддддддддддддддддддддддддддд©
		//Ё Contador de Tamanho de nota Ё
		//юддддддддддддддддддддддддддддды
		nTamNota:=nLin
		
		//зддддддддддддддддддддддддддддддддд©
		//ЁImprime os periodos sem movimentoЁ
		//юддддддддддддддддддддддддддддддддды
		If (cArqTemp)->SEMMOV
			dDia:=(cArqTemp)->F3_ENTRADA
			R932Cabec(dDia)
			cLinha:=FmtLin(Array(16),aL[17],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			R932TermEnc()
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA          
			lHouveMov := .T.
			Loop     
		Endif    

		//зддддддддддддддддддддддддддд©
		//ЁSalva o perМodo de apuraГЦoЁ
		//юддддддддддддддддддддддддддды
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo((cArqTemp)->F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo((cArqTemp)->F3_ENTRADA,nApurIPI)
		Endif                         
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPosiciona na filial em que foi processado o registro	Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Posiciona nos cadastros de Clientes/FornecedoresЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		cClieFor:=(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA
		If lF3_CLIDVMC .And. !Empty(F3_CLIDVMC)
			cClieFor:=Alltrim((cArqTemp)->F3_CLIDVMC)+Alltrim((cArqTemp)->F3_LOJDVMC)
		Endif
		If(F3_TIPO$"DB",dbSelectArea("SA1"),dbSelectArea("SA2"))
		MSSeek(xFilial()+cClieFor)
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁConta contabil devera ser buscada no parametro MV_CTALFE de cada filialЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cContaContab := Alltrim(aSX6[MV_CTALFE])
		cContaContab :=	StrTran(cContaContab,"SF3->","(cArqTemp)->")
		cContaContab := IIF(Empty(EvalMacro(cContaContab)), (cArqTemp)->CONTA,EvalMacro(cContaContab))
		//dbSelectArea(cArqTemp)
		//здддддддддддддддддддддддддддддддддд©
		//ЁRestaura a filial e area corrente Ё
		//юдддддддддддддддддддддддддддддддддды
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de Observacao Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,,lListaNFO,,lObsFecp,,;
			(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA+(cArqTemp)->F3_SERIE+(cArqTemp)->F3_NFISCAL+(cArqTemp)->F3_IDENTFT;
		)
		R932IniGrade()
		If lEntAmb
			aGrade[1,2]:=0
			aGrade[1,3]:=0
			aGrade[2,2]:=0 
			aGrade[3,2]:=0
	    	aGrade[1,4]:=0
		Else
			aGrade[1,2]:=(cArqTemp)->F3_BASEICM
			aGrade[1,3]:=(cArqTemp)->F3_VALICM
			aGrade[2,2]:=(cArqTemp)->F3_ISENICM 
			aGrade[3,2]:=(cArqTemp)->F3_OUTRICM
	            If !Empty((cArqTemp)->F3_VLINCMG)
	                aGrade[3,2] += (cArqTemp)->F3_VLINCMG
	            EndIf
			cChaval:=(cArqTemp)->F3_NFISCAL+(cArqTemp)->F3_SERIE+(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA  
			SD1->(dbSetOrder(1))
			SF4->(dbSetOrder(1))
			If SD1->(MSSeek(xFilial("SD1")+cChaval))
			    If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
				    If SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z"
			       	    aGrade[1,4]:=F3_VALCONT
				    EndIf
			    EndIf
			EndIf
		EndIf
			
		IF cMV_ESTADO != "SP" .OR. lCat21
            If lEntAmb
		 	    aGrade[4,2]:=0
			    aGrade[4,3]:=0
			    aGrade[5,2]:=0
			    aGrade[6,2]:=0
            Else

		 	    aGrade[4,2]:=(cArqTemp)->F3_BASEIPI
			    aGrade[4,3]:=(cArqTemp)->F3_VALIPI
			    aGrade[5,2]:=(cArqTemp)->F3_ISENIPI
			    aGrade[6,2]:=(cArqTemp)->F3_OUTRIPI
            EndIf
        ENDIF

		//Imprime no campo codigo emitente o CNPJ/CPF ou o codigo do fornecedor 
		If mv_par47==1
			If RetPessoa((cArqTemp)->CGC) == "F"
		    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R 999.999.999-99")
		    ELSE
		    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R! NN.NNN.NNN/NNNN-99")
		    EndIf
    	Else
			cIdTipo := (Alltrim((cArqTemp)->COD)+"-"+(cArqTemp)->LOJA)
		Endif    	

		aDados:=Array(16)
		aDados[1]:=DTOC((cArqTemp)->F3_ENTRADA)
		aDados[2]:=IIf(Empty((cArqTemp)->F3_ESPECIE),R930CFOTra((cArqTemp)->F3_CFO,SerieNfId(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim((cArqTemp)->F3_ESPECIE) == "SPED","55",(cArqTemp)->F3_ESPECIE))  
		aDados[3]:=SerieNfId(cArqTemp,2,"F3_SERIE")
		aDados[4]:=(cArqTemp)->F3_NFISCAL
		aDados[5]:=DTOC((cArqTemp)->F3_EMISSAO)
		aDados[6]:=cIdTipo		
		aDados[7]:= Iif( cUfFornecedor == '1' .And. AllTrim( (cArqTemp)->F3_ESPECIE ) == 'CTE', SA2->A2_EST, F3_ESTADO )
		
		aLinCont:= {}	//zera array devido a carga R931ImpGrade para impressao de conhecimento de frete	
		If Empty((cArqTemp)->F3_DTCANC) .Or. lImprZero
			aDados[8]:=Iif(lEntAmb==.T.,0,(cArqTemp)->F3_VALCONT)
			aDados[9]:=Alltrim(Substr(cContaContab,1,TamSX3("A2_CONTA")[1]))
			//Tratativa para imprimir conta contabil com tamanho maior que 20 sem quebrar a coluna do relatorio
			nTamCon := IIF(Valtype(aDados[7]) == "C", Len(Alltrim(aDados[9])), 0) //checa a quantidade de caracteres da conta contabil
			If nTamCon > nMaxCol //verifica necessidade de tratativa para quebra de linha devido ao tamanho da conta contabil
				nMaxLin := Ceiling(nTamCon/nMaxCol) //qtd total de quebras de linhas
				cContaFor := aDados[9]
				aAdd(aLinCont,Substr(cContaFor,1,nMaxCol)) //limita o tamanho da conta contabil para impressao na primeira linha

				//Cria array para armazenar os dados da conta contabil por quebra de linha
				For nH:=2 to nMaxLin
					nIniPos :=(nMaxCol*nH)-21
					cQuebraCon := Substr(cContaFor,nIniPos,nMaxCol)
					If !Empty(cQuebraCon)
						aAdd(aLinCont,cQuebraCon) //alimenta o array das quebras da conta contabil por linha
					EndIf
				Next nH
			EndIf

			aDados[10]:=If(substr(F3_CFO,1,3)$"999#000",,Transform((cArqTemp)->F3_CFO,cPesqCFO)) 
			If nModelo != 5
				If lEntAmb
				    aDados[14]:=""
				Else
				    aDados[14]:=Iif((cArqTemp)->F3_ALIQICM > 0,Transform((cArqTemp)->F3_ALIQICM,"@E 99.99"),"")
			    Endif
			EndIf
			nTotICMS += Iif(lEntAmb==.T.,0,(cArqTemp)->F3_VALICM)
		Endif
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If lVlCtTot
			nVlrOrig	:= aDados[8]
			aDados[8]	:= R932TVlCtEn(@cUltNF)
			R932ImpGrade()
			aDados[8]	:= nVlrOrig
		Else
			R932ImpGrade()
		EndIf
		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0   
			If nLin>=nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			Endif
		End
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GO Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and.(cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL>0  .And. lProcST
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=(cArqTemp)->F3_BASERET
			If nColuna == 1
				aDados[16]:=STR0001+Alltrim(Transform((cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[15]:=(cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
			ElseIf nColuna == 3
				If F3_TIPO == "D"
					aDados[15]:=(cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
				Else
					aDados[16]:=STR0001+Alltrim(Transform((cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			EndIf
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. (cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL>0  .And. lProcST .And. (cArqTemp)->F3_CREDST <> '4'
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=(cArqTemp)->F3_BASERET 
			If nModelo != 5
				aDados[14]:= Iif(lAliqstn,"",Iif((cArqTemp)->F3_ALIQICM > 0,Transform((cArqTemp)->F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[15]:=(cArqTemp)->F3_ICMSRET-(cArqTemp)->F3_OBSSOL
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Endif
		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			For nI:=1 to Len(aLinCont)
				aDados[9] := aLinCont[nI]
				FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			Next nI
		EndIf	   
		//зддддддддддддддддд©
		//Ё Acumula valores Ё
		//юддддддддддддддддды
		nLinNec:=nLin-nTamNota+If(lImpZer,3,0)
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3,,,@aTotObs)
		dDiaAnt:=(cArqTemp)->F3_ENTRADA
		//********************* CIAP **********************
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atualiza a Manutencao do CIAP                   Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		If lEmiteCiap
			If Select("CIAP") > 0
				dbSelectArea("CIAP")
				If ( MSSeek(&(cArqTemp)->(Recno())) )
					While ( !Eof() .And. CIAP->SF3==&(cArqTemp)->(Recno()) )
						dbSelectArea("SF9")
						dbGoto(CIAP->SF9)
						Begin Transaction
							RecLock("SF9",.F.)
							SF9->F9_NLRE := Val(cLivro)
							SF9->F9_FLRE := nPagina
							MsUnlock()
						End Transaction
						dbSelectArea("CIAP")
						dbSkip()
					EndDo
				Endif
			EndIf
		Endif
		//********************* CIAP **********************
		dbSelectArea(cArqTemp)
		dDataProd 	:= (cArqTemp)->F3_ENTRADA		
		nMes 		:= Month((cArqTemp)->F3_ENTRADA)
		dbSkip()
		If !Eof()
			dDia:=(cArqTemp)->F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf
		//зддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Totais e finaliza relatorio Ё
		//юддддддддддддддддддддддддддддддддддддды
		lTotGrade:=.T.
		lHouveMov:=.T.
		R932Totais(@nSvApurIcm,@nSvApurIpi)
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁImprime quadro de demonstrativo de Produtor RuralЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		If lProdutor .And. nModelo == 2 .And. Month((cArqTemp)->F3_ENTRADA) <> nMes
			nMes := Month((cArqTemp)->F3_ENTRADA)
			aProdutor := {}
			aProdutor := Mtr930Apur(nApurICM,Year(dDataProd),Month(dDataProd),cNrLivro)
			If Len(aProdutor) > 0
				R932Cabec(dDataProd,.F.)
				FmtLin(,aL[20],,,@nLin)
				FmtLin(,aL[21],,,@nLin)
				FmtLin(,aL[22],,,@nLin)
				FmtLin({aProdutor[01][02]},aL[23],,,@nLin)
				FmtLin(,aL[24],,,@nLin)
				FmtLin({nTotICMS},aL[25],,,@nLin)
				FmtLin(,aL[26],,,@nLin)
				FmtLin({aProdutor[01][03]+aProdutor[01][04]},aL[27],,,@nLin)
				FmtLin(,aL[28],,,@nLin)
				FmtLin({aProdutor[01][01]},aL[29],,,@nLin)
				FmtLin(,aL[30],,,@nLin)
				FmtLin(,aL[31],,,@nLin)
				FmtLin({(aProdutor[01][02]+nTotICMS)-(aProdutor[01][03]+aProdutor[01][01]+aProdutor[01][04])},aL[32],,,@nLin)
				FmtLin(,aL[33],,,@nLin)
				FmtLin(,aL[34],,,@nLin)
				nLin := 80
			Endif
	
		Endif
	End
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Quando nao ha movimento                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lHouveMov
		dDia:=dDtIni
		R932Cabec(dDia)
		cLinha:=FmtLin(Array(16),aL[17],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R932TermEnc()
	Endif
Else
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de Abertura    Ё
	//юдддддддддддддддддддддддддддддды
	R932TermIni()
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de EncerramentoЁ
	//юдддддддддддддддддддддддддддддды
	R932TermEnc()
EndIf
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠здддддддддбдддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o   ЁR932RegSaidasЁAutorЁ Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цдддддддддедддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘oЁImprime Registro de Saidas                                   Ё╠╠
╠╠юдддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932RegSaidas(nSvApurIcm,nSvApurIpi)

Local lMV_ESTCLI 	:= aSX6[MV_ESTCLI]	//Parametro para mudar a pesquisa do estado do cliente. F3_ESTADO pelo A1_EST ou A2_EST.
Local lEcfNotas 	:= aSX6[MV_ECFNOTA]	//Parametro tem como objetivo imprimir o documento final mesmo sem a utilizacao de Aglutinar Notas Fiscais de Saida
Local lApur			:= .F.
Local aAreaSM0 		:= SM0->(GetArea())
Local lProcST		:= .T.
Local lImpSemMov	:= .F.
Local lImpTot		:= .F.
Local lAliqstn      := aSX6[MV_ALIQSTN] // parametro tem como objetivo nao imprimir aliquota de ICMS-ST no relatorio
Local dQbrDia       := ""
Local lSaiAmb       := .F.
Local lImprZero		:= aSX6[MV_IMPZNFC]
Local lP1IcmST		:= aSX6[MV_P1ICMST]
Local cRet931Ecf	:= ""
Local nTamCon		:= 0
Local nMaxLin		:= 0
Local nMaxCol		:= 20
Local nIniPos		:= 0
Local cContaFor		:= ""
Local nH			:= 0
Local nI			:= 0

PRIVATE aLinCont	:= {}
PRIVATE aGrade:={}                                 


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
	
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif     
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Considera filtro do usuario                     Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o valor do ICMS Retido de acordo com a configuracao da TES     Ё
		//ЁQuando o campo F3_CREST existir e estiver configurado como "4",         Ё
		//Ёo valor do ICMS retido nao deve ser apresentado na coluna de observacoesЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		lProcST := .T.
		If (cArqTemp)->F3_CREDST == "4" .And. (cArqTemp)->F3_OBSSOL>0
		       	lProcST := .F.
	       	Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST 
				lProcST := .F.
		Endif
		lSaiAmb := .F.
       
		If (!lLacuna .AND. !Empty(F3_DTCANC))
			If lHouveMov
				dQbrDia:=F3_ENTRADA
			EndIf
			dbSelectArea(cArqTemp)
			dbSkip()
			If lHouveMov
				dDia:=F3_ENTRADA
			EndIf
			lImpTot := .F. 
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verifico se a ultima nota eh cancelada e se houve quebra da data para imprimir o Total Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If lHouveMov .And. (dQbrDia <> dDia) 
    			R932Totais(@nSvApurIcm,@nSvApurIpi)
			Endif
			
			loop
		Endif
		//зддддддддддд©
		//Ё Cabecalho Ё
		//юддддддддддды
		If nLin>nLimPag .And. !(cArqTemp)->SEMMOV .And. !Empty(dDia)
			R932Cabec(dDia)
		Endif
		//зддддддддддддддддддддддддддддддддд©
		//ЁImprime os periodos sem movimentoЁ
		//юддддддддддддддддддддддддддддддддды
		If (cArqTemp)->SEMMOV .And. !Empty(dDia)
			dDia:=(cArqTemp)->F3_ENTRADA
			R932Cabec(dDia)
			cLinha:=FmtLin(Array(14),aL[19],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			R932TermEnc()
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA
			lHouveMov := .F.
			lImpSemMov:= .T.
			Loop     
		Endif

		//зддддддддддддддддддддддддддд©
		//ЁSalva o perМodo de apuraГЦoЁ
		//юддддддддддддддддддддддддддды
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
		Endif
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPosiciona na filial em que foi processado o registro	Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
		//здддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o parametro para cada filial processadaЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддды
        lMV_ESTCLI 	:= aSX6[MV_ESTCLI]
		//здддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Posiciona nos cadastros de Clientes/Fornecedores Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддды
		cClieFor:=(cArqTemp)->(F3_CLIEFOR+F3_LOJA)
		If(F3_TIPO$"DB",dbSelectArea("SA2"),dbSelectArea("SA1"))
		MSSeek(xFilial()+cClieFor)
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁConta contabil devera ser buscada no parametro MV_CTALFS de cada filialЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cContaContab := Alltrim(aSX6[MV_CTALFS])
		cContaContab := StrTran(cContaContab,"SF3->","(cArqTemp)->")
		cContaContab := IIF(Empty(EvalMacro(cContaContab)), (cArqTemp)->CONTA,EvalMacro(cContaContab))
		//здддддддддддддддддддддддддддддддддд©
		//ЁRestaura a filial e area corrente Ё
		//юдддддддддддддддддддддддддддддддддды
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//зддддддддддддддддддддддддддддд©
		//Ё Contador de Tamanho de nota Ё
		//юддддддддддддддддддддддддддддды
		nTamNota:=nLin

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,,lListaNFO,,lObsFecp,,;
			(cArqTemp)->F3_CLIEFOR+(cArqTemp)->F3_LOJA+(cArqTemp)->F3_SERIE+(cArqTemp)->F3_NFISCAL+(cArqTemp)->F3_IDENTFT;
		)
		//здддддддддддддддддд©
		//Ё Linhas de DetalheЁ
		//юдддддддддддддддддды
		aDados:=ARRAY(14)
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPreenche a especie de acordo com a regra e Artigo utilizado utilizada  Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aDados[1] := R931GetEcf(cArqTemp,1)  
		aDados[2] := R931GetEcf(cArqTemp,2)

		IF lAglutina
			aDados[3]:=F3_NFISCAL+" A "+IF(!EMPTY(F3_DTCANC),F3_NFISCAL,F3_DOCOR)	 	
		ELSE
			aDados[3]:= F3_NFISCAL + " A " +IF((F3_TIPO $ "L".Or.F3_SERIE == "ECF") .And. !lEcfNotas ,F3_DOCOR,F3_NFISCAL)
		ENDIF

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁLayout de acordo com a lei 9.513 (lista o intervalo de cupons fiscais - ECF)Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lLeiECF .AND. !Empty(F3_PDV)
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁPosiciona na filial em que foi processado o registro	Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
	        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁRecupera a partir do SFI, o numero do ultimo documento emitido no ECF.Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If !(AllTrim(F3_ESPECIE) == "NFCE" .Or. AllTrim(F3_ESPECIE) == "SATCE")
				cRet931Ecf := R931GetEcf(cArqTemp,3) 
				aDados[3] := Iif(!Empty(cRet931Ecf),cRet931Ecf,aDados[3]) 
			EndIf

			dbSelectArea(cArqTemp)
			//здддддддддддддддддддддддддддддддддд©
			//ЁRestaura a filial e area corrente Ё
			//юдддддддддддддддддддддддддддддддддды
			Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		Endif

		aDados[4]:=StrZero(Day(F3_ENTRADA),2)
		//
		aDados[5]:=F3_ESTADO
		If (lMV_ESTCLI)
			aDados[5]:= (cArqTemp)->EST	
		EndIf

		aLinCont:= {}	//zera array devido a carga R931ImpGrade para impressao de conhecimento de frete
		If Empty(F3_DTCANC) .Or. lImprZero
			//Tratativa para imprimir conta contabil com tamanho maior que 20 sem quebrar a coluna do relatorio
			cContaFor := Alltrim(Substr(cContaContab,1,TamSX3("A1_CONTA")[1]))
			nTamCon := IIF(Valtype(cContaFor) == "C", Len(Alltrim(cContaFor)), 0) //checa a quantidade de caracteres da conta contabil
			If nTamCon > nMaxCol //verifica necessidade de tratativa para quebra de linha devido ao tamanho da conta contabil
				nMaxLin := Ceiling(nTamCon/nMaxCol) //qtd total de quebras de linhas
				aAdd(aLinCont,Substr(cContaFor,1,nMaxCol)) //limita o tamanho da conta contabil para impressao na primeira linha
				//Cria array para armazenar os dados da conta contabil por quebra de linha
				For nH:=2 to nMaxLin
					nIniPos :=(nMaxCol*nH)-21
					cQuebraCon := Substr(cContaFor,nIniPos,nMaxCol)
					If !Empty(cQuebraCon)
						aAdd(aLinCont,cQuebraCon) //alimenta o array das quebras da conta contabil por linha
					EndIf
				Next nH
			EndIf

			If lSaiAmb
				aDados[6]:=0
				aDados[7]:=Substr(EvalMacro(cContaContabil),1,20)
				aDados[8]:=If(substr(F3_CFO,1,3)$"999#000",,Transform(F3_CFO,cPesqCFO))																									  
				aDados[9]:=0
	          	If nModelo != 5		        
				    aDados[10]:=""
				EndIf
				aDados[11]:=0
				aDados[12]:=0
				aDados[13]:=0
			Else
				aDados[6]:=F3_VALCONT
				aDados[7]:=Alltrim(Substr(cContaContab,1,TamSX3("A1_CONTA")[1]))
				aDados[8]:=If(substr(F3_CFO,1,3)$"999#000",,Transform(F3_CFO,cPesqCFO))
				aDados[9]:=F3_BASEICM        
				If nModelo != 5
					aDados[10]:=Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),"")
				EndIf
				aDados[11]:=F3_VALICM
				aDados[12]:=F3_ISENICM
				aDados[13]:=F3_OUTRICM
				    If !Empty(F3_VLINCMG)
				        aDados[13] +=F3_VLINCMG
				    EndIf
	        EndIf
        Endif
		R932LoadObs()
		If Empty(cFilterUser).Or. (&cFilterUser)
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif
		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			If nLin>=nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Endif
		End


		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .And. F3_ICMSRET-F3_OBSSOL>0  .And. lProcST
			aDados[8]:="ST"
			aDados[9]:=F3_BASERET
			If nColuna == 1
				aDados[14]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[11]:=F3_ICMSRET-F3_OBSSOL
			ElseIf nColuna == 3
				If F3_TIPO == "D"
					aDados[11]:=F3_ICMSRET-F3_OBSSOL
				Else
					aDados[14]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			EndIF
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST  .And. F3_CREDST <> '4'
			aDados[8]:="ST"
			aDados[9]:=F3_BASERET
			If nModelo != 5
				aDados[10]:= Iif(lAliqstn,"",Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[11]:=F3_ICMSRET-F3_OBSSOL
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif
		//зддддддддддддддддд©
		//Ё Acumula valores Ё
		//юддддддддддддддддды
		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			For nI:=1 to Len(aLinCont)
				aDados[7] := aLinCont[nI]
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Next nI
		EndIf
		nLinNec:=nLin-nTamNota
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3,,,@aTotObs)
		dDiaAnt:=F3_ENTRADA
		dbSelectArea(cArqTemp)
		dbSkip()
		If !Eof()
			dDia:=F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf
		//зддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Totais e finaliza relatorio Ё
		//юддддддддддддддддддддддддддддддддддддды
		lHouveMov	:= .T.
		lImpTot		:= .T.		
		R932Totais(@nSvApurIcm,@nSvApurIpi)
	End

	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifico se a ultima nota eh cancelada para imprimir o Total Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If lHouveMov .And. 	!lImpTot
    	R932Totais(@nSvApurIcm,@nSvApurIpi)
	Endif
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Quando nao ha movimento                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lHouveMov .And. !lImpSemMov
		dDia:=dDtIni
		R932Cabec(dDia)
		cLinha:=FmtLin(Array(14),aL[19],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R932TermEnc()
	Endif
Else
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de Abertura    Ё
	//юдддддддддддддддддддддддддддддды
	R932TermIni()
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de EncerramentoЁ
	//юдддддддддддддддддддддддддддддды
	R932TermEnc()
EndIf
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932Cabec ЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Impressao de Cabecalho                                     Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
FUNCTION R932Cabec(dData,lImpDad)

Local lLFisOrd := aSX6[MV_LFISORD]
Local cTermoSAb := aSX6[MV_LSAIAB]
Local cTermoEAb	:= aSX6[MV_LENTAB]
Local cMvEstado := aSX6[MV_ESTADO]
If MV_PAR41 == 1 .And. !Empty(aSX6[MV_P2ABER]) .And. !Empty(aSX6[MV_P1ABER])
	cTermoSAb := aSX6[MV_P2ABER]
	cTermoEAb := aSX6[MV_P1ABER]
EndIf

dData	:= IIf(dData==NIL,dDiaAnt,dData)
lImpDad := Iif(lImpDad==Nil,.T.,lImpDad)

cPeriodo:=aMeses[Month(dData)]+" / "+Str(Year(dData),4)
//здддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime Termos de Abertura/EncerramentoЁ
//юдддддддддддддддддддддддддддддддддддддддды
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3) .and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
//здддддддддддддддддддд©
//Ё Imprime Cabecalho  Ё
//юдддддддддддддддддддды
nLin:=3
FmtLin(,AvalImp(nLargMax),,,@nLin)
FmtLin(,aL[1],,,@nLin)
FmtLin({cCabNumLiv},aL[2],,,@nLin)
FmtLin(,aL[3],,,@nLin)
FmtLin({cNome},aL[4],,,@nLin)
FmtLin(,aL[5],,,@nLin)
FmtLin({cInscr,cCGC},aL[6],,,@nLin)
FmtLin(,aL[7],,,@nLin)
If lLFisOrd .and. !(cMvEstado == "PE")
	FmtLin({cLivro,cPagina,cPeriodo},aL[8],,,@nLin)	
Else
	FmtLin({cPagina,cPeriodo},aL[8],,,@nLin)                                         
Endif
If lImpDad
	FmtLin(,{aL[9],aL[10],aL[11],aL[12],aL[13],aL[14],aL[15],aL[16]},,,@nLin)
	If nTipoMov==2
		FmtLin(,{aL[17],aL[18]},,,@nLin)
	Endif
Else                                                                             
	FmtLin(,{aL[9],aL[10],aL[11]},,,@nLin)
Endif
	
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932LayOutЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Layout dos modelos P1A e P2A                               Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932LayOut

Local nSubDiv	:= mv_par36
Local lLFisOrd	:= aSX6[MV_LFISORD]
Local lImp  	:= aSX6[MV_IMPCABE]
Local lImpPag  	:= aSX6[MV_IMPPAGI]
If nTipoMov==1
	aL:=Array(34)
	aL[01]:="+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPara atender a Legislacao de Pernambuco                        Ё
	//ЁO valor do ICMS ST nas entradas deve ser apresentado em coluna Ё
	//Ёespecifica - Contribuinte Substituido - ICMS na Fonte          Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If cMV_ESTADO == "PE"
		aL[02]:=STR0052 //"|                                                                REGISTRO DE ENTRADAS #                                                               |                  (*) CODIGO DE VALORES FISCAIS                     |"
		aL[03]:="|                                                                                                                                                     |--------------------------------------------------------------------|"
		aL[04]:=STR0053 //"| FIRMA: #############################                                                                                                                | 1  - OPERACOES COM CREDITO DO IMPOSTO                              |"
		aL[05]:=STR0054 //"|                                                                                                                                                     | 2  - OPERACOES SEM CREDITO DO IMPOSTO - ISENTAS OU NAO TRIBUTADAS  |"
		aL[06]:=STR0006 //"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                            |                                                                    |"
		aL[07]:=STR0056 //"|                                                                                                                                                     | ST - CONTRIBUINTE-SUBSTITUIDO - ICMS NA FONTE                      |"		
		aL[08]:=STR0057 //"| FOLHA: #######                   MES OU PERIODO/ANO: #######                                                                                        |                                                                    |" 
		aL[09]:=STR0058 //"|                                                                                                                                                     |                                                                    |"
		aL[10]:=STR0059
	Else
		If nSubDiv == 1
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
	    	If cMV_ESTADO == "SE"   
		   		aL[02]:=STR0073		//"|                                                           REGISTRO DE ENTRADAS - MODELO P1A                                                         |                  (*) CODIGO DE VALORES FISCAIS                     |"	
			Else 
				If lImp
					aL[02]:=STR0066 //"|                                                                REGISTRO DE ENTRADAS # - P1A                                                         |                  (*) CODIGO DE VALORES FISCAIS                     |"
	            Else
					aL[02]:=STR0003 //"|                                                                REGISTRO DE ENTRADAS #                                                               |                  (*) CODIGO DE VALORES FISCAIS                     |"
	            Endif
	    	EndIf 
	    	
		ElseIf nSubDiv == 2   
		    //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
	   		If cMV_ESTADO == "SE"   
		    	aL[02]:=STR0075		 //"|                                                   LIVRO REGISTRO DE ENTRADAS ESTADUAIS - MODELO P1A                                                 |                  (*) CODIGO DE VALORES FISCAIS                     |"
			Else 
				If lImp
					aL[02]:= STR0067 //"|                                                        LIVRO REGISTRO DE ENTRADAS ESTADUAIS # - P1A                                                 |                  (*) CODIGO DE VALORES FISCAIS                     |"
				Else
					aL[02]:= STR0060 //"|                                                        LIVRO REGISTRO DE ENTRADAS ESTADUAIS #                                                       |                  (*) CODIGO DE VALORES FISCAIS                     |"
			    Endif      
			EndIf
			
		ElseIf nSubDiv == 3    
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
			If cMV_ESTADO == "SE"   
		    	aL[02]:=STR0076 	//"|                                                 LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS - MODELO P1A                                              |                  (*) CODIGO DE VALORES FISCAIS                     |"
			Else
				If lImp
					aL[02]:=STR0068 //"|                                                      LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS # - P1A                                              |                  (*) CODIGO DE VALORES FISCAIS                     |"
				Else
			   		aL[02]:=STR0061 //"|                                                      LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS #                                                    |                  (*) CODIGO DE VALORES FISCAIS                     |"
			    Endif  
			EndIf 
		Endif
		aL[03]:="|                                                                                                                                                     |--------------------------------------------------------------------|"
		aL[04]:=STR0004 	//"| FIRMA: #############################                                                                                                                |                                                                    |"
		aL[05]:=STR0005 	//"|                                                                                                                                                     | 1 - OPERACOES COM CREDITO DO IMPOSTO                               |"
		aL[06]:=STR0006 	//"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                            |                                                                    |"
		aL[07]:=STR0007 	//"|                                                                                                                                                     | 2 - OPERACOES SEM CREDITO DO IMPOSTO - ISENTAS OU NAO TRIBUTADAS   |"
		If lLFisOrd
			aL[08]:=STR0079 //"| ORDEM/FOLHA: ###-E / #######     MйS OU PERмODO/ANO: #######                                                                                        |                                                                    |"
		ElseIf lImpPag
			aL[08]:=STR0080 //"| PаGINA: #######                    MES OU PERIODO/ANO: #######                                                                                      |                                                                    |"
		Else
			aL[08]:=STR0008 //"| FOLHA: #######                   MйS OU PERмODO/ANO: #######                                                                                        |                                                                    |"
		Endif
		aL[09]:=STR0009 	//"|                                                                                                                                                     | 3 - OPERACOES SEM CREDITO DO IMPOSTO - OUTRAS                      |"
		aL[10]:="|                                                                                                                                                     |                                                                    |"
	Endif
	aL[11]:="|==========================================================================================================================================================================================================================|"
	aL[12]:=STR0010 //"|          |             DOCUMENTOS FISCAIS                                 |                  |      CODIFICACAO          |    |              VALORES FISCAIS                  |                                          |"
	aL[13]:="|          |----------------------------------------------------------------|                  |---------------------------|    |-----------------------------------------------|                                          |"
	aL[14]:=STR0011 //"|DATA DE   |ESPE |  SERIE  |      |DATA      |CODIGO DO                | UF |                  |                    |      |ICMS|COD| BASE DE CALCULO  |     |      IMPOSTO     |                                          |"
	
	If ("SP"$cMV_ESTADO .OR. lCat21)
		aL[15]:=STR0050 //"|ENTRADA   |CIE  |SUB-SERIE|NUMERO|DOCUMENTO |EMITENTE                 |ORIG|  VALOR CONTABIL  |    CONTABIL        |FISCAL|    |(*)|VALOR DA OPERACAO |ALIQ.|     CREDITADO    |                       OBSERVACOES        |"
	Else
		aL[15]:=STR0012 //"|ENTRADA   |CIE  |SUB-SERIE|NUMERO|DOCUMENTO |EMITENTE                 |ORIG|  VALOR CONTABIL  |    CONTABIL        |FISCAL|IPI |(*)|VALOR DA OPERACAO |ALIQ.|     CREDITADO    |                       OBSERVACOES        |"
	EndIf
			 
    aL[16]:="|==========|=====+=========+=========+==========+======================+====|==================|====================+======|====|===+==================+=====+==================|==========================================|"
	aL[17]:="|##########|#####|   ###   |#########|##########|######################| ## |##################|####################| #### |####| # |##################|#####|##################|##########################################|"
	aL[18]:="|# # # #   |# #########################################################| ## |##################|####################| #### |####| # |##################|#####|##################|##########################################|"
	aL[19]:="+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	aL[20]:=STR0044 // "|                                                                                        DEMONSTRATIVO DE CREDITOS - PRODUTOR RURAL                                                                                        |" 
	aL[21]:="+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	aL[22]:="|                                                                                                                                                                                                                          |"
	aL[23]:=STR0045 // "|                                                                      I   - SALDO CREDOR TRANSPORTADO DO MES ANTERIOR           ####################                                                                      |"
	aL[24]:="|                                                                                                                                                                                                                          |"	
	aL[25]:=STR0046 // "|                                                                      II  - CREDITOS ESCRITURADOS NO MES                        ####################                                                                      |"
	aL[26]:="|                                                                                                                                                                                                                          |"
	aL[27]:=STR0047 // "|                                                                      III - CREDITOS UTILIZADOS NO PERIODO                      ####################                                                                      |"
	aL[28]:="|                                                                                                                                                                                                                          |"
	aL[29]:=STR0048 // "|                                                                      IV  - ESTORNOS DE CREDITOS EFETUADOS                      ####################                                                                      |" 
	aL[30]:="|                                                                                                                                                                                                                          |"
	aL[31]:="|                                                                                                                                                                                                                          |"
	aL[32]:=STR0049 // "|                                                                      V   - SALDO DO PERIODO (I + II) - (III + IV)              ####################                                                                      |"
	aL[33]:="|                                                                                                                                                                                                                          |"
	aL[34]:="+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
Else             
	aL:=Array(20)
	aL[01]:="+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	If nSubDiv == 1
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
  		If cMV_ESTADO == "SE"   
    		aL[02]:= STR0074 	 //"|                                                                                            REGISTRO DE SAмDAS - MODELO P2A                                                                                                 |"
		Else 		
			If lImp
				aL[02]:= STR0069 //"|                                                                                                     REGISTRO DE SAмDAS # - P2A                                                                                             |"
			Else
		   		aL[02]:= STR0013 //"|                                                                                                     REGISTRO DE SAмDAS #                                                                                                   |"
		    Endif 
		EndIf
		
	ElseIf nSubDiv == 2       
	
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
		If cMV_ESTADO == "SE"   
    		aL[02]:= STR0077 	 //"|                                                                                         LIVRO REGISTRO DE SAмDAS ESTADUAIS - MODELO P2A                                                                                    |"
	 	Else
			If lImp
				aL[02]:= STR0070 //"|                                                                                             LIVRO REGISTRO DE SAмDAS ESTADUAIS # - P2A                                                                                     |"
			Else
				aL[02]:= STR0063 //"|                                                                                             LIVRO REGISTRO DE SAмDAS ESTADUAIS #                                                                                           |"
		    Endif 
		EndIf
		
	ElseIf nSubDiv == 3   
	
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
		If cMV_ESTADO == "SE"   
    		aL[02]:= STR0078 	 //"|                                                                                    LIVRO REGISTRO DE SAмDAS INTERESTADUAIS - MODELO P2A                                                                                    |" 
	 	Else
			If lImp
				aL[02]:= STR0071 //"|                                                                                          LIVRO REGISTRO DE SAмDAS INTERESTADUAIS # - P2A                                                                                   |"
			Else
				aL[02]:= STR0064 //"|                                                                                          LIVRO REGISTRO DE SAмDAS INTERESTADUAIS #                                                                                         |"
	        Endif  
		EndIf 
		
	Endif
	aL[03]:="|                                                                                                                                                                                                                            |"
	aL[04]:=STR0014 			 //"| FIRMA: #########################                                                                                                                                                                                           |"
	aL[05]:="|                                                                                                                                                                                                                            |"
	aL[06]:=STR0015 			 //"| INSC.EST: #########             C.N.P.J.: ##############                                                                                                                                                                   |"
	aL[07]:="|                                                                                                                                                                                                                            |"
	If lLFisOrd
		aL[08]:=STR0062 		 //"| ORDEM/FOLHA: ###-E / #######     MйS OU PERмODO/ANO: #######                                                                                                                                                               |"
	ElseIf lImpPag
		aL[08]:=STR0072 		 //"| PаGINA: #######                    MйS OU PERмODO/ANO: #######                                                                                                                                                             |"
	Else
		aL[08]:=STR0016			 //"| FOLHA: #######                   MйS OU PERмODO/ANO: #######                                                                                                                                                               |"
	Endif
	aL[09]:="|                                                                                                                                                                                                                            |"
	aL[10]:="|                                                                                                                                                                                                                            |"
	aL[11]:="|============================================================================================================================================================================================================================|"
	aL[12]:="|             DOCUMENTOS FISCAIS                      |                  |     CODIFICAгцO           |                                 VALORES FISCAIS                                  |                                    |"  //STR0017 //"|             DOCUMENTOS FISCAIS                 |                  |      CODIFICACAO          |                                 VALORES FISCAIS                                 |                                        |"
	aL[13]:="|-----------------------------------------------------|                  |---------------------------|----------------------------------------------------------------------------------|                                    |"
	aL[14]:="|     |         |                            |   |    |                  |                    |      |      OPERAгуES COM DиBITO DO IMPOSTO      |   OPERAгуES SEM DиBITO DO IMPOSTO    |                                    |"  //STR0018 //"|     |     |                              |   |    |                  |                 |      |      OPERACOES COM DEBITO DO IMPOSTO      |   OPERACOES SEM DEBITO DO IMPOSTO   |                                        |"
	aL[15]:="|     |         |                            |   |    |                  |                    |      |-------------------------------------------|--------------------------------------|                                    |"  //STR0019 //"|     |SERIE|                              |   |    |                  |                 |      |-------------------------------------------|-------------------------------------|                                        |"
	aL[16]:="|ESPи |  SиRIE  |                            |   | UF |      VALOR       |                    |      |     BASE DE      |     |     IMPOSTO      |    ISENTAS OU     |                  |                                    |"  //STR0020 //"|ESPE | SUB-|                              |   | UF |      VALOR       |                 |      |     BASE DE      |     |     IMPOSTO      |    ISENTAS OU    |                  |                                        |"
	aL[17]:="|CIE  |SUB-SиRIE|         NзMERO             |DIA|DEST|     CONTаBIL     |   CONTаBIL         |FISCAL|     CALCULO      |ALIQ |     DEBITADO     |  NцO TRIBUTADAS   |      OUTRAS      |                OBSERVAгуES         |"  //STR0021 //"|CIE  |SERIE|          NUMERO              |DIA|DEST|     CONTABIL     |  CONTABIL       |FISCAL|     CALCULO      |ALIQ |     DEBITADO     |  NAO TRIBUTADAS  |      OUTRAS      |           OBSERVACOES                  |"
	aL[18]:="|=====+=========+============================+===+====|==================|====================+======|==================+=====+==================|===================+==================|====================================|"
	aL[19]:="|#####|#########|############################| ##| ## |##################|####################| #### |##################|#####|##################|###################|##################|####################################|"
	aL[20]:="|# #  |         |############################| ##| ## |##################|####################| #### |##################|#####|##################|###################|##################|####################################|"
Endif

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932TranspЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime linhas de transporte                               Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932Transp(lTotal)
Local aTamTransp := LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)
Local nTamTransp := Len(aTamTransp)+Max(Len(aGrade),3)+2

lTotal :=If(lTotal==Nil,.F.,lTotal)
If lTotal
	nTamTransp*=2
EndIf
nMaior:=0
AEval(aTamNotas,{|x|nMaior:=Max(nMaior,x)})
aTamNotas[2]:=nMaior

nLinNec:=aTamNotas[2]
lTransp := nLimPag<=nLin+nTamTransp

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se o TES И para comerciante nЦo contribuinte de IPI           Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды     
        
cChaveSD1 := aTransp[ColF3("F3_NFISCAL")]+aTransp[ColF3("F3_SERIE")]+aTransp[ColF3("F3_CLIEFOR")]+aTransp[ColF3("F3_LOJA")] 


If lTransp
	nTamTransp:=nLin
	If nTipoMov==1

		aObs:=aTamTransp//LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)

		R932IniGrade()

		aGrade[1,2]:=aTransp[ColF3("F3_BASEICM")]
		aGrade[1,3]:=aTransp[ColF3("F3_VALICM")]
		aGrade[2,2]:=aTransp[ColF3("F3_ISENICM")]
		aGrade[3,2]:=aTransp[ColF3("F3_OUTRICM")]
		    If !Empty(aTransp[ColF3("F3_VLINCMG")])
		        aGrade[3,2] += aTransp[ColF3("F3_VLINCMG")]
		    EndIf
		IF cMV_ESTADO != "SP" .OR. lCat21
			aGrade[4,2]:=aTransp[ColF3("F3_BASEIPI")]
			aGrade[4,3]:=aTransp[ColF3("F3_VALIPI")]
			aGrade[5,2]:=aTransp[ColF3("F3_ISENIPI")]
			aGrade[6,2]:=aTransp[ColF3("F3_OUTRIPI")]
	    ENDIF
		aDados:=ARRAY(16)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0022 //"A TRANSPORTAR"
		aDados[8]:=aTransp[ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R932ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GO Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and.aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[16]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[15]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTransp[ColF3("F3_TIPO")] == "D"
					aDados[15]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
				Else
					aDados[16]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			EndIf
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")] >0 .And. aTransp[ColF3("F3_CREDST")] <> '4'
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aTransp[ColF3("F3_BASERET")]
			aDados[15]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		nLinNec:=nLin-nTamTransp
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R932Filler()
		R932Cabec()
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTransp,,,lObsFecp)
		aDados:=ARRAY(14)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0022 //"A TRANSPORTAR"
		aDados[6]:=aTransp[ColF3("F3_VALCONT")]
		aDados[9]:=aTransp[ColF3("F3_BASEICM")]
		aDados[11]:=aTransp[ColF3("F3_VALICM")]
		aDados[12]:=aTransp[ColF3("F3_ISENICM")]
		aDados[13]:=aTransp[ColF3("F3_OUTRICM")]                           
		    If !Empty(aTransp[ColF3("F3_VLINCMG")])
		        aDados[13] += aTransp[ColF3("F3_VLINCMG")]
		    EndIf                               
		R932LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			aDados[9]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[14]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[11]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTransp[ColF3("F3_TIPO")] == "D"
					aDados[11]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
				Else
					aDados[14]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			EndIf
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0  .And. aTransp[ColF3("F3_CREDST")] <> '4'
			aDados[8]:="ST"
			aDados[9]:=aTransp[ColF3("F3_BASERET")]
			aDados[11]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif

		nLinNec:=nLin-nTamTransp
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R932Filler()
		R932Cabec()
	Endif
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932TotdiaЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do dia                                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932TotDia
Local nX := 0
Local lP1IcmST:= aSX6[MV_P1ICMST]
lTotDia:=(dDiaAnt!=dDia)


If lTotDia .And. !Empty(dDia)
	aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	nLinNec:=aTamNotas[3]	

	If nLimPag<=nLin+((nLinNec+1)*2)
		R932Transp(.T.)
	Endif

	nTamTotDia:=nLin
	If nTipoMov==1

		aObs:=LivrArrayObs(nLargObs,aTotDia,,,lObsFecp)

		R932IniGrade()
		
		
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Monta array com valores de ICMS        Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		aGrade[1,2]:=aTotDia[ColF3("F3_BASEICM")]
		aGrade[1,3]:=aTotDia[ColF3("F3_VALICM")]
		aGrade[2,2]:=aTotDia[ColF3("F3_ISENICM")]
		aGrade[3,2]:=aTotDia[ColF3("F3_OUTRICM")]                          
		    If !Empty(aTotDia[ColF3("F3_VLINCMG")])
		        aGrade[3,2] += aTotDia[ColF3("F3_VLINCMG")]
		    EndIf                               
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Monta array com valores de IPI         Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		IF cMV_ESTADO != "SP" .OR. lCat21
            aGrade[4,2]:=aTotDia[ColF3("F3_BASEIPI")]
			aGrade[4,3]:=aTotDia[ColF3("F3_VALIPI")]
			aGrade[5,2]:=aTotDia[ColF3("F3_ISENIPI")]
			aGrade[6,2]:=aTotDia[ColF3("F3_OUTRIPI")]
	    ENDIF
		aDados:=ARRAY(16)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0023+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "
		aDados[8]:=aTotDia[ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R932ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[16]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[15]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTotDia[ColF3("F3_TIPO")] == "D"
					aDados[15]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
				Else
					aDados[16]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			If (lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")]>0)
				aDados[13]:=aTotDia[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[15]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[13]:=aTotDia[ColF3("F3_BASERET")]			
				aDados[15]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
		nLinNec:=nLin-nTamTotDia
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTotDia,,,lObsFecp)
		aDados:=ARRAY(14)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0023+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "
		aDados[6]:=aTotDia[ColF3("F3_VALCONT")]
		aDados[9]:=aTotDia[ColF3("F3_BASEICM")]
		aDados[11]:=aTotDia[ColF3("F3_VALICM")]
		aDados[12]:=aTotDia[ColF3("F3_ISENICM")]
		aDados[13]:=aTotDia[ColF3("F3_OUTRICM")]                              
		    If !Empty(aTotDia[ColF3("F3_VLINCMG")])
		        aDados[13] += aTotDia[ColF3("F3_VLINCMG")]
		    EndIf                               
		R932LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			aDados[9]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[14]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[11]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTotDia[ColF3("F3_TIPO")] == "D"
					aDados[11]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
				Else
					aDados[14]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			If (lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")]>0)
				aDados[9]:=aTotDia[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[11]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[9]:=aTotDia[ColF3("F3_BASERET")]
				aDados[11]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
		nLinNec:=nLin-nTamTotDia
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Endif
Endif
If nLimPag<=nLin+nLinNec
	R932Transp()
Endif
If lTotDia
	For nX := 1 to Len(aTotDia)
	Do Case
		Case ValType(aTotDia[nX]) == "C"
			aTotDia[nX] := ""
		Case ValType(aTotDia[nX]) == "N"
			aTotDia[nX] := 0
		OtherWise
			aTotDia[nX] := Nil				
		End Case
	Next nX		
Endif   

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932TotMesЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do Mes                                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932TotMes
Local xx 		:= 1
Local nPosicao 	:= 0    
Local nProcFil	:= mv_par31
Local cFilDe	:= mv_par32
Local cFilAte	:= mv_par33
Local aArea		:= GetArea()
Local aAreaSm0 	:= SM0->(GetArea())
Local lP1IcmST		:= aSX6[MV_P1ICMST]

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se o processamento e centralizado, imprimindo mais de uma filialЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nProcFil <> 1
	cFilDe 	:= cFilAnt
	cFilAte	:= cFilAnt
Endif      

SM0->(MSSeek(cEmpAnt+cFilDe,.T.))

//********************* CIAP **********************
If lEmiteCiap
	nPosicao := ColF3("F3_VALICM") //Ascan((cArqTemp)->(dbstruct()),{ |x| ( "F3_VALICM" $ x[1] ) })
	if nTipoMov==1 .and. lTotMes
		If nLin>=nLimPag.and.lImpMes
			R932Transp()
		Endif

		dData := LASTDAY(DDIAANT)
		SFA->(dbSetOrder(2))

        //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
        //ЁImprime atraves das filiais selecionadas para o processamentoЁ
        //юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
        Do While !SM0->(Eof()) .And. SM0->M0_CODIGO+SM0->M0_CODFIL <= cEmpAnt+cFilAte

			cFilAnt	:= SM0->M0_CODFIL
		
			If SFA->(MSSeek(xFilial("SFA")+dTos( dData )))
				While SFA->(!EOF()) .and. SFA->FA_FILIAL == xFilial("SFA") .and. Dtos(SFA->FA_DATA)== dTos(ddata)
					If ( SFA->FA_TIPO == "1" ) .and. (SFA->FA_CREDIT =="1")
						cMensagem:=Trim("Credito de ICMS relativo a entrada de Bem do Ativo ")+If(lColCiap,PADL(Transform(SFA->FA_VALOR,"@E 9,999,999.99"),58),"")
						For xx:=1 to MlCount(cMensagem,nLargObs)
							AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
						Next xx
	
						SF9->(MSSeek(xFilial()+SFA->FA_CODIGO))
						R932IniGrade()
						aGrade[1,1]:="1"
						If !lColCiap
							aGrade[1,3]:=SFA->FA_VALOR
						Endif
						nCredAtivo  +=SFA->FA_VALOR
	
						aDados:=Array(18)		
						If nLin>=nLimPag
							R932Filler()
							R932Cabec()
						EndIf
						FmtLin(@aDados,aL[18],,,@nLin)
						aDados[10]	:= SF9->F9_CFOENT
						R932ImpGrade()
						nPosObs:=Ascan(aObs,{|x|x[2]})
						While nPosObs>0
							R932LoadObs()
							If nPosObs>0
								If nLin>=nLimPag
									R932Filler()
									R932Cabec()
								EndIf
								FmtLin(@aDados,aL[17],cPictVl,,@nLin)
							Endif
						Enddo
					EndIf				
					SFA->(dBSkip())
				EndDo
			Endif	
			SM0->(dbSkip())
		Enddo
		aTotMes[nPosicao] +=nCredAtivo
	EndIf
Endif
//******************* CIAP FIM *********************
If lTotMes.and.lImpMes

	If nLin>=nLimPag.and.lImpMes
		R932Transp()
	Endif


	If nTipoMov==1

		aObs:=LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)

		R932IniGrade()

		aGrade[1,2]:=aTotMes[ColF3("F3_BASEICM")]
		aGrade[1,3]:=aTotMes[ColF3("F3_VALICM")]
		aGrade[2,2]:=aTotMes[ColF3("F3_ISENICM")]
		aGrade[3,2]:=aTotMes[ColF3("F3_OUTRICM")]                           
		    If !Empty(aTotMes[ColF3("F3_VLINCMG")])
		        aGrade[3,2] += aTotMes[ColF3("F3_VLINCMG")]
		    EndIf                              
		IF cMV_ESTADO != "SP" .OR. lCat21
            aGrade[4,2]:=aTotMes[ColF3("F3_BASEIPI")]
			aGrade[4,3]:=aTotMes[ColF3("F3_VALIPI")]
			aGrade[5,2]:=aTotMes[ColF3("F3_ISENIPI")]
			aGrade[6,2]:=aTotMes[ColF3("F3_OUTRIPI")]
	    ENDIF
		aDados:=ARRAY(16)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0024 //"TOTAL DO MES"
		aDados[8]:=aTotMes[ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R932ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and.aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aTotMes[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[16]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTotMes[ColF3("F3_TIPO")] == "D"
					aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				Else
					aDados[16]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			If (lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")]>0)
				aDados[13]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[13]:=aTotMes[ColF3("F3_BASERET")]
				aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTotMes,,,lObsFecp)
		aDados:=ARRAY(14)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0024 //"TOTAL DO MES"
		aDados[6]:=aTotMes[ColF3("F3_VALCONT")]
		aDados[9]:=aTotMes[ColF3("F3_BASEICM")]
		aDados[11]:=aTotMes[ColF3("F3_VALICM")]
		aDados[12]:=aTotMes[ColF3("F3_ISENICM")]
		aDados[13]:=aTotMes[ColF3("F3_OUTRICM")]                              
		    If !Empty(aTotMes[ColF3("F3_VLINCMG")])
		        aDados[13] += aTotMes[ColF3("F3_VLINCMG")]
		    EndIf                              
		R932LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GO Ё
		//юддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			aDados[9]:=aTotMes[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[14]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[11]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aTotMes[ColF3("F3_TIPO")] == "D"
					aDados[11]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				Else
					aDados[14]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif			
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			If lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0
				aDados[9]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
				aDados[11]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
			Else
				aDados[9]:=aTotMes[ColF3("F3_BASERET")]
				aDados[11]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
	Endif
	If !Eof()
		R932Filler()
	Endif
	
	For xx := 1 to Len(aTransp)
		If ValType(aTransp[xx]) == "N"
			aTransp[xx] := 0
		Else
			aTransp[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTotMes)
		If ValType(aTotMes[xx]) == "N"
			aTotMes[xx] := 0
		Else
			aTotMes[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTamNotas)
		If ValType(aTamNotas[xx]) == "N"
			aTamNotas[xx] := 0
		Else
			aTamNotas[xx] := "NULL"
		Endif
	Next
	
Endif    

//здддддддддддддддддддддддддддддддддд©
//ЁRestaura a filial e area corrente Ё
//юдддддддддддддддддддддддддддддддддды
RestArea(aAreaSm0)
cFilAnt	:= SM0->M0_CODFIL
RestArea(aArea)

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932TotPerЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do periodo de apuracao                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932TotPer(nSvApurIcm,nSvApurIpi)
Local nCntFor	:=1
Local nX		:=0
Local lContZer	:= .F. 
Local cChave3	:= ""
Local lP1IcmST		:= aSX6[MV_P1ICMST]
nLinNec2:=0

If lTotPerICM
	aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[4]
Endif
If lTotPerIPI
	aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[5]
Endif

If lTotPerICM.or.lTotPerIPI
	nLinNec:=nLinNec2	

	If nLimPag<=nLin+nLinNec
		R932Transp()
	Endif

	If nTipoMov==1

		aObs:={}

		R932IniGrade()

		If lTotPerICM
			aObs:=LivrArrayObs(nLargObs,aTotPerICM,,,lObsFecp)
			aGrade[1,2]:=aTotPerICM[ColF3("F3_BASEICM")]
			aGrade[1,3]:=aTotPerICM[ColF3("F3_VALICM")]
			aGrade[2,2]:=aTotPerICM[ColF3("F3_ISENICM")]
			aGrade[3,2]:=aTotPerICM[ColF3("F3_OUTRICM")]                              
			    If !Empty(aTotPerICM[ColF3("F3_VLINCMG")])
			        aGrade[3,2] += aTotPerICM[ColF3("F3_VLINCMG")]
			    EndIf                               
		Endif
		If lTotPerIPI
			IF cMV_ESTADO != "SP" .OR. lCat21
                aGrade[4,2]:=aTotPerIPI[ColF3("F3_BASEIPI")]
	     	    aGrade[4,3]:=aTotPerIPI[ColF3("F3_VALIPI")]
			    aGrade[5,2]:=aTotPerIPI[ColF3("F3_ISENIPI")]
			    aGrade[6,2]:=aTotPerIPI[ColF3("F3_OUTRIPI")]
			ENDIF
		Endif
		aDados:=ARRAY(16)
		nTamTotPer:=nLin

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		cICM:="ICMS"
		cIPI:="IPI"
		nVlContICM:=aTotPerICM[ColF3("F3_VALCONT")]
		nVlContIPI:=aTotPerIPI[ColF3("F3_VALCONT")]

		lImprime:=.F.
		For nx:=1 to Len(aGrade)
			If !lImpZer.and.(aGrade[nx,2]+aGrade[nx,3])==0
				Loop
			Endif
			If nx<=3.and.!Empty(cICM)
				aDados[6]:=STR0025 //"TOTAL DO PERIODO "
				aDados[8]:=nVlContICM
				aDados[11]:=cICM
				cICM:=NIL
				lImprime:=.T.
			Endif
			If nx>3.and.!Empty(cIPI)
				aDados[6]:=STR0025 //"TOTAL DO PERIODO "
				aDados[8]:=nVlContIPI
				aDados[11]:=cIPI
				cIPI:=NIL
				lImprime:=.T.
			Endif 
		cChave3 := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
		SD1->(dbSetOrder(1))
		SF4->(dbSetOrder(1))
		If SD1->(MSSeek(xFilial("SD1")+cChave3))
		If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
			If aTotPerICM[ColF3("F3_VALCONT")] > 0 .And. aTotPerICM[ColF3("F3_BASEICM")] <= 0 .And. SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z"
				aDados[12]:= "2"
				lContZer := .T.
			Endif
		Endif
		Else
				aDados[12]:=aGrade[nx,1]
		EndIf
			aDados[13]:=aGrade[nx,2]
			aDados[15]:=If(aGrade[nx,3]>0,aGrade[nx,3],NIL)			
			//зддддддддддддддддддддддд©
			//Ё Coluna de Observacoes Ё
			//юддддддддддддддддддддддды
			If lImprime
				R932LoadObs()
				If !lIcmIpZer .and. ((aGrade[nx,2]+aGrade[nx,3])==0)
					aDados[11]:= NIL
					aDados[15]:= NIL
					aDados[12]:= NIL
					aDados[13]:= NIL
					aDados[14]:= NIL
					aDados[16]:= NIL
					FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				Else
					If aDados[12] == "2" .And. lImpZer .And. lContZer .And. SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z"
						FmtLin({,,,,,,,,,,,"1",,,,},If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
						FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
						FmtLin({,,,,,,,,,,,"3",,,,},If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
						Exit
					Else
						FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
					EndIf
				EndIf
			Endif
		Next nx

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0.and.lTotPerICM
			R932LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End

		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If lTotPerICM
			If !Empty(cTitLivro) .and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ICMS"
				aDados[12]:="ST"
				aDados[13]:=aTotMes[ColF3("F3_BASERET")]
				If nColuna == 1
					aDados[16]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
					If aTotMes[ColF3("F3_TIPO")] == "D"
						aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
					Else
						aDados[16]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
					Endif
				EndIf
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ICMS"
				aDados[12]:="ST"
				If (lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0)
					aDados[13]:=aTotMes[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
					aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
				Else
					aDados[13]:=aTotMes[ColF3("F3_BASERET")]
					aDados[15]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				Endif
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		Endif
		If lTotPerICM
			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
		If lTotPerIPI
			nLinNec:=nLin-nTamTotPer
			aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lTotPerIcm
			nTamTotPer:=nLin
			aObs:=LivrArrayObs(nLargObs,aTotPerICM,,,lObsFecp)
			aDados:=ARRAY(14)
			aDados[3]:=STR0026 //"TOTAL DO PERIODO"
			aDados[6]:=aTotPerICM[ColF3("F3_VALCONT")]
			aDados[9]:=aTotPerICM[ColF3("F3_BASEICM")]
			aDados[11]:=aTotPerICM[ColF3("F3_VALICM")]
			aDados[12]:=aTotPerICM[ColF3("F3_ISENICM")]
			aDados[13]:=aTotPerICM[ColF3("F3_OUTRICM")]                          
                If !Empty(aTotPerICM[ColF3("F3_VLINCMG")])
                    aDados[13] += aTotPerICM[ColF3("F3_VLINCMG")]
                EndIf                              
			R932LoadObs()
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)

			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R932LoadObs()
				If nPosObs>0
					FmtLin(@aDados,aL[20],cPictVl,,@nLin)
				Endif
			End
			//здддддддддддддддддддддддддддддддддд©
			//Ё Atender legislacao Fomentar de GOЁ
			//юдддддддддддддддддддддддддддддддддды
			If !Empty(cTitLivro) .and. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[8]:="ST"
				aDados[9]:=aTotPerICM[ColF3("F3_BASERET")]
				If nColuna == 1
					aDados[14]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[11]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
					If aTotPerICM[ColF3("F3_TIPO")] == "D"
						aDados[11]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
					Else
						aDados[14]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
					Endif
				EndIf
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[8]:="ST"
				If (lP1IcmST .And. aTotObs[ColF3("F3_ICMSRET")] > 0)
					aDados[9]:=aTotPerICM[ColF3("F3_BASERET")]-aTotObs[ColF3("F3_BASERET")]
					aDados[11]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]-aTotObs[ColF3("F3_ICMSRET")]
				Else
					aDados[9]:=aTotPerICM[ColF3("F3_BASERET")]
					aDados[11]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				Endif
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			EndIf
			FmtLin(@aDados,aL[20],,,@nLin)

			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
	Endif
	If lTotPerICM.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerICM)
			If ValType(aTransp[nCntFor]) == "N"
				aTotPerICM[nCntFor] := 0
			Else
				aTotPerICM[nCntFor] := "NULL"
			Endif
		Next
		nSvApurICM:=DefPeriodo(dDia,nApurICM)
	Endif
	If lTotPerIPI.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerIPI)
			If ValType(aTotPerIPI[nCntFor]) == "N"
				aTotPerIPI[nCntFor] := 0
			Else
				aTotPerIPI[nCntFor] := "NULL"
			Endif
		Next
		nSvApurIPI:=DefPeriodo(dDia,nApurIPI)
	Endif
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932ResCfoЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Resumo por CFO                                             Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932ResCfo
Local i	:=0
Local cChave3	:= ""

If (Len(aResCFO)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)) .And. !Eof()
   If nLin<nLimPag
      R932Filler()
   Endif
   Return
Endif

//здддддддддддд©
//Ё Ordena CFOsЁ
//юдддддддддддды
aResCFO:=Asort(aResCFO,,,{|x,y|x[ColF3("F3_CFO")]<y[ColF3("F3_CFO")]})

aCFOS:={STR0027,; //"1.00 ENTRADAS DO ESTADO"
	STR0028,; //"2.00 ENTRADAS DE FORA DO ESTADO"
	STR0029,; //"3.00 ENTRADAS DO EXTERIOR"
	"",;
	STR0030,; //"5.00 SAIDAS PARA O ESTADO"
	STR0031,; //"6.00 SAIDAS PARA FORA DO ESTADO"
	STR0032} //"7.00 SAIDAS PARA O EXTERIOR"

cSvCFO:="X"
If nLin<nLimPag
	R932Filler()
Endif
nLin:=80
For i:=1 to Len(aResCFO)
	If nLin>nLimPag
		R932Cabec()
	EndIf
	cCFO:=Trim(aResCFO[i,ColF3("F3_CFO")])
	aObs:=LivrArrayObs(nLargObs,aResCFO[i],,cCFO,lObsFecp)
	
	If nTipoMov==1

		If i==1
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=STR0033 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL"
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:="==================================================="
			FmtLin(@aDados,aL[18],,,@nLin)
		EndIf

		R932IniGrade()
		aGrade[1,2]:=aResCFO[i,ColF3("F3_BASEICM")]
		aGrade[1,3]:=aResCFO[i,ColF3("F3_VALICM")]
		aGrade[2,2]:=aResCFO[i,ColF3("F3_ISENICM")]
		aGrade[3,2]:=aResCFO[i,ColF3("F3_OUTRICM")]                
	    	If !Empty(aResCFO[i,ColF3("F3_VLINCMG")])
		        aGrade[3,2] += aResCFO[i,ColF3("F3_VLINCMG")]
		EndIf
		// Tratamento do campo F3_VALCONT, deverА ser somado apenas se o campo F4_LFICM for ICM Zerado
		cChave3 := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
		SD1->(dbSetOrder(1))
		SF4->(dbSetOrder(1))
		If SD1->(MSSeek(xFilial("SD1")+cChave3))
			If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
				If SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z"
					aGrade[1,4]:=aResCFO[i,ColF3("F3_VALCONT")]
				Endif
			Endif
		Endif
		//
		IF cMV_ESTADO != "SP" .OR. lCat21
			aGrade[4,2]:=aResCFO[i,ColF3("F3_BASEIPI")]
			aGrade[4,3]:=aResCFO[i,ColF3("F3_VALIPI")]
			aGrade[5,2]:=aResCFO[i,ColF3("F3_ISENIPI")]
			aGrade[6,2]:=aResCFO[i,ColF3("F3_OUTRIPI")]
		ENDIF
		aDados:=ARRAY(16)
		If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)$"TTT") .And. !Empty (cCfo)
			If (nLin+3)>nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			FmtLin(@aDados,aL[18],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[6]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])			
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))			
			FmtLin(@aDados,aL[18],,,@nLin)
		Endif
		If ("TT"$cCFO)
			If (nLin+1)>nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=If(ALLTRIM(cCFO)=="TTT",STR0034,STR0035) //"TOTAL"###"SUB-TOTAL"
		Else
			aDados[10]:=TransForm(cCFO,cPesqCFO)
		Endif
		aDados[8]:=aResCFO[i,ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R932ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				If (nLin+1)>nLimPag
					R932Filler()
					R932Cabec()
				EndIf
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aResCFO[i,ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[16]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[15]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aResCFO[i,ColF3("F3_TIPO")] == "D"
					aDados[15]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
				Else
					aDados[16]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIF (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ICMS"
			aDados[12]:="ST"
			aDados[13]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[15]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
	Else
		//зддддддддддддддддддддддддддддддддддддддд©
		//ЁControla a impressao de CFO's de Saida.Ё
		//юддддддддддддддддддддддддддддддддддддддды
		If Val(Substr(cCFO,1,1))<5 .AND. !(ALLTRIM(cCFO)=="TTT")
			Loop
		Endif
		If i==1
			If mv_par27 == 1 .And. nTotIcmDeb > 0
				FmtLin(@aDados,aL[20],,,@nLin)
				aDados[14]:= STR0041+Transform(nTotIcmDeb,cPesqICMRET) //"ICMS A SER DEBITADO: "
				FmtLin(@aDados,aL[20],,,@nLin)
			Endif
			
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=STR0033 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL"
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:="==================================================="
			FmtLin(@aDados,aL[20],,,@nLin)
		EndIf
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aDados:=ARRAY(14)

		If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)=="TTT")
			If (nLin+3)>nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			FmtLin(@aDados,aL[20],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[3]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])			
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		If ("TT"$cCFO)
			If (nLin+1)>nLimPag
				R932Filler()
				R932Cabec()
			EndIf
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=If(ALLTRIM(cCFO)=="TTT",STR0034,STR0035) //"TOTAL"###"SUB-TOTAL"
		Else
			aDados[8]:=TransForm(cCFO,cPesqCFO)
		Endif
		aDados[6]:=aResCFO[i,ColF3("F3_VALCONT")]
		aDados[9]:=aResCFO[i,ColF3("F3_BASEICM")]
		aDados[11]:=aResCFO[i,ColF3("F3_VALICM")]
		aDados[12]:=aResCFO[i,ColF3("F3_ISENICM")]
		aDados[13]:=aResCFO[i,ColF3("F3_OUTRICM")]                            
	    	If !Empty(aResCFO[i,ColF3("F3_VLINCMG")])
		        aDados[13] += aResCFO[i,ColF3("F3_VLINCMG")]
		EndIf		
		R932LoadObs()
		If (nLin+1)>nLimPag
			R932Filler()
			R932Cabec()
		EndIf
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R932LoadObs()
			If nPosObs>0
				If (nLin+1)>nLimPag
					R932Filler()
					R932Cabec()
				EndIf
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		If (nLin+1)>nLimPag
			R932Filler()
			R932Cabec()
		EndIf
		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			aDados[9]:=aResCFO[i,ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[14]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[11]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
				If aResCFO[i,ColF3("F3_TIPO")] == "D"
					aDados[11]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
				Else
					aDados[14]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],cPesqICMRET)) //"ICMS RETIDO: "
				Endif
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[8]:="ST"
			aDados[9]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[11]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
	Endif
	//зддддддддддддддддддддддддддддддддд©
	//Ё Completa preenchimento da folha Ё
	//юддддддддддддддддддддддддддддддддды
	If i==Len(aResCFO)
		If nTipoMov==1
			FmtLin(@aDados,aL[18],,,@nLin)
		Else
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		aResCfo:={}
		R932Filler()
	ElseIf nLin+nLinNec>nLimPag
		R932Filler()
	Endif
Next i

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932ResEstЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠ 
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Resumo por Estado                                          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932ResEst

Local lFirstCO:=.T.
Local lFirstNC:=.T.
Local nTotvlrctb:=0
Local nTotvlrbsc:=0
Local nTotimpdeb	:=0
Local nTotisenta	:=0
Local nTotoutras	:=0
Local nTotIcmCre	:=0
Local nTotIPICre	:=0
Local nTotBasIPI	:=0
Local i				:=0
Local j				:=0
Local lAntiICM		:= aSX6[MV_ESTADO]=="SP"
Local cChares		:= ""
Local lGrade		:= .F.

If (Len(aResumo)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)) .And. !Eof()
   Return
Endif

nLin:=80
//здддддддддддддддддддддддддддддддддддддддддд©
//Ё Arranja o resumo em ordem de CFO e EstadoЁ
//юдддддддддддддддддддддддддддддддддддддддддды
aResumo:=ASort(aResumo,,,{|x,y|x[1]+x[2]<y[1]+y[2]})
For i:=1 to Len(aResumo)
	If nLin>nLimPag
   		If nLin<>80
   			FmtLin({},aL[01],,,@nLin)
   		EndIf
		R932Cabec()
	Endif
	If nTipoMov==1
	   aDados:=ARRAY(17)
	   //здддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	   //ЁVerifica se deve listar ou nao o estado origem no resumoЁ
	   //юдддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	   If (lLisEstOri.Or.(!lLisEstOri.And.cMV_Estado!=aResumo[i,2]))
		  If i==1
			 FmtLin(@aDados,aL[17],,,@nLin)
			 aDados[8]:=STR0036 //"DEMONSTRATIVO POR ESTADO DE ORIGEM DA MERCADORIA OU DE INICIO DA PRESTACAO DE SERVICO"
			 FmtLin(@aDados,aL[17],,,@nLin)
			 aDados[8]:="====================================================================================="
			 FmtLin(@aDados,aL[17],,,@nLin)
			 FmtLin(@aDados,aL[17],,,@nLin)
		  Endif
		  aGrade:={}
          
          If mv_par26 == 1
 		     If aResumo[i,4]>0 //Base de Calculo
			    AADD(aGrade,{"1",aResumo[i,4]})
			 Endif
			 
			cChares := SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA 
			SD1->(dbSetOrder(1))
			SF4->(dbSetOrder(1))
			If SD1->(MSSeek(xFilial("SD1")+cChares))
			If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))			 
				If (aResumo[i,7]>0 .And. lLisIsenta) .Or. (aResumo[i,3]>0 .And. aResumo[i,4]<=0 .And. (SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z")) //ICMS Isentas / ICMS Zerado
			    	AADD(aGrade,{"2",aResumo[i,7]})
			    	lGrade := .T.
			 	Else
					If (aResumo[i,7]>0 .And. lLisIsenta) //ICMS Isentas
			    		AADD(aGrade,{"2",aResumo[i,7]})
			    		lGrade := .T.
					EndIf
				Endif
			EndIf
			Else									
		   		If (aResumo[i,7]>0 .And. lLisIsenta) //ICMS Isentas
		    		AADD(aGrade,{"2",aResumo[i,7]})
		    		lGrade := .T.
				EndIf
			EndIf				
			
			 If aResumo[i,5]>0 //ICMS Outras
			    AADD(aGrade,{"3",aResumo[i,5]})
			    lGrade := .T.
 			 EndIf
 	        If aResumo[i,18]>0 //ReduГЦo de Base - D.L.43.080
			    AADD(aGrade,{"3",aResumo[i,5] + aResumo[i,18]})
			    lGrade := .T.		
			 Endif			   
 	        If aResumo[i,19]>0 //Incentivo a prod.leite-MG
			   AADD(aGrade,{"3",aResumo[i,5] + aResumo[i,19]})
			   lGrade := .T.			   
			 Endif			   
			 aDados[7]:=aResumo[i,2]  // Estado
			 aDados[8]:=aResumo[i,3]  //Valor Contabil
			 If lGrade
			 aDados[11]:="ICMS"
			 EndIf
             If aResumo[i,8]>0          		//Valor Icms
			    aDados[15] :=aResumo[i,8]
             EndIf
             
             If nModelo == 1
                If aResumo[i,9]>0 				// Base de Calculo IPI
				   aDados[16] :=aResumo[i,9]
			    Endif
			 Endif   
		  Else
 		     If aResumo[i,4]>0 //Base de Calculo
			    AADD(aGrade,{"1",aResumo[i,4]})
			 Endif
		cChares := SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA 
		SD1->(dbSetOrder(1))
		SF4->(dbSetOrder(1))
		If SD1->(MSSeek(xFilial("SD1")+cChares))
			If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
				If (aResumo[i,7]>0 .And. lLisIsenta) .Or. (aResumo[i,3]>0 .And. aResumo[i,4]<=0 .And. (SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z")) //ICMS Isentas / ICMS Zerado
				   	AADD(aGrade,{"2",aResumo[i,7]})
				Else
				If (aResumo[i,7]>0 .And. lLisIsenta) //ICMS Isentas
			    	AADD(aGrade,{"2",aResumo[i,7]})
				EndIf
				Endif
			EndIf
		Else									
		   	If (aResumo[i,7]>0 .And. lLisIsenta) //ICMS Isentas
		    	AADD(aGrade,{"2",aResumo[i,7]})
			EndIf
		EndIf
		
			 If aResumo[i,5]>0 //ICMS Outras
			    AADD(aGrade,{"3",aResumo[i,5]})
			 EndIf
			 If aResumo[i,18]>0 //ReduГЦo de Base de Calculo DL43080
			    AADD(aGrade,{"3",aResumo[i,5] + aResumo[i,18]})
	        EndIf
			 If aResumo[i,19]>0 //Valor incentivo a prod.leite-MG 
			    AADD(aGrade,{"3",aResumo[i,5] + aResumo[i,19]})
	        EndIf
			 aDados[7]:=aResumo[i,2]  // Estado
			 aDados[8]:=aResumo[i,3]  //Valor Contabil
			 aDados[11]:="ICMS"
		  Endif
			   
		  If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS Retido
			 aDados[16]:=STR0037+Alltrim(Transform(aResumo[i,6],cPesqICMRET))
		  Endif         
			
		  //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддX©
          //Ёcriar totalizador de resumo por estado. quando o parametro  mv_par24 for sim Ё
          //юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддXы

		  If MV_PAR25 == 1                
     		 nTotvlrctb:= nTotvlrctb + aResumo[i,3] //Valor Contabil
     		 
		     If aResumo[i,4]>0 //Base de Calculo
			 	nTotvlrbsc +=	aResumo[i,4]
		   	 Endif
             If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  nTotvlrbsc +=	aResumo[i,7]
             EndIf
             If aResumo[i,5]>0 //ICMS Outras
			 	 nTotvlrbsc +=	aResumo[i,5]
		     Endif
            If aResumo[i,18]>0 //ReduГЦo de Base de Calculo DL.43080
	    		 nTotvlrbsc +=	aResumo[i,18]
            EndIf
            If aResumo[i,19]>0 //Valor incentivo a prod.leite-MG
	    		 nTotvlrbsc +=	aResumo[i,19]
            EndIf
	    	 If mv_par26 == 1
			    nTotIcmCre	+=aResumo[i,08] //Total Icm Creditado
			    nTotIPICre	+=aResumo[i,10] //Total Ipi Creditado
			    nTotBasIPI	+=aResumo[i,09] //Base de Calculo IPI
	    	 Endif
	 	  Endif 
		  
		  if Len(aGrade)>0
			 For j:=1 to Len(aGrade)
				 aDados[12]:=aGrade[j,1]
				 aDados[13]:=aGrade[j,2]
				 FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			 Next j
		  Else
			 FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		  EndIf	
		  If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
			  aDados[16]:=STR0042+Alltrim(Transform(aResumo[i,13],cPesqOBSI))
			  FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		  Endif			
		  If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
			  If lAntiICM
				  aDados[16]:=STR0043+Alltrim(Transform((aResumo[i,14]-aResumo[i,17]),cPesqOBSS))
			  Else
				  aDados[16]:=STR0043+Alltrim(Transform(aResumo[i,14],cPesqOBSS))			  			  
			  Endif
			  FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		  EndIf	
		  If aResumo[i,15]>0 .and. (nColuna == 1 .Or. nColuna == 3)  //CRED. PRES. ST
			aDados[16]:=STR0051+Alltrim (Transform (aResumo[i,15], cPesqCRPR))
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		  Endif
	   Endif
	Else
	   aDados:=ARRAY(14)
	   //здддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	   //ЁVerifica se deve listar ou nao o estado origem no resumoЁ
	   //юдддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	   If (lLisEstOri.Or.(!lLisEstOri.And.cMV_Estado!=aResumo[i,2]))
		  If i==1
			 FmtLin(@aDados,aL[19],,,@nLin)
			 aDados[7]:=STR0038 //"DEMONSTRATIVO POR ESTADO DE DESTINO DA MERCADORIA OU DA PRESTACAO DE SERVICO"
			 FmtLin(@aDados,aL[19],,,@nLin)
			 aDados[7]:="============================================================================"
			 FmtLin(@aDados,aL[19],,,@nLin)
			 FmtLin(@aDados,aL[19],,,@nLin)
		  Endif
		  If lFirstCO.and.aResumo[i,1]=="CO"
			 lFirstCO:=.F.
			 aDados[9]:=STR0039 //"OPERACOES REALIZADAS COM CONTRIBUINTES"
			 FmtLin(@aDados,aL[19],,,@nLin)
			 aDados[9]:="======================================"
			 FmtLin(@aDados,aL[19],,,@nLin)
		  Endif
		  If lFirstNC.and.aResumo[i,1]=="NC"
			 lFirstNC:=.F.
			 aDados[9]:=STR0040 //"OPERACOES REALIZADAS COM NAO CONTRIBUINTES"
			 FmtLin(@aDados,aL[19],,,@nLin)
			 aDados[9]:="=========================================="
			 FmtLin(@aDados,aL[19],,,@nLin)
		  Endif
		  If mv_par26 == 1
		     aDados[05]:=aResumo[i,2]
		     aDados[06]:=aResumo[i,3]
		     aDados[09]:=aResumo[i,4]            
		     aDados[11]:=aResumo[i,8]
		     aDados[12]:=aResumo[i,7]
		     If aResumo[i,5]>0
		     	aDados[13]:=aResumo[i,5]            
		     Endif
   		     If aResumo[i,18]>0
		        aDados[13] += aResumo[i,18]            
		     EndIf
   		     If aResumo[i,19]>0
		        aDados[13] += aResumo[i,19]            
		     EndIf
 
		  Else
		     aDados[5]:=aResumo[i,2]
		     aDados[6]:=aResumo[i,3]
			 aDados[9]:=aResumo[i,4]            
		  Endif   

		  If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)
		     aDados[14]:=STR0037+Alltrim(Transform(aResumo[i,6],cPesqICMRET)	)
		  Endif
			
          If mv_par25 == 1                
   	 	     nTotvlrctb +=aResumo[i,3] //Valor Contabil
	         nTotvlrbsc +=aResumo[i,4] //Base de Calculo
             If mv_par26 == 1
   	 	        nTotimpdeb +=aResumo[i,8] //Imposto Debitado
	            nTotisenta +=aResumo[i,7] //Coluna Isentas
	            If aResumo[i,5]>0
   	 	            nTotoutras +=aResumo[i,5] //Coluna Outras
   	 	        EndIf 
	            If aResumo[i,18]>0
   	 	           nTotoutras += aResumo[i,18]    	 	        
   	 	        EndIf
	            If aResumo[i,19]>0
   	 	           nTotoutras += aResumo[i,19]    	 	        
   	 	        EndIf
   	 	     Endif   
     	  Endif 
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif
		If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
			aDados[14]:=STR0042+Alltrim(Transform(aResumo[i,13],cPesqOBSI))
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif			
		If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
		    If lAntiICM
			    aDados[14]:=STR0043+Alltrim(Transform((aResumo[i,14]-aResumo[i,17]),cPesqOBSS))
		    Else
			    aDados[14]:=STR0043+Alltrim(Transform(aResumo[i,14],cPesqOBSS))		    
		    Endif
		    FmtLin(@aDados,aL[19],cPictVl,,@nLin)
	   Endif
	Endif
	//зддддддддддддддддддддддддддддддддд©
	//Ё Completa preenchimento da folha Ё
	//юддддддддддддддддддддддддддддддддды
	If i==Len(aResumo)

	   IF nTipoMov == 2  .AND. MV_PAR25 == 1
          aDados[03]:=STR0034
          aDados[06]:=nTotvlrctb		//TOTAL Valor Contabil
          aDados[09]:=nTotvlrbsc		//TOTAL Base de Calculo
          If mv_par26 == 1
	         aDados[11]:=nTotimpdeb		//Imposto Debitado
		     aDados[12]:=nTotisenta		//Coluna Isentas
			 aDados[13]:=nTotoutras		//Coluna Outras
		  Endif   
          FmtLin(@aDados,aL[19],cPictVl,,@nLin)
       ELSE 
          IF nTipoMov==1 .AND. MV_PAR25 == 1
             aDados[5]		:=STR0034
             aDados[8]		:=	 nTotvlrctb //TOTAL Valor Contabil
             aDados[13]	:=	 nTotvlrbsc //TOTAL Base de Calculo
         	 If mv_par26 == 1
	   	        aDados[15]	:= nTotIcmCre
	   	     	If nModelo == 1
		     	   aDados[16]	:= nTotIPICre
		     	Endif   
		   	 Endif   

             FmtLin(@aDados,aL[17],cPictVl,,@nLin)
          ENDIF
       ENDIF                    
	   R932Filler()
	Endif
Next i
aResumo:={}
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932LoadObsЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Carrega observacao para ser impressa                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932LoadObs

Local cTipo 	:= IIF(FWIsInCallStack('R932RegEntradas'), "aDados[9]", "aDados[7]") 
Local lRemoved	:= .F. //Protecao para nao refazer o ajuste de tamanho

nPosObs:=Ascan(aObs,{|x|x[2]})
If nPosObs>0
	aDados[If(nTipoMov==1,16,14)]:=aObs[nPosObs,1]
	aObs[nPosObs,2]:=.F.
	//Verifica necessidade de impressao da conta contabil por quebra de linha
	If Len(aLinCont) > 0 .AND. !FWIsInCallStack('R932Transp')
		&cTipo := aLinCont[1] 			//Preenche a continuacao da conta contabil
		ADel( aLinCont, 1 )					//Remove a dimensao que foi utilizada
		ASize( aLinCont, Len(aLinCont)-1 )	//Redimensiona o array
		lRemoved := .T.
	EndIf
Endif

If 	(Empty(&cTipo) .OR. Len(&cTipo)>14) .AND. !lRemoved; 
	.AND. !FWIsInCallStack('R932TotDia') .AND. !FWIsInCallStack('R932Transp')
	If IIF(Substr(cTipo,8,1) == "9", IIF(!Empty(aDados[11]) .OR. aDados[11] == Nil,.T.,.F.), IIF(!Empty(aDados[8]) .OR. aDados[8] == Nil,.T.,.F.))
		//Verifica necessidade de impressao da conta contabil por quebra de linha
		If Len(aLinCont) > 0
			(&cTipo) := aLinCont[1] 			//Preenche a continuacao da conta contabil
			ADel( aLinCont, 1 )					//Remove a dimensao que foi utilizada
			ASize( aLinCont, Len(aLinCont)-1 )	//Redimensiona o array
		EndIf
	EndIf
EndIf
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932Totais ЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Aciona funcoes de totalizacao                              Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932Totais(nSvApurIcm,nSvApurIpi)
R932Transp()
If lTotalDia
	R932TotDia()
Endif

lTotPerICM:=(nSvApurICM!=DefPeriodo(dDia,nApurICM)) .Or. IIf(nApurIcm==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotPerIPI:=(nSvApurIPI!=DefPeriodo(dDia,nApurIPI)) .Or. IIf(nApurIpi==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotMes:=(Month(dDiaAnt)!=Month(dDia))

R932TotPer(@nSvApurIcm,@nSvApurIpi)
R932TotMes()
//зддддддддддддддддддддд©
//Ё Termino do RelatorioЁ
//юддддддддддддддддддддды
If lTotMes
	//здддддддддддддддддддддддд©
	//Ё Imprime Resumo por CFO Ё
	//юдддддддддддддддддддддддды
	R932ResCfo()
	//зддддддддддддддддддддддддддд©
	//Ё Imprime Resumo por Estado Ё
	//юддддддддддддддддддддддддддды
	R932ResEst()
Endif                   

//здддддддддддддддддддддддддддддд©
//Ё Imprime Termo de EncerramentoЁ
//юдддддддддддддддддддддддддддддды
R932TermEnc()
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932TermIniЁAutor Ё Rodrigo de A. SartorioЁ Data Ё 25.03.98 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime termo de abertura no caso de so listar termos      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932TermIni()
Local cTermoSAb := aSX6[MV_LSAIAB]
Local cTermoEAb	:= aSX6[MV_LENTAB]
If MV_PAR41 == 1 .And. !Empty(aSX6[MV_P2ABER]) .And. !Empty(aSX6[MV_P1ABER])
	cTermoSAb :=aSX6[MV_P2ABER]
	cTermoEAb := aSX6[MV_P1ABER]
EndIf

nPagina:=1
//здддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime Termos de Abertura/EncerramentoЁ
//юдддддддддддддддддддддддддддддддддддддддды
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3).and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932TermEncЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime termo de encerramento no fim do relatorio          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932TermEnc
If ((Eof().Or.!lHouveMov).and. nImpTerm == 3) .Or. (nImpTerm == 2)
	If nTipoMov==1
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,aSX6[MV_LENTEN],nLargMax,cPerg)
	Else
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,aSX6[MV_LSAIEN],nLargMax,cPerg)
	Endif
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932Filler ЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Preenche folha com linha vazias                            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
FUNCTION R932Filler
IF nLin<67
    While nLin<=nLimPag
	    FmtLin(@aDados,If(nTipoMov==1,aL[17],aL[19]),,,@nLin)
    End                       
    If nLin>=nLimPag
        FmtLin(@aDados,aL[1],,,@nLin)
    ENdif   
ENDIF
Return
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932IniGradeЁAutorЁ Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Inicializa array aGrade do registro de entradas            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932IniGrade
//зддддддддддддддддддддддддддддддддддддд©
//Ё Monta grade de impressao            Ё
//Ё [1]=Codigo de Operacao de ICMS/IPI  Ё
//Ё [2]=Base de Calculo/Isentas/ Outras Ё
//Ё [3]=Valor do ICMS / IPI             Ё
//юддддддддддддддддддддддддддддддддддддды
IF cMV_ESTADO == "SP" .And. !lCat21
	aGrade:={{"1",0,0,0},{"2",0,0,0},{"3",0,0,0}}   	// ICMS
ELSE
	aGrade:={{"1",0,0,0},{"2",0,0,0},{"3",0,0,0},;   	// ICMS
			{"1",0,0,0},{"2",0,0,0},{"3",0,0,0}}	  	// IPI
ENDIF
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR932ImpGradeЁAutorЁ Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime aGrade do registro de entradas                     Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R932ImpGrade
Local lImprimiu :=.F.
Local nX		:=0
Local cChave	:= ""
Local cChave2	:= ""
Local lContZer	:= .F.

cICMS:="ICMS"
cIPI :="IPI"
For nx:=1 to Len(aGrade)
	If !lImpZer .and. ((aGrade[nx,2]+aGrade[nx,3]+aGrade[nx,4])==0)
		Loop
	Endif
	lImprimiu:=.T.
	If nx<=3
		aDados[11]:=cICMS
		cICMS:=NIL
	Else
		aDados[11]:=cIPI
		cIPI:=NIL
	Endif
	cChave2 := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
	SD1->(dbSetOrder(1))
	SF4->(dbSetOrder(1))
	If SD1->(MSSeek(xFilial("SD1")+cChave2))
		If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))
			If Iif(nx<=3,SF4->F4_LFICM == "Z",SF4->F4_LFIPI == "Z")
				aDados[12]:="2"
				lContZer := .T.
			Else
				aDados[12]:=aGrade[nx,1]
			EndIf
		Else
			aDados[12]:=aGrade[nx,1]
		EndIf
	Else
		aDados[12]:=aGrade[nx,1]
	EndIf
	aDados[13]:=aGrade[nx,2]
	aDados[15]:=If(aGrade[nx,3]>0,aGrade[nx,3],NIL)
	If aGrade[nx,4] > 0 .And. aGrade[nx,2] <= 0 .And. SF4->F4_LFICM == "Z"
		aDados[12]:="2"
		lContZer := .T.
	EndIf 
	//зддддддддддддддддддддддд©
	//Ё Coluna de Observacoes Ё
	//юддддддддддддддддддддддды
	If !lIcmIpZer .and. ((aGrade[nx,2]+aGrade[nx,3])==0)
		//зддддддддддддддддддддддд©
		//Ё Coluna de Observacoes Ё
		//юддддддддддддддддддддддды
		aDados[11]:= NIL
		aDados[15]:= NIL
		aDados[12]:= NIL
		aDados[13]:= NIL
		aDados[14]:= NIL
		aDados[16]:= NIL
		R932LoadObs() 
		FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
	Else
		R932LoadObs() 
		If lIcmIpZer
			If aDados[12] == "2" .And. lImpZer .And. lContZer .And. SF4->F4_LFICM == "Z"
				FmtLin({,,,,,,,,,,,"1",,,,},If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				FmtLin({,,,,,,,,,,,"3",,,,},If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				Exit
			Else
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
			EndIf
		Else
			FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
		EndIF	
	EndIf
Next nx

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime itens com lancamento no livro fiscal zerado   Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !lImprimiu .And. !Empty(aDados[1]) .And. F3_VALCONT>0 .And. lIcmIpZer
	cChave := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
	SD1->(dbSetOrder(1))
	SF4->(dbSetOrder(1))
	If SD1->(MSSeek(xFilial("SD1")+cChave))
		If SF4->(MSSeek(xFilial("SF4")+SD1->D1_TES))			
	 
			//зддддддддддддддддддддддд©
			//Ё Coluna de ICMS        Ё
			//юддддддддддддддддддддддды
			aDados[11]:=cICMS
			cICMS:=NIL
		    If (SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z")
				aDados[12]:="2"
			Else
				aDados[12]:="1"
			EndIf
			aDados[13]:=0
			aDados[15]:=0
		
			//зддддддддддддддддддддддд©
			//Ё Coluna de Observacoes Ё
			//юддддддддддддддддддддддды
			If SF4->F4_LFICM == "Z"
				R932LoadObs()
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
			EndIf
		
			//зддддддддддддддддддддддд©
			//Ё Coluna de IPI         Ё
			//юддддддддддддддддддддддды
			aDados[11]:=cIPI
			cIPI:=NIL
			If (SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z" .Or. SF4->F4_LFIPI == "I" )
				aDados[12]:="2"
			ElseIf SF4->F4_LFIPI == "O" 
				aDados[12]:="3"
			Else			
				aDados[12]:="1"
			Endif
			aDados[13]:=0
			aDados[15]:=0
		
			//зддддддддддддддддддддддд©
			//Ё Coluna de Observacoes Ё
			//юддддддддддддддддддддддды
			If SF4->F4_LFIPI == "Z"
				R932LoadObs()
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
			EndIf
		EndIf
	EndIf
Endif

Return


/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R932TVlCtEnЁAutorЁLTrombini              Ё Data Ё 25.06.13 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Calcula valor total contАbil por NF impressa               Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function R932TVlCtEn(cUltNF)
Local nVlrCtNF	:= 0
Local aDadT		:= aClone(aDados)
Local nRecOri	:= Recno()
Local cIdTipo   := ""
Local aAreaCF  := {}
If cUltNF <> aDadT[1]+aDadT[2]+aDadT[3]+aDadT[4]+aDadT[5]+aDadT[6]+aDadT[7]
	If mv_par47 ==1 
		aAreaCF := GetArea() 
		If RetPessoa((cArqTemp)->CGC) == "F"
	    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R 999.999.999-99")
	    ELSE
	    	cIdTipo := TRANSFORM((cArqTemp)->CGC,"@R! NN.NNN.NNN/NNNN-99")
	    EndIf
   EndIf
	aDadT[1]:= DTOC(F3_ENTRADA)
	aDadT[2]:= IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,SerieNfId(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE))
	aDadT[3]:= SerieNfID(cArqTemp,2,"F3_SERIE")
	aDadT[4]:= F3_NFISCAL
	aDadT[5]:= DTOC(F3_EMISSAO)
	aDadT[6]:= If(mv_par47 == 1 ,cIdTipo, F3_CLIEFOR+"-"+F3_LOJA)
	aDadT[7]:= F3_ESTADO
	cUltNF := aDadT[1]+aDadT[2]+aDadT[3]+aDadT[4]+aDadT[5]+aDadT[6]+aDadT[7]
	While !Eof() .and. aDadT[1]== DTOC(F3_ENTRADA) .and.;
		aDadT[2]== IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,SerieNfID(cArqTemp,2,"F3_SERIE")),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE)) .and.;
		aDadT[3]== SerieNfID(cArqTemp,2,"F3_SERIE") .and. aDadT[4]==F3_NFISCAL .and. aDadT[5]== DTOC(F3_EMISSAO) .and. aDadT[6]== If(mv_par47 == 1 ,cIdTipo, F3_CLIEFOR+"-"+F3_LOJA) .and. aDadT[7]==F3_ESTADO

		nVlrCtNF += F3_VALCONT
		dbSelectArea(cArqTemp)
		dbSkip()
		//Autualizo o cIdTipo pois pode existir a mesma nota e serie com fornecedores Diferentes.
		If mv_par47 == 1 .And. !Eof()
			cIdTipo := Posicione(If(F3_TIPO$"DB","SA1","SA2"),1,xFilial(If(F3_TIPO$"DB","SA1","SA2"))+F3_CLIEFOR+F3_LOJA,If(F3_TIPO$"DB","A1_CGC","A2_CGC"))
			If F3_TIPO$"DB"
				If RetPessoa(SA1->A1_CGC) == "F"
			    	cIdTipo := TRANSFORM(SA1->A1_CGC,"@R 999.999.999-99")
			    ELSE
			    	cIdTipo := TRANSFORM(SA1->A1_CGC,"@R! NN.NNN.NNN/NNNN-99")
			    EndIf
			Else
				If RetPessoa(SA2->A2_CGC) == "F"
			    	cIdTipo := TRANSFORM(SA2->A2_CGC,"@R 999.999.999-99")
				Else    	
			    	cIdTipo := TRANSFORM(SA2->A2_CGC,"@R! NN.NNN.NNN/NNNN-99")
			    EndIf
			EndIf
		EndIf
	EndDo
	If mv_par47 ==1
		RestArea(aAreaCF)
	EndIf
	DbGoto(nRecOri)
Else
	nVlrCtNF	:= ' '		// Para nЦo imprimir zero no relatСrio, transforma em branco
EndIf
Return(nVlrCtNF)
