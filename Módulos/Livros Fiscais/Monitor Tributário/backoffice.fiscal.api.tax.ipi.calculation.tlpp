#INCLUDE "tlpp-core.th"
#INCLUDE "tlpp-rest.th"
#INCLUDE "totvs.ch"

Static oGetApurIPI := Nil

/*-------------------------------------------------------------
{Protheus.doc} GET MTApurIPIFilter
API de Apuração de IPI por parâmetros.
@author william.palma
@parâmetros de entrada do endpoint
@since 10/12/2024
--------------------------------------------------------------*/
@get(endpoint='/api/fiscal/tax-monitor/v1/ipi/calculation', description='API de apuração de IPI')
Function MTApurIPIFilter()
Local oJsResponse         as json
Local cbranches        := oRest:getQueryRequest()['branches'] as character
Local cperiodStart     := oRest:getQueryRequest()['periodStart']  as character
Local cperiodEnd       := oRest:getQueryRequest()['periodEnd']  as character

If valtype(cbranches) != 'U' .and. !empty(cbranches) .and. valtype(cperiodStart) != 'U' .and. !empty(cperiodStart) .and. valtype(cperiodEnd) != 'U' .and. !empty(cperiodEnd)
    oJsResponse := ApurIPIFilter(cbranches, cperiodStart, cperiodEnd)
Endif    
oRest:setResponse( (oJsResponse )) 
FWFreeObj(oJsResponse)
Return 

/*-------------------------------------------------------------------
{Protheus.doc} GET ApurIPIFilter
Função responsável por preencher o Json com com informações referentes a apuração de IPI
@author william.palma
@parâmetros de entrada do endpoint
@since 10/12/2024
-------------------------------------------------------------------*/
Static Function ApurIPIFilter(cbranches as character, cperiodStart as character, cperiodEnd as character)
Local nPos         := 0                         as numeric
Local nPageAux     := 0                         as numeric
Local nPageSize    := 12                        as numeric
Local lHasNext     := .f.                       as logical
Local nPage        := 1                         as numeric
Local oJsonResp    := JsonObject():New()        as object
Local cAlias       := getNextAlias()            as character
Local aRetOrig     := {}                        as array
Local cDbMs        := ""                        as character

cDbMs := TcGetDb()
  
If "MSSQL" $ cDbMs
    GetApuraIPIMSSQL(@cAlias,nPage,nPageSize,cbranches, cperiodStart, cperiodEnd)
ElseIf "ORACLE" $ cDbMs
    GetApuraIPIORACLE(@cAlias,nPage,nPageSize,cbranches, cperiodStart, cperiodEnd)
ElseIf "POSTGRES" $ cDbMs
    GetApuraIPIPOSTGRES(@cAlias,nPage,nPageSize,cbranches, cperiodStart, cperiodEnd)
EndIf

// Iniciando o While
If (cAlias)->(!Eof())
    While (cAlias)->(!Eof())
        nPageAux++
        If nPageAux == 1
            oJsonResp["items"] := {}
        Endif
        If nPageAux <= nPageSize
            aAdd( oJsonResp["items"], JsonObject():New() )
            nPos++
            oJsonResp["items"][nPos]["month"]         :=   AllTrim((cAlias)->MESANO)
            oJsonResp["items"][nPos]["credit"]        :=   (cAlias)->VALORCRED     
            oJsonResp["items"][nPos]["debt"]          :=   (cAlias)->VALORDEBT
            oJsonResp["items"][nPos]["calculation"]   :=   (cAlias)->VALORAPUR
        Else
            lHasNext := .t.
            Exit
        EndIf
        (cAlias)->(DbSkip())
    EndDo
oJsonResp["hasNext"]    := lHasNext
Else
    oJsonResp['code'] := 400
    oJsonResp['detailMessage'] := 'value not found'
    oJsonResp['message'] := "Dados não encontrados para o período e/ou filial informados."
EndIf       
(cAlias)->(DBCloseArea())
aSize(aRetOrig,0)
Return oJsonResp:toJson()


/*--------------------------------------------------------------------
{Protheus.doc} GetApuraIPIMSSQL()
(Responsável por executar a consulta aos campos da tabela CDP)
@author william.palma
@since 10/12/2024
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApuraIPIMSSQL(cAlias as character, nPage as numeric, nPageSize as numeric, cbranches as character, cperiodStart as character, cperiodEnd as character)
Local cQuery    := ''  as character

If oGetApurIPI == Nil
    cQuery := "SELECT DISTINCT (CDP.MESNOME) AS MESANO,  SUM(CDP.VALORCRED) AS VALORCRED , SUM(CDP.VALORDEBT) AS VALORDEBT, CDP.MESNUM AS MESNUMERO, CDP.ANONUM AS ANONUMERO,"
    cQuery += "SUM(CDP.VALORAPUR) AS VALORAPUR FROM"
    cQuery += " (SELECT"
    cQuery += " RIGHT(CDP_DTINI,4) AS MES, LEFT(CDP_DTINI,4) AS ANO, CDP_LINHA, MONTH(CDP_DTINI) AS MESNUM, YEAR(CDP_DTINI) AS ANONUM,  "
    cQuery += " CASE "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jan/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'fev/' + LEFT(CDP_DTINI,4)"
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'mar/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'abr/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'mai/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jun/' + LEFT(CDP_DTINI,4)"
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jul/' + LEFT(CDP_DTINI,4)  "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'ago/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'set/' + LEFT(CDP_DTINI,4)"
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'out/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'nov/' + LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'dez/' + LEFT(CDP_DTINI,4)"
    cQuery +="ELSE ? END as 'MESNOME',   "
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END  AS VALORCRED,"
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END  AS VALORDEBT,"
    cQuery += " CASE WHEN CDP_LINHA IN (?) THEN CDP_VALOR ELSE 0 END  AS VALORAPUR"
    cQuery += " FROM "+RetSQLName("CDP")+" CDP "
    cQuery += " WHERE CDP_DTINI BETWEEN ? AND ? "
    cQuery +="AND D_E_L_E_T_ = ? AND CDP_LINHA IN (?)"
    cQuery +="AND CDP_FILIAL IN (?) AND CDP_VALOR > ?"
    cQuery += " GROUP BY CDP_FILIAL, RIGHT(CDP_DTINI,4), LEFT(CDP_DTINI,4), CDP_VALOR, CDP_LINHA, MONTH(CDP_DTINI), YEAR(CDP_DTINI)) AS CDP  "
    cQuery += " GROUP BY CDP.MESNOME, CDP.MESNUM, CDP.ANONUM"
    cQuery += " ORDER BY CDP.ANONUM, CDP.MESNUM"
    oGetApurIPI := FwExecStatement():New()
    oGetApurIPI:SetQuery(ChangeQuery(cQuery))
Endif

If oGetApurIPI != Nil
    oGetApurIPI:setString(1, "0101")
    oGetApurIPI:setString(2, "0201")
    oGetApurIPI:setString(3, "0301")
    oGetApurIPI:setString(4, "0401")
    oGetApurIPI:setString(5, "0501")
    oGetApurIPI:setString(6, "0601")
    oGetApurIPI:setString(7, "0701")
    oGetApurIPI:setString(8, "0801")
    oGetApurIPI:setString(9, "0901")
    oGetApurIPI:setString(10,"1001")
    oGetApurIPI:setString(11,"1101")
    oGetApurIPI:setString(12,"1201")
    oGetApurIPI:setString(13, "")
    oGetApurIPI:setString(14, "015")
    oGetApurIPI:setString(15, "014")
    oGetApurIPI:SetIn(16, {'016','017'})
    oGetApurIPI:setString(17, StrTran(cperiodStart, "-", ""))
    oGetApurIPI:setString(18, StrTran(cperiodEnd, "-", ""))
    oGetApurIPI:setString(19, "")
    oGetApurIPI:SetIn(20, {'014','015', '016', '017'})
    oGetApurIPI:SetIn(21, StrTokArr(cbranches, "," ))
    oGetApurIPI:SetNumeric(22, 0)
    cAlias := oGetApurIPI:OpenAlias()
Endif
FWFreeObj(oGetApurIPI)
Return 


/*--------------------------------------------------------------------
{Protheus.doc} GetApuraIPIORACLE()
(Responsável por executar a consulta aos campos da tabela CDP)
@author william.palma
@since 10/12/2024
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApuraIPIORACLE(cAlias as character, nPage as numeric, nPageSize as numeric, cbranches as character, cperiodStart as character, cperiodEnd as character)
Local cQuery    := ''  as character

If oGetApurIPI == Nil
    cQuery := "SELECT DISTINCT (CDP.MESNOME) AS MESANO, SUM(CDP.VALORCRED) AS VALORCRED,"
    cQuery += "SUM(CDP.VALORDEBT) AS VALORDEBT, TO_NUMBER(CDP.MESNUM) AS MESNUMERO, TO_NUMBER(CDP.ANONUM) AS ANONUMERO, SUM(CDP.VALORAPUR) AS VALORAPUR FROM"
    cQuery += " (SELECT"
    cQuery += " SUBSTR(CDP_DTINI,5,2) AS MES, SUBSTR(CDP_DTINI,1,4) AS ANO, CDP_LINHA, TO_CHAR(CAST(CDP_DTINI AS DATE), 'MM') AS MESNUM, TO_CHAR(CAST(CDP_DTINI AS DATE), 'YYYY') AS ANONUM,  "
    cQuery += " CASE "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'jan/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'fev/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'mar/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'abr/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'mai/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'jun/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'jul/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'ago/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'set/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'out/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'nov/' || SUBSTR(CDP_DTINI,1,4) "
	cQuery +="WHEN SUBSTR(CDP_DTINI,5,2) = ? THEN 'dez/' || SUBSTR(CDP_DTINI,1,4) "
    cQuery +="ELSE ? END AS MESNOME,   "
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END AS VALORCRED,"
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END AS VALORDEBT,"
    cQuery += " CASE WHEN CDP_LINHA IN (?) THEN CDP_VALOR ELSE 0 END AS VALORAPUR"
    cQuery += " FROM "+RetSQLName("CDP") "
    cQuery += " WHERE TO_CHAR(CAST(CDP_DTINI AS DATE), 'YYYYMMDD')  BETWEEN ? AND ? "
    cQuery +="AND D_E_L_E_T_ = ? AND CDP_LINHA IN (?) "
    cQuery +="AND CDP_FILIAL IN (?) AND CDP_VALOR > ?"
    cQuery += " GROUP BY CDP_FILIAL, SUBSTR(CDP_DTINI,5,2), SUBSTR(CDP_DTINI,1,4), CDP_VALOR, CDP_LINHA, TO_CHAR(CAST(CDP_DTINI AS DATE), 'MM'), TO_CHAR(CAST(CDP_DTINI AS DATE), 'YYYY') ) CDP   "
    cQuery += " GROUP BY CDP.MESNOME, CDP.MESNUM, CDP.ANONUM "
    cQuery += " ORDER BY CDP.ANONUM, CDP.MESNUM"
    oGetApurIPI := FwExecStatement():New()
    oGetApurIPI:SetQuery(ChangeQuery(cQuery))
Endif

If oGetApurIPI != Nil
    oGetApurIPI:setString(1, "01")
    oGetApurIPI:setString(2, "02")
    oGetApurIPI:setString(3, "03")
    oGetApurIPI:setString(4, "04")
    oGetApurIPI:setString(5, "05")
    oGetApurIPI:setString(6, "06")
    oGetApurIPI:setString(7, "07")
    oGetApurIPI:setString(8, "08")
    oGetApurIPI:setString(9, "09")
    oGetApurIPI:setString(10,"10")
    oGetApurIPI:setString(11,"11")
    oGetApurIPI:setString(12,"12")
    oGetApurIPI:setString(13, "")
    oGetApurIPI:setString(14, "015")
    oGetApurIPI:setString(15, "014")
    oGetApurIPI:SetIn(16, {'016','017'})
    oGetApurIPI:setString(17, StrTran(cperiodStart, "-", ""))
    oGetApurIPI:setString(18, StrTran(cperiodEnd, "-", ""))
    oGetApurIPI:setString(19, "")
    oGetApurIPI:SetIn(20, {'014','015', '016', '017'})
    oGetApurIPI:SetIn(21, StrTokArr(cbranches, "," ))
    oGetApurIPI:SetNumeric(22, 0)
    cAlias := oGetApurIPI:OpenAlias()
Endif
FWFreeObj(oGetApurIPI)
Return


/*--------------------------------------------------------------------
{Protheus.doc} GetApuraIPIPOSTGR()
(Responsável por executar a consulta aos campos da tabela CDP)
@author william.palma
@since 10/12/2024
@return Nil, nulo, não tem retorno.
//-------------------------------------------------------------------*/
Static Function GetApuraIPIPOSTGRES(cAlias as character, nPage as numeric, nPageSize as numeric, cbranches as character, cperiodStart as character, cperiodEnd as character)
Local cQuery    := ''  as character

If oGetApurIPI == Nil
    cQuery := "SELECT DISTINCT (CDP.MESNOME) AS MESANO,  SUM(CDP.VALORCRED) AS VALORCRED, "
    cQuery += "SUM(CDP.VALORDEBT) AS VALORDEBT, TO_NUMBER(CDP.MESNUM,'99') AS MESNUMERO, TO_NUMBER(CDP.ANONUM,'9999'), SUM(CDP.VALORAPUR) AS VALORAPUR FROM "
    cQuery += " (SELECT"
    cQuery += " RIGHT(CDP_DTINI,4) AS MES, LEFT(CDP_DTINI,4) AS ANO, TO_CHAR(CDP_DTINI:: DATE, 'MM') AS MESNUM, TO_CHAR(CDP_DTINI:: DATE, 'YYYY') AS ANONUM, "
    cQuery += " CASE "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jan/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'fev/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'mar/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'abr/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'mai/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jun/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'jul/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'ago/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'set/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'out/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'nov/' || LEFT(CDP_DTINI,4) "
	cQuery +="WHEN RIGHT(CDP_DTINI,4) = ? THEN 'dez/' || LEFT(CDP_DTINI,4) "
    cQuery +="ELSE ? END as MESNOME, "
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END  AS VALORCRED,"
    cQuery += " CASE WHEN CDP_LINHA = ? THEN CDP_VALOR ELSE 0 END  AS VALORDEBT,"
    cQuery += " CASE WHEN CDP_LINHA IN (?) THEN CDP_VALOR ELSE 0 END AS VALORAPUR"
    cQuery += " FROM "+RetSQLName("CDP")+" CDP "
    cQuery += " WHERE CDP_DTINI BETWEEN ? AND ? "
    cQuery +="AND D_E_L_E_T_ = ? AND CDP_LINHA IN (?)"
    cQuery +="AND CDP_FILIAL IN (?) AND CDP_VALOR > ?"
    cQuery += " GROUP BY CDP_FILIAL, RIGHT(CDP_DTINI,4), LEFT(CDP_DTINI,4), CDP_VALOR, CDP_LINHA, TO_CHAR(CDP_DTINI:: DATE, 'MM'), TO_CHAR(CDP_DTINI:: DATE, 'YYYY')) AS CDP"
    cQuery += " GROUP BY CDP.MESNOME, CDP.MESNUM, CDP.ANONUM "
    cQuery += " ORDER BY TO_NUMBER(CDP.ANONUM,'9999'), TO_NUMBER(CDP.MESNUM,'99')"
    oGetApurIPI := FwExecStatement():New()
    oGetApurIPI:SetQuery(ChangeQuery(cQuery))
Endif

If oGetApurIPI != Nil
    oGetApurIPI:setString(1, "0101")
    oGetApurIPI:setString(2, "0201")
    oGetApurIPI:setString(3, "0301")
    oGetApurIPI:setString(4, "0401")
    oGetApurIPI:setString(5, "0501")
    oGetApurIPI:setString(6, "0601")
    oGetApurIPI:setString(7, "0701")
    oGetApurIPI:setString(8, "0801")
    oGetApurIPI:setString(9, "0901")
    oGetApurIPI:setString(10,"1001")
    oGetApurIPI:setString(11,"1101")
    oGetApurIPI:setString(12,"1201")
    oGetApurIPI:setString(13, "")
    oGetApurIPI:setString(14, "015")
    oGetApurIPI:setString(15, "014")
    oGetApurIPI:SetIn(16, {'016','017'})
    oGetApurIPI:setString(17, StrTran(cperiodStart, "-", ""))
    oGetApurIPI:setString(18, StrTran(cperiodEnd, "-", ""))
    oGetApurIPI:setString(19, "")
    oGetApurIPI:SetIn(20, {'014','015', '016', '017'})
    oGetApurIPI:SetIn(21, StrTokArr(cbranches, "," ))
    oGetApurIPI:SetNumeric(22, 0)
    cAlias := oGetApurIPI:OpenAlias()
Endif
FWFreeObj(oGetApurIPI)
Return 
