#INCLUDE "PROTHEUS.CH"
#include "matxmag.ch"
#Include "APWIZARD.CH"
#DEFINE CHRCOMP If(aReturn[4]==1,15,18)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ MATXMAG  ณ Autor ณ Andreia dos Santos    ณ Data ณ 23/10/00   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Funcoes utilizadas na geracao dos arquivos magneticos     	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณSintaxe e ณ MATXMAG(void)                                              	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ Generico                                                   	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                     	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ PROGRAMADOR  ณ DATA   ณ BOPS ณ  MOTIVO DA ALTERACAO                   	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤลฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Antonio C.   ณ07/11/13ณTHUTNIณ Modificar as incid๊ncias das verbas de IR ฑฑ
ฑฑณ              ณ        ณ      ณ quando houver insufici๊ncia de saldo.     ฑฑ
ฑฑ|Antonio C.  |07/11/2013|THXQBB|Desconsiderar a verba de id 151 para com- ณฑฑ
ฑฑ|            |          |   	 |por a base do IR.                         ณฑฑ
ฑฑ|Antonio C.  |27/12/2013|TI4961|Ajuste para gera็ใo das linhas K250 quandoณฑฑ
ฑฑ|            |          |      |existe rateio e bases Ir e Inss zeradas.  ณฑฑ
ฑฑ|Antonio C.  |12/02/2014|TIIO41|Ajuste dos campos da tabela SRD que estavaณฑฑ
ฑฑ|            |          |      |sem a referencia do alias, gerando erro.  ณฑฑ
ฑฑ|Antonio C.  |25/03/2014|TPAVZ7|Ajuste da tributa็ใo da verba id 0151 PLR ณฑฑ
ฑฑ|            |          |   	 |no Manad k300 antes e depois de 01/2013   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณRetNum    บAutor  ณAndreia dos Santos  บ Data ณ  24/10/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna o numero do telefone Formatado                      บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SISIF                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
//
Function RetNum(cNumAux)
Local cNum := ""
Local n := 1

// Retira caracteres do campo cNumAux
For n:=1 To Len(cNumAux)
	If IsDigit(Subs(cNumAux,n,1))
		cNum+=Subs(cNumAux,n,1)
	Endif
Next

return( cNum )

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณRetUnid   บAutor  ณAndreia dos Santos  บ Data ณ  24/10/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna a unidade de produto                                บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SISIF                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function RetUnid(cUnid, cSegum)
Local cretUnid := "UN"

Default cSegum := ""

If !(Empty(cSegum))
	Return(cSegum)
EndIf

cUnid := alltrim(cUnid)
Do Case
Case cUnid == "CX" .Or. cUnid == "DZ" .Or. cUnid == "PC" //CAIXA,DUZIA,PECA
	cretUnid := "UN"
Case cUnid == "G" //GRAMA
	cretUnid :=	"KG"
Case cUnid == "L" .Or. cUnid == "ML" .Or. cUnid == "TL" //LITRO, mililitro,TONELADA LIQUIDA
	cretUnid := "LT"
Case cUnid == "M" .Or. cUnid == "DM" .Or. cUnid == "CM" .Or. cUnid == "MM" .Or. cUnid == "PL"
	//METRO,DECIMETRO,Centimetro,milimetro, POLEGADA
	cretUnid := "MT"
Case cUnid == "P" //PAR
	cretUnid := "PR"
OtherWise
	cretUnid := cUnid
END

Return(cretUnid)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณRetEnd    บAutor  ณAndreia dos Santos  บ Data ณ  24/10/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna(1) o endereco                                       บฑฑ
ฑฑบ          ณ       (2) o numero                                         บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ generico                                                   บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function RetEnd( cEnd, nRet )
Local nVirgula	:= Rat(",",cEND)
Local nNumero 	:= Val(AllTrim(SubStr(cEND,nVirgula+1)))
Local cEnderec	:= PadR(If(nNumero!=0,SubStr(cEND,1,nVirgula-1),cEND),34)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณQuando nao ha virgula no endereco procura-se o caracter brancoณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If ( nVirgula == 0 )
	nVirgula	:= Rat(" ",AllTrim(cEND))
	nNumero		:= Val(AllTrim(SubStr(cEND,nVirgula+1)))
	cEnderec	:= PadR(If(nNumero!=0,SubStr(cEND,1,nVirgula-1),cEND),34)
EndIf

RETURN(if(nRet==1,cEnd,nNumero))

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณRetInvent บAutor  ณAndreia dos Santos  บ Data ณ  24/10/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Calcula a quantidade e o valor de um determinado produto   บฑฑ
ฑฑบ          ณ em uma determinada data                                    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
function RetInvent(cCod)
Local aInvent	:= {}
Local lRet		:= .f.
_nQtde			:= 0
_nValor			:= 0

if MV_PAR06 == 1
	While SB2->(!eof()) .and. SB2->B2_COD == cCod
		aInvent	:=	CalcEst(SB2->B2_COD,SB2->B2_LOCAL,MV_PAR07)
		_nQtde	+=	aInvent[1]
		_nValor	+=	aInvent[2]
		SB2->(dbSkip())
	EndDo
EndIf
lRet	:= (_nQtde > 0)
Return(lRet)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณArqNotas  บAutor  ณAndreia dos Santos  บ Data ณ  26/10/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Cria e monta arquivo temporario com os dados das NF's      บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ArqNotas()
Local aCampos	:= {}
Local lItens	:= .F.
Local lFirst	:= .T.
Local cNome		:=	""
Local cUf		:=	""
Local cFone		:=	""
Local nI := 0
Local	nTotBsIpi	:=	0
Local	nTotIsIpi	:=	0
Local	nTotOtIpi	:=	0
Local	nTotVlIpi	:=	0
cModelo	:=	"01"
cOperac	:= 	"01"
cFatura	:= 	"1"
cTipoMov:= 	""
nItens	:= 	0
cTipoReg:=	"40"
aTam  	:= TAMSX3("F3_CFO")
cCGC    := ""
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCabecalho da Nota Fiscal.Reg. 40,41,42,43ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aCampos,{"TIPOREG","C",002,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})
AADD(aCampos,{"OPERAC"	,"C",002,0})
AADD(aCampos,{"MODELO"	,"C",002,0})
AADD(aCampos,{"SUBSER"	,"C",003,0})
AADD(aCampos,{"CFOP"	,"C",aTam[1],0})
AADD(aCampos,{"EMISSAO"	,"D",008,0})
AADD(aCampos,{"CAIXA"	,"C",004,0})
AADD(aCampos,{"TIPFRET"	,"C",001,0})
AADD(aCampos,{"FATURA"	,"C",001,0})
AADD(aCampos,{"SITUACA"	,"C",002,0})
AADD(aCampos,{"CTACONT"	,"C",015,0})
AADD(aCampos,{"AIDF"	,"C",011,0})
AADD(aCampos,{"AUTGNRE"	,"C",012,0})
AADD(aCampos,{"MUNICIP"	,"C",005,0})
AADD(aCampos,{"CNPJ"	,"C",020,0})

cTRB	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTRB,"TRB",.T.,.F.)
IndRegua("TRB",cTRB,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("TRB")
DbClearIndex()
DbSetIndex(cTRB+OrdBagExt())

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณItens da Nota Fiscal. Reg. 60,62,64,66,67ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos	:= {}
AADD(aCampos,{"TIPOREG"	,"C",002,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})
AADD(aCampos,{"NUMITEM"	,"C",004,0})
AADD(aCampos,{"PRODUTO"	,"C",030,0})
AADD(aCampos,{"QUANTID"	,"N",013,4})
AADD(aCampos,{"VALUNIT"	,"N",015,4})
AADD(aCampos,{"UNIDADE"	,"C",003,0})
AADD(aCampos,{"QTDPADR"	,"N",017,8})
AADD(aCampos,{"VALPADR"	,"N",015,6})
AADD(aCampos,{"CFOP"	,"C",aTam[1],0})
AADD(aCampos,{"CST"		,"C",003,0})
AADD(aCampos,{"CSTECF"	,"C",003,0})
AADD(aCampos,{"BASEICM"	,"N",013,2})
AADD(aCampos,{"VALICM"	,"N",013,2})
AADD(aCampos,{"BASERET"	,"N",013,2})
AADD(aCampos,{"VALRET"	,"N",013,2})
AADD(aCampos,{"TIPOICM"	,"C",002,0})
AADD(aCampos,{"BASEIMP"	,"N",013,2})
AADD(aCampos,{"VALIMPO"	,"N",013,2})
AADD(aCampos,{"TIPOIMP"	,"C",002,0})
AADD(aCampos,{"CODICM"	,"C",002,0})
AADD(aCampos,{"BASEIPI"	,"N",013,2})
AADD(aCampos,{"ISENIPI"	,"N",013,2})
AADD(aCampos,{"OUTRIPI"	,"N",013,2})
AADD(aCampos,{"VALIPI"	,"N",013,2})
AADD(aCampos,{"CODIPI"	,"C",002,0})
AADD(aCampos,{"CONTAB"	,"C",015,0})
AADD(aCampos,{"VALUBRU"	,"N",015,4})

cITE	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cITE,"ITE",.T.,.F.)
IndRegua("ITE",cITE,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA+PRODUTO+CFOP+NUMITEM")
DbSelectArea("ITE")
DbClearIndex()
DbSetIndex(cITE+OrdBagExt())


//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณParticipantes.Reg 62ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos	:= {}
AADD(aCampos,{"TIPOREG"	,"C",002,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})
AADD(aCampos,{"CONDIC"	,"C",002,0})
AADD(aCampos,{"CNPJ"	,"C",014,0})
AADD(aCampos,{"CGF"		,"C",020,4})
AADD(aCampos,{"RAZASO"	,"C",060,4})
AADD(aCampos,{"UF"		,"C",002,0})
AADD(aCampos,{"SUFRAMA"	,"C",014,8})

cPAR	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cPAR,"PAR",.T.,.F.)
IndRegua("PAR",cPAR,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("PAR")
DbClearIndex()
DbSetIndex(cPAR+OrdBagExt())

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTotalizador da Nota Fiscal.Reg 69ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos := {}
AADD(aCampos,{"TIPOREG","C",002,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})
AADD(aCampos,{"ITENS"	,"N",004,0})
AADD(aCampos,{"VALPRO"	,"N",013,2})
AADD(aCampos,{"VALFRE"	,"N",013,2})
AADD(aCampos,{"VALDESP"	,"N",013,2})
AADD(aCampos,{"VALDESC"	,"N",013,2})
AADD(aCampos,{"VALCONT"	,"N",013,2})
AADD(aCampos,{"VALRET"	,"N",013,2})
AADD(aCampos,{"BASEICM"	,"N",013,2})
AADD(aCampos,{"VALICM"	,"N",013,2})
AADD(aCampos,{"ISENICM"	,"N",013,2})
AADD(aCampos,{"OUTRICM"	,"N",013,2})
AADD(aCampos,{"BASEANT"	,"N",013,2})
AADD(aCampos,{"VALANTE"	,"N",013,2})
AADD(aCampos,{"BASEST"	,"N",013,2})
AADD(aCampos,{"VALST"	,"N",013,2})
AADD(aCampos,{"DIFALIQ"	,"N",013,2})
AADD(aCampos,{"BASEIMP"	,"N",013,2})
AADD(aCampos,{"VALIMPO"	,"N",013,2})
AADD(aCampos,{"BASEIPI"	,"N",013,2})
AADD(aCampos,{"ISENIPI"	,"N",013,2})
AADD(aCampos,{"OUTRIPI"	,"N",013,2})
AADD(aCampos,{"VALIPI"	,"N",013,2})
AADD(aCampos,{"VALSEG"	,"N",013,2})

cTOT	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTOT,"TOT",.T.,.F.)
IndRegua("TOT",cTOT,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("TOT")
DbClearIndex()
DbSetIndex(cTOT+OrdBagExt())

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCabec.da Nota Fiscal. Reg. 70 NTST       ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos	:= {}
AADD(aCampos,{"TIPOREG"	,"C",002,0})
AADD(aCampos,{"OPERAC"	,"C",002,0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"SUBSER"	,"C",003,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"TELEFON"	,"C",012,0})
AADD(aCampos,{"CFOP"	,"C",005,0})
AADD(aCampos,{"EMISSAO"	,"D",008,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"VENCTO"	,"D",008,0})
AADD(aCampos,{"PERIODO"	,"C",006,0})
AADD(aCampos,{"CLASSE"	,"C",003,0})
AADD(aCampos,{"CONDPAR"	,"C",002,0})
AADD(aCampos,{"CNPJCGF"	,"C",020,0})
AADD(aCampos,{"TIPIDEN"	,"C",001,0})
AADD(aCampos,{"NOME"	,"C",060,0})
AADD(aCampos,{"UF"		,"C",002,0})
AADD(aCampos,{"VALCONT"	,"N",013,2})
AADD(aCampos,{"VALDESP"	,"N",013,2})
AADD(aCampos,{"VALDESC"	,"N",013,2})
AADD(aCampos,{"BASEICM"	,"N",013,2})
AADD(aCampos,{"VALICM"	,"N",013,2})
AADD(aCampos,{"CODCONT"	,"C",015,0})
// Auxiliares
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})

cTEL	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTEL,"TEL",.T.,.F.)
IndRegua("TEL",cTEL,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("TEL")
DbClearIndex()
DbSetIndex(cTEL+OrdBagExt())

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCabec.da Nota Fiscal. Reg. 76 NFCEE      ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos	:= {}
AADD(aCampos,{"TIPOREG"	,"C",002,0})
AADD(aCampos,{"OPERAC"	,"C",002,0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"SUBSER"	,"C",003,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"NUMCONT"	,"N",015,0})
AADD(aCampos,{"CFOP"	,"C",005,0})
AADD(aCampos,{"EMISSAO"	,"D",008,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"VENCTO"	,"D",008,0})
AADD(aCampos,{"PERIODO"	,"C",006,0})
AADD(aCampos,{"CLASSE"	,"C",003,0})
AADD(aCampos,{"CONDPAR"	,"C",002,0})
AADD(aCampos,{"CNPJCGF"	,"C",020,0})
AADD(aCampos,{"TIPIDEN"	,"C",001,0})
AADD(aCampos,{"NOME"	,"C",060,0})
AADD(aCampos,{"UF"		,"C",002,0})
AADD(aCampos,{"CONSFAT"	,"N",010,0})
AADD(aCampos,{"VALCONT"	,"N",013,2})
AADD(aCampos,{"VALCONS"	,"N",013,2})
AADD(aCampos,{"VALDESP"	,"N",013,2})
AADD(aCampos,{"VALDESC"	,"N",013,2})
AADD(aCampos,{"BASEICM"	,"N",013,2})
AADD(aCampos,{"VALICM"	,"N",013,2})
AADD(aCampos,{"CODCONT"	,"C",015,0})
AADD(aCampos,{"TXILUMI"	,"N",013,2})
AADD(aCampos,{"TARIFA"	,"C",006,0})
AADD(aCampos,{"INCRIC"	,"C",010,0})
// Auxiliares
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})

c76	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,c76,"R76",.T.,.F.)
IndRegua("R76",c76,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("R76")
DbClearIndex()
DbSetIndex(c76+OrdBagExt())
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณNumeros de seguranca            ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos	:= {}
AADD(aCampos,{"TIPOREG","C",002,0})
AADD(aCampos,{"ENTRADA"	,"D",008,0})
AADD(aCampos,{"NFISCAL"	,"C",010,0})
AADD(aCampos,{"SDOC"	,"C",003,0})
AADD(aCampos,{"SERIE"	,"C",TamSx3("F3_SERIE")[1],0})
AADD(aCampos,{"CLIEFOR"	,"C",006,0})
AADD(aCampos,{"LOJA"	,"C",002,0})
AADD(aCampos,{"TIPODIS"	,"C",002,0})
AADD(aCampos,{"SUBSER"	,"C",003,0})
AADD(aCampos,{"FORMUL"	,"C",001,0})

cSEG	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cSEG,"SEG",.T.,.F.)
IndRegua("SEG",cSEG,"TIPOREG+DTOS(ENTRADA)+NFISCAL+SERIE+CLIEFOR+LOJA")
DbSelectArea("SEG")
DbClearIndex()
DbSetIndex(cSEG+OrdBagExt())

aCampos	:= {}
AADD(aCampos,{"TIPOREG"	,"N",002,0})
AADD(aCampos,{"CODPROD"	,"C",030,0})
AADD(aCampos,{"CODBAR"	,"C",014,0})
AADD(aCampos,{"DESCRI"	,"C",060,0})
AADD(aCampos,{"UNIDADE"	,"C",002,0})
AADD(aCampos,{"POSIPI"	,"C",020,0})
AADD(aCampos,{"FILIAL"	,"C",002,0})

cPRO	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cPRO,"PRO",.T.,.F.)
IndRegua("PRO",cPRO,"CODPROD")
DbSelectArea("PRO")
DbClearIndex()
DbSetIndex(cPRO+OrdBagExt())

aCampos	:= {}
AADD(aCampos,{"TIPOREG"		,"C",002,0})
AADD(aCampos,{"MODELO"		,"C",002,0})
AADD(aCampos,{"SDOC"		,"C",003,0})
AADD(aCampos,{"SERIE"		,"C",TamSx3("D1_SERIE")[1],0})
AADD(aCampos,{"SUBSER"		,"C",003,0})
AADD(aCampos,{"NUMINI"		,"C",010,0})
AADD(aCampos,{"NUMFIM"		,"C",010,0})
AADD(aCampos,{"CNPJ"		,"C",020,0})
AADD(aCampos,{"TIPO"		,"C",001,0})
AADD(aCampos,{"MOTIVO"		,"C",002,0})
AADD(aCampos,{"SITUACAO"	,"C",002,0})
AADD(aCampos,{"VLCONTAB"	,"N",013,2})
AADD(aCampos,{"BASECALC"	,"N",013,2})
AADD(aCampos,{"ICMSNORM"	,"N",013,2})
AADD(aCampos,{"ICMSISEN"	,"N",013,2})
AADD(aCampos,{"ICMOUTR"		,"N",013,2})
AADD(aCampos,{"AIDF"		,"C",011,0})
AADD(aCampos,{"OBSERV"		,"C",100,0})
AADD(aCampos,{"FILIAL"		,"C",002,0})
cDFR	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cDFR,"DFR",.T.,.F.)
IndRegua("DFR",cDFR,"FILIAL+NUMINI+SERIE+CNPJ")
DbSelectArea("DFR")
DbClearIndex()
DbSetIndex(cDFR+OrdBagExt())


dbSelectArea("SF3")
dbSetOrder(1)
dBSeek(xFilial("SF3")+dtos(MV_PAR01),.T.)
While SF3->(!EOF()).and. SF3->F3_FILIAL == xFilial("SF3") .and. SF3->F3_ENTRADA >= MV_PAR01 .AND.;
	SF3->F3_ENTRADA <= MV_PAR02
	cTipoMov	:=	if(substr(SF3->F3_CFO,1,1)<"5","E","S")
	cModelo		:= Iif ("CF"$SF3->F3_ESPECIE .OR. "ECF"$SF3->F3_ESPECIE, "37", aModNot (SF3->F3_ESPECIE))
	nTotBsIpi	:=	0
	nTotIsIpi	:=	0
	nTotOtIpi	:=	0
	nTotVlIpi	:=	0
	//
	if SF3->F3_FORMUL == "S"
		cOperac	:= "01"
	elseIf cTipoMov == "E"
		cOperac	:=	"02"
	elseif cTipoMov == "S"
		cOperac	:= "03"
	ElseIf ("CF"$SF3->F3_ESPECIE .OR. "ECF"$SF3->F3_ESPECIE) .And. (cTipoMov=="E")
		cOperac	:= "07"
	EndIf
	//
	If (Empty(SF3->F3_ESPECIE)) .Or. (Alltrim (SF3->F3_ESPECIE)$"NFF,NF,NFE") .Or. ("CF"$SF3->F3_ESPECIE .OR. "ECF"$SF3->F3_ESPECIE)
		cTipoReg	:=	"40"
	elseIf Alltrim(SF3->F3_ESPECIE) $ "CTA,CTR,CA"
		cTipoReg	:=	"41"
		cOperac		:= if( cTipoMov=="E","04","05")
	elseIf Alltrim(SF3->F3_ESPECIE) =="NFST" .OR. Alltrim(SF3->F3_ESPECIE) =="NTSC" .OR. Alltrim(SF3->F3_ESPECIE) =="NFSC"
		cTipoReg	:=	"42"
		cOperac		:= if( cTipoMov=="E","04","05")
	EndIf
	//
	If cModelo$"06"
		cTipoReg	:=	"76"
	ElseIf cModelo$"22"
		cTipoReg	:=	"70"
	EndIf

	If SF3->F3_TIPO $ "BD"
	   If cTipoMov=="S"
		  SA2->(MsSeek(F3Filial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		  cCNPJ 	:=	StrZero (Val (aRetDig (SA2->A2_CGC, .F.)), 14)
		  cNome		:=	SA2->A2_NOME
		  cUf		:=	SA2->A2_EST
		  cFone		:=	SA2->A2_TEL
  	   Else
		  SA1->(MsSeek(F3Filial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		  cCNPJ		:=	StrZero (Val (aRetDig (SA1->A1_CGC, .F.)), 14)
		  cNome		:=	SA1->A1_NOME
		  cUf		:=	SA1->A1_EST
		  cFone		:=	SA1->A1_TEL
  	   Endif
	Else
	   If cTipoMov=="S"
		  SA1->(MsSeek(F3Filial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		  cCNPJ		:=SA1->A1_CGC
		  cNome		:=	SA1->A1_NOME
		  cUf		:=	SA1->A1_EST
		  cFone		:=	SA1->A1_TEL
	   Else
		  SA2->(MsSeek(F3Filial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		  cCNPJ		:=SA2->A2_CGC
		  cNome		:=	SA2->A2_NOME
		  cUf		:=	SA2->A2_EST
		  cFone		:=	SA2->A2_TEL
   	   Endif
	Endif

	cSeek	:=	SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA

	if cTipoMov =="E"
		SF1->(dbSeek(xFilial("SF1")+cSeek))
		SE4->(dBSeek(xFilial("SE4")+SF1->F1_COND))
		SD1->(dbSetOrder(1))
		SD1->(dbSeek(xFilial("SD1")+cSeek))
	else
		SF2->(dbSetOrder(1))
		SF2->(dbSeek(xFilial("SF2")+cSeek))
		SE4->(dBSeek(xFilial("SE4")+SF2->F2_COND))
		SD2->(dbSetOrder(3))
		SD2->(dbSeek(xFilial("SD2")+cSeek))
	Endif
	SB1->(dbSetOrder(1))
	cFatura	:= if(alltrim(SE4->E4_COND)=="0","1","2")
	if	cTipoReg$"70"
		IF TEL->(!dbSeek(cTipoReg+DTOS(SF3->F3_ENTRADA)+SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA)) .And. (!"CANCELAD"$SF3->F3_OBSERV)
			aArq70(cNome, cUf, cFone)
			lItens	:= .T.
		EndIf
	Elseif	cTipoReg$"76"
		IF R76->(!dbSeek(cTipoReg+DTOS(SF3->F3_ENTRADA)+SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA)) .And. (!"CANCELAD"$SF3->F3_OBSERV)
			aArq76(cNome, cUf, cFone, cSeek)
			lItens	:= .T.
		EndIf
	Else
		IF TRB->(!dbSeek(cTipoReg+DTOS(SF3->F3_ENTRADA)+PADR(SF3->F3_NFISCAL,10)+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA))
			aArqCab(cCNPJ)
			lItens	:= .T.
		EndIf
	EndIf
	If lItens
		if cTipoMov =="E"
			While SD1->(!eof()).and.SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA==xFilial("SD1")+cSeek
				SB1->(dbSeek(xFilial("SB1")+SD1->D1_COD))
				SF4->(dbSeek(xFilial("SF4")+SD1->D1_TES))
				IF ITE->(!dbSeek(cTipoReg+DTOS(SF3->F3_ENTRADA)+PADR(SF3->F3_NFISCAL,10)+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA+PADR(SD1->D1_COD,30)+SD1->D1_CF+StrZero(nItens+1,4))) .And. lFirst
					RECLOCK("ITE",.T.)
					ITE->TIPOREG	:=	cTipoReg
					ITE->ENTRADA	:=	SF3->F3_ENTRADA
					ITE->NFISCAL	:=	SF3->F3_NFISCAL
					ITE->SERIE		:=	SF3->F3_SERIE
					ITE->SDOC		:=	SerieNfId("SF3",2,"F3_SERIE")
					ITE->CLIEFOR	:=	SF3->F3_CLIEFOR
					ITE->LOJA		:=	SF3->F3_LOJA
					nItens++
					ITE->NUMITEM	:=	strzero(nItens,4)
					ITE->PRODUTO	:=	SD1->D1_COD
					ITE->QUANTID	:=	SD1->D1_QUANT
					ITE->VALUNIT	:=	SD1->D1_VUNIT-(SD1->D1_VALDESC/SD1->D1_QUANT)
					ITE->UNIDADE	:=	SD1->D1_UM
					ITE->QTDPADR	:=	Iif (Empty (SD1->D1_SEGUM), SD1->D1_QUANT, SD1->D1_QTSEGUM)
					ITE->VALPADR	:=	Iif (Empty (SD1->D1_SEGUM), SD1->D1_VUNIT, (SD1->D1_TOTAL/SD1->D1_QTSEGUM))
					ITE->CFOP		:=	SD1->D1_CF
					ITE->CST		:=	If ("70"$cTipoReg, "90", "")
					ITE->CSTECF		:=	""
					ITE->BASEICM	:=	if(SF4->F4_LFICM=="T",SD1->D1_BASEICM,0)
					ITE->VALICM		:=	if(SF4->F4_LFICM=="T",SD1->D1_VALICM,0)
					ITE->BASERET	:=	SD1->D1_BRICMS
					ITE->VALRET		:=	SD1->D1_ICMSRET
					ITE->TIPOICM	:=	if(SD1->D1_ICMSRET>0,"03","")
					ITE->BASEIMP	:=	0
					ITE->VALIMPO	:=	0
					ITE->TIPOIMP	:=	""
					ITE->CODICM		:=	IF(SF4->F4_LFICM=="T","01",IF(SF4->F4_LFICM=="I","02","03"))
					ITE->BASEIPI	:=	if(SF4->F4_LFIPI=="T",SD1->D1_BASEIPI,0)
					ITE->ISENIPI	:=	if(SF4->F4_LFIPI=="I",SD1->D1_BASEIPI,0)
					ITE->OUTRIPI	:=	if(SF4->F4_LFIPI=="O",SD1->D1_BASEIPI,0)
					ITE->VALIPI		:=	if(SF4->F4_LFIPI=="T",SD1->D1_VALIPI,0)
					ITE->CODIPI		:= 	IF(SF4->F4_LFIPI=="T","01",IF(SF4->F4_LFIPI=="I","02","03"))
					ITE->CONTAB		:=	""
					ITE->VALUBRU	:=	SD1->D1_VUNIT
					MSunlock()

					nTotBsIpi	+=	if(SF4->F4_LFIPI=="T",SD1->D1_BASEIPI,0)
					nTotIsIpi	+=	if(SF4->F4_LFIPI=="I",SD1->D1_BASEIPI,0)
					nTotOtIpi	+=	if(SF4->F4_LFIPI=="O",SD1->D1_BASEIPI,0)
					nTotVlIpi	+=	if(SF4->F4_LFIPI=="T",SD1->D1_VALIPI,0)

			   	   If !(PRO->(dbSeek(PADR(SD1->D1_COD,30))))
			          RECLOCK("PRO",.T.)
				      PRO->TIPOREG	:=	30
				      PRO->CODPROD	:=	SB1->B1_COD
				      PRO->CODBAR	:=	SB1->B1_CODBAR
				      PRO->DESCRI	:=	SB1->B1_DESC
				      PRO->UNIDADE	:=	RetUnid(SB1->B1_UM, SB1->B1_SEGUM)
				      PRO->POSIPI	:=	SB1->B1_POSIPI
			 	      PRO->FILIAL	:=	SB1->B1_FILIAL
				      MSunlock()
			       Endif

                   If SD1->D1_TIPO=="D"
			   	      If !(DFR->(dbSeek(SD1->D1_FILIAL+PADR(SD1->D1_DOC,10)+SD1->D1_SERIE+cCNPJ)))
			             RECLOCK("DFR",.T.)
				         DFR->TIPOREG		:="67"
					     DFR->MODELO		:=cModelo
					     DFR->SERIE			:=SD1->D1_SERIE
					     DFR->SDOC			:=SerieNfId("SD1",2,"D1_SERIE")
					     DFR->SUBSER		:=""
					     DFR->NUMINI		:=SD1->D1_DOC
					     DFR->NUMFIM		:=SD1->D1_DOC
					     DFR->CNPJ			:=cCNPJ
					     DFR->TIPO			:="2"
					     DFR->MOTIVO		:="07"
					     DFR->SITUACAO		:="01"
			 	         DFR->FILIAL		:=SD1->D1_FILIAL
			 	         DFR->AIDF			:=GETNEWPAR("MV_AIDF","00200000001")
			 	         DFR->CNPJ			:=cCNPJ
				         MSunlock()
			          Endif
			       ElseIf SD1->D1_TIPO=="I" .Or. SD1->D1_TIPO=="P"
			   	      If !(DFR->(dbSeek(SD1->D1_FILIAL+PADR(SD1->D1_DOC,10)+SD1->D1_SERIE+cCNPJ)))
			             RECLOCK("DFR",.T.)
				         DFR->TIPOREG		:="67"
					     DFR->MODELO		:=cModelo
					     DFR->SERIE			:=SD1->D1_SERIE
					     DFR->SDOC			:=SerieNfId("SD1",2,"D1_SERIE")
					     DFR->SUBSER		:=""
					     DFR->NUMINI		:=SD1->D1_DOC
					     DFR->NUMFIM		:=SD1->D1_DOC
					     DFR->CNPJ			:=cCNPJ
					     DFR->TIPO			:="2"
					     DFR->MOTIVO		:="03"
					     DFR->SITUACAO		:="01"
			 	         DFR->FILIAL		:=SD1->D1_FILIAL
			 	         DFR->AIDF			:=GETNEWPAR("MV_AIDF","00200000001")
			 	         DFR->CNPJ			:=cCNPJ
				         MSunlock()
			          Endif
			       Else
			       		For nI := 1 To Len (GetNewPar ("MV_SISIFD1",""))
			       			If (SubStr (GetNewPar ("MV_SISIFD1",""), nI, 1))=="-"
			       				If (AllTrim (SD1->D1_CF)$SubStr (GetNewPar ("MV_SISIFD1",""), nI-4, 4))
									If !(DFR->(DbSeek (SD1->D1_FILIAL+Padr (SD1->D1_DOC, 10)+SD1->D1_SERIE+cCNPJ)))
										RecLock ("DFR", .T.)
											DFR->TIPOREG	:=	"67"
									     	DFR->MODELO		:=	cModelo
									     	DFR->SERIE		:=	SD1->D1_SERIE
									     	DFR->SDOC			:=SerieNfId("SD1",2,"D1_SERIE")
									     	DFR->SUBSER		:=	""
									     	DFR->NUMINI		:=	SD1->D1_DOC
									     	DFR->NUMFIM		:=	SD1->D1_DOC
									     	DFR->CNPJ		:=	cCNPJ
									     	DFR->TIPO		:=	"2"
									     	DFR->MOTIVO		:=	SubStr (GetNewPar ("MV_SISIFD1",""), nI+1, 2)
									     	DFR->SITUACAO	:=	"01"
									 	    DFR->FILIAL		:=	SD1->D1_FILIAL
									 	    DFR->AIDF		:=	GetNewPar ("MV_AIDF", "00200000001")
									 	    DFR->OBSERV		:=	Iif ("99"$SubStr (GetNewPar ("MV_SISIFD1",""), nI+1, 2) .And. "B"$SD1->D1_TIPO, "BENEFICIAMENTO", "")
								 	        DFR->CNPJ	:=cCNPJ
										MSunlock ()
										//
										Exit
									Endif
			       				EndIf
			       			EndIf
			       		Next
			       Endif
				ENDIF
				SD1->(dbSkip())
			EndDo
		else
			While SD2->(!eof()).and.SD2->D2_FILIAL+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA==xFilial("SD2")+cSeek
				SB1->(dbSeek(xFilial("SB1")+SD2->D2_COD))
				SF4->(dbSeek(xFilial("SF4")+SD2->D2_TES))
				IF ITE->(!dbSeek(cTipoReg+DTOS(SF3->F3_ENTRADA)+PADR(SF3->F3_NFISCAL,10)+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA+PADR(SD2->D2_COD,30)+SD2->D2_CF+StrZero(nItens+1,4))) .And. lFirst
				   RECLOCK("ITE",.T.)
				   ITE->TIPOREG	:=	cTipoReg
				   ITE->ENTRADA	:=	SF3->F3_ENTRADA
				   ITE->NFISCAL	:=	SF3->F3_NFISCAL
				   ITE->SERIE 		:=	SF3->F3_SERIE
				   ITE->SDOC 			:=	SerieNfId("SF3",2,"F3_SERIE")
				   ITE->CLIEFOR	:=	SF3->F3_CLIEFOR
				   ITE->LOJA		:=	SF3->F3_LOJA
				   nItens++
				   ITE->NUMITEM	:=	strzero(nItens,4)
				   ITE->PRODUTO	:=	SD2->D2_COD
				   ITE->QUANTID	:=	SD2->D2_QUANT
				   ITE->VALUNIT	:=	SD2->D2_PRCVEN
				   ITE->UNIDADE	:=	SD2->D2_UM
				   ITE->QTDPADR	:=	Iif (Empty (SD2->D2_SEGUM), SD2->D2_QUANT, SD2->D2_QTSEGUM)
				   ITE->VALPADR	:=	Iif (Empty (SD2->D2_SEGUM), SD2->D2_PRCVEN, (SD2->D2_TOTAL/SD2->D2_QTSEGUM))
				   ITE->CFOP	:=	SD2->D2_CF
					ITE->CST		:=	StrZero (Val (AllTrim (SB1->B1_ORIGEM)+AllTrim (SF4->F4_SITTRIB)), 3)
				   ITE->CSTECF		:=	""
				   ITE->BASEICM	:=	if(SF4->F4_LFICM=="T",SD2->D2_BASEICM,0)
				   ITE->VALICM		:=	if(SF4->F4_LFICM=="T",SD2->D2_VALICM,0)
				   ITE->BASERET	:=	SD2->D2_BRICMS
				   ITE->VALRET		:=	SD2->D2_ICMSRET
				   ITE->TIPOICM	:=	If(SD2->D2_ICMSRET>0,"03","")
				   ITE->BASEIMP	:=	0
				   ITE->VALIMPO	:=	0
				   ITE->TIPOIMP	:=	""
				   ITE->CODICM		:=	""
				   ITE->BASEIPI	:=	if(SF4->F4_LFIPI=="T",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
				   ITE->ISENIPI	:=	if(SF4->F4_LFIPI=="I",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
				   ITE->OUTRIPI	:=	if(SF4->F4_LFIPI=="O",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
				   ITE->VALIPI		:=	if(SF4->F4_LFIPI=="T",SD2->D2_VALIPI,0)
				   ITE->CODIPI		:=	IF(SF4->F4_LFIPI=="T","01",IF(SF4->F4_LFIPI=="I","02","03"))
				   ITE->CONTAB		:=	""
				   ITE->VALUBRU	:=	SD2->D2_PRUNIT
				   MSunlock()

				   	nTotBsIpi	+=	if(SF4->F4_LFIPI=="T",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
					nTotIsIpi	+=	if(SF4->F4_LFIPI=="I",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
					nTotOtIpi	+=	if(SF4->F4_LFIPI=="O",SD2->D2_VALIPI/(SD2->D2_IPI/100),0)
					nTotVlIpi	+=	if(SF4->F4_LFIPI=="T",SD2->D2_VALIPI,0)

			   	   If !(PRO->(dbSeek(PADR(SD2->D2_COD,30))))
			          RECLOCK("PRO",.T.)
				      PRO->TIPOREG		:=30
				      PRO->CODPROD		:=SB1->B1_COD
				      PRO->CODBAR		:=SB1->B1_CODBAR
				      PRO->DESCRI		:=SB1->B1_DESC
				      PRO->UNIDADE		:=RetUnid(SB1->B1_UM, SB1->B1_SEGUM)
				      PRO->POSIPI		:=SB1->B1_POSIPI
				      PRO->FILIAL		:=SB1->B1_FILIAL
				      MSunlock()
			       Endif
					If SD2->D2_TIPO=="D"
			   	      If !(DFR->(dbSeek(SD2->D2_FILIAL+PADR(SD2->D2_DOC,10)+SD2->D2_SERIE+cCNPJ)))
			             RECLOCK("DFR",.T.)
				         DFR->TIPOREG		:="67"
					     DFR->MODELO		:=cModelo
					     DFR->SERIE			:=SD2->D2_SERIE
					     DFR->SDOC			:=SerieNfId("SD2",2,"D2_SERIE")
					     DFR->SUBSER		:=""
					     DFR->NUMINI		:=SD2->D2_DOC
					     DFR->NUMFIM		:=SD2->D2_DOC
					     DFR->CNPJ			:=cCNPJ
					     DFR->TIPO			:="2"
					     DFR->MOTIVO		:="10"
					     DFR->SITUACAO		:="01"
			 	         DFR->FILIAL		:=SD2->D2_FILIAL
			 	         DFR->AIDF			:=GETNEWPAR("MV_AIDF","00200000001")
			 	         DFR->CNPJ			:=cCNPJ
				         MSunlock()
			          Endif
			       ElseIf SD2->D2_TIPO=="I" .Or. SD2->D2_TIPO=="P"
			   	      If !(DFR->(dbSeek(SD2->D2_FILIAL+PADR(SD2->D2_DOC,10)+SD2->D2_SERIE+cCNPJ)))
			             RECLOCK("DFR",.T.)
				         DFR->TIPOREG		:="67"
					     DFR->MODELO		:=cModelo
					     DFR->SERIE			:=SD2->D2_SERIE
					     DFR->SDOC			:=SerieNfId("SD2",2,"D2_SERIE")
					     DFR->SUBSER		:=""
					     DFR->NUMINI		:=SD2->D2_DOC
					     DFR->NUMFIM		:=SD2->D2_DOC
					     DFR->CNPJ			:=cCNPJ
					     DFR->TIPO			:="2"
					     DFR->MOTIVO		:="03"
					     DFR->SITUACAO		:="01"
			 	         DFR->FILIAL		:=SD2->D2_FILIAL
			 	         DFR->AIDF			:=GETNEWPAR("MV_AIDF","00200000001")
			 	         DFR->CNPJ			:=cCNPJ
				         MSunlock()
			          Endif
			       Else
			       		For nI := 1 To Len (GetNewPar ("MV_SISIFD2",""))
			       			If (SubStr (GetNewPar ("MV_SISIFD2",""), nI, 1))=="-"
			       				If (AllTrim (SD2->D2_CF)$SubStr (GetNewPar ("MV_SISIFD2",""), nI-4, 4))
									If !(DFR->(DbSeek (SD2->D2_FILIAL+Padr (SD2->D2_DOC, 10)+SD2->D2_SERIE+cCNPJ)))
										RecLock ("DFR", .T.)
											DFR->TIPOREG	:=	"67"
									     	DFR->MODELO		:=	cModelo
									     	DFR->SERIE		:=	SD2->D2_SERIE
									     	DFR->SDOC			:=SerieNfId("SD2",2,"D2_SERIE")
									     	DFR->SUBSER		:=	""
									     	DFR->NUMINI		:=	SD2->D2_DOC
									     	DFR->NUMFIM		:=	SD2->D2_DOC
									     	DFR->CNPJ		:=	cCNPJ
									     	DFR->TIPO		:=	"2"
									     	DFR->MOTIVO		:=	SubStr (GetNewPar ("MV_SISIFD2",""), nI+1, 2)
									     	DFR->SITUACAO	:=	"01"
									 	    DFR->FILIAL		:=	SD2->D2_FILIAL
									 	    DFR->AIDF		:=	GetNewPar ("MV_AIDF", "00200000001")
									 	    DFR->OBSERV		:=	Iif ("99"$SubStr (GetNewPar ("MV_SISIFD2",""), nI+1, 2) .And. "B"$SD2->D2_TIPO, "BENEFICIAMENTO", "")
								 	        DFR->CNPJ			:=cCNPJ
										MSunlock ()
										//
										Exit
									Endif
			       				EndIf
			       			EndIf
			       		Next
			       Endif
				ENDIF
				SD2->(dbSkip())
			EndDo
    	Endif

    	If !SEG->(DbSeek (cTipoReg+DTOS(SF3->F3_ENTRADA)+SF3->F3_NFISCAL+Space (10-Len (SF3->F3_NFISCAL))+SF3->F3_SERIE))
			RECLOCK("SEG",.T.)
			SEG->TIPOREG	:= 	cTipoReg
			SEG->SERIE		:=	SF3->F3_SERIE
			SEG->SDOC		:=	SerieNfId("SF3",2,"F3_SERIE")
			SEG->SUBSER		:=	"   "
			SEG->NFISCAL	:=	SF3->F3_NFISCAL
			SEG->ENTRADA	:=	SF3->F3_ENTRADA
			SEG->CLIEFOR	:=	SF3->F3_CLIEFOR
			SEG->LOJA		:=	SF3->F3_LOJA
			SEG->FORMUL		:=	SF3->F3_FORMUL
	        MsUnlock()
        EndIf
		//
		If !(PAR->(DbSeek (cTipoReg+DTOS(SF3->F3_ENTRADA)+SF3->F3_NFISCAL+Space (4)+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA))) .And. (!"CANCELAD"$SF3->F3_OBSERV)
			RECLOCK("PAR",.T.)
				PAR->TIPOREG	:=	cTipoReg
				PAR->ENTRADA	:= 	SF3->F3_ENTRADA
				PAR->NFISCAL	:=	SF3->F3_NFISCAL
				PAR->SERIE		:=	SF3->F3_SERIE
				PAR->SDOC		:=	SerieNfId("SF3",2,"F3_SERIE")
				PAR->CLIEFOR	:= 	SF3->F3_CLIEFOR
				PAR->LOJA		:= 	SF3->F3_LOJA
				if cTipoMov == "E"
					if SF3->F3_FORMUL =="S"
						PAR->CONDIC	:=	"02"
					Else
						PAR->CONDIC	:= 	"01"
					Endif
					If SF3->F3_TIPO $"BD"
						SA1->(dbSeek(xFilial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
						PAR->CNPJ 		:=	if(SA1->A1_TIPO=="X","",SA1->A1_CGC)
						PAR->RAZASO		:=	SA1->A1_NOME
						PAR->UF			:=	SA1->A1_EST
						PAR->SUFRAMA	:=	SA1->A1_SUFRAMA
						PAR->CGF		:=	If("ISENT"$UPPER(SA1->A1_INSCR),"",SA1->A1_INSCR)
					Else
						SA2->(dbSeek(xFilial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
						PAR->CNPJ 		:=	if(SA2->A2_TIPO=="X","",SA2->A2_CGC)
						PAR->RAZASO		:=	SA2->A2_NOME
						PAR->UF			:=	SA2->A2_EST
						PAR->CGF		:=	If("ISENT"$UPPER(SA2->A2_INSCR),"",SA2->A2_INSCR)
					EndIf
				else
					PAR->CONDIC		:= 	"03"
					If SF3->F3_TIPO $"BD"
						SA2->(dbSeek(xFilial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
						PAR->CNPJ 		:=	SA2->A2_CGC
						PAR->RAZASO		:=	SA2->A2_NOME
						PAR->UF			:=	SA2->A2_EST
						PAR->CGF		:=	If("ISENT"$UPPER(SA2->A2_INSCR),"",SA2->A2_INSCR)
					Else
						SA1->(dbSeek(xFilial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
						PAR->CNPJ 		:=	SA1->A1_CGC
						PAR->RAZASO		:=	SA1->A1_NOME
						PAR->UF			:=	SA1->A1_EST
						PAR->SUFRAMA	:=	SA1->A1_SUFRAMA
						PAR->CGF		:=	If("ISENT"$UPPER(SA1->A1_INSCR),"",SA1->A1_INSCR)
					EndIf
				EndIf
			MsUnlock()
		EndIf
		cCgc	:= PAR->CNPJ
	EndIf

	If TOT->(!dbseek(cTipoReg+DTOS(SF3->F3_ENTRADA)+PADR(SF3->F3_NFISCAL,10)+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		RECLOCK("TOT",.T.)
		TOT->TIPOREG	:= 	cTipoReg
		TOT->ENTRADA	:=	SF3->F3_ENTRADA
		TOT->NFISCAL	:=	SF3->F3_NFISCAL
		TOT->SERIE		:=	SF3->F3_SERIE
		TOT->SDOC		:=	SerieNfId("SF3",2,"F3_SERIE")
		TOT->CLIEFOR	:=	SF3->F3_CLIEFOR
		TOT->LOJA		:= 	SF3->F3_LOJA
		TOT->ITENS		:=	nItens
		TOT->VALPRO    	:=	If(cTipoMov == "E",SF1->F1_VALMERC,SF2->F2_VALMERC)
		TOT->VALFRE		:=	If(cTipoMov == "E",SF1->F1_FRETE,SF2->F2_FRETE)
		TOT->VALDESP	:=	If(cTipoMov == "E",SF1->F1_DESPESA,SF2->F2_DESPESA)
		TOT->VALSEG		:=	If(cTipoMov == "E",SF1->F1_SEGURO,SF2->F2_SEGURO)
		TOT->VALCONT	:=	0
		TOT->BASEICM	:=	0
		TOT->VALICM		:=	0
		TOT->ISENICM	:=	0
		TOT->OUTRICM	:=	0
		TOT->BASEANT	:=	0
		TOT->VALANTE	:=	0
		TOT->BASEST		:=	0
		TOT->VALST		:=	0
		TOT->DIFALIQ	:=	0
		TOT->BASEIPI	:=	0
		TOT->ISENIPI	:=	0
		TOT->OUTRIPI	:=	0
		TOT->VALIPI		:=	0
	else
		RECLOCK("TOT",.F.)
	EndIf
	TOT->VALCONT	+=	IIf(cTipoMov == "E", Iif (SF1->F1_TIPO=="P", 0, SF3->F3_VALCONT), Iif (SF2->F2_TIPO=="P", 0, SF3->F3_VALCONT))
	TOT->BASEICM	+=	SF3->F3_BASEICM
	TOT->VALICM		+=	SF3->F3_VALICM
	TOT->ISENICM	+=	SF3->F3_ISENICM
	TOT->OUTRICM	+=	SF3->F3_OUTRICM
	TOT->BASEANT	+=	0
	TOT->VALANTE	+=	0
	If cPaisLoc $ "ANG|ARG|BOL|BRA|CHI|COS|DOM|EQU|EUA|HAI|MEX|PAD|PAN|PAR|POR|PTG|RUS|SAL|URU|VEN"
		TOT->BASEST		+=	SF3->F3_BASERET
	EndIf
	TOT->VALST		+= 	SF3->F3_ICMSRET
	TOT->DIFALIQ	+= 	0
	TOT->BASEIPI	+=	nTotBsIpi
	TOT->ISENIPI	+=	nTotIsIpi
	TOT->OUTRIPI	+=	nTotOtIpi
	TOT->VALIPI		+=	nTotVlIpi
	nItens	:= 0
	MsUnlock()
	lFirst := .F.
	SF3->(dbSkip())
	If cSeek <>	SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA
		lFirst := .T.
	Endif
EndDo

Return(.t.)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao	 ณaArq76    บAutor  ณGustavo G. Rueda    บ Data ณ  24/05/04   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Grava os dados no arquivo temporario do registro 76        บฑฑ
ฑฑบ          ณ Somente para NF de Conta de Energia Eletrica               บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function aArq76 (cNome, cUf, cFone, cSeek)
Local	nPosNumCont		:=	0
Local	nPosClasseCons	:=	0
Local	nPosConsFat		:=	0
Local	nConsFat		:=	0

If GetNewPar ("MV_NCONT", "XXX")<>"XXX" .And. GetNewPar ("MV_CLASSEC", "XXX")<>"XXX" .And. GetNewPar ("MV_CONSFAT", "XXX")<>"XXX"
	nPosNumCont		:=	Iif (cTipoMov=="E", SA2->(FieldPos (&(GetNewPar ("MV_NCONT", ""))[1])), SA1->(FieldPos (&(GetNewPar ("MV_NCONT", ""))[2])))
	nPosClasseCons	:=	Iif (cTipoMov=="E", SA2->(FieldPos (&(GetNewPar ("MV_CLASSEC", ""))[1])), SA1->(FieldPos (&(GetNewPar ("MV_CLASSEC", ""))[2])))
	nPosConsFat		:=	Iif (cTipoMov=="E", SD1->(FieldPos (&(GetNewPar ("MV_CONSFAT", ""))[1])), SD2->(FieldPos (&(GetNewPar ("MV_CONSFAT", ""))[2])))
EndIf

If (cTipoMov=="E")
	Do While !SD1->(Eof ()) .And. cSeek==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA .And. nPosConsFat<>0
		nConsFat	+=	SD1->(FieldGet (nPosConsFat))
		SD1->(DbSkip ())
	EndDo
	//
	SD1->(DbSetOrder(1))
	SD1->(MsSeek(xFilial("SD1")+cSeek))
Else
	Do While !SD2->(Eof ()) .And. cSeek==SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA .And. nPosConsFat<>0
		nConsFat	+=	SD2->(FieldGet (nPosConsFat))
		SD2->(DbSkip ())
	EndDo
	//
	SD2->(DbSetOrder(3))
	SD2->(MsSeek(xFilial("SD2")+cSeek))
EndIf
//
RECLOCK("R76",.T.)
R76->TIPOREG	:= 	cTipoReg
R76->OPERAC		:=	If(cTipoMov=="E","02","03")
R76->SERIE		:= 	SF3->F3_SERIE
R76->SDOC		:= 	SerieNfId("SF3",2,"F3_SERIE")
R76->SUBSER		:= 	""
R76->NFISCAL	:=	SF3->F3_NFISCAL
R76->NUMCONT	:=	Iif (nPosNumCont==0, 1, Iif (cTipoMov=="E", SA2->(FieldGet (nPosNumCont)), SA1->(FieldGet (nPosNumCont))))	//
R76->CFOP		:=	SF3->F3_CFO
R76->EMISSAO	:=	SF3->F3_EMISSAO
R76->ENTRADA	:= 	SF3->F3_ENTRADA
R76->VENCTO		:= 	SF3->F3_EMISSAO
R76->PERIODO	:=	SubStr (DToS (SF3->F3_ENTRADA),  1, 6)
R76->CLASSE		:=	Iif (nPosClasseCons==0, "001", Iif (cTipoMov=="E", SA2->(FieldGet (nPosClasseCons)), SA1->(FieldGet (nPosClasseCons))))	//
R76->CONDPAR	:=	if(cTipoMov=="E","01","03")
R76->CNPJCGF	:=	cCNPJ
R76->TIPIDEN	:=	If (Len (AllTrim (cCNPJ))<14, "3", "2")
R76->NOME		:=	cNome
R76->UF			:=	cUf
R76->CONSFAT	:=	nConsFat
R76->VALCONT 	:=	If(cTipoMov=="E",SF1->F1_VALBRUT,SF2->F2_VALBRUT)
R76->VALCONS	:=	If(cTipoMov=="E",SF1->F1_VALBRUT,SF2->F2_VALBRUT)
R76->VALDESP	:=	If(cTipoMov=="E",SF1->F1_DESPESA,SF2->F2_DESPESA)
R76->VALDESC	:=	If(cTipoMov=="E",SF1->F1_DESCONT,SF2->F2_DESCONT)
R76->BASEICM	:=	If(cTipoMov=="E",SF1->F1_BASEICM,SF2->F2_BASEICM)
R76->VALICM		:=	If(cTipoMov=="E",SF1->F1_VALICM,SF2->F2_VALICM)
R76->CODCONT	:=	""
R76->TXILUMI	:=	0
R76->TARIFA		:=	""
R76->INCRIC		:=	""
//
R76->CLIEFOR	:=	SF3->F3_CLIEFOR
R76->LOJA		:=	SF3->F3_LOJA
MsUnlock()
Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao	 ณaArq70    บAutor  ณAndreia dos Santos  บ Data ณ  10/11/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Grava os dados no arquivo temporario do registro 70        บฑฑ
ฑฑบ          ณ Somente para NF de Servico de Telecomunicacao              บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function aArq70 (cNome, cUf, cFone)
RECLOCK("TEL",.T.)
TEL->TIPOREG	:= 	cTipoReg
TEL->OPERAC		:=	if(cTipoMov=="E","04","05")
TEL->SDOC		:= 	SerieNfId("SF3",2,"F3_SERIE")
TEL->SERIE		:= 	SF3->F3_SERIE
TEL->SUBSER		:= 	""
TEL->NFISCAL	:=	SF3->F3_NFISCAL
TEL->TELEFON	:=	cFone
TEL->CFOP		:=	SF3->F3_CFO
TEL->EMISSAO	:=	SF3->F3_EMISSAO
TEL->ENTRADA	:= 	SF3->F3_ENTRADA
TEL->VENCTO		:= 	SF3->F3_EMISSAO
TEL->PERIODO	:=	SubStr (DToS (SF3->F3_ENTRADA),  1, 6)
TEL->CLASSE		:=	""
TEL->CONDPAR	:=	if(cTipoMov=="E","01","03")
TEL->CNPJCGF	:=	cCNPJ
TEL->TIPIDEN	:=	If (Len (AllTrim (cCNPJ))<14, "3", "2")
TEL->NOME		:=	cNome
TEL->UF			:=	cUf
TEL->VALCONT 	:=	If(cTipoMov=="E",SF1->F1_VALBRUT,SF2->F2_VALBRUT)
TEL->VALDESP	:=	If(cTipoMov=="E",SF1->F1_DESPESA,SF2->F2_DESPESA)
TEL->VALDESC	:=	If(cTipoMov=="E",SF1->F1_DESCONT,SF2->F2_DESCONT)
TEL->BASEICM	:=	If(cTipoMov=="E",SF1->F1_BASEICM,SF2->F2_BASEICM)
TEL->VALICM		:=	If(cTipoMov=="E",SF1->F1_VALICM,SF2->F2_VALICM)
TEL->CODCONT	:=	""
//
TEL->CLIEFOR	:=	SF3->F3_CLIEFOR
TEL->LOJA		:=	SF3->F3_LOJA
MsUnlock()

Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณaArqCab   บAutor  ณAndreia dos Santos  บ Data ณ  10/11/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ                                                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function aArqCab(cCNPJ)

RECLOCK("TRB",.T.)
TRB->TIPOREG	:=	cTipoReg
TRB->ENTRADA	:=	SF3->F3_ENTRADA
TRB->NFISCAL	:=	SF3->F3_NFISCAL
TRB->SERIE		:=	SF3->F3_SERIE
TRB->SDOC		:=	SerieNfId("SF3",2,"F3_SERIE")
TRB->CLIEFOR	:=	SF3->F3_CLIEFOR
TRB->LOJA   	:=	SF3->F3_LOJA
TRB->OPERAC		:=	Iif ("CANCELAD"$SF3->F3_OBSERV, "08", cOperac)
TRB->MODELO  	:=	if("CF"$SF3->F3_ESPECIE .OR. "ECF"$SF3->F3_ESPECIE,"37",cModelo)
TRB->SUBSER		:= ""
TRB->CFOP		:= SF3->F3_CFO
TRB->EMISSAO	:= SF3->F3_EMISSAO
TRB->CAIXA		:= SF3->F3_PDV
if cTipoMov=="E"
	TRB->TIPFRET	:=	if(SF1->F1_FRETE>0,"1","2")
else
	TRB->TIPFRET	:=	if(SF2->F2_FRETE>0,"1","2")
EndIf
TRB->FATURA		:=	cFatura
TRB->SITUACA	:=	 Iif ("CANCELAD"$SF3->F3_OBSERV, "06", "00")
TRB->CTACONT	:=	""
TRB->AIDF		:=	GETNewPar("MV_AIDF","00200000001")
TRB->AUTGNRE  	:=	""
TRB->MUNICIP	:=	""
TRB->CNPJ		:=	cCNPJ

MSunlock()
Return


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณAPURAICM  บAutor  ณAndreia dos Santos  บ Data ณ  13/11/00   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณLe o arquivo de apuracao do ICMS                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function APURAICM()

LOCAL cNomeArq	:=""
LOCAL aArquivos
LOCAL i
LOCAL j
LOCAL cConteudo
LOCAL nPos
LOCAL cValor
LOCAL cCampo
LOCAL cLinha



aIC	:=	Afill(aIC,0)

cNomeArq	:=	ANomeArqIC()
cNomeArq	:=	Substr(cNomeArq,1,at(".",cNomeArq)- 1 )+".IC*"

aArquivos:=	Directory(cNomeArq)

if ProcName(1) == "R972IMP"
	setregua(Len(aArquivos))
Else
	ProcRegua(Len(aArquivos))
Endif
For i:=1 to Len(aArquivos)
	if ProcName(1) == "R972IMP"
		IncRegua()
	else
		#IFNDEF WINDOWS
			IncProc(17,4)
		#ELSE
			IncProc()
		#ENDIF
	EndIf

	cConteudo:=	MemoRead(aArquivos[i,1])
	aCampos	:=	{"001","002","003","004","005","006","007","008","009","010","012","IND"}
	For j:=1 to MLCount(cConteudo,254)
		cLinha	:=	MemoLine(cConteudo,254,j)
		cCampo	:=	Substr(cLinha,1,3)
		nPos		:=	Ascan(aCampos,{|x|x==cCampo})
		If nPos==0
			Loop
		Endif
		If aCampos[nPos]=="IND"
			cValor:=	Alltrim(Substr(cLinha,5,5))
			nInd	:=	Val(cValor)
		Else
			cValor:=	Alltrim(Substr(cLinha,52,18))
			cValor:=	StrTran(cValor,".")
			cValor:=	StrTran(cValor,",",".")
			cCampo:=	"n"+cCampo
			&cCampo.:=	Val(cValor)
		Endif
		aCampos[nPos]:=	NIL
	Next j
	If i>1
		n010	-=	n009
		n009	:=	0
	Endif
	aIC[1]	+=	n001		//Por saidas/prestacoes com debito do imposto
	aIC[2]	+=	n002		//Outros debitos
	aIC[3]	+=	n003		//Estornos de creditos
	aIC[4]	+=	n004		//Total
	aIC[5]	+=	n005  		//Por entradas/aquisicoes com credito do imposto
	aIC[6]	+=	n006		//Outros creditos
	aIC[7]	+=	n007		//Estornos de debitos
	aIC[8]	+=	n008		//Subtotal
	aIC[9]	+=	n009		//Saldo credor do periodo anterior
	aIC[10]	+=	n010		//Total do Credito
	aIC[11]	+=	n011		//Saldo Devedor
	aIC[12]	+=	n012		//Deducoes
	aIC[14]	+=	n014		//Saldo Credor
	aIC[15]	:=	nInd
Next i

aIC[11]	:=	Max(0,aIC[4]-aIC[10])
aIC[13]	:=	Max(0,aIC[11]-aIC[12])
aIC[14]	:=	Max(0,aIC[10]-aIC[4])

Return(aIC)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออัออออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao  ณANomeArqIC  บAutor  ณMicrosiga           บ Data ณ  06/30/00   บฑฑ
ฑฑฬออออออออุออออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.   ณRetorna o nome do arquivo de apuracao                         บฑฑ
ฑฑบ        ณ                                                              บฑฑ
ฑฑฬออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso     ณGenerico                                                      บฑฑ
ฑฑศออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION ANomeArqIC()

LOCAL cNomeArq  := ""
LOCAL cMeses	:=	"ABCDEFGHIJKL"
LOCAL nMes		:=	month(MV_PAR01)
LOCAL nAno		:=	year(MV_PAR01)
Local cNrLivro	:= MV_PAR08

cNomeArq	:=	If(cNrLivro == "*" ,"A" , cNrLivro)
cNomeArq	:=	If(cNomeArq == " " ,"_" , cNomeArq)
cNomeArq	+=	Substr(cMeses,nMes,1)
cNomeArq	+=	substr(strzero(nAno,4),3,2)
cNomeArq	+=	FWGrpCompany()+FWCodFil()
cNomeArq	+=	".TXT"

Return(cNomeArq)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณ ArqDMA   บAutor  ณAline Correa do Valeบ Data ณ  28/09/01   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Gera arquivo temporario de NF's por Estado                 บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ArqDMA(nMes,nAno)
Local aCampos		:= {}
Local lItens		:= .F.
Local cUF			:= SuperGetMv("MV_ESTADO",,.F.)
Local cRegistro 	:= ""
Local cCFOCFP   	:= ""
Local nVRetRemE 	:= 0
Local nVRetRemS 	:= 0
Local cInscr		:= ""
Local cTipo 		:= ""
Local cNumDet   	:= ""
LocaL nVTotalE 	    := 0
Local nVCompAtv	    := 0
Local nVTotalS      := 0
Local nVAqMat	    := 0
Local nVTrnsfAe		:= 0
Local nVTrnsfMe		:= 0
Local nVTrnsfAs		:= 0
Local nVTrnsfMs		:= 0
Local nVOtOpE       := 0
Local nVOtOpS       := 0
Local nVTotDif      := 0
Local nVTotsubE     := 0
Local nVTotsubS     := 0
Local nVIcmImp   	:= 0
Local nTIcAtvSU		:= 0
Local nTIcAtvNO		:= 0
Local nTIcAtv		:= 0
Local nTIcMatSU		:= 0
Local nTIcMatNO		:= 0
Local nTIcMat 	    := 0
Local nBasCale  	:= 0
Local nBasCalIe 	:= 0
Local nBasCalOe 	:= 0
Local nBasCals  	:= 0
Local nBasCalIs 	:= 0
Local nBasCalOs 	:= 0
Local aApuIcm 		:= {}
Local nCofins		:= 0
Local nTotDeb		:= 0
Local nTotCred		:= 0
Local nSldCred 		:= 0
Local nSldDeb  		:= 0
Local cAliasSF3     := "SF3"
Local lQuery        := .F.
Local aStruSF3  	:= {}
Local cQuery 		:= ""
Local cIndSF3		:= ""
Local cChave		:= ""
Local cFiltro		:= ""
Local aTotais		:= {}
Local nResDif		:= 0
Local nSaiTrib		:= 0
Local nOutSai  		:= 0
Local nEstCred 		:= 0
Local nEntTrib 		:= 0
Local nOutCred 		:= 0
Local nEstDeb  		:= 0
Local nSdCdAnt 		:= 0
Local ndeducao 		:= 0
Local nImpRec  		:= 0
Local nSf3			:= 0
Local lContrib      := .F.
Local lAglut		:= .F.
Local aEmpresa		:= {}
Local nEmpresa		:= 1
Local nVez			:= 0
Local nX			:= 0
Local nY			:= 0
Local aDadAdi		:= {}
Local cAlsCKR		:= GetNextAlias()
Local cAlsF2R		:= GetNextAlias()
Local cAlsF2P		:= GetNextAlias()
Local cAlsCE5		:= GetNextAlias()
Local cAlsCE6		:= GetNextAlias()
Local lTabF2R		:= AliasIndic("F2R")
Local lQuadr1920	:= .T.
Local aCdLancOri	:= {}
Local nPosCdLanc	:= 0
Local cQuadro		:= ''
Local cPerAnt		:= ''
Local nSldAntExp	:= 0
Local nSldAntDIO	:= 0
Local nGerCredEd	:= 0
Local nGerCredEi	:= 0
Local nGerCredDf	:= 0
Local nGerCredIs	:= 0
Local nGerCredRd	:= 0
Local nGerCredOM	:= 0
Local nUtPgICMEx	:= 0
Local nUtTrOutEx	:= 0
Local nUtImpMEEx	:= 0
Local nUtDenEsEx	:= 0
Local nUtAuFisEx	:= 0
Local nUtTrTerEx	:= 0
Local nUtPgICMDI	:= 0
Local nUtImpMEDI	:= 0
Local nUtDenEsDI	:= 0
Local nUtAuFisDI	:= 0
Local nUtTransDI	:= 0

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTotalizador da NF.Reg 08 e 09 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos := {}
AADD(aCampos,{"TIPOREG","C",002,0})
AADD(aCampos,{"UF"     ,"C",002,0})
AADD(aCampos,{"VALNCONT","N",012,2})
AADD(aCampos,{"VALNBASE","N",012,2})
AADD(aCampos,{"VALCONT","N",012,2})
AADD(aCampos,{"VALBASE","N",012,2})
AADD(aCampos,{"VALOUTR","N",012,2})
AADD(aCampos,{"VALSUBP","N",012,2})
AADD(aCampos,{"VALSUBT","N",012,2})

TOTUF  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TOTUF,"TUF",.T.,.F.)
IndRegua("TUF",TOTUF,"TIPOREG+UF")
DbSelectArea("TUF")
DbClearIndex()
DbSetIndex(TOTUF+OrdBagExt())

aCampos := {}
AADD(aCampos,{"NUMDET" ,"C",001,0})
AADD(aCampos,{"TIPODET","C",002,0})
AADD(aCampos,{"ENTSAI" ,"C",001,0})
AADD(aCampos,{"VALCONT","N",012,2})
AADD(aCampos,{"VALBASE","N",012,2})
AADD(aCampos,{"ISENICM","N",012,2})
AADD(aCampos,{"VALOUTR","N",012,2})
TOTOPE  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TOTOPE,"OPE",.T.,.F.)
IndRegua("OPE",TOTOPE,"NUMDET+TIPODET+ENTSAI")
DbSelectArea("OPE")
DbClearIndex()
DbSetIndex(TOTOPE+OrdBagExt())


aCampos := {}
AADD(aCampos,{"TALIAS","C",001,0})
TEPALIAS  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TEPALIAS,"TEP",.T.,.F.)
IndRegua("TEP",TEPALIAS,"TALIAS")
DbSelectArea("TEP")
DbClearIndex()
DbSetIndex(TEPALIAS+OrdBagExt())

//Quadro 12
aCampos := {}
AADD(aCampos,{"NATUREZA" 	 ,"C",002,0})
AADD(aCampos,{"I_VALTRIB"	 ,"N",012,2})
AADD(aCampos,{"I_ISENICM"	 ,"N",012,2})
AADD(aCampos,{"I_OUTRICM"	 ,"N",012,2})
AADD(aCampos,{"I_VALTOTAL" 	 ,"N",012,2})
TOTINV  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TOTINV,"INV",.T.,.F.)
IndRegua("INV",TOTINV,"NATUREZA")
DbSelectArea("INV")
DbClearIndex()
DbSetIndex(TOTINV+OrdBagExt())

aCampos := {}
AADD(aCampos,{"NATUREZA" 	 ,"C",002,0})
AADD(aCampos,{"F_VALTRIB"	 ,"N",012,2})
AADD(aCampos,{"F_ISENICM"	 ,"N",012,2})
AADD(aCampos,{"F_OUTRICM"	 ,"N",012,2})
AADD(aCampos,{"F_VALTOTAL" 	 ,"N",012,2})
TOTINVF  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TOTINVF,"INVF",.T.,.F.)
IndRegua("INVF",TOTINVF,"NATUREZA")
DbSelectArea("INVF")
DbClearIndex()
DbSetIndex(TOTINVF+OrdBagExt())

aCampos := {}
AADD(aCampos,{"TPREG" 	,"C",002,0})
AADD(aCampos,{"VALBASE"	,"N",012,2})
AADD(aCampos,{"ISENICM"	,"N",012,2})
AADD(aCampos,{"VALOUTR"	,"N",012,2})
TOTMOVS  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TOTMOVS,"TAW",.T.,.F.)
IndRegua("TAW",TOTMOVS,"TPREG")
DbSelectArea("TAW")
DbClearIndex()
DbSetIndex(TOTMOVS+OrdBagExt())

For nX := 40 To 92
	RecLock("TAW",.T.)
	TAW->TPREG	 := Alltrim(Str(nX))
	TAW->VALBASE := 0
	TAW->ISENICM := 0
	TAW->VALOUTR := 0
	MsUnlock()
Next

#IFDEF TOP
lAglut	:= ( MV_PAR11 == 1 )		// Define se aglutina registros no grupo de perguntas DMABA1
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXฟ
//ณVariแvel Private declarada no MATA950, serve para sair do loop de filiais e ณ
//ณprocessar uma ๚nica vez, se utilizou a sele็ใo e aglutina็ใo de filiais.    ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXู

If lAglut
	For nVez := 1 to Len(aFilsCalc)
		If aFilsCalc[nVez][1]
			aAdd(aEmpresa,{ cEmpAnt, aFilsCalc[nVez][2]})
		EndIf
	Next
EndIf
lAglut		:= Iif(lAglut.And.Len(aEmpresa)>1,.T.,.F.)
lExitPFil	:= Len(aFilsCalc) > 0 .And. lAglut

If Len(aEmpresa) == 0
   	aAdd(aEmpresa, { cEmpAnt, cFilAnt } )
EndIf
aEmpresa := asort(aEmpresa,,,{|x,y| x[2] < y[2] })

While nEmpresa <=  len(aEmpresa)
	dbSelectArea("SM0")
	If dbSeek(aEmpresa[nEmpresa,1]+aEmpresa[nEmpresa,2],.T.)
		cFilAnt  := FWCodFil()

#ENDIF

#IFDEF TOP
		If TcSrvType() <> "AS/400"
			cAliasSF3:= "ArqDMA"
			lQuery    := .T.
			aStruSF3  := SF3->(dbStruct())
			cQuery := "SELECT SF3.F3_FILIAL,SF3.F3_ENTRADA,SF3.F3_DTCANC, "
			cQuery += "SF3.F3_TIPO,SF3.F3_CFO,SF3.F3_ESTADO,SF3.F3_VALCONT,SF3.F3_BASEICM, "
			cQuery += "SF3.F3_VALICM,SF3.F3_ISENICM,SF3.F3_OUTRICM,SF3.F3_ICMSRET,SF3.F3_CREDST, "
			cQuery += "SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_NFISCAL,SF3.F3_EMISSAO,SF3.F3_ICMSCOM, "
			cQuery += "SF3.F3_ESPECIE, SF3.F3_SERIE "
			cQuery += "FROM "
			cQuery += RetSqlName("SF3") + " SF3 "
			cQuery += "WHERE "
			cQuery += "SF3.F3_FILIAL = '"+xFilial("SF3")+"' AND "
			cQuery += "SF3.F3_ENTRADA >= '"+DTOS(dDmainc)+"' AND "
			cQuery += "SF3.F3_ENTRADA <= '"+DTOS(dDmaFin)+"' AND "
			cQuery += "SF3.F3_TIPO <> 'S' AND "
			cQuery += "SF3.D_E_L_E_T_ = ' ' "

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3,.T.,.T.)

			For nSF3 := 1 To Len(aStruSF3)
				If aStruSF3[nSF3][2] <> "C" .and. FieldPos(aStruSF3[nSF3][1]) > 0
					TcSetField(cAliasSF3,aStruSF3[nSF3][1],aStruSF3[nSF3][2],aStruSF3[nSF3][3],aStruSF3[nSF3][4])
				EndIf
			Next nSF3
		Else
#ENDIF
			dbSelectArea(cAliasSF3)
			cIndSF3	:=	CriaTrab(NIL,.F.)
			cChave	:=	IndexKey()
			cFiltro	:=	"F3_FILIAL=='"+xFilial()+"'"
			cFiltro	+=	" .And. DTOS(SF3->F3_ENTRADA)>='"+DTOS(dDmainc)+"' .AND. DTOS(SF3->F3_ENTRADA)<='"+DTOS(dDmaFin)+"' .AND. SF3->F3_TIPO<>'S'"
			IndRegua(cAliasSF3,cIndSF3,cChave,,cFiltro)
#IFDEF TOP
		Endif
#ENDIF

		While (cAliasSF3)->(!EOF()) .and. (cAliasSF3)->F3_FILIAL == xFilial("SF3") .and. _aTotal[9]
			cCFOCFP:=VerTpDet((cAliasSF3)->F3_CFO,.F.,"SIGADMA.CFP")
			If Empty(cCFOCFP)
				(cAliasSF3)->(dbSkip())
				Loop
			Endif
			If !EMPTY((cAliasSF3)->F3_DTCANC)
				(cAliasSF3)->(dbSkip())
				Loop
			EndIf
			cRegistro	:=If(substr(cCFOCFP,1,1)<"5","08","09")

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณ Verifica o cliente/fornecedor                                          ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If (SubStr((cAliasSF3)->F3_CFO,1,1)>="5" .And. (cAliasSF3)->F3_TIPO$"BD") .Or.;
			(SubStr((cAliasSF3)->F3_CFO,1,1)<"5" .And. !(cAliasSF3)->F3_TIPO$"BD")

				SA2->(MsSeek(F3Filial("SA2")+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA))
				cInscr		:=SA2->A2_INSCR
				cTipo		:=SA2->A2_TIPO
				lContrib := (!("ISENT" $Upper(cInscr))) .And. ( ! empty(cInscr) )
			Else
				SA1->(MsSeek(F3Filial("SA1")+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA))
				cInscr		:=SA1->A1_INSCR
				cTipo		:=SA1->A1_TIPO
				lContrib := (SA1->A1_CONTRIB == "1")
			EndIf

			/*
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณTotaliza็ใo por UF Entradas/Saํdas -  TIPOS 08/09ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			*/
			If substr(cCFOCFP,1,1) $"6,1"
				If TUF->(!dbseek(cRegistro+(cAliasSF3)->F3_ESTADO))
					RecLock("TUF",.T.)
					TUF->UF			:= (cAliasSF3)->F3_ESTADO
					TUF->TIPOREG	:= cRegistro

				Else
					RECLOCK("TUF",.F.)
				EndIf
				If (cCFOCFP == " " .or. "ISENT" $Upper(cInscr) .or. (empty(cInscr) .and. cTipo != "L")) .and. (cRegistro == "09") .and. !lContrib
					TUF->VALNCONT   += noRound((cAliasSF3)->F3_VALCONT ,2)
					TUF->VALNBASE   += noRound((cAliasSF3)->F3_BASEICM ,2)
				Else
					TUF->VALCONT	+=	noRound((cAliasSF3)->F3_VALCONT,2)
					TUF->VALBASE	+=	noRound((cAliasSF3)->F3_BASEICM,2)
				EndIf
				IF cCFOCFP == "012/112"
					TUF->VALSUBP	+=  noRound((cAliasSF3)->F3_ICMSRET,2)
				Else
					TUF->VALSUBT	+=  noRound((cAliasSF3)->F3_ICMSRET,2)
				EndIf
				TUF->VALOUTR	+=	noRound((cAliasSF3)->F3_OUTRICM,2)
				MsUnlock()
			Endif
			If cRegistro == "08"
				/*
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
				//ณTotaliza็ใo por Opera็๕es de Entrada - TIPO 10ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
				*/
				If !(cCFOCFP$"010,011,012,013,110,112,113,207")
					If cCFOCFP$"111"
					cChaveOp := substr(cCFOCFP,1,1)+'07'+"E"
					Else
					cChaveOp := substr(cCFOCFP,1,1)+substr(cCFOCFP,2,2)+"E"
					EndIf

					If OPE->(!dbseek(cChaveOp))
						RecLock("OPE",.T.)
						OPE->NUMDET  := substr(cCFOCFP,1,1)
						OPE->TIPODET := Iif(cCFOCFP$"111",'07',Substr(cCFOCFP,2,2))
						OPE->ENTSAI  := "E"
						OPE->VALCONT := (cAliasSF3)->F3_VALCONT
						OPE->VALBASE := (cAliasSF3)->F3_BASEICM
						OPE->ISENICM := (cAliasSF3)->F3_ISENICM
						OPE->VALOUTR := (cAliasSF3)->F3_OUTRICM
						MsUnlock()
					Else
						RecLock("OPE",.F.)
						OPE->VALCONT += noRound((cAliasSF3)->F3_VALCONT,2)
						OPE->VALBASE += noRound((cAliasSF3)->F3_BASEICM,2)
						OPE->ISENICM += noRound((cAliasSF3)->F3_ISENICM,2)
						OPE->VALOUTR +=	noRound((cAliasSF3)->F3_OUTRICM,2)
						MsUnlock()
					Endif
				EndIf
				Do Case
					Case cCFOCFP $ "007#107#204"
						nVCompAtv += (cAliasSF3)->F3_VALCONT * 100
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Compras para Ativo Imobilizado"
					Case cCFOCFP $ "008#108#205"
						nVAqMat	  += (cAliasSF3)->F3_VALCONT * 100
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Aquisi็ใo de Material para Uso ou Consumo"
					Case cCFOCFP $ "011#111"
						nVTrnsfAe += (cAliasSF3)->F3_VALCONT * 100
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Transfer๊ncias para Ativo Imob.
					Case cCFOCFP $ "010#110"
						nVTrnsfMe += (cAliasSF3)->F3_VALCONT * 100
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Transfer๊ncias Material de Uso Consumo
					Case cCFOCFP $ "009#109#206"
						nVOtOpE   += (cAliasSF3)->F3_VALCONT * 100     	// Valor "Outras" de entradas e aquisi็๕es nใo especificados
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100
					Case cCFOCFP $ "013#113#207"
						nVRetRemE += (cAliasSF3)->F3_VALCONT * 100     	// Valor Retorno de Industriliazao, conserto ou venda fora do estabelecimento
						nVTotalE  += (cAliasSF3)->F3_VALCONT * 100
				END
				Do Case
					Case cCFOCFP == "111#107" .and. (cAliasSF3)->F3_ESTADO $ "SP#RJ#ES#MG#RS#SC#PR"
						nTIcAtvSU +=	(cAliasSF3)->F3_VALICM * 100 //Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Sul/Sudeste
					Case cCFOCFP == "111#107" .and. !((cAliasSF3)->F3_ESTADO $"SP#RJ#ES#MG#RS#SC#PR")
						nTIcAtvNO +=	(cAliasSF3)->F3_VALICM * 100 //Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Norte/Nordeste/Centro-Oeste
					Case cCFOCFP $ "007#204#011"
						nTIcAtv +=	(cAliasSF3)->F3_VALICM * 100 	//Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Estado e do exterior
					Case cCFOCFP == "108#110" .and. (cAliasSF3)->F3_ESTADO $ "SP#RJ#ES#MG#RS#SC#PR"
						nTIcMatSU +=	(cAliasSF3)->F3_VALICM * 100 //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Sul/Sudeste
					Case cCFOCFP == "108#110" .and. !((cAliasSF3)->F3_ESTADO $"SP#RJ#ES#MG#RS#SC#PR")
						nTIcMatNO +=	(cAliasSF3)->F3_VALICM	* 100 //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Norte/Nordeste/Centro-Oeste
						Case cCFOCFP == "008#205#010"
						nTIcMat +=	(cAliasSF3)->F3_VALICM * 100 //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Estado e do Exterior
				END
				If Substr(cCFOCFP,1,1) == "2"
					nVIcmImp  += (cAliasSF3)->F3_VALICM
				Endif
				nBasCale  += 	(cAliasSF3)->F3_BASEICM * 100  //Valor do ICMS - Valores Fiscais - Base de Cแlculo
				nBasCalIe +=	(cAliasSF3)->F3_ISENICM * 100  //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
				nBasCalOe +=	(cAliasSF3)->F3_OUTRICM	* 100  //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
				nVTotDif  += 	(cAliasSF3)->F3_ICMSCOM * 100
				If (cAliasSF3)->F3_CREDST == "4" .And. Alltrim((cAliasSF3)->F3_ESPECIE) == "CTE"
					nVTotsubS += (cAliasSF3)->F3_ICMSRET * 100
				Else
					nVTotsubE += (cAliasSF3)->F3_ICMSRET * 100
				Endif
			Else
				/*
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
				//ณTotaliza็ใo por Opera็๕es de Saํda   - TIPO 11ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
				*/
				cNumDet := Iif(substr(cCFOCFP,1,1)=="5","0",Iif(substr(cCFOCFP,1,1)=="6","1","2")) + substr(cCFOCFP,2,2)
				If !(cCFOCFP$"508,509,510,608,609,610,705")
					If OPE->(!dbseek(substr(cNumDet,1,1)+substr(cNumDet,2,2)+"S"))
						RecLock("OPE",.T.)
						OPE->NUMDET  := cNumDet
						OPE->TIPODET := substr(cCFOCFP,2,2)
						OPE->ENTSAI  := "S"
						OPE->VALCONT := (cAliasSF3)->F3_VALCONT
						OPE->VALBASE := (cAliasSF3)->F3_BASEICM
						OPE->ISENICM := (cAliasSF3)->F3_ISENICM
						OPE->VALOUTR := (cAliasSF3)->F3_OUTRICM
						MsUnlock()
					Else
						RecLock("OPE",.F.)
						OPE->VALCONT += noRound((cAliasSF3)->F3_VALCONT,2)
						OPE->VALBASE += noRound((cAliasSF3)->F3_BASEICM,2)
						OPE->ISENICM += noRound((cAliasSF3)->F3_ISENICM,2)
						OPE->VALOUTR +=	noRound((cAliasSF3)->F3_OUTRICM,2)
						MsUnlock()
					Endif
				Endif
					Do Case
						Case cCFOCFP $ "508#608"
						nVTrnsfAs += (cAliasSF3)->F3_VALCONT * 100
						nVTotalS  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Transfer๊ncias para Ativo Imob.
					Case cCFOCFP $ "509#609"
						nVTrnsfMs += (cAliasSF3)->F3_VALCONT * 100
						nVTotalS  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Transfer๊ncias para Material de Uso Consumo
					Case cCFOCFP $ "507#607#704"
						nVOtOpS   += (cAliasSF3)->F3_VALCONT * 100
						nVTotalS  += (cAliasSF3)->F3_VALCONT * 100		// Valor "Outras" de entradas e aquisi็๕es nใo especificados
					Case cCFOCFP $ "510#610#705"
						nVRetRemS += (cAliasSF3)->F3_VALCONT * 100     	// Valor Retorno de Industriliazao, conserto ou venda fora do estabelecimento
						nVTotalS  += (cAliasSF3)->F3_VALCONT * 100
				END
				nVTotsubS += 	(cAliasSF3)->F3_ICMSRET * 100
				nBasCals  += 	(cAliasSF3)->F3_BASEICM	* 100 //Valor do ICMS - Valores Fiscais - Base de Cแlculo
				nBasCalIs +=	(cAliasSF3)->F3_ISENICM	* 100 //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
				nBasCalOs +=	(cAliasSF3)->F3_OUTRICM	* 100 //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
			EndIf
			// Armazeno os valores nos registros totalizadores
			If cPaisLoc == "BRA"
				If Substr((cAliasSF3)->F3_CFO,1,1) $ "5|6|7"
					dbSelectArea("SD2")
					dbSetOrder(3)
					If (SD2->(MsSeek(xFilial("SD2")+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA)))
						dbSelectArea("SF4")
						dbSetOrder(1)
						If SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES))
							dbSelectArea("TAW")
							dbSetOrder(1)
							If dbSeek(SF4->F4_TREGDMA)
								RecLock("TAW",.F.)
								TAW->VALBASE += (cAliasSF3)->F3_BASEICM
								TAW->ISENICM += (cAliasSF3)->F3_ISENICM
								TAW->VALOUTR += (cAliasSF3)->F3_OUTRICM
								MsUnlock()
							Endif
						Endif
					Endif
				ElseIf Substr((cAliasSF3)->F3_CFO,1,1) $ "1|2|3"
					dbSelectArea("SD1")
					dbSetOrder(1)
					If (SD1->(MsSeek(xFilial("SD1")+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA)))
						dbSelectArea("SF4")
						dbSetOrder(1)
						If SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
							dbSelectArea("TAW")
							dbSetOrder(1)
							If dbSeek(SF4->F4_TREGDMA)
								RecLock("TAW",.F.)
								TAW->VALBASE += (cAliasSF3)->F3_BASEICM
								TAW->ISENICM += (cAliasSF3)->F3_ISENICM
								TAW->VALOUTR += (cAliasSF3)->F3_OUTRICM
								MsUnlock()
							Endif
						Endif
					Endif
				Endif
			EndIf
			(cAliasSF3)->(dbSkip())
		EndDo

		//Processa Quadro 12
		IF MV_PAR13 == 1 .and. !empty(MV_PAR15)

			//Carrega Tipos de produto da rotina MATA965
			If File("SIGADMA.CFP")
				AAdd(aDadAdi,(VerTpDet("901",.F.,"SIGADMA.CFP")))     //Mercadorias 			[901]=ME
				AAdd(aDadAdi,(VerTpDet("902",.F.,"SIGADMA.CFP")))     //Materiais de Consumo 	[902]=MC
				AAdd(aDadAdi,(VerTpDet("903",.F.,"SIGADMA.CFP")))     //Mat้rias Primas			[903]=MP
				AAdd(aDadAdi,(VerTpDet("904",.F.,"SIGADMA.CFP")))     //Materiais Secundแrios	[904]=PI
				AAdd(aDadAdi,(VerTpDet("905",.F.,"SIGADMA.CFP")))     //Materiais de Embalagem	[905]=EM
				AAdd(aDadAdi,(VerTpDet("906",.F.,"SIGADMA.CFP")))     //Produ็ใo em Andamento 	[906]=PP
				AAdd(aDadAdi,(VerTpDet("907",.F.,"SIGADMA.CFP")))     //Produtos Acabados		[907]=PA
			Endif

			//Carrega tipo 12 com valor zero para todos os tipos.
			For nY := 1 to 7
				Reclock("INV",.T.)
				INV->NATUREZA 	:= cValtochar(nY)
				INV->I_VALTRIB  := 0
				INV->I_ISENICM  := 0
				INV->I_OUTRICM  := 0
				INV->I_VALTOTAL := 0
				MSunlock()

				Reclock("INVF",.T.)
				INVF->NATUREZA 	 := cValtochar(nY)
				INVF->F_VALTRIB  := 0
				INVF->F_ISENICM  := 0
				INVF->F_OUTRICM  := 0
				INVF->F_VALTOTAL := 0
				MSunlock()
			Next

			//Caso nใo exista estoque inicial processa somente Final
			If !empty(MV_PAR14)
				InvDMA("I",MV_PAR14,aDadAdi) //Data de fechamento Estoque Inicial
			Endif
			InvDMA("F",MV_PAR15,aDadAdi) //Data de fechamento Estoque Final

			INV->(dbGoTop())
			INVF->(dbGoTop())
		Endif

		If lQuery
			dbSelectArea(cAliasSF3)
			dbCloseArea()
		Endif
		dbSelectArea("SF3")
		RetIndex("SF3")
		If _aTotal[9]
			RecLock("TEP",.T.)
			TEP->TALIAS 	:= "S"
			MsUnlock()

			aApuIcm := FisApur("IC",nAno,nMes,2,0,"*",.F.,{},1,.F.,"")
			If Len(aApuIcm) > 0
				aEval(aApuIcm, {|b| nTotDeb  += Iif(Substr(Alltrim(b[1]),1,3)=="016" .or. Substr(Alltrim(b[1]),1,3)=="004" ,b[3],0)}) //Valor "Total do D้bito"
				aEval(aApuIcm, {|c| nTotCred += Iif(Substr(Alltrim(c[1]),1,3)=="010" ,c[3],0)}) //Valor "Total de Cr้dito"
				aEval(aApuIcm, {|d| nResDif  += Iif(Substr(Alltrim(d[1]),1,3)=="016" ,d[3],0)}) //Valor "Diferencial de Aliquota"
				aEval(aApuIcm, {|e| nSaiTrib += Iif(Substr(Alltrim(e[1]),1,3)=="001" ,e[3],0)}) //Valor "Saidas Tributadas"
				aEval(aApuIcm, {|x| nOutSai  += Iif(Substr(Alltrim(x[4]),1,6)=="002.00" .and. Substr(Alltrim(x[1]),1,3)=="002" ,x[3],0)}) //Valor "Outros D้bitos"
				aEval(aApuIcm, {|x| nEstCred += Iif(Substr(Alltrim(x[4]),1,6)=="003.00" .and. Substr(Alltrim(x[1]),1,3)=="003" ,x[3],0)}) //Valor "Estorno de Cr้dito"
				aEval(aApuIcm, {|x| nEntTrib += Iif(Substr(Alltrim(x[1]),1,3)=="005" ,x[3],0)}) //Valor "Entradas Tributadas"
				aEval(aApuIcm, {|x| nOutCred += Iif(Substr(Alltrim(x[4]),1,6)=="006.00" .and. Substr(Alltrim(x[1]),1,3)=="006" ,x[3],0)}) //Valor "Outros Cr้ditos"
				aEval(aApuIcm, {|x| nEstDeb  += Iif(Substr(Alltrim(x[4]),1,6)=="007.00" .and. Substr(Alltrim(x[1]),1,3)=="007" ,x[3],0)}) //Valor "Estorno de D้bito"
				aEval(aApuIcm, {|x| nSdCdAnt += Iif(Substr(Alltrim(x[1]),1,3)=="009" ,x[3],0)}) //Valor "Saldo Credor Perํodo Anterior"
				aEval(aApuIcm, {|x| ndeducao += Iif(Substr(Alltrim(x[4]),1,6)=="012.00" .and. Substr(Alltrim(x[1]),1,3)=="012" ,x[3],0)}) //Valor "dedu็๕es"
				aEval(aApuIcm, {|w| nImpRec  += Iif(Substr(Alltrim(w[1]),1,3)=="013" ,w[3],0)}) //Valor "imposto a recolher"
				// Caso exista diferencial de aliquota, este valor deve ser considerado separadamente de "Outros Debitos" na DMA
				// pois isto causa uma duplicacao de valores, pois o valor faz parte de "Outros Debitos" na apuracao de ICMS
				nTotDeb := nTotDeb - nResDif
				// O mesmo vale para "Outros Debitos", Este valor deve ser ajustado para nao considerar o diferencial de aliquota na DMA
				nOutSai := nOutSai - nResDif
			EndIf
			nSldCred := nTotCred - nTotDeb
			nSldDeb  := nTotDeb - nTotCred
			If mv_par08 == 1
				If nSldCred > nTotCred
					MsgStop(STR0106) //"Saldo Credor para o periodo seguinte, nใo pode ser maior que o total de Cr้ditos."
				Elseif nSldDeb < 0
					MsgStop(STR0108) //"Saldo Credor para o periodo seguinte, nใo pode ser maior que o total de Cr้ditos."
				Endif
			Else
				If nSldCred < 0
					nSldCred := 0
				ElseIf nSldDeb < 0
					nSldDeb	:= 0
				EndIf
			EndIf

			//Receita pelas vendas sob o regime cumulativo - Cofins
			If MV_PAR12 == 1 .And. AliasIndic("CKR")  //usa o FISA001
#IFDEF TOP
				If (TcSrvType()<>"AS/400")
					BeginSql Alias cAlsCKR
						COLUMN CKR_PER AS DATE

						SELECT CKR_CREC
						FROM %table:CKR% CKR
						WHERE
						CKR.%NotDel% AND
						CKR.CKR_FILIAL=%xFilial:CKR% AND
						CKR.CKR_PER=%Exp:DTOS(CtoD("01/"+strzero(MV_PAR02,2)+"/"+strzero(MV_PAR01,4)))% AND
						CKR_TRIB='2'

					EndSql
					nCofins := NoRound((cAlsCKR)->CKR_CREC,2)
					(cAlsCKR)->(DbCloseArea())
				Endif
#ENDIF
			Else	//usa o MATA996
				nCofins := NoRound(LoadAnt(alltrim(_aTotal[99][18])+".CP","004"),2) * 100
			Endif

#IFDEF TOP
			//---Processa Registros Tipo 18/19/20 - Quadros 19 e 20 (Cr้dito Fiscal Acumulado)---//
			If (TcSrvType()<>"AS/400")
				If lTabF2R //---Nใo gerar valores nos quadros 19 e 20 em casos de inexist๊ncia da tabela F2R--//

					//---Cr้ditos Acumulados - Opera็๕es de Saํda Incentivadas X C๓digos de Ajuste Apura็ใo e Extra-Apura็ใo---//
					cQuery := "SELECT DISTINCT F2P.F2P_CODCRE, CASE WHEN F2P.F2P_CREDAC IN ('1','4') THEN '19' WHEN F2P.F2P_CREDAC IN ('2','5','6','7') THEN '20' ELSE '  ' END F2P_QUADRO "
					cQuery += "FROM "+RetSqlName("F2P")+" F2P "
					cQuery += "WHERE F2P.F2P_FILIAL='"+xFilial("F2P")+"'        AND "
					cQuery += "      F2P.F2P_UF    ='"+cUf+"'                   AND "
					cQuery += "      F2P.D_E_L_E_T_='' "
					cQuery := ChangeQuery(cQuery)

					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlsF2P,.T.,.T.)

					While (cAlsF2P)->(!Eof())
						nPosCdLanc:=Ascan(aCdLancOri,{|x|x[1]==AllTrim((cAlsF2P)->F2P_CODCRE)})
						If nPosCdLanc=0
							Aadd(aCdLancOri,{AllTrim((cAlsF2P)->F2P_CODCRE),(cAlsF2P)->F2P_QUADRO})
						Else
							lQuadr1920 := .F.
						EndIf
						(cAlsF2P)->(DbSkip())
					EndDo
					(cAlsF2P)->(DbCloseArea())
					//---FIM Cr้ditos Acumulados - Opera็๕es de Saํda Incentivadas X C๓digos de Ajuste Apura็ใo e Extra-Apura็ใo---//

					If lQuadr1920 //---Nใo gerar valores nos quadros 19 e 20 em casos de tabela F2P contendo um mesmo c๓digo extra-apura็ใo em quadros diferentes--//

						//---Cr้ditos Gerados---//
						cQuery := "SELECT F2R_CREDAC, F2R_VALOR, F2R.F2R_CODCRE, CASE WHEN F2R.F2R_CREDAC IN ('1','4') THEN '19' WHEN F2R.F2R_CREDAC IN ('2','5','6','7') THEN '20' ELSE '  ' END F2R_QUADRO "
						cQuery += "FROM "+RetSqlName("F2R")+" F2R "
						cQuery += "WHERE F2R.F2R_FILIAL='"+xFilial("F2R")+"'                   AND "
						cQuery += "      F2R.F2R_ANOMES='"+cValToChar(nAno)+StrZero(nMes,2)+"' AND "
						cQuery += "      F2R.F2R_LIVRO='*'                                     AND "
						cQuery += "      F2R.D_E_L_E_T_='' "
						cQuery := ChangeQuery(cQuery)

						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlsF2R,.T.,.T.)

						While (cAlsF2R)->(!Eof())

							If (cAlsF2R)->F2R_CREDAC=='1'     //---Exp. Direta
								nGerCredEd += (cAlsF2R)->F2R_VALOR
							ElseIf (cAlsF2R)->F2R_CREDAC=='4' //---Exp. Indireta
								nGerCredEi += (cAlsF2R)->F2R_VALOR
							ElseIf (cAlsF2R)->F2R_CREDAC=='6' //---Diferido
								nGerCredDf += (cAlsF2R)->F2R_VALOR
							ElseIf (cAlsF2R)->F2R_CREDAC=='5' //---Isento
								nGerCredIs += (cAlsF2R)->F2R_VALOR
							ElseIf (cAlsF2R)->F2R_CREDAC=='7' //---Red. BC
								nGerCredRd += (cAlsF2R)->F2R_VALOR
							ElseIf (cAlsF2R)->F2R_CREDAC=='2' //---Outros
								nGerCredOM += (cAlsF2R)->F2R_VALOR
							EndIf

							nPosCdLanc:=Ascan(aCdLancOri,{|x|x[1]==AllTrim((cAlsF2R)->F2R_CODCRE)})
							If nPosCdLanc=0
								Aadd(aCdLancOri,{AllTrim((cAlsF2R)->F2R_CODCRE),(cAlsF2R)->F2R_QUADRO})
							Else
								aCdLancOri[nPosCdLanc][2]:=(cAlsF2R)->F2R_QUADRO
							EndIf

							(cAlsF2R)->(DbSkip())
						EndDo
						(cAlsF2R)->(DbCloseArea())
						//---FIM Cr้ditos Gerados---//

						//---Cr้ditos Utilizados---//
						cQuery := "SELECT CE5.CE5_CODLAN, CE5.CE5_VALOR, CE7.CE7_CODREF "
						cQuery += "FROM "+RetSqlName("CE5")+" CE5 LEFT OUTER JOIN "+RetSqlName("CE7")+" CE7 ON (CE7.CE7_FILIAL='"+xFilial("CE7")+"' AND CE7.CE7_CODUTI=CE5.CE5_CODUTI) AND CE7.D_E_L_E_T_='' "
						cQuery += "WHERE CE5.CE5_FILIAL='"+xFilial("CE5")+"'                   AND "
						cQuery += "      CE5.CE5_PERIOD='"+cValToChar(nAno)+StrZero(nMes,2)+"' AND "
						cQuery += "      CE5.CE5_TPMOV='U'                                     AND "
						cQuery += "      CE5.D_E_L_E_T_='' "
						cQuery := ChangeQuery(cQuery)

						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlsCE5,.T.,.T.)

						While (cAlsCE5)->(!Eof())
							nPosCdLanc:=Ascan(aCdLancOri,{|x|x[1]==AllTrim((cAlsCE5)->CE5_CODLAN)})
							If nPosCdLanc>0
								cQuadro:=aCdLancOri[nPosCdLanc][2]
							EndIf
							If !Empty(cQuadro)
								If cQuadro=='19'
									If AllTrim((cAlsCE5)->CE7_CODREF)=='0001'
										nUtPgICMEx += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0002'
										nUtImpMEEx += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0003'
										nUtDenEsEx += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0004'
										nUtAuFisEx += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0005'
										nUtTrOutEx += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0006'
										nUtTrTerEx += (cAlsCE5)->CE5_VALOR
									EndIf
								EndIf
								If cQuadro=='20'
									If AllTrim((cAlsCE5)->CE7_CODREF)=='0001'
										nUtPgICMDI += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0002'
										nUtImpMEDI += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0003'
										nUtDenEsDI += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0004'
										nUtAuFisDI += (cAlsCE5)->CE5_VALOR
									ElseIf AllTrim((cAlsCE5)->CE7_CODREF)=='0005' .Or. AllTrim((cAlsCE5)->CE7_CODREF)=='0006'
										nUtTransDI += (cAlsCE5)->CE5_VALOR
									EndIf
								EndIf
							EndIf
							(cAlsCE5)->(DbSkip())
						EndDo
						(cAlsCE5)->(DbCloseArea())
						//---FIM Cr้ditos Utilizados---//

						//---Cr้ditos de Perํodos Anteriores---//
						cPerAnt:=Iif(nMes=1,cValToChar(nAno-1)+'12',cValToChar(nAno)+StrZero(nMes-1,2))

						cQuery := "SELECT CE6_CODLAN, CE6_SALDO "
						cQuery += "FROM "+RetSqlName("CE6")+" CE6 "
						cQuery += "WHERE CE6.CE6_FILIAL='"+xFilial("CE6")+"' AND "
						cQuery += "      CE6.CE6_PERIOD='"+cPerAnt+"'        AND "
						cQuery += "      CE6.D_E_L_E_T_='' "
						cQuery := ChangeQuery(cQuery)

						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlsCE6,.T.,.T.)

						While (cAlsCE6)->(!Eof())
							nPosCdLanc:=Ascan(aCdLancOri,{|x|x[1]==AllTrim((cAlsCE6)->CE6_CODLAN)})
							If nPosCdLanc>0
								cQuadro:=aCdLancOri[nPosCdLanc][2]
							EndIf
							If !Empty(cQuadro)
								If cQuadro=='19'
									nSldAntExp += (cAlsCE6)->CE6_SALDO
								EndIf
								If cQuadro=='20'
									nSldAntDIO += (cAlsCE6)->CE6_SALDO
								EndIf
							EndIf
							(cAlsCE6)->(DbSkip())
						EndDo
						(cAlsCE6)->(DbCloseArea())
						//---FIM Cr้ditos de Perํodos Anteriores---//

					EndIf
				EndIf
			EndIf
			//---FIM Processa Registros Tipo 18, 19 e 20 - Quadros 19 e 20 (Cr้dito Fiscal Acumulado)---//
#ENDIF

			/*
			aTotais{}
			1- nVCompAtv	  // Valor "Compras para Ativo Imobilizado"
			2- nVAqMat		  // Valor "Aquisi็ใo de Material para Uso ou Consumo"
			3- nVTrnsfAe	  // Valor "Transfer๊ncias para o Ativo Imobilizado"
			4- nVOtOpE		  // Valor "Outras" de entradas e aquisi็๕es nใo especificados
			5- nVTrnsfMs	  // Valor "Transfer๊ncias de Material para Uso ou Consumo"
			6- nVOtOpS		  // Valor "Outras" de entradas e aquisi็๕es nใo especificados
			7- nVTotalE		  // Valor "Total" de entrada
			8- nVTotalS		  // Valor "Total" de Saํda
			9- nVRetRemE	  // Valor "Entradas" e "Retornos" e/ou saํdas e Remessas
			10- nVTotDif
			11- nSaiTrib	  //Valor "D้bito do Imposto", Saํdas Tributadas
			12- nOutSai       //Valor "D้bito do Imposto", Outros D้bitos
			13- nEstCred 	  //Valor "D้bito do Imposto", Estorno de Cr้dito
			14- nEntTrib	  //Valor "Cr้dito do Imposto", Entradas Tributadas
			15- nOutCred      //Valor "Cr้dito do Imposto", Outros Cr้ditos
			16- nEstDeb       //Valor "Cr้dito do Imposto", Estorno de D้bito
			17- nSdCdAnt	  //Valor "Cr้dito do Imposto", Saldo Credor Perํodo Anterior
			18- ndeducao	  //Valor "Conta Corrente", dedu็๕es
			19- nImpRec       //Valor "Conta Corrente", imposto a recolher
			20- nTotDeb  	  //Valor "Total do D้bito"
			21- nTotCred      //Valor "Total de Cr้dito"
			22- nSldDeb       //Valor do saldo devedor
			23- nSldCred      //Valor do saldo credor
			24- nVTotsubS     //Valor do ICMS da substitui็ใo tributแria por reten็ใo(saํdas)
			25- nVTotsubE	  //Valor do ICMS da substitui็ใo tributแria por antecipa็ใo(entradas)
			26- nVIcmImp 	  //Valor do ICMS da importa็ใo para industrializa็ใo/comercializa็ใo imobilizado/uso ou consumo
			27- nVTrnsfMe	  //Valor "Transfer๊ncias Material de Uso Consumo
			28- nVTrnsfAs	  //Valor "Transfer๊ncias para Ativo Imob.
			29- nTIcAtvSU 	  //Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Sul/Sudeste
			30- nTIcAtvNO     //Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Norte/Nordeste/Centro-Oeste
			31- nTIcAtv 	  //Valor do ICMS creditado na compra e/ou transfer๊ncia para ativo imobilizado procedente do Estado e do exterior
			32- nTIcMatSU	  //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Sul/Sudeste
			33- nTIcMatNO	  //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Norte/Nordeste/Centro-Oeste
			34- nCofins       //Valor recolhido a COFINS
			35- nTIcMat       //Valor do ICMS creditado na compra e/ou transfer๊ncia de material para uso ou consumo procedente do Estado e do Exterior
			36- nBasCals      //Valor do ICMS - Valores Fiscais - Base de Cแlculo
			37- nBasCalIs     //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
			38-	nBasCalOs 	  //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
			39- nBasCale      //Valor do ICMS - Valores Fiscais - Base de Cแlculo
			40- nBasCalIe     //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
			41-	nBasCalOe 	  //Valor do ICMS - Valores Fiscais - Isentas ou Nใo Tributadas
			42- nVRetRemS  	  //Valor Retorno de Industriliazao, conserto ou venda fora do estabelecimento
			43- nResDif	  	 //Diferencial de Aliquotas
			44- TOTUF	  	 //Arquivo temporario
			45- TOTOPE	  	 //Arquivo temporario
			46- TEPALIAS  	 //Arquivo temporario
			*/
			If Len(aTotais) > 0
				aTotais[01] += nVCompAtv
				aTotais[02] += nVAqMat
				aTotais[03] += nVTrnsfAe
				aTotais[04] += nVOtOpE
				aTotais[05] += nVTrnsfMs
				aTotais[06] += nVOtOpS
				aTotais[07] += nVTotalE
				aTotais[08] += nVTotalS
				aTotais[09] += nVRetRemE
				aTotais[10] += nVTotDif
				aTotais[11] += nSaiTrib
				aTotais[12] += nOutSai
				aTotais[13] += nEstCred
				aTotais[14] += nEntTrib
				aTotais[15] += nOutCred
				aTotais[16] += nEstDeb
				aTotais[17] += nSdCdAnt
				aTotais[18] += ndeducao
				aTotais[19] += nImpRec
				aTotais[20] += nTotDeb
				aTotais[21] += nTotCred
				aTotais[22] += nSldDeb
				aTotais[23] += nSldCred
				aTotais[24] += nVTotsubS
				aTotais[25] += nVTotsubE
				aTotais[26] += nVIcmImp
				aTotais[27] += nVTrnsfMe
				aTotais[28] += nVTrnsfAs
				aTotais[29] += nTIcAtvSU
				aTotais[30] += nTIcAtvNO
				aTotais[31] += nTIcAtv
				aTotais[32] += nTIcMatSU
				aTotais[33] += nTIcMatNO
				aTotais[34] += nCofins
				aTotais[35] += nTIcMat
				aTotais[36] += nBasCals
				aTotais[37] += nBasCalIs
				aTotais[38] += nBasCalOs
				aTotais[39] += nBasCale
				aTotais[40] += nBasCalIe
				aTotais[41] += nBasCalOe
				aTotais[42] += nVRetRemS
				aTotais[43] += nResDif
				aTotais[49] += nSldAntExp
				aTotais[50] += nSldAntDIO
				aTotais[51] += nGerCredEd
				aTotais[52] += nGerCredEi
				aTotais[53] += nGerCredDf
				aTotais[54] += nGerCredIs
				aTotais[55] += nGerCredRd
				aTotais[56] += nGerCredOM
				aTotais[57] += nUtPgICMEx
				aTotais[58] += nUtTrOutEx
				aTotais[59] += nUtImpMEEx
				aTotais[60] += nUtDenEsEx
				aTotais[61] += nUtAuFisEx
				aTotais[62] += nUtTrTerEx
				aTotais[63] += nUtPgICMDI
				aTotais[64] += nUtImpMEDI
				aTotais[65] += nUtDenEsDI
				aTotais[66] += nUtAuFisDI
				aTotais[67] += nUtTransDI
			Else
				aTotais := {nVCompAtv,nVAqMat,nVTrnsfAe,nVOtOpE,nVTrnsfMs,nVOtOpS,nVTotalE,nVTotalS,nVRetRemE,nVTotDif,;
							nSaiTrib,nOutSai,nEstCred,nEntTrib,nOutCred,nEstDeb,nSdCdAnt,ndeducao,;
							nImpRec,nTotDeb,nTotCred,nSldDeb,nSldCred,nVTotsubS,nVTotsubE,nVIcmImp,;
							nVTrnsfMe,nVTrnsfAs,nTIcAtvSU,nTIcAtvNO,nTIcAtv,nTIcMatSU,nTIcMatNO,nCofins * 100,nTIcMat,;
							nBasCals,nBasCalIs,nBasCalOs,nBasCale,nBasCalIe,nBasCalOe,nVRetRemS,nResDif,;
							TOTUF,TOTOPE,TEPALIAS,TOTINV,TOTINVF,;
							nSldAntExp,nSldAntDIO,;
							nGerCredEd,nGerCredEi,nGerCredDf,nGerCredIs,nGerCredRd,nGerCredOM,;
							nUtPgICMEx,nUtTrOutEx,nUtImpMEEx,nUtDenEsEx,nUtAuFisEx,nUtTrTerEx,;
							nUtPgICMDI,nUtImpMEDI,nUtDenEsDI,nUtAuFisDI,nUtTransDI,;
							lQuadr1920}
			Endif

		Endif

#IFDEF TOP
	EndIf
	nEmpresa++
	If FWModeAccess("SF3",3)=="C"
		Exit
	Endif

EndDo

#ENDIF

Return(aTotais)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณArqMunDMA บAutor  ณLuciana Pires       บ Data ณ  14/09/06   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Gera arquivo temporario de NF's por C๓digo de Municํpio    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ 		                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ArqMunDMA(nMes,nAno)
Local aCampos		:= {}
Local aTotMun		:= {}
Local aCodMun		:= {}
Local aTotRat       := {}
Local cCodMun		:= ""
Local cRegistro 	:= ""
Local cCFOCFP   	:= ""
Local cAliasSFT     := "SFT"
Local cIndSFT		:= ""
Local cChave		:= ""
Local cFiltro		:= ""
Local lParam 		:= GetNewPar("MV_DMARAT",.F.)
Local nX            := 0
Local nTotBase 		:= 0
Local nTotIsen 		:= 0
Local nTotOutr 		:= 0
Local nBaseEnt      := 0
Local nIsenEnt      := 0
Local nOutrEnt      := 0
Local lAglut		:= .F.
Local aEmpresa		:= {}
Local nEmpresa		:= 1
Local nVez			:= 0
Local lFoundDTC		:= .F.
Local lFoundSA		:= .F.
Local aAreaDT6		:= {}
Local cDbType  		:= TCGetDB()
Local cFuncNull		:= ""

#IFDEF TOP
	Local lQuery        := .F.
	Local aStruSFT  	:= {}
	Local cQuery 		:= ""
	Local nSFT			:= 0
#ENDIF

cCodMun	:= GetNewPar("MV_MUNDMA","{'SA1->A1_COD_MUN','SA2->A2_COD_MUN'}")	// Informa o nome do campo com o codigo do municํpio(SA1,SA2)
aCodMun	:= &cCodMun

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTotalizador da NF.Reg 30 e 31 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos := {}
AADD(aCampos,{"TIPOREG","C",002,0})
AADD(aCampos,{"CODMUN","C",005,0})
AADD(aCampos,{"VALBASE","N",012,2})
AADD(aCampos,{"VALISEN","N",012,2})
AADD(aCampos,{"VALOUTR","N",012,2})

aTotMun  :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,aTotMun,"TCM",.T.,.F.)
IndRegua("TCM",aTotMun,"TIPOREG+CODMUN")
DbSelectArea("TCM")
DbClearIndex()
DbSetIndex(aTotMun+OrdBagExt())

#IFDEF TOP

lAglut	:= ( MV_PAR11 == 1 )		// Define se aglutina registros no grupo de perguntas DMABA1

If lAglut
	For nVez := 1 to Len(aFilsCalc)
		If aFilsCalc[nVez][1]
			aAdd(aEmpresa,{ cEmpAnt, aFilsCalc[nVez][2]})
		EndIf
	Next
EndIf

If Len(aEmpresa) == 0
	aAdd(aEmpresa, { cEmpAnt, cFilAnt } )
EndIf
aEmpresa := asort(aEmpresa,,,{|x,y| x[2] < y[2] })

Do Case // Tratamento do ISNULL por banco de dados
	Case cDbType $ "DB2/POSTGRES"
		cFuncNull	:= "COALESCE"
	Case "ORACLE" $ cDbType
		cFuncNull	:= "NVL"
	Otherwise
		cFuncNull	:= "ISNULL"
EndCase

While nEmpresa <=  len(aEmpresa)

	If Select('SFTDMA') > 0
		SFTDMA->(dbCloseArea())
	EndIf

	dbSelectArea("SM0")
	If dbSeek(aEmpresa[nEmpresa,1]+aEmpresa[nEmpresa,2],.T.)
		cFilAnt  := FWCodFil()

#ENDIF

#IFDEF TOP
	If TcSrvType() <> "AS/400"
		cAliasSFT:= "SFTDMA"
		lQuery    := .T.
		aStruSFT  := SFT->(dbStruct())

		cQuery := " SELECT SFT.FT_TIPOMOV,SFT.FT_FILIAL,SFT.FT_ENTRADA,SFT.FT_DTCANC, SFT.FT_TIPO,SFT.FT_CFOP,SFT.FT_ESTADO,SFT.FT_VALCONT,SFT.FT_BASEICM, SFT.FT_VALICM,SFT.FT_ISENICM,SFT.FT_OUTRICM,SFT.FT_ICMSRET, SFT.FT_CLIEFOR,SFT.FT_LOJA,SFT.FT_NFISCAL,SFT.FT_EMISSAO,SFT.FT_ICMSCOM, SFT.FT_SERIE,SFT.FT_ESPECIE "
		cQuery += " FROM "+RetSqlName("SFT") + " SFT"
		cQuery += " LEFT JOIN "+RetSqlName("SF2") + " SF2 ON F2_FILIAL='"+xFilial("SF2")+"' AND SF2.F2_DOC=SFT.FT_NFISCAL AND SF2.F2_SERIE=SFT.FT_SERIE AND SF2.F2_CLIENTE=SFT.FT_CLIEFOR AND SF2.F2_LOJA=SFT.FT_LOJA AND SF2.D_E_L_E_T_=' ' AND SFT.FT_TIPOMOV='S'"
		cQuery += " LEFT JOIN "+RetSqlName("SF1") + " SF1 ON F1_FILIAL='"+xFilial("SF1")+"' AND SF1.F1_DOC=SFT.FT_NFISCAL AND SF1.F1_SERIE=SFT.FT_SERIE AND SF1.F1_FORNECE=SFT.FT_CLIEFOR AND SF1.F1_LOJA=SFT.FT_LOJA AND SF1.D_E_L_E_T_=' ' AND SFT.FT_TIPOMOV='E'"
		cQuery += " WHERE SFT.FT_FILIAL = '"+xFilial("SFT")+"'" 
		cQuery += " AND SFT.FT_ENTRADA >= '"+DTOS(dDmainc)+"'"
		cQuery += " AND SFT.FT_ENTRADA <= '"+DTOS(dDmaFin)+"'" 
		cQuery += " AND SFT.FT_TIPO <> 'S'"
		cQuery += " AND SFT.D_E_L_E_T_ = ' '"
		cQuery += " AND SFT.FT_DTCANC = ' '"
		cQuery += " AND (("+cFuncNull+"(SF2.F2_UFORIG,' ')='BA')"
		cQuery += " 	OR ("+cFuncNull+"(SF1.F1_UFORITR,' ')='BA'"
		cQuery += " 	OR ("+cFuncNull+"(SF1.F1_UFORITR,' ')=' ' AND "+cFuncNull+"(SF1.F1_EST,' ')='BA'))"
		cQuery += " 	OR ("+cFuncNull+"(SF2.F2_UFORIG,' ')=' ' AND "+cFuncNull+"(SF1.F1_EST,' ') = ' ' AND "+cFuncNull+"(SF1.F1_UFORITR,' ')=' ' AND SFT.FT_ESTADO = 'BA'))"

		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFT,.T.,.T.)
		For nSFT := 1 To Len(aStruSFT)
			If aStruSFT[nSFT][2] <> "C" .and. FieldPos(aStruSFT[nSFT][1]) > 0
				TcSetField(cAliasSFT,aStruSFT[nSFT][1],aStruSFT[nSFT][2],aStruSFT[nSFT][3],aStruSFT[nSFT][4])
			EndIf
		Next nSFT
	Else
#ENDIF
		dbSelectArea(cAliasSFT)
		cIndSFT	:=	CriaTrab(NIL,.F.)
		cChave	:=	IndexKey()
		cFiltro	:=	"FT_FILIAL=='"+xFilial()+"'"
		cFiltro	+=	" .And. DTOS(SFT->FT_ENTRADA)>='"+DTOS(dDmainc)+"' .AND. DTOS(SFT->FT_ENTRADA)<='"+DTOS(dDmaFin)+"' .AND. SFT->FT_TIPO<>'S'"
		IndRegua(cAliasSFT,cIndSFT,cChave,,cFiltro)
#IFDEF TOP
	Endif
#ENDIF

While (cAliasSFT)->(!EOF()) .and. (cAliasSFT)->FT_FILIAL == xFilial("SFT") .and. _aTotal[9]
	cCFOCFP:=VerTpDet((cAliasSFT)->FT_CFOP,.F.,"SIGADMA.CFP")
	If Empty(cCFOCFP)
		(cAliasSFT)->(dbSkip())
		Loop
	Endif

	cRegistro	:=If(substr(cCFOCFP,1,1)<"5","30","31")
	lFoundDTC := .F.
	lFoundSA  := .F.

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Verifica o cliente/fornecedor                                          ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	//--Verifica se tem intregracao com modulo TMS
	If IntTms() .And. AllTrim((cAliasSFT)->FT_ESPECIE) $ "CTR|CTE|NFST" .And.;
		((SubStr((cAliasSFT)->FT_CFOP,1,1)>="5" .And. !(cAliasSFT)->FT_TIPO$"BD") .Or.;
		 (SubStr((cAliasSFT)->FT_CFOP,1,1)<"5" .And. (cAliasSFT)->FT_TIPO$"BD"))

		DbSelectArea("DT6")
		DT6->(dbSetOrder(1))

		If DT6->(MsSeek(xFilial("DT6")+(cAliasSFT)->FT_FILIAL+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE))
			DTC->(DbSetOrder(3))
			If DT6->DT6_DOCTMS <> (StrZero(8,Len(DT6->DT6_DOCTMS)))
				/*
					Tipos de Documentos TMS
					-----------------------
					6 - CTRC Devolucao
					7 - CTRC Reentrega
					8 - CTRC Complemento
					9 - CTRC Retorno
					P - CTRC Subustitui็ใo
					M - CTRC Anula็ใo

					Os Tipos de Documentos "6|7|8|9|P|M|", nใo estใo relacionados com um registro da tabela DTC, para encontrar o DTC, 
					o processo abaixo busca o DT6 original para poder posicionar no DTC correspondente.					
				*/
				If ( DT6->DT6_DOCTMS $ "6|7|8|9|P|M|" )
					aAreaDT6 := GetArea("DT6")
					If DT6->(MsSeek(xFilial("DT6")+DT6->DT6_FILDOC+DT6->DT6_DOCDCO+DT6->DT6_SERIE))
						lFoundDTC:= DTC->(MsSeek(xFilial("DTC")+DT6->DT6_FILDOC+DT6->DT6_DOC+DT6->DT6_SERIE))
					EndIf
					RestArea(aAreaDT6)
				Else
					lFoundDTC:= DTC->(MsSeek(xFilial("DTC")+DT6->DT6_FILDOC+DT6->DT6_DOC+DT6->DT6_SERIE))
				EndIf
			Else	// CTRC COMPLEMENTAR
				lFoundDTC:= DTC->(MsSeek(xFilial("DTC")+DT6->DT6_FILDCO+DT6->DT6_DOCDCO+DT6->DT6_SERDCO))
			EndIf

			If lFoundDTC 

				If DTC->DTC_DEVFRE == "1" //--Remetente
					lFoundSA:= SA1->(dbSeek(xFilial("SA1")+DTC->DTC_CLIREM+DTC->DTC_LOJREM))
				ElseIf DTC->DTC_DEVFRE == "2" //--Destinatario
					lFoundSA:= SA1->(dbSeek(xFilial("SA1")+DTC->DTC_CLIDES+DTC->DTC_LOJDES))
				ElseIf DTC->DTC_DEVFRE == "3" //--Consignatario
					lFoundSA:= SA1->(dbSeek(xFilial("SA1")+DTC->DTC_CLICON+DTC->DTC_LOJCON))
				ElseIf DTC->DTC_DEVFRE == "4" //--Despachante
					lFoundSA:= SA1->(dbSeek(xFilial("SA1")+DTC->DTC_CLIDPC+DTC->DTC_LOJDPC))
				EndIf

				If lFoundSA
					cCodMun 	:= &(aCodMun[1])
				EndIf

			Endif
		Endif

	Else
		If (SubStr((cAliasSFT)->FT_CFOP,1,1)>="5" .And. (cAliasSFT)->FT_TIPO$"BD") .Or.;
		   (SubStr((cAliasSFT)->FT_CFOP,1,1)<"5" .And. !(cAliasSFT)->FT_TIPO$"BD")

			lFoundSA:= SA2->(MsSeek(xFilial("SA2")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
			If lFoundSA
				cCodMun 	:= &(aCodMun[2])
			EndIf
		Else
			lFoundSA:= SA1->(MsSeek(xFilial("SA1")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
			If lFoundSA
				cCodMun 	:= &(aCodMun[1])
			EndIf
		EndIf
	EndIf

	/*
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณTotaliza็ใo por C๓digo do Municํpio -  Entradas/Saํdas -  TIPOS 30/31ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	*/
	// C๓digos incluํdos no quadro 13 (Valores Fiscais Ded๚tiveis)
	If !cCFOCFP$("007#008#009#010#011#013#107#108#109#110#111#113#204#205#206#207#507#510#607#610#704#705") .and. lFoundSA
		If lParam   // Rateio de entradas de acordo com as saidas
			If cRegistro == "31"
				AADD(aTotRat,{	"30",;
								cCodMun,;
								(cAliasSFT)->FT_BASEICM,; //"VALBASE"
								(cAliasSFT)->FT_ISENICM,; //"VALISEN"
								(cAliasSFT)->FT_OUTRICM	})//"VALOUTR"

				If TCM->(!dbseek(cRegistro+cCodMun))
					RecLock("TCM",.T.)
					TCM->CODMUN  := cCodMun
					TCM->TIPOREG := cRegistro
					TCM->VALBASE := (cAliasSFT)->FT_BASEICM
					TCM->VALISEN := (cAliasSFT)->FT_ISENICM
					TCM->VALOUTR := (cAliasSFT)->FT_OUTRICM
				Else
					RECLOCK("TCM",.F.)
					TCM->VALBASE += noRound((cAliasSFT)->FT_BASEICM,2)
					TCM->VALISEN += noRound((cAliasSFT)->FT_ISENICM,2)
					TCM->VALOUTR += noRound((cAliasSFT)->FT_OUTRICM,2)
				EndIf
			Else    // registro = 30
				nBaseEnt += (cAliasSFT)->FT_BASEICM
				nIsenEnt += (cAliasSFT)->FT_ISENICM
				nOutrEnt += (cAliasSFT)->FT_OUTRICM
			EndIf
		Else
			If TCM->(!dbseek(cRegistro+cCodMun))
				RecLock("TCM",.T.)
				TCM->CODMUN  := cCodMun
				TCM->TIPOREG := cRegistro
				TCM->VALBASE := (cAliasSFT)->FT_BASEICM
				TCM->VALISEN := (cAliasSFT)->FT_ISENICM
				TCM->VALOUTR := (cAliasSFT)->FT_OUTRICM
			Else
				RECLOCK("TCM",.F.)
				TCM->VALBASE += noRound((cAliasSFT)->FT_BASEICM,2)
				TCM->VALISEN += noRound((cAliasSFT)->FT_ISENICM,2)
				TCM->VALOUTR += noRound((cAliasSFT)->FT_OUTRICM,2)
			EndIf
		Endif
		MsUnlock()
	Endif
	(cAliasSFT)->(dbSkip())
EndDo
If lQuery
	dbSelectArea(cAliasSFT)
	dbCloseArea()
Endif

If lParam
	// Le array para Totais
	For nX := 1 to Len(aTotRat)
		nTotBase += aTotRat[nX][3]
		nTotIsen += aTotRat[nX][4]
		nTotOutr += aTotRat[nX][5]
	Next

	// Gravar os registros tipo 30 - Entrada
	For nX := 1 to Len(aTotRat)
		If TCM->(!dbseek(aTotRat[nX][1]+aTotRat[nX][2]))
			RecLock("TCM",.T.)
			TCM->CODMUN  := aTotRat[nX][2] //cCodMun
			TCM->TIPOREG := aTotRat[nX][1] //cRegistro
			TCM->VALBASE := ((((aTotRat[nX][3]*100)/nTotBase)/100)*nBaseEnt) //(cAliasSFT)->FT_BASEICM
			TCM->VALISEN := ((((aTotRat[nX][4]*100)/nTotIsen)/100)*nIsenEnt) //(cAliasSFT)->FT_ISENICM
			TCM->VALOUTR := ((((aTotRat[nX][5]*100)/nTotOutr)/100)*nOutrEnt) //(cAliasSFT)->FT_OUTRICM
		Else
			RECLOCK("TCM",.F.)
			TCM->VALBASE += noRound(((((aTotRat[nX][3]*100)/nTotBase)/100)*nBaseEnt),2)
			TCM->VALISEN += noRound(((((aTotRat[nX][4]*100)/nTotIsen)/100)*nIsenEnt),2)
			TCM->VALOUTR += noRound(((((aTotRat[nX][5]*100)/nTotOutr)/100)*nOutrEnt),2)
		EndIf
	Next
Endif

#IFDEF TOP
	EndIf
nEmpresa++
If FWModeAccess("SFT",3)=="C"
	Exit
Endif

EndDo

#ENDIF
Return(aTotMun)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณ VerTpDet บAutor  ณAline Correa do Valeบ Data ณ  04/10/01   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Pesquisa o arquivo SIGADMA.CFP os CFO Tipo de Detalhe      บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function VerTpDet(cCPO,lEnd,cArqIni)
Local cTpDet := ""
Local cIni := "", cConteudo:="", i:=0
lEnd:=If(lEnd==NIL,.F.,lEnd)

If !File(cArqIni)
	Help(" ",1,"SIGADMEF")
	lContinua:=.f.
	lEnd:=.T.
	Return(cTpDet)
Else
	cConteudo:=MemoRead(cArqIni)
	nLinhas:=MlCount(cConteudo,254)
	For i:=4 to nLinhas
		cLinha:=AllTrim(MemoLine(cConteudo,254,i))
		IF Substr(AllTrim(cCPO),1,1) <> "9"
	  		If AllTrim(cCPO)$Substr(cLinha,7)
	  			cIni:=Substr(cLinha,2,3)
	  			If Substr(AllTrim(cIni),1,1) <> "9"
     				Exit
				EndIf
			Endif
		Elseif AllTrim(cCPO) ==Substr(cLinha,2,3)
			cIni:=Substr(cLinha,7)
			Exit
		Endif

	Next
Endif
If Substr(AllTrim(cIni),1,1) == "9" .and. Substr(AllTrim(cCPO),1,1) <> "9"
	cIni := Space(03)
EndIf
Return(cIni)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณ DadosDma บAutor  ณEduardo Jos้ Zanardo  Data ณ  24/10/01   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Tela com as informa็๕es adicionais para o DMA              บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP5                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DadosDma()
Local aDadAdi := {}

AAdd(aDadAdi,Substr(VerTpDet("911",.F.,"SIGADMA.CFP"),1,35))     //1"Responsแvel: "
AAdd(aDadAdi,Substr(VerTpDet("912",.F.,"SIGADMA.CFP"),1,11))     //2"CPF:"
AAdd(aDadAdi,Substr(VerTpDet("913",.F.,"SIGADMA.CFP"),1,35))     //3"Nome do Contador Responsแvel: "
AAdd(aDadAdi,Substr(VerTpDet("914",.F.,"SIGADMA.CFP"),1,07))     //4"CRC"
AAdd(aDadAdi,Substr(VerTpDet("915",.F.,"SIGADMA.CFP"),1,02))     //5"UF DO CRC DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("916",.F.,"SIGADMA.CFP"),1,03))     //6"TIPO DO LOGRADOURO DO END. DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("917",.F.,"SIGADMA.CFP"),1,30))     //7"DESCRIวรO DO LOGRADOURO"
AAdd(aDadAdi,Substr(VerTpDet("918",.F.,"SIGADMA.CFP"),1,02))     //8"UF DO LOGRADOURO DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("919",.F.,"SIGADMA.CFP"),1,16))     //9"BAIRRO DO LOGRADOURO DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("920",.F.,"SIGADMA.CFP"),1,09))     //10"NฺMERO DO LOGRADOURO DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("921",.F.,"SIGADMA.CFP"),1,08))     //11"CEP DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("922",.F.,"SIGADMA.CFP"),1,05))     //12"COD. DO MUNICIPIO"
AAdd(aDadAdi,Substr(VerTpDet("923",.F.,"SIGADMA.CFP"),1,16))     //13"NฺMERO DO TELEFONE DO CONTADOR"
AAdd(aDadAdi,Substr(VerTpDet("924",.F.,"SIGADMA.CFP"),1,30))     //14"DESCRICAO DO MUNICIPIO DO CONTADOR - OUTRO ESTADO"
AAdd(aDadAdi,Substr(VerTpDet("925",.F.,"SIGADMA.CFP"),1,02))     //15"CODIGO DA INSPETORIA"
AAdd(aDadAdi,Substr(VerTpDet("926",.F.,"SIGADMA.CFP"),1,06))     //16"N๚mero de Empregados"
AAdd(aDadAdi,Substr(VerTpDet("927",.F.,"SIGADMA.CFP"),1,07))     //17"KWH consumidos no perํodo"
AAdd(aDadAdi,Substr(VerTpDet("928",.F.,"SIGADMA.CFP"),1,30))     //18"NOME DO ARQUIVO DE APURAวรO DO COFINS"

Return (aDadAdi)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณCtbTotAt2 บAutor  ณMicrosiga           บ Data ณ  06/24/10   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ                                                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CtbTotAt2( cChvBusca , cChvPesq )
Local aArea	 := GetArea()
Local nValor := 0
Local nRecAt2:= 0

Default cChvPesq := 'DTOS(AT2->DTLANCA) + AT2->NUMARQ'
Default cChvBusca:= ''

DbSelectArea( 'AT2' )
nRecAt2 := Recno()

While !Eof() .And. &cChvPesq == cChvBusca

	IF AT2->INDICADC == 'D'
		nValor += AT2->VALLANC
	Endif

	AT2->( DbSkip() )
Enddo

DbSelectArea( 'AT2' )
DbGoTo( nRecAt2 )

RestArea( aArea )

Return nValor
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ  CodUnMd ณ Autor ณ  Eduardo Jose Zanardo ณ Data ณ 08.01.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Retorna o Codigo da Unid. Medida                           ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ NORMA 86                                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CodUnMd(cChave,aRetCod)

Local nCod:=0
Local cRet:=""

nCod := Ascan(aRetCod,Alltrim(cChave))
cRet := StrZero(nCod,3)

Return(cRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณ ValOpera ณ Autor ณ Eduardo Jose Zanardo  ณ Data ณ 09.01.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณ Recupera apenas o valor operacional                        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ Norma 86                                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/

Function ValOpera(cEFilial,cPrefixo,cNumero,cParcela,cTipo,cCliFor,cLoja,cSeq,cRecpag)

Local nValLiq	:= 0
Local cArea		:= Alias()
Local aAreaSE5	:= {}
Local cChave	:= (cEFilial+cPrefixo+cNumero+cParcela+cTipo+cCliFor+cLoja+cSeq)

DbSelectArea("SE5")

aAreaSE5 := GetArea()

DbSetOrder(7)
DbSeek(cChave)

While !Eof() .and. cChave==SE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ)
	If SE5->E5_SITUACA <> "C"	// Verifica se a movimentacao nao foi cancelada
		If SE5->E5_TIPODOC $ "VL/BA/LJ/V2/CP"
			nValLiq += SE5->E5_VALOR
		EndIf
	EndIf
	DbSkip()
EndDo

RestArea(aAreaSE5)
DbSelectArea(cArea)

Return(nValLiq)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออหอออออหอออออออออออออออออออหออออหอออออออออปฑฑ
ฑฑบFuncao    ณDadosProบAutorบEdstron E. Correia บDataบ 29/01/02บฑฑ
ฑฑฬออออออออออุออออออออสอออออสอออออออออออออออออออสออออสอออออออออนฑฑ
ฑฑบObjetivo  ณGerar base de dados para atender programa CADPRO บฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function DadosPRO(aFilsCalc)

Local aCampos1 :={}
Local aCampos2 :={}
Local aCampos3 :={}
Local aCampos4 :={}
Local aCampos5 :={}
Local aCampos6 :={}
Local cCgc     :=""
Local cChave   :=""
Local cTipo    :=""
Local cNcmProd :=""
Local cNcmInsu :=""
Local cNomInsu :=""
#IFDEF TOP
	Local cQuery    := ""
	Local cAliasSD1 := ""
	Local cAliasSD2 := ""
	Local aStruSD1  := {}
	Local aStruSD2  := {}
	Local nX		:= 0
#ENDIF
Local nForFilial:= 0
Local cFilOrig	:= cFilAnt

Private cArq1   :=""
Private cArq2   :=""
Private cArq3   :=""
Private cArq4   :=""
Private cArq5   :=""
Private cArq6   :=""

Default aFilsCalc	:= { { .T., cFilAnt } }

AADD(aCampos1,{"TIPOREG"   ,"C",002,0})
AADD(aCampos1,{"NCMPROD"   ,"C",008,0})
AADD(aCampos1,{"NCMEXT"    ,"C",002,0})
AADD(aCampos1,{"NOMPROD"   ,"C",040,0})
AADD(aCampos1,{"PRODUCAO"  ,"N",009,2})
AADD(aCampos1,{"UNIDADE"   ,"C",004,0})
AADD(aCampos1,{"PVENDA"    ,"N",009,2})
cArq1  :=CriaTrab(aCampos1)
_aTotal[2] := cArq1
dbUseArea(.T.,__LocalDriver,cArq1,"PRO",.T.,.F.)
IndRegua("PRO",cArq1,"NCMPROD")
DbSelectArea("PRO")
DbClearIndex()
DbSetIndex(cArq1+OrdBagExt())

AADD(aCampos2,{"TIPOREG"   ,"C",002,0})
AADD(aCampos2,{"NCMINSU"   ,"C",008,0})
AADD(aCampos2,{"NCMEXT"    ,"C",002,0})
AADD(aCampos2,{"NCMPROD"   ,"C",008,0})
AADD(aCampos2,{"NCMEXT2"   ,"C",002,0})
AADD(aCampos2,{"NOMINSUM"  ,"C",040,0})
cArq2  :=CriaTrab(aCampos2)
_aTotal[3] := cArq2
dbUseArea(.T.,__LocalDriver,cArq2,"INS",.T.,.F.)
IndRegua("INS",cArq2,"NCMINSU")
DbSelectArea("INS")
DbClearIndex()
DbSetIndex(cArq2+OrdBagExt())

AADD(aCampos3,{"TIPOREG"   ,"C",002,0})
AADD(aCampos3,{"CGCMF"     ,"C",014,0})
AADD(aCampos3,{"NCMINSUM"  ,"C",008,0})
AADD(aCampos3,{"NCMEXT"    ,"C",002,0})
AADD(aCampos3,{"UF"        ,"C",002,0})
cArq3  :=CriaTrab(aCampos3)
_aTotal[4] := cArq3
dbUseArea(.T.,__LocalDriver,cArq3,"FNC",.T.,.F.)
IndRegua("FNC",cArq3,"CGCMF+UF+NCMINSUM")
DbSelectArea("FNC")
DbClearIndex()
DbSetIndex(cArq3+OrdBagExt())

AADD(aCampos4,{"TIPOREG"   ,"C",002,0})
AADD(aCampos4,{"CGCMF"     ,"C",014,0})
AADD(aCampos4,{"NCMPROD"   ,"C",008,0})
AADD(aCampos4,{"NCMEXT"    ,"C",002,0})
AADD(aCampos4,{"UF"        ,"C",002,0})
cArq4  :=CriaTrab(aCampos4)
_aTotal[5] := cArq4
dbUseArea(.T.,__LocalDriver,cArq4,"CLI",.T.,.F.)
IndRegua("CLI",cArq4,"CGCMF+UF+NCMPROD")
DbSelectArea("CLI")
DbClearIndex()
DbSetIndex(cArq4+OrdBagExt())

AADD(aCampos5,{"TIPOREG"   ,"C",002,0})
AADD(aCampos5,{"TOTPR"     ,"N",005,0})
AADD(aCampos5,{"TOTIN"     ,"N",005,0})
AADD(aCampos5,{"TOTCL"     ,"N",005,0})
AADD(aCampos5,{"TOTFO"     ,"N",005,0})
AADD(aCampos5,{"TOTGER"    ,"N",007,0})
cArq5  :=CriaTrab(aCampos5)
_aTotal[6] := cArq5
dbUseArea(.T.,__LocalDriver,cArq5,"TOT",.T.,.F.)
IndRegua("TOT",cArq5,"TIPOREG")
DbSelectArea("TOT")
DbClearIndex()
DbSetIndex(cArq5+OrdBagExt())

AADD(aCampos6,{"TIPOREG"   ,"C",002,0})
AADD(aCampos6,{"NOME"      ,"C",030,0})
AADD(aCampos6,{"DDD"       ,"C",003,0})
AADD(aCampos6,{"TELEFONE"  ,"C",008,0})
AADD(aCampos6,{"EMAIL"     ,"C",040,0})
cArq6  :=CriaTrab(aCampos6)
_aTotal[7] := cArq6
dbUseArea(.T.,__LocalDriver,cArq6,"COT",.T.,.F.)
IndRegua("COT",cArq6,"TIPOREG")
DbSelectArea("COT")
DbClearIndex()
DbSetIndex(cArq6+OrdBagExt())

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]

		dbSelectArea("SD1")
		SD1->(dbsetorder(3))
		#IFDEF TOP
		    cAliasSD1 := "AliasSD1"
			aStruSD1  := SD1->(dbStruct())
			cQuery    := "SELECT * "
			cQuery    += "FROM "+RetSqlName("SD1")+" SD1 "
			cQuery    += "WHERE SD1.D1_FILIAL='"+xFilial("SD1")+"' AND "
			cQuery    += "SD1.D1_EMISSAO >= '"+DTOS(MV_PAR01)+"' AND "
			cQuery    += "SD1.D1_EMISSAO <= '"+DTOS(MV_PAR02)+"' AND "
			cQuery    += "SD1.D_E_L_E_T_=' ' "
			cQuery    += "ORDER BY "+SqlOrder(SD1->(IndexKey()))

			cQuery    := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1,.T.,.T.)

			For nX := 1 To Len(aStruSD1)
				If ( aStruSD1[nX][2] <> "C" )
					TcSetField(cAliasSD1,aStruSD1[nX][1],aStruSD1[nX][2],aStruSD1[nX][3],aStruSD1[nX][4])
				EndIf
			Next nX
		#ELSE
		    cAliasSD1 := "SD1"
		    dbSeek(xFilial("SD1")+DTOS(mv_par01),.T.)
		#ENDIF

		While xFilial("SD1")==(cAliasSD1)->D1_FILIAL .And. DTOS((cAliasSD1)->D1_EMISSAO)>=DTOS(MV_PAR01) .And. DTOS((cAliasSD1)->D1_EMISSAO)<=DTOS(MV_PAR02)
		      If SB1->(dbSeek(xFilial("SB1")+(cAliasSD1)->D1_COD))
		         If !Empty(SB1->B1_POSIPI)
		            SF1->(dbSeek(xFilial("SF1")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE))
		            If(SF1->F1_TIPO$"DB",dbSelectArea("SA1"),dbSelectArea("SA2"))
		            dbseek(xFilial()+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)
			        cCgc 	:=If(SF1->F1_TIPO$"DB",SA1->A1_CGC,SA2->A2_CGC)
			        cChave  :=If(SF1->F1_TIPO$"DB",SA1->A1_CGC+SA1->A1_EST+SB1->B1_POSIPI,SA2->A2_CGC+SA2->A2_EST+SB1->B1_POSIPI)
			        cTipo	:=If(SF1->F1_TIPO$"DB",SA1->A1_TIPO,SA2->A2_TIPO)
		            If cTipo=="X"
		               cCgc   :=SM0->M0_CGC
		               cChave :=cCgc+"EX"
		            Endif

		            SG1->(dbsetorder(2))

		            If SG1->(dbSeek(xFilial("SG1")+(cAliasSD1)->D1_COD))
		               cNcmInsu :=SB1->B1_POSIPI
		               cNomInsu :=SB1->B1_DESC
		               While xFilial("SG1")==SG1->G1_FILIAL .And. (cAliasSD1)->D1_COD==SG1->G1_COMP
		                     SB1->(dbSeek(xFilial("SB1")+SG1->G1_COD))
		                     cNcmProd :=SB1->B1_POSIPI
		               		 If !Empty(cCgc)
			                    If !INS->(dbSeek(cNcmInsu))
		   			               RecLock("INS",.T.)
							       INS->TIPOREG    :="IN"
							       INS->NCMINSU    :=cNcmInsu
							       INS->NCMEXT     :=""
							       INS->NCMPROD    :=cNcmProd
							       INS->NCMEXT2    :=""
							       INS->NOMINSUM   :=cNomInsu
					               INS->(MsUnlock())
		                        Endif
		                        If !FNC->(dbSeek(cChave))
		                           RecLock("FNC",.T.)
		 					       FNC->TIPOREG   :="FO"
								   FNC->CGCMF     :=cCgc
								   FNC->NCMINSUM  :=INS->NCMINSU
								   FNC->NCMEXT    :=INS->NCMEXT
								   FNC->UF        :=SUBS(cChave,15,2)
					               FNC->(MsUnlock())
							    Endif
		                     Endif
		                     SG1->(DbSkip())
		               Enddo
		            Else
		               cNcmInsu :=SB1->B1_POSIPI
		               cNomInsu :=SB1->B1_DESC
		               cNcmProd :=""
		               If !Empty(cCgc)
			              If !INS->(dbSeek(cNcmInsu))
		   			         RecLock("INS",.T.)
					         INS->TIPOREG    :="IN"
							 INS->NCMINSU    :=cNcmInsu
							 INS->NCMEXT     :=""
							 INS->NCMPROD    :=cNcmProd
							 INS->NCMEXT2    :=""
							 INS->NOMINSUM   :=cNomInsu
					         INS->(MsUnlock())
		                  Endif
		                  If !FNC->(dbSeek(cChave))
		                     RecLock("FNC",.T.)
		 				     FNC->TIPOREG   :="FO"
						     FNC->CGCMF     :=cCgc
						     FNC->NCMINSUM  :=INS->NCMINSU
						     FNC->NCMEXT    :=INS->NCMEXT
						     FNC->UF        :=SUBS(cChave,15,2)
					         FNC->(MsUnlock())
						  Endif
		               Endif
		            Endif
		         Endif
		      Endif
		      (cAliasSD1)->(dbskip())
		Enddo
		#IFDEF TOP
			dbSelectArea(cAliasSD1)
			dbCloseArea()
		#ENDIF

		SA1->(dbsetorder(1))
		SC2->(dbsetorder(1))
		SC2->(dbSeek(xFilial("SC2")+SD2->D2_COD))
		dbSelectArea("SD2")
		SD2->(DbSetOrder(5))
		#IFDEF TOP
		    cAliasSD2 := "AliasSD2"
			aStruSD2  := SD2->(dbStruct())
			cQuery    := "SELECT * "
			cQuery    += "FROM "+RetSqlName("SD2")+" SD2 "
			cQuery    += "WHERE SD2.D2_FILIAL='"+xFilial("SD2")+"' AND "
			cQuery    += "SD2.D2_EMISSAO >= '"+DTOS(MV_PAR01)+"' AND "
			cQuery    += "SD2.D2_EMISSAO <= '"+DTOS(MV_PAR02)+"' AND "
			cQuery    += "SD2.D_E_L_E_T_=' ' "
			cQuery    += "ORDER BY "+SqlOrder(SD2->(IndexKey()))

			cQuery    := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2,.T.,.T.)

			For nX := 1 To Len(aStruSD2)
				If ( aStruSD2[nX][2] <> "C" )
					TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
				EndIf
			Next nX
		#ELSE
		    cAliasSD2 := "SD2"
		    dbSeek(xFilial("SD2")+DTOS(mv_par01),.T.)
		#ENDIF

		While xFilial("SD2")==(cAliasSD2)->D2_FILIAL .And. DTOS((cAliasSD2)->D2_EMISSAO)>=DTOS(MV_PAR01) .And. DTOS((cAliasSD2)->D2_EMISSAO)<=DTOS(MV_PAR02)
		      If SB1->(dbSeek(xFilial("SB1")+(cAliasSD2)->D2_COD))
		         If !Empty(SB1->B1_POSIPI)
		            SF2->(dbSeek(xFilial("SF2")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE))
		            If(SF2->F2_TIPO$"DB",dbSelectArea("SA2"),dbSelectArea("SA1"))
		            dbseek(xFilial()+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)
		            cCgc     :=If(SF2->F2_TIPO$"DB",SA2->A2_CGC,SA1->A1_CGC)
			        cChave   :=If(SF2->F2_TIPO$"DB",SA2->A2_CGC+SA2->A2_EST+SB1->B1_POSIPI,SA1->A1_CGC+SA1->A1_EST+SB1->B1_POSIPI)
			        cTipo    :=If(SF2->F2_TIPO$"DB",SA2->A2_TIPO,SA1->A1_TIPO)
		            If cTipo=="X"
			           cCgc 	 :=SM0->M0_CGC
			           cChave :=cCgc+"EX"
		            Endif
		            If !Empty(cCgc)
		               If PRO->(dbSeek(SB1->B1_POSIPI))
			      	      RecLock("PRO",.F.)
		               Else
		   			      RecLock("PRO",.T.)
					   Endif
					   PRO->TIPOREG    :="PR"
					   PRO->NCMPROD    :=SB1->B1_POSIPI
					   PRO->NCMEXT     :=""
					   PRO->NOMPROD    :=SB1->B1_DESC
					   PRO->PRODUCAO   :=SC2->C2_QUJE
					   PRO->UNIDADE    :=SB1->B1_UM
					   PRO->PVENDA     :=(cAliasSD2)->D2_PRCVEN
					   PRO->(MsUnlock())

			           If !CLI->(dbSeek(cChave))
		   	              RecLock("CLI",.T.)
					      CLI->TIPOREG   :="CL"
					 	  CLI->CGCMF     :=cCgc
						  CLI->NCMPROD   :=SB1->B1_POSIPI
						  CLI->NCMEXT    :=""
						  CLI->UF        :=SUBS(cChave,15,2)
		               Endif
		            Endif
		         Endif
		      Endif
		      (cAliasSD2)->(Dbskip())
		Enddo
		#IFDEF TOP
			dbSelectArea(cAliasSD2)
			dbCloseArea()
		#ENDIF
	EndIf
Next

RecLock("TOT",.T.)
TOT->TIPOREG   :="TO"
TOT->TOTPR     :=PRO->(LastRec())
TOT->TOTIN     :=INS->(LastRec())
TOT->TOTCL     :=CLI->(LastRec())
TOT->TOTFO     :=FNC->(LastRec())
TOT->TOTGER    :=(TOT->TOTPR+TOT->TOTIN+TOT->TOTCL+TOT->TOTFO+3)
TOT->(MsUnlock())

RecLock("COT",.T.)
COT->TIPOREG     :="CT"
COT->NOME        :=VerTpDet("901",.F.,"CADPRO.CFP")
COT->DDD         :=VerTpDet("902",.F.,"CADPRO.CFP")
COT->TELEFONE    :=VerTpDet("903",.F.,"CADPRO.CFP")
COT->EMAIL       :=VerTpDet("904",.F.,"CADPRO.CFP")
COT->(MsUnlock())

PRO->(DbgoTop())
INS->(DbgoTop())
CLI->(DbgoTop())
FNC->(DbgoTop())
COT->(DbgoTop())
Return(.t.)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออหอออออหอออออออออออออออออออหออออหอออออออออปฑฑ
ฑฑบFuncao    ณDeletProบAutorบEdstron E. Correia บDataบ 04/02/02บฑฑ
ฑฑฬออออออออออุออออออออสอออออสอออออออออออออออออออสออออสอออออออออนฑฑ
ฑฑบObjetivo  ณExclui os arquivos temporarios da funcao DadosProบฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function DeletPRO(cArq1,cArq2,cArq3,cArq4,cArq5,cArq6)
DbCloseAll()
Ferase(cArq1+GetDBExtension())
Ferase(cArq1+OrdBagExt())
Ferase(cArq2+GetDBExtension())
Ferase(cArq2+OrdBagExt())
Ferase(cArq3+GetDBExtension())
Ferase(cArq3+OrdBagExt())
Ferase(cArq4+GetDBExtension())
Ferase(cArq4+OrdBagExt())
Ferase(cArq5+GetDBExtension())
Ferase(cArq5+OrdBagExt())
Ferase(cArq6+GetDBExtension())
Ferase(cArq6+OrdBagExt())
Return(.t.)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณDadCompIC   ณ Autor ณ Eduardo Jose Zanardoณ Data ณ 12/03/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณL arquivos .IC e .ST de apuracao de ICMS                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑณRetorno   ณ Retorna os valores dentro do array aAIC					  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpl1-lImpressao 	- Eh Impressao ?						   ฑฑ
ฑฑ			  Expc2-cExtensao 	- Extensao do Arquivo					   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION DadCompIC(lImpressao,cExtensao)

Local aIC       :={}
Local cNomeArq	:= ""
Local aArquivos := {}
Local i         := 0
Local j         := 0
Local cConteudo := ""
Local cValor    := ""
Local cLinha    := ""

Default lImpressao := .F.
Default cExtensao  := ".IC*"

cNomeArq	:=	A970NomeArq()
cNomeArq	:=	Substr(cNomeArq,1,8)+cExtensao

aArquivos:=	Directory(cNomeArq)

If lImpressao
	SetRegua(Len(aArquivos))
Else
	ProcRegua(Len(aArquivos))
EndIf
For i:=1 to Len(aArquivos)
	If lImpressao
		IncRegua()
	Else
		IncProc()
	EndIf
	cConteudo:=	MemoRead(aArquivos[i,1])
	For j:=1 to MLCount(cConteudo,254)
		cLinha	:=	MemoLine(cConteudo,254,j)
		cCampo	:=	Substr(cLinha,1,3)
	    If Alltrim(Substr(cLinha,86,06)) <> ""
			cValor	:=	Alltrim(Substr(cLinha,52,18))
			cValor	:=	StrTran(cValor,".")
			cValor	:=	StrTran(cValor,",",".")
			AADD(aIC,{Alltrim(Substr(cLinha,86,06)),val(cValor)})
		Endif
	Next j
Next i
Return(aIC)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณRetChar     ณ Autor ณ Eduardo Jose Zanardoณ Data ณ 12/03/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณRetira e/ou Substitui caracteres especiais do conteudo      ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpc1-cConteudo - Devera ser passado a string a ser alterado ฑฑ
ฑฑ			  Expl2-lCompleta - Se completa o string com zeros ou branco   ฑฑ
ฑฑ					 at้ o tamanho total 								   ฑฑ
ฑฑ			  Expl3-lConsEsp  - Conserva espaco em no meio da String 	   ฑฑ
ฑฑ			  Expl4-lRetBco   - Se completa a string com espacos em branco ฑฑ
ฑฑ			  Expl5-lRetZero  - Se completa a string com zeros 			   ฑฑ
ฑฑ			  Expl6-lDireita  - Se completa a direita doa string o a	   ฑฑ
ฑฑ					 esquerda								 			   ฑฑ
ฑฑ			  Expn7-nTamanho  = Tamanho final do string 				   ฑฑ
ฑฑ			  Expl8-lSubstitui = Se troca os caracteres de especiais por   ฑฑ
ฑฑ					caracteres validos por exemplo, caracteres acentuados. ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function RetChar(cConteudo,lCompleta,lConsEsp,lRetBco,lRetZero,lDireita,;
				nTamanho,lSubstitui)


Local nT  := 0

Default cConteudo  :=""
Default lCompleta  :=.F.
Default lConsEsp   :=.F.
Default lRetBco    :=.F.
Default lRetZero   :=.F.
Default lDireita   :=.F.
Default nTamanho   := 0
Default lSubstitui :=.F.

cConteudo := Alltrim(cConteudo)
If !Empty(cConteudo)
	If lSubstitui
		NoAcento(cConteudo)
	EndIf
	For nT:=33 to 255
	    If !lConsEsp .or. (lConsEsp .and. Chr(nT) <> " ")
			If (nT >= 33 .and. nT <= 47) .or. (nT >= 58 .and. nT <= 64) .or. (nT >= 91 .and. nT <= 96) .or. (nT >= 123 .and. nT <= 255)
			    If (at(CHR(nT),cConteudo)) > 0
					cConteudo:= StrTran(cConteudo,CHR(nT),"")
				EndIf
			EndIf
		EndIf
	Next nT
EndIf
If lCompleta
	If lRetZero .and. !lDireita
		cConteudo := StrZero(val(cConteudo),nTamanho,0)
	ElseIf lRetZero .and. lDireita
		cConteudo := cConteudo+Replicate("0",nTamanho-Len(cConteudo))
	Endif
	If lRetBco .and. !lDireita
		cConteudo := Replicate(" ",nTamanho-Len(cConteudo))+cConteudo
		ElseIf lRetBco .and. lDireita
		cConteudo := cConteudo+Replicate(" ",nTamanho-Len(cConteudo))
	Endif
Endif

Return(cConteudo)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncion   ณ TotF6Val  ณ Autor ณ Eduardo Jos้ Zanardo  ณ Data ณ21/03/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Totaliza็ใo do Guia Nacional de Recolhimento(GNR) - GIASC  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpd1	-	nDtRef 	- Data da Referencia					   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function TotF6Val(nDtRef)

Local nValor := 0
Local aArea := GetArea()
Local cAliasSF6 := "SF6"
Local lQuery    := .F.
Local cIndSF6	:= ""
Local cChave	:= ""
Local cFiltro   := ""
#IFDEF TOP
	Local aStruSF6  := {}
	Local cQuery    := ""
	Local nSF6      := 0
#ENDIF
DbSelectArea("SF6")
#IFDEF TOP
	If TcSrvType() <> "AS/400"
	    cAliasSF6:= "TotF6Val"
	   	lQuery    := .T.
		aStruSF6  := SF6->(dbStruct())
		cQuery := "SELECT SF6.F6_FILIAL,SUM(SF6.F6_VALOR) TotalSF6 "
		cQuery += "FROM "
		cQuery += RetSqlName("SF6") + " SF6 "
		cQuery += "WHERE "
		cQuery += "SF6.F6_FILIAL = '"+xFilial("SF6")+"' AND "
		cQuery += "SF6.F6_ANOREF = "+ str(nAno,4) +" AND SF6.F6_MESREF = "+ str(nMes,2) +" AND "
	 	cQuery += "SF6.F6_TIPOIMP IN('1','3',' ') AND "
		cQuery += "SF6.F6_CODREC <> '1473' AND "
		cQuery += "SF6.F6_CODREC <> '" + Space(TAMSX3("F6_CODREC")[1]) + "' AND "
			cQuery += "SF6.F6_CLAVENC <>'" + Space(TAMSX3("F6_CLAVENC")[1]) + "' AND "
			cQuery += "SF6.D_E_L_E_T_ = ' ' "
		cQuery += "GROUP BY SF6.F6_FILIAL"
		cQuery := ChangeQuery(cQuery)

		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF6,.T.,.T.)

		For nSF6 := 1 To Len(aStruSF6)
			If aStruSF6[nSF6][2] <> "C" .and. FieldPos(aStruSF6[nSF6][1]) > 0
				TcSetField(cAliasSF6,aStruSF6[nSF6][1],aStruSF6[nSF6][2],aStruSF6[nSF6][3],aStruSF6[nSF6][4])
			EndIf
		Next nSF6
	Else
#ENDIF
		dbSelectArea(cAliasSF6)
		cIndSF6	:=	CriaTrab(NIL,.F.)
		cChave	:=	IndexKey()
		cFiltro	:=	"SF6->F6_FILIAL == '"+xFilial()+"'"
		cFiltro	+=	" .And. SF6->F6_ANOREF ="+ str(nAno,4) +" .And. SF6->F6_MESREF="+ str(nMes,2) +" .and. SF6->F6_CODREC <> '1473'"
	 	cFiltro	+=	" .And. SF6->F6_TIPOIMP$'1#3# '"
		cFiltro	+=	" .And. SF6->F6_CODREC <>'" + Space(TAMSX3("F6_CODREC")[1]) + "'"
		cFiltro	+=	" .And. SF6->F6_CLAVENC <>'" + Space(TAMSX3("F6_CLAVENC")[1]) + "'"
		IndRegua(cAliasSF6,cIndSF6,cChave,,cFiltro)
			(cAliasSF6)->(DbgoTop())
#IFDEF TOP
	Endif
#ENDIF
while xFilial("SF6") == (cAliasSF6)->F6_FILIAL .and. (cAliasSF6)->(!eof())
	If AllTrim(SF6->F6_CLAVENC) <> "10243"
		If lQuery
   			nValor += (cAliasSF6)->TotalSF6
		Else
			nValor += (cAliasSF6)->F6_VALOR
		EndIf
	EndIf
	(cAliasSF6)->(dbSkip())
EndDo
If lQuery
    dbSelectArea(cAliasSF6)
	dbCloseArea()
Endif
dbSelectArea("SF6")
RetIndex("SF6")
RestArea(aArea)

Return(nValor)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณDadosAdm  ณ Autor ณMauricio Pequim Jr     ณ Data ณ07.05.2002ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de selecao dos modulos admnistrativos                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray com o Lay-Out da Instr.Normativa                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1: Arquivo                                              ณฑฑ
ฑฑณ          ณExpC2: Identificador de selecao                             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function DadosAdm(cAlias,cFile)

#IFDEF TOP
	Local aStru := (cAlias)->(dbStruct())
	Local nLaco	:= 0
#ENDIF

DEFAULT cFile := cAlias

If cFile == "BBR"
	#IFDEF TOP
		cQuery	:= "SELECT * FROM " + RetSqlName(cAlias) + " WHERE "
		cQuery	+= " E5_FILIAL = '" + xFilial(cAlias) + "'"
		cQuery	+= " AND E5_DTDIGIT >= '" + DTOS(mv_par01) + "'"
		cQuery	+= " AND E5_DTDIGIT <= '" + DTOS(mv_par02) + "'"
		cQuery	+= " AND E5_TIPODOC IN ('VL','BA','CP','LJ','V2')"
		cQuery	+= " AND D_E_L_E_T_ <> '*'"
		cQuery 	+= " ORDER BY " + SqlOrder("E5_FILIAL, E5_DTDIGIT, E5_PREFIXO, E5_NUMERO, E5_PARCELA, E5_TIPO, E5_CLIFOR, E5_LOJA, E5_SEQ")

		cQuery := ChangeQuery(cQuery)
		DbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cFile, .F., .T.)
		For nLaco:=1 to Len(aStru)
			If aStru[nLaco,2] != 'C'
				TCSetField(cFile, aStru[nLaco,1], aStru[nLaco,2],aStru[nLaco,3],aStru[nLaco,4])
			EndIf
		Next
	#ELSE
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Abre o SE5 com outro alias para ser filtrado porque a funcao    ณ
		//ณ TemBxCanc() utilizara o SE5 sem filtro.						    ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		ChkFile("SE5",.F.,cFile)

		DbSelectArea(cFile)

		cCondicao	:= "E5_FILIAL=='"+xFilial("SE5")+"'.And."
		cCondicao 	+= "DTOS(E5_DTDIGIT)>='"+dtos(mv_par01)+"'.And."
		cCondicao 	+= "DTOS(E5_DTDIGIT)<='"+dtos(mv_par02)+"'.And."
		cCondicao	+= "E5_TIPODOC $ 'VL#BA#CP#LJ#V2'"
		cChaveInd	:= "E5_FILIAL+DTOS(E5_DTDIGIT)+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ"
		cArqTemp	:= CriaTrab(NIL,.F.)

		IndRegua(cFile,cArqTemp,cChaveInd,,cCondicao,)

		nIndice := RetIndex("SE5",cFile)

		DbSelectArea(cFile)
		DbSetIndex(cArqTemp+OrdBagExt())
		DbSetOrder(nIndice+1)
		DbGotop()
	#ENDIF

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Movimentacao das Baixas a Pagar 						     ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
ElseIf cFile == "BBP"
	#IFDEF TOP
		cQuery	:= "SELECT * FROM " + RetSqlName(cAlias) + " WHERE "
		cQuery	+= " E5_FILIAL = '" + xFilial(cAlias) + "'"
		cQuery += " AND E5_DTDIGIT >= '" + DTOS(mv_par01) + "'"
		cQuery += " AND E5_DTDIGIT <= '" + DTOS(mv_par02) + "'"
		cQuery += " AND E5_TIPODOC IN ('VL','BA','CP','LJ')"
		cQuery += " AND D_E_L_E_T_ <> '*'"

		cQuery += " ORDER BY " + SqlOrder("E5_FILIAL, E5_DTDIGIT, E5_PREFIXO, E5_NUMERO, E5_PARCELA, E5_TIPO, E5_CLIFOR, E5_LOJA, E5_SEQ")
		cQuery := ChangeQuery(cQuery)
		DbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cFile, .F., .T.)
		For nLaco:=1 to Len(aStru)
			If aStru[nLaco,2] != 'C'
				TCSetField(cFile, aStru[nLaco,1], aStru[nLaco,2],aStru[nLaco,3],aStru[nLaco,4])
			EndIf
		Next
	#ELSE
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Abre o SE5 com outro alias para ser filtrado porque a funcao    ณ
		//ณ TemBxCanc() utilizara o SE5 sem filtro.							ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		ChkFile("SE5",.F.,cFile)

		DbSelectArea(cFile)

		cCondicao	:= "E5_FILIAL=='"+xFilial("SE5")+"'.And."
		cCondicao 	+= "DTOS(E5_DTDIGIT)>='"+dtos(mv_par01)+"'.And."
		cCondicao 	+= "DTOS(E5_DTDIGIT)<='"+dtos(mv_par02)+"'.And."
		cCondicao	+= "E5_TIPODOC $ 'VL#BA#CP#LJ'"
		cChaveInd	:= "E5_FILIAL+DTOS(E5_DTDIGIT)+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ"
		cArqTemp	:= CriaTrab(NIL,.F.)

		IndRegua(cFile,cArqTemp,cChaveInd,,cCondicao)
		nIndice := RetIndex("SE5",cFile)

		DbSelectArea(cFile)
		DbSetIndex(cArqTemp+OrdBagExt())
		DbSetOrder(nIndice+1)
		DbGotop()
	#ENDIF

ElseIf cFile == "SE1"
	#IFDEF TOP
		dbSelectArea("SE1")
		dbCloseArea()
		dbSelectArea("SA1")

		cQuery	:= "SELECT * FROM " + RetSqlName(cAlias) + " WHERE "
		cQuery	+= " E1_FILIAL = '" + xFilial(cAlias) + "'"
		cQuery	+= " AND E1_EMISSAO >= '" + DTOS(mv_par01) + "'"
		cQuery	+= " AND E1_EMISSAO <= '" + DTOS(mv_par02) + "'"
		cQuery	+= " AND E1_TIPO NOT IN " +FormatIn(MVPROVIS+MVRECANT+MV_CRNEG+MVABATIM,,3)
		cQuery	+= " AND D_E_L_E_T_ <> '*'"

		cQuery += " ORDER BY " + SqlOrder("E1_FILIAL, E1_EMISSAO, E1_PREFIXO, E1_NUM, E1_PARCELA, E1_TIPO, E1_CLIENTE, E1_LOJA")

		cQuery := ChangeQuery(cQuery)
		DbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cFile, .F., .T.)
		For nLaco:=1 to Len(aStru)
			If aStru[nLaco,2] != 'C'
				TCSetField(cFile, aStru[nLaco,1], aStru[nLaco,2],aStru[nLaco,3],aStru[nLaco,4])
			EndIf
		Next
	#ELSE
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Abre o SE5 com outro alias para ser filtrado porque a funcao    ณ
		//ณ TemBxCanc() utilizara o SE5 sem filtro.						    ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		DbSelectArea(cFile)

		cCondicao	:= "E1_FILIAL=='"+xFilial()+"'.And."
		cCondicao 	+= "DTOS(E1_EMISSAO)>='"+dtos(mv_par01)+"'.And."
		cCondicao 	+= "DTOS(E1_EMISSAO)<='"+dtos(mv_par02)+"'.And."
		cCondicao	+= "!(E1_TIPO$'"+MVPROVIS+'/'+MVRECANT+'/'+MV_CRNEG+'/'+MVABATIM+"')"
		cChaveInd	:= "E1_FILIAL+DTOS(E1_EMISSAO)+E1_PREFIXO+E1_NUM+E1_PARCELA+E1_TIPO+E1_CLIENTE+E1_LOJA"
		cArqTemp	:= CriaTrab(NIL,.F.)

		IndRegua(cFile,cArqTemp,cChaveInd,,cCondicao)
		nIndice := RetIndex(cFile)

		DbSelectArea(cFile)
		DbSetIndex(cArqTemp+OrdBagExt())
		DbSetOrder(nIndice+1)
		DbGotop()
	#ENDIF

ElseIf cFile == "SE2"
	#IFDEF TOP
		dbSelectArea("SE2")
		dbCloseArea()
		dbSelectArea("SA2")

		cQuery	:= "SELECT * FROM " + RetSqlName(cAlias) + " WHERE "
		cQuery	+= " E2_FILIAL = '" + xFilial(cAlias) + "'"
		cQuery	+= " AND E2_EMIS1 >= '" + DTOS(mv_par01) + "'"
		cQuery	+= " AND E2_EMIS1 <= '" + DTOS(mv_par02) + "'"
		cQuery	+= " AND E2_TIPO NOT IN "+FormatIn(MVPROVIS+MVPAGANT+MV_CPNEG+MVABATIM,,3)
		cQuery	+= " AND D_E_L_E_T_ <> '*'"
		cQuery 	+= " ORDER BY " + SqlOrder("E2_FILIAL, E2_EMIS1, E2_PREFIXO, E2_NUM, E2_PARCELA, E2_TIPO, E2_FORNECE, E2_LOJA")

		cQuery := ChangeQuery(cQuery)

		DbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cFile, .F., .T.)
		For nLaco:=1 to Len(aStru)
			If aStru[nLaco,2] != 'C'
				TCSetField(cFile, aStru[nLaco,1], aStru[nLaco,2],aStru[nLaco,3],aStru[nLaco,4])
			EndIf
		Next
	#ELSE
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Abre o SE5 com outro alias para ser filtrado porque a funcao    ณ
		//ณ TemBxCanc() utilizara o SE5 sem filtro.						    ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		DbSelectArea(cFile)

		cCondicao	:= "E2_FILIAL=='"+xFilial()+"'.And."
		cCondicao 	+= "DTOS(E2_EMIS1)>='"+dtos(mv_par01)+"'.And."
		cCondicao 	+= "DTOS(E2_EMIS1)<='"+dtos(mv_par02)+"'.And."
		cCondicao	+= "!(E2_TIPO$'"+MVPROVIS+'/'+MVPAGANT+'/'+MV_CPNEG+'/'+MVABATIM+"')"
		cChaveInd	:= "E2_FILIAL+DTOS(E2_EMIS1)+E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA"
		cArqTemp	:= CriaTrab(NIL,.F.)

		IndRegua(cFile,cArqTemp,cChaveInd,,cCondicao)
		nIndice := RetIndex(cFile)

		DbSelectArea(cFile)
		DbSetIndex(cArqTemp+OrdBagExt())
		DbSetOrder(nIndice+1)
		DbGotop()
	#ENDIF

Endif

Return

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณSelAdm    ณ Autor ณMauricio Pequim Jr     ณ Data ณ07.05.2002ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de selecao dos modulos admnistrativos                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณRetorna .T. se registro for valido                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1: Arquivo                                              ณฑฑ
ฑฑณ          ณExpC2: Identificador de selecao                             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function SelAdm(cAlias,cFile)

Local lRet := .T.
Local lFound := .F.
Local nIndex := 0

If cFile $ "BBR/BBP"
	DbSelectArea(cFile)
	ProcRegua(LastRec())
	If cFile == "BBR"
		SA1->(dbSeek(xFilial("SA1")+(cFile)->(E5_CLIFOR+E5_LOJA)))
		lFound := SE1->(dbSeek(xFilial("SE1")+(cFile)->(E5_CLIFOR+E5_LOJA+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)))
	Else
		SA2->(dbSeek(xFilial("SA2")+(cFile)->(E5_CLIFOR+E5_LOJA)))
		lFound := SE2->(dbSeek(xFilial("SE2")+(cFile)->(E5_CLIFOR+E5_LOJA+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)))
		nIndex := SE2->(IndexOrd()) //Retorna a posi็ใo do ํndice corrente
	Endif
	// Verifica se o movimento possui titulo na filial selecionada
	If lRet .And. !lFound
		Conout( 'SELADM: Titulo nใo encontrado na filial.' )
		lRet := .F.
	EndIf
	If lRet .And. ( E5_TIPO $ (MVPAGANT+"/"+MVRECANT+"/"+MV_CPNEG+"/"+MV_CRNEG) )
		lRet := .F.
	EndIf
	If lRet .and. (Empty(E5_NUMERO) .Or. Empty(E5_TIPODOC) .Or. ;
			!(E5_TIPODOC $ "VL/BA/CP/V2/LJ") .Or. IIF(cFile == "BBR",E5_RECPAG == "P",E5_RECPAG == "R"))
		lRet := .F.
	EndIf
	If lRet .and. E5_SITUACA == "C"
		lRet := .F.
	EndIf

	If lRet
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Posiciona o SE5 pois o alias do laco e o cFile.                ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		DbSelectArea("SE5")
		DbSetOrder(7)
		DbSeek(xFilial("SE5")+(cFile)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))

		If lRet .and. ExistBlock( "FSELADM" )
			lRet := ExecBlock( "FSELADM", .F., .F. )
		Endif

		//Posiciono sobre o movimento principal da baixa
		While !Eof() .and. SE5->(E5_FILIAL+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ) == ;
								  xFilial("SE5")+(cFile)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ)

			If !(SE5->E5_TIPODOC $ "VL#BA#CP#LJ#V2")
				dbSkip()
				Loop
			Else
				Exit
			Endif
		Enddo
	EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Verifica se existe estorno para esta baixa                       ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If lRet .and. TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
		lRet := .F.
	EndIf

	If lRet
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Posiciona no titulo a receber                                    ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If cFile == "BBR"
			DbSelectArea("SE1")
			DbSetOrder (2)
			cChave	:=	xFilial ("SE1")+(cFile)->(E5_CLIFOR+E5_LOJA+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)
		Else
			DbSelectArea("SE2")
			DbSetOrder (1)
			cChave	:=	xFilial ("SE2")+(cFile)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)
		Endif
		//
		If lRet .and. DbSeek(cChave)
			If cFile == "BBR"
				DbSelectArea("SA1")
			Else
				DbSelectArea("SA2")
			Endif
			DbSetOrder(1)
			If !(DbSeek(xFilial()+(cFile)->(E5_CLIFOR+E5_LOJA)))
				lRet := .F.
			Endif
		Else
			lRet := .F.
		EndIf
	EndIf

	//Restaura indice da tabela SE2
	IF nIndex > 0
		SE2->(dbSetOrder(nIndex))
	Endif

Endif
Return (lRet)


/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณFormatDateณ Autor ณ Wagner Mobile Costa   ณ Data ณ 08/05/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณConverte um data para o formato ddmmaaaa						  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ Generico                                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function FormatDate(dData)

Return Left(Dtoc(dData), 2) + Subs(Dtoc(dData), 4, 2) + Str(Year(dData), 4)


/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณCloseAdm  ณ Autor ณMauricio Pequim Jr     ณ Data ณ 08/05/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFecha as querys criadas e reabre os respectivos arquivos    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1: Arquivo                                              ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ Generico                                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function CloseAdm(cFile)

#IFDEF TOP
	dbSelectArea(cFile)
	dbCloseArea()
	ChKFile(cFile)
	dbSelectArea(cFile)
	dbSetOrder(1)
#ELSE
	dbSelectArea(cFile)
	dbClearFilter()
	RetIndex(cFile)
	dbSetOrder(1)
#ENDIF

Return
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncion   ณDumpiNI86ณ Autor ณ Eduardo Jose Zanardo  ณ Data ณ 10/06/02  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Gera o Dump do Arquivos gerados                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpl1	-	lGera 	- Gera Relatorio						   ฑฑ
ฑฑ			  Expc2	-	cDest 	- Nome do Arquivo destino				   ฑฑ
ฑฑ			  Expc3	-	cDir 	- Diretorio de Origem dos Arquuivos Geradosฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DumpIni86(lGera,cDest,cDir)

Local Titulo   := OemToAnsi(STR0028)
Local cString  := ""          // Alias utilizado na Filtragem
Local lDic     := .F.         // Habilita/Desabilita Dicionario
Local lComp    := .T.         // Habilita/Desabilita o Formato Comprimido/Expandido
Local lFiltro  := .F.         // Habilita/Desabilita o Filtro
Local cDesc1  := "Este relatorio imprime a listagem de acompanhamento dos meios-magnetivos"
Local wnrel    := "NORMA086"  // Nome do Arquivo utilizado no Spool
Local nomeprog := "GeraDump"  // nome do programa
LOCAL aArea	   := GetArea()

Private Tamanho := "G" // P/M/G
Private Limite  := 220 // 80/132/220
Private aOrdem  := {}  // Ordem do Relatorio
Private aReturn := {OemToAnsi(STR0001), 1,OemToAnsi(STR0002),1,2,1,"",1} //"Zebrado"###"Administracao"
						//[1] Reservado para Formulario
						//[2] Reservado para Nง de Vias
						//[3] Destinatario
						//[4] Formato => 1-Comprimido 2-Normal
						//[5] Midia   => 1-Disco 2-Impressora
						//[6] Porta ou Arquivo 1-LPT1... 4-COM1...
						//[7] Expressao do Filtro
						//[8] Ordem a ser selecionada
						//[9]..[10]..[n] Campos a Processar (se houver)

Private lEnd    := .F.// Controle de cancelamento do relatorio
Private m_pag   := 1  // Contador de Paginas
Private nLastKey:= 0  // Controla o cancelamento da SetPrint e SetDefault

If lGera
	Pergunte("INI086",.T.)
	wnrel:=SetPrint(cString,wnrel,"",@titulo,cDesc1,"","",lDic,aOrdem,lComp,Tamanho,,lFiltro)
	If ( nLastKey==27 )
		Return
	Endif

	SetDefault(aReturn,cString)

	If ( nLastKey==27 )
		Return
	Endif

	RptStatus({|lEnd| ImpDump86(@lEnd,wnrel,cString,nomeprog,Titulo,cDest,cDir)},Titulo)

EndIf
RestArea(aArea)
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณRecupera os MV_PAR do Mata950ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
Pergunte("MTA950",.F.)
Return(.T.)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณProgram   ณ ImpDump86ณ Autor ณ Eduardo Jose Zanardo  ณ Data ณ10.07.2002ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณControle de Fluxo do Relatorio.                             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpl1	-	lEnd 	- Controle de cancelamento do relatorio	   ฑฑ
ฑฑ			  Expc2	-	wnrel 	- Nome do Arquivo utilizado no Spool	   ฑฑ
ฑฑ			  Expc3	-	cString	- Alias utilizado na Filtragem			   ฑฑ
ฑฑ			  Expc4	-	nomeprog- Nome do Arquivo do Relatorio			   ฑฑ
ฑฑ			  Expc5	-	Titulo	- Titulo do Relatorio					   ฑฑ
ฑฑ			  Expc6	-	cDest	- Nome do Arquuivo Destino				   ฑฑ
ฑฑ			  Expc7	-	cDir	- Diretorio de Origem dos Arquuivos Geradosฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/

Static Function ImpDump86(lEnd,wnrel,cString,nomeprog,Titulo,cDest,cDir)

Local aNorma    := ReadNorma("NORMA086.INI")
Local nTNorma   := len(aNorma)
Local li        := 100 // Contador de Linhas
Local lImp      := .F. // Indica se algo foi impresso
Local cbCont    := 0   // Numero de Registros Processados
Local cbText    := ""  // Mensagem do Rodape
Local nReg      := 1
Local nContArq	:= 0
Local cLinha	:= ""
Local nCtPagIni := 0
Local nCtPagFim := 0
Local nHdlTxt   := 0
Local aDump		:= {}
Local nX		:= 0
Local nY		:= 0
Local nTotIni 	:= 0
Local lPos 		:= .F.
Local lPag 		:= .F.

//
//                          1         2         3         4         5         6         7         8         9        10        11        12        13        14        15        16        17        18        19        20        21        22
//                01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
SetRegua(nTNorma)
While nReg <= nTNorma
	lImp      := .F.
	li        := 100
	nCtPagIni := 0
	nCtPagFim := 0
	nHdlTxt   := 0
	aDump	  := {}
	nX 		  := 0
	lPos 	  := .F.
	lPag 	  := .F.
	#IFNDEF WINDOWS
		If LastKey() = 286
			lEnd := .T.
		EndIf
	#ENDIF
	If lEnd
		@ Prow()+1,001 PSAY STR0031 //"CANCELADO PELO OPERADOR"
		Exit
	EndIf
	If (Len(aNorma[nReg,8,1]) > 0) .and. (!Empty(alltrim(aNorma[nReg,8,1,1])))
    	If (File(cDir+alltrim(aNorma[nReg,8,1,1])))
			FT_FUse(cDir+alltrim(aNorma[nReg,8,1,1]))
			FT_FGotop()
			If (!FT_FEof())
				While(!FT_FEof())
					cLinha :=FT_FReadLN()
				   	aadd(aDump,Substr(alltrim(cLinha),1,220))
					If Len(aDump) == 1
					   	nContArq := Directory(cDir+alltrim(aNorma[nReg,8,1,1]))[1][2]/(len(cLinha)+2)
					ElseIf Len(aDump) == 31 .and. !lPos
						FT_FGoto(Min(Directory(cDir+alltrim(aNorma[nReg,8,1,1]))[1][2],1))
						lPos := .T.
					EndIf
					If Len(aDump) > 60
						aDump := aDel(aDump,31)
						aDump := aSize(aDump,60)
					EndIf
					FT_FSkip()
				EndDo
			EndIf
			If Len(aDump) > 0
	            If Len(aDump) > 30
	            	nTotIni := 30
	            	nY := Len(aDump) - 29
	            ElseIf Len(aDump) == 30
					nTotIni := Len(aDump)
	            	nY := 1
	            ElseIf Len(aDump) < 30
					nTotIni := Len(aDump)
	            	nY := 1
	     	    EndIf
				For nX := 1 to nTotIni
							If ( li > 58 )
							 	nCtPagIni++
								li := cabec(Titulo,"","",nomeprog,Tamanho,CHRCOMP)
								li++
							Endif
					@li, 00 Psay substr(aDump[nX],1,220)
					li++
					lImp := .T.
				Next nX
				li := 100
				For nY := nY to Len(aDump)
						If ( li > 58 )
							nCtPagFim++
							li := cabec(Titulo,"","",nomeprog,Tamanho,CHRCOMP)
							li++
						Endif
					@li, 00 Psay substr(aDump[nY],1,220)
					li++
					lImp := .T.
				Next nY
			EndIf
        EndIf
   	EndIf
   	If lImp
		//
		//                          1         2         3         4         5         6         7         8         9        10        11        12        13        14        15        16        17        18        19        20        21        22
		//                01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
		li := 100
		If ( li > 58 )
			li := cabec(Titulo,"","",nomeprog,Tamanho,CHRCOMP)
			li++
		Endif
		@li, 00 Psay OemToAnsi(STR0029) + Alltrim(SM0->M0_CGC)
		li++
		@li, 00 Psay OemToAnsi(STR0030) + Alltrim(SM0->M0_NOME)
		li:= li + 2
		@li, 00 Psay Replicate("-",220)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0003) + alltrim(aNorma[nReg,8,1,1])
		@li, 60 Psay OemToAnsi(STR0004)
		@li, 77 psay dDataBase Picture "99/99/9999"
		li++
		@li, 00 Psay OemToAnsi(STR0005)
  		li++
		@li, 00 Psay OemToAnsi(STR0006)
		li++
		@li, 00 Psay OemToAnsi(STR0007)
		li++
		@li, 00 Psay OemToAnsi(STR0008)
		li++
		@li, 00 Psay OemToAnsi(STR0009)
		li++
		@li, 00 Psay OemToAnsi(STR0010)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0011)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0012) + Alltrim(Str(nCtPagIni)) + OemToAnsi(STR0027)
		li++
		@li, 00 Psay OemToAnsi(STR0013) + Alltrim(Str(nCtPagFim)) + OemToAnsi(STR0027)
		li++
		@li, 00 Psay OemToAnsi(STR0014) + Alltrim(Str(0)) + OemToAnsi(STR0027)
		li++
		@li, 00 Psay OemToAnsi(STR0015)
		li++
		@li, 00 Psay OemToAnsi(STR0016) + Alltrim(Str(nContArq))
		li++
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณHa a necessidade de copiar o arquivo gerado para um temporario           ณ
		//ณpois o arquivo original encontra-se em memoria e nao fisicamente gravado.ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		Ferase(cDir+"XTEMP.TXT")
		__CopyFile(cDir+alltrim(aNorma[nReg,8,1,1]),cDir+"XTEMP.TXT")
		nHdlTxt:=FOpen(cDir+"XTEMP.TXT")
		@li, 00 Psay OemToAnsi(STR0017) + If(nHdlTxt<>Nil .and. nHdlTxt<>-1,Alltrim(Str(FSeek(nHdlTxt,0,2))),"0")
		FClose(nHdlTxt)
		Ferase(cDir+"XTEMP.TXT")
		li++
		@li, 00 Psay OemToAnsi(STR0018)
		li:= li + 2
		@li, 00 Psay Replicate("-",220)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0019) + Alltrim(mv_par11) + ", " + dToc(mv_par12) + "."
		li:= li + 3
		@li, 00 Psay OemToAnsi(STR0020)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0021) + alltrim(mv_par01)
		li++
		@li, 00 Psay OemToAnsi(STR0022) + alltrim(str(mv_par02))
		@li, 35 Psay OemToAnsi(STR0023) + alltrim(str(mv_par03))
		@li, 65 Psay OemToAnsi(STR0024) + alltrim(str(mv_par04))
		li++
		@li, 00 Psay OemToAnsi(STR0025) + alltrim(mv_par05)
		li:= li + 3
		@li, 00 Psay OemToAnsi(STR0026)
		li:= li + 2
		@li, 00 Psay OemToAnsi(STR0021) + alltrim(mv_par06)
		li++
		@li, 00 Psay OemToAnsi(STR0022) + alltrim(str(mv_par07))
		@li, 35 Psay OemToAnsi(STR0023) + alltrim(str(mv_par08))
		@li, 65 Psay OemToAnsi(STR0024) + alltrim(str(mv_par09))
		li++
		@li, 00 Psay OemToAnsi(STR0025) + alltrim(mv_par10)
		li := 100
	EndIf

	cbCont++
	nReg++

	IncRegua()
EndDo

If ( lImp )
	Roda(cbCont,cbText,Tamanho)
EndIf

Set Device To Screen
Set Printer To
If ( aReturn[5] = 1 )
	dbCommitAll()
	OurSpool(wnrel)
Endif
MS_FLUSH()
Return(.T.)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณAPURADIF  บAutor  ณEduardo Jos้ Zanardoบ Data ณ  10/07/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณApura็ใo da DIF(Declara็ใo Especial de Informa็๕es Relativasบฑฑ
ฑฑบ          ณao Controle de Papel Imune)                                 บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function APURADIF()


Local aCampos	:= {}
Local aEmpresa  := {}
Local lIntegra  := IF(GetMV("MV_EASY")=="S",.T.,.F.)
Local cNumDI    := ""
Local cAliasSD1 := "SD1"
Local cAliasSF1 := "SF1"
Local cAliasSF3 := "SF3"
Local cAliasSF4 := "SF4"
Local cAliasSB1 := "SB1"
Local cAliasSWN := "SWN"
Local cAliasSW6 := "SW6"
Local cAliasSD2 := "SD2"
Local cAliasSF2 := "SF2"
Local lQuery    := .F.
Local aStruSD1  := {}
Local aStruSF3  := {}
Local aStruSD2  := {}
Local aStruSF2  := {}
Local aStruSF1  := {}
Local aStruSB1  := {}
Local aStruSWN  := {}
Local aStruSW6  := {}
Local cQuery 	:= ""
Local nSB1 		:= 0
Local nSF3 		:= 0
Local nSD1 		:= 0
Local nSF2 		:= 0
Local nSF1 		:= 0
Local nSD2 		:= 0
Local nSWN 		:= 0
Local nSW6 		:= 0
Local cIndSD1	:= ""
Local cIndSF1	:= ""
Local cIndSF2	:= ""
Local cIndSF3	:= ""
Local cIndSD2	:= ""
Local cIndSF4	:= ""
Local cIndSB1	:= ""
Local cIndSWN	:= ""
Local cIndSW6	:= ""
Local cChave	:= ""
Local cFiltro	:= ""
Local cDoc   	:= ""
Local cSerie 	:= ""
Local cCNPJ 	:= ""
Local cDtDigit 	:= ""
Local cTipoNF 	:= ""
Local cCFONF 	:= ""
Local cItem 	:= ""
Local cDtEmis 	:= ""
Local cNCM 		:= ""
Local cDescTab 	:= ""
Local cCFOP 	:= ""
Local cCodProd 	:= ""
Local cQuant 	:= ""
Local cValUnit 	:= ""
Local cValTotIt := ""
Local cDI 		:= ""
Local cFilIni   := ""
Local cFilFim   := ""
Local cTipoReg	:= ""
Local cCNPJEmp	:= ""
Local cSemest	:= ""
Local nEmpresa 	:= 1
Local cDocNf   	:= ""
Local cSerieNf 	:= ""
Local cSerieF3 	:= ""
Local cSerieWN 	:= ""
Local cSerieD1 	:= ""
Local cSerieD2 	:= ""
Local TipoPD	:= ""
Local nRegEmp   := SM0->(RecNo())
Local aRetDif	:= {}
Local cINI071	:= GetMV("MV_INI71")
Local cINI71F4	:= GetNewPar("MV_IN71F4","")
Local lGrava 	:= .F.
Local cIndica   := ""
Local cDocVin  	:= ""
Local cSeriVin	:= ""
Local cChaveSf3	:=	""
Local lSelFil	:= IiF(MV_PAR06==1, .T., .F.)		// Define se seleciona filiais pela rotina MATA950 que estแ ativa neste momento
Local lAglut	:= .F.
Local nVez		:= 0
Local lAPDIF01	:= ExistBlock("APDIF01")
Local lAPDIF02	:= ExistBlock("APDIF02")
Local lSDoc		:= SerieNfId("SF3",3,"F3_SERIE")== "F3_SDOC"

pergunte("INI071",.T.)

cFilIni  := mv_par01       // Filial de ?
cFilFim  := mv_par02       // Filial Ate ?
cSemest := RetChar(mv_par03,.T.,.F.,.F.,.T.,.F.,5,.F.) //Semestre ?
cNumDI   := If(!Empty(mv_par04),mv_par04,"0000000000") //Numero de Reg. de Import.?
lAglut	:= ( MV_PAR06 == 1 )								// Define se aglutina registros no grupo de perguntas INI071

#IFDEF TOP
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXฟ
	//ณVariแvel Private declarada no MATA950, serve para sair do loop de filiais e ณ
	//ณprocessar uma ๚nica vez, se utilizou a sele็ใo e aglutina็ใo de filiais.    ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXู
	lExitPFil	:= lSelFil .and. lAglut
#ENDIF

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณRegistro tipo 0 - Arq. de Trabalho       ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aCampos,{"TipoReg"  ,"C",001,0})
AADD(aCampos,{"CNPJEMP"  ,"C",014,0})
AADD(aCampos,{"Semestre" ,"C",005,0})
AADD(aCampos,{"CNPJ"     ,"C",014,0})
AADD(aCampos,{"DOC"	     ,"C",TamSX3("F2_DOC")[1],0})
AADD(aCampos,{"SERIE"    ,"C",TamSX3("F2_SERIE")[1],0})
AADD(aCampos,{"SDOC"     ,"C",003,0})
AADD(aCampos,{"DtDigit"  ,"C",008,0})
AADD(aCampos,{"TipoNF"   ,"C",001,0})
AADD(aCampos,{"DtEmissao","C",008,0})
AADD(aCampos,{"CFOP"	 ,"C",004,0})
AADD(aCampos,{"ValorNF"  ,"C",016,0})
AADD(aCampos,{"Indicador","C",001,0})
AADD(aCampos,{"DOCVinc"	 ,"C",TamSX3("F2_DOC")[1],0})
AADD(aCampos,{"SerVinc"	 ,"C",003,0})
AADD(aCampos,{"DtDgVinc" ,"C",008,0})

TNF	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TNF,"TNF",.T.,.F.)
IndRegua("TNF",TNF,"CNPJ+DtEmissao+DOC+SERIE+TipoNF+CFOP",,,STR0032)
DbSelectArea("TNF")
DbClearIndex()
DbSetIndex(TNF+OrdBagExt())
_aTotal[1] := TNF
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณRegistro tipo 1 - Arq. de Trabalho       ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCampos := {}
AADD(aCampos,{"TipoReg"  ,"C",001,0})
AADD(aCampos,{"CNPJEMP"  ,"C",014,0})
AADD(aCampos,{"Semestre" ,"C",005,0})
AADD(aCampos,{"CNPJ"     ,"C",014,0})
AADD(aCampos,{"DOC"	     ,"C",TamSX3("F2_DOC")[1],0})
AADD(aCampos,{"SERIE"    ,"C",TamSx3("F2_SERIE")[1],0})
AADD(aCampos,{"SDOC"     ,"C",003,0})
AADD(aCampos,{"DtDigit"  ,"C",008,0})
AADD(aCampos,{"TipoNF"   ,"C",001,0})
AADD(aCampos,{"Item"     ,"C",003,0})
AADD(aCampos,{"DtEmissao","C",008,0})
AADD(aCampos,{"NCM"	     ,"C",010,0})
AADD(aCampos,{"TipoPD"   ,"C",001,0})
AADD(aCampos,{"DescTab"  ,"C",005,0})
AADD(aCampos,{"CFOP"	 ,"C",004,0})
AADD(aCampos,{"CodProd"	 ,"C",020,0})
AADD(aCampos,{"Quant"	 ,"C",010,0})
AADD(aCampos,{"ValUnit"  ,"C",009,0})
AADD(aCampos,{"ValTotIt" ,"C",014,0})
AADD(aCampos,{"DINUM"    ,"C",010,0})

TIT	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,TIT,"TIT",.T.,.F.)
IndRegua("TIT",TIT,"CNPJ+DtEmissao+DOC+SERIE+TipoNF+Item",,,STR0032)
DbSelectArea("TIT")
DbClearIndex()
DbSetIndex(TIT+OrdBagExt())
_aTotal[2] := TIT

If !Empty(cINI071) .And. (Substr(cINI071,1,1)=="{" .And. Substr(cINI071,len(cINI071),1)=="}") .And. mv_par05 <> "MA"
	#IFDEF TOP
		If lAglut
			For nVez := 1 to Len(aFilsCalc)
				If aFilsCalc[nVez][1]
					aAdd(aEmpresa,{ cEmpAnt, aFilsCalc[nVez][2]})
				EndIf
			Next
		EndIf
	#ELSE
	dbSelectArea("SM0")
	dbSeek(cEmpAnt+cFilIni,.T.)
	While !Eof() .and. FWGrpCompany() == cEmpAnt .and. FWCodFil() <= cFilFim
		aAdd(aEmpresa,{FWGrpCompany(),FWCodFil()})
		dbSkip()
	EndDo
	SM0->(dbGoTo(nRegEmp))
	cFilAnt := FWCodFil()
	#ENDIF

	If Len(aEmpresa) == 0
       	aAdd(aEmpresa, { cEmpAnt, cFilAnt } )
	EndIf
	aEmpresa := asort(aEmpresa,,,{|x,y| x[2] < y[2] })

	While nEmpresa <=  len(aEmpresa)
		dbSelectArea("SM0")
		IF dbSeek(aEmpresa[nEmpresa,1]+aEmpresa[nEmpresa,2],.T.)
			cFilAnt  := FWCodFil()
			cCNPJEmp := RetChar(SM0->M0_CGC,.T.,.F.,.F.,.T.,.F.,14,.F.)
			#IFDEF TOP
				If TcSrvType() <> "AS/400"
				    cAliasSD1:= "DIFSQL"
				    cAliasSF3:= "DIFSQL"
				    cAliasSB1:= "DIFSQL"
					cAliasSF4:= "DIFSQL"
					cAliasSF1:= "DIFSQL"
				    If lIntegra
				    	cAliasSWN:= "DIFSQL"
				    	cAliasSW6:= "DIFSQL"
				    EndIf
				   	lQuery    := .T.
					aStruSD1  := SD1->(dbStruct())
					aStruSB1  := SB1->(dbStruct())
					aStruSF3  := SF3->(dbStruct())
					If lIntegra
						aStruSWN  := SWN->(dbStruct())
						aStruSW6  := SW6->(dbStruct())
					EndIf
					cQuery := "SELECT SF3.F3_FILIAL,SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_ENTRADA,"
					cQuery += "SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_VALCONT,SF3.F3_DTCANC, "
					cQuery += "SF3.F3_CFO,SF3.F3_TIPO, "
					cQuery += "SF1.F1_IMPORT,SF1.F1_VALMERC, "
					cQuery += "SD1.D1_FILIAL,SD1.D1_ITEM,SD1.D1_CF,SD1.D1_COD,SD1.D1_QUANT,SD1.D1_VUNIT, "
					cQuery += "SD1.D1_TOTAL,SD1.D1_TEC,SD1.D1_DOC,SD1.D1_SERIE,SD1.D1_DTDIGIT,SD1.D1_EMISSAO, "
					cQuery += "SD1.D1_CF,SD1.D1_TIPO,SD1.D1_NFORI,SD1.D1_SERIORI,SD1.D1_FORNECE,SD1.D1_LOJA,  "
				    cQuery += "SB1.B1_FILIAL,SB1.B1_ESPECIE,SB1.B1_POSIPI,SB1.B1_COD"
				    If lIntegra
				    	cQuery += ",SWN.WN_DOC,SWN.WN_SERIE,SWN.WN_PRODUTO,SWN.WN_ITEM,SWN.WN_QUANT,"
				    	cQuery += "SWN.WN_VALOR,SWN.WN_PRUNI,SWN.WN_CFO,"
				    	cQuery += "SW6.W6_DI_NUM"
					EndIf

					If lSDoc .and. lIntegra
						cQuery += ",SF3.F3_SDOC,SD1.D1_SDOCORI,SWN.WN_SDOC, SD1.D1_SDOC "
					ElseIf 	lSDoc .and. !lIntegra
						cQuery += ",SF3.F3_SDOC,SD1.D1_SDOCORI, SD1.D1_SDOC "
					EndIf

					cQuery += " FROM "
					cQuery += RetSqlName("SF1") + " SF1 ,"
					cQuery += RetSqlName("SF3") + " SF3 ,"
					cQuery += RetSqlName("SF4") + " SF4 ,"
					cQuery += RetSqlName("SB1") + " SB1 ,"
					cQuery += RetSqlName("SD1") + " SD1 "
					If lIntegra
						cQuery += "LEFT JOIN " + RetSqlName("SWN") + " SWN ON "
						cQuery += "SWN.WN_FILIAL = '"+ xFilial("SWN") +"' AND "
						cQuery += "SWN.WN_DOC = SD1.D1_DOC AND "
						cQuery += "SWN.WN_SERIE = SD1.D1_SERIE AND "
						cQuery += "SWN.WN_TEC||SWN.WN_EX_NCM||SWN.WN_EX_NBM = SD1.D1_TEC AND "
						cQuery += "SWN.D_E_L_E_T_ = ' ' "
						cQuery += "LEFT JOIN " + RetSqlName("SW6") + " SW6 ON "
						cQuery += "SW6.W6_FILIAL = '"+ xFilial("SW6") +"' AND "
						cQuery += "SW6.W6_HAWB = SWN.WN_HAWB AND "
						cQuery += "SW6.W6_DI_NUM <> '" + space(TamSx3("W6_DI_NUM")[1]) + "' AND "
						cQuery += "SW6.D_E_L_E_T_ = ' ' "
					EndIf
					cQuery += "WHERE "
					cQuery += "SF3.F3_FILIAL = '"+ xFilial("SF3") +"' AND "
					cQuery += "SF3.F3_ENTRADA >= '"+DTOS(dDmainc)+"' AND "
					cQuery += "SF3.F3_ENTRADA <= '"+DTOS(dDmaFin)+"' AND "
					cQuery += "SF3.F3_CFO <= '5000' AND "
					cQuery += "SF3.D_E_L_E_T_ = ' ' AND "
					cQuery += "SF1.F1_DOC = SF3.F3_NFISCAL AND "
					cQuery += "SF1.F1_SERIE = SF3.F3_SERIE AND "
					cQuery += "SF1.F1_FORNECE = SF3.F3_CLIEFOR AND "
					cQuery += "SF1.F1_LOJA = SF3.F3_LOJA AND "
					cQuery += "SF1.F1_TIPO <>'C' AND "
					cQuery += "SF1.D_E_L_E_T_ = ' ' AND "
					cQuery += "SD1.D1_FILIAL= '"+ xFilial("SD1") +"' AND "
					cQuery += "SD1.D1_DOC = SF1.F1_DOC AND "
					cQuery += "SD1.D1_SERIE = SF1.F1_SERIE AND "
					cQuery += "SD1.D1_FORNECE = SF1.F1_FORNECE AND "
					cQuery += "SD1.D1_LOJA = SF1.F1_LOJA AND "
					cQuery += "SD1.D1_TIPO = SF1.F1_TIPO AND "
					cQuery += "SD1.D1_TES <> '   ' AND "
					cQuery += "SD1.D1_CF = SF3.F3_CFO AND "
					cQuery += "SD1.D_E_L_E_T_ = ' ' AND "
					cQuery += "SF4.F4_FILIAL = '"+ xFilial("SF4") +"' AND "
					cQuery += "SF4.F4_CODIGO = SD1.D1_TES AND "
				    cQuery += "SF4.F4_ESTOQUE = 'S' AND "
					cQuery += "SF4.D_E_L_E_T_ = ' ' AND "
					cQuery += "SB1.B1_FILIAL = '"+ xFilial("SB1") +"' AND "
			 		cQuery += "SB1.B1_COD = SD1.D1_COD AND "
					cQuery += "SB1.B1_POSIPI <> '" + space(TamSx3("B1_POSIPI")[1]) + "' AND "
					cQuery += "SB1.D_E_L_E_T_ = ' '"

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณPonto de Entrada para complementar o filtro nos documentos de entrada  ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lAPDIF01
						cQuery := ExecBlock("APDIF01", .F., .F., {cQuery})
					EndIf

					cQuery := ChangeQuery(cQuery)

					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3,.T.,.T.)

					For nSF3 := 1 To Len(aStruSF3)
						If aStruSF3[nSF3][2] <> "C" .and. FieldPos(aStruSF3[nSF3][1]) > 0
							TcSetField(cAliasSF3,aStruSF3[nSF3][1],aStruSF3[nSF3][2],aStruSF3[nSF3][3],aStruSF3[nSF3][4])
						EndIf
					Next nSF3

					For nSF1 := 1 To Len(aStruSF1)
						If aStruSF1[nSF1][2] <> "C" .and. FieldPos(aStruSF1[nSF1][1]) > 0
							TcSetField(cAliasSF1,aStruSF1[nSF1][1],aStruSF1[nSF1][2],aStruSF1[nSF1][3],aStruSF1[nSF1][4])
						EndIf
					Next nSF1

					For nSD1 := 1 To Len(aStruSD1)
						If aStruSD1[nSD1][2] <> "C" .and. FieldPos(aStruSD1[nSD1][1]) > 0
							TcSetField(cAliasSD1,aStruSD1[nSD1][1],aStruSD1[nSD1][2],aStruSD1[nSD1][3],aStruSD1[nSD1][4])
						EndIf
					Next nSD1

					For nSB1 := 1 To Len(aStruSB1)
						If aStruSB1[nSB1][2] <> "C" .and. FieldPos(aStruSB1[nSB1][1]) > 0
							TcSetField(cAliasSB1,aStruSB1[nSB1][1],aStruSB1[nSB1][2],aStruSB1[nSB1][3],aStruSB1[nSB1][4])
						EndIf
					Next nSB1

					If lIntegra
						For nSWN := 1 To Len(aStruSWN)
							If aStruSWN[nSWN][2] <> "C" .and. FieldPos(aStruSWN[nSWN][1]) > 0
								TcSetField(cAliasSWN,aStruSWN[nSWN][1],aStruSWN[nSWN][2],aStruSWN[nSWN][3],aStruSWN[nSWN][4])
							EndIf
						Next nSWN
						For nSW6 := 1 To Len(aStruSW6)
							If aStruSW6[nSW6][2] <> "C" .and. FieldPos(aStruSW6[nSW6][1]) > 0
								TcSetField(cAliasSW6,aStruSW6[nSW6][1],aStruSW6[nSW6][2],aStruSW6[nSW6][3],aStruSB1[nSW6][4])
							EndIf
						Next nSW6
					EndIf
				Else
			#ENDIF

					dbSelectArea(cAliasSF3)
					cIndSF3	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF3->F3_FILIAL=='"+xFilial("SF3")+"' .And. DTOS(SF3->F3_ENTRADA)>='"+DTOS(dDmainc)+"' .AND. DTOS(SF3->F3_ENTRADA)<='"+DTOS(dDmaFin)+"'"
					cFiltro	+= " .AND. SF3->F3_CFO <= '5000'"
					IndRegua(cAliasSF3,cIndSF3,cChave,,cFiltro)
					(cAliasSF3)->(DbgoTop())

					dbSelectArea(cAliasSF1)
					cIndSF1	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF1->F1_FILIAL=='"+xFilial("SF1")+"' .And. DTOS(SF1->F1_DTDIGIT)>='"+DTOS(dDmainc)+"' .AND. DTOS(SF1->F1_DTDIGIT)<='"+DTOS(dDmaFin)+"' .AND. SF1->F1_TIPO <>'C'"
					If lIntegra
						cFiltro	+= " .AND. SF1->F1_IMPORT = 'S'"
					EndIf
					IndRegua(cAliasSF1,cIndSF1,cChave,,cFiltro)
					(cAliasSF1)->(DbgoTop())

					dbSelectArea(cAliasSD1)
					cIndSD1	:=	CriaTrab(NIL,.F.)
					cChave	:=	"SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_CF+SD1->D1_TIPO"
					cFiltro	:=	"SD1->D1_FILIAL=='"+xFilial("SD1")+"' .And. DTOS(SD1->D1_DTDIGIT)>='"+DTOS(dDmainc)+"' .AND. DTOS(SD1->D1_DTDIGIT)<='"+DTOS(dDmaFin)+"' .AND. SD1->D1_TES <> '   ' .AND. SD1->D1_TIPO <>'C'"
					IndRegua(cAliasSD1,cIndSD1,cChave,,cFiltro)
					(cAliasSD1)->(DbgoTop())

					dbSelectArea(cAliasSB1)
					cIndSB1	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SB1->B1_FILIAL=='"+xFilial("SB1")+"' .And. SB1->B1_POSIPI <> '" + space(TamSx3("B1_POSIPI")[1]) + "'"
					IndRegua(cAliasSB1,cIndSB1,cChave,,cFiltro)
					(cAliasSB1)->(DbgoTop())

					dbSelectArea(cAliasSF4)
					cIndSF4	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF4->F4_FILIAL=='"+xFilial("SF4")+"' .And. SF4->F4_ESTOQUE == 'S'"
					IndRegua(cAliasSF4,cIndSF4,cChave,,cFiltro)
					(cAliasSF4)->(DbgoTop())

					If lIntegra
						dbSelectArea(cAliasSWN)
						cIndSWN	:=	CriaTrab(NIL,.F.)
						cChave	:=	IndexKey()
						cFiltro	:=	"SWN->WN_FILIAL=='"+xFilial("SWN")+"'"
						IndRegua(cAliasSWN,cIndSWN,cChave,,cFiltro)
						(cAliasSWN)->(DbgoTop())

						dbSelectArea(cAliasSW6)
						cIndSW6	:=	CriaTrab(NIL,.F.)
						cChave	:=	IndexKey()
						cFiltro	:=	"SW6->W6_FILIAL=='"+xFilial("SW6")+"' .And. SW6->W6_DI_NUM <> '" + space(TamSx3("W6_DI_NUM")[1]) + "'"
						IndRegua(cAliasSW6,cIndSW6,cChave,,cFiltro)
						(cAliasSW6)->(DbgoTop())
					EndIf
			#IFDEF TOP
				Endif
			#ENDIF
			If !lQuery
				dbSelectArea(cAliasSF3)
			EndIf
			While (cAliasSF3)->(!EOF()) .and. xFilial("SF3") == (cAliasSF3)->(F3_FILIAL)
			    If (cAliasSF3)->(F3_TIPO)$"BD"
				   	SA1->(dbSetOrder(1))
				    SA1->(dbSeek(xFilial("SA1")+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA)))
				    cCNPJ:= Substr(alltrim(SA1->A1_CGC),1,14)
				Else
					SA2->(dbSetOrder(1))
				    SA2->(dbSeek(xFilial("SA2")+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA)))
				    cCNPJ:= Substr(alltrim(SA2->A2_CGC),1,14)
				EndIf

				cCNPJ := If(lIntegra,cCNPJEmp,cCNPJ)

				If Len(cCNPJ) >= 14 .and. EMPTY((cAliasSF3)->F3_DTCANC) .and. (mv_par05 <> "FP" .or. (mv_par05 == "FP" .And. Substr(Alltrim((cAliasSF3)->F3_CFO),1,4) == '1201' .Or. Substr(Alltrim((cAliasSF3)->F3_CFO),1,4 ) == '2201'))
					cDocNf  	:= RetChar((cAliasSF3)->(F3_NFISCAL),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
					cSerieNf	:= RetChar((cAliasSF3)->(F3_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
					cSerieF3	:= RetChar(SerieNfId(cAliasSF3,2,"F3_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
					cCNPJ		:= RetChar(cCNPJ,.T.,.F.,.F.,.T.,.F.,14,.F.)
					cDtDigit 	:= (Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),7,2))+(Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),5,2))+(Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),1,4))
					cCFONF		:= Substr(Alltrim((cAliasSF3)->(F3_CFO)),1,4)
					cTipoNF		:= "E"

					If !lQuery
						dbSelectArea(cAliasSD1)
						MsSeek(xFilial("SD1")+(cAliasSF3)->(F3_NFISCAL)+(cAliasSF3)->(F3_SERIE)+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA))
						dbSelectArea(cAliasSF1)
						MsSeek(xFilial("SF1")+(cAliasSD1)->(D1_DOC)+(cAliasSD1)->(D1_SERIE)+(cAliasSD1)->(D1_FORNECE)+(cAliasSD1)->(D1_LOJA)+(cAliasSD1)->(D1_TIPO))
					EndIf

					cIndica     := If((cAliasSD1)->(D1_QUANT) > 0,"N","S")
					cDocVin  	:= RetChar((cAliasSD1)->(D1_NFORI),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
					cSeriVin	:= RetChar(SerieNfId(cAliasSD1,2,"D1_SERIORI"),.T.,.F.,.F.,.T.,.F.,3,.F.)
					//lGrava 		:= .T.
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณRegistro Tipo 1 - Dados dos Produtos  ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					While 	cDocNf   == RetChar((cAliasSD1)->(D1_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)		.And. ;
							cSerieNf == RetChar((cAliasSD1)->(D1_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.) 	.And. ;
							cDtDigit  ==	(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),1,4)) .And. ;
							(cAliasSF3)->(F3_CLIEFOR) 	== (cAliasSD1)->(D1_FORNECE)	.And. ;
							(cAliasSF3)->(F3_LOJA)		== (cAliasSD1)->(D1_LOJA)		.And. ;
							(cAliasSD1)->(!EOF()) .And. ;
							xFilial("SD1") == (cAliasSD1)->(D1_FILIAL)

						If lIntegra .and. (cAliasSF1)->(F1_IMPORT) == "S"
							If lQuery
								SB1->(dbSetOrder(1))
								If SB1->(MsSeek(xFilial("SB1")+(cAliasSWN)->(WN_PRODUTO)))
									SB5->(dbSetOrder(1))
									SB5->(dbSeek(xFilial("SB5")+(cAliasSWN)->(WN_PRODUTO)))
									aRetDif   := &cINI071
									If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
										cTipoReg  := "1"
										CNPJEMP	  := cCNPJEmp
										CNPJ 	  := cCNPJ
										Semestre  := cSemest
										cDoc	  := RetChar((cAliasSWN)->(WN_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
										cSerie 	  := RetChar((cAliasSWN)->(WN_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cSerieWN 	  := RetChar(SerieNfId(cAliasSWN,2,"WN_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtDigit  := (Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),1,4))
										cTipoNF   := "E"
										cItem     := RetChar((cAliasSWN)->(WN_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtEmis   := (Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),1,4))
										cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
										cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
										cCFOP     := Substr(alltrim((cAliasSD1)->(D1_CF)),1,4)
										cCodProd  := Substr(alltrim((cAliasSWN)->(WN_PRODUTO)),1,20)
										cQuant    := RetChar(str(NoRound((cAliasSWN)->(WN_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cValUnit  := RetChar(str(NoRound((cAliasSWN)->(WN_PRUNI),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
										cValTotIt := RetChar(str(NoRound((cAliasSWN)->(WN_VALOR),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
										cDI       := RetChar((cAliasSW6)->(W6_DI_NUM),.T.,.F.,.F.,.T.,.F.,10,.F.)

				                   GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
				                   					cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
				                   					cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
				                   					cValTotIt,cDI,cSerieWN)
										GravDifNf(cCNPJEmp,cSemest,cCNPJ,cDocNf,cSerieNf,;
								  					cDtDigit,cTipoNF,cDtEmis,cCFOP,cIndica,If(Alltrim(cIndica) == "S",cDocVin,StrZero(Val("0"),TamSX3("F2_DOC")[1])),;
						   							If(Alltrim(cIndica) == "S",cSeriVin,"000"),;
						   							If(Alltrim(cIndica) == "S",cDtEmis,"00000000"),;
						   							RetChar(str((cAliasSF1)->(F1_VALMERC),16,2),.T.,.F.,.F.,.T.,.F.,16,.F.),cSerieF3)
				                   	EndIf
			                   	EndIf
							Else
								(cAliasSF4)->(DBSETORDER(1))
								(cAliasSF4)->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
								If (cAliasSF4)->F4_ESTOQUE == "S"
									(cAliasSWN)->(DBSETORDER(1))
			                   		(cAliasSWN)->(MsSeek(xFilial("SWN")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_TEC))
			                   		While (cAliasSWN)->(!eof()) .and. (cAliasSWN)->(WN_FILIAL) == xFilial("SWN")
			                   			If (cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSWN)->(WN_PRODUTO)))
		       								SB5->(dbSetOrder(1))
											SB5->(dbSeek(xFilial("SB5")+(cAliasSWN)->(WN_PRODUTO)))
											If (cAliasSW6)->(MsSeek(xFilial("SW6")+(cAliasSWN)->WN_HAWB,.F.))
				                    			aRetDif   := &cINI071
				                    			If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
					                    			cTipoReg  := "1"
													CNPJEMP	  := cCNPJEmp
													CNPJ 	  := cCNPJ
													Semestre  := cSemest
													cDoc	  := RetChar((cAliasSWN)->(WN_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
													cSerie 	  := RetChar((cAliasSWN)->(WN_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
													cSerieWN 	  := RetChar(SerieNfId(cAliasSWN,2,"WN_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
													cDtDigit  := (Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),1,4))
													cTipoNF   := "E"
													cItem     := RetChar((cAliasSWN)->(WN_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
													cDtEmis   := (Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),1,4))
													cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
													cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
													cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
													cCFOP     := Substr(alltrim((cAliasSD1)->(D1_CF)),1,4)
													cCodProd  := Substr(alltrim((cAliasSWN)->(WN_PRODUTO)),1,20)
													cQuant    := RetChar(str(NoRound((cAliasSWN)->(WN_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
													cValUnit  := RetChar(str(NoRound((cAliasSWN)->(WN_PRUNI),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
													cValTotIt := RetChar(str(NoRound((cAliasSWN)->(WN_VALOR),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
													cDI       := RetChar((cAliasSW6)->(W6_DI_NUM),.T.,.F.,.F.,.T.,.F.,10,.F.)

					                    			GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
					                    					cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
					                    					cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
					                    					cValTotIt,cDI,cSerieWN)
					                    			GravDifNf(cCNPJEmp,cSemest,cCNPJ,cDocNf,cSerieNf,;
										  					cDtDigit,cTipoNF,cDtEmis,cCFOP,cIndica,If(Alltrim(cIndica) == "S",cDocVin,StrZero(Val("0"),TamSX3("F2_DOC")[1])),;
								   							If(Alltrim(cIndica) == "S",cSeriVin,"000"),;
								   							If(Alltrim(cIndica) == "S",cDtEmis,"00000000"),;
								   							RetChar(str((cAliasSF1)->(F1_VALMERC),16,2),.T.,.F.,.F.,.T.,.F.,16,.F.),cSerieF3)
					                    		EndIf
				                    		EndIf
				                    	EndIf
			                   			(cAliasSWN)->(dbSkip())
			                   		EndDo
			                   	EndIf
		                   	EndiF

				        Else

						 	If lQuery
					 		    SB1->(dbSetOrder(1))
					 		    If SB1->(msSeek(xFilial("SB1")+(cAliasSB1)->(B1_COD)))
									SB5->(dbSetOrder(1))
									SB5->(dbSeek(xFilial("SB5")+(cAliasSB1)->(B1_COD)))
						 	    	aRetDif   := &cINI071
						 	    	If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
								     	cTipoReg  := "1"
										cCNPJEMP  := cCNPJEmp
										cCNPJ 	  := cCNPJ
										cSemest   := cSemest
										cDoc	  := RetChar((cAliasSD1)->(D1_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
										cSerie 	  := RetChar((cAliasSD1)->(D1_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cSerieD1 	  := RetChar(SerieNfId(cAliasSD1,2,"D1_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtDigit  := (Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),1,4))
										cTipoNF   := "E"
										cItem     := RetChar((cAliasSD1)->(D1_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtEmis   := (Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),1,4))
										cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
										cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
										cCFOP     := Substr(alltrim((cAliasSD1)->(D1_CF)),1,4)
										cCodProd  := Substr(alltrim((cAliasSD1)->(D1_COD)),1,20)
										cQuant    := RetChar(str(NoRound((cAliasSD1)->(D1_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cValUnit  := RetChar(str(NoRound((cAliasSD1)->(D1_VUNIT),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
										cValTotIt := RetChar(str(NoRound((cAliasSD1)->(D1_TOTAL),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
										cDI       := RetChar(alltrim(cNumDI),.T.,.F.,.F.,.T.,.F.,10,.F.)

						        	   	GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
						              				cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
						               				cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
						               				cValTotIt,cDI,cSerieD1)

						               	lGrava 		:= .T.
					                EndIf
				                EndIf
				      		Else
				               	(cAliasSF4)->(DBSETORDER(1))
								(cAliasSF4)->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
				               	If (cAliasSF4)->F4_ESTOQUE == "S"
									If (cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSD1)->(D1_COD)))
										SB5->(dbSetOrder(1))
										SB5->(dbSeek(xFilial("SB5")+(cAliasSB1)->(B1_COD)))
										aRetDif   := &cINI071
										If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
											cTipoReg  := "1"
											cCNPJEMP  := cCNPJEmp
											cCNPJ 	  := cCNPJ
											cSemest   := cSemest
											cDoc	  := RetChar((cAliasSD1)->(D1_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
											cSerie 	  := RetChar((cAliasSD1)->(D1_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
											cSerieD1 	  := RetChar(SerieNfId(cAliasSD1,2,"D1_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
											cDtDigit  := (Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_DTDIGIT)),1,4))
											cTipoNF   := "E"
											cItem     := RetChar((cAliasSD1)->(D1_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
											cDtEmis   := (Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD1)->(D1_EMISSAO)),1,4))
											cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
											cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
											cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
											cCFOP     := Substr(alltrim((cAliasSD1)->(D1_CF)),1,4)
											cCodProd  := Substr(alltrim((cAliasSD1)->(D1_COD)),1,20)
											cQuant    := RetChar(str(NoRound((cAliasSD1)->(D1_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
											cValUnit  := RetChar(str(NoRound((cAliasSD1)->(D1_VUNIT),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
											cValTotIt := RetChar(str(NoRound((cAliasSD1)->(D1_TOTAL),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
											cDI       := RetChar(alltrim(cNumDI),.T.,.F.,.F.,.T.,.F.,10,.F.)

							        	   	GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
							              				cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
							               				cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
							               				cValTotIt,cDI,cSerieD1)

							               	lGrava 		:= .T.
										EndIf
				                   	EndIf
				                EndIf
				      		EndIf
				            If lGrava
				             	GravDifNf(cCNPJEmp,cSemest,cCNPJ,cDocNf,cSerieNf,;
						  					cDtDigit,cTipoNF,cDtEmis,cCFOP,cIndica,If(Alltrim(cIndica) == "S",cDocVin,StrZero(Val("0"),TamSX3("F2_DOC")[1])),;
				   							If(Alltrim(cIndica) == "S",cSeriVin,"000"),;
				   							If(Alltrim(cIndica) == "S",cDtEmis,"00000000"),;
				   							RetChar(str((cAliasSF1)->(F1_VALMERC),16,2),.T.,.F.,.F.,.T.,.F.,16,.F.),cSerieF3)
				            	lGrava := .F.
				            EndIf
						EndIf
						If !lQuery
							dbSelectArea(cAliasSD1)
						EndIf
						(cAliasSD1)->(dbSkip())
					EndDo
				Else
				  (cAliasSD1)->(dbSkip())
				EndIf

				If !lQuery
					dbSelectArea(cAliasSF3)
					cChaveSf3	:=	(cAliasSF3)->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
					While !(cAliasSF3)->(Eof()) .And.;
						cChaveSf3==(cAliasSF3)->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)

						(cAliasSF3)->(DbSkip())
					End
				EndIf
			EndDo
			If lQuery
				dbSelectArea(cAliasSF3)
				dbCloseArea()
			Else
				RetIndex("SF1")
				dbClearFilter()
				Ferase(cIndSF1+OrdBagExt())

				RetIndex("SF3")
				dbClearFilter()
				Ferase(cIndSF3+OrdBagExt())

				RetIndex("SD1")
				dbClearFilter()
				Ferase(cIndSD1+OrdBagExt())

				RetIndex("SB1")
				dbClearFilter()
				Ferase(cIndSB1+OrdBagExt())

				RetIndex("SF4")
				dbClearFilter()
				Ferase(cIndSF4+OrdBagExt())

				If lIntegra
					RetIndex("SWN")
					dbClearFilter()
					Ferase(cIndSWN+OrdBagExt())

					RetIndex("SW6")
					dbClearFilter()
					Ferase(cIndSW6+OrdBagExt())
				EndIf
	        EndIF
			lQuery := .F.
			#IFDEF TOP
				If TcSrvType() <> "AS/400"
				    cAliasSD2:= "DIFSQL2"
				    cAliasSF2:= "DIFSQL2"
				    cAliasSB1:= "DIFSQL2"
				    cAliasSF3:= "DIFSQL2"
				    cAliasSF4:= "DIFSQL2"
				    cAliasSF2:= "DIFSQL2"
				    lQuery    := .T.
					aStruSD2  := SD2->(dbStruct())
					aStruSF2  := SF2->(dbStruct())
					aStruSF3  := SF3->(dbStruct())
					aStruSB1  := SB1->(dbStruct())
					cQuery := "SELECT SF3.F3_FILIAL,SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_ENTRADA,"
					cQuery += "SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_VALCONT,SF3.F3_DTCANC,  "
					cQuery += "SF3.F3_CFO,SF3.F3_TIPO, "
					cQuery += "SF2.F2_VALMERC, "
					cQuery += "SD2.D2_FILIAL,SD2.D2_ITEM,SD2.D2_CF,SD2.D2_COD,SD2.D2_QUANT,SD2.D2_PRCVEN,"
					cQuery += "SD2.D2_TOTAL,SD2.D2_DOC,SD2.D2_SERIE,SD2.D2_EMISSAO,SD2.D2_NFORI,SD2.D2_SERIORI,"
					cQuery += "SD2.D2_CLIENTE,SD2.D2_LOJA,"
					cQuery += "SB1.B1_FILIAL,SB1.B1_ESPECIE,SB1.B1_COD,SB1.B1_POSIPI"

					If lSDoc
						cQuery += ",SF3.F3_SDOC,SD2.D2_SDOCORI, SD2.D2_SDOC "
					EndIf

					cQuery += " FROM "
					cQuery += RetSqlName("SF3") + " SF3 ,"
					cQuery += RetSqlName("SF2") + " SF2 ,"
					cQuery += RetSqlName("SF4") + " SF4 ,"
					cQuery += RetSqlName("SD2") + " SD2 ,"
					cQuery += RetSqlName("SB1") + " SB1 "
					cQuery += "WHERE "
					cQuery += "SF3.F3_FILIAL = '"+ xFilial("SF3") +"' AND "
					cQuery += "SF3.F3_ENTRADA >= '"+DTOS(dDmainc)+"' AND "
					cQuery += "SF3.F3_ENTRADA <= '"+DTOS(dDmaFin)+"' AND "
					cQuery += "SF3.F3_CFO > '5000' AND "
					cQuery += "SF3.D_E_L_E_T_ = ' ' AND "
					cQuery += "SF2.F2_DOC = SF3.F3_NFISCAL AND "
					cQuery += "SF2.F2_SERIE = SF3.F3_SERIE AND "
					cQuery += "SF2.F2_CLIENTE = SF3.F3_CLIEFOR AND "
					cQuery += "SF2.F2_LOJA = SF3.F3_LOJA AND "
					cQuery += "SD2.D2_FILIAL = '"+ xFilial("SD2") +"' AND "
					cQuery += "SD2.D2_DOC = SF2.F2_DOC AND "
					cQuery += "SD2.D2_SERIE = SF2.F2_SERIE AND "
					cQuery += "SD2.D2_CLIENTE = SF2.F2_CLIENTE AND "
					cQuery += "SD2.D2_LOJA = SF2.F2_LOJA AND "
					cQuery += "SF2.F2_TIPO <> 'C' AND "
					cQuery += "SD2.D2_CF = SF3.F3_CFO AND "
					cQuery += "SD2.D_E_L_E_T_ = ' ' AND "
					cQuery += "SF4.F4_FILIAL = '"+ xFilial("SF4") +"' AND "
					cQuery += "SF4.F4_CODIGO = SD2.D2_TES AND "

					If (!Empty(cINI71F4) .AND. SF4->(FieldPos(cINI71F4))>0)
						cQuery +="(SF4.F4_ESTOQUE = 'S' OR SF4."+cINI71F4+"='1') AND "
					Else
						cQuery += "SF4.F4_ESTOQUE = 'S' AND "
					EndIf

					cQuery += "SF4.D_E_L_E_T_ = ' ' AND "
					cQuery += "SB1.B1_FILIAL = '"+ xFilial("SB1") +"' AND "
					cQuery += "SB1.B1_COD = SD2.D2_COD AND "
					cQuery += "SB1.B1_POSIPI <> '" + space(TamSx3("B1_POSIPI")[1]) + "' AND "
					cQuery += "SB1.D_E_L_E_T_ = ' '"

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณPonto de Entrada para complementar o filtro nos documentos de saida    ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lAPDIF02
						cQuery := ExecBlock("APDIF02", .F., .F., {cQuery})
					EndIf

					cQuery := ChangeQuery(cQuery)
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF2,.T.,.T.)
					For nSD2 := 1 To Len(aStruSD2)
						If aStruSD2[nSD2][2] <> "C" .and. FieldPos(aStruSD2[nSD2][1]) > 0
							TcSetField(cAliasSD2,aStruSD2[nSD2][1],aStruSD2[nSD2][2],aStruSD2[nSD2][3],aStruSD2[nSD2][4])
						EndIf
					Next nSD2

					For nSF2 := 1 To Len(aStruSF2)
						If aStruSF2[nSF2][2] <> "C" .and. FieldPos(aStruSF2[nSF2][1]) > 0
							TcSetField(cAliasSF2,aStruSF2[nSF2][1],aStruSF2[nSF2][2],aStruSF2[nSF2][3],aStruSF2[nSF2][4])
						EndIf
					Next nSF2

					For nSF3 := 1 To Len(aStruSF3)
						If aStruSF3[nSF3][2] <> "C" .and. FieldPos(aStruSF3[nSF3][1]) > 0
							TcSetField(cAliasSF3,aStruSF3[nSF3][1],aStruSF3[nSF3][2],aStruSF3[nSF3][3],aStruSF3[nSF3][4])
						EndIf
					Next nSF3

					For nSB1 := 1 To Len(aStruSB1)
						If aStruSB1[nSB1][2] <> "C" .and. FieldPos(aStruSB1[nSB1][1]) > 0
							TcSetField(cAliasSB1,aStruSB1[nSB1][1],aStruSB1[nSB1][2],aStruSB1[nSB1][3],aStruSB1[nSB1][4])
						EndIf
					Next nSB1
				Else
			#ENDIF
					dbSelectArea(cAliasSF3)
					cIndSF3	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF3->F3_FILIAL=='"+xFilial("SF3")+"' .And. DTOS(SF3->F3_ENTRADA)>='"+DTOS(dDmainc)+"' .AND. DTOS(SF3->F3_ENTRADA)<='"+DTOS(dDmaFin)+"'"
					cFiltro	+= " .AND. SF3->F3_CFO > '5000'"
					IndRegua(cAliasSF3,cIndSF3,cChave,,cFiltro)
					(cAliasSF3)->(DbgoTop())

					dbSelectArea(cAliasSD2)
					dbSetOrder(3)
					cIndSD2	:=	CriaTrab(NIL,.F.)
					cChave	:=	"SD2->D2_FILIAL+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA"
					cFiltro	:=	"SD2->D2_FILIAL=='"+xFilial("SD2")+"' .And. DTOS(SD2->D2_EMISSAO)>='"+DTOS(dDmainc)+"' .AND. DTOS(SD2->D2_EMISSAO)<='"+DTOS(dDmaFin)+"' .AND. SD2->D2_TIPO <>'C'"
					IndRegua(cAliasSD2,cIndSD2,cChave,,cFiltro)
					(cAliasSD2)->(DbgoTop())

					dbSelectArea(cAliasSF2)
					dbSetOrder(4)
					cIndSF2	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF2->F2_FILIAL=='"+xFilial("SF2")+"' .And. DTOS(SF2->F2_EMISSAO)>='"+DTOS(dDmainc)+"' .AND. DTOS(SF2->F2_EMISSAO)<='"+DTOS(dDmaFin)+"' .AND. SF2->F2_TIPO <>'C'"
					IndRegua(cAliasSF2,cIndSF2,cChave,,cFiltro)
					(cAliasSF2)->(DbgoTop())

					dbSelectArea(cAliasSB1)
					cIndSB1	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SB1->B1_FILIAL=='"+xFilial("SB1")+"' .And. SB1->B1_POSIPI <> '" + space(TamSx3("B1_POSIPI")[1]) + "'"
					IndRegua(cAliasSB1,cIndSB1,cChave,,cFiltro)
					(cAliasSB1)->(DbgoTop())

					dbSelectArea(cAliasSF4)
					cIndSF4	:=	CriaTrab(NIL,.F.)
					cChave	:=	IndexKey()
					cFiltro	:=	"SF4->F4_FILIAL=='"+xFilial("SF4")+"' .And. SF4->F4_ESTOQUE == 'S'"
					IndRegua(cAliasSF4,cIndSF4,cChave,,cFiltro)
					(cAliasSF4)->(DbgoTop())

			#IFDEF TOP
				Endif
			#ENDIF
			If !lQuery
				dbSelectArea(cAliasSF3)
			EndIf
			While (cAliasSF3)->(!EOF()) .and. (cAliasSF3)->(F3_FILIAL) == xFilial("SF3")
			    If (cAliasSF3)->(F3_TIPO)$"BD"
			    	SA2->(dbSetOrder(1))
				    SA2->(dbSeek(xFilial("SA2")+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA)))
				    cCNPJ:= Substr(alltrim(SA2->A2_CGC),1,14)
				Else
					SA1->(dbSetOrder(1))
				    SA1->(dbSeek(xFilial("SA1")+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA)))
				    cCNPJ:= Substr(alltrim(SA1->A1_CGC),1,14)
				EndIf
				If Len(cCNPJ) >= 11 .And. Empty((cAliasSF3)->(F3_DTCANC))
					cDocNf  	:= RetChar((cAliasSF3)->(F3_NFISCAL),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
					cSerieNf	:= RetChar((cAliasSF3)->(F3_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
					cSerieF3	:= RetChar(SerieNfId(cAliasSF3,2,"F3_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
					cCNPJ		:= RetChar(cCNPJ,.T.,.F.,.F.,.T.,.F.,14,.F.)
					cDtEmis 	:= (Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),7,2))+(Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),5,2))+(Substr(DTOS((cAliasSF3)->(F3_ENTRADA)),1,4))
					cCFONF		:= Substr(Alltrim((cAliasSF3)->(F3_CFO)),1,4)
					cTipoNF		:= "S"

					If !lQuery
							dbSelectArea(cAliasSD2)
							MsSeek(xFilial("SD2")+(cAliasSF3)->(F3_NFISCAL)+(cAliasSF3)->(F3_SERIE)+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA))
							dbSelectArea(cAliasSF2)
							MsSeek(xFilial("SF2")+(cAliasSF3)->(F3_SERIE)+DTOS((cAliasSF3)->(F3_ENTRADA))+(cAliasSF3)->(F3_NFISCAL)+(cAliasSF3)->(F3_CLIEFOR)+(cAliasSF3)->(F3_LOJA))
					EndIf

					cIndica     := If((cAliasSD2)->(D2_QUANT) > 0,"N","S")
					cDocVin  	:= RetChar((cAliasSD2)->(D2_NFORI),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
					cSeriVin	:= RetChar(SerieNfId(cAliasSD2,2,"D2_SERIORI"),.T.,.F.,.F.,.T.,.F.,3,.F.)
					//lGrava 		:= .T.
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณRegistro Tipo 1 - Dados dos Produtos  ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					While   cDocNf   == RetChar((cAliasSD2)->(D2_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.) 		.And. ;
							cSerieNf == RetChar((cAliasSD2)->(D2_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.) 	.And. ;
							cDtEmis  ==	(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),1,4)) .And. ;
							(cAliasSF3)->(F3_CLIEFOR) 	== (cAliasSD2)->(D2_CLIENTE)	.And. ;
							(cAliasSF3)->(F3_LOJA)		== (cAliasSD2)->(D2_LOJA) 		.And. ;
							(cAliasSD2)->(!EOF())                        	.And. ;
							xFilial("SD2") == (cAliasSD2)->(D2_FILIAL)

						If lQuery
							SB1->(dbSetOrder(1))
						    If SB1->(MsSeek(xFilial("SB1")+(cAliasSD2)->(D2_COD)))
								SB5->(dbSetOrder(1))
								SB5->(dbSeek(xFilial("SB5")+(cAliasSD2)->(D2_COD)))
								aRetDif   := &cINI071
								If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
								   	cTipoReg  := "1"
									cCNPJEMP  := cCNPJEmp
									cCNPJ 	  := cCNPJ
									cSemest   := cSemest
									cDoc	  := RetChar((cAliasSD2)->(D2_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
									cSerie 	  := RetChar((cAliasSD2)->(D2_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
									cSerieD2 	  := RetChar(SerieNfId(cAliasSD2,2,"D2_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
									cDtDigit  := (Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),1,4))
									cTipoNF   := "S"
									cItem     := RetChar((cAliasSD2)->(D2_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
									cDtEmis   := (Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),1,4))
									cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
									cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
									cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
									cCFOP     := Substr(alltrim((cAliasSD2)->(D2_CF)),1,4)
									cCodProd  := Substr(alltrim((cAliasSD2)->(D2_COD)),1,20)
									cQuant    := RetChar(str(NoRound((cAliasSD2)->(D2_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
									cValUnit  := RetChar(str(NoRound((cAliasSD2)->(D2_PRCVEN),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
									cValTotIt := RetChar(str(NoRound((cAliasSD2)->(D2_TOTAL),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
									cDI       := RetChar(alltrim(cNumDI),.T.,.F.,.F.,.T.,.F.,10,.F.)

						            GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
					               				cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
					               				cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
					               				cValTotIt,cDI,cSerieD2)

					               	lGrava 		:= .T.
								EndIf
			                EndIf
			            Else
			                (cAliasSF4)->(DBSETORDER(1))
							(cAliasSF4)->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))
				            If (cAliasSF4)->F4_ESTOQUE == "S" .OR. (!Empty(cINI71F4) .AND. (cAliasSF4)->(FieldPos(cINI71F4))>0 .AND. (cAliasSF4)->(FieldGet(FieldPos(cINI71F4)))=="1")
								If (cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSD2)->(D2_COD)))
									SB5->(dbSetOrder(1))
									SB5->(dbSeek(xFilial("SB5")+(cAliasSD2)->(D2_COD)))
									aRetDif   := &cINI071
									If Len(aRetDif) == 2 .And. Left(Alltrim(aRetDif[1]),1) $ "LPS"		//L=Publicacao - P=Papel - S=Sobra
										cTipoReg  := "1"
										cCNPJEMP  := cCNPJEmp
										cCNPJ 	  := cCNPJ
										cSemest   := cSemest
										cDoc	  := RetChar((cAliasSD2)->(D2_DOC),.T.,.F.,.F.,.T.,.F.,TamSX3("F2_DOC")[1],.F.)
										cSerie 	  := RetChar((cAliasSD2)->(D2_SERIE),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cSerieD2 	  := RetChar(SerieNfId(cAliasSD2,2,"D2_SERIE"),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtDigit  := (Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),1,4))
										cTipoNF   := "S"
										cItem     := RetChar((cAliasSD2)->(D2_ITEM),.T.,.F.,.F.,.T.,.F.,3,.F.)
										cDtEms   := (Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),7,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),5,2))+(Substr(DTOS((cAliasSD2)->(D2_EMISSAO)),1,4))
										cNCM      := RetChar((cAliasSB1)->(B1_POSIPI),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cTipoPD   := Substr(Alltrim(aRetDif[1]),1,1)
										cDescTab  := If(cTipoPD == "S","00000",RetChar(Substr(Alltrim(aRetDif[2]),1,5),.T.,.F.,.F.,.T.,.F.,5,.F.))
										cCFOP     := Substr(alltrim((cAliasSD2)->(D2_CF)),1,4)
										cCodProd  := Substr(alltrim((cAliasSD2)->(D2_COD)),1,20)
										cQuant    := RetChar(str(NoRound((cAliasSD2)->(D2_QUANT),3),10,3),.T.,.F.,.F.,.T.,.F.,10,.F.)
										cValUnit  := RetChar(str(NoRound((cAliasSD2)->(D2_PRCVEN),2),9,2),.T.,.F.,.F.,.T.,.F.,9,.F.)
										cValTotIt := RetChar(str(NoRound((cAliasSD2)->(D2_TOTAL),2),14,2),.T.,.F.,.F.,.T.,.F.,14,.F.)
										cDI       := RetChar(alltrim(cNumDI),.T.,.F.,.F.,.T.,.F.,10,.F.)

							            GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
						               				cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
						               				cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
						               				cValTotIt,cDI,cSerieD2)

						               	lGrava 		:= .T.
									Endif
				               	EndIf
			               	EndIf
			            EndIf
			            If lGrava
			               	GravDifNf(cCNPJEmp,cSemest,cCNPJ,cDocNf,cSerieNf,;
					  					cDtDigit,cTipoNF,cDtEmis,cCFOP,cIndica,If(Alltrim(cIndica) == "S",cDocVin,StrZero(Val("0"),TamSX3("F2_DOC")[1])),;
			   							If(Alltrim(cIndica) == "S",cSeriVin,"000"),;
			   							If(Alltrim(cIndica) == "S",cDtEmis,"00000000"),;
			   							RetChar(str((cAliasSF2)->(F2_VALMERC),16,2),.T.,.F.,.F.,.T.,.F.,16,.F.),cSerieF3)
			            	lGrava := .F.
			            EndIf
						If !lQuery
							dbSelectArea(cAliasSD2)
						EndIf
						(cAliasSD2)->(dbSkip())
					EndDo
				Else
				  (cAliasSD2)->(dbSkip())
				EndIf

				If !lQuery
					dbSelectArea(cAliasSF3)
					cChaveSf3	:=	(cAliasSF3)->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
					While !(cAliasSF3)->(Eof()) .And.;
						cChaveSf3==(cAliasSF3)->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)

						(cAliasSF3)->(DbSkip())
					End
				EndIf
			EndDo
			nEmpresa++

			If lQuery
				dbSelectArea(cAliasSF3)
				dbCloseArea()
			Else
				RetIndex("SF3")
				dbClearFilter()
				Ferase(cIndSF3+OrdBagExt())

				RetIndex("SF2")
				dbClearFilter()
				Ferase(cIndSF2+OrdBagExt())

				RetIndex("SD2")
				dbClearFilter()
				Ferase(cIndSD2+OrdBagExt())

				RetIndex("SB1")
				dbClearFilter()
				Ferase(cIndSB1+OrdBagExt())

				RetIndex("SF4")
				dbClearFilter()
				Ferase(cIndSF4+OrdBagExt())

	        EndIF
		EndIf
		If FWModeAccess("SF3",3)=="C"
			Exit
		Endif
	EndDo
	SM0->(dbGoTo(nRegEmp))
	cFilAnt := FWCodFil()
EndIf

Return(Nil)


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGravDifNf บAutor  ณEduardo Jos้ Zanardoบ Data ณ  23/09/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Grava os cabe็alhos das Notas fiscais conforme registo tipo ฑฑ
ฑฑบ0 da Inst.Normat.071 - DIF Papel Imune		    					  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpc1	-	cTipoReg 	- Tipo do Registro					   ฑฑ
ฑฑ			  Expc2	-	cCNPJEmp 	- CNPJ do Estabelecimento			   ฑฑ
ฑฑ			  Expc3	-	cSemest 	- Semestre e Ano de referencia		   ฑฑ
ฑฑ			  Expc4	-	cCNPJ 		- CNPJ do Cliente/Fornecedor		   ฑฑ
ฑฑ			  Expc5	-	cDoc		- Num. da Nota Fiscal				   ฑฑ
ฑฑ			  Expc6	-	cSerie		- Serie da Nota Fiscal				   ฑฑ
ฑฑ			  Expc7 -	cDtDigit	- Data de Entrada					   ฑฑ
ฑฑ			  Expc8	-	cTipoNF		- Tipo da Nota Fiscal				   ฑฑ
ฑฑ			  Expc9	-	cItem		- Num. do Item da Nota Fiscal		   ฑฑ
ฑฑ			  Expc0	-	cDtEmis		- Data da emissใo da Nota fiscal	   ฑฑ
ฑฑ			  ExpcA	-	cTipoPD		- Tipo do Produto					   ฑฑ
ฑฑ			  ExpcB	-	cNCM		- Codigo NCM do Produto(TIPI)		   ฑฑ
ฑฑ 			  ExpcC	-	cDescTab	- Codigo de descricao do Produto	   ฑฑ
ฑฑ			  ExpcD	-	cCFOP		- CFOP do Item da Nota Fiscal		   ฑฑ
ฑฑ 			  ExpcE	-	cCodProd	- Codigo do Produto					   ฑฑ
ฑฑ 			  ExpcF	-	cQuant		- Quantida do Produto				   ฑฑ
ฑฑ 			  ExpcG	-	cValUnit	- Valor Unitแrio do Produto 		   ฑฑ
ฑฑ 			  ExpcH	-	cValTotIt 	- Valor Total do Item				   ฑฑ
ฑฑ 			  ExpcI	-	cDI			- Registro de Importa็ใo              ณฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Static Function GravDifNf(cCNPJEmp,cSemest,cCNPJ,cDocNf,cSerieNf,;
   					cDtDigita,cTipoNF,cDtEmissao,cCFOP,cIndica,cDOCVinc,;
   					cSerVinc,cDtDgVinc,cValorNF,cSerieView)

LOCAL aArea    := GetArea()

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณRegistro Tipo 0 - Dados da Nota Fiscalณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
DbSelectArea("TNF")
DbSetOrder(1)
If !dbSeek(cCNPJ+cDtEmissao+cDocNf+cSerieNf+cTipoNF)
	RecLock("TNF",.T.)
    TipoReg		:= "0"
	CNPJEMP		:= cCNPJEmp
	Semestre 	:= cSemest
	CNPJ 		:= cCNPJ
	DOC			:= cDocNf
	SERIE		:= cSerieNf
	SDOC		:= cSerieView
	DtDigit 	:= cDtDigita
	TipoNF		:= cTipoNF
	DtEmissao 	:= cDtEmissao
	CFOP		:= cCFOP
	Indicador   := cIndica
	DOCVinc		:= cDOCVinc
	SerVinc		:= cSerVinc
	DtDgVinc 	:= cDtDgVinc
	ValorNF		:= cValorNF
	MsUnlock()
EndIf

RestArea(aArea)

Return(Nil)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGravDifIt บAutor  ณEduardo Jos้ Zanardoบ Data ณ  10/07/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Grava os produtos conforme registo tipo 1 da Inst.Normat.  บฑฑ
ฑฑ           ณ 071 - DIF Papel Imune									  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpc1	-	cTipoReg 	- Tipo do Registro					   ฑฑ
ฑฑ			  Expc2	-	cCNPJEmp 	- CNPJ do Estabelecimento			   ฑฑ
ฑฑ			  Expc3	-	cSemest 	- Semestre e Ano de referencia		   ฑฑ
ฑฑ			  Expc4	-	cCNPJ 		- CNPJ do Cliente/Fornecedor		   ฑฑ
ฑฑ			  Expc5	-	cDoc		- Num. da Nota Fiscal				   ฑฑ
ฑฑ			  Expc6	-	cSerie		- Serie da Nota Fiscal				   ฑฑ
ฑฑ			  Expc7 -	cDtDigit	- Data de Entrada					   ฑฑ
ฑฑ			  Expc8	-	cTipoNF		- Tipo da Nota Fiscal				   ฑฑ
ฑฑ			  Expc9	-	cItem		- Num. do Item da Nota Fiscal		   ฑฑ
ฑฑ			  Expc0	-	cDtEmis		- Data da emissใo da Nota fiscal	   ฑฑ
ฑฑ			  ExpcA	-	cTipoPD		- Tipo do Produto					   ฑฑ
ฑฑ			  ExpcB	-	cNCM		- Codigo NCM do Produto(TIPI)		   ฑฑ
ฑฑ 			  ExpcC	-	cDescTab	- Codigo de descricao do Produto	   ฑฑ
ฑฑ			  ExpcD	-	cCFOP		- CFOP do Item da Nota Fiscal		   ฑฑ
ฑฑ 			  ExpcE	-	cCodProd	- Codigo do Produto					   ฑฑ
ฑฑ 			  ExpcF	-	cQuant		- Quantida do Produto				   ฑฑ
ฑฑ 			  ExpcG	-	cValUnit	- Valor Unitแrio do Produto 		   ฑฑ
ฑฑ 			  ExpcH	-	cValTotIt 	- Valor Total do Item				   ฑฑ
ฑฑ 			  ExpcI	-	cDI			- Registro de Importa็ใo              ณฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Static Function GravDifIt(cTipoReg,cCNPJEmp,cSemest,cCNPJ,cDoc,cSerie,;
   					cDtDigit,cTipoNF,cItem,cDtEmis,cTipoPD,cNCM,;
   					cDescTab,cCFOP,cCodProd,cQuant,cValUnit,;
   					cValTotIt,cDI,cSerieView)

LOCAL aArea    := GetArea()

DbSelectArea("TIT")
DbSetOrder(1)
If !DbSeek(cCNPJ+cDtEmis+cDoc+cSerie+cTipoNF+cItem)
	RecLock("TIT",.T.)
	TipoReg		:= 	cTipoReg
	CNPJEMP		:= 	cCNPJEmp
	Semestre	:= 	cSemest
	CNPJ 		:=	cCNPJ
	DOC			:=	cDoc
	SERIE		:=	cSerie
	SDOC		:=	cSerieView
	DtDigit 	:=	cDtDigit
	TipoNF 		:= 	cTipoNF
	Item 		:= 	cItem
	DtEmissao 	:= 	cDtEmis
	NCM 		:= 	cNCM
	TipoPD		:=  cTipoPD
	DescTab 	:= 	cDescTab
	CFOP 		:= 	cCFOP
	CodProd 	:= 	cCodProd
	Quant 		:= 	cQuant
	ValUnit 	:= 	cValUnit
	ValTotIt 	:= 	cValTotIt
	DINUM   	:= 	cDI
	MsUnlock()
EndIf
RestArea(aArea)

Return(Nil)


/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncion   ณ GIASCH  	 ณ Autor ณ Eduardo Jos้ Zanardo  ณ Data ณ11/11/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Totaliza็ใo do quadro H da  GIASC						  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GIASCH()
Local aArea		:= GetArea()
Local cArqtrab	:= ""
Local aCampos	:= {}
Local cCfo		:= GetNewPar("MV_GIASC01","")
Local aCfo		:= {}
Local cCodigo	:= ""
Local nTotSimp	:= 0
Local lGerou	:=	.F.

aCfo			:= &cCfo
aCfo			:= If(aCfo==NIL,{"",""},aCfo)

AADD(aCampos,{"CODIGO"  ,"C",005,0})
AADD(aCampos,{"VALOR"	,"N",017,2})
cArqtrab	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cArqtrab,"R37",.T.,.F.)
IndRegua("R37",cArqtrab,"CODIGO")
DbSelectArea("R37")
DbClearIndex()
DbSetIndex(cArqtrab+OrdBagExt())

DbSelectArea("ICM")
ICM->(DbGotop())
While ICM->(!EOF())
	  cCodigo := IiF(alltrim(ICM->(CFOP))$aCFO[1],"01301",IiF(alltrim(ICM->(CFOP))$aCFO[2],"01302",""))
	  If !Empty(cCodigo) .and. cCodigo <> "01302"
	  	lGerou	:=	.T.
		 If R37->(DbSeek(cCodigo))
			RECLOCK("R37",.F.)
			If Subs(AllTrim(ICM->CFOP),1,1)$"123"
			   R37->VALOR  	-= ICM->VALCONT
			   nTotSimp 	-= ICM->VALCONT
			Else
			   R37->VALOR  	+= ICM->VALCONT
			   nTotSimp 	+= ICM->VALCONT
			Endif
			MsUnlock()
		 Else
			RECLOCK("R37",.T.)
			If Subs(AllTrim(ICM->CFOP),1,1)$"123"
			   R37->CODIGO 	:= cCodigo
			   R37->VALOR  	-= ICM->VALCONT
			   nTotSimp		-= ICM->VALCONT
			Else
			   R37->CODIGO 	:= cCodigo
			   R37->VALOR  	:= ICM->VALCONT
			   nTotSimp		+= ICM->VALCONT
			Endif
			MsUnlock()
		 EndIf
	  EndIf
	  ICM->(DBSkip())
EndDo

If !lGerou .Or. MV_PAR07==2 .Or. _aTotal[92]>0
   RECLOCK("R37",.T.)
   R37->CODIGO 	:= "01303"
   R37->VALOR  	:= _aTotal[92]
   nTotSimp 	+= _aTotal[92]
   MsUnlock()
EndIf

RECLOCK("R37",.T.)
R37->CODIGO 	:= "01399"
R37->VALOR  	:= nTotSimp
MsUnlock()

RestArea(aArea)
Return(cArqtrab)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณA940LoadDIC ณAutorณ Eduardo Jos้ Zanardo  ณ Data ณ 30/08/02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณCarrega array com opcoes para o ListBox da DIC_SE           ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณMATA965                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function A940LoadDIC(aListBox,aSel,aMsg,aValid)
	Local cMsg		:= ""
Local cValid	:= ""
Local nI		:= 0

cValid:="AValCFOCFP(aListBox)"

AADD(aListBox,STR0034)          ; AADD(aSel,.f.) ; AADD(aMsg,"")   ; AADD(aValid,"") 	//"Informe o Codigo da Contas Contabeis"
AADD(aListBox," ")				; AADD(aSel,.f.) ; AADD(aMsg,"")   ; AADD(aValid,"")
AADD(aListBox,STR0035)			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    901 - Caixa"
AADD(aListBox,STR0036) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    902 - Bancos"
AADD(aListBox,STR0037) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    903 - Cliente"
AADD(aListBox,STR0038) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    904 - Out.Cta.Receber"
AADD(aListBox,STR0039) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    905 - Fornecedor"
AADD(aListBox,STR0040) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    906 - Out.Cta.Pagar"
AADD(aListBox,STR0041) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    907 - Emprest.P.Fํsica"
AADD(aListBox,STR0042) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    908 - Emprest.P.Jurํdica"
AADD(aListBox,STR0043) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    909 - Cta.Cx. e Bancos"
AADD(aListBox,STR0044) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    910 - Emprest. Contraidos no Mes PF"
AADD(aListBox,STR0045) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    911 - Emprest. Contraidos no Mes PJ"
AADD(aListBox,STR0046) 			; AADD(aSel,.t.) ; AADD(aMsg,cMsg) ; AADD(aValid,cValid) //"    912 - Outros Pagto."
AADD(aListBox," ")				; AADD(aSel,.f.) ; AADD(aMsg,"")   ; AADD(aValid,"")
AADD(aListBox," ")				; AADD(aSel,.f.) ; AADD(aMsg,"")   ; AADD(aValid,"")

For nI:=1 to Len(aListBox)
	aListBox[nI]:=OemToAnsi(aListBox[nI])
	aMsg[nI]:=OemToAnsi(aMsg[nI])
Next

RETURN (aListBox)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ AValCFOCFP() ณ Autor ณ Eduardo J. Zanardoณ Data ณ19/11/2002ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Validacao do Conte๚do dos dados do arquivo CFP		      ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION AValCFOCFP(aListBox)

Local cVar		:= ReadVar()
Local cConteudo	:= ""
Local lHelp		:= .f.
Local nI		:= 0
Local aCFO		:= {}
Local nJ		:= 1
Local cDigito	:= ""
Local i			:= 0

cConteudo:=Alltrim(&cVar)

If Empty(cConteudo)
	Return .t.
Endif

If Substr(aListBox[nAt],5,1) <> "9"
	For nI:=1 to Len(cConteudo)
		cDigito:=Substr(cConteudo,i,1)
		// No campo so podem ser digitados numeros e virgulas
		If !(cDigito$"0123456789,") .or. ((nI%4==0 .and. cDigito!=",").AND. (nI%5==0 .and. cDigito!=",");
			.AND. (nI%6==0 .and. cDigito!=","))
			lHelp:=.t.
			Exit
		Endif
		If nJ==1 .and. cDigito!=","
			AADD(aCFO,"")
		Endif
		If cDigito!=","
			aCFO[Len(aCFO)]+=cDigito
			nJ++
		EndIf
		nJ:=IIf(cDigito==",",1,nJ)
	Next
Endif
If !lHelp
	For i:=1 to Len(aCFO)
		If (Len(aCFO[i])!=3 .and. Len(aCFO[i])!=4 .and. Len(aCFO[i])!=5) .or. "*"$VerCFO(aCFO[i])
			lHelp:=.t.
			Exit
		Endif
	Next
Endif

If lHelp
	Help(" ",1,"A965CFO")
	Return .f.
Endif

Return .t.

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณAFisIns     ณAutorณ Eduardo J. Zanardo    ณ Data ณ 30.09.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณCarrega conteudo do arquivo *.CFP  		                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณSIGAFIS                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function AFisIns(cTitulo1,cTexto1,cTexto2,aListBox,aConteudo,aSel,aValid,aMsg,;
					cArqIni,cTitulo2,aSvConteudo)

LOCAL oDlg,oDlgGet,oGet
LOCAL nOpca := 2

DEFINE MSDIALOG oDlg TITLE OemtoAnsi(cTitulo1) FROM  180,110 TO 450,520 PIXEL OF oMainWnd
@ 10, 20 SAY Oemtoansi(LTrim(cTexto1)) 	SIZE 300, 07 OF oDlg PIXEL
@ 20, 20 SAY Oemtoansi(LTrim(cTexto2)) 	SIZE 300, 07 OF oDlg PIXEL
@ 28, 20 TO 110, 187 LABEL "" OF oDlg PIXEL
DEFINE SBUTTON FROM 115, 132 TYPE 1 ACTION (nOpca:=1,oDlg:End()) ENABLE OF oDlg
DEFINE SBUTTON FROM 115, 160 TYPE 2 ACTION (nOpca:=2,oDlg:End()) ENABLE OF oDlg
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Desenha List Box                                             ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AFisListBox(oDlg,@aListBox,@aConteudo,aSel,aValid,aMsg)
ACTIVATE MSDIALOG oDlg
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Grava arquivo de configuracao                                ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If nOpca==1 .and. !A965CompArray(aConteudo,aSvConteudo)
	AFisGravaCFP(cArqIni,aListBox,aConteudo,cTitulo2)
Endif

RETURN
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณAFisListBox ณAutorณ Eduardo J. Zanardo    ณ Data ณ 30.09.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณAtiva ListBox com opcoes para o array da configuracao       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณSigaFis                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION AFisListBox(oDlg,aListBox,aConteudo,aSel,aValid,aMsg)

LOCAL oListBox

@ 33,22 LISTBOX oListBox VAR cVar FIELDS HEADER "" ON DBLCLICK (AFisGetList(oListBox,;
		@aConteudo,aSel,aValid,aMsg,aListBox)) SIZE 164,76 PIXEL
oListBox:SetArray(aListBox)
oListBox:bLine := { ||{aListBox[oListBox:nAt]}}

RETURN
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณAFisGetList ณAutorณ Eduardo J. Zanardo    ณ Data ณ 30.09.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณAtiva Get para edicao de Elemento relacionado ao ListBox    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณSigaFis                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION AFisGetList(oListBox,aConteudo,aSel,aValid,aMsg,aListBox)

Local oDlgGet
Local nOpcaGet:=2
Local bValid
Local lUpdated:=.f.
Local cCampo := ""
nAt:=oListBox:nAt

If aSel[nAt]
	If Alltrim(Upper(aValid[nAt]))=="AValCFOCFP(aListBox)"
		cCampo:="cA965Cpo1"
	Else
		cCampo:="cA965Cpo2"
	Endif
	&cCampo:=aConteudo[nAt]
	bValid:=&("{||"+aValid[nAt]+"}")
	DEFINE MSDIALOG oDlgGet TITLE aMsg[nAt] FROM  300,100 TO 400,620 PIXEL OF oListBox
	@ 08, 20 TO 27, 237 LABEL "" OF oDlgGet PIXEL
	@ 15, 24 MSGET &cCampo PICTURE "@!" VALID Eval(bValid) SIZE 210, 08 OF oDlgGet PIXEL
	DEFINE SBUTTON FROM 032, 182 TYPE 1 ACTION (lUpdated:=.t.,oDlgGet:End()) ENABLE OF oDlgGet
	DEFINE SBUTTON FROM 032, 210 TYPE 2 ACTION (lUpdated:=.f.,oDlgGet:End()) ENABLE OF oDlgGet
	ACTIVATE MSDIALOG oDlgGet
	If lUpdated
		aConteudo[nAt]:=StrTran(&cCampo,'"',"'")
	Endif
Endif

RETURN
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ AFisGravaCFP ณ Autor ณ Eduardo J. Zanardoณ Data ณ 27.07.95 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Grava arquivo de configuracao .CFP                         ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function AFisGravaCFP(cArqIni,aListBox,aConteudo,cTitulo2)

Local cArqBkp := ""
Local nHandle := 0
Local aGravar := {}
Local I		  := 0
Local cCabec  := ""

cArqBkp:=StrTran(cArqIni,".CFP",".#CF")
Ferase(cArqBkp)
FRename(cArqIni,cArqBkp)
nHandle:=MSFCREATE(cArqIni)
aGravar:={}
cCabec := STR0033
AADD(aGravar,"ฺฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ"+Chr(13)+Chr(10))
AADD(aGravar,cCabec+cTitulo2+Chr(13)+Chr(10)) //"ณ Microsiga ณ Arquivo de configuracao :"
AADD(aGravar,"ภฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู"+Chr(13)+Chr(10))

For i:=1 to Len(aListBox)
	If IsDigit(Substr(aListBox[i],5,3))
		AADD(aGravar,"["+Substr(aListBox[i],5,3)+"]="+Rtrim(aConteudo[i])+Chr(13)+Chr(10))
	EndIf
Next
For i:=1 to Len(aGravar)
	FWrite(nHandle,aGravar[i],Len(aGravar[i]))
Next
FClose(nHandle)

Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณAFisLoadCFP ณAutorณ Eduardo J. Zanardo    ณ Data ณ 30.09.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณCarrega conteudo do arquivo *.CFP  		                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณSIGAFIS                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function AFisLoadCFP(cArqIni,aListBox)

Local i 		:= 0
Local cConteudo := ""
Local aConteudo := {}

If File(cArqIni)
	For i:=1 to Len(aListBox)
		cConteudo:=""
		If IsDigit(Substr(aListBox[i],5,3))
			cConteudo:=A965LeIni(Substr(aListBox[i],5,3),.F.,cArqIni)
			If Len(cConteudo)<230
				cConteudo:=cConteudo+Space(230-Len(cConteudo))
			EndIf
		Endif
		AADD(aConteudo,cConteudo)
	Next
Else
	For i:=1 to Len(aListBox)
		AADD(aConteudo,Space(230))
	Next
Endif

RETURN (aConteudo)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGIARSX   บAutor  ณEduardo Jos้ Zanardoบ Data ณ  15/10/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ GIA-RS - Reg. 10             							  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function GIARSX(nMes,nAno,dDtIni,dDtFim)

Local aCampos	:= {}
Local cArqTRB	:= ""
Local cArqTRB2	:= ""
Local cMv_StUf	:= GetNewPar("MV_STUF","")	// Def. estado a serem utilizados para o artigo 281

AADD(aCampos,{"VENCTO"	,"C",8,0})
AADD(aCampos,{"VLICM"	,"N",13,2})
AADD(aCampos,{"VLST"	,"N",13,2})
AADD(aCampos,{"VALFECP"	,"N",13,2})
AADD(aCampos,{"VFECPST"	,"N",13,2})

cArqTRB :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cArqTRB,"GIA",.T.,.F.)
IndRegua("GIA",cArqTRB,"VENCTO")
DbSelectArea("GIA")
DbClearIndex()
DbSetIndex(cArqTRB+OrdBagExt())

cArqTRB2 :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cArqTRB2,"PAG",.T.,.F.)
IndRegua("PAG",cArqTRB2,"VENCTO")
DbSelectArea("PAG")
DbClearIndex()
DbSetIndex(cArqTRB2+OrdBagExt())

DbselectArea("SF6")
dbSetOrder(2)
DbSeek(xFilial("SF6"))

While SF6->(!EOF()) .and. SF6->F6_FILIAL==xFilial("SF6")

	IF ( SF6->F6_ANOREF == nAno .And. SF6->F6_MESREF == nMes .and. (val(Substr(DTOS(SF6->F6_DTVENC),5,2)) > nMes ) .or. val(Substr(DTOS(SF6->F6_DTVENC),1,4)) > nAno)
		If GIA->(DbSeek(Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)))
			RECLOCK("GIA",.F.)
		Else
			RECLOCK("GIA",.T.)
			GIA->VENCTO := Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)
		EndIf

		If SF6->F6_TIPOIMP$"1# "
			If ALLTRIM(SF6->F6_CODREC)$'1512|1513' // AMPARA/RS ICMS PROPRIO
				GIA->VALFECP += SF6->F6_VALOR
			Else
				GIA->VLICM += SF6->F6_VALOR
			EndIf
		ElseIf	SF6->F6_TIPOIMP=="3" .and. _aTotal[10] == 1
			If (!Empty(cMv_StUf) .And. (SF6->F6_EST$cMv_StUf)) .or. Empty(cMv_StUf)
				If ALLTRIM(SF6->F6_CODREC)$'1514' // AMPARA/RS ICMS-ST PROPRIO
					GIA->VFECPST  += SF6->F6_VALOR
				Else
					GIA->VLST  +=SF6->F6_VALOR
				EndIf
			Endif
		EndIf
		MsUnlock()
	EndIf

	IF Dtos(SF6->F6_DTARREC) >= Dtos(dDtIni) .and. Dtos(SF6->F6_DTARREC) <= Dtos(dDtFim) .and. Dtos(SF6->F6_DTVENC) >= Dtos(dDtIni) .and. Dtos(SF6->F6_DTVENC) <= Dtos(dDtFim)
		If SF6->F6_VENCAUT == "1"
			If PAG->(DbSeek(Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)))
				RECLOCK("PAG",.F.)
			Else
				RECLOCK("PAG",.T.)
				PAG->VENCTO := Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)
			EndIf
			If SF6->F6_TIPOIMP$"1# "
				If ALLTRIM(SF6->F6_CODREC)$'1512|1513' // AMPARA/RS ICMS PROPRIO
					PAG->VALFECP += SF6->F6_VALOR
				Else
					PAG->VLICM += SF6->F6_VALOR
				EndIf
			ElseIf	SF6->F6_TIPOIMP=="3" .and.  _aTotal[10] == 1
				If (!Empty(cMv_StUf) .And. (SF6->F6_EST$cMv_StUf)) .or. Empty(cMv_StUf)
					PAG->VLST  += SF6->F6_VALOR
				EndIf
			EndIf

			MsUnlock()

		ElseIf SF6->F6_VENCAUT== "2"
			If SF6->F6_TIPOIMP$"1# "
				_aTotal[76]+= SF6->F6_VALOR
			ElseIf	SF6->F6_TIPOIMP=="3" .and. _aTotal[10] == 1
				If (!Empty(cMv_StUf) .And. (SF6->F6_EST$cMv_StUf)) .or. Empty(cMv_StUf)
					If ALLTRIM(SF6->F6_CODREC)$'1514' // AMPARA/RS ICMS-ST PROPRIO
						PAG->VFECPST  += SF6->F6_VALOR
					Else
						PAG->VLST  += SF6->F6_VALOR
					EndIF
				EndIf
			EndIf
		EndIf
	EndIf

	DbselectArea("SF6")
	SF6->(DbSkip())

EndDo

Return({cArqTRB,cArqTRB2})

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGIARSVIII บAutor  ณEduardo Jos้ Zanardoบ Data ณ  15/10/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ GIA-RS - Reg. 8               							  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function GIARSVIII(dDtIni,dDtFim)

Local cArqTRB	:= ""
/*
Local aCampos	:= {}
Local cMV_StUf	:= GetNewPar("MV_STUF","")	// Def. estado a serem utilizados para o artigo 281

TRATAMENTO ABAIXO CENTRALIZADO NA FUNวรO GIARSX

AADD(aCampos,{"VENCTO"	,"C",8,0})
AADD(aCampos,{"VLICM"	,"N",13,2})
AADD(aCampos,{"VLST"	,"N",13,2})

cArqTRB :=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cArqTRB,"PAG",.T.,.F.)
IndRegua("PAG",cArqTRB,"VENCTO")
DbSelectArea("PAG")
DbClearIndex()
DbSetIndex(cArqTRB+OrdBagExt())

DbselectArea("SF6")
dbSetOrder(2)
DbSeek(xFilial("SF6"))



	While SF6->(!EOF()) .and. SF6->F6_FILIAL==xFilial("SF6")
		IF Dtos(SF6->F6_DTARREC) >= Dtos(dDtIni) .and. Dtos(SF6->F6_DTARREC) <= Dtos(dDtFim) .and. Dtos(SF6->F6_DTVENC) >= Dtos(dDtIni) .and. Dtos(SF6->F6_DTVENC) <= Dtos(dDtFim)
			If SF6->F6_VENCAUT == "1"
				If PAG->(DbSeek(Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)))
					RECLOCK("PAG",.F.)
				Else
					RECLOCK("PAG",.T.)
					PAG->VENCTO := Substr(DTOS(SF6->F6_DTVENC),7,2)+Substr(DTOS(SF6->F6_DTVENC),5,2)+Substr(DTOS(SF6->F6_DTVENC),1,4)
				EndIf
				If SF6->F6_TIPOIMP$"1# "
					PAG->VLICM += SF6->F6_VALOR
				ElseIf	SF6->F6_TIPOIMP=="3" .and.  _aTotal[10] == 1
				    If (!Empty(cMv_StUf) .And. (SF6->F6_EST$cMv_StUf)) .or. Empty(cMv_StUf)
						PAG->VLST  += SF6->F6_VALOR
					EndIf
				EndIf

				MsUnlock()

			ElseIf SF6->F6_VENCAUT== "2"
				If SF6->F6_TIPOIMP$"1# "
					_aTotal[76]+= SF6->F6_VALOR
				ElseIf	SF6->F6_TIPOIMP=="3" .and. _aTotal[10] == 1
					    If (!Empty(cMv_StUf) .And. (SF6->F6_EST$cMv_StUf)) .or. Empty(cMv_StUf)
							_aTotal[75]+= SF6->F6_VALOR
						EndIf
				EndIf
			EndIf
		EndIf
		DbselectArea("SF6")
		SF6->(DbSkip())
	EndDo

*/
Return(cArqTRB)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGIARSVIII บAutor  ณEduardo Jos้ Zanardoบ Data ณ  15/10/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ GIA-RS - Reg. 8               							  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function GRAVAGIARS(cDest,cDir)

Local cArqAbc   := "ABC.TXT"
Local cArqGia   := "A1.TXT"
Local cConteudo := ""
Local cLinha 	:= ""

If File(Alltrim(cDir)+cArqAbc)
	cConteudo:=Memoread(Alltrim(cDir)+cArqAbc)
 	cConteudo:=Substr(alltrim(cConteudo),1,891)+Chr(13)+Chr(10)
 	If File(Alltrim(cDir)+cArqGia)
 		cLinha:= Memoread(Alltrim(cDir)+cArqGia)
	 	Ferase(Alltrim(cDir)+cArqGia)
 	Endif
	If !Empty(cLinha)
		cConteudo:= cConteudo+cLinha
	Endif
	Ferase(Alltrim(cDir)+cArqAbc)

	MemoWrite(Alltrim(cDir)+Alltrim(cDest),cConteudo)
Endif

Return(.T.)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGIARSIV   บAutor  ณEduardo Jos้ Zanardoบ Data ณ  15/10/02   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ GIA-RS - Reg. 4               							  บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													   ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function GIARSIV(dDtFim)

Local aApuICM := FisApur("IC",val(Substr(DTOS(dDtFim),1,4)),val(Substr(DTOS(dDtFim),5,2)),2,0,"*",.F.,{},1,.F.,"",0)
Local aApuST  := FisApur("ST",val(Substr(DTOS(dDtFim),1,4)),val(Substr(DTOS(dDtFim),5,2)),2,0,"*",.F.,{},1,.F.,"",0)
Local aCampos := {}
Local cArqTRB := ""
Local nX	  := 0
Local nY	  := 0
Local cVenc	  := ""
Local cPerApu := ""
Local aDatas  := {}

AADD(aCampos,{"PERAPU"	,"C",10,0})
AADD(aCampos,{"VENCTO"	,"C",8,0})
AADD(aCampos,{"VLDEV"	,"N",13,2})
AADD(aCampos,{"VLPAG"	,"N",13,2})

cArqTRB :=	CriaTrab(aCampos)

dbUseArea(.T.,__LocalDriver,cArqTRB,"GIC",.T.,.F.)

IndRegua("GIC",cArqTRB,"PERAPU+VENCTO")

DbSelectArea("GIC")
DbClearIndex()
DbSetIndex(cArqTRB+OrdBagExt())

For nX := 1 to Len(aApuICM)

	DbSelectArea("SF6")
	SF6->(dbSetOrder(1))
	If   alltrim((aApuICM[nX][1]))=="006" .and. !Empty(aApuICM[nX][5])
		If SF6->(MsSeek(xFilial("SF6")+Alltrim(aApuICM[nX][5])))
			aDatas  := DetDatas(val(Substr(Dtos(SF6->F6_DTARREC),5,2)),val(Substr(Dtos(SF6->F6_DTARREC),1,4)),2,0)
		    cPerApu := Substr(Dtos(aDatas[01]),7,2)+Substr(Dtos(aDatas[02]),7,2)+Substr(Dtos(aDatas[02]),5,2)+Substr(Dtos(aDatas[02]),1,4)
			cVenc   := Substr(Dtos(SF6->F6_DTVENC),7,2)+Substr(Dtos(SF6->F6_DTVENC),5,2)+Substr(Dtos(SF6->F6_DTVENC),1,4)
			DbSelectArea("GIC")
			If GIC->(dbSeek(cVenc))
				RECLOCK("GIC",.F.)
			Else
				RECLOCK("GIC",.T.)
				GIC->PERAPU := cPerApu
				GIC->VENCTO := cVenc
	        EndIf
			GIC->VLDEV += (SF6->F6_VALOR)-(aApuICM[nX][3])
			GIC->VLPAG += (SF6->F6_VALOR)
			MsUnlock()
	    EndIf
	Endif

Next nX

For nY := 1 to Len(aApuST)

	DbSelectArea("SF6")
	SF6->(dbSetOrder(1))
	If   alltrim((aApuST[nY][1]))=="007" .and. !Empty(aApuST[nY][5])
		If SF6->(MsSeek(xFilial("SF6"+Alltrim(aApuST[nY][5]))))
			cVenc := Substr(Dtos(SF6->F6_DTVENC),7,2)+Substr(Dtos(SF6->F6_DTVENC),5,2)+Substr(Dtos(SF6->F6_DTVENC),1,4)
			DbSelectArea("GIC")
			If GIC->(dbSeek(cVenc))
				RECLOCK("GIC",.F.)
			Else
				RECLOCK("GIC",.T.)
				GIC->VENCTO := cVenc
	        EndIf
			GIC->VLDEV += (SF6->F6_VALOR)-(aApuST[nY][3])
			GIC->VLPAG += (SF6->F6_VALOR)
			MsUnlock()
	    EndIf
	Endif
Next nY

Return(cArqTRB)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณSRF194    ณ Autor ณEduardo Riera          ณ Data ณ23.01.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณPreparacao dos arquivos para serem utilizados na SRF194     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpN1: [1] Inicializacao                                    ณฑฑ
ฑฑณ          ณ       [2] Finalizacao                                      ณฑฑ
ฑฑณ          ณExpD2: Data Inicial                                         ณฑฑ
ฑฑณ          ณExpD3: Data Final                                           ณฑฑ
ฑฑณ          ณExpA4: Array de Controle                                    ณฑฑ
ฑฑณ          ณExpN5: [1] SRF194 - DIF CIGARROS                            ณฑฑ
ฑฑณ          ณ       [2] SRF325 - DIF BEBIDAS                             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function SRF194(nTipo,dDataIni,dDataFim,aControle,nSrf, nVersao, cFilDe, cFilAte, aEmpresa)

Local aArea     := GetArea()
Local aAreaSm0	:=	SM0->(GetArea ())
Local aStruSF3  := SF3->(dbStruct())
Local aStruSD1  := SD1->(dbStruct())
Local aStruSD2  := SD2->(dbStruct())
Local cAliasSD1 := "SD1"
Local cAliasSD2 := "SD2"
Local cAliasSF3 := "SF3"
Local cAliasSB1 := "SB1"
Local cKey      := ""
Local cArqSF3   := ""
Local cQuery    := ""
Local cChave    := ""
Local lQuery    := .F.
Local lGravou   := .F.
Local lValido   := .F.
Local nX        := 0
Local nItem     := 0
Local cPosIPI   := ""
Local nJ        := 1
#IFDEF TOP
	Local cAliasSB5 := "SB5"
#ENDIF
Default nSrf    := 1
Default nVersao := 0
Default cFilDe	:=	cFilAnt
Default cFilAte	:=	cFilAnt
Default aEmpresa:= {}

If nTipo == 1
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Cria os arquivo temporarios para a normativa - SRF194        ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	aadd(aStruSD1,{"D1_POSIPI","C",10,0})
	aadd(aStruSD2,{"D2_POSIPI","C",10,0})
	If nSrf == 2
		aadd(aStruSD1,{"D1_ITEMNF","C",03,0})
		aadd(aStruSD2,{"D2_ITEMNF","C",03,0})
	Endif
	aadd(aStruSD1,{"D1_TR3SER","C",3,0})
	aadd(aStruSD2,{"D2_TR2SER","C",3,0})

	aControle := {}
	aAdd (aStruSF3, {"F3_FILF1", "C", 2, 0})
	aAdd (aStruSF3, {"F3_FILF2", "C", 2, 0})
	aAdd (aStruSF3, {"F3_FILA1", "C", 2, 0})
	aAdd (aStruSF3, {"F3_FILA2", "C", 2, 0})
	aadd (aStruSF3, {"F3_TRBSER","C",3,0})

	aadd(aControle,{"TRB",CriaTrab(aStruSF3,.T.)})
	dbUseArea(.T.,__LocalDrive,aControle[1,2],"TRB")
	IndRegua("TRB",aControle[1,2],"F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA+Dtos(F3_EMISSAO)")

	aAdd (aStruSD2, {"D2_FILB1", "C", 2, 0})
	aAdd (aStruSD2, {"D2_FILB5", "C", 2, 0})
	aadd(aControle,{"TR2",CriaTrab(aStruSD2,.T.)})
	dbUseArea(.T.,__LocalDrive,aControle[2,2],"TR2")
	IndRegua("TR2",aControle[2,2],"D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+D2_POSIPI")

	aAdd (aStruSD1, {"D1_FILB1", "C", 2, 0})
	aAdd (aStruSD1, {"D1_FILB5", "C", 2, 0})
	aadd(aControle,{"TR3",CriaTrab(aStruSD1,.T.)})
	dbUseArea(.T.,__LocalDrive,aControle[3,2],"TR3")
	If nSrf == 1
		IndRegua("TR3",aControle[3,2],"D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_POSIPI")
	ElseIf nSrf == 2
		IndRegua("TR3",aControle[3,2],"D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_POSIPI+D1_CF+D1_ITEM")
	Endif
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMonto no array aEmpresa todas as filiais da empresa correnteณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	cFilAte := Iif (Empty (cFilAte+cFilDe), cFilAnt, cFilAte)
	cFilDe  := Iif (Empty (cFilAte+cFilDe), cFilAnt, cFilDe)

	If Empty(aEmpresa)
		DbSelectArea ("SM0")
		SM0->(DbSeek (cEmpAnt+cFilDe, .T.))
		Do While !SM0->(Eof ()) .And. (FWGrpCompany()==cEmpAnt) .And. (FWCodFil()<=cFilAte)
			Aadd( aEmpresa, { .T., SM0->M0_CODFIL, SM0->M0_FILIAL, SM0->M0_CGC, SM0->M0_INSC, SM0->M0_INSCM } )
			SM0->(DbSkip ())
		EndDo
	EndIf
	aSort(aEmpresa,,,{|x,y| x[4]+x[5]+x[6]+x[2] < y[4]+y[5]+x[6]+y[2]}) //-- Ordena por CNPJ, IE, Insc.Municipal e Codigo de Filial para facilitar a quebra de rotinas consolidadas
	RestArea(aAreaSm0)

	Do While (nJ<=Len (aEmpresa))	//Empresas do array aEmpresa
		DbSelectArea("SM0")
		SM0->(DbSeek (FWGrpCompany()+aEmpresa[nJ,2], .T.))
		cFilAnt		:=	FWCodFil()
		//
		dbSelectArea("SF3")
		cKey   := "F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA+Dtos(F3_EMISSAO)"
		#IFDEF TOP
			cAliasSF3 := "SRF194SF3"

			lQuery := .T.
			cQuery := "SELECT * "
			cQuery += "FROM "+RetSqlName("SF3")+" SF3 "
			cQuery += "WHERE "
			cQuery += "F3_FILIAL = '"+xFilial("SF3")+"' AND "
			cQuery += "F3_ENTRADA >= '"+Dtos(dDataIni)+"' AND "
			cQuery += "F3_ENTRADA <= '"+Dtos(dDataFim)+"' AND "
			cQuery += "SF3.D_E_L_E_T_=' ' "

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3)
			For nX := 1 To Len(aStruSF3)
				If aStruSF3[nX][2]<>"C"
					TcSetField(cAliasSF3,aStruSF3[nX][1],aStruSF3[nX][2],aStruSF3[nX][3],aStruSF3[nX][4])
				EndIf
			Next nX
		#ELSE
			cQuery := "F3_FILIAL=='"+xFilial("SF3")+"' .AND. "
			cQuery += "DTOS(F3_ENTRADA) >= '"+Dtos(dDataIni)+"' .AND. "
			cQuery += "DTOS(F3_ENTRADA) <= '"+Dtos(dDataFim)+"' "
			cArqSF3 := CriaTrab(,.F.)
			IndRegua("SF3",cArqSF3,cKey,,cQuery)
			dbGotop()
		#ENDIF
		dbSelectArea(cAliasSF3)
		While !Eof()
			lGravou := .F.
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณ Verifica se eh entrada ou saida                              ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If SubStr((cAliasSF3)->F3_CFO,1,1) < "5"
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณ Tratamento para Entrada                                      ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				#IFDEF TOP
					lQuery := .T.
					cAliasSB1 := "SRF194SD1"
					cAliasSD1 := "SRF194SD1"
					cAliasSB5 := "SRF194SD1"

				    cQuery := "SELECT SD1.*,SB1.B1_POSIPI "
				    cQuery += "FROM "+RetSqlName("SD1")+" SD1, "
				    cQuery += RetSqlName("SB1")+" SB1,"
				    cQuery += RetSqlName("SB5")+" SB5 "
				    cQuery += "WHERE SD1.D1_FILIAL='"+F3Filial("SD1")+"' AND "
				    cQuery += "SD1.D1_DOC='"+(cAliasSF3)->F3_NFISCAL+"' AND "
				    cQuery += "SD1.D1_SERIE='"+(cAliasSF3)->F3_SERIE+"' AND "
				    cQuery += "SD1.D1_FORNECE='"+(cAliasSF3)->F3_CLIEFOR+"' AND "
				    cQuery += "SD1.D1_LOJA='"+(cAliasSF3)->F3_LOJA+"' AND "
				    cQuery += "SD1.D_E_L_E_T_=' ' AND "
				    cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
				    cQuery += "SB1.B1_COD=SD1.D1_COD AND "
		   		    If nSrf == 1
			   		    If nVersao==30
			   		    	cQuery += "SB1.B1_POSIPI IN('39202019', '39202090','55020010','56012190','56012291','48132000','48139000','76072000') AND "
			   		    	cQuery += "SD1.D1_TIPO NOT IN ('C','I','P') AND "
			   		    Else
				   		    cQuery += "SB1.B1_POSIPI IN('39202019', '24022000','39202090','55020010','56012190','56012291','48132000','48139000','76072000') AND "
			   		    EndIf
		   		    ElseIf nSrf == 2
			   		    cQuery += "(SB1.B1_POSIPI IN('39011010','39011091','39011092','39012011','39012019','39012021','39012029') OR "
			   		    cQuery += "SB1.B1_POSIPI IN('39021010','39021020','39023000','39076000','39232110','39232190','39233000') OR "
						cQuery += "SB1.B1_POSIPI IN('39235000','45031000','48115122','48115923','70109011','70109021','70109090') OR "
						cQuery += "SB1.B1_POSIPI IN('73102110','73102910','76129019','83091000','83099000') ) AND "
		   		    Endif
				    cQuery += "SB1.D_E_L_E_T_=' ' AND "
				    cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
		   		    cQuery += "SB5.B5_COD=SD1.D1_COD AND "
		   		    cQuery += "SB5.D_E_L_E_T_=' '  "

		   		    cQuery := ChangeQuery(cQuery)
		   		    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1)
		   		    For nX := 1 To Len(aStruSD1)
		   		    	If aStruSD1[nX][2]<>"C"
							TcSetField(cAliasSD1,aStruSD1[nX][1],aStruSD1[nX][2],aStruSD1[nX][3],aStruSD1[nX][4])
						EndIf
		   		    Next nX

				#ELSE
					dbSelectArea("SD1")
					dbSetOrder(1)
					MsSeek(F3Filial("SD1")+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA)
				#ENDIF
				nItem := 1
				While !Eof() .And. F3Filial("SD1") == xFilial("SD1") .And.;
					(cAliasSF3)->F3_NFISCAL == (cAliasSD1)->D1_DOC .And.;
					(cAliasSF3)->F3_SERIE == (cAliasSD1)->D1_SERIE .And.;
					(cAliasSF3)->F3_CLIEFOR == (cAliasSD1)->D1_FORNECE .And.;
					(cAliasSF3)->F3_LOJA == (cAliasSD1)->D1_LOJA
					lValido := .F.
					If !lQuery
						dbSelectArea("SB1")
						dbSetOrder(1)
						MsSeek(xFilial("SB1")+(cAliasSD1)->D1_COD)
						dbSelectArea("SB5")
						dbSetOrder(1)
						lValido := MsSeek(xFilial("SB5")+(cAliasSD1)->D1_COD)
					    If nVersao==30
							cPosIPI	:=	"39202019#39202090#55020010#56012190#56012291#48132000#48139000#76072000"
							If ((cAliasSD1)->D1_TIPO$"CIP")
								lValido	:=	.F.
							EndIf
						Else
							cPosIPI	:=	"39202019#24022000#39202090#55020010#56012190#56012291#48132000#48139000#76072000"
						EndIf
					    If nSrf == 1 .And. !AllTrim((cAliasSB1)->B1_POSIPI) $ cPosIPI ;
					        .And. lValido
							lValido := .F.
						ElseIf nSrf == 2 .And. lValido 	.And. ;
						    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39011010#39011091#39011092#39012011#39012019#39012021#39012029" .And.;
				   		    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39021010#39021020#39023000#39076000#39232110#39232190#39233000" .And.;
							!Alltrim((cAliasSB1)->B1_POSIPI) $ "39235000#45031000#48115122#48115923#70109011#70109021#70109090" .And.;
							!Alltrim((cAliasSB1)->B1_POSIPI) $ "73102110#73102910#76129019#83091000#83099000"
							lValido := .F.
						Endif
					Else
						lValido := .T.
					EndIf
					If nSrf == 2 .And. (cAliasSD1)->D1_TIPO == 'C' .And. Left((cAliasSD1)->D1_ORIGLAN,1) == 'F'
						lValido := .F.
					Endif

					If lValido

						dbSelectArea("TR3")
						If nSrf == 1
							cChave := (cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSB1)->B1_POSIPI
						ElseIf nSrf == 2
							cChave := (cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSB1)->B1_POSIPI+(cAliasSD1)->D1_CF+(cAliasSD1)->D1_ITEM
						Endif
						If !MsSeek(cChave)
							RecLock("TR3",.T.)
							For nX := 1 To Len(aStruSD1)
								If (cAliasSD1)->(FieldPos(aStruSD1[nX][1]))<>0
									FieldPut(nX,(cAliasSD1)->(FieldGet(FieldPos(aStruSD1[nX][1]))))
								EndIf
							Next nX
							TR3->D1_POSIPI  := (cAliasSB1)->B1_POSIPI
							If nSrf == 2
								TR3->D1_ITEMNF  := StrZero(nItem,3)
							Endif
							TR3->D1_FILB1	:=	xFilial ("SB1")
							TR3->D1_FILB5	:=	xFilial ("SB5")
							TR3->D1_TR3SER  := SerieNfId( cAliasSD1,2,"D1_SERIE")
						Else
							If nSrf == 1
								RecLock("TR3",.F.)
								TR3->D1_QUANT   += (cAliasSD1)->D1_QUANT
								TR3->D1_TOTAL   += (cAliasSD1)->D1_TOTAL
								TR3->D1_VALDESC += (cAliasSD1)->D1_VALDESC
								TR3->D1_VALIPI  += (cAliasSD1)->D1_VALIPI
							Endif
						EndIf
						lGravou := .T.
						nItem ++
						MsUnLock()
		            EndIf
					dbSelectArea(cAliasSD1)
					dbSkip()
				EndDo
				If lQuery
					dbSelectArea(cAliasSD1)
					dbCloseArea()
					dbSelectArea("SD1")
				EndIf
			Else
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณ Tratamento para Saida                                        ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				If nSrf == 1
					#IFDEF TOP
						lQuery := .T.
						cAliasSB1 := "SRF194SD2"
						cAliasSD2 := "SRF194SD2"
						cAliasSB5 := "SRF194SD2"

					    cQuery := "SELECT SD2.*,SB1.B1_POSIPI "
					    cQuery += "FROM "+RetSqlName("SD2")+" SD2, "
					    cQuery += RetSqlName("SB1")+" SB1,"
					    cQuery += RetSqlName("SB5")+" SB5 "
					    cQuery += "WHERE SD2.D2_FILIAL='"+F3Filial("SD2")+"' AND "
					    cQuery += "SD2.D2_DOC='"+(cAliasSF3)->F3_NFISCAL+"' AND "
					    cQuery += "SD2.D2_SERIE='"+(cAliasSF3)->F3_SERIE+"' AND "
					    cQuery += "SD2.D2_CLIENTE='"+(cAliasSF3)->F3_CLIEFOR+"' AND "
					    cQuery += "SD2.D2_LOJA='"+(cAliasSF3)->F3_LOJA+"' AND "
					    cQuery += "SD2.D_E_L_E_T_=' ' AND "
					    cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
					    cQuery += "SB1.B1_COD=SD2.D2_COD AND "
					    If nVersao==30
						    cQuery += "SB1.B1_POSIPI IN('24022000') AND "
						    cQuery += "SD2.D2_TIPO NOT IN ('C','I','P') AND "
			   		    Else
			   		    	cQuery += "SB1.B1_POSIPI IN('39202019','24022000','39202090','55020010','56012190','56012291','48132000','48139000','76072000') AND "
			   		    EndIf
					    cQuery += "SB1.D_E_L_E_T_=' ' AND "
					    cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
			   		    cQuery += "SB5.B5_COD=SD2.D2_COD AND "
			   		    cQuery += "SB5.D_E_L_E_T_=' '  "

			   		    cQuery := ChangeQuery(cQuery)
			   		    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2)
			   		    For nX := 1 To Len(aStruSD2)
			   		    	If aStruSD2[nX][2]<>"C"
								TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
							EndIf
			   		    Next nX
					#ELSE
						dbSelectArea("SD2")
						dbSetOrder(3)
						MsSeek(F3Filial("SD2")+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA)
					#ENDIF

					While !Eof() .And. F3Filial("SD2") == xFilial("SD2") .And.;
						(cAliasSF3)->F3_NFISCAL == (cAliasSD2)->D2_DOC .And.;
						(cAliasSF3)->F3_SERIE == (cAliasSD2)->D2_SERIE .And.;
						(cAliasSF3)->F3_CLIEFOR == (cAliasSD2)->D2_CLIENTE .And.;
						(cAliasSF3)->F3_LOJA == (cAliasSD2)->D2_LOJA
						lValido := .F.
						If !lQuery
							dbSelectArea("SB1")
							dbSetOrder(1)
							MsSeek(xFilial("SB1")+(cAliasSD2)->D2_COD)
							dbSelectArea("SB5")
							dbSetOrder(1)
							lValido := MsSeek(xFilial("SB5")+(cAliasSD2)->D2_COD)
						Else
							lValido	:=	.T.
						EndIf
						//
						If nVersao==30
							cPosIPI	:=	"#24022000#"
							If ((cAliasSD2)->D2_TIPO$"CIP")
								lValido	:=	.F.
							EndIf
						Else
							cPosIPI	:=	"39202019#24022000#39202090#55020010#56012190#56012291#48132000#48139000#76072000"
						EndIf
						//
						If lValido .And. AllTrim((cAliasSB1)->B1_POSIPI) $ cPosIPI
							dbSelectArea("TR2")
							If !MsSeek((cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSB1)->B1_POSIPI)
								RecLock("TR2",.T.)
								For nX := 1 To Len(aStruSD2)
									If (cAliasSD2)->(FieldPos(aStruSD2[nX][1]))<>0
										FieldPut(nX,(cAliasSD2)->(FieldGet(FieldPos(aStruSD2[nX][1]))))
									EndIf
								Next nX
								TR2->D2_POSIPI  := (cAliasSB1)->B1_POSIPI
								TR2->D2_FILB1	:=	xFilial ("SB1")
								TR2->D2_FILB5	:=	xFilial ("SB5")
								TR2->D2_TR2SER  := SerieNfId( cAliasSD2,2,"D2_SERIE")
							Else
								RecLock("TR2",.F.)
								TR2->D2_QUANT   += (cAliasSD2)->D2_QUANT
								TR2->D2_PRCVEN  += (cAliasSD2)->D2_PRCVEN
								TR2->D2_TOTAL   += (cAliasSD2)->D2_TOTAL
								TR2->D2_VALIPI  += (cAliasSD2)->D2_VALIPI
							EndIf
							lGravou := .T.
							MsUnLock()
			            EndIf
						dbSelectArea(cAliasSD2)
						dbSkip()
					EndDo
					If lQuery
						dbSelectArea(cAliasSD2)
						dbCloseArea()
						dbSelectArea("SD1")
					EndIf
				Endif
			EndIf
			If lGravou .Or. !Empty((cAliasSF3)->F3_DTCANC) .Or. "CANCEL"$(cAliasSF3)->F3_OBSERV
				dbSelectArea("TRB")
				If !MsSeek((cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA+Dtos((cAliasSF3)->F3_EMISSAO))
					RecLock("TRB",.T.)
					For nX := 1 To Len(aStruSF3)
						If !AllTrim (aStruSF3[nX][1])$"F3_FILF1/F3_FILF2/F3_FILA1/F3_FILA2/F3_TRBSER" .And. !Empty((cAliasSF3)->(FieldName(nX)))
							FieldPut(nX,(cAliasSF3)->(FieldGet(FieldPos(aStruSF3[nX][1]))))
						EndIf
					Next nX
					TRB->F3_FILF1	:=	xFilial ("SF1")
					TRB->F3_FILF2	:=	xFilial ("SF2")
					TRB->F3_FILA1	:=	xFilial ("SA1")
					TRB->F3_FILA2	:=	xFilial ("SA2")
					TRB->F3_TRBSER  := SerieNfId( cAliasSF3 ,2,"F3_SERIE")
				Else
					RecLock("TRB",.F.)
					TRB->F3_VALIPI  += (cAliasSF3)->F3_VALIPI
					TRB->F3_VALCONT += (cAliasSF3)->F3_VALCONT
				EndIf
				MsUnLock()
			EndIf
			dbSelectArea(cAliasSF3)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSF3)
			dbCloseArea()
			dbSelectArea("SF3")
		Else
			SF3->(RetIndex("SF3"))
			FErase(cArqSF3+OrdBagExt())
		EndIf
		//
		nJ++
	EndDo
	RestArea (aAreaSm0)
	cFilAnt		:=	FWCodFil()
Else
	For nX := 1 To Len(aControle)
		dbSelectArea(aControle[nX][1])
		dbCloseArea()
		FErase(aControle[nX][2]+GetDbExtension())
		FErase(aControle[nX][2]+OrdBagExt())
	Next nX
	dbSelectArea("SX1")
EndIf
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Restaura area                                                ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
RestArea(aArea)
Return(.T.)


/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณ FsGuiaRS ณ Autor ณ Nereu Humberto Junior ณ Data ณ19.03.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Totalizacao de Campos do Fiscal por CFOP                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpA1: [1] Total da coluna Valor Contabil                   ณฑฑ
ฑฑณ          ณExpA1: [2] Total da coluna Base de ICMS                     ณฑฑ
ฑฑณ          ณExpA1: [3] Total da coluna Isentas                          ณฑฑ
ฑฑณ          ณExpA1: [4] Total da coluna Outras                           ณฑฑ
ฑฑณ          ณExpA1: [5] Total da coluna ICMS Retido                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function FsGuiaRS()

Local cAliasSF3 := "SF3"
Local nIndex    := 0
Local nI        := 0
Local nX        := 0
Local nPos      := 0
Local nPos2     := 0
Local nTotContE := nTotBaseE := nTotIsenE := nTotOutrE := nTotExclE := 0
Local nTotContS := nTotBaseS := nTotIsenS := nTotOutrS := nTotExclS := 0
Local nVLRetido := nVlOutras := nVlContNC := nVlBaseNC := nVlContCO := 0
Local nVlBaseCO := nValCont  := nValBase  := nValOutr  := nValRetP  := nValRetO := 0
Local nTgRetido := nTgOutras := nTgContNC := nTgBaseNC := nTgContCO := 0
Local nTgBaseCO := nTgCont   := nTgBase   := nTgOutr   := nTgRetP   := nTglRetO := 0
Local cEstado   := ""
Local cQuery    := ""
Local cArqTrab  := ""
Local cArq      := ""
Local cArq1     := ""
Local cKey      := ""
Local cCondicao := ""
Local cCfop     := ""
Local aStru     := {}
Local aStru1    := {}
Local aListCFOP := {}
Local aTotCFOP  := {}
Local aListEst  := {}
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCria arquivos temporarios ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aStru,{"CFOP"	  ,"C",004,0})
AADD(aStru,{"UF"	  ,"C",002,0})
AADD(aStru,{"VALCONT" ,"N",014,2})
AADD(aStru,{"REFEVAL" ,"N",003,0})
AADD(aStru,{"BASEICM" ,"N",014,2})
AADD(aStru,{"REFEBAS" ,"N",003,0})
AADD(aStru,{"ISENICM" ,"N",014,2})
AADD(aStru,{"REFEISE" ,"N",003,0})
AADD(aStru,{"OUTRICM" ,"N",014,2})
AADD(aStru,{"REFEOUT" ,"N",003,0})
AADD(aStru,{"IMPEXCL" ,"N",014,2})
AADD(aStru,{"REFEXCL" ,"N",003,0})
AADD(aStru,{"VALIPI"  ,"N",014,2})
AADD(aStru,{"ICMSRET" ,"N",014,2})
AADD(aStru,{"CLIEFOR" ,"C",006,0})
AADD(aStru,{"LOJA"	  ,"C",002,0})
AADD(aStru,{"TIPO"	  ,"C",001,0})
AADD(aStru,{"ESPECIE" ,"C",005,0})

cArq :=	CriaTrab(aStru)
dbUseArea(.T.,__LocalDriver,cArq,"TR2")
IndRegua("TR2",cArq,"CFOP")

cInd := CriaTrab(Nil,.F.)
IndRegua("TR2",cInd,"UF")
dbClearIndex()
dbSetIndex(cArq+OrdBagExt())
dbSetIndex(cInd+OrdBagExt())
dbSetOrder(1)

AADD(aStru1,{"REF01" ,"N",003,0})
AADD(aStru1,{"VAL01" ,"N",014,2})
AADD(aStru1,{"REF02" ,"N",003,0})
AADD(aStru1,{"VAL02" ,"N",014,2})
AADD(aStru1,{"REF03" ,"N",003,0})
AADD(aStru1,{"VAL03" ,"N",014,2})
AADD(aStru1,{"REF04" ,"N",003,0})
AADD(aStru1,{"VAL04" ,"N",014,2})
AADD(aStru1,{"REF05" ,"N",003,0})
AADD(aStru1,{"VAL05" ,"N",014,2})
AADD(aStru1,{"REF06" ,"N",003,0})
AADD(aStru1,{"VAL06" ,"N",014,2})

cArq1 := CriaTrab(aStru1)
dbUseArea(.T.,__LocalDriver,cArq1,"TR3")
IndRegua("TR3",cArq1,"REF01")

//              CFOP   REF INDICE
AAdd(aListCFOP,{"111",101,51}) //  Compras para industrializa็ใo
AAdd(aListCFOP,{"112",102,51}) //  Compras para comercializa็ใo
AAdd(aListCFOP,{"113",103,51}) //  Industrializa็ใo efetuada por outras empresas
AAdd(aListCFOP,{"120",104,51}) //  Transf. p/ ind. com. e/ou presta็ใo de servi็os
AAdd(aListCFOP,{"130",105,51}) //  Devol. vendas prod pr๓pria de terc. e/ou anula็๕es
AAdd(aListCFOP,{"140",106,51}) //  Compra de energia el้trica
AAdd(aListCFOP,{"150",107,51}) //  Aquisi็ใo de servi็o de comunica็ใo
AAdd(aListCFOP,{"160",108,51}) //  Aquisi็ใo de servi็o de transporte
AAdd(aListCFOP,{"170",109,51}) //  Entr. merc. oper. sujeitas Regime Subst. Tribut.
AAdd(aListCFOP,{"181",110,51}) //  Ret. merc. do estab. produtor (Sistema Integrado)
AAdd(aListCFOP,{"182",111,51}) //  Ret. insumos do estab prod. ๑ utiliz. produ็ใo(SI)
AAdd(aListCFOP,{"185",112,51}) //  Ent. mercadorias remetidas - fim especif. export.
AAdd(aListCFOP,{"191",113,51}) //  Compra p/ ativo imobilizado
AAdd(aListCFOP,{"192",114,51}) //  Transfer๊ncia p/ o ativo imobilizado
AAdd(aListCFOP,{"193",115,51}) //  Entrada para industrializa็ใo por encomenda
AAdd(aListCFOP,{"194",116,51}) //  Retorno simb. de insumos util. ind. por encomenda
AAdd(aListCFOP,{"195",117,51}) //  Retornos de remessa p/ vendas fora do estabelec.
AAdd(aListCFOP,{"197",118,51}) //  Compras de materiais p/ uso ou consumo
AAdd(aListCFOP,{"198",119,51}) //  Transfer๊ncia de material p/ uso ou consumo
AAdd(aListCFOP,{"199",120,51}) //  Outras ent. e/ou aquisi็๕es de serv. n especific.
AAdd(aListCFOP,{"100",121,51}) //  SUBTOTAL DAS ENTRADAS DO ESTADO
AAdd(aListCFOP,{"211",122,51}) //  Compras para industrializa็ใo
AAdd(aListCFOP,{"212",123,51}) //  Compras para comercializa็ใo
AAdd(aListCFOP,{"213",124,51}) //  Industrializa็ใo efetuada por outras empresas
AAdd(aListCFOP,{"220",125,51}) //  Transf. p/ industr. comerc. e/ou prest. servi็os
AAdd(aListCFOP,{"230",126,51}) //  Devol. vendas prod. pr๓pria, terc. e/ou anul. val.
AAdd(aListCFOP,{"240",127,51}) //  Compra de energia el้trica
AAdd(aListCFOP,{"250",128,51}) //  Aquisi็ใo de servi็o de comunica็ใo
AAdd(aListCFOP,{"260",129,51}) //  Aquisi็ใo de servi็o de transporte
AAdd(aListCFOP,{"270",130,51}) //  Ent. merc. opers. sujeitas a Regime Subst. Tribut.
AAdd(aListCFOP,{"285",131,51}) //  Ent. mercad. remetidas - fim especif. exporta็ใo
AAdd(aListCFOP,{"291",132,51}) //  Compra p/ ativo imobilizado
AAdd(aListCFOP,{"292",133,51}) //  Transfer๊ncia p/ o ativo imobilizado
AAdd(aListCFOP,{"293",134,51}) //  Entrada para industrializa็ใo por encomenda
AAdd(aListCFOP,{"294",135,51}) //  Retorno simb. insumos util. industr. por encomenda
AAdd(aListCFOP,{"295",136,51}) //  Retornos de Remessa p/ vendas fora do estabelec.
AAdd(aListCFOP,{"297",137,51}) //  Compras de materiais p/ uso ou consumo
AAdd(aListCFOP,{"298",138,51}) //  Transfer๊ncia de materiais p/ uso ou consumo
AAdd(aListCFOP,{"299",139,51}) //  Outras entr. e/ou aquisi็๕es serv. nใo especific.
AAdd(aListCFOP,{"200",140,51}) //  SUBTOTAL DAS ENTRADAS DE OUTROS ESTADOS
AAdd(aListCFOP,{"311",141,51}) //  Compras para industrializa็ใo
AAdd(aListCFOP,{"312",142,51}) //  Compras para comercializa็ใo
AAdd(aListCFOP,{"320",143,51}) //  Devol. vendas prod. pr๓pria, terc. e/ou anul. val.
AAdd(aListCFOP,{"330",144,51}) //  Compra de energia el้tr. para distrib. ou comerc.
AAdd(aListCFOP,{"350",145,51}) //  Aquisi็ใo de servi็o de transporte
AAdd(aListCFOP,{"391",146,51}) //  Compra para o ativo imobilizado
AAdd(aListCFOP,{"394",147,51}) //  Entrada sob o regime de "drawback"
AAdd(aListCFOP,{"397",148,51}) //  Compras de materiais p/ uso ou consumo
AAdd(aListCFOP,{"399",149,51}) //  Outras ent. e/ou aquisi็๕es serv. nใo especific.
AAdd(aListCFOP,{"300",150,51}) //  SUBTOTAL DAS ENTRADAS DO EXTERIOR
AAdd(aListCFOP,{"400",151,51}) //  TOTAL DE ENTRADAS Itens
AAdd(aListCFOP,{"511",361,48}) //  Venda de produ็ใo do estabelecimento
AAdd(aListCFOP,{"512",362,48}) //  Venda merc. adquiridas e/ou recebidas de terceiros
AAdd(aListCFOP,{"513",363,48}) //  Industrializa็ใo efetivada para outras empresas
AAdd(aListCFOP,{"514",364,48}) //  Vendas (prod. prop, terc) efetuadas fora estabelec
AAdd(aListCFOP,{"520",365,48}) //  Transfer๊ncias produ็ใo pr๓pria e/ou de terceiros
AAdd(aListCFOP,{"530",366,48}) //  Devol. compras p/ industr, comerc. e/ou anul. val.
AAdd(aListCFOP,{"540",367,48}) //  Venda de energia el้trica
AAdd(aListCFOP,{"550",368,48}) //  Presta็ใo de servi็o de comunica็ใo
AAdd(aListCFOP,{"560",369,48}) //  Presta็ใo de servi็o de transporte
AAdd(aListCFOP,{"570",370,48}) //  Saํdas merc. opers. sujeitas Regime Subst. Tribut.
AAdd(aListCFOP,{"580",371,48}) //  Remessa insumos p/ estabelecimento produtor (SI)
AAdd(aListCFOP,{"585",372,48}) //  Remessas- fim de exporta็ใo e eventuais devolu็๕es
AAdd(aListCFOP,{"591",373,48}) //  Venda de ativo imobilizado
AAdd(aListCFOP,{"592",374,48}) //  Transf. ativo imobil. e/ou mat. p/ uso e consumo
AAdd(aListCFOP,{"593",375,48}) //  Saํda para industrializa็ใo por encomenda
AAdd(aListCFOP,{"594",376,48}) //  Remessa simb. insumo util. industr. por encomenda
AAdd(aListCFOP,{"595",377,48}) //  Devol. compra p/ ativo imob. e/ou mat. uso consumo
AAdd(aListCFOP,{"596",378,48}) //  Remessas p/ vendas fora do estabelecimento
AAdd(aListCFOP,{"599",379,48}) //  Outras saํdas e/ou prest. servi็os nใo especific.
AAdd(aListCFOP,{"500",380,48}) //  SUBTOTAL DAS SAอDAS PARA O ESTADO
AAdd(aListCFOP,{"611",381,48}) //  Venda de produ็ใo do estabelecimento
AAdd(aListCFOP,{"612",382,48}) //  Venda mercad. adquirida e/ou recebida de terceiros
AAdd(aListCFOP,{"613",383,48}) //  Industrializa็ใo efetuada para outras empresas
AAdd(aListCFOP,{"614",384,48}) //  Vendas (prod. prop, terc) efetuadas fora estabelec
AAdd(aListCFOP,{"620",385,48}) //  Transfer๊ncia de produ็ใo pr๓pria e/ou de terceiro
AAdd(aListCFOP,{"630",386,48}) //  Devol. compras p/ indust. comerc. e/ou anul. val.
AAdd(aListCFOP,{"640",387,48}) //  Venda de energia el้trica
AAdd(aListCFOP,{"650",388,48}) //  Presta็ใo de servi็o de comunica็ใo
AAdd(aListCFOP,{"660",389,48}) //  Presta็ใo de servi็o de transporte
AAdd(aListCFOP,{"670",390,48}) //  Saํdas merc. opers. sujeitas Regime Subst. Tribut.
AAdd(aListCFOP,{"685",391,48}) //  Remessas - fim exporta็๕es e eventuais devolu็๕es
AAdd(aListCFOP,{"691",392,48}) //  Venda de ativo imobilizado
AAdd(aListCFOP,{"692",393,48}) //  Transf. ativo imobil. e/ou mat. p/ uso ou consumo
AAdd(aListCFOP,{"693",394,48}) //  Saํda para industrializa็ใo por encomenda
AAdd(aListCFOP,{"694",395,48}) //  Remessa simb. insumo utiliz. indust. por encomenda
AAdd(aListCFOP,{"695",396,48}) //  Devol. compra p/ ativo imob. e/ou mat. uso consumo
AAdd(aListCFOP,{"696",397,48}) //  Remessas p/ venda fora estab. (inc. Subst. Tribut)
AAdd(aListCFOP,{"699",398,48}) //  Outras saํdas e/ou prest. servi็os nใo especific
AAdd(aListCFOP,{"600",399,48}) //  SUBTOTAL DAS SAอDAS PARA OUTROS ESTADOS
AAdd(aListCFOP,{"711",400,48}) //  Venda de produ็ใo do estabelecimento
AAdd(aListCFOP,{"712",401,48}) //  Venda mercad. adquirida e/ou recebida de terceiros
AAdd(aListCFOP,{"730",402,48}) //  Devol. compras p/ industr. comerc. e/ou anul. val.
AAdd(aListCFOP,{"740",403,48}) //  Venda de energia el้trica
AAdd(aListCFOP,{"750",404,48}) //  Presta็ใo do servi็o de comunica็ใo
AAdd(aListCFOP,{"760",405,48}) //  Presta็ใo de servi็o de transporte
AAdd(aListCFOP,{"799",406,48}) //  Outras saํdas e/ou prest. servi็os nใo especific
AAdd(aListCFOP,{"700",407,48}) //  SUBTOTAL DAS SAอDAS PARA O EXTERIOR
AAdd(aListCFOP,{"800",408,48}) //  TOTAL DE SAอDAS Itens
AAdd(aListCFOP,{"888",151,51}) //  TOTAL GERAL DE ENTRADAS
AAdd(aListCFOP,{"999",408,48}) //  TOTAL GERAL DE SAIDAS
//            EST REF.E REF.S INDICE
AAdd(aListEst,{"AC",601,750,27})
AAdd(aListEst,{"AL",602,751,27})
AAdd(aListEst,{"AP",603,752,27})
AAdd(aListEst,{"AM",604,753,27})
AAdd(aListEst,{"BA",605,754,27})
AAdd(aListEst,{"CE",606,755,27})
AAdd(aListEst,{"DF",607,756,27})
AAdd(aListEst,{"ES",608,757,27})
AAdd(aListEst,{"GO",609,758,27})
AAdd(aListEst,{"MA",610,759,27})
AAdd(aListEst,{"MT",611,760,27})
AAdd(aListEst,{"MS",612,761,27})
AAdd(aListEst,{"MG",613,762,27})
AAdd(aListEst,{"PA",614,763,27})
AAdd(aListEst,{"PB",615,764,27})
AAdd(aListEst,{"PR",616,765,27})
AAdd(aListEst,{"PE",617,766,27})
AAdd(aListEst,{"PI",618,767,27})
AAdd(aListEst,{"RN",619,768,27})
AAdd(aListEst,{"RJ",620,769,27})
AAdd(aListEst,{"RO",621,770,27})
AAdd(aListEst,{"RR",622,771,27})
AAdd(aListEst,{"SC",623,772,27})
AAdd(aListEst,{"SP",624,773,27})
AAdd(aListEst,{"SE",625,774,27})
AAdd(aListEst,{"TO",626,775,27})


dbSelectArea("SF3")
dbSetOrder(3)
#IFDEF TOP
	 cAliasSF3 := "GUIARSBSF3"
	 aStru  := SF3->(dbStruct())
	 cQuery := "SELECT F3_CFO, F3_ESTADO, F3_VALCONT, F3_BASEICM, F3_ISENICM, F3_OUTRICM, F3_ICMSRET, F3_VALIPI, "
	 cQuery += "F3_CLIEFOR, F3_LOJA, F3_TIPO, F3_ESPECIE "
	 cQuery += "FROM "+RetSqlName("SF3")+" "
	 cQuery += "WHERE F3_FILIAL='"+xFilial("SF3")+"' AND "
	 cQuery += "F3_EMISSAO >='"+Dtos(dDmainc)+"' AND "
     cQuery += "F3_EMISSAO <='"+Dtos(dDmaFin)+"' AND "
	 cQuery += "D_E_L_E_T_ = ' ' "
	 cQuery += "ORDER BY "+SqlOrder(SF3->(IndexKey()))

	 cQuery := ChangeQuery(cQuery)
	 dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3,.T.,.T.)

	 For nX := 1 To Len(aStru)
		 If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
			 TcSetField(cAliasSF3,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
		 EndIf
	 Next nX
	 dbSelectArea(cAliasSF3)
#ELSE
     cArqTrab  := CriaTrab(NIL,.F.)
	 cKey	   := SF3->(IndexKey())
	 cCondicao := 'F3_FILIAL=="'+xFilial("SF3")+'".And.'
	 cCondicao += 'DTOS(F3_EMISSAO)>="'+DTOS(dDmainc)+'".And.DTOS(F3_EMISSAO)<="'+DTOS(dDmaFin)+'"'
	 IndRegua(cAliasSF3,cArqTrab,cKey,,cCondicao)
	 nIndex := RetIndex("SF3")
	 dbSelectArea("SF3")
	 dbSetIndex(cArqTrab+OrdBagExt())

	 dbSetOrder(nIndex+1)
	 dbGoTop()
	 dbSelectArea(cAliasSF3)
#ENDIF

While (cAliasSF3)->(!Eof())

	nPos := Ascan(aListCFOP,{|x|x[1]==AllTrim((cAliasSF3)->F3_CFO)})
	If nPos > 0
		dbSelectArea("TR2")
		If !dbSeek( (cAliasSF3)->F3_CFO)
		    Reclock("TR2",.T.)
			TR2->CFOP    := (cAliasSF3)->F3_CFO
			TR2->UF      := (cAliasSF3)->F3_ESTADO
			TR2->CLIEFOR := (cAliasSF3)->F3_CLIEFOR
			TR2->LOJA    := (cAliasSF3)->F3_LOJA
		    TR2->TIPO    := (cAliasSF3)->F3_TIPO
		    TR2->ESPECIE := (cAliasSF3)->F3_ESPECIE
		    TR2->REFEVAL := aListCFOP[nPos,2]
			TR2->REFEBAS := TR2->REFEVAL+aListCFOP[nPos,3]
			TR2->REFEISE := TR2->REFEBAS+aListCFOP[nPos,3]
			TR2->REFEOUT := TR2->REFEISE+aListCFOP[nPos,3]
			TR2->REFEXCL := TR2->REFEOUT+aListCFOP[nPos,3]
		Else
		 	Reclock("TR2",.F.)
		Endif
		TR2->VALCONT += (cAliasSF3)->F3_VALCONT
		TR2->BASEICM += (cAliasSF3)->F3_BASEICM
		TR2->ISENICM += (cAliasSF3)->F3_ISENICM
		TR2->OUTRICM += (cAliasSF3)->F3_OUTRICM
		If Substr((cAliasSF3)->F3_CFO,2,2) <> "99"
			TR2->IMPEXCL += (cAliasSF3)->F3_ICMSRET+(cAliasSF3)->F3_VALIPI
        Endif
		TR2->VALIPI  += (cAliasSF3)->F3_VALIPI
		TR2->ICMSRET += (cAliasSF3)->F3_ICMSRET
		MsUnlock()

		nPos2 := Ascan(aTotCFOP,{|x|x[1]==Substr((cAliasSF3)->F3_CFO,1,1)})
		If nPos2 == 0
			Aadd(aTotCFOP,{Substr((cAliasSF3)->F3_CFO,1,1),(cAliasSF3)->F3_VALCONT,(cAliasSF3)->F3_BASEICM,(cAliasSF3)->F3_ISENICM,(cAliasSF3)->F3_OUTRICM,(cAliasSF3)->F3_ICMSRET+(cAliasSF3)->F3_VALIPI})
		Else
			aTotCFOP[nPos2,2] += (cAliasSF3)->F3_VALCONT
			aTotCFOP[nPos2,3] += (cAliasSF3)->F3_BASEICM
			aTotCFOP[nPos2,4] += (cAliasSF3)->F3_ISENICM
			aTotCFOP[nPos2,5] += (cAliasSF3)->F3_OUTRICM
			If Substr((cAliasSF3)->F3_CFO,2,2) <> "99"
				aTotCFOP[nPos2,6] += (cAliasSF3)->F3_ICMSRET+(cAliasSF3)->F3_VALIPI
			Endif
		Endif
		If Substr((cAliasSF3)->F3_CFO,1,1) < "5"
			nTotContE += (cAliasSF3)->F3_VALCONT
			nTotBaseE += (cAliasSF3)->F3_BASEICM
			nTotIsenE += (cAliasSF3)->F3_ISENICM
			nTotOutrE += (cAliasSF3)->F3_OUTRICM
			If Substr((cAliasSF3)->F3_CFO,2,2) <> "99"
				nTotExclE += (cAliasSF3)->F3_ICMSRET+(cAliasSF3)->F3_VALIPI
			Endif
		Else
			nTotContS += (cAliasSF3)->F3_VALCONT
			nTotBaseS += (cAliasSF3)->F3_BASEICM
			nTotIsenS += (cAliasSF3)->F3_ISENICM
			nTotOutrS += (cAliasSF3)->F3_OUTRICM
			If Substr((cAliasSF3)->F3_CFO,2,2) <> "99"
				nTotExclS += (cAliasSF3)->F3_ICMSRET+(cAliasSF3)->F3_VALIPI
			Endif
		Endif
	Endif
	(cAliasSF3)->(dbSkip())
EndDo
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Gerando os registros para os Subtotais de Entradas/Saidas    ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
For nI:= 1 To Len(aTotCFOP)
	cCfop := ""
	If aTotCFOP[nI,1] == "1"
		cCfop := "100"
	ElseIf aTotCFOP[nI,1] == "2"
	    cCfop := "200"
	ElseIf aTotCFOP[nI,1] == "3"
	    cCfop := "300"
	ElseIf aTotCFOP[nI,1] == "5"
	    cCfop := "500"
	ElseIf aTotCFOP[nI,1] == "6"
	    cCfop := "600"
	ElseIf aTotCFOP[nI,1] == "7"
	    cCfop := "700"
	Endif
	nPos := Ascan(aListCFOP,{|x|x[1]==cCfop})
	If nPos > 0
		dbSelectArea("TR2")
		Reclock("TR2",.T.)
		TR2->REFEVAL := aListCFOP[nPos,2]
		TR2->REFEBAS := TR2->REFEVAL+aListCFOP[nPos,3]
		TR2->REFEISE := TR2->REFEBAS+aListCFOP[nPos,3]
		TR2->REFEOUT := TR2->REFEISE+aListCFOP[nPos,3]
		TR2->REFEXCL := TR2->REFEOUT+aListCFOP[nPos,3]
		TR2->VALCONT := aTotCFOP[nI,2]
		TR2->BASEICM := aTotCFOP[nI,3]
		TR2->ISENICM := aTotCFOP[nI,4]
		TR2->OUTRICM := aTotCFOP[nI,5]
		TR2->IMPEXCL := aTotCFOP[nI,6]
		MsUnlock()
	Endif
Next
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Gerando os registros para os Totais Gerais de Entradas/Saidasณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If nTotContE+nTotContS > 0
	For nX := 1 To 2
	    If (nX == 1 .And. nTotContE == 0) .Or. (nX == 2 .And. nTotContS == 0)
	        Loop
	    Endif
    	cCfop := ""
    	If nX == 1
	    	cCfop := "888"
    	Else
			cCfop := "999"
    	Endif
    	nPos := Ascan(aListCFOP,{|x|x[1]==cCfop})
		If nPos > 0
		    dbSelectArea("TR2")
			Reclock("TR2",.T.)
			TR2->REFEVAL := aListCFOP[nPos,2]
			TR2->REFEBAS := TR2->REFEVAL+aListCFOP[nPos,3]
			TR2->REFEISE := TR2->REFEBAS+aListCFOP[nPos,3]
			TR2->REFEOUT := TR2->REFEISE+aListCFOP[nPos,3]
			TR2->REFEXCL := TR2->REFEOUT+aListCFOP[nPos,3]
			TR2->VALCONT := IIf(nX==1,nTotContE,nTotContS)
			TR2->BASEICM := IIf(nX==1,nTotBaseE,nTotBaseS)
			TR2->ISENICM := IIf(nX==1,nTotIsenE,nTotIsenS)
			TR2->OUTRICM := IIf(nX==1,nTotOutrE,nTotOutrS)
			TR2->IMPEXCL := IIf(nX==1,nTotExclE,nTotExclS)
		    MsUnlock()
		Endif
	Next
Endif
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Gerando os registros para preenchimento do Anexo 4 Operacoes Interestaduais ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
dbSelectArea("TR2")
dbSetOrder(2)
dbGoTop()
While !Eof()
    If Empty(TR2->UF) .Or. TR2->UF == "RS" .Or. !Substr(TR2->CFOP,1,1) $ "26"
       TR2->(dbSkip())
       Loop
    Endif
    nVLRetido := nVlOutras := nVlContNC := nVlBaseNC := nVlContCO := 0
    nVlBaseCO := nValCont  := nValBase  := nValOutr  := nValRetP  := nValRetO := 0
    cEstado := TR2->UF
	While TR2->UF == cEstado .And. !Eof()
		If Substr(TR2->CFOP,1,1) >= "5"
	        nVLRetido += TR2->ICMSRET
	        nVlOutras += TR2->OUTRICM
			If TR2->TIPO $ "DB"
			    SA2->(MsSeek(xFilial("SA2")+TR2->CLIEFOR+TR2->LOJA))
			    If Empty(SA2->A2_INSCR)
			        nVlContNC += TR2->VALCONT
			        nVlBaseNC += TR2->BASEICM
			    Else
			        nVlContCO += TR2->VALCONT
			        nVlBaseCO += TR2->BASEICM
			    Endif
			Else
			    SA1->(MsSeek(xFilial("SA1")+TR2->CLIEFOR+TR2->LOJA))
			    If Empty(SA1->A1_INSCR)
			        nVlContNC += TR2->VALCONT
			        nVlBaseNC += TR2->BASEICM
			    Else
			        nVlContCO += TR2->VALCONT
			        nVlBaseCO += TR2->BASEICM
			    Endif
			Endif
			nTgRetido += nVLRetido
			nTgOutras += nVlOutras
			nTgContNC += nVlContNC
			nTgBaseNC += nVlBaseNC
			nTgContCO += nVlContCO
			nTgBaseCO += nVlBaseCO
		Else
		    nValCont += TR2->VALCONT
		    nValBase += TR2->BASEICM
		    nValOutr += TR2->OUTRICM
		    If AllTrim(TR2->ESPECIE) == "NFCEE" //Energia E;etrica/Petroleo
		    	nValRetP += TR2->ICMSRET
		    	nTgRetP  += nValRetP
		    Else
		    	nValRetO += TR2->ICMSRET
		    	nTglRetO += nValRetO
		    Endif
			nTgCont   += nValCont
			nTgBase   += nValBase
			nTgOutr   += nValOutr
		Endif
		dbSkip()
		If TR2->UF <> cEstado
		   	For nX := 1 To 2
			   	If (nX == 1 .And. nValCont == 0) .Or. (nX == 2 .And. (nVlContNC == 0 .And. nVlContNC == 0))
			   	    Loop
			   	Endif
			   	nPos := Ascan(aListEst,{|x|x[1]==cEstado})
				If nPos > 0
				    dbSelectArea("TR3")
					Reclock("TR3",.T.)
					TR3->REF01 := IIf(nX==1,aListEst[nPos,2],aListEst[nPos,3])
					TR3->VAL01 := IIf(nX==1,nValCont,nVlContNC)
					TR3->REF02 := TR3->REF01+aListEst[nPos,4]
					TR3->VAL02 := IIf(nX==1,nValBase,nVlContCO)
					TR3->REF03 := TR3->REF02+aListEst[nPos,4]
					TR3->VAL03 := IIf(nX==1,nValOutr,nVlBaseNC)
					TR3->REF04 := TR3->REF03+aListEst[nPos,4]
					TR3->VAL04 := IIf(nX==1,nValRetP,nVlBaseCO)
					TR3->REF05 := TR3->REF04+aListEst[nPos,4]
					TR3->VAL05 := IIf(nX==1,nValRetO,nVlOutras)
					If nX == 2
						TR3->REF06 := TR3->REF05+aListEst[nPos,4]
						TR3->VAL06 := nVLRetido
					Endif
				    MsUnlock()
				Endif
			Next
		Endif
		dbSelectArea("TR2")
	Enddo
EndDo
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Gerando os totalizadores do Anexo 4  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
For nX := 1 To 2
   	If (nX == 1 .And. nTgCont == 0) .Or. (nX == 2 .And. (nTgContNC == 0 .And. nTgContNC == 0))
	   	Loop
   	Endif
    dbSelectArea("TR3")
	Reclock("TR3",.T.)
	TR3->REF01 := IIf(nX==1,627,776)
	TR3->VAL01 := IIf(nX==1,nTgCont,nTgContNC)
	TR3->REF02 := TR3->REF01+27
	TR3->VAL02 := IIf(nX==1,nTgBase,nTgContCO)
	TR3->REF03 := TR3->REF02+27
	TR3->VAL03 := IIf(nX==1,nTgOutr,nTgBaseNC)
	TR3->REF04 := TR3->REF03+27
	TR3->VAL04 := IIf(nX==1,nTgRetP,nTgBaseCO)
	TR3->REF05 := TR3->REF04+27
	TR3->VAL05 := IIf(nX==1,nTglRetO,nTgOutras)
	If nX == 2
		TR3->REF06 := TR3->REF05+27
		TR3->VAL06 := nTgRetido
	Endif
    MsUnlock()
Next
#IFDEF TOP
    dbSelectArea(cAliasSF3)
    dbCloseArea()
#ELSE
   	dbSelectArea("SF3")
	RetIndex("SF3")
	dbClearFilter()
	Ferase(cArqTrab+OrdBagExt())
#ENDIF

dbSelectArea("TR2")

Return({cArq,cInd,cArq1})


/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณGiaMsValidณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 30/04/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณValidacoes das regras de geracao dos dados da GIA para      ณฑฑ
ฑฑณ          ณImportacao                                                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณLogico                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณArray                                                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณMATA950() - GIAMS.INI                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GiaMsValid(aMsg)

Local lRet  := .T.
Local cEnde := Alltrim(GetMv("MV_GIAENDE",,""))
Local cBair := Alltrim(GetMv("MV_GIABAIR",,""))
Local cMuni := Alltrim(GetMv("MV_GIAMUNI",,""))
Local aPar  := GiaMsContr()		//Numero de Elementos

Do Case
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณValida se os parametros MV_GIAENDE, MV_GIABAIR e MV_GIAMUNI, foram preenchidosณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (Empty(cEnde) .Or. Empty(cBair) .Or. Empty(cMuni))
		lRet := .F.
		MsgAlert(aMsg[2],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Valida numero de elementos dos parametros MV_GIAENDE, MV_GIABAIR e MV_GIAMUNI ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (Len(aPar[1])<>Len(aPar[2])) .Or. (Len(aPar[1])<>Len(aPar[3]))
		lRet := .F.
		MsgAlert(aMsg[6],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณValida se a GIA e Anual e Mes Inicial <> de Janeiro e Mes Final <> de Dezembro e Se foi selecionado uma Justificativaณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (_aTotal[07]==2 .And. (Month(_aTotal[01])<>1 .Or. Month(_aTotal[02])<>12) .And. _aTotal[17]==4)
		lRet := .F.
		MsgAlert(aMsg[3],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณInformar o Mes e o Ano de Mudanca, quando a forma de Entrega da GIA for anual, mas o periodo de referencia for diferente de Janeiro a Dezembro, e Justificativa para este periodo diferenciado for Mudanca na Forma de Entregaณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (_aTotal[07]==2 .And. (Month(_aTotal[01])<>1 .Or. Month(_aTotal[02])<>12) .And. _aTotal[17]==3 .And. (Empty(_aTotal[18]) .Or. Empty(_aTotal[19])))
		lRet := .F.
		MsgAlert(aMsg[4],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณSe o Tipo da GIA for Retificadora, Informar o Tipo da GIA Substituta, Substituida e Forma de Entregaณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (_aTotal[13]==3 .And. (_aTotal[14]==4 .Or. _aTotal[15]==5 .Or. _aTotal[16]==3))
		lRet := .F.
		MsgAlert(aMsg[5],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณEstabelecimento Centralizador de ICMSณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (_aTotal[09]==1 .And. Empty(_aTotal[10]))
		lRet := .F.
		MsgAlert(aMsg[8],aMsg[1])

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณGeracao de Empregoณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Case (Empty(_aTotal[21]) .Or. Empty(_aTotal[22]) .Or. Empty(_aTotal[23]))
		lRet := .F.
		MsgAlert(aMsg[7],aMsg[1])
EndCase

Return(lRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณGiaMsContrณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 22/04/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณLay-out   ณContribuinte                                                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณGera os Codigos do Logradouro, Bairro e Municipio           ณฑฑ
ฑฑณ          ณpor Contribuinte a partir dos parametros MV_GIAENDE,        ณฑฑ
ฑฑณ          ณMV_GIABAIR e MV_GIAMUNI                                     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray                                                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณMATA950() - GIAMS.INI                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GiaMsContr()

Local cEnde := Alltrim(GetMv("MV_GIAENDE",,""))
Local cBair := Alltrim(GetMv("MV_GIABAIR",,""))
Local cMuni := Alltrim(GetMv("MV_GIAMUNI",,""))
Local aEnde := {}
Local aBair := {}
Local aMuni := {}
Local nEnde := 0
Local nBair := 0
Local nMuni := 0

If _aTotal[99]	//Verifica se o processo foi cancelado, ou se alguma das regras nao foi atendida
	AADD(aEnde,Upper(Left(cEnde,5)))
	AADD(aBair,Upper(Left(cBair,5)))
	AADD(aMuni,Left(cMuni,8))
	While	At("/",Subs(cEnde,nEnde+1)) > 0 .Or. ;
			At("/",Subs(cBair,nBair+1)) > 0 .Or. ;
			At("/",Subs(cMuni,nMuni+1)) > 0
	    If At("/",Subs(cEnde,nEnde+1)) > 0
		    nEnde += At("/",Subs(cEnde,nEnde+1))
			AADD(aEnde,Upper(Subs(cEnde,nEnde+1,5)))
		Endif
	    If At("/",Subs(cBair,nBair+1)) > 0
		    nBair += At("/",Subs(cBair,nBair+1))
			AADD(aBair,Upper(Subs(cBair,nBair+1,5)))
		Endif
	    If At("/",Subs(cMuni,nMuni+1)) > 0
		    nMuni += At("/",Subs(cMuni,nMuni+1))
			AADD(aMuni,Subs(cMuni,nMuni+1,8))
		Endif
	Enddo
Endif

Return({aEnde,aBair,aMuni})

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณGiaMsR02  ณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 21/05/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณLay-out   ณRegistro 02 - Apuracao de ICMS                              ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณRetorna os valores dos campos Imposto a Recolher, Saldo Cre-ณฑฑ
ฑฑณ          ณdor a Transportar e Saldo Credor a Transferir               ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNumerico                                                    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNumerico 1,2 ou 3                                           ณฑฑ
ฑฑณ          ณ1-Imposto a Recolher                                        ณฑฑ
ฑฑณ          ณ2-Saldo Credor a Transportar                                ณฑฑ
ฑฑณ          ณ3-Saldo Credor a Transferir                                 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณMATA950() - GIAMS.INI                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GiaMsR02(nCpo)

// _aTotal[09] = Possui empresa centralizadora de ICMS
// _aTotal[10] = Inscricao Estadual da empresa centralizadora
// _aTotal[60] = Saldo Devedor
// _aTotal[61] = Saldo Credor
// _aTotal[62] = Deducoes
// _aTotal[63] = Imposto a Recolher
// _aTotal[64] = Saldo Credor a Transportar

Local nRet := 0

Do Case
	Case nCpo == 1	//Imposto a Recolher
		If (_aTotal[60]-_aTotal[62])>0
			nRet := (_aTotal[60]-_aTotal[62])
		Endif

	Case nCpo == 2	//Saldo Credor a Transportar
		If (_aTotal[60]>0 .And. (_aTotal[62]>_aTotal[60]))
			nRet := (_aTotal[62]-_aTotal[60])
		ElseIf (_aTotal[61]>0)
			nRet := (_aTotal[61]+_aTotal[62])
		ElseIf ((_aTotal[60]==0 .And. _aTotal[61]==0) .And. _aTotal[62]>0)
			nRet := _aTotal[62]
		Endif

	Case nCpo == 3	//Saldo Credor a Transferir
		If (_aTotal[09]==1 .And. _aTotal[10]<>aRetDig(SM0->M0_INSC,.F.))
			If _aTotal[63]>0
				nRet := -(_aTotal[63])
				_aTotal[63] := 0
			Else
				nRet := _aTotal[64]
				_aTotal[64] := 0
			Endif
			If (_aTotal[60]==0 .And. _aTotal[61]==0 .And. _aTotal[62]>0)
				nRet := _aTotal[62]
				_aTotal[64] := 0
			Endif
		Endif
EndCase

Return(nRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณGiaMsR15  ณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 16/04/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณLay-out   ณRegistro 15 - ICMS Cobrado por Substituicao Tributaria nas  ณฑฑ
ฑฑณ          ณOperacoes Interestaduais                                    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณTotalizar por Entrada/Saida e por UF, somente as CFOP's     ณฑฑ
ฑฑณ          ณreferentes a Substituicao Tributaria fora do Estado, nao    ณฑฑ
ฑฑณ          ณsepara valores de Petroleo e Energia                        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray                                                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณMATA950() - GIAMS.INI                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GiaMsR15()

Local aArea := GetArea()
Local aRet  := {}
Local nPos  := 0
Local cCFOP := IIf(_aTotal[77]>=2003,Alltrim(GetMv("MV_GIA15AN",,"")),Alltrim(GetMv("MV_GIA15AA",,"")))

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ CFOP's de Entrada/Saida Substituicao Tributaria - Fora do Estado ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
dbSelectArea("T01")
dbGoTop()
While !Eof() .And. _aTotal[99]
	If Alltrim(T01->CFOP)$cCFOP .And. T01->UF<>"MS"
		If Left(Alltrim(T01->CFOP),1)$"2"	// Entrada
			nPos := Ascan(aRet,{|x| x[1]=="E" .And. x[2]==T01->UF})
			If nPos > 0
				aRet[nPos][3] += T01->VALICM
			Else
				AADD(aRet,{"E",T01->UF,T01->VALICM})
			Endif
		Else
			If Left(Alltrim(T01->CFOP),1)$"6"	// Saida
				nPos := Ascan(aRet,{|x| x[1]=="S" .And. x[2]==T01->UF})
				If nPos > 0
					aRet[nPos][3] += T01->VALICM
				Else
					AADD(aRet,{"S",T01->UF,T01->VALICM})
				Endif
			Endif
		Endif
	Endif
	dbSkip()
Enddo
RestArea(aArea)

Return(aRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณGiaMsR22  ณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 28/04/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณLay-out   ณRegistro 22 - Nota Fiscal de Saida                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณRetorna Inscricao Estadual ou CNPJ, dependendo do Tipo de   ณฑฑ
ฑฑณ          ณPessoa campo A1_TPESSOA ou A2_TPESSOA                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray                                                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณMATA950() - GIAMS.INI                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GiaMsR22()

Local cTipo := ""
Local cIE	:= ""
Local cCGC  := ""
Local aArea := GetArea()

If SF3->F3_TIPO$"DB"	//Devolucao ou Beneficiamento
	If SA2->(MsSeek(xFilial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		cTipo := SA2->A2_TPESSOA
		If cTipo == "CI"	//Comercio/Industria
			If Left(Alltrim(SF3->F3_CFO),1)=="5"		//Dentro do Estado
				cIE := aRetDig(SA2->A2_INSCR,.F.)
			ElseIf Left(Alltrim(SF3->F3_CFO),1)=="6"	//Fora do Estado
				cCGC := aRetDig(SA2->A2_CGC,.F.)
			Endif
		ElseIf cTipo == "PS"	//Prestacao de Servico
			cCGC := aRetDig(SA2->A2_CGC,.F.)
		Endif
	Endif
Else
	If SA1->(MsSeek(xFilial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))
		cTipo := SA1->A1_TPESSOA
		If cTipo == "CI"	//Comercio/Industria
			If Left(Alltrim(SF3->F3_CFO),1)=="5"		//Dentro do Estado
				cIE := aRetDig(SA1->A1_INSCR,.F.)
			ElseIf Left(Alltrim(SF3->F3_CFO),1)=="6"	//Fora do Estado
				cCGC := aRetDig(SA1->A1_CGC,.F.)
			Endif
		ElseIf cTipo == "PS"	//Prestacao de Servico
			cCGC := aRetDig(SA1->A1_CGC,.F.)
		Endif
	Endif
Endif
RestArea(aArea)

Return({cTipo,cIE,cCGC})

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณDAPIMG    ณ Autor ณEdstron Everson Correiaณ Data ณ28.05.03  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณAjuste do SX1 para a Inst. Normat. DAPI-MG                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณSigaFis                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/

Function DadosDAPI(dDataIni,dDataFim, aFilsCons)

Local cApuICMSAnt 	:= AllTrim(MV_PAR09)
Local nLinha87		:=	0
Local nLinha78      :=	0 
Local nLinha81      :=	0 
Local aCampos		:=	{}
Local aColunas		:=	{}
Local cTipo			:=	"10"
Local cLinha		:=	""
Local cColuna		:=	""
Local cColunas		:=	""
Local cArq010		:=	""
Local cArq020		:=	""
Local cArq021		:=	""
Local nItem			:=	0
Local nValCont		:=	0
Local nVal96		:=	0
Local nBaseIcm		:=	0
Local nValIcm		:=	0
Local nIsenIcm		:=	0
Local nOutrIcm		:=	0
Local lDAPIMGD1		:= ExistBlock("DAPIMGD1")	//SD1
Local lDAPIMGD2		:= ExistBlock("DAPIMGD2")	//SD2
Local cMVDAPIC04	:= SuperGetMv("MV_DAPIC04")
Local aLinha		:= {}
Local nI			:= 0
Local nX			:= 0
Local n080			:= 0
Local n099			:= 0
Local n101			:= 0
Local n102			:= 0
Local n106     		:= 0
Local n110     		:= 0
Local nIcmObs  		:= 0
Local aCredDeb		:= {}
Local aApurST		:= {}
Local aReg20		:= {}
Local aReg21		:= {}
Local aReg22		:= {}
Local aReg23		:= {}
Local aReg24		:= {}
Local aReg29		:= {}
Local nTotDeb		:= 0
Local nTotCred		:= 0
Local nTot			:= 0
Local nLin91		:= 0
Local nLin96		:= 0
Local nLin98		:= 0
Local nCred			:= 0
Local nDifAliq		:= 0
Local n103			:= 0
Local nCredPre		:= 0
Local nCont			:= 0
Local cFil			:= ""
Local aAux			:= {}
Local nRec			:= 0
Local nRecAnt		:= 0
Local lConsolida	:= .F.
Local cFilAnterior	:= ""
Local cDVNome		:= ""
Local cDVLoj		:= ""
Local cObs			:= ""
Local cApICMSASt    := ""  
Local cAliasSF3		:= GetNextAlias()
Local cAliasF0I   	:= ""
Local nIndex		:= 0
Local nAliqIcms		:= 0
Local nTamFTIt		:= TamSX3("FT_ITEM")[01]
Local nMes			:= 0
Local nAno			:= 0
Local nValIPI 		:= 0
Local nIPITrib 		:= 0
Local nIPIObs 		:= 0
Local nTotEstCrd 	:= 0
Local nVLincMG   	:= 0
Local lFTDS43080 	:= cPaisLoc == "BRA"
Local lFTPR43080 	:= cPaisLoc == "BRA"
Local cCampos		:= ""
Local lEic 	 		:= SuperGetMv("MV_EASY",.F.,"N") == "S"
Local nVlDifal 		:= 0
Local cUF		 	:= SuperGetMv("MV_ESTADO",,"")
Local nVlCrdDif		:= 0
Local nValCol131	:= 0
Local lEnerElet		:= .F.

#IFDEF TOP
	Local cAliasSD2	:= GetNextAlias()
	Local cAliasSD1	:= GetNextAlias()
#ELSE
	Local cIndSd1		:= ""
	Local cChave		:= ""
	Local cFiltro		:= ""
	Local cAliasSD2	:= "SD2"
	Local cAliasSD1	:= "SD1"
	Local cIndSd2		:= ""
	Local nRetInd		:= 0
#ENDIF

Default aFilsCons := {}

aApurST    :=FisApur("ST",val(Substr(DTOS(dDataFim),1,4)),val(Substr(DTOS(dDataFim),5,2)),2,0,"*",.F.,{},1,.F.,"")

//Monta o nome da apuracao do mes anterior
If Upper(cApuICMSAnt)=="AUTO"
	nMes := Month(dDataIni)-1
	nAno := Year(dDataIni)
	nAno := IIf(nMes==0, nAno-1, nAno)
	nMes := IIf(nMes==0, 12, nMes)
	cApuICMSAnt := "A"+Chr(nMes+64)+Substr(StrZero(nAno,4),3,2)+cEmpAnt+cFilAnt+".ic0"
	cApICMSASt := "A"+Chr(nMes+64)+Substr(StrZero(nAno,4),3,2)+cEmpAnt+cFilAnt+".st0"

	nLinha78 :=	LoadAnt(AllTrim(cApICMSASt),"016") //Pega o Saldo Credor ( 012-005 ) 
Endif

//Pega a linha 014 da apuracao do mes anterior
nLinha87 :=	LoadAnt(AllTrim(cApuICMSAnt),"014")

If Len(aApurST) > 0 .And. (aScan(aApurST, {|a| a[1]=="016"})<>0)
   nLinha81 := aApurST[aScan (aApurST, {|a| a[1]=="016"})][3]  //Pega o Saldo Credor ( 012-005 ) 
EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 10 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aCampos,{"TIPO"			,"C"	,002,0})
AADD(aCampos,{"LINHA"		,"C"	,003,0})
AADD(aCampos,{"COLUNA"		,"C"	,002,0})
AADD(aCampos,{"VALOR"		,"N"	,021,6}) //DSERFIS1-15789
cArq010	:=	CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cArq010,"R10",.T.,.F.)
IndRegua("R10",cArq010,"TIPO+LINHA+COLUNA",,,"Gerando Arquivo Tipo Linha 10")
DbSelectArea("R10")
dbSetOrder(1)
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 20 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg20,{"UF"			,"C",002,						0})
AADD(aReg20,{"INSC"		,"C",015,						0})
AADD(aReg20,{"NF"			,"C",TamSx3("F3_NFISCAL")	[1],0})
AADD(aReg20,{"SERIE"		,"C",TamSx3("F3_SERIE")		[1],0})
AADD(aReg20,{"SDOC"		,"C",003,						0})
AADD(aReg20,{"DTNF"		,"D",008,						0})
AADD(aReg20,{"VALOR"		,"N",015,						2})
AADD(aReg20,{"LOJA"		,"C",TamSx3("F3_LOJA")		[1],0})
cArq020	:=	CriaTrab(aReg20,.T.)
dbUseArea(.T.,__LocalDriver,cArq020,"R20",.T.,.F.)
IndRegua("R20",cArq020,"NF+SERIE+LOJA",,,"Gerando Arquivo Tipo Linha 20")
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 21 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg21,{"UF"		,"C",002,						0})
AADD(aReg21,{"INSC"	,"C",015,						0})
AADD(aReg21,{"NF"		,"C",TamSx3("F3_NFISCAL")	[1],0})
AADD(aReg21,{"SERIE"	,"C",TamSx3("F3_SERIE")		[1],0})
AADD(aReg21,{"SDOC"	,"C",003,						0})
AADD(aReg21,{"DTNF"	,"D",008,						0})
AADD(aReg21,{"VALOR"	,"N",015,						2})
AADD(aReg21,{"LOJA"	,"C",TamSx3("F3_LOJA")		[1],0})
cArq021	:=	CriaTrab(aReg21,.T.)
dbUseArea(.T.,__LocalDriver,cArq021,"R21",.T.,.F.)
IndRegua("R21",cArq021,"NF+SERIE+LOJA",,,"Gerando Arquivo Tipo Linha 21")
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 22 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg22,{"INSC"		,"C",015,						0})
AADD(aReg22,{"NF"			,"C",TamSx3("F3_NFISCAL")	[1],0})
AADD(aReg22,{"SERIE"		,"C",TamSx3("F3_SERIE")		[1],0})
AADD(aReg22,{"SDOC"		,"C",003,						0})
AADD(aReg22,{"DTNF"		,"D",008,						0})
AADD(aReg22,{"VALOR"		,"N",015,						2})
AADD(aReg22,{"LOJA"		,"C",TamSx3("F3_LOJA")		[1],0})
AADD(aReg22,{"JUST"		,"C",060,						0})
AADD(aReg22,{"MOTIVO"	,"C",001,						0})
cArq022	:=	CriaTrab(aReg22,.T.)
dbUseArea(.T.,__LocalDriver,cArq022,"R22",.T.,.F.)
IndRegua("R22",cArq022,"NF+SERIE+LOJA",,,"Gerando Arquivo Tipo Linha 22")
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 23 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg23,{"SDOCUL"		,"N",015,2}) //Saldo de incentivo เ cultura do perํodo anterior
AADD(aReg23,{"INCCUL"		,"N",015,2}) //Incentivo เ cultura no perํodo
AADD(aReg23,{"DEDCULPER"		,"N",015,2}) //Total dedu็ใo incentivo เ cultura no perํodo
AADD(aReg23,{"LIMDEDCULP"	,"N",015,2}) //Valor limite p/ dedu็ใo incentivo เ cultura no perํodo
AADD(aReg23,{"SDOCRECULS"	,"N",015,2}) //Saldo credor dedu็ใo incentivo เ cultura perํodo Seguinte
AADD(aReg23,{"COMCREEMPP"	,"N",015,2}) //Compensa็ใo de cr้dito entre estabelecimentos da mesma empresa no perํodo
AADD(aReg23,{"TOTDEDPER"		,"N",015,2}) //Total de dedu็๕es no perํodo
AADD(aReg23,{"ULTCRERECT"	,"N",015,2}) //Utiliza็ใo de Cr้ditos Recebidos em Transfer๊ncia
AADD(aReg23,{"ALQDEDINCP"	,"N",015,2}) //Alํquota de dedu็ใo por incentivo เ cultura no perํodo
AADD(aReg23,{"VLRESTCUL"		,"N",015,2}) //Cultura Estorno
AADD(aReg23,{"SDOESPANT"		,"N",015,2}) //Saldo de incentivo ao esporte do perํodo anterior
AADD(aReg23,{"INCESPPER"		,"N",015,2}) //Incentivo ao esporte no perํodo
AADD(aReg23,{"DEDESPPER"		,"N",015,2}) //Total dedu็ใo incentivo ao esporte no perํodo
AADD(aReg23,{"LIMDEDESPP"	,"N",015,2}) //Valor limite p/ dedu็ใo incentivo ao esporte no perํodo
AADD(aReg23,{"SDOCREESPS"	,"N",015,2}) //Saldo credor dedu็ใo incentivo ao esporte perํodo seguinte
AADD(aReg23,{"ALQDEDESPP"	,"N",015,2}) //Alํquota de dedu็ใo por incentivo ao esporte no perํodo
AADD(aReg23,{"VLRESTESP"		,"N",015,2}) //Esporte Estorno
cArq023	:=	CriaTrab(aReg23,.T.)
dbUseArea(.T.,__LocalDriver,cArq023,"R23",.T.,.F.)
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 24 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg24,{"INSC"		,"C",015						,0})
AADD(aReg24,{"NF"			,"C",TamSx3("F3_NFISCAL")	[1],0})
AADD(aReg24,{"SERIE"		,"C",TamSx3("F3_SERIE")		[1],0})
AADD(aReg24,{"SDOC"		,"C",003						,0})
AADD(aReg24,{"DTNF"		,"D",008						,0})
AADD(aReg24,{"DTVISTO"	,"D",008						,0})
AADD(aReg24,{"VALOR"		,"N",015						,2})
cArq024	:=	CriaTrab(aReg24,.T.)
dbUseArea(.T.,__LocalDriver,cArq024,"R24",.T.,.F.)
IndRegua("R24",cArq024,"INSC+NF+SERIE",,,"Gerando Arquivo Tipo Linha 24")
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณArquivo do Registro tipo 29 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aReg29,{"INSC"		,"C",013,						0})
AADD(aReg29,{"MOTIVO"	,"C",002,						0})
AADD(aReg29,{"AUTO"		,"C",013,						0})
AADD(aReg29,{"VALOR"		,"N",015,						2})
AADD(aReg29,{"NF"			,"C",TamSx3("F3_NFISCAL")	[1],0})
AADD(aReg29,{"SERIE"		,"C",TamSx3("F3_SERIE")		[1],0})
AADD(aReg29,{"SDOC"		,"C",003,						0})
AADD(aReg29,{"DTNF"		,"D",008,						0})
cArq029	:=	CriaTrab(aReg29,.T.)
dbUseArea(.T.,__LocalDriver,cArq029,"R29",.T.,.F.)
IndRegua("R29",cArq029,"MOTIVO+NF+SERIE",,,"Gerando Arquivo Tipo Linha 29")
cArq0292	:= CriaTrab(aReg29,.T.)
IndRegua("R29",cArq0292,"MOTIVO",,,"Gerando Arquivo Tipo Linha 29")
DbClearIndex()
DbSetIndex(cArq029+OrdBagExt())
DbSetIndex(cArq0292+OrdBagExt())
DbSetOrder(1)

lConsolida := Iif ( Len(aFilsCons) > 0, .T., .F. )

If lConsolida   // Consolidar filiais com mesmo CNPJ  e IE
	//
	aAux := {}
	aEval( aFilsCons, { |x| Iif( x[1], Aadd(aAux, x ), .T. ) }  )
	aFilsCons := aAux

	// Verifica as empresas com o mesmo CNPJ e IE
	DbSelectArea("SM0")
	nRecAnt := SM0->(Recno())

	If SM0->( MsSeek( cEmpAnt + aFilsCons[1][2] ))
		cCnpj 	:= SubStr(SM0->M0_CGC,1,8 )
		cIE		:= SM0->M0_INSC
	EndIf

	For nCont := 1 To Len(aFilsCons)
		SM0->( DbGoTop() )
		If SM0->( MsSeek( cEmpAnt + aFilsCons[nCont][2] ))
			If SubStr(SM0->M0_CGC,1,8) != cCnpj
				aFilsCons := {}
				Aviso("DAPI - MG","As Filiais selecionadas nใo possuem mesma raiz do CNPJ." + CHR(13)+CHR(10) + "Somente a Filial corrente serแ processada!",{"OK"} )
				lConsolida := .F.
				Exit
			EndIf
		EndIf
	Next nCont

	SM0->( DbGoTo(nRecAnt))
EndIf

If lConsolida
	nCont := 1
	cFilAnterior := cFilAnt
	cFilAnt := aFilsCons[nCont][2]
EndIf

If MV_PAR16 = 1 .AND. !Empty( MV_PAR17 )
	nValCol131 := DescPontual('IC', '*', '3', '1', dDataIni, dDataFim, MV_PAR17)
EndIf

dbSelectArea("SFT")
SFT->(dbSetOrder(1))

While .T.

	dbSelectArea("SD1")
	SD1->(dbsetorder(1))

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCampos que serao adicionados a query somente se existirem na baseณ
	//ณControle de Chave unica.											ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	If SerieNfId("SD1",3,"D1_SERIE") == "D1_SDOC"
		cCampos := "% " + ", SD1.D1_SERIE, SD1.D1_SDOC" + " %"
	Else
		cCampos := "% " + ",SD1.D1_SERIE" + " %"
	Endif

	#IFDEF TOP
		If lDAPIMGD1
			ExecBlock("DAPIMGD1",.F.,.F.,{cAliasSD1,dDataIni,dDataFim})
		Else
			BeginSql Alias cAliasSd1
				COLUMN D1_DTDIGIT AS DATE
				COLUMN D1_EMISSAO AS DATE
				SELECT
					SD1.D1_FILIAL,SD1.D1_DOC,SD1.D1_FORNECE,SD1.D1_LOJA,SD1.D1_COD,SD1.D1_ITEM,
					SD1.D1_DTDIGIT,SD1.D1_TES,SD1.D1_TOTAL,SD1.D1_VALIPI,SD1.D1_ICMSRET,SD1.D1_VALFRE,SD1.D1_DESPESA,
					SD1.D1_VALDESC,SD1.D1_BASEICM,SD1.D1_VALICM,SD1.D1_CF,SD1.D1_BRICMS,SD1.D1_CODISS,SD1.D1_EMISSAO,SD1.D1_TIPO,
					SD1.D1_CLASFIS,SD1.D1_ESTCRED,SD1.D1_VALANTI
					%Exp:cCampos%
				FROM
				%table:SD1% SD1
				JOIN %table:SFT% SFT ON SFT.FT_FILIAL = %xFilial:SFT% AND SFT.FT_TIPOMOV = 'E' AND SD1.D1_SERIE = SFT.FT_SERIE AND SD1.D1_DOC = SFT.FT_NFISCAL AND SD1.D1_FORNECE = SFT.FT_CLIEFOR AND
				SD1.D1_LOJA = SFT.FT_LOJA AND SFT.FT_ITEM = SD1.D1_ITEM AND SFT.FT_PRODUTO = SD1.D1_COD AND SFT.D_E_L_E_T_ = ' ' AND SFT.FT_TIPO <> 'S'
				WHERE
				SD1.%NotDel% AND
				SD1.D1_FILIAL=%xFilial:SD1% AND
				SD1.D1_DTDIGIT>=%Exp:DTOS(dDataIni)% AND
				SD1.D1_DTDIGIT<=%Exp:DTOS(dDataFim)%
				ORDER BY
				1,2,3,4,5,6,7
			EndSql
		Endif
	#ELSE
		If lDAPIMGD1
			ExecBlock("DAPIMGD1",.F.,.F.,{cAliasSD1,dDataIni,dDataFim})
		Else
			cIndSd1	:=	CriaTrab (NIL, .F.)
			cChave	:=	IndexKey()
			cFiltro	:=	"D1_FILIAL=='"+xFilial("SD1")+"'"
			cFiltro	+=	" .And. DTOS(D1_DTDIGIT)>='"+DTOS(dDataIni)+"' .AND. DTOS(D1_DTDIGIT)<='"+DTOS(dDataFim)+"' "
			cFiltro	+= " .And. (Empty(D1_CODISS) .OR. (Empty(D1_CODISS) .AND. D1_TIPO <> 'S'))"
			IndRegua (cAliasSd1, cIndSd1, cChave,, cFiltro)
			nRetInd := RetIndex (cAliasSd1)
			DbSetIndex (cIndSd1+OrdBagExt ())
			DbSetOrder (nRetInd+1)
			DbGoTop ()
		Endif
	#ENDIF

	(cAliasSd1)->(DbGoTop ())
	While !(cAliasSd1)->(Eof ())

	      nValIPI := 0
	      If SF4->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))

				cClasFis := AllTrim(SubStr((cAliasSD1)->D1_CLASFIS, 2, 2))
				cLinha   := ""
	         Do Case
	            Case AllTrim((cAliasSD1)->D1_CF)$"1101/1102/1111/1113/1116/1117/1118/1120/1121/1122/1124/1125/1126/1128/1131/1132/1135/1159/1401/1403/1501/1651/1652" .OR.;
	            	 (AllTrim((cAliasSD1)->D1_CF)$"1653" .And. (SF4->F4_CREDICM<>"N" .Or. SF4->F4_CONSUMO<>"S")) //.Or. (AllTrim((cAliasSD1)->D1_CF)$"1949" .And. ((cAliasSD1)->D1_TIPO$"I"))
		 	         cLinha :="016"
	      	    Case AllTrim((cAliasSD1)->D1_CF)$"1151/1152/1153/1154/1408/1409/1658/1659"
	         	     cLinha :="017"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1201/1202/1203/1204/1205/1206/1207/1208/1209/1213/1214/1410/1411/1503/1504/1603/1660/1661/1662"
	                 cLinha :="018"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1251/1252/1253/1254/1255/1256/1257"
	                 cLinha :="019"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1301/1302/1303/1304/1305/1306"
	                 cLinha :="020"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1351/1352/1353/1354/1355/1356/1360/1931/1932"
	                 cLinha :="021"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1406/1551/1552/1553/1554/1555/1604"
	                 cLinha :="022"
	            Case AllTrim((cAliasSD1)->D1_CF)$"1407/1556/1557" .Or.;
		            (AllTrim((cAliasSD1)->D1_CF)$"1653" .And. SF4->F4_CREDICM=="N" .And. SF4->F4_CONSUMO=="S")
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณIncluir neste campo, tamb้m, os valores das opera็๕es lan็adas no livro Registro de Entradas com o ณ
					//ณ  c๓digo 1.653, quando a aquisi็ใo da mercadoria for destinada a consumidor ou usuแrio final para  ณ
					//ณ  uso e consumo sem direito a aproveitamento do cr้dito.                                           ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	                 cLinha :="023"
  	            Case AllTrim((cAliasSD1)->D1_CF)$"1414/1415/1451/1452/1901/1902/1903/1904/1905/1906/1907/1908/1909/1910/1911/1912/1913/1914/1915/1916/1917/1918/1919/1920/1921/1922/1923/1924/1925/1926/1933/1663/1664/1949/1934" .And. SF4->F4_LFICM <> "N"
	                 cLinha :="024"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2101/2102/2111/2113/2116/2117/2118/2120/2121/2122/2124/2125/2126/2128/2131/2132/2135/2159/2401/2403/2501/2651/2652" .Or.;
	            	 (AllTrim((cAliasSD1)->D1_CF)$"2653" .And. (SF4->F4_CREDICM<>"N" .Or. SF4->F4_CONSUMO<>"S")) //.Or. (AllTrim((cAliasSD1)->D1_CF)$"2949" .And. ((cAliasSD1)->D1_TIPO$"I"))
	    	 	     cLinha :="026"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2151/2152/2153/2154/2408/2409/2658/2659"
	         	     cLinha :="027"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2201/2202/2203/2204/2205/2206/2207/2208/2209/2213/2214/2410/2411/2503/2504/2660/2661/2662"
	                 cLinha :="028"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2251/2252/2253/2254/2255/2256/2257"
	                 cLinha :="029"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2301/2302/2303/2304/2305/2306"
	                 cLinha :="030"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2351/2352/2353/2354/2355/2356/2931/2932"
	                 cLinha :="031"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2406/2551/2552/2553/2554/2555"
	                 cLinha :="032"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2407/2556/2557" .Or.;
	            	 (AllTrim((cAliasSD1)->D1_CF)$"2653" .And. (SF4->F4_CREDICM=="N" .Or. SF4->F4_CONSUMO=="S"))
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณIncluir neste campo, tamb้m, os valores das opera็๕es lan็adas no livro Registro de Entradas com o ณ
					//ณ  c๓digo 1.653, quando a aquisi็ใo da mercadoria for destinada a consumidor ou usuแrio final para  ณ
					//ณ  uso e consumo sem direito a aproveitamento do cr้dito.                                           ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	                 cLinha :="033"
	            Case AllTrim((cAliasSD1)->D1_CF)$"2414/2415/2505/2901/2902/2903/2904/2905/2906/2907/2908/2909/2910/2911/2912/2913/2914/2915/2916/2917/2918/2919/2920/2921/2922/2923/2924/2925/2663/2664/2949/2933"
	                 cLinha :="034"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3101/3102/3126/3128/3127/3651/3652" .Or.;
	            	 (AllTrim((cAliasSD1)->D1_CF)$"3653" .And. (SF4->F4_CREDICM<>"N" .Or. SF4->F4_CONSUMO<>"S"))
	                 cLinha :="036"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3201/3202/3205/3206/3207/3211/3503"
	                 cLinha :="037"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3251/3301/3351/3352/3353/3354/3355/3356"
	                 cLinha :="038"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3551/3553"
	                 cLinha :="039"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3556" .Or.;
	            	 (AllTrim((cAliasSD1)->D1_CF)$"3653" .And. (SF4->F4_CREDICM=="N" .Or. SF4->F4_CONSUMO=="S"))
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณIncluir neste campo, tamb้m, os valores das opera็๕es lan็adas no livro Registro de Entradas com o ณ
					//ณ  c๓digo 1.653, quando a aquisi็ใo da mercadoria for destinada a consumidor ou usuแrio final para  ณ
					//ณ  uso e consumo sem direito a aproveitamento do cr้dito.                                           ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	                 cLinha :="040"
	            Case AllTrim((cAliasSD1)->D1_CF)$"3930/3949"
	                 cLinha :="041"
				Case AllTrim((cAliasSD1)->D1_CF)$"1601"
	                 cLinha :="066"
	            Otherwise
	            	(cAliasSD1)->(DbSkip())
	            	Loop
	         EndCase

	   		 SF4->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))

			 //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			 //ณQuando nao necessitar de coluna, processo somente a linha de um array e gravo no TRBณ
	 		 //ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If SF4->F4_OBSSOL=="1" .And. AllTrim((cAliasSD1)->D1_CF) != "1603"
				aLinha		:=	{}
			 	//Devolu็ใo opera็ใo interna
			 	If (cAliasSD1)->D1_TIPO=="D" .And. Left((cAliasSD1)->D1_CF,1)=="1"
		 		 aAdd (aLinha, {"10", "080", "00", (cAliasSD1)->D1_ICMSRET})
			 	Endif
				aAdd (aLinha, {"10", "085", "00", (cAliasSD1)->D1_BRICMS})
	 			aAdd (aLinha, {"10", "086", "00", (cAliasSD1)->D1_ICMSRET})
	 			aAdd (aLinha, {"10", "101", "00", (cAliasSD1)->D1_ICMSRET})
				GrvLinR10(aLinha)
			EndIf

			 //No campo 80: Devolu็ใo/Outros cr้ditos, onde serแ informado o valor do ST a ser restituํdo;
            //Campo 81 foi adicionado por que validador DAPI Versใo 09.00 solicita quando existir valor no 080

			If AllTrim((cAliasSD1)->D1_CF) == "1603"
				aLinha		:=	{}
				aAdd (aLinha, {"10", "080", "00", (cAliasSD1)->D1_TOTAL})
				GrvLinR10(aLinha)
			EndIf

			lEnerElet	:=  .F.
			If SFT->(MsSeek(xFilial("SFT")+"E"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+Padr((cAliasSD1)->D1_ITEM,nTamFTIt)+(cAliasSD1)->D1_COD))
				nValCont	:=	SFT->FT_VALCONT
				nBaseIcm	:=	SFT->FT_BASEICM
				nAliqIcms	:= 	SFT->FT_ALIQICM
				nValIcm		:=	SFT->FT_VALICM
				nIsenIcm	:=	SFT->FT_ISENICM
				lEnerElet	:=  (AModNot(SFT->FT_ESPECIE) == "06") //"NFCEE"

				If lFTDS43080 .And. lFTPR43080
					If SFT->FT_DS43080 <> 0 .AND. SFT->FT_PR43080 <> 0
						nIsenIcm	+=	SFT->FT_VALCONT - SFT->FT_BASEICM
					Endif
				Endif
				If cPaisLoc == "BRA" .And. SFT->FT_VALANTI <> 0
					nOutrIcm	:=	SFT->FT_OUTRICM
				Else
					nOutrIcm	:=	SFT->FT_OUTRICM  + SFT->FT_ICMSRET
				EndIf
				nIcmObs	:=	SFT->FT_OBSICM
				If cPaisLoc == "BRA"
					nVLincMG	:=	SFT->FT_VLINCMG
				EndIf
				//Linha 16  e 18  - A coluna 1 (Valores Contแbeis) deve ser igual a soma das colunas 2 + (5 a 11)
				If cLinha$"010/016/018/024" .And. SFT->FT_CREDST$"1/4"
					nOutrIcm	+=	SFT->FT_ICMSRET - SFT->FT_ICMSRET
				EndIf
				nIPIObs := SFT->FT_IPIOBS
				nIPITrib := SFT->FT_VALIPI

				If (Alltrim(SFT->FT_TIPO) == "I" .And. cLinha $ "024|034|041" .And. nValCont == 0)	//DSERFIS1-8273 - Componho a coluna 01
					nValCont := nBaseIcm
				EndIf
			Else
				nValCont	:= 0
				nBaseIcm	:= 0
				nAliqIcms	:= 0
				nValIcm	:= 0
				nIsenIcm	:= 0
				nOutrIcm	:= 0
				nIcmObs	:= 0
				nIPIObs	:= 0
				nIPITrib	:= 0
				nVLincMG	:= 0
			EndIf

			AADD(aColunas,{"01",nValCont})
			AADD(aColunas,{"02",nBaseIcm})
			AADD(aColunas,{"03",nValIcm})

			// Verificando livro de IPI p/ saber de qual coluna obter o valor.
			If AllTrim(SF4->F4_LFIPI) == "T"
				nValIPI := nIPITrib
			ElseIf AllTrim(SF4->F4_LFIPI) == "O"
				nValIPI := nIPIObs
			ElseIf AllTrim(SF4->F4_LFIPI) == "P"
		 	 	nValIPI := (cAliasSD1)->D1_VALIPI
			ElseIf AllTrim(SF4->F4_LFIPI) == "I"
				nValIPI := nIPIObs
			EndIf
			Do Case
				Case cClasFis == "00" .And. AllTrim(SF4->F4_LFIPI) $ "O|T|P" // Livro de IPI = Outros
					AADD(aColunas, {"11", nValIPI + nVLincMG })
				Case cClasFis == "40"  //Isentas
					AADD(aColunas,{"05",nIsenIcm})
					If (AllTrim(SF4->F4_LFIPI) $ "I|O|T|P") // Livro de IPI Isento, adicionar o valor do IPI na coluna 11 para compor a soma e bater com o valor da coluna 1(Valor Contabil)
						AADD(aColunas,{"11", nValIPI })
					Endif
				Case cClasFis == "41" .And. ALLTRIM(SF4->F4_LFICM) == "O"  // Nao Tributadas - Livro = Outros
					AADD(aColunas,{"06",nOutrIcm})
				Case cClasFis == "41" .And. ALLTRIM(SF4->F4_LFICM) $ "INB" // Nao Tributadas - Livro = Isento/Nao/Observacoes
					AADD(aColunas,{"06",nIsenIcm})
				Case  cClasFis == "41" .And. ALLTRIM(SF4->F4_LFICM) == "Z" .And. (AllTrim ((cAliasSD1)->D1_CF)$"1601")
					AADD(aColunas,{"00", (cAliasSD1)->D1_TOTAL })
				Case cClasFis == "20" // Parcela de Base de Calculo Reduzida
					AADD(aColunas,{"07",nIsenIcm})
	       		    // Se o item for escriturado como Outros (ex: material de uso e consumo) esta coluna deve ser lancada
					AADD(aColunas,{"11",nOutrIcm + nVLincMG})
				Case cClasFis == "51" // Diferidas
					AADD(aColunas,{"08",nOutrIcm})
				Case cClasFis == "50" // Suspensas
					AADD(aColunas,{"09",nOutrIcm})
				Case cClasFis == "10" // Substituicao Tributaria
					AADD(aColunas,{"10",nOutrIcm})
						If (AllTrim(SF4->F4_LFIPI) $ "O|T|P") // Livro de IPI , adicionar o valor do IPI na coluna 11 para compor a soma e bater com o valor da coluna 1(Valor Contabil)
							AADD(aColunas,{"11", nValIPI })
						Endif
				Case cClasFis == "30" //Substituicao Tributaria
					AADD(aColunas,{"10",nOutrIcm})
				Case cClasFis $ "60|61" //Substituicao Tributaria
					AADD(aColunas,{"10",nOutrIcm})
				Case cClasFis == "70" //Substituicao Tributaria
					AADD(aColunas,{"10",nOutrIcm})
				Case cClasFis == "90" //Outras
					If ("S"$SF4->F4_ICM .And. "N"$SF4->F4_CREDICM) .Or. (lEic .And. "N"$SF4->F4_ICM)

					 	AADD(aColunas,{"11",nOutrIcm + nVLincMG  + IIf(SF4->F4_IPILICM<>'1',nValIPI,0)})

		          		//Somente ira gerar a coluna 04 se o CFOP for informado no parametro MV_DAPIC04
		          		If (AllTrim ((cAliasSD1)->D1_CF)$cMVDAPIC04)

			          		//Sem aproveitamento do credito coluna outras
							If (SF4->F4_LFICM=='O')
								AADD(aColunas,{"04",nIcmObs})

				            	//Se tiver reducao de base sempre vai gerar a coluna Isento.
					            If (SF4->F4_BASEICM>0)
					                AADD(aColunas,{"05",nIsenIcm})
				                EndIf

							//Sem aproveitamento do credito coluna isentas
							ElseIf (SF4->F4_LFICM=='I')
								AADD(aColunas,{"04",nIcmObs})
								AADD(aColunas,{"05",nIsenIcm})

							//Sem aproveitamento do credito
							Else
								AADD(aColunas,{"04",nValIcm})
							Endif

						ElseIf ("S"$SF4->F4_CONSUMO .And. cLinha$"019/023/033/040") .AND. AllTrim ((cAliasSD1)->D1_CF)$cMVDAPIC04
			            	AADD(aColunas,{"04",nIcmObs})
			            	AADD(aColunas,{"11",nOutrIcm + nValIPI})
			   			EndIf
	            	Else
		            	//Se tiver reducao de base sempre vai gerar a coluna Isento.
			            If (SF4->F4_BASEICM>0)
			                AADD(aColunas,{"05",nIsenIcm})
		                EndIf
		          		If (AllTrim ((cAliasSD1)->D1_CF)$"1933/2933")
			       		    AADD(aColunas,{"11",nValCont + nVLincMG })
		          		Elseif (AllTrim ((cAliasSD1)->D1_CF)$cMVDAPIC04)
		          	   		AADD(aColunas,{"04",nOutrIcm})
		          	   		AADD(aColunas,{"11",nOutrIcm + nValIPI + nVLincMG })
		          		Else
			       		    AADD(aColunas,{"11",nOutrIcm + nValIPI + nVLincMG })
		    	        Endif
		       		EndIf
			EndCase

	      	For nI :=1 to Len(aColunas)
	             cColuna :=aColunas[nI,1]
	             nValCol :=aColunas[nI,2]
	             nValCol := Round(nValCol,2)

	             If (cLinha$"023/033/040" .And. cColuna$"02/03") .Or. cLinha$"066"
	                Loop
	             Endif

				aLinha := {}
				aAdd (aLinha, {cTipo, cLinha, cColuna, nValCol})
				GrvLinR10(aLinha)

			     cColuna :=If(!(VAL(cLinha)>=16 .And. VAL(cLinha)<25) .And.;
			                  !(VAL(cLinha)>=26 .And. VAL(cLinha)<35) .And.;
			                  !(VAL(cLinha)>=36 .And. VAL(cLinha)<42) .And.;
			                  !(VAL(cLinha)>=44 .And. VAL(cLinha)<51) .And.;
			                  !(VAL(cLinha)>=52 .And. VAL(cLinha)<59) .And.;
			                  !(VAL(cLinha)>=60 .And. VAL(cLinha)<64) .And.;
			                  !(VAL(cLinha)>=66 .And. VAL(cLinha)<106) ,"00",cColuna)

	             If VAL(cLinha)>=16 .And. VAL(cLinha)<25
				 	aLinha := {}
					aAdd (aLinha, {cTipo, "025", cColuna, IIF(lEnerElet .And. (nValCol < 0) .And. cColuna == "11", 0, nValCol)}) //R10->VALOR		+= nValCol //DSERFIS1-11316
					GrvLinR10(aLinha)
			     Endif

	            If VAL(cLinha)>=26 .And. VAL(cLinha)<35
	            	If cColuna<>"00"
						aLinha := {}
						aAdd (aLinha, {cTipo, "035", cColuna, nValCol})
						GrvLinR10(aLinha)
	     			Endif
				Endif

	            If VAL(cLinha)>=36 .And. VAL(cLinha)<42
	            	If cColuna<>"00"

						aLinha := {}
						aAdd (aLinha, {cTipo, "042", cColuna, nValCol})
						GrvLinR10(aLinha)

	     		       	If cColuna=="03" .Or. cColuna=="04"
	     		        	n106 +=nValCol
	     		       	Endif
	     			Endif
			    Endif

	            If VAL(cLinha)>=16 .And. VAL(cLinha)<=42
	       	    	If cColuna<>"00"

						aLinha := {}
						aAdd (aLinha, {cTipo, "043", cColuna, nValCol})
						GrvLinR10(aLinha)

	  		        	If cColuna=="03"
	                    	cColuna	:="00"

							aLinha := {}
							aAdd (aLinha, {cTipo, "088", cColuna, nValCol})
							GrvLinR10(aLinha)

							If !R10->(MsSeek(cTipo+"090"+cColuna))
								aCredDeb  :=  FisApur("IC",val(Substr(DTOS(dDataFim),1,4)),val(Substr(DTOS(dDataFim),5,2)),2,0,"*",.F.,{},1,.F.,"")
								nValCol90	:=	Iif (aScan (aCredDeb, {|a| a[1]=="032"})<>0, aCredDeb[aScan (aCredDeb, {|a| a[1]=="032"})][3], 0) // Campo 90 dever ser correspondente ao campo 32 da aba Informa็oes complementares da Apura็ใo do ICMS;

								aLinha := {}
								aAdd (aLinha, {cTipo, "090", cColuna, nValCol90})
								GrvLinR10(aLinha, ,.T.)
							Else
								nValCol90 := 0
							Endif

							aLinha := {}
							aAdd (aLinha, {cTipo, "091", cColuna, nValCol + nValCol90})
							GrvLinR10(aLinha)

							aLinha := {}
							aAdd (aLinha, {cTipo, "092", cColuna, nValCol})
							GrvLinR10(aLinha)

							aLinha := {}
							aAdd (aLinha, {cTipo, "097", cColuna, nValCol})
							GrvLinR10(aLinha, .F.)

							aLinha := {}
							aAdd (aLinha, {cTipo, "099", cColuna, nValCol})
							GrvLinR10(aLinha, .F.)
						EndIf
	     		    Endif
	             Endif
	         Next

			//-- ICMS recolhido antecipado no momento da entrada.
			If cPaisLoc == "BRA" .And. SF4->F4_ANTICMS == "1" .And. (cAliasSD1)->D1_VALANTI > 0
				If SF4->F4_SITTRIB $ "10/30/60/70"
					//-- Campo 108 - Substituicao Tributaria
					cLinha := "108"
				ElseIf SF4->F4_SITTRIB $ "00|20"
					//-- Campo 109 - Outros
					cLinha := "109"
				EndIf

				aLinha := {}
				aAdd (aLinha, {cTipo, cLinha, "00", (cAliasSD1)->D1_VALANTI})
				GrvLinR10(aLinha)
				n110 += (cAliasSD1)->D1_VALANTI
			EndIf

	 		 //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			 //ณREGISTRO TIPO 20 - Transferencia de Creditos		      ณ
	 		 //ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If SF4->F4_TRFICM=="1"
				 If SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
	 	            If R20->(MsSeek((cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_LOJA))
							R20->(RecLock ("R20", .F.))
								R20->VALOR	+=	(cAliasSD1)->D1_BASEICM
							R20->(MsUnLock ())
					Else
						R20->(RecLock ("R20", .T.))
							R20->UF		:= SA2->A2_EST
							R20->INSC	:= Padl(Alltrim(SA2->A2_INSCR),15)
							R20->NF		:= (cAliasSD1)->D1_DOC
							R20->SERIE	:= (cAliasSD1)->D1_SERIE
							R20->SDOC	:= SerieNfId(cAliasSD1,2,"D1_SERIE")
							R20->DTNF	:= (cAliasSD1)->D1_EMISSAO
							R20->VALOR	:= Iif((cAliasSD1)->D1_BASEICM == 0 .And. cLinha =="066",(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_BASEICM)
							R20->LOJA	:= (cAliasSD1)->D1_LOJA
						R20->(MsUnLock ())
					EndIf
	             Endif
			EndIf
            //Registro R22 detalhamento deve trazer as nota de Entrada e nao as notas de Saida; NEsse caso foi alterado para gerar R22 da SD1 e nao R29
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณREGISTRO TIPO 22 - Estorno de Debitos	    		      ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If cPaisLoc == "BRA" .And. SF4->F4_ESTCRED > 0
				SD1->(dbSetOrder(1))
				If SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
					If R22->(MsSeek((cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_LOJA))
						R22->(RecLock ("R22", .F.))
						R22->VALOR	+=	(cAliasSD1)->D1_ESTCRED
						R22->(MsUnLock())
					Else
						R22->(RecLock ("R22", .T.))
						R22->INSC		:= SA2->A2_INSCR
						R22->NF		:= (cAliasSD1)->D1_DOC
						R22->SERIE		:= (cAliasSD1)->D1_SERIE
						R22->SDOC		:= SerieNfId(cAliasSD1,2,"D1_SERIE")
						R22->DTNF		:= (cAliasSD1)->D1_EMISSAO
						R22->VALOR		:= (cAliasSD1)->D1_ESTCRED
						R22->LOJA		:= (cAliasSD1)->D1_LOJA
						R22->MOTIVO 	:= "1"
						// Em alinhamento com o Time do TMS, antes R29 buscava o Detalhamento com base na SD1, sendo o correto buscar da SD2, nesse caso R22 Detalahmento do Estorno, buscar daa entradas e nesse caso o time d TMS busca as justificativas de entrada da SF1, somente nas saidas que tem as tabelas DV1 e DUG.
						If SF1->(MsSeek(xFilial("SF1")+(cAliasSD1)->D1_DOC +(cAliasSD1)->D1_SERIE)) 
							R22->JUST	:= SF1->F1_MENNOTA
							if empty(R22->JUST)
								R22->JUST := DescComp("E",(cAliasSD1)->D1_DOC,(cAliasSD1)->D1_SERIE,(cAliasSD1)->D1_FORNECE,(cAliasSD1)->D1_LOJA,(cAliasSD1)->D1_TES)
							Endif
						EndIf

						cEspecie		:=	AModNot (SFT->FT_ESPECIE)		//Modelo NF

						If cEspecie$"07#08#09#10#11#26#27#57#67" .And. SFT->FT_ICMSRET > 0
							R22->INSC		:= ""
							R22->NF		:= ""
							R22->SERIE		:= ""
							R22->SDOC		:= ""
							R22->VALOR		:= (cAliasSD1)->D1_ESTCRED
							R22->MOTIVO 	:= "2"
						Elseif cEspecie$ "21#22"
							R22->NF		:= (cAliasSD1)->D1_DOC
							R22->SERIE		:= (cAliasSD1)->D1_SERIE
							R22->DTNF		:= (cAliasSD1)->D1_EMISSAO
							R22->VALOR		:= (cAliasSD1)->D1_ESTCRED
							R22->MOTIVO 	:= "3"
						EndIf
						R22->(MsUnLock())
					EndIf
				Endif
			EndIf	 
	    Endif
	      (cAliasSD1)->(dbskip())
	      //
		  aColunas	:=	{}
	EndDo
	#IFDEF TOP
		dbSelectArea(cAliasSD1)
		dbCloseArea()
	#ELSE
		dbSelectArea(cAliasSD1)
		RetIndex (cAliasSd1)
		FErase (cIndSd1+OrdBagExt ())
	#ENDIF

	//Gera o registro de Dedu็๕es referente เ transferencia de filias
	DAPIMGDedTrans(FirstDay(dDataFim+1),LastDay(dDataFim+1))

	dbSelectArea("SD2")
	SD2->(DbSetOrder(3))

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCampos que serao adicionados a query somente se existirem na baseณ
	//ณControle de Chave unica.											ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	If SerieNfId("SD2",3,"D2_SERIE") == "D2_SDOC"
		cCampos := "% " + ", SD2.D2_SERIE , SD2.D2_SDOC" + " %"
	Else
		cCampos := "% " + ",SD2.D2_SERIE" + " %"
	Endif

	#IFDEF TOP
	    If lDAPIMGD2
			ExecBlock("DAPIMGD2",.F.,.F.,{cAliasSD2,dDataIni,dDataFim})
		Else
			BeginSql Alias cAliasSd2
			COLUMN D2_EMISSAO AS DATE
			SELECT
					SD2.D2_FILIAL,SD2.D2_DOC,SD2.D2_CLIENTE,SD2.D2_LOJA,SD2.D2_COD,SD2.D2_ITEM,
					SD2.D2_EMISSAO,SD2.D2_TES,SD2.D2_TOTAL,SD2.D2_VALIPI,SD2.D2_ICMSRET,SD2.D2_VALFRE,SD2.D2_DESPESA,SD2.D2_BASEICM,
					SD2.D2_VALICM,SD2.D2_CF,SD2.D2_BRICMS,SD2.D2_CODISS, SD2.D2_ESTCRED, SD2.D2_TIPO, SD2.D2_CLASFIS, SD2.D2_PEDIDO
					%Exp:cCampos%
			FROM
				%table:SD2% SD2
				JOIN %table:SFT% SFT ON SFT.FT_FILIAL = %xFilial:SFT% AND SFT.FT_TIPOMOV = 'S' AND SD2.D2_SERIE = SFT.FT_SERIE AND SD2.D2_DOC = SFT.FT_NFISCAL AND SD2.D2_CLIENTE = SFT.FT_CLIEFOR AND
				SD2.D2_LOJA = SFT.FT_LOJA AND SFT.FT_ITEM = SD2.D2_ITEM AND SFT.FT_PRODUTO = SD2.D2_COD AND SFT.D_E_L_E_T_ = ' ' AND SFT.FT_TIPO <> 'S'
			WHERE
				SD2.%NotDel% AND
				SD2.D2_FILIAL=%xFilial:SD2% AND
				SD2.D2_EMISSAO>=%Exp:DTOS(dDataIni)% AND
				SD2.D2_EMISSAO<=%Exp:DTOS(dDataFim)%
			ORDER BY
				1,2,3,4,5,6,7
			EndSql
		Endif
	#ELSE
	    If lDAPIMGD2
			ExecBlock("DAPIMGD2",.F.,.F.,{cAliasSD2,dDataIni,dDataFim})
		Else
			cIndSd2	:=	CriaTrab (NIL, .F.)
			cChave	:=	IndexKey()

			cFiltro	:= "D2_FILIAL=='"+xFilial("SD2")+"'"
			cFiltro	+= " .And. DTOS(D2_EMISSAO)>='"+DTOS(dDataIni)+"' .AND. DTOS(D2_EMISSAO)<='"+DTOS(dDataFim)+"' "
			cFiltro	+= " .And. (Empty(D2_CODISS) .OR. (Empty(D2_CODISS) .AND. D2_TIPO <> 'S'))"
			IndRegua (cAliasSd2, cIndSd2, cChave,, cFiltro)
			nRetInd := RetIndex (cAliasSd2)
			DbSetIndex (cIndSd2+OrdBagExt ())
			DbSetOrder (nRetInd+1)
			DbGoTop ()
		Endif
	#ENDIF

	(cAliasSd2)->(DbGoTop ())
	While !(cAliasSD2)->(Eof ())

        nValIPI := 0
 	    If SF4->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))

			cClasFis := AllTrim(SubStr((cAliasSD2)->D2_CLASFIS, 2, 2))
			cLinha := ""
	        Do Case
	        	Case AllTrim((cAliasSD2)->D2_CF)$"5101/5102/5103/5104/5105/5106/5111/5112/5113/5114/5115/5116/5117/5118/5119/5120/5122/5123/5124/5125/5131/5132/5159/5160/5401/5402/5403/5405/5501/5502/5651/5652/5653/5654/5655/5656/5933"
		 	         cLinha :="044"
	      	    Case AllTrim((cAliasSD2)->D2_CF)$"5151/5152/5153/5155/5156/5408/5409/5552/5557/5658/5659"
	         	     cLinha :="045"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5201/5202/5205/5206/5207/5208/5209/5210/5213/5214/5215/5410/5411/5412/5413/5503/5553/5556/5660/5661/5662"
	                 cLinha :="046"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5251/5252/5253/5254/5255/5256/5257/5258"
	                 cLinha :="047"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5301/5302/5303/5304/5305/5306/5307"
	                 cLinha :="048"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5351/5352/5353/5354/5355/5356/5357/5359/5360"
	                 cLinha :="049"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5414/5415/5451/5505/5551/5554/5555/5901/5902/5903/5904/5905/5906/5907/5908/5909/5910/5911/5912/5913/5914/5915/5916/5917/5918/5919/5920/5921/5922/5923/5924/5925/5926/5927/5928/5929/5931/5932/5934/5949/5657/5663/5664/5665/5666"
	                 cLinha :="050"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6101/6102/6103/6104/6105/6106/6107/6108/6109/6110/6111/6112/6113/6114/6115/6116/6117/6118/6119/6120/6122/6123/6124/6125/6131/6132/6159/6160/6401/6402/6403/6404/6501/6502/6651/6652/6653/6654/6655/6656"
	                 cLinha :="052"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6151/6152/6153/6155/6156/6408/6409/6552/6557/6658/6659"
		 	         cLinha :="053"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6201/6202/6205/6206/6207/6208/6209/6210/6213/6214/6215/6410/6411/6412/6413/6503/6553/6556/6660/6661/6662"
	                 cLinha :="054"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6251/6252/6253/6254/6255/6256/6257/6258"
	                 cLinha :="055"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6301/6302/6303/6304/6305/6306/6307"
	                 cLinha :="056"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6351/6352/6353/6354/6355/6356/6357/6359/6360"
	                 cLinha :="057"
	            Case AllTrim((cAliasSD2)->D2_CF)$"6414/6415/6504/6551/6554/6555/6901/6902/6903/6904/6905/6906/6907/6908/6909/6910/6911/6912/6913/6914/6915/6916/6917/6918/6919/6920/6921/6922/6923/6924/6925/6929/6931/6932/6949/6657/6663/6664/6665/6666/6933/6160,6159"
	                 cLinha :="058"
	            Case AllTrim((cAliasSD2)->D2_CF)$"7101/7102/7105/7106/7127/7651/7654"
	                 cLinha :="060"
	            Case AllTrim((cAliasSD2)->D2_CF)$"7201/7202/7205/7206/7207/7210/7211/7553/7556"
	                 cLinha :="061"
	            Case AllTrim((cAliasSD2)->D2_CF)$"7251/7301/7358"
	                 cLinha :="062"
	            Case AllTrim((cAliasSD2)->D2_CF)$"7501/7551/7930/7949"
	                 cLinha :="063"
	            Case AllTrim((cAliasSD2)->D2_CF)$"5601/5602"
	                 cLinha :="073"
	         	Otherwise
		            (cAliasSD2)->(Dbskip())
	            	loop
	        EndCase

			SF4->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณQuando nao necessitar de coluna, processo somente a linha de um array e gravo no TRBณ
	 		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If SF4->F4_OBSSOL=="1" .And. Left ((cAliasSD2)->D2_CF, 1)$"5#6"
			 	aLinha	:=	{}
				If (Left ((cAliasSD2)->D2_CF, 1)=="5")
					aAdd (aLinha, {"10", "076", "00", (cAliasSD2)->D2_BRICMS})
					aAdd (aLinha, {"10", "077", "00", (cAliasSD2)->D2_ICMSRET})
					aAdd (aLinha, {"10", "082", "00", (cAliasSD2)->D2_ICMSRET})
					aAdd (aLinha, {"10", "102", "00", (cAliasSD2)->D2_ICMSRET})

		 		ElseIf (Left ((cAliasSD2)->D2_CF, 1)=="6")
					aAdd (aLinha, {"10", "083", "00", (cAliasSD2)->D2_BRICMS})
					aAdd (aLinha, {"10", "084", "00", (cAliasSD2)->D2_ICMSRET})
				EndIf
	 			GrvLinR10(aLinha)
			EndIf

			If SFT->(MsSeek(xFilial("SFT")+"S"+(cAliasSD2)->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+Padr(D2_ITEM,nTamFTIt)+D2_COD)))

				nValCont	:=	SFT->FT_VALCONT

				If Alltrim(SFT->FT_ESPECIE) $ "CF/ECF" .AND. SF4->F4_BASEICM > 0
         			nBaseIcm	:=	SFT->FT_BASEICM + SFT->FT_ISENICM + SFT->FT_OUTRICM
		        	nAliqIcms	:= 	SFT->FT_ALIQICM
   		   	        nValIcm		:=	SFT->FT_VALICM
   		   	    Else
		    		nBaseIcm	:=	SFT->FT_BASEICM
	   	   			nAliqIcms	:= 	SFT->FT_ALIQICM
	   	   			nValIcm		:=	SFT->FT_VALICM
		   			nIsenIcm	:=	SFT->FT_ISENICM

		   			If lFTDS43080 .And. lFTPR43080
						If SFT->FT_DS43080 <> 0 .AND. SFT->FT_PR43080 <> 0
					    	nIsenIcm	+=	SFT->FT_VALCONT - SFT->FT_BASEICM
						Endif
				    Endif

		      		nOutrIcm	:=	SFT->FT_OUTRICM
		      		nIPIObs := SFT->FT_IPIOBS
					nIpiTrib := SFT->FT_VALIPI
		  		EndIf

		        //A coluna 1 (Valores Contแbeis) ้ diferente da soma das colunas 2 + (4 a 10).
		        If SFT->FT_CREDST$"1/4"
		        	nOutrIcm	+=	SFT->FT_ICMSRET
		        EndIf

				//Complemento ICMS-ST
				If SF4->F4_OBSSOL=="1" .And. AllTrim((cAliasSD2)->D2_CF) == "5949" .And. (cAliasSD2)->D2_BRICMS == 0 .And. (cAliasSD2)->D2_ICMSRET == 0
					aLinha	:=	{}
					aAdd (aLinha, {"10", "076", "00", nValCont})
					GrvLinR10(aLinha)
				EndIf

				//Saํdas para SUFRAMA - Informa็๕es Complementares
				If AllTrim((cAliasSD2)->D2_CF) $ "6109|6110"
					aLinha	:=	{}
					aAdd (aLinha, {"10", "112", "00", nValCont}) //DSERFIS1-12027
					GrvLinR10(aLinha)
				EndIf

				If (Alltrim(SFT->FT_TIPO) == "I" .And. cLinha $ "050|058|063" .And. nValCont == 0)	//DSERFIS1-8273 - Componho a coluna 01
					nValCont := nBaseIcm
				EndIf

			Else
				nValCont	:= 0
				nBaseIcm	:= 0
				nAliqIcms	:= 0
				nValIcm		:= 0
				nIsenIcm	:= 0
				nOutrIcm	:= 0
				nIPIObs		:= 0
				nIPITrib	:= 0
			EndIf


	        AADD(aColunas,{"01",nValCont})
			AADD(aColunas,{"02",nBaseIcm})
			AADD(aColunas,{"03",nValIcm})


	    	// Adiciona o valor de IPI na coluna "Outros"
			If AllTrim(SF4->F4_LFIPI) == "T"
				nValIPI := nIPITrib
			ElseIf AllTrim(SF4->F4_LFIPI) == "O"
				nValIPI := nIPIObs
			ElseIf AllTrim(SF4->F4_LFIPI) == "P"
				nValIPI := (cAliasSD2)->D2_VALIPI
			ElseIf AllTrim(SF4->F4_LFIPI) == "I"
				nValIPI := nIPIObs
		 	EndIf

	        Do Case
	        	Case cClasFis == "00" .And. AllTrim(SF4->F4_LFIPI) $ "N|T|O|P"  //Tributado
			 		AADD(aColunas,{"10", nValIPI})
				Case cClasFis == "40" //Isentas
					AADD(aColunas,{"04",nIsenIcm})
					If (AllTrim(SF4->F4_LFIPI) $ "I|O|T|P") // Livro de IPI Isento Vendas Suframa
						AADD(aColunas,{"10", nValIPI })
					Endif
				Case cClasFis == "41" // Nao Tributadas
					If (AllTrim ((cAliasSD2)->D2_CF) $ "5601/5602")
						AADD(aColunas,{"00", (cAliasSD2)->D2_TOTAL })
					Else
						AADD(aColunas,{"05",nIsenIcm})
					EndIf
				Case cClasFis == "20" // Parcela de Base de Calculo Reduzida
					AADD(aColunas,{"06",nIsenIcm})
				Case cClasFis == "51" // Diferidas
					AADD(aColunas,{"07",nOutrIcm})
				Case cClasFis == "50" // Suspensas
					AADD(aColunas,{"08",nOutrIcm})
				Case cClasFis $ "10|30|60|61|70"  //Substituicao Tributaria  //DSERFIS1-12827
					If cClasFis == "70" 
						AADD(aColunas,{"06",nIsenIcm})
					Endif
				 	If SF4->F4_CREDST == "2" // Adicionado regra para atender vendas com CST 10|30|60|70 que tenha o Credito ST Retido , para gravar no livro da DAPIMG na coluna 09
		         		nOutrIcm	+=	SFT->FT_ICMSRET
		         	EndIf
					AADD(aColunas,{"09",nOutrIcm})
					If cClasFis $ "10|70" .And. (AllTrim(SF4->F4_LFIPI) $ "O|T|P") // Livro de IPI
						AADD(aColunas,{"10", nValIPI })
					Endif
				Case cClasFis == "90" .OR. AllTrim(SF4->F4_LFIPI)=="P" //Outras
					If (SF4->F4_BASEICM > 0) //Se tiver reducao de base sempre vai gerar a coluna Isento.
	             		AADD(aColunas,{"04",nIsenIcm})
					EndIf

					If (AllTrim ((cAliasSD2)->D2_CF)$"5933/6933")
						AADD(aColunas,{"10",nValCont})
					ElseIf  (AllTrim ((cAliasSD2)->D2_CF)$cMVDAPIC04)
						AADD(aColunas,{"04",nOutrIcm})
					Else
			 			AADD(aColunas,{"10", nOutrIcm + nValIPI})
					Endif
	        EndCase

	      	For nI :=1 to Len(aColunas)
	        	cColuna :=aColunas[nI,1]
	            nValCol :=aColunas[nI,2]
	            nValCol := Round(nValCol,2)

	            If (cLinha$"023/033/040" .And. cColuna$"02/03") .Or. nValCol==0 .Or. cLinha $ "073"
	               Loop
	            Endif

	            cColuna :=If((VAL(cLinha)>=44 .And. VAL(cLinha)<66) .And. Val(cColuna)>10,"10",cColuna)

				aLinha := {}
				aAdd (aLinha, {cTipo, cLinha, cColuna, nValCol})
				GrvLinR10(aLinha)

			    cColuna :=If(!(VAL(cLinha)>=16 .And. VAL(cLinha)<25) .And.;
			                 !(VAL(cLinha)>=26 .And. VAL(cLinha)<35) .And.;
			                 !(VAL(cLinha)>=36 .And. VAL(cLinha)<42) .And.;
			                 !(VAL(cLinha)>=44 .And. VAL(cLinha)<51) .And.;
			                 !(VAL(cLinha)>=52 .And. VAL(cLinha)<59) .And.;
			                 !(VAL(cLinha)>=60 .And. VAL(cLinha)<64) .And.;
			                 !(VAL(cLinha)>=66 .And. VAL(cLinha)<106) ,"00",cColuna)

	            If VAL(cLinha)>=44 .And. VAL(cLinha)<51
	            	If cColuna<>"00"
	                	cColuna	:=If(Val(cColuna)>10,"10",cColuna)

						aLinha := {}
						aAdd (aLinha, {cTipo, "051", cColuna, nValCol})
						GrvLinR10(aLinha)
			       	Endif
			    Endif

	            If VAL(cLinha)>=52 .And. VAL(cLinha)<59
	                If cColuna<>"00"
	                	cColuna	:=If(Val(cColuna)>10,"10",cColuna)

						aLinha := {}
						aAdd (aLinha, {cTipo, "059", cColuna, nValCol})
						GrvLinR10(aLinha)
	     		    Endif
			    Endif

	            If VAL(cLinha)>=60 .And. VAL(cLinha)<64
	            	cColuna	:=If(Val(cColuna)>10,"10",cColuna)
	               	If cColuna<>"00"

					   	aLinha := {}
						aAdd (aLinha, {cTipo, "064", cColuna, nValCol})
						GrvLinR10(aLinha)
	     		   	Endif
			    Endif

	            If VAL(cLinha)>=44 .And. VAL(cLinha)<=64
	          		If cColuna<>"00"
	                	cColuna	:=If(Val(cColuna)>10,"10",cColuna)
	          	       	cColunas := cColuna

						aLinha := {}
						aAdd (aLinha, {cTipo, "065", cColuna, nValCol})
						GrvLinR10(aLinha)

	                   	If cColuna=="01"
	          	        	If cLinha=="060"
	                        	cColuna	:="00"

								aLinha := {}
								aAdd (aLinha, {cTipo, "113", cColuna, nValCol})
								GrvLinR10(aLinha)
		   		          	Endif
	                   	Endif
	                   	If cColuna=="02"
		                	cColuna	:="01"
						  	If !R10->(MsSeek(cTipo+cLinha+cColuna))

							  	aLinha := {}
								aAdd (aLinha, {cTipo, cLinha, cColuna, nValCol})
								GrvLinR10(aLinha, ,.T.)
			     	   		  	If !R10->(MsSeek(cTipo+"051"+cColuna)) .And. VAL(cLinha)>=44 .And. VAL(cLinha)<=50
									aLinha := {}
									aAdd (aLinha, {cTipo, "051", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
			          	      	Endif
			          	      	If !R10->(MsSeek(cTipo+"059"+cColuna)) .And. VAL(cLinha)>=52 .And. VAL(cLinha)<=58
									aLinha := {}
									aAdd (aLinha, {cTipo, "059", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
			          	      	Endif
			          	      	If !R10->(MsSeek(cTipo+"064"+cColuna)) .And. VAL(cLinha)>=60 .And. VAL(cLinha)<=63
									aLinha := {}
									aAdd (aLinha, {cTipo, "064", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
			          	      	Endif
								aLinha := {}
								aAdd (aLinha, {cTipo, "065", cColuna, nValCol})
								GrvLinR10(aLinha)
			     	    	Endif
	  		           	Endif
	  		           	If cColuna=="03"
		                	cColuna	:="01"
							If !R10->(MsSeek(cTipo+cLinha+cColuna))
								aLinha := {}
								aAdd (aLinha, {cTipo, cLinha, cColuna, nValCol})
								GrvLinR10(aLinha, ,.T.)
								If !R10->(MsSeek(cTipo+"051"+cColuna)) .And. VAL(cLinha)>=44 .And. VAL(cLinha)<=50
									aLinha := {}
									aAdd (aLinha, {cTipo, "051", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								If !R10->(MsSeek(cTipo+"059"+cColuna)) .And. VAL(cLinha)>=52 .And. VAL(cLinha)<=58
									aLinha := {}
									aAdd (aLinha, {cTipo, "059", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								If !R10->(MsSeek(cTipo+"064"+cColuna)) .And. VAL(cLinha)>=60 .And. VAL(cLinha)<=63
									aLinha := {}
									aAdd (aLinha, {cTipo, "064", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								aLinha := {}
								aAdd (aLinha, {cTipo, "065", cColuna, nValCol})
								GrvLinR10(aLinha)
							Endif
							cColuna	:="02"
							If !R10->(MsSeek(cTipo+cLinha+cColuna))
								aLinha := {}
								aAdd (aLinha, {cTipo, cLinha, cColuna, nValCol})
								GrvLinR10(aLinha, ,.T.)
								If !R10->(MsSeek(cTipo+"051"+cColuna)) .And. VAL(cLinha)>=44 .And. VAL(cLinha)<=50
									aLinha := {}
									aAdd (aLinha, {cTipo, "051", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								If !R10->(MsSeek(cTipo+"059"+cColuna)) .And. VAL(cLinha)>=52 .And. VAL(cLinha)<=58
									aLinha := {}
									aAdd (aLinha, {cTipo, "059", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								If !R10->(MsSeek(cTipo+"064"+cColuna)) .And. VAL(cLinha)>=60 .And. VAL(cLinha)<=63
									aLinha := {}
									aAdd (aLinha, {cTipo, "064", cColuna, nValCol})
									GrvLinR10(aLinha, ,.T.)
								Endif
								aLinha := {}
								aAdd (aLinha, {cTipo, "065", cColuna, nValCol})
								GrvLinR10(aLinha)
							Endif

							cColuna	:="00"

							aLinha := {}
							aAdd (aLinha, {cTipo, "092", cColuna, nValCol})
							GrvLinR10(aLinha, .F.)

							If !R10->(MsSeek(cTipo+"093"+cColuna)) .And. cColunas=="03"
								nVal96 :=nValCol
								aLinha := {}
								aAdd (aLinha, {cTipo, "093", cColuna, nValCol})
								GrvLinR10(aLinha, ,.T.)
							ElseIf R10->(MsSeek(cTipo+"093"+cColuna)) .And. cColunas=="03"
								nVal96 :=nValCol
								RecLock("R10",.F.)
								R10->VALOR		+=nValCol
								R10->(MsUnLock())
							Endif
							aLinha := {}
							aAdd (aLinha, {cTipo, "096", cColuna, nVal96})
							GrvLinR10(aLinha)
							nVal96 := 0

							aLinha := {}
							aAdd (aLinha, {cTipo, "097", cColuna, nValCol})
							GrvLinR10(aLinha)

							aLinha := {}
							aAdd (aLinha, {cTipo, "099", cColuna, nValCol})
							GrvLinR10(aLinha)

						Endif
	     		    Endif
	            Endif
	        Next
	   		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณREGISTRO TIPO 21 - Transferencia de Debitos			      ณ
	 		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If SF4->F4_TRFICM=="1"
				If SA1->(MsSeek(xFilial("SA1")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
	 	            If R21->(MsSeek((cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_LOJA))
							R21->(RecLock ("R21", .F.))
								R21->VALOR	+=	(cAliasSD2)->D2_BASEICM
							R21->(MsUnLock ())
					Else
						R21->(RecLock ("R21", .T.))
							R21->UF		:= SA1->A1_EST
							R21->INSC	:= Padl(Alltrim(SA1->A1_INSCR),15)
							R21->NF	:= (cAliasSD2)->D2_DOC
							R21->SERIE	:= (cAliasSD2)->D2_SERIE
							R21->SDOC	:= SerieNfId(cAliasSD2,2,"D2_SERIE")
							R21->DTNF	:= (cAliasSD2)->D2_EMISSAO
							R21->VALOR	:= Iif((cAliasSD2)->D2_BASEICM == 0 .And. cLinha =="073",(cAliasSD2)->D2_TOTAL,(cAliasSD2)->D2_BASEICM)
							R21->LOJA	:= (cAliasSD2)->D2_LOJA
						R21->(MsUnLock ())
					EndIf
	            Endif
			EndIf
			/*Linha Tipo 29 - Detalhamento 10 (Detalhamento de Estorno de Cr้dito  Campo 95 da DAPI 01)*/ 
            //Nesse caso o Detalhamento do Campo95 ้ referente as nota de saida  e nao as notas de entrada.
			R29->(dbSetOrder(1))
			If (cAliasSD2)->D2_ESTCRED > 0
			 	If SA1->(MsSeek(xFilial("SA1")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			 		If R29->(MsSeek("05"+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_LOJA))
							R29->(RecLock ("R29", .F.))
							R29->VALOR	+=	(cAliasSD2)->D2_ESTCRED
							R29->(MsUnLock())
					Else
							R29->(RecLock ("R29", .T.))
							R29->MOTIVO := "05"
							R29->AUTO	:= "             "
							R29->VALOR	:= (cAliasSD2)->D2_ESTCRED
							R29->NF		:= (cAliasSD2)->D2_DOC
							R29->SERIE	:= (cAliasSD2)->D2_SERIE
							R29->SDOC	:= SerieNfId(cAliasSD2,2,"D2_SERIE")
							R29->DTNF	:= (cAliasSD2)->D2_EMISSAO
							R29->(MsUnLock())
					EndIf
				EndIf
	        Endif			
		Endif
		(cAliasSD2)->(Dbskip())
		aColunas	:=	{}
	Enddo

	#IFDEF TOP
		dbSelectArea(cAliasSD2)
		dbCloseArea()
	#ELSE
		dbSelectArea(cAliasSD2)
		RetIndex (cAliasSd2)
		FErase (cIndSd2+OrdBagExt ())
	#ENDIF

	If !lConsolida
		Exit
	Else
		nCont++
		If nCont > Len(aFilsCons)
			cFilAnt := cFilAnterior
			Exit
		Else
			cFilAnt := aFilsCons[nCont][2]
		EndIf
	EndIf

EndDo

//XI - Informa็๕es Econ๔micas
If mv_par11 <> 0
	For nI := 1 To 4
		If nI == 1
			cLinha := "115"
			nValor := mv_par11
		ElseIf nI == 2
			cLinha := "116"
			nValor := mv_par12
		ElseIf nI == 3
			cLinha := "117"
			nValor := mv_par13
		Else
			cLinha := "118"
			nValor := mv_par14
		Endif
		RecLock("R10",.T.)
		R10->TIPO		:= "10"
		R10->LINHA		:= cLinha
		R10->COLUNA	:= "00"
    	R10->VALOR		:= nValor
    	R10->(MsUnLock())
	Next
Endif

//Devolu็ใo ST
If R10->(MsSeek("10"+"080"+"00"))
	n080 := R10->VALOR
EndIf

If R10->(MsSeek("10"+"082"+"00"))
	RecLock("R10",.F.)	
	R10->VALOR	-= n080 + nLinha78

	If R10->VALOR < 0
		R10->VALOR := 0
	EndIf 

	R10->(MsUnLock())
Endif

If R10->(MsSeek("10"+"102"+"00"))
	RecLock("R10",.F.)
	R10->VALOR	-= n080 + nLinha78

	If R10->VALOR < 0
		R10->VALOR := 0
	EndIf 
	
	R10->(MsUnLock())
Endif

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCalculo a somatoria para a linha 105ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If R10->(MsSeek("10"+"099"+"00"))
	n099	:=	R10->VALOR
EndIf
If R10->(MsSeek("10"+"101"+"00"))
	n101	:=	R10->VALOR
EndIf
If R10->(MsSeek("10"+"102"+"00"))
	n102	:=	R10->VALOR
EndIf
If !R10->(MsSeek("10"+"105"+"00"))
	RecLock("R10",.T.)
		R10->TIPO		:="10"
		R10->LINHA		:="105"
		R10->COLUNA		:="00"
Else
	RecLock("R10",.F.)
Endif
R10->VALOR	+=	n099+n101+n102
If !R10->(MsSeek("10"+"106"+"00"))
	RecLock("R10",.T.)
		R10->TIPO		:="10"
		R10->LINHA		:="106"
		R10->COLUNA		:="00"
Else
	RecLock("R10",.F.)
Endif
R10->VALOR	+=	n106
n110		+=	n106 //a linha 110 = 106 + 107 + 108 + 109
R10->(MsUnLock())

If nValCol131 > 0

	If !R10->(MsSeek(cTipo+"130"+cColuna))
		RecLock("R10",.T.)
		R10->TIPO		:=cTipo
		R10->LINHA		:="130"
		R10->COLUNA	:=cColuna
	Else
		RecLock("R10",.F.)
	Endif
	R10->VALOR		:=nValCol131
	R10->(MsUnLock())

EndIf

If !R10->(MsSeek("10"+"081"+"00")) 
	RecLock("R10",.T.)
		R10->TIPO		:=	"10"
		R10->LINHA		:=	"081"
		R10->COLUNA		:=	"00"
Else
	RecLock("R10",.F.)
EndIf
		R10->VALOR		+= nLinha81
	MsUnLock()

If !Empty (MV_PAR09)	//Considera saldo credor do periodo anterior
	//Sera necessario atualizar todos os totalizadores.
	//

	If !R10->(MsSeek("10"+"078"+"00")) 
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
			R10->LINHA		:=	"078"
			R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	EndIf
			R10->VALOR		+= nLinha78
		MsUnLock()

	If !R10->(MsSeek("10"+"087"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
			R10->LINHA		:=	"087"
			R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	EndIf
			R10->VALOR		+=	nLinha87
		MsUnLock()
	//
	If !R10->(MsSeek("10"+"091"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
			R10->LINHA		:=	"091"
			R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	EndIf
			R10->VALOR		+=	nLinha87
		R10->(MsUnLock())
	//
	If !R10->(MsSeek("10"+"092"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
			R10->LINHA		:=	"092"
			R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	EndIf
			R10->VALOR		+=	nLinha87
		R10->(MsUnLock())
	//
	If !R10->(MsSeek(cTipo+"097"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
			R10->LINHA		:=	"097"
			R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	Endif
			R10->VALOR		-=	nLinha87
		R10->(MsUnLock())
	//
	If !R10->(MsSeek(cTipo+"099"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
		 	R10->LINHA		:=	"099"
		    R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	Endif
			R10->VALOR		-=	nLinha87
		R10->(MsUnLock())
	//
	If !R10->(MsSeek(cTipo+"105"+"00"))
		RecLock("R10",.T.)
			R10->TIPO		:=	"10"
		    R10->LINHA		:=	"105"
		    R10->COLUNA		:=	"00"
	Else
		RecLock("R10",.F.)
	Endif
			R10->VALOR		-=	nLinha87
		R10->(MsUnLock())
EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณInformacoes referentes a Outros Creditos/Outros Debitos		 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aCredDeb   :=FisApur("IC",val(Substr(DTOS(dDataFim),1,4)),val(Substr(DTOS(dDataFim),5,2)),2,0,"*",.F.,{},1,.F.,"")
nTotDeb    :=0
nTotCred   :=0
nDifAliq   :=0
n103	 :=0
nTot	 :=0
nLin91	 :=0
nLin96	 :=0
nCredPre :=0
nFem     :=0 // VALOR DO FECP-MG ICMS
nFemST   :=0 //VALOR DO FECP-MG ICMS ST

For nI := 1 To Len(aCredDeb)
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCreditos    	  ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If aCredDeb[nI,4] == "006.66"
      If !R10->(MsSeek(cTipo + "066" + "00"))
         RecLock("R10", .T.)
         R10->TIPO		:= cTipo
         R10->LINHA		:= "066"
         R10->COLUNA	:= "00"
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
         R10->(MsUnLock())
         nTotCred 		+=aCredDeb[nI,3]
	Elseif aCredDeb[nI,4] == "006.67"
      If !R10->(MsSeek(cTipo+"067"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="067"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
         R10->(MsUnLock())
         nTotCred +=aCredDeb[nI,3]
	Elseif aCredDeb[nI,4] == "006.68"
      If !R10->(MsSeek(cTipo+"068"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="068"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
         R10->(MsUnLock())
         nTotCred +=aCredDeb[nI,3]
	Elseif aCredDeb[nI,4] == "006.69"
      If !R10->(MsSeek(cTipo+"069"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="069"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
         R10->(MsUnLock())
         nTotCred +=aCredDeb[nI,3]
	Elseif aCredDeb[nI,4] == "006.71"
      If !R10->(MsSeek(cTipo+"071"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="071"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
         R10->(MsUnLock())
         nTotCred +=aCredDeb[nI,3]
	// Retirado esse parte ElseIf aCredDeb[nI,1] == "031" por que nessa momento esta duplicando o campo 95 com as notas da apura็ใo motivo 05  
	ElseIf aCredDeb[nI,1] == "003" .And. aCredDeb[nI,4] == "003.01"
    	If !R10->(MsSeek(cTipo+"095"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="095"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
      R10->VALOR		+=aCredDeb[nI,3]
      R10->(MsUnLock())
	  nTotEstCrd += aCredDeb[nI,3]
		

	// Conforme manunal da DAPI o motivo 01 apartir de 01/2020 Se motivo = Estorno de Cr้dito decorrente de Recomposi็ใo Fiscal  Campo = 01.- A partir do perํodo de referencia 01/2020  motivo inabilitado 	
	ElseIf aCredDeb[nI,1] == "003" .And. aCredDeb[nI,4] == "003.02"
    	If !R10->(MsSeek(cTipo+"095"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="095"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
      R10->VALOR		+=aCredDeb[nI,3]
      R10->(MsUnLock())
	  nTotEstCrd += aCredDeb[nI,3]
	   /*Linha Tipo 29 - Detalhamento 10 (Detalhamento de Estorno de Cr้dito  Campo 95 da DAPI 01)*/
		R29->(dbSetOrder(2))
		If R29->(MsSeek("02"))
			R29->(RecLock ("R29", .F.))
			R29->VALOR	+=	aCredDeb[nI,3]
			R29->(MsUnLock())
		Else
			RecLock("R29",.T.)
			R29->MOTIVO := "02"
			R29->AUTO	:= "             "
			R29->VALOR	:= aCredDeb[nI,3]
			R29->NF	:= "         "
			R29->SERIE	:= Space(TamSx3("D1_SERIE")[1])
			R29->SDOC	:= Space(TamSx3(SerieNfId("SD1",3,"D1_SERIE"))[1])
			R29->DTNF	:= ctod('')
			R29->(MsUnLock())
		EndIf
	ElseIf aCredDeb[nI,1] == "003" .And. aCredDeb[nI,4] == "003.03"
    	If !R10->(MsSeek(cTipo+"095"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="095"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
      R10->VALOR		+=aCredDeb[nI,3]
      R10->(MsUnLock())
	  nTotEstCrd += aCredDeb[nI,3]

	  /*Linha Tipo 29 - Detalhamento 10 (Detalhamento de Estorno de Cr้dito  Campo 95 da DAPI 01)*/
		R29->(dbSetOrder(2))
		If R29->(MsSeek("03"))
			R29->(RecLock ("R29", .F.))
			R29->VALOR	+=	aCredDeb[nI,3]
			R29->(MsUnLock())
		Else
			RecLock("R29",.T.)
			R29->MOTIVO := "03"
			R29->AUTO	:= "             "
			R29->VALOR	:= aCredDeb[nI,3]
			R29->NF	:= "         "
			R29->SERIE	:= Space(TamSx3("D1_SERIE")[1])
			R29->SDOC	:= Space(TamSx3(SerieNfId("SD1",3,"D1_SERIE"))[1])
			R29->DTNF	:= ctod('')
			R29->(MsUnLock())
		EndIf
	ElseIf aCredDeb[nI,1] == "003" .And. aCredDeb[nI,4] == "003.04"
    	If !R10->(MsSeek(cTipo+"095"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="095"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
      R10->VALOR		+=aCredDeb[nI,3]
      R10->(MsUnLock())
	  nTotEstCrd += aCredDeb[nI,3]

	  /*Linha Tipo 29 - Detalhamento 10 (Detalhamento de Estorno de Cr้dito  Campo 95 da DAPI 01)*/
		R29->(dbSetOrder(2))
		If R29->(MsSeek("04"))
			R29->(RecLock ("R29", .F.))
			R29->VALOR	+=	aCredDeb[nI,3]
			R29->(MsUnLock())
		Else
			RecLock("R29",.T.)
			R29->MOTIVO := "04"
			R29->AUTO	:= "             "
			R29->VALOR	:= aCredDeb[nI,3]
			R29->NF	:= "         "
			R29->SERIE	:= Space(TamSx3("D1_SERIE")[1])
			R29->SDOC	:= Space(TamSx3(SerieNfId("SD1",3,"D1_SERIE"))[1])
			R29->DTNF	:= ctod('')
			R29->(MsUnLock())
		EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณDebitos     	  ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Elseif aCredDeb[nI,4] == "002.73"
      If !R10->(MsSeek(cTipo+"073"+"00"))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="073"
         R10->COLUNA	:="00"
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
		 R10->(MsUnLock())
		 nTotDeb +=aCredDeb[nI,3]
	Elseif aCredDeb[nI,4] == "002.74"
      If !R10->(MsSeek(cTipo+"074"+cColuna))
         RecLock("R10",.T.)
         R10->TIPO		:=cTipo
         R10->LINHA		:="074"
         R10->COLUNA	:=cColuna
      Else
         RecLock("R10",.F.)
      Endif
         R10->VALOR		+=aCredDeb[nI,3]
		 R10->(MsUnLock())
		 nTotDeb +=aCredDeb[nI,3]
	Endif
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณDiferencial de Aliquotas         ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If aCredDeb[nI,1] == "016"
		If !R10->(MsSeek(cTipo+"100"+cColuna))
			RecLock("R10",.T.)
			R10->TIPO   :=cTipo
			R10->LINHA  :="100"
			R10->COLUNA :=if (cColuna == "","00",cColuna)
		Else
			RecLock("R10",.F.)
		Endif
		R10->VALOR := aCredDeb[nI,3]
		R10->(MsUnLock())
		nDifAliq := aCredDeb[nI,3]
	Endif
	// Transferencia entre filiais
	If aCredDeb[nI,4] == "012.12"
		RecLock("R10",.T.)
		R10->TIPO	:=cTipo
		R10->LINHA	:="098"
		R10->COLUNA	:="00"
		R10->VALOR  := aCredDeb[nI,3]
		R10->(MsUnLock())
	Endif
	// FECP-MG -OPERACAO
	If aCredDeb[nI,4] == "012.02"
	      	RecLock("R10",.T.)
		    R10->TIPO	:=cTipo
		    R10->LINHA	:="122"
		    R10->COLUNA	:=cColuna
	        R10->VALOR  := aCredDeb[nI,3]
	        R10->(MsUnLock())
	        nFemST := R10->VALOR
	 Endif

Next nI

For nI := 1 To Len(aApurST)
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณServ. Transp. Responsabilidade Remetente ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If aApurST[nI,4] == "002.02"

		//Guardo o Valor do Cr้dito Presumido para abater do ICMS-ST a Recolher
		For nX:=1 To Len(aApurST)
			If aApurST[nX,4] == "007.01"
				nCredPre := aApurST[nX,3]
			EndIf
		Next nX

	   	RecLock("R10",.T.)
	    R10->TIPO	:=cTipo
	    R10->LINHA	:="103"
	    R10->COLUNA	:=cColuna
        R10->VALOR  := aApurST[nI,3] - nCredPre
        R10->(MsUnLock())
        n103 := aApurST[nI,3] - nCredPre
	Endif

	// FECP-MG-FECP/ST-MG APURACAO ICMS ST  passa o valor da linha 119 e atualiza a 082 e 102
	If aApurST[nI,4] == "014.01"
      	RecLock("R10",.T.)
	    R10->TIPO	:=cTipo
	    R10->LINHA	:="119"
	    R10->COLUNA	:=cColuna
        R10->VALOR  := aApurST[nI,3]
        R10->(MsUnLock())
		nFem := R10->VALOR


        If R10->(MsSeek("10"+"082"+"00"))
          RecLock("R10",.F.)
          R10->VALOR := R10->VALOR - aApurST[nI,3]
          R10->(MsUnLock())
        Endif

        If R10->(MsSeek("10"+"102"+"00"))
          RecLock("R10",.F.)
          R10->VALOR := R10->VALOR - aApurST[nI,3]
          R10->(MsUnLock())
        Endif
    Endif

	// Registro 119 - 82.1 Estorno do FEM - adicionado ao ICMS ST
    If aApurST[nI,4] == "008.01"
      	RecLock("R10",.T.)
	    R10->TIPO	:=cTipo
	    R10->LINHA	:="119"
	    R10->COLUNA	:=cColuna
        R10->VALOR  := aApurST[nI,3]
        R10->(MsUnLock())
    Endif

    If aApurST[nI,4] == "014.02"
     If !R10->(MsSeek("10"+"122"+"00"))
	      	RecLock("R10",.T.)
		    R10->TIPO	:=cTipo
		    R10->LINHA	:="122"
		    R10->COLUNA	:=cColuna
	        R10->VALOR  := aApurST[nI,3]
	        R10->(MsUnLock())
	  else
	      RecLock("R10",.F.)
          R10->VALOR := aApurST[nI,3]+ nFemST
          R10->(MsUnLock())
	  Endif
    Endif

    // REGISTRO 126 -- 77.1 - Valor do complemento do ICMS ST + FEM - Aspecto quantitativo

	If aApurST[nI,4] == "002.01"
      	RecLock("R10",.T.)
	    R10->TIPO	:=cTipo
	    R10->LINHA	:="126"
	    R10->COLUNA	:=cColuna
        R10->VALOR  := aApurST[nI,3]
        R10->(MsUnLock())

        If R10->(MsSeek("10"+"126"+"00"))
          RecLock("R10",.F.)
          R10->VALOR := R10->VALOR - aApurST[nI,3]
          R10->(MsUnLock())
        Endif

    Endif

	// REGISTRO 128 -- 82.2 - FEM informativo ,Valor do complemento do FEM adicionado ao d้bito do ICMS ST

	If aApurST[nI,4] == "008.01"
      	RecLock("R10",.T.)
	    R10->TIPO	:=cTipo
	    R10->LINHA	:="128"
	    R10->COLUNA	:=cColuna
        R10->VALOR  := aApurST[nI,3]
        R10->(MsUnLock())
    Endif


    If aApurST[nI,4] == "007.70"
		RecLock("R10",.T.)
		R10->TIPO	:=cTipo
		R10->LINHA	:="070"
		R10->COLUNA	:="00"
	    R10->VALOR  := aApurST[nI,3]
	    R10->(MsUnLock())
        R10->(MsUnLock())
	Endif
Next nI

//Linha 125 do Registro 10, carrega o valor de DIFAL
If (TcSrvType()<>"AS/400")
	cAliasF0I := GetNextAlias()
	BeginSql Alias cAliasF0I
		SELECT
			SUM(F0I.F0I_DEBDIF) TOTDIF,
			SUM(F0I.F0I_CRDDIF) TOTCRDDIF
		FROM
			%Table:F0I% F0I
		WHERE
			F0I.F0I_FILIAL=%xFilial:F0I% AND
			F0I.F0I_PER= %Exp:DToS(dDataIni)% AND
			F0I.F0I_UF=%Exp:cUF% AND
			F0I.%NotDel%
	EndSql

		nVlDifal := (cAliasF0I)->TOTDIF
		nVlCrdDif := (cAliasF0I)->TOTCRDDIF

	(cAliasF0I)->(DbCloseArea())
EndIf

If nVlDifal > 0
	RecLock("R10",.T.)
	R10->TIPO		:=cTipo
	R10->LINHA		:="125"
	R10->COLUNA	:="00"
	R10->VALOR 	:= nVlDifal
	R10->(MsUnLock())
EndIf

If nVlCrdDif > 0
	RecLock("R10",.T.)
	R10->TIPO		:=cTipo
	R10->LINHA		:="124"
	R10->COLUNA	:="00"
	R10->VALOR 	:= nVlCrdDif
	R10->(MsUnLock())
EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณTotalizadores  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
//Pega o valor das Dedu็๕es da linha 098 para atualizar os totais
If R10->(MsSeek("10"+"098"+"00"))
	nLin98 := Round(R10->VALOR,2)
EndIf
If !R10->(MsSeek(cTipo+"072"+cColuna))
    RecLock("R10",.T.)
    R10->TIPO		:=cTipo
    R10->LINHA		:="072"
    R10->COLUNA	:= if (cColuna == "","00",cColuna)
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		+=nTotCred + nVlCrdDif
 	R10->(MsUnLock())

If !R10->(MsSeek(cTipo+"089"+cColuna))
    RecLock("R10",.T.)
    R10->TIPO		:=cTipo
    R10->LINHA		:="089"
    R10->COLUNA	:= if (cColuna == "","00",cColuna)
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		+=nTotCred + nVlCrdDif
 	R10->(MsUnLock())

If !R10->(MsSeek(cTipo+"075"+cColuna))
    RecLock("R10",.T.)
    R10->TIPO		:=cTipo
    R10->LINHA		:="075"
    R10->COLUNA	:= if (cColuna == "","00",cColuna)
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		+=nTotDeb+nVlDifal
	R10->(MsUnLock())

If !R10->(MsSeek(cTipo+"094"+cColuna))
    RecLock("R10",.T.)
    R10->TIPO		:=cTipo
    R10->LINHA		:="094"
    R10->COLUNA	:= if (cColuna == "","00",cColuna)
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		+=nTotDeb+nVlDifal
 	R10->(MsUnLock())

If !R10->(MsSeek("10"+"091"+"00"))
	RecLock("R10",.T.)
	R10->TIPO		:=	"10"
	R10->LINHA		:=	"091"
	R10->COLUNA		:=	"00"
Else
	RecLock("R10",.F.)
EndIf
	R10->VALOR		+=	nTotCred + nVlCrdDif
	R10->(MsUnLock())
	nLin91			+=	R10->VALOR

If !R10->(MsSeek("10"+"096"+"00"))
	RecLock("R10",.T.)
	R10->TIPO		:=	"10"
	R10->LINHA		:=	"096"
	R10->COLUNA		:=	"00"
Else
	RecLock("R10",.F.)
EndIf
	R10->VALOR		+=	nTotDeb + nTotEstCrd + nVlDifal
	R10->(MsUnLock())
	nLin96			+=	R10->VALOR

If nLin91 > nLin96 // Se tiver creditos
	nTot := 0
	nCred :=Round(nLin91,2)-Round(nLin96,2) // Saldo Credor -->Outros Creditos(apuracao)
Else
	nTot:=Round(nLin96,2)-Round(nLin91,2)
Endif

If !R10->(MsSeek("10"+"092"+"00"))
    RecLock("R10",.T.)
    R10->TIPO		:="10"
    R10->LINHA		:="092"
    R10->COLUNA		:="00"
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		:=nCred
    R10->(MsUnLock())

If !R10->(MsSeek("10"+"097"+"00"))
    RecLock("R10",.T.)
    R10->TIPO		:="10"
    R10->LINHA		:="097"
    R10->COLUNA		:="00"
Else
    RecLock("R10",.F.)
Endif
    R10->VALOR		:=nTot
    R10->(MsUnLock())

If !R10->(MsSeek("10"+"099"+"00"))
    RecLock("R10",.T.)
    R10->TIPO		:="10"
    R10->LINHA		:="099"
    R10->COLUNA		:="00"
Else
    RecLock("R10",.F.)
Endif
R10->VALOR		:=nTot-nLin98
R10->(MsUnLock())

If !R10->(MsSeek(cTipo+"131"+cColuna))
	RecLock("R10",.T.)
	R10->TIPO		:= cTipo
	R10->LINHA		:= "131"
	R10->COLUNA		:= IIF(Empty(cColuna), "00", cColuna) //DSERFIS1-10829
Else
	RecLock("R10",.F.)
Endif
If nTot - nValCol131 > 0
	R10->VALOR		:= nTot := nTot - nValCol131
Else
	R10->VALOR		:= nTot
EndIf
R10->(MsUnLock())

If !R10->(MsSeek(cTipo+"105"+"00"))
	RecLock("R10",.T.)
	R10->TIPO		:=	"10"
    R10->LINHA		:=	"105"
    R10->COLUNA		:=	"00"
Else
	RecLock("R10",.F.)
Endif
	R10->VALOR		:= nTot+n101+n102+nDifAliq+n103 -(nLin98+nFem)
	R10->(MsUnLock())

//-- Campo 110 - Total ICMS Antecipado = 106 + 107 + 108 + 109
If !R10->(MsSeek("10"+"110"+"00"))
	RecLock("R10",.T.)
	R10->TIPO		:="10"
	R10->LINHA		:="110"
	R10->COLUNA		:="00"
Else
	RecLock("R10",.F.)
Endif
	R10->VALOR	+=	n110
	R10->(MsUnLock())

Return(.t.)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณTabRS     ณ Autor ณThiago Galvao Silveira ณ Data ณ17.04.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Cria e monta arquivo temporแrio com os dados da Tabela     ณฑฑ
ฑฑณ			 ณanexa ao Decreto n 35.160/94                                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณ SIGAFIS                                                    ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
/*/

Function TabRS(nOpc)
Local aTabela	:= {}
Local nPos		:= 0
Local nValor    := 0
Local cFator	:= GetNewPar("MV_UPFRS","")
Local nFator    := 0

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณDados da Tabela ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aTabela,{01,00000,00625,0100,00})
AADD(aTabela,{02,00626,00720,0097,00})
AADD(aTabela,{03,00721,00840,0094,01})
AADD(aTabela,{04,00841,00980,0090,02})
AADD(aTabela,{05,00981,01140,0086,02})
AADD(aTabela,{06,01141,01320,0080,03})
AADD(aTabela,{07,01321,01530,0075,03})
AADD(aTabela,{08,01531,01780,0068,04})
AADD(aTabela,{09,01781,02070,0061,04})
AADD(aTabela,{10,02071,02400,0053,05})
AADD(aTabela,{11,02401,02800,0044,05})
AADD(aTabela,{12,02801,03250,0036,06})
AADD(aTabela,{13,03251,03770,0027,06})
AADD(aTabela,{14,03771,04380,0019,07})
AADD(aTabela,{15,04381,05080,0011,08})
AADD(aTabela,{16,05081,05900,0006,09})
AADD(aTabela,{17,05901,06840,0002,10})
AADD(aTabela,{18,06841,07960,0001,11})
AADD(aTabela,{19,07961,09230,0.50,12})
AADD(aTabela,{20,09231,10700,0.38,13})
AADD(aTabela,{21,10701,12420,0.01,14})
AADD(aTabela,{22,12421,14500,0.00,15})

cAno	:= Substr(_aTotal[01],1,4)
cFator	:= Subs(cFator,AT(cAno,cFator)+5,7)
nFator	:= VAL(cFator)
nValor	:= (MV_PAR08/nFator)
nPos	:=	Ascan(aTabela,{|x| nValor >= x[2] .and. nValor <= x[3] })

if nOpc==1
   _aTotal[98]	:= (aTabela[nPos,4]/100)
else
   _aTotal[98]	:= aTabela[nPos,5]
endif

Return(_aTotal[98])
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณSRF325    ณ Autor ณ Nereu Humberto Junior ณ Data ณ16.06.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณPreparacao dos arquivos para serem utilizados na SRF325     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpN1: [1] Inicializacao                                    ณฑฑ
ฑฑณ          ณ       [2] Finalizacao                                      ณฑฑ
ฑฑณ          ณExpD2: Data Inicial                                         ณฑฑ
ฑฑณ          ณExpD3: Data Final                                           ณฑฑ
ฑฑณ          ณExpA4: Array de Controle                                    ณฑฑ
ฑฑณ          ณExpN1: [1] Insumos                                          ณฑฑ
ฑฑณ          ณ       [2] Produtos Envasados                               ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function SRF325(nTipo,dDataIni,dDataFim,aControle,nTipProd,cFilDe,cFilAte,aEmpresa,lAutomato)

Local aArea       := GetArea()
Local aStruTRB    := {}
Local aAreaSm0    := SM0->(GetArea())
Local aStruSD1    := SD1->(dbStruct())
Local aStruSD2    := SD2->(dbStruct())
Local aStruSB1    := SB1->(dbStruct())
Local cAliasSD1   := "SD1"
Local cAliasSD2   := "SD2"
Local cAliasSB1   := "SB1"
Local cAliasSB5   := "SB5"
Local cQuery      := ""
Local cIndSD1	  := ""
Local cIndSD2	  := ""
Local cIndSB1	  := ""
Local cChave	  := ""
Local cFiltro	  := ""
Local cDec        := ""
Local cProd       := ""
Local cTpDecl     := ""
Local cCfop1      := cCfop2 := cCfop3 := cCfop4 := ""
Local cCfop5      := cCfop6 := cCfop7 := cCfop8 := cCfop9 := ""
Local cNCM        := ""
Local cEX         := ""
Local cLocal      := ""
Local cDecBusca   := ""
Local lQuery      := .F.
Local lValido     := .F.
Local nX          := 0
Local nVolReci    := 0
Local nCapacidade := 0
Local nEstDec1    := 0
Local nEstDec2    := 0
Local nTotEnt     := 0
Local nTotSai     := 0
Local nPos        := 0
Local nEstInicio  := 0
Local nAdquirido  := 0
Local nRecTrensf  := 0
Local nRecIndust  := 0
Local nOutrasEnt  := 0
Local nInutiliza  := 0
Local nRevendido  := 0
Local nOutrasTrf  := 0
Local nOutrasAid  := 0
Local nEstFinal   := 0
Local nPreCom     := 0
Local nDevolucao  := 0
Local nVendas     := 0
Local nEnvasados  := 0
Local nInsumo     := 0
Local nCodigoSRF  := 0
Local nUtiliza    := 0
Local i           := 0
Local aSaldo      :={}
Local aLocais     :={}
Local nJ          :=1

Private aListBox  :={}
Private	aMsg	  :={}
Private	aSel	  :={}
Private	aValid	  :={}
Private	aConteudo :={}

Default cFilDe    :=cFilAnt
Default cFilAte   :=cFilAnt
Default aEmpresa  :={}
Default lAutomato :=.F.

If nTipo == 1
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Chama arquivo de configuracao SRF325.CFP  ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	SRF325CFOP(lAutomato)

	cConteudo := MemoRead("SRF325.CFP")
	nLinhas	  := MlCount(cConteudo,254)
	For i:=1 to nLinhas
		cLinha	:=	AllTrim(MemoLine(cConteudo,254,i))
		If Substr(cLinha,2,3) == "001" //Insumos Adquiridos
		    cCfop1 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "002" //Insumos Recebidos em Transferencia
			cCfop2 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "003" //Insumos Recebidos para Industrializacao por Encomenda
			cCfop3 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "004" //Outras entradas de Insumos
			cCfop4 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "005" //Insumos Inutilizados
			cCfop5 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "006" //Insumos Revendidos
			cCfop6 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "007" //Insumos Transferidos para outro Estabelecimento
			cCfop7 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "008" //Outras Saidas de Insumos
			cCfop8 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "009" //Vendas de Produtos Envasados
			cCfop9 := Substr(cLinha,8)
		ElseIf Substr(cLinha,2,3) == "010" //Tipo Declara็ใo
			cTpDecl:= Substr(cLinha,8,1)
		Endif
	Next
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Cria os arquivo temporarios para a normativa - SRF325        ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	aControle := {}

	AADD(aStruTRB,{"NCM"	    ,"C",008,0})
	AADD(aStruTRB,{"CODIGO"	    ,"C",015,0})
	AADD(aStruTRB,{"DECENDIO"	,"C",007,0})
	AADD(aStruTRB,{"EX"    		,"C",002,0})
	AADD(aStruTRB,{"INSUMO" 	,"N",003,0})
	AADD(aStruTRB,{"ESTINICIO"	,"N",014,3})
	AADD(aStruTRB,{"ADQUIRIDO"	,"N",013,3})
	AADD(aStruTRB,{"RECTRANSF"	,"N",013,3})
	AADD(aStruTRB,{"RECINDUST"	,"N",013,3})
	AADD(aStruTRB,{"OUTRASENT"	,"N",013,3})
	AADD(aStruTRB,{"INUTILIZA"	,"N",013,3})
	AADD(aStruTRB,{"REVENDIDO"	,"N",013,3})
	AADD(aStruTRB,{"OUTRASTRF"	,"N",013,3})
	AADD(aStruTRB,{"OUTRASAID"	,"N",013,3})
	AADD(aStruTRB,{"ESTFINAL"	,"N",014,3})
	AADD(aStruTRB,{"EMISSAO" 	,"D",008,0})
	AADD(aStruTRB,{"VOLRECI" 	,"N",005,0})
	AADD(aStruTRB,{"PRECOM" 	,"N",012,2})
	AADD(aStruTRB,{"DEVOLUCAO" 	,"N",010,2})
	AADD(aStruTRB,{"VENDAS" 	,"N",010,2})
	AADD(aStruTRB,{"ENVASADOS" 	,"N",010,2})
	AADD(aStruTRB,{"CODIGOSRF" 	,"N",006,0})
	AADD(aStruTRB,{"DLOCAL" 	,"C",002,0})
	AADD(aStruTRB,{"UTILIZA"	,"N",013,3})
	AADD(aStruTRB,{"FILB5"		,"C",002,0})

	cArqTRB	:=	CriaTrab(aStruTRB)
	dbUseArea(.T.,__LocalDriver,cArqTRB,"TRB")
	IndRegua("TRB",cArqTRB,"Str(CODIGOSRF,6)+Str(INSUMO,3)+Str(VOLRECI,5)+CODIGO+DECENDIO")
    cArqTRB2  := CriaTrab(NIL,.F.)
    IndRegua("TRB",cArqTRB2,"NCM+Str(INSUMO,3)+Str(VOLRECI,5)+DECENDIO")
    DbClearIndex()
    DbSetIndex(cArqTRB+OrdBagExt())
    DbSetIndex(cArqTRB2+OrdBagExt())
    DbSetOrder(1)

	aadd(aControle,{"TRB",cArqTRB})
	aadd(aControle,{"TRB",cArqTRB2})
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMonto no array aEmpresa todas as filiais da empresa correnteณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	cFilAte := Iif (Empty (cFilAte+cFilDe), cFilAnt, cFilAte)
	cFilDe  := Iif (Empty (cFilAte+cFilDe), cFilAnt, cFilDe)
	//
	If Empty(aEmpresa)
		DbSelectArea ("SM0")
		SM0->(DbSeek (cEmpAnt+cFilDe, .T.))
		Do While !SM0->(Eof ()) .And. (FWGrpCompany()==cEmpAnt) .And. (FWCodFil()<=cFilAte)
			Aadd( aEmpresa, { .T., SM0->M0_CODFIL, SM0->M0_FILIAL, SM0->M0_CGC, SM0->M0_INSC, SM0->M0_INSCM } )
			SM0->(DbSkip ())
		EndDo
	EndIf
	aSort(aEmpresa,,,{|x,y| x[4]+x[5]+x[6]+x[2] < y[4]+y[5]+x[6]+y[2]}) //-- Ordena por CNPJ, IE, Insc.Municipal e Codigo de Filial para facilitar a quebra de rotinas consolidadas
	RestArea(aAreaSm0)
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณInicio do processamento das filiaisณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Do While (nJ<=Len (aEmpresa))	//Empresas do array aEmpresa
		DbSelectArea("SM0")
		SM0->(DbSeek (FWGrpCompany()+aEmpresa[nJ,2], .T.))
		cFilAnt		:=	FWCodFil()
		//
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Tratamento para Entrada                                      ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		dbSelectArea("SD1")
		dbSetOrder(7)
		#IFDEF TOP
			lQuery := .T.
			cAliasSB1 := "SRF325SD1"
			cAliasSD1 := "SRF325SD1"
			cAliasSB5 := "SRF325SD1"

		    cQuery := "SELECT SD1.*,SB1.B1_POSIPI, SB1.B1_EX_NCM, SB1.B1_COD, SB5.B5_INSUMO, SB5.B5_VOLRECI, SB5.B5_CODISRF, SB5.B5_COD "
		    cQuery += "FROM "+RetSqlName("SD1")+" SD1, "
		    cQuery += RetSqlName("SB1")+" SB1, "
	    	cQuery += RetSqlName("SB5")+" SB5 "
		    cQuery += "WHERE SD1.D1_FILIAL='"+F3Filial("SD1")+"' AND "
			cQuery += "SD1.D1_DTDIGIT BETWEEN '"+DTOS(dDataIni)+"' AND '"+DTOS(dDataFim)+"' AND "
		    cQuery += "SD1.D_E_L_E_T_=' ' AND "
	    	cQuery += "SD1.D1_TIPO IN ('N','D','B') AND "
		    cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
		    cQuery += "SB1.B1_COD=SD1.D1_COD AND "
		    If nTipProd == 1
	   		    cQuery += "(SB1.B1_POSIPI IN('39011010','39011091','39011092','39012011','39012019','39012021','39012029') OR "
	   		    cQuery += "SB1.B1_POSIPI IN('39021010','39021020','39023000','39076000','39232110','39232190','39233000') OR "
				cQuery += "SB1.B1_POSIPI IN('39235000','45031000','48115122','48115923','70109011','70109021','70109090') OR "
				cQuery += "SB1.B1_POSIPI IN('73102110','73102910','76129019','83091000','83099000') ) AND "
	   		ElseIf nTipProd == 2
	   		   	cQuery += "(SB1.B1_POSIPI LIKE '2201%' OR SB1.B1_POSIPI LIKE '2202%' OR SB1.B1_POSIPI LIKE '2203%' OR SB1.B1_POSIPI LIKE '2204%' OR "
			   	cQuery += "SB1.B1_POSIPI LIKE '2205%' OR SB1.B1_POSIPI LIKE '2206%' OR SB1.B1_POSIPI LIKE '2208%') AND "
	   		Endif
		    cQuery += "SB1.D_E_L_E_T_=' ' AND "
	    	cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
		    cQuery += "SB5.B5_COD=SD1.D1_COD AND "
		    cQuery += "SB5.D_E_L_E_T_=' '  "

	    	cQuery += "ORDER BY "+SqlOrder(SD1->(IndexKey()))

		    cQuery := ChangeQuery(cQuery)
		    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1)
		    For nX := 1 To Len(aStruSD1)
		   	 	If aStruSD1[nX][2]<>"C"
					TcSetField(cAliasSD1,aStruSD1[nX][1],aStruSD1[nX][2],aStruSD1[nX][3],aStruSD1[nX][4])
				EndIf
	   	    Next nX
		#ELSE
			dbSelectArea(cAliasSD1)
			cIndSD1	:=	CriaTrab(NIL,.F.)
			cChave	:=	IndexKey()
			cFiltro	:=	"D1_FILIAL=='"+F3Filial("SD1")+"'"
			cFiltro	+=	" .And. DTOS(D1_DTDIGIT)>='"+DTOS(dDataIni)+"' .AND. DTOS(D1_DTDIGIT)<='"+DTOS(dDataFim)+"' .AND. D1_TIPO$'NDB'"
			IndRegua(cAliasSD1,cIndSD1,cChave,,cFiltro)
			nIndex := RetIndex("SD1")
			dbSelectArea("SD1")
			dbSetIndex(cIndSD1+OrdBagExt())

			dbSetOrder(nIndex+1)
			dbSelectArea(cAliasSD1)
			dbGoTop()
		#ENDIF

		While (cAliasSD1)->(!Eof())
			lValido := .F.

			SB1->(dbSetOrder(1))
			SB1->(MsSeek(xFilial("SB1")+(cAliasSD1)->D1_COD))
			nVolReci := &(SuperGetMv("MV_VOLRECI"))


			If !lQuery

				SB5->(dbSetOrder(1))
				lValido := SB5->(MsSeek(xFilial("SB5")+(cAliasSD1)->D1_COD))

				If nTipProd == 1
				    If nTipProd == 1 .And. lValido .And. ;
					    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39011010#39011091#39011092#39012011#39012019#39012021#39012029" .And.;
			   		    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39021010#39021020#39023000#39076000#39232110#39232190#39233000" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "39235000#45031000#48115122#48115923#70109011#70109021#70109090" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "73102110#73102910#76129019#83091000#83099000"
						lValido := .F.
					Endif
				ElseIf nTipProd == 2 .And. lValido
					If !(Left((cAliasSB1)->B1_POSIPI,4) $ "2201#2202#2203#2204#2205#2206#2208")
						lValido := .F.
					Endif
				Endif
			Else
				lValido := .T.
			EndIf

			SF4->(dbSetOrder(1))
			SF4->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
			If SF4->F4_ESTOQUE <> "S"
				lValido := .F.
			Endif

			If lValido .And. (cAliasSB5)->B5_INSUMO<>0
				If cTpDecl=="1" // mensal
					cDec := SubStr(DTOS((cAliasSD1)->D1_DTDIGIT),1,6)+"0"
				Else
					cDec := SubStr(DTOS((cAliasSD1)->D1_DTDIGIT),1,6)+IIF(Day((cAliasSD1)->D1_DTDIGIT)<=10,"1",IIF(Day((cAliasSD1)->D1_DTDIGIT)<=20,"2","3"))
				Endif
				dbSelectArea("TRB")
				nCapacidade:= Iif (nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
				If !MsSeek(Str((cAliasSB5)->B5_CODISRF,6)+Str((cAliasSB5)->B5_INSUMO,3)+Str(nCapacidade,5)+(cAliasSB5)->B5_COD+cDec)
					RecLock("TRB",.T.)
					TRB->CODIGO := (cAliasSB1)->B1_COD
					TRB->NCM := (cAliasSB1)->B1_POSIPI
					TRB->DECENDIO := cDec
					TRB->EX  := (cAliasSB1)->B1_EX_NCM
					TRB->INSUMO  := (cAliasSB5)->B5_INSUMO
					TRB->CODIGOSRF := (cAliasSB5)->B5_CODISRF
					TRB->VOLRECI := IIF(nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
					TRB->EMISSAO := (cAliasSD1)->D1_DTDIGIT
				    TRB->DLOCAL := (cAliasSD1)->D1_LOCAL
				    TRB->FILB5  := xFilial ("SB5")
					If Substr(cDec,7,1) == "1" .Or. Substr(cDec,7,1) == "0"
						aSaldo := CalcEst((cAliasSD1)->D1_COD,(cAliasSD1)->D1_LOCAL,dDataIni)
						TRB->ESTINICIO := aSaldo[1]
					Endif
				    MsUnlock()
				Else
					RecLock("TRB",.F.)
					If Substr(cDec,7,1) == "1" .Or. Substr(cDec,7,1) == "0"
						aSaldo := CalcEst((cAliasSD1)->D1_COD,(cAliasSD1)->D1_LOCAL,dDataIni)
						TRB->ESTINICIO += aSaldo[1]
					Endif
				    MsUnlock()
				Endif

				RecLock("TRB",.F.)
				TRB->ADQUIRIDO += IIF(AllTrim((cAliasSD1)->D1_CF) $ cCfop1, (cAliasSD1)->D1_QUANT,0)
				TRB->RECTRANSF += IIF(AllTrim((cAliasSD1)->D1_CF) $ cCfop2, (cAliasSD1)->D1_QUANT,0)
				TRB->RECINDUST += IIF(AllTrim((cAliasSD1)->D1_CF) $ cCfop3, (cAliasSD1)->D1_QUANT,0)
				TRB->OUTRASENT += IIF(AllTrim((cAliasSD1)->D1_CF) $ cCfop4, (cAliasSD1)->D1_QUANT,0)
				TRB->DEVOLUCAO += IIF((cAliasSD1)->D1_TIPO == "D", (cAliasSD1)->D1_QUANT,0)
				MsUnLock()
				nPos := Ascan(aLocais,{|x|x[1]==(cAliasSD1)->D1_COD .And. x[2]==(cAliasSD1)->D1_LOCAL .And. x[3]==(cAliasSB5)->B5_CODISRF .And. x[4]==(cAliasSB5)->B5_INSUMO .And. x[5]==(cAliasSB5)->B5_VOLRECI .And. x[6]==(cAliasSB5)->B5_COD})
				If nPos==0
					Aadd(aLocais,{(cAliasSD1)->D1_COD,(cAliasSD1)->D1_LOCAL,(cAliasSB5)->B5_CODISRF, (cAliasSB5)->B5_INSUMO,(cAliasSB5)->B5_VOLRECI,(cAliasSB5)->B5_COD})
	            Endif
	        EndIf
			dbSelectArea(cAliasSD1)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSD1)
			dbCloseArea()
			dbSelectArea("SD1")
		Else
			dbSelectArea("SD1")
			RetIndex("SD1")
			dbClearFilter()
			Ferase(cIndSD1+OrdBagExt())
		EndIf

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณ Tratamento para Saida                                        ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		dbSelectArea("SD2")
		dbSetOrder(7)
		#IFDEF TOP
			lQuery := .T.
			cAliasSB1 := "SRF325SD2"
			cAliasSD2 := "SRF325SD2"
			cAliasSB5 := "SRF325SD2"

		    cQuery := "SELECT SD2.*,SB1.B1_POSIPI, SB1.B1_EX_NCM, SB1.B1_COD, SB5.B5_INSUMO, SB5.B5_VOLRECI, SB5.B5_CODISRF, SB5.B5_COD "
		    cQuery += "FROM "+RetSqlName("SD2")+" SD2, "
		    cQuery += RetSqlName("SB1")+" SB1, "
	    	cQuery += RetSqlName("SB5")+" SB5 "
		    cQuery += "WHERE SD2.D2_FILIAL='"+F3Filial("SD2")+"' AND "
			cQuery += "SD2.D2_EMISSAO BETWEEN '"+DTOS(dDataIni)+"' AND '"+DTOS(dDataFim)+"' AND "
		    cQuery += "SD2.D_E_L_E_T_=' ' AND "
		    cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
		    cQuery += "SB1.B1_COD=SD2.D2_COD AND "
		    If nTipProd == 1
	   		    cQuery += "(SB1.B1_POSIPI IN('39011010','39011091','39011092','39012011','39012019','39012021','39012029') OR "
	   		    cQuery += "SB1.B1_POSIPI IN('39021010','39021020','39023000','39076000','39232110','39232190','39233000') OR "
				cQuery += "SB1.B1_POSIPI IN('39235000','45031000','48115122','48115923','70109011','70109021','70109090') OR "
				cQuery += "SB1.B1_POSIPI IN('73102110','73102910','76129019','83091000','83099000') ) AND "
	  		ElseIf nTipProd == 2
	   		   	cQuery += "(SB1.B1_POSIPI LIKE '2201%' OR SB1.B1_POSIPI LIKE '2202%' OR SB1.B1_POSIPI LIKE '2203%' OR SB1.B1_POSIPI LIKE '2204%' OR "
			   	cQuery += "SB1.B1_POSIPI LIKE '2205%' OR SB1.B1_POSIPI LIKE '2206%' OR SB1.B1_POSIPI LIKE '2208%') AND "
	   		Endif
		    cQuery += "SB1.D_E_L_E_T_=' ' AND "
	    	cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
		    cQuery += "SB5.B5_COD=SD2.D2_COD AND "
		    cQuery += "SB5.D_E_L_E_T_=' '  "

	    	cQuery += "ORDER BY "+SqlOrder(SD2->(IndexKey()))

		    cQuery := ChangeQuery(cQuery)
		    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2)
		    For nX := 1 To Len(aStruSD2)
		   	 	If aStruSD2[nX][2]<>"C"
					TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
				EndIf
	   	    Next nX
		#ELSE
			dbSelectArea(cAliasSD2)
			cIndSD2	:=	CriaTrab(NIL,.F.)
			cChave	:=	IndexKey()
			cFiltro	:=	"D2_FILIAL=='"+F3Filial("SD2")+"'"
			cFiltro	+=	" .And. DTOS(D2_EMISSAO)>='"+DTOS(dDataIni)+"' .AND. DTOS(D2_EMISSAO)<='"+DTOS(dDataFim)+"'"
			IndRegua(cAliasSD2,cIndSD2,cChave,,cFiltro)
			nIndex := RetIndex("SD2")
			dbSelectArea("SD2")
			dbSetIndex(cIndSD2+OrdBagExt())

			dbSetOrder(nIndex+1)
			dbSelectArea(cAliasSD2)
			dbGoTop()
		#ENDIF

		While (cAliasSD2)->(!Eof())
			lValido := .F.

			SB1->(MsSeek(xFilial("SB1")+(cAliasSD2)->D2_COD))
			nVolReci := &(SuperGetMv("MV_VOLRECI"))

			If !lQuery

				SB5->(dbSetOrder(1))
				lValido := SB5->(MsSeek(xFilial("SB5")+(cAliasSD2)->D2_COD))

				If nTipProd == 1
				    If nTipProd == 1 .And. lValido .And. ;
					    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39011010#39011091#39011092#39012011#39012019#39012021#39012029" .And.;
			   		    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39021010#39021020#39023000#39076000#39232110#39232190#39233000" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "39235000#45031000#48115122#48115923#70109011#70109021#70109090" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "73102110#73102910#76129019#83091000#83099000"
						lValido := .F.
					Endif
				ElseIf nTipProd == 2 .And. lValido
					If !(Left((cAliasSB1)->B1_POSIPI,4) $ "2201#2202#2203#2204#2205#2206#2208")
						lValido := .F.
					Endif
				Endif
			Else
				lValido := .T.
			EndIf

			SF4->(dbSetOrder(1))
			SF4->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))
			If SF4->F4_ESTOQUE <> "S"
				lValido := .F.
			Endif

			If lValido .And. (cAliasSB5)->B5_INSUMO<>0
				If cTpDecl=="1" //Mensal
					cDec := SubStr(DTOS((cAliasSD2)->D2_EMISSAO),1,6)+"0"
				Else
					cDec := SubStr(DTOS((cAliasSD2)->D2_EMISSAO),1,6)+IIF(Day((cAliasSD2)->D2_EMISSAO)<=10,"1",IIF(Day((cAliasSD2)->D2_EMISSAO)<=20,"2","3"))
				Endif

				dbSelectArea("TRB")
				nCapacidade := Iif (nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
				If !MsSeek(Str((cAliasSB5)->B5_CODISRF,6)+Str((cAliasSB5)->B5_INSUMO,3)+Str(nCapacidade,5)+(cAliasSB5)->B5_COD+cDec)
					RecLock("TRB",.T.)
					TRB->CODIGO := (cAliasSB1)->B1_COD
					TRB->NCM := (cAliasSB1)->B1_POSIPI
					TRB->DECENDIO := cDec
					TRB->EX  := (cAliasSB1)->B1_EX_NCM
					TRB->INSUMO  := (cAliasSB5)->B5_INSUMO
					TRB->CODIGOSRF := (cAliasSB5)->B5_CODISRF
					TRB->VOLRECI := IIF(nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
					TRB->EMISSAO := (cAliasSD2)->D2_EMISSAO
					TRB->DLOCAL := (cAliasSD2)->D2_LOCAL
					TRB->FILB5  := xFilial ("SB5")
					If Substr(cDec,7,1) == "1" .Or. Substr(cDec,7,1) == "0"
						aSaldo := CalcEst((cAliasSD2)->D2_COD,(cAliasSD2)->D2_LOCAL,dDataIni)
						TRB->ESTINICIO := aSaldo[1]
					Endif
				    MsUnlock()
				Endif
				RecLock("TRB",.F.)
				TRB->INUTILIZA += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop5, (cAliasSD2)->D2_QUANT,0)
				TRB->REVENDIDO += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop6, (cAliasSD2)->D2_QUANT,0)
				TRB->OUTRASTRF += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop7, (cAliasSD2)->D2_QUANT,0)
				TRB->OUTRASAID += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop8, (cAliasSD2)->D2_QUANT,0)
				TRB->VENDAS    += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop9, (cAliasSD2)->D2_QUANT,0)
				TRB->PRECOM    += IIF(AllTrim((cAliasSD2)->D2_CF) $ cCfop9, (cAliasSD2)->D2_TOTAL,0)
				MsUnLock()
				nPos := Ascan(aLocais,{|x|x[1]==(cAliasSD2)->D2_COD .And. x[2]==(cAliasSD2)->D2_LOCAL .And. x[3]==(cAliasSB5)->B5_CODISRF .And. x[4]==(cAliasSB5)->B5_INSUMO .And. x[5]==(cAliasSB5)->B5_VOLRECI .And. x[6]==(cAliasSB5)->B5_COD})
				If nPos==0
					Aadd(aLocais,{(cAliasSD2)->D2_COD,(cAliasSD2)->D2_LOCAL,(cAliasSB5)->B5_CODISRF,(cAliasSB5)->B5_INSUMO,(cAliasSB5)->B5_VOLRECI,(cAliasSB5)->B5_COD})
	            Endif
	        EndIf
			dbSelectArea(cAliasSD2)
			dbSkip()
		EndDo
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณConsidera-se todos produtos com saldo anterior que nao tiveram movimentacoes no periodo de apuracao.ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		dbSelectArea("SB1")
		dbSetOrder(1)
		#IFDEF TOP
			lQuery 		:= .T.
			cAliasSB1 	:= "SRF325SB1"
			cAliasSB5 	:= "SRF325SB1"
		    cQuery := "SELECT SB1.B1_COD,SB1.B1_LOCPAD,SB1.B1_POSIPI,SB1.B1_EX_NCM,SB5.B5_INSUMO,SB5.B5_VOLRECI,SB5.B5_CODISRF, SB5.B5_COD "
		    cQuery += "FROM "+RetSqlName("SB1")+" SB1, "
	    	cQuery += RetSqlName("SB5")+" SB5 "
		    cQuery += "WHERE SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
		    cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
		    cQuery += "SB1.B1_COD=SB5.B5_COD AND "
		    If nTipProd == 1
	   		    cQuery += "(SB1.B1_POSIPI IN('39011010','39011091','39011092','39012011','39012019','39012021','39012029') OR "
	   		    cQuery += "SB1.B1_POSIPI IN('39021010','39021020','39023000','39076000','39232110','39232190','39233000') OR "
				cQuery += "SB1.B1_POSIPI IN('39235000','45031000','48115122','48115923','70109011','70109021','70109090') OR "
				cQuery += "SB1.B1_POSIPI IN('73102110','73102910','76129019','83091000','83099000') ) AND "
	  		ElseIf nTipProd == 2
	   		   	cQuery += "(SB1.B1_POSIPI LIKE '2201%' OR SB1.B1_POSIPI LIKE '2202%' OR SB1.B1_POSIPI LIKE '2203%' OR SB1.B1_POSIPI LIKE '2204%' OR "
			   	cQuery += "SB1.B1_POSIPI LIKE '2205%' OR SB1.B1_POSIPI LIKE '2206%' OR SB1.B1_POSIPI LIKE '2208%') AND "
	   		Endif
		    cQuery += "SB1.D_E_L_E_T_=' ' "

	    	cQuery += "ORDER BY "+SqlOrder(SB1->(IndexKey()))

		    cQuery := ChangeQuery(cQuery)
		    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB1)
		    For nX := 1 To Len(aStruSB1)
		   	 	If aStruSB1[nX][2]<>"C"
					TcSetField(cAliasSB1,aStruSB1[nX][1],aStruSB1[nX][2],aStruSB1[nX][3],aStruSB1[nX][4])
				EndIf
	   	    Next nX
		#ELSE
			dbSelectArea(cAliasSB1)
			cIndSB1	:=	CriaTrab(NIL,.F.)
			cChave	:=	IndexKey()
			cFiltro	:=	"B1_FILIAL=='"+xFilial("SB1")+"'"
			IndRegua(cAliasSB1,cIndSB1,cChave,,cFiltro)
			nIndex := RetIndex("SB1")
			dbSelectArea("SB1")
			dbSetIndex(cIndSB1+OrdBagExt())

			dbSetOrder(nIndex+1)
			dbSelectArea(cAliasSB1)
			dbGoTop()
		#ENDIF

		If cTpDecl=="1" // mensal
			cDec := SubStr(DToS(MV_PAR01),1,6)+"0"
		Else
			cDec := SubStr(DToS(MV_PAR01),1,6)+IIF(Day(MV_PAR01)<=10,"1",IIF(Day(MV_PAR01)<=20,"2","3"))
		Endif

		Do While !(cAliasSB1)->(Eof ())

			If !lQuery

				SB5->(dbSetOrder(1))
				lValido := SB5->(MsSeek(xFilial("SB5")+(cAliasSB1)->B1_COD))

				If nTipProd == 1
				    If nTipProd == 1 .And. lValido .And. ;
					    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39011010#39011091#39011092#39012011#39012019#39012021#39012029" .And.;
			   		    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39021010#39021020#39023000#39076000#39232110#39232190#39233000" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "39235000#45031000#48115122#48115923#70109011#70109021#70109090" .And.;
						!Alltrim((cAliasSB1)->B1_POSIPI) $ "73102110#73102910#76129019#83091000#83099000"
						lValido := .F.
					Endif
				ElseIf nTipProd == 2 .And. lValido
					If !(Left((cAliasSB1)->B1_POSIPI,4) $ "2201#2202#2203#2204#2205#2206#2208")
						lValido := .F.
					Endif
				Endif
			Else
				lValido := .T.
			EndIf

			If lValido
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณApenas acrescenta o saldo inicial dos produtos que nใo foram processados nas entradas, saidas ou movimentos de producao.ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				//
				nVolReci := &(SuperGetMv("MV_VOLRECI"))
				//
				nCapacidade := Iif (nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
				If !TRB->(MsSeek (Str((cAliasSB5)->B5_CODISRF,6)+Str((cAliasSB5)->B5_INSUMO,3)+Str(nCapacidade,5)+(cAliasSB5)->B5_COD))
					aSaldo := CalcEst((cAliasSB1)->B1_COD,(cAliasSB1)->B1_LOCPAD,dDataIni)
					//
					If (aSaldo[1]>0)

						RecLock ("TRB", .T.)
							TRB->CODIGO 	:= 	(cAliasSB1)->B1_COD
							TRB->NCM 		:= 	(cAliasSB1)->B1_POSIPI
							TRB->DECENDIO	:= 	cDec
							TRB->EX  		:=  (cAliasSB1)->B1_EX_NCM
							TRB->INSUMO  	:= 	(cAliasSB5)->B5_INSUMO
							TRB->CODIGOSRF 	:=	(cAliasSB5)->B5_CODISRF
							TRB->VOLRECI 	:=	Iif (nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
							TRB->EMISSAO 	:= 	MV_PAR01
							TRB->DLOCAL 	:=	(cAliasSB1)->B1_LOCPAD
							TRB->ESTINICIO	:=	aSaldo[1]
						    TRB->FILB5  	:=  xFilial("SB5")
						MsUnLock ()
					EndIf
				EndIf
				//
			Endif
			(cAliasSB1)->(DbSkip ())
		EndDo
		//-----------> FIM ALTERACAO
		//
		aLocais := aSort(aLocais,,,{|x,y| x[1] < y[1] })

		A325Producao(aLocais,dDataIni,dDataFim,nTipProd,cTpDecl)

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณInsere os saldos iniciais nos dec๊ndios sem movimentacaoณ
		//|Tanto para os insumos quanto para os envasados          |
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		TRB->(dbSetOrder(1))
		TRB->(dbGoTop())

		If cTpDecl=="2"  //Decendio
			While ! TRB->(Eof())
				If Str(nCodigoSRF,6)+Str(nInsumo,3)+Str(nVolReci,5)+cProd <> Str(TRB->CODIGOSRF,6)+Str(TRB->INSUMO,3)+Str(TRB->VOLRECI,5)+TRB->CODIGO
					nRecno 		:= TRB->(Recno())
					cProd  		:= TRB->CODIGO
					cNCM		:= TRB->NCM
					cEX			:= TRB->EX
					nInsumo 	:= TRB->INSUMO
					nCodigoSRF 	:= TRB->CODIGOSRF
					nVolReci	:= TRB->VOLRECI
					cLocal  	:= TRB->DLOCAL
					cDec 		:= SubStr(TRB->DECENDIO,1,6)

					For nX := 1 to 3
						cDecBusca := AllTrim(cDec)+Str(nX,1)
						If ! TRB->(dbSeek(Str(nCodigoSRF,6)+Str(nInsumo,3)+Str(nVolReci,5)+cProd+cDecBusca))
							RecLock("TRB",.T.)
							If nX == 1
								aSaldo := CalcEst(cProd,cLocal,dDataIni)
								TRB->ESTINICIO 	:= aSaldo[1]
							Endif
							TRB->CODIGO 	:= cProd
							TRB->NCM 		:= cNCM
							TRB->DECENDIO 	:= cDecBusca
							TRB->EX  		:= cEX
							TRB->INSUMO  	:= nInsumo
							TRB->CODIGOSRF 	:= nCodigoSRF
							TRB->VOLRECI 	:= nVolReci
							TRB->DLOCAL 	:= cLocal
							// Datas iniciais de cada decendio
							If nX == 1
								TRB->EMISSAO := CtoD("01/"+SubStr(cDecBusca,5,2)+"/"+SubStr(cDecBusca,1,4))
							Elseif nX == 2
								TRB->EMISSAO := CtoD("11/"+SubStr(cDecBusca,5,2)+"/"+SubStr(cDecBusca,1,4))
							ElseIf nX == 3
								TRB->EMISSAO := CtoD("21/"+SubStr(cDecBusca,5,2)+"/"+SubStr(cDecBusca,1,4))
							Endif
						    MsUnlock()
						    TRB->(dbGoTo(nRecno))
						Endif
					Next
				Endif
				cProd  := TRB->CODIGO
				nCodigoSRF	:= TRB->CODIGOSRF
				nInsumo := TRB->INSUMO
				nVolreci := TRB->VOLRECI
		        TRB->(dbSkip())
		    Enddo
		Endif

		dbSelectArea("TRB")
		dbSetOrder(1)
		dbGoTop()
		While !Eof()
			cProd 		:= TRB->CODIGO
			cDec  		:= TRB->DECENDIO
			nCodigoSRF	:= TRB->CODIGOSRF
			nInsumo		:= TRB->INSUMO
			nVolreci 	:= TRB->VOLRECI
			nTotEnt  	:= 0
			nTotSai  	:= 0

			While !Eof() .And. Str(TRB->CODIGOSRF,6)+ Str(TRB->INSUMO,3)+ Str(TRB->VOLRECI,5)+TRB->CODIGO+TRB->DECENDIO == Str(nCodigoSRF,6)+Str(nInsumo,3)+Str(nVolreci,5)+cProd+cDec
				If nTipProd == 1 // Total de insumos
			   		nTotEnt  += TRB->ADQUIRIDO+TRB->RECTRANSF+TRB->RECINDUST+TRB->OUTRASENT
					nTotSai  += TRB->UTILIZA+TRB->INUTILIZA+TRB->REVENDIDO+TRB->OUTRASTRF+TRB->OUTRASAID
				Else // Total de envasados
			   		nTotEnt  += TRB->ENVASADOS+TRB->RECTRANSF+TRB->DEVOLUCAO+TRB->OUTRASENT
					nTotSai  += TRB->VENDAS+TRB->OUTRASTRF+TRB->INUTILIZA+TRB->OUTRASAID
				Endif
			    nRecno := TRB->(Recno())
			    dbSkip()

		    	If Str(TRB->CODIGOSRF,6)+Str(TRB->INSUMO,3)+Str(TRB->VOLRECI,5)+TRB->CODIGO+TRB->DECENDIO <> Str(nCodigoSRF,6)+Str(nInsumo,3)+Str(nVolreci,5)+cProd+cDec
			    	nRecno2 := TRB->(Recno())
			    	TRB->(dbGoTo(nRecno))
			    	RecLock("TRB",.F.)
					If Substr(TRB->DECENDIO,7,1) == "1" .Or. Substr(TRB->DECENDIO,7,1) == "0"
						TRB->ESTFINAL := (TRB->ESTINICIO+nTotEnt)-nTotSai
						nEstDec1 += TRB->ESTFINAL
					ElseIf Substr(TRB->DECENDIO,7,1) == "2"
						TRB->ESTINICIO := nEstDec1
						TRB->ESTFINAL  := (TRB->ESTINICIO+nTotEnt)-nTotSai
						nEstDec2 += TRB->ESTFINAL
					ElseIf Substr(TRB->DECENDIO,7,1) == "3"
						TRB->ESTINICIO := nEstDec2
						TRB->ESTFINAL  := (TRB->ESTINICIO+nTotEnt)-nTotSai
					Endif
					MsUnlock()
		   			TRB->(dbGoTo(nRecno2))
	   				If TRB->CODIGOSRF+TRB->INSUMO+TRB->VOLRECI <> nCodigoSRF+nInsumo+nVolreci
	   					nEstDec1 := 0
						nEstDec2 := 0
					Endif
				Endif
			EndDo
		EndDo

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณFaz o tratamento referente a NCM + Cod. Insumo + Capacidade + Decendio    ณ
		//ณPodem existir produtos distintos no sistema com essa mesma caracteristica,ณ
		//ณmas na geracao da DIF deve-se gerar um unico registro.                    ณ
	    //|Somente para nTipoProd == 1 (Insumos)                                     |
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	    If nTipProd == 1
			dbSelectArea("TRB")
			TRB->(dbSetOrder(2))
			TRB->(dbGoTop())
			While !TRB->(Eof())

				cChave := TRB->NCM+Str(TRB->INSUMO,3)+Str(TRB->VOLRECI,5)+TRB->DECENDIO

				nEstInicio  := TRB->ESTINICIO
				nAdquirido  := TRB->ADQUIRIDO
				nRecTrensf  := TRB->RECTRANSF
				nRecIndust  := TRB->RECINDUST
				nOutrasEnt  := TRB->OUTRASENT
				nInutiliza  := TRB->INUTILIZA
				nRevendido  := TRB->REVENDIDO
				nOutrasTrf  := TRB->OUTRASTRF
				nOutrasAid  := TRB->OUTRASAID
				nEstFinal   := TRB->ESTFINAL
				nPreCom     := TRB->PRECOM
				nDevolucao  := TRB->DEVOLUCAO
				nVendas     := TRB->VENDAS
				nEnvasados  := TRB->ENVASADOS
				nUtiliza	:= TRB->UTILIZA

				nRecno := TRB->(Recno())

				While !Eof() .And. cChave == TRB->NCM+Str(TRB->INSUMO,3)+Str(TRB->VOLRECI,5)+TRB->DECENDIO

				    TRB->(dbSkip())

				    If cChave == TRB->NCM+Str(TRB->INSUMO,3)+Str(TRB->VOLRECI,5)+TRB->DECENDIO
						nEstInicio  += TRB->ESTINICIO
						nAdquirido  += TRB->ADQUIRIDO
						nRecTrensf  += TRB->RECTRANSF
						nRecIndust  += TRB->RECINDUST
						nOutrasEnt  += TRB->OUTRASENT
						nInutiliza  += TRB->INUTILIZA
						nRevendido  += TRB->REVENDIDO
						nOutrasTrf  += TRB->OUTRASTRF
						nOutrasAid  += TRB->OUTRASAID
						nEstFinal   += TRB->ESTFINAL
						nPreCom     += TRB->PRECOM
						nDevolucao  += TRB->DEVOLUCAO
						nVendas     += TRB->VENDAS
						nEnvasados  += TRB->ENVASADOS
						nUtiliza	+= TRB->UTILIZA
						RecLock("TRB",.F.,.T.)
						TRB->(dbDelete())
						MsUnlock()
					Else
						TRB->(dbGoTo(nRecno))
						RecLock("TRB",.F.)
						TRB->ESTINICIO	:= nEstInicio
						TRB->ADQUIRIDO	:= nAdquirido
						TRB->RECTRANSF	:= nRecTrensf
						TRB->RECINDUST	:= nRecIndust
						TRB->OUTRASENT	:= nOutrasEnt
						TRB->INUTILIZA	:= nInutiliza
						TRB->REVENDIDO	:= nRevendido
						TRB->OUTRASTRF	:= nOutrasTrf
						TRB->OUTRASAID	:= nOutrasAid
						TRB->ESTFINAL	:= nEstFinal
						TRB->PRECOM		:= nPreCom
						TRB->DEVOLUCAO	:= nDevolucao
						TRB->VENDAS		:= nVendas
						TRB->ENVASADOS	:= nEnvasados
						TRB->UTILIZA	:= nUtiliza
						MsUnlock()
						TRB->(dbSkip())
					Endif
				EndDo
			EndDo
        EndIf

		TRB->(dbSetOrder(1))

		If lQuery
			dbSelectArea(cAliasSD2)
			dbCloseArea()
			dbSelectArea("SD2")
			dbSelectArea(cAliasSB1)
			dbCloseArea()
			dbSelectArea("SB1")
		Else
			dbSelectArea("SD2")
			RetIndex("SD2")
			dbClearFilter()
			Ferase(cIndSD2+OrdBagExt())
			dbSelectArea("SB1")
			RetIndex("SB1")
			dbClearFilter()
			Ferase(cIndSB1+OrdBagExt())
		EndIf
        //
        nJ++
    EndDo
    RestArea (aAreaSm0)
	cFilAnt		:=	FWCodFil()
Else
	For nX := 1 To Len(aControle)
        If nX == 1
			dbSelectArea(aControle[nX][1])
			dbCloseArea()
			FErase(aControle[nX][2]+GetDbExtension())
		Endif
		FErase(aControle[nX][2]+OrdBagExt())
	Next nX
	dbSelectArea("SX1")
EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Restaura area                                                ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
RestArea(aArea)

Return(.T.)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ  SRF325CFOP  ณ Autor ณNereu Humberto Jr. ณ Data ณ 17/06/03 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Monta Gets p/digitacao dos CFOPS utilizados na DIF-Bebidas ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function SRF325CFOP(lAutomato)

Local cValid  :=""
Local i		  :=1
Local nOpcA	  :=2
Local lRet	  :=.F.
Local oDlgGet
Local oListBox

AADD(aListBox,STR0047);AADD(aSel,.f.);AADD(aMsg,"")                 ;AADD(aValid,"")  //"CFOP's utilizados na DIF - Bebidas"
AADD(aListBox," ")    ;AADD(aSel,.f.);AADD(aMsg,"")                 ;AADD(aValid,"")
AADD(aListBox,STR0048);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0001 - Insumos Adquiridos"
AADD(aListBox,STR0049);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0002 - Insumos Recebidos em Transferencia"
AADD(aListBox,STR0050);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0003 - Insumos Recebidos para Industrializacao por Encomenda"
AADD(aListBox,STR0051);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0004 - Outras entradas de Insumos"
AADD(aListBox,STR0052);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0005 - Insumos Inutilizados"
AADD(aListBox,STR0053);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0006 - Insumos Revendidos"
AADD(aListBox,STR0054);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0007 - Insumos Transferidos para outro Estabelecimento"
AADD(aListBox,STR0055);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0008 - Outras Saidas de Insumos"
AADD(aListBox,STR0056);AADD(aSel,.t.);AADD(aMsg,"Informe os CFOP's");AADD(aValid,"") //"0009 - Vendas de Produtos Envasados"
AADD(aListBox," ")    ;AADD(aSel,.f.);AADD(aMsg,"")                 ;AADD(aValid,"")
AADD(aListBox,STR0103);AADD(aSel,.f.);AADD(aMsg,"")                 ;AADD(aValid,"")  //"Tipo da Declara็ใo da DIF - Bebidas"
AADD(aListBox," ")    ;AADD(aSel,.f.);AADD(aMsg,"")                 ;AADD(aValid,"")
AADD(aListBox,STR0102);AADD(aSel,.t.);AADD(aMsg,"Informe o Tipo da Declara็ใo 1=Mensal, 2=Decendial");AADD(aValid,"A325Valid('C','TIPO')") //"0010 - Tipo de Declara็ใo - 1=Mensal, 2=Decendial"

For i:=1 to Len(aListBox)
	aListBox[i]:=OemToAnsi(aListBox[i])
	aMsg[i]:=OemToAnsi(aMsg[i])
Next

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Le informacoes do arquivo de configuracao SRF325.CFP ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
A325LoadIni("SRF325.CFP")
if !lAutomato
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Ativa ListBox com opcoes para o array da configuracao ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	DEFINE MSDIALOG oDlgGet TITLE OemtoAnsi("Instru็ใo Normativa - SRF325") FROM  180,110 TO 400,700 PIXEL OF oMainWnd
	@ 10, 20 SAY Oemtoansi("Itens de Configura็ใo DIF - Bebidas") SIZE 100, 07 OF oDlgGet PIXEL
	@ 26, 18 TO 091, 277 LABEL "" OF oDlgGet PIXEL
	@ 33,22 LISTBOX oListBox VAR cVar FIELDS HEADER "" ON DBLCLICK (A325GetList(oListBox)) SIZE 250,50 PIXEL
	oListBox:SetArray(aListBox)
	oListBox:bLine := { ||{aListBox[oListBox:nAt]}}

	DEFINE SBUTTON FROM 095, 220 TYPE 1 ACTION (nOpca:=1,oDlgGet:End()) ENABLE OF oDlgGet
	DEFINE SBUTTON FROM 095, 248 TYPE 2 ACTION (nOpca:=2,oDlgGet:End()) ENABLE OF oDlgGet

	ACTIVATE MSDIALOG oDlgGet
endif

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Grava itens no arquivo de configuracao SRF325.CFP ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If nOpcA==1 .or. lAutomato
	A325GravaIt("SRF325.CFP")
Else
	lRet	:=	.T.
Endif


Return(lRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณA325LoadIni ณAutorณ     Marcos Simidu     ณ Data ณ 27.03.96 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณCarrega conteudo do arquivo SRF325.CFP                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณMATA977                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function A325LoadIni(ArqIni)

Local i	:=	0
Local cConteudo :=	""

If File(ArqIni)
	For i	:=	1 to Len(aListBox)
		cConteudo	:=	""
		If IsDigit(Substr(aListBox[i],2,4))
			cConteudo	:=	A325LeSRF(Substr(aListBox[i],2,4))
			If Len(cConteudo)<254
				cConteudo	:=	cConteudo+Space(254-Len(cConteudo))
			EndIf
		Endif
		AADD(aConteudo,cConteudo)
	Next
Else
	For i:=1 to Len(aListBox)
		AADD(aConteudo,Space(254))
	Next
Endif

Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ A325LeSRF()  ณ Autor ณ Juan Jose Pereira ณ Data ณ 27.07.95 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Le Arquivo SRF325.CFP                                      ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function A325LeSRF(cCPO,lEnd)

Local cIni		:=	""
Local cArqIni	:=	"SRF325.CFP"
Local cConteudo:=	""
Local	i:=0

lEnd	:=	If(lEnd==NIL,.F.,lEnd)
cCPO	:=	"["+cCPO+"]="

If !File(cArqIni)
	Help(" ",1,"SRF325.CFP")
	lContinua:=	.f.
	lEnd		:=	.T.
	Return(cIni)
Else
	cConteudo	:=	MemoRead(cArqIni)
	nLinhas		:=	MlCount(cConteudo,254)
	For i:=1 to nLinhas
		cLinha	:=	AllTrim(MemoLine(cConteudo,254,i))
		If cCPO$cLinha
			cIni	:=	Substr(cLinha,8)
			Exit
		Endif
	Next
Endif

Return(cIni)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ A325GravaIt  ณ Autor ณ Juan Jose Pereira ณ Data ณ 27.07.95 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Grava arquivo de configuracao .CFP                         ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function A325GravaIt(ArqIni)

LOCAL cArqBkp
LOCAL aGravar	:=	{}
LOCAL i

cArqBkp	:=	StrTran(ArqIni,".CFP",".#CF")
If File(cArqBkp)
	Ferase(cArqBkp)
Endif
FRename(ArqIni,cArqBkp)
nHandle	:=	MSFCREATE(ArqIni)

For i	:=	1 to Len(aListBox)
	If IsDigit(Substr(aListBox[i],2,4))
		AADD(aGravar,"["+Substr(aListBox[i],2,4)+"]="+Rtrim(aConteudo[i])+Chr(13)+Chr(10))
	EndIf
Next
For i	:=	1 to Len(aGravar)
	FWrite(nHandle,aGravar[i],Len(aGravar[i]))
Next
FClose(nHandle)

Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณA325GetList ณAutorณ Juan Jose Pereira     ณ Data ณ 27.03.96 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณAtiva Get para edicao de Elemento relacionado ao ListBox    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณMATA977                                                     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function A325GetList(oListBox)

Local oDlgGet2
Local nOpcaGet	:=	2
Local lUpdated	:=	.F.
Local bValid
Private cCampo	:=	"cCpoItem"

nAt	:=	oListBox:nAt

Private cValid	:=	"{||"+aValid[nAt]+"}"

If aSel[nAt]
	&cCampo	:=	aConteudo[nAt]
	bValid	:=	&(cValid)
	DEFINE MSDIALOG oDlgGet2 TITLE aMsg[nAt] FROM  300,100 TO 400,620 PIXEL OF oListBox
	@ 08, 20 TO 27, 237 LABEL "" OF oDlgGet2 PIXEL

	@ 15, 24 MSGET &cCampo PICTURE "@!" VALID Eval(bValid) SIZE 210, 08 OF oDlgGet2 PIXEL

	DEFINE SBUTTON FROM 032, 182 TYPE 1 ACTION (lUpdated:=.t.,oDlgGet2:End()) ENABLE OF oDlgGet2
	DEFINE SBUTTON FROM 032, 210 TYPE 2 ACTION (lUpdated:=.f.,oDlgGet2:End()) ENABLE OF oDlgGet2

	ACTIVATE MSDIALOG oDlgGet2
	If lUpdated
		aConteudo[nAt]	:=	StrTran(&cCampo,'"',"'")
	Endif
Endif

Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ  A325Valid() ณ Autor ณLuciana Pires      ณ Data ณ 21.07.06 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Valida itens do ListBox.                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function A325Valid(cTipo,cCampo)
Local lRet		:= .T.
Local cConteudo	:= &(ReadVar())
Local n			:= 1

cConteudo	:=	Alltrim(cConteudo)
cCampo		:=	(If(cCampo==NIL," ",cCampo))
cTipo		:=	(If(cTipo==NIL," ",cTipo))

If cCampo=="TIPO"
	If !(cConteudo$"12").Or.Len(Alltrim(cConteudo))>1
		lRet:=.F.
	Endif
Endif

Return(lRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณMd5Icms   ณ Autor ณGustavo G. Rueda       ณ Data ณ27.01.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณPreparacao do meio-magnetico, chamado atraves de um INI     ณฑฑ
ฑฑณ          ณpela instrucoes normativas.                                 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet = Retornando Sucesso ou Falha da funcao.       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpD - dDataIni = Parametro de data inicial.                ณฑฑ
ฑฑณ          ณExpD - dDataFim = Parametro de data final.                  ณฑฑ
ฑฑณ          ณExpC - cDirEst = Parametro de diretorio destino.            ณฑฑ
ฑฑณ          ณExpC - cTitulo = Parametro de titulo do formBatch.          ณฑฑ
ฑฑณ          ณExpA - aMensagem = Parametro de mensagem do FormBatch.      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function Md5Icms(dDataIni, dDataFim, cDirDest, cTitulo, aMensagem, cModelosNf, aFilsCalc, cRotina)
	Local	aArea	:=	GetArea ()
	Local	lRet	:=	.F.
	Local	nOpca	:=	1
	Local	cPerg	:=	"D5ICMS"
	Local   cDriver :=  MV_PAR05
	Local   cFilOrig:=  cFilAnt

	Local	lAutomato	:= iif(IsBlind(),.T.,.F.)

	DEFAULT cRotina := ""

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณMV_PAR01 = Arq. Tipo M = Registro mestre dos documentos fiscais.                               ณ
	//ณMV_PAR02 = Arq. Tipo I = Registro de Itens dos documentos fiscais.                             ณ
	//ณMV_PAR03 = Arq. Tipo D = Registro de dados cadastrais dos destinatarios dos documentos fiscais.ณ
	//ณMV_PAR04 = Tipo do arquivo (2=Substituto, 1=Normal).                                           ณ
	//ณMV_PAR05 = Tipo de midia. (1=CD-R, 2=DVD-R).                                                   ณ
	//ณMV_PAR06 = Qtd. Regist. Perm.
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Pergunte (cPerg, .T.)
	//
	if !lAutomato
		FormBatch (OemToAnsi (cTitulo), aMensagem,;
			{{5, .T., {|o| Pergunte (cPerg, .T.)}},;
			{ 1, .T., {|o| nOpca := 1, o:oWnd:End()}},;
			{ 2, .T., {|o| nOpca := 2, o:oWnd:End()}}})
	endif 
	//
	If (nOpca==1)
		FwMsgRun (,{|| lRet := D5Proc(cPerg, dDataIni, dDataFim, AllTrim (cDirDest), AllTrim (MV_PAR01), AllTrim (MV_PAR02),;
			AllTrim (MV_PAR03), MV_PAR04, MV_PAR05, cModelosNf, aFilsCalc, cRotina)}, OemToAnsi(STR0061), OemToAnsi(STR0062))	//"Aguarde..."###"Processando registros conforme parametros."
		//
		lRet	:=	.T.
	EndIf
	// Volto o valor do parametro pois quando roda mais de uma filial esta perdendo o Driver.
	MV_PAR05 := cDriver
	RestArea (aArea)
	cFilAnt := cFilOrig
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณD5Proc    ณ Autor ณGustavo G. Rueda       ณ Data ณ27.01.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao de processamento do meio-magnetico.                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet = Retornando Sucesso ou Falha da funcao.       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC - cPerg = Nome da pergunta do SX1.                     ณฑฑ
ฑฑณ          ณExpD - dDataDe - Data de informada na pergunta.             ณฑฑ
ฑฑณ          ณExpD - dDataAte - Data ate informada na pergunta.           ณฑฑ
ฑฑณ          ณExpC - cDiretorio - Diretorio destrinos dos arquivos a seremณฑฑ
ฑฑณ          ณ	gerados.                                                  ณฑฑ
ฑฑณ          ณExpC - cNormaM - Instrucao normativa para processamento do  ณฑฑ
ฑฑณ          ณ	arquivo tipo M.                                           ณฑฑ
ฑฑณ          ณExpC - cNormaI - Instrucao normativa para processamento do  ณฑฑ
ฑฑณ          ณ	arquivo tipo I.                                           ณฑฑ
ฑฑณ          ณExpC - cNormaD - Instrucao normativa para processamento do  ณฑฑ
ฑฑณ          ณ	arquivo tipo D.                                           ณฑฑ
ฑฑณ          ณExpN - nTipoArq - Tipo do arquivo(1=Normal/2=substituto).   ณฑฑ
ฑฑณ          ณExpN - nTipoMidia - Tipo de midia(1=CD-R/2=DVD).            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function D5Proc(cPerg, dDataDe, dDataAte, cDiretorio, cNormaM, cNormaI, cNormaD, nTipoArq, nTipoMidia, cModelosNf, aFilsCalc, cRotina)
	Local	oMd5IcmsDados	:= Md5IcmsDados():new()
	Local 	oCashSX3		:= oMd5IcmsDados:getCashSX3()
	Local 	oCashSX6		:= oMd5IcmsDados:getCashSX6()
	Local 	oCashMvSX3		:= oMd5IcmsDados:getCashMvSX3()
	Local	lCv115A17		:= Alltrim(Str(Year(dDataDe))) >= '2017'
	Local	aArqsAbr		:=	R79EstrArq (dDataDe,lCv115A17)
	Local	aMestre			:=	{}
	Local	cTipoArq		:=	Iif (nTipoArq==1, "N", "S")
	Local	cAliasSFT		:=	"SFT"
	Local	cSerie			:=	""
	Local 	cFisGetSerie	:=  ""
	Local	cAno			:=	""
	Local	cMes			:=	""
	Local	cNomeArq		:=	""
	Local	cMCorrente		:=	""
	Local	cDCorrente		:=	""
	Local	cICorrente		:=	""
	Local	aMvD5ICMS		:=	&(oCashSX6["MV_D5ICMS"])
	Local	lExistCAT79		:=	IIF(ValType(aMvD5ICMS)=="A".And.Len(aMvD5ICMS)>0,.T.,.F.)
	Local	lCmpAss			:=	.F.
	Local	lCmpUti			:=	.F.
	Local	lCmpNumtc		:=	.F.
	Local	lCmpTen			:=	.F.
	Local	lCmpClIt		:=	.F.
	Local	lCmpTpCli		:=	.F.
	Local	lCmpNumTm		:=	.F.
	Local	lCmpContr		:=	.F.
	Local	lCmpIsenc		:=	.F.
	Local	nOpca			:=	1
	Local	nPosM			:=	0
	Local	nI				:=	0
	Local	nProxRegItem	:=	0
	Local	nItem			:=	0
	Local	nRegPerm		:=	Iif (nTipoMidia==1, 1000000, 0)
	Local	lContinua		:=	.T.
	Local	lConteudo		:=	.T.
	Local	lContEnd		:=	.T.
	Local	lRet			:=	.T.
	Local	lGeraCad		:=	.T.
	Local	nOrdCadMes		:=	0
	Local	cChaveNf		:=	""
	Local	cAutDig1		:=	""
	Local	cAutDig2		:=	""
	Local	cNumNf			:=	""
	Local	cCNPJ			:=	""
	Local	cIE				:=	""
	Local	cCFOP			:=	""
	Local	cTpCGC			:=	""
	Local	cSubCl			:=	""
	Local	cTerm			:=	""
	Local	cContrat		:=	""
	Local 	cModel			:=	""
	Local	cIsenRed		:=	""
	Local	cEspec			:=	""
	Local 	dDataVazio		:=	STOD("//")
	Local	dLeitAnt		:=	dDataVazio
	Local	dLeitAtu		:=	dDataVazio
	Local	cMVMD579		:=	oCashSX6["MV_MD579"]
	Local	aEndCob			:=	&(oCashSX6["MV_ENDCOB"])
	Local	lEndCob79		:=	Iif(ValType(aEndCob)=="A".And.Len(aEndCob)>0,.T.,.F.)
	Local	lEnd			:=	.F.
	Local	lCep			:=	.F.
	Local	lBairro			:=	.F.
	Local	lMunic			:=	.F.
	Local	lUf				:=	.F.
	Local	lSimples		:=	Iif(oCashSX6["MV_SIMPLES"]=="S",.T.,.F.)
	Local	nForFilial		:=	0
	Local	cProd			:=	''
	Local	lSFU_NFCEE		:=	cPaisLoc == "BRA" 		.And. ;
								oCashSX3["FU_SUBCLC"] 	.And. ;
								oCashSX3["FU_AREATER"] 	.And. ;
								oCashSX3["FU_TERMINA"] 	.And. ;
								oCashSX3["FU_DTANT"]
	Local lTipLiga 		:= oCashSX3["FU_TIPLIGA"]
	Local lVldCpos		:= .F.
	Local aInfosMES		:= {"",""}
	Local lCv115Mun		:= ExistBlock("CV115MUN")
	Local cCmpUti		:= ''
	Local cCmpClIt		:= ''
	Local lSFX			:= .F.
	Local lSFU			:= .F.
	Local lCv128A17		:= cRotina == "CONV128" .And. Alltrim(Str(Year(dDataDe))) >= '2017'
	Local lMdCt79		:= FindFunction("xFisMdCt79")	
	////////////////////////////////////////////////////////////////////////////////////////////
	Local nDataEm   	:= 	0
	Local cAnoMes		:= 	" "
	Local nDesc			:=	0
	Local nAcres		:= 	0
	Local cSituac		:=	" "
	Local nAliqIcms		:=	0		
	Local cUFit			:= " "	
	Local cGetDB		:= TcGetDb()
	Local lOracle		:= cGetDB $ "INFORMIX*ORACLE" 	
	Local lPostGre  	:= cGetDB == "POSTGRES"
	Local lAutomato		:= iif(IsBlind(),.T.,.F.)
	Local cUf			:= oCashSX6["MV_ESTADO"]
	Local nTamFTNFiscal := TamSx3("FT_NFISCAL")[1]
	Local cVlidDoc		:= ""
	Local nLenA1Inscr	:=	0
	Local cTPAssVld		:= "" //aMvD5ICMS[1] ou '0' ou '1'
	Local cFaseVld		:= "" //aMvD5ICMS[2] ou '1'
	Local cGrpVld		:= "" //aMvD5ICMS[3] ou '00'
	Local cCodClVld		:= "" //aMvD5ICMS[5] ou '0101'
	Local cNTelVld		:= "" //aMvD5ICMS[4] ou '0000000000'
	Local cTpCliVld		:= "" //aMvD5ICMS[6] ou '01'
	Local cEndVld		:= "" //aEndCob[1] ou A1_END
	Local cCepVld		:= "" //aEndCob[2] ou A1_CEP
	Local cBairVld		:= "" //aEndCob[3] ou A1_BAIRRO
	Local cMuniVld		:= "" //aEndCob[4] ou A1_MUN
	Local cUFVld		:= "" //aEndBob[5] ou A1_EST

	DEFAULT cRotina := ""

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณHelp Informativo sobre o parametro MV_D5ICMSณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If lExistCAT79
		lCmpAss			:=	oCashMvSX3["MV_A1_PASS"]
		lCmpUti			:=	oCashMvSX3["MV_A1_UTI"]
		lCmpTen			:=	oCashMvSX3["MV_A1_TEN"]
		lCmpNumtc		:=	oCashMvSX3["MV_A1_NUMTC"]
		lCmpClIt		:=	oCashMvSX3["MV_B5_CLIT"]
		lCmpTpCli		:=	oCashMvSX3["MV_A1_TPCLI"]
		If lCv115A17
			lCmpNumTm	:=	oCashMvSX3["MV_A1_NUMTM"]
			lCmpContr	:=	oCashMvSX3["MV_A1_CONTR"]
			lCmpIsenc	:=	oCashMvSX3["MV_F4_ISENC"]
		EndIf
	Else
		lConteudo := .F.
	EndIf

	//Validar parametro MV_ENDCOB
	If (lEndCob79)
		If (Len(aEndCob)<>5)
			lContEnd	:=	.F.
		Else
			lEnd		:=	oCashMvSX3["MV_A1_END"]
			lCep		:=	oCashMvSX3["MV_A1_CEP"]
			lBairro		:=	oCashMvSX3["MV_A1_BAIRRO"]
			lMunic		:=	oCashMvSX3["MV_A1_MUNIC"]
			lUf			:=	oCashMvSX3["MV_A1_UF"]
		EndIf
	EndIf

	// Validacao dos campos p/ exibicao do help. Campo da posicao 6 (lCmpTpCli) nao eh utilizado na CAT79.
	lVldCpos := lExistCAT79 .And. lConteudo .And. lCmpAss .And. lCmpUti .And. lCmpTen .And. lCmpClIt .And. lCmpNumtc .And. Iif(lCv115A17, lCmpNumTm .And. lCmpContr .And. lCmpIsenc,.T.) .And. Iif(cRotina <> "CAT79", lCmpTpCli, .T.)
	If !lVldCpos
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณSTR0089 "Parametro inexistente ou conte๚do invแlido. Favor corrigir para que os arquivos"  ณ
		//ณSTR0090 "O Parametro [MV_D5ICMS] nao existe ou seu conteudo e invalido."                   ณ
		//ณSTR0091 "Para que os arquivos sejam gerados corretamente e necessario corrigi-lo."         ณ
		//ณSTR0092 "Formato deste parametro: Seu conteudo e baseado na tabela SA1, portanto deve ser "ณ
		//ณSTR0093 "preenchido com o respectivo campo."                                               ณ
		//ณSTR0094 "Sintaxe: {<campo ref. Tipo assinante entre aspas>, <Campo ref. Tipo utilizacao "  ณ
		//ณSTR0095 "entre aspas>, <Campo ref. Grupo de tensใo entre aspas>, <Classificacao item entre"ณ
		//ณSTR0096 "Deseja continuar?"                                                                ณ
		//ณSTR0097 "aspas>, <Campo ref. Tipo de Cliente entre aspas>}"                                ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		FormBatch (OemToAnsi (STR0089),;
			{OemToAnsi (STR0090), OemToAnsi (STR0091), OemToAnsi (STR0092), OemToAnsi (STR0093), OemToAnsi (STR0094), OemToAnsi (STR0095), OemToAnsi (STR0097)+" "+OemToAnsi (STR0096)},;
			{{1, .T., {|o| nOpca := 1, o:oWnd:End ()}},;
			{ 2, .T., {|o| nOpca := 2, lRet := .F., o:oWnd:End ()}}})
	EndIf
	//
	If (nOpca==1)
		SFT->(DbSetOrder(6)) //FT_FILIAL+FT_TIPOMOV+FT_NFISCAL+FT_SERIE
		For nForFilial := 1 to Len(aFilsCalc)
			If aFilsCalc[nForFilial, 1]
				cFilAnt := aFilsCalc[ nForFilial, 2 ]

				//Refa็o os cashs por filial
				oCashSX6 :=  oMd5IcmsDados:getCashSX6()
				oCashMvSX3 :=  oMd5IcmsDados:getCashMvSX3()
				oCashFil := oMd5IcmsDados:getCashFil()
					
				cAliasSFT := oMd5IcmsDados:qryPriMatxMag(lOracle .Or. lPostGre, nTamFTNFiscal, dDataDe, dDataAte, cModelosNf, lExistCAT79)
				
				Do while !(cAliasSFT)->(Eof()) .And. (lContinua)
					cEspec := aModNot((cAliasSFT)->FT_ESPECIE)

					lSFU := !Empty((cAliasSFT)->(FU_FILIAL+FU_TIPOMOV+FU_SERIE+FU_DOC+FU_CLIFOR+FU_LOJA+FU_ITEM+FU_COD))
					lSFX := !Empty((cAliasSFT)->(FX_FILIAL+FX_TIPOMOV+FX_SERIE+FX_DOC+FX_CLIFOR+FX_LOJA+FX_ITEM+FX_COD))

					If oCashSX3["FX_TIPSERV"] .And. lSFX

						If 	substr(cCmpUti,2,len(cCmpUti)) <> (cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
							Do Case
								Case  (cAliasSFT)->FX_TIPSERV == '0'
									cCmpUti := '1'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
								Case  (cAliasSFT)->FX_TIPSERV == '1'
									cCmpUti := '2'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
								Case  (cAliasSFT)->FX_TIPSERV == '2'
									cCmpUti := '3'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
								Case  (cAliasSFT)->FX_TIPSERV == '3'
									cCmpUti := '4'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
								Case  (cAliasSFT)->FX_TIPSERV == '4'
									cCmpUti := '5'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
								Case  (cAliasSFT)->FX_TIPSERV == '9'
									cCmpUti := '6'+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
							EndCase

							cCmpClIt := (cAliasSFT)->(FX_GRPCLAS+FX_CLASSIF)

							//Trecho abaixo para verificar situa็๕es do campo FX_GRPCLAS legado, pois ele inicialmente possuia tamamtamanho 1 e foi alterado para tamanho 2.
							//Quando o primeiro dํgito ้ diferente de zero, verifico se o tamanho ้ igual a 3, se for entใo inserimos "0" para complementar a informa็ใo
							//Lembrando que trata-se de um mecanismo para que funcione em ambientes legado onde o campo FX_GRPCLAS possui tamanho 1.
							If Substr( cCmpClIt , 1, 1 ) <> "0" .AND. Len( Alltrim(cCmpClIt) ) == 3
								cCmpClIt := "0" + cCmpClIt
							EndIF
						Endif
					ElseIf lTipLiga .And. lSFU .And. !lSFX
						If 	substr(cCmpUti,2,len(cCmpUti)) <> (cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
							cCmpUti  := (cAliasSFT)->FU_TIPLIGA+(cAliasSFT)->(FT_NFISCAL+FT_SERIE+FT_ESPECIE)
							cCmpClIt := (cAliasSFT)->(FU_GRPCLAS+FU_CLASSIF)
						Endif
					Else
						cCmpClIt := ''
						cCmpUti  := ''
					Endif

					cSubCl := "00"
					If lCv115A17 .And. lCmpNumTm
						cTerm := (cAliasSFT)->&(aMvD5ICMS[7])
					Else
						cTerm := "000000000000"
					EndIf

					If lCv115A17 .And. lCmpContr
						cContrat := (cAliasSFT)->&(aMvD5ICMS[8])
					Else
						cContrat := Space(15)
					EndIf

					dLeitAnt := dDataVazio
					dLeitAtu := dDataVazio
					If cEspec == "06" .And. lSFU_NFCEE .And. lSFU .And. Empty((cAliasSFT)->FT_DTCANC) //So pego os dados caso nใo sejam dados excluํdo (nota cancelada)
						cSubCl := (cAliasSFT)->FU_SUBCLC
						dLeitAnt := (cAliasSFT)->FU_DTANT
						dLeitAtu := (cAliasSFT)->FU_DTLEIT
						If lCv115A17
							cTerm := Space(12) //IIf(cRotina=="CAT79",Space(12),"000000000000") informar somente para esp้cies 21 ou 22
						Else
							cTerm := (cAliasSFT)->(FU_AREATER+FU_TERMINA)
						EndIf							
					EndIf

					If (cEspec == "21" .Or. cEspec == "22") .And. lSFX
						dLeitAnt := (cAliasSFT)->FX_DTINI
						dLeitAtu := (cAliasSFT)->FX_DTFIM
					EndIf

					// ----------------------- DECLARACAO DE VARIAVEIS ------------------------- //

					cChaveNf	:= (cAliasSFT)->(DToS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA)
					cCNPJ		:= Repl("0",Len(MES->M_CNPJ)-Len(AllTrim(sfValidDoc ((cAliasSFT)->A1_CGC, .T., .T.))))+AllTrim(sfValidDoc ((cAliasSFT)->A1_CGC, .T., .T.))
					nLenA1Inscr := Len(AllTrim((cAliasSFT)->A1_INSCR))
					cVlidDoc	:= AllTrim(sfValidDoc((cAliasSFT)->A1_INSCR, .T., .T.))

					If Val(cCNPJ) == 0
						cTpCGC	:=	IIf((cAliasSFT)->A1_PESSOA=="F","4","3") //4=Isento CPF ou 3=Isento CNPJ
					Else
						cTpCGC	:=	IIf((cAliasSFT)->A1_PESSOA=="F","2","1") //2=CPF ou 1=CNPJ
					EndIf

					If lCv115A17
						If nLenA1Inscr > 0
							If "ISENTO"$(cAliasSFT)->A1_INSCR
								cIE := PADR((cAliasSFT)->A1_INSCR,Len(MES->M_IE))
							Else
								cIE := Repl("0",Len(MES->M_IE)-Len(cVlidDoc))+cVlidDoc
							EndIf
						Else
							cIE := PADR("ISENTO",Len(MES->M_IE))
						EndIF
					Else
						If nLenA1Inscr > 0
							cIE := Repl("0",Len(MES->M_IE)-Len(cVlidDoc))+cVlidDoc
						Else
							cIE := Repl("0",Len(MES->M_IE)-Len("ISENTO"))+"ISENTO"
						EndIF
					EndIf
					cNumNf		:=  AllTrim((cAliasSFT)->FT_NFISCAL)
					cNumNf		:=	Repl("0",Len(MES->M_NUMERO)-Len(cNumNf))+cNumNf
					cNumNf 		:=  iif(Len(cNumNf) > 9,Substring(cNumNf,-9,9),cNumNf)
					cCFOP		:=  AllTrim((cAliasSFT)->FT_CFOP)
					cCFOP		:=	Repl("0",Len(ITE->I_CFOP)-Len(cCFOP))+cCFOP
					cSerie		:=	Left((cAliasSFT)->FT_SERIE, 3)
					cAno		:=	SubStr(StrZero (Year ((cAliasSFT)->FT_ENTRADA), 4), 3, 2)
					cMes		:=	SubStr(StrZero (Month ((cAliasSFT)->FT_ENTRADA), 2), 1, 2)
					cModel		:=	Iif(cEspec=="28","01",cEspec)
					cFisGetSerie:=  FisGetSer(cSerie,"","","",.F.,.F.,"",.F.,.F.,oCashSX6["MV_ESPNFX5"],oCashSX6["MV_DSSERIE"],oCashSX6["MV_SERCAT"])

					//Iif (lCmpAss, SA1->(FieldGet(FieldPos(aMvD5ICMS[1]))), "1")
					cTPAssVld := "1"
					If lCmpAss
						cTPAssVld := (cAliasSFT)->&(aMvD5ICMS[1])
					EndIf

					//Iif(lCmpUti,SA1->(FieldGet(FieldPos(aMvD5ICMS[2]))),"1")
					cFaseVld := "1"
					If lCmpUti
						cFaseVld := (cAliasSFT)->&(aMvD5ICMS[2])
					EndIf

					//Iif (lCmpTen, SA1->(FieldGet(FieldPos(aMvD5ICMS[3]))), "00")
					cGrpVld := "00"
					If lCmpTen
						cGrpVld := (cAliasSFT)->&(aMvD5ICMS[3])
					EndIf

					//Iif (lCmpNumtc, SA1->(FieldGet(FieldPos(aMvD5ICMS[4]))), Iif(cRotina == "CONV128",Space(12),Iif(dDataDe >= CTOD("01/07/2012"),"0000000000","0000000000")))
					cNTelVld := "0000000000"
					If lCmpNumtc
						cNTelVld := (cAliasSFT)->&(aMvD5ICMS[4])
					ElseIf cRotina == "CONV128"
						cNTelVld := Space(12)
					EndIf

					//Iif(lCmpClIt, SB5->(FieldGet(FieldPos(aMvD5ICMS[5]))), "0101")
					cCodClVld := "0101"
					If lCmpClIt
						cCodClVld := (cAliasSFT)->&(aMvD5ICMS[5])
					ElseIf cRotina == "CONV128" //Iif(lCmpClIt, SB5->(FieldGet(FieldPos(aMvD5ICMS[5]))), Iif(cRotina == "CONV128","5099","0101"))
						cCodClVld := "5099"
					EndIf

					//Iif (lCmpTpCli, SA1->(FieldGet(FieldPos(aMvD5ICMS[6]))), "01")
					cTpCliVld := "01"
					If lCmpTpCli
						cTpCliVld := (cAliasSFT)->&(aMvD5ICMS[6])
					EndIf
					
					//Iif(lContEnd .And. lEndCob79 .And. lEnd,Iif(!Empty(SA1->(FieldGet(FieldPos(aEndCob[1])))),SA1->(FieldGet(FieldPos(aEndCob[1]))),SA1->A1_END),SA1->A1_END)
					cEndVld := (cAliasSFT)->A1_END
					If lContEnd .And. lEndCob79 .And. lEnd .And. !Empty((cAliasSFT)->&(aEndCob[1]))
						cEndVld := (cAliasSFT)->&(aEndCob[1])
					EndIf
					
					//Iif(lContEnd .And. lEndCob79 .And. lCep,   Iif(!Empty(SA1->(FieldGet(FieldPos(aEndCob[2])))),SA1->(FieldGet(FieldPos(aEndCob[2]))),SA1->A1_CEP),   SA1->A1_CEP)
					cCepVld	:= (cAliasSFT)->A1_CEP
					If lContEnd .And. lEndCob79 .And. lCep .And. !Empty((cAliasSFT)->&(aEndCob[2]))
						cCepVld	:= (cAliasSFT)->&(aEndCob[2])
					EndIf

					//Iif(lContEnd .And. lEndCob79 .And. lBairro,Iif(!Empty(SA1->(FieldGet(FieldPos(aEndCob[3])))),SA1->(FieldGet(FieldPos(aEndCob[3]))),SA1->A1_BAIRRO),SA1->A1_BAIRRO)
					cBairVld := (cAliasSFT)->A1_BAIRRO
					If lContEnd .And. lEndCob79 .And. lBairro .And. !Empty((cAliasSFT)->&(aEndCob[3]))
						cBairVld := (cAliasSFT)->&(aEndCob[3])
					EndIf

					//Iif(lContEnd .And. lEndCob79 .And. lMunic,Iif(!Empty(SA1->(FieldGet(FieldPos(aEndCob[4])))),SA1->(FieldGet(FieldPos(aEndCob[4]))),SA1->A1_MUN),SA1->A1_MUN)
					cMuniVld := (cAliasSFT)->A1_MUN
					If lContEnd .And. lEndCob79 .And. lMunic .And. !Empty((cAliasSFT)->&(aEndCob[4]))
						cMuniVld := (cAliasSFT)->&(aEndCob[4])
					EndIf

					//Iif(lContEnd .And. lEndCob79 .And. lUf,Iif(!Empty(SA1->(FieldGet(FieldPos(aEndCob[5])))),SA1->(FieldGet(FieldPos(aEndCob[5]))),SA1->A1_EST),SA1->A1_EST)
					cUFVld := (cAliasSFT)->A1_EST					
					If lContEnd .And. lEndCob79 .And. lUf .And. !Empty((cAliasSFT)->&(aEndCob[5]))						
						cUFVld := (cAliasSFT)->&(aEndCob[5])
					EndIf

					cNomeArq := cUF + cFisGetSerie + cAno + cMes + cTipoArq + "M"
					If lCv115A17
						cNomeArq := cUF + Alltrim(SM0->M0_CGC) + cModel + cFisGetSerie + cAno + cMes + cTipoArq+ "01" + "M"
					EndIf

					nPosM := aScan(aMestre, {|aM| aM[1]==cNomeArq})
					If (nPosM==0)
						aAdd (aMestre, {cNomeArq, 1, 1, 0})
						nPosM := Len(aMestre)
					Else
						If (nRegPerm<>0) .And. (aMestre[nPosM][2]>=nRegPerm)
							aMestre[nPosM][2] := 1
							aMestre[nPosM][3]++
						Else
							aMestre[nPosM][2]++
						EndIf
					EndIf
					aMestre[nPosM][4]++
					nProxRegItem := aMestre[nPosM][4] //Incr.contador de itens

					cMCorrente   := aMestre[nPosM][1]+"."+StrZero(aMestre[nPosM][3], 3)
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณCada registro do arquito MESTRE corresponde a um registro no arquivo de CADASTRO, portanto pode ser utilizado o mesmo nPosM.ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lCv115A17
						cDCorrente := Left(aMestre[nPosM][1], 28)+"D."+StrZero(aMestre[nPosM][3], 3)
					Else
						cDCorrente := Left(aMestre[nPosM][1], 10)+"D."+StrZero(aMestre[nPosM][3], 3)
					EndIf
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณO registro de itens nao tem controle de capacidade, e ilimitado. Portanto, seu nome he alterado conforme o registro MESTRE.ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lCv115A17
						cICorrente := Left(cNomeArq, 28)+"I.001"
					Else
						cICorrente := Left(cNomeArq, 10)+"I.001"
					EndIf

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณGravando registro Mestre.ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lCv115A17
						aInfosMES := C115InfAdd(cAliasSFT, dDataDe, dDataAte, oCashSX6["MV_CANCFOR"], oCashFil)
					EndIf
					If (MES->(DbSeek (PADR(cNumNf,nTamFTNFiscal)+(cAliasSFT)->FT_SERIE+cCNPJ)))
						lGeraCad := .F.
						If !(RecLock ("MES", .F.))
							lContinua := MsgYesNo (STR0085+"MES"+STR0086,STR0087) //"Problemas no lock da tabela de trabalho ["###"]. Deseja continuar?"###"Problemas Lock."
						EndIf
					Else
						//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
						//ณPreciso saber a sequencia dos itens para cada nota gravada no registro mestre.ณ
						//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
						lGeraCad := .T. //Verifica se gero registro de cadastro para este SF3, pois pode haver mais de um por NF.
						DbSelectArea ("MES")
						If (RecLock ("MES", .T.))
							MES->M_CNPJ		:=	cCNPJ
							MES->M_IE		:=	cIE
							MES->M_RSOCIAL	:=	Padr ((cAliasSFT)->A1_NOME, 35)
							MES->M_UF		:=	Padr (cUFVld, 2)
							If lCv115A17 .And. !(cEspec == "06")
								MES->M_TPASSI	:=	'0'
							Else
								MES->M_TPASSI	:= cTPAssVld
							EndIf
							If lCv128A17
								MES->M_FASE		:=	"1"
								MES->M_GRPTENS	:=	"00"
							Else
								MES->M_FASE		:=	Iif (!Empty(cCmpUti),cCmpUti,cFaseVld)
								MES->M_GRPTENS	:=	cGrpVld
							EndIf
							MES->M_CODCLI	:=	(cAliasSFT)->A1_COD+(cAliasSFT)->A1_LOJA
							MES->M_EMISSAO	:=	Val (DToS ((cAliasSFT)->FT_ENTRADA))
							MES->M_MODELO	:=	IIF(Val(cEspec)== 28,1,Val(cEspec)) //Tratamento para conv๊nio 128.
							MES->M_SERIE	:=	(cAliasSFT)->FT_SERIE
							MES->M_SDOC		:=	SerieNfId(cAliasSFT,2,"FT_SERIE")
							MES->M_NUMERO	:=	cNumNf
							If lCv115A17 .And. !Empty(aInfosMES[1])
								MES->M_SITUAC := aInfosMES[1]
							Else
								MES->M_SITUAC	:=	Iif("CANCELAD"$(cAliasSFT)->FT_OBSERV .And. !Empty((cAliasSFT)->FT_DTCANC),"S","N")
							EndIf
							MES->M_ANOMES	:=	Val (SubStr (AllTrim (Str (Year ((cAliasSFT)->FT_ENTRADA))), 3, 2)+StrZero (Month ((cAliasSFT)->FT_ENTRADA), 2))
							MES->M_REFITEM	:=	nProxRegItem
							MES->M_NOMEARQ	:=	cMCorrente
							MES->M_NTELCON	:=	cNTelVld
							MES->M_TPCGC	:=	cTpCGC
							MES->M_TPCLI	:=	cTpCliVld
							MES->M_SUBCLAS	:=	cSubCl
							MES->M_NTERM	:= Iif(lCv128A17,Space(12),cTerm)
							MES->M_CNPJEMI	:=	SM0->M0_CGC
							MES->M_FATURA	:=	Iif(lCv115A17,'00000000000000000000',cNumNf)
							MES->M_TOTFAT	:=	(cAliasSFT)->FT_TOTAL
							MES->M_LEITANT	:=	Val(AllTrim (Str (Year (dLeitAnt)))+Alltrim(StrZero (Month (dLeitAnt),2))+Alltrim(StrZero(Day(dLeitAnt),2)))
							MES->M_LEITATU	:=	Val(AllTrim (Str (Year (dLeitAtu)))+Alltrim(StrZero (Month (dLeitAtu),2))+Alltrim(StrZero(Day(dLeitAtu),2)))
							If lCv115A17 .And. !Empty(aInfosMES[2])
								MES->M_INFOADI := aInfosMES[2]
							Else
								MES->M_INFOADI := Space (30)
							EndIf
						Else
							lContinua := MsgYesNo(STR0085+"MES"+STR0086,STR0087) //"Problemas no lock da tabela de trabalho ["###"]. Deseja continuar?"###"Problemas Lock."
						EndIf
					EndIf
					If (lContinua)
						MES->M_VLRTOT	+=	(cAliasSFT)->FT_VALCONT //Foi retirado o desconto pois o campo VALCONT ja eh gravado sendo subtraido o valor do desconto concedido na nota fiscal.
						If (!lSimples)
							MES->M_BCICMS	+=	(cAliasSFT)->FT_BASEICM
							MES->M_ICMS		+=	(cAliasSFT)->FT_VALICM
							MES->M_ISENTAS	+=	(cAliasSFT)->FT_ISENICM
							MES->M_OUTRAS	+=	(cAliasSFT)->FT_OUTRICM
							MES->M_TOTFAT	+=	0
						Else
							MES->M_BCICMS	:=	0
							MES->M_ICMS		:=	0
							MES->M_ISENTAS	:=	0
							MES->M_OUTRAS	:=	MES->M_VLRTOT
							MES->M_TOTFAT	+=	0
						EndIf
						/*
							author: Vitor Ribeiro
							since: 08/08/2017
							obs: Foi criado a fun็ใo xFisMdCt79 (no MATXFIS) para realizar a regra do cAutDig1, devido que a mesma regra ้ utilizada para gravar o campo F3_MDCAT79.
						*/
						// Como todos os cliente recebem o IMPXFIS, verifica para deixar como era antes para nใo ter problema.
						If lMdCt79
							// Fun็ใo para realizar o algoritmo MD5, utilizando da fun็ใo Md5(), para as informa็๕es do campo F3_MDCAT79.
							// xFisMdCt79(c_CnpjCli,c_NFiscal,n_ValCont,n_BaseIcm,n_ValIcms,d_Emissao,c_CnpjEmi)
							cAutDig1 := xFisMdCt79(MES->M_CNPJ,MES->M_NUMERO,MES->M_VLRTOT,MES->M_BCICMS,MES->M_ICMS,SToD(StrZero(MES->M_EMISSAO,8)),SM0->M0_CGC)
						Else
							//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
							//ณPassamos a calcular no fonte e nao mais no INI porque precisavamos gravar no SF3 paraณ
							//|  apresentar no P2/P2A, coluna "Observacao"                                          ณ
							//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
							cAutDig1 := MES->M_CNPJ+MES->M_NUMERO+StrTran (StrZero (MES->M_VLRTOT, 13, 2), ".", "")
							cAutDig1 += StrTran (StrZero (MES->M_BCICMS, 13, 2), ".", "")+StrTran (StrZero (MES->M_ICMS, 13, 2), ".", "")
							If lCv115A17
								cAutDig1 += StrZero (MES->M_EMISSAO, 8)+ Alltrim(SM0->M0_CGC)
							EndIf
							cAutDig1 := Md5(cAutDig1)
						EndIf

						cAutDig2 := MES->M_CNPJ+MES->M_IE+MES->M_RSOCIAL+MES->M_UF+MES->M_TPASSI+MES->M_FASE
						cAutDig2 += MES->M_GRPTENS+MES->M_CODCLI+StrZero (MES->M_EMISSAO, 8)+StrZero (MES->M_MODELO, 2)+FisGetSer(MES->M_SDOC,"","","",.F.,.F.,"",.F.,.F.,oCashSX6["MV_ESPNFX5"],oCashSX6["MV_DSSERIE"],oCashSX6["MV_SERCAT"])
						cAutDig2 += SubStr(AllTrim(MES->M_NUMERO),-9,9)+cAutDig1+StrTran (StrZero (MES->M_VLRTOT, 13, 2), ".", "")
						cAutDig2 += StrTran (StrZero (MES->M_BCICMS, 13, 2), ".", "")+	StrTran (StrZero (MES->M_ICMS, 13, 2), ".", "")
						cAutDig2 += StrTran (StrZero (MES->M_ISENTAS, 13, 2), ".", "")+StrTran (StrZero (MES->M_OUTRAS, 13, 2), ".", "")
						cAutDig2 += MES->M_SITUAC+StrZero (MES->M_ANOMES, 4)+StrZero (MES->M_REFITEM, 9)+MES->M_NTELCON//+Space (Iif (dDataDe >= CTOD("01/07/2012"),5,3))
						If lCv115A17
							cAutDig2 += MES->M_TPCGC+MES->M_TPCLI+MES->M_SUBCLAS+MES->M_NTERM+MES->M_CNPJEMI+MES->M_FATURA
							cAutDig2 += StrTran (StrZero (MES->M_TOTFAT, 13, 2), ".", "") + StrZero(MES->M_LEITANT,8) + StrZero(MES->M_LEITATU,8)
							cAutDig2 += Space (50)+StrTran (StrZero (0, 09, 2), ".", "")+MES->M_INFOADI+Space (5)
						Else
							cAutDig2 += Space (Iif (dDataDe >= CTOD("01/07/2012"),5,3))
						EndIf
						MES->M_CODAUT1 := cAutDig1
						MES->M_CODAUT2 := Md5(cAutDig2)

						MsUnLock ()
					EndIf

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณGravando registro Cadastro.ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If (lGeraCad)
						If (RecLock ("CAD", .T.))
								CAD->D_CNPJ		:=	cCNPJ
								CAD->D_IE		:=	cIE
								CAD->D_RSOCIAL	:=	Padr((cAliasSFT)->A1_NOME, 35)
								CAD->D_LOGRAD	:=	Padr(FisGetEnd(cEndVld)[1],45)
								CAD->D_NUMERO	:=	Val (Substr(sfRetNum(cEndVld),1,5))
								CAD->D_COMPL	:=	Padr(Iif(!Empty(FisGetEnd((cAliasSFT)->A1_END)[4]),FisGetEnd((cAliasSFT)->A1_END)[4],Iif(!Empty(Alltrim((cAliasSFT)->A1_COMPLEM)),Alltrim((cAliasSFT)->A1_COMPLEM),FisGetEnd((cAliasSFT)->A1_END)[3])),15)
								CAD->D_CEP		:=	Val (cCepVld)
								CAD->D_BAIRRO	:=	Padr(cBairVld,15)
								If lCv115Mun
									SA1->(DbSetOrder(1))
									SA1->(MsSeek(xFilial("SA1")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
																		
									CAD->D_MUNIC	:=	ExecBlock("CV115MUN", .F., .F., {'SA1'})
								Else
									CAD->D_MUNIC	:=	CAPITALACE(Padr(cMuniVld, 30))
								EndIf
								CAD->D_UF		:=	Padr(cUFVld, 2)
								CAD->D_FONE		:=	IIF(!(dDataDe >= CTOD("01/07/2012")) .And. Len(Strzero(Val((cAliasSFT)->A1_DDD),2)+AllTrim(Str(FisGetTel((cAliasSFT)->A1_TEL)[3]))) > 10, Val(SubStr(Alltrim(Str(Val((cAliasSFT)->A1_DDD))),2,1)+AllTrim(Str(FisGetTel((cAliasSFT)->A1_TEL)[3]))), Val(Strzero(Val((cAliasSFT)->A1_DDD),2)+AllTrim(Str(FisGetTel((cAliasSFT)->A1_TEL)[3]))))
								CAD->D_NTELCON	:=	cNTelVld
								CAD->D_CODIDEN	:=	(cAliasSFT)->A1_COD+(cAliasSFT)->A1_LOJA
								CAD->D_EMISSAO	:=	MES->M_EMISSAO
								CAD->D_MODELO	:=	MES->M_MODELO
								CAD->D_SERIE	:=	MES->M_SERIE
								CAD->D_NUMNF	:=	MES->M_NUMERO
								CAD->D_CODMUN	:= IIf((cAliasSFT)->A1_EST=='EX','99',UfCodIBGE((cAliasSFT)->A1_EST))+(cAliasSFT)->A1_COD_MUN //tratamento feito pois na fun็ใo nใo tem.
								CAD->D_NOMEARQ	:= cDCorrente
								CAD->D_ORDMEST	:=	StrZero (nOrdCadMes++, 10)
							MsUnLock ()
						Else
							lContinua := MsgYesNo(STR0085+"CAD"+STR0086,STR0087) //"Problemas no lock da tabela de trabalho ["###"]. Deseja continuar?"###"Problemas Lock."
						EndIf
					EndIf

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณGravando registro Itens.   ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If Len(Alltrim((cAliasSFT)->FT_PRODUTO)) > 10
						cProd := PadR(AllTrim(SubStr((cAliasSFT)->FT_PRODUTO,(Len((cAliasSFT)->B1_COD) - 9),Len((cAliasSFT)->B1_COD))),10)
					Else
						cProd	:=	Padr ((cAliasSFT)->FT_PRODUTO, 10)
					EndIf
					If lCv115A17 .And. lCmpIsenc .And. !Empty((cAliasSFT)->&(aMvD5ICMS[9]))
						cIsenRed := (cAliasSFT)->&(aMvD5ICMS[9])
					Else
						cIsenRed := "00"
					EndIf

 					If (ITE->(DbSeek (PADR(cNumNf,nTamFTNFiscal)+(cAliasSFT)->FT_SERIE+cCNPJ+Padr (cProd, 10)+cCFOP))) .And. !lCv115A17
						If !(RecLock ("ITE", .F.))
							lContinua := MsgYesNo(STR0085+"ITE"+STR0086,STR0087) //"Problemas no lock da tabela de trabalho ["###"]. Deseja continuar?"###"Problemas Lock."
						EndIf
					Else
					 	nDataEm		:=	Val (DToS ((cAliasSFT)->FT_ENTRADA))
					  	cAnoMes		:= 	SubStr (AllTrim (Str (Year ((cAliasSFT)->FT_ENTRADA))), 3, 2)+StrZero (Month ((cAliasSFT)->FT_ENTRADA), 2)
					  	nDesc		:=	IIf(lCv115A17, 0, (cAliasSFT)->FT_DESCONT)
					 	nAcres		:=	IIf(lCv115A17, 0, (cAliasSFT)->FT_DESPESA)
					  	cSituac		:= 	Iif("CANCELAD"$(cAliasSFT)->FT_OBSERV .And. !Empty((cAliasSFT)->FT_DTCANC),"S","N")
						nAliqIcms	:= 	(cAliasSFT)->FT_ALIQICM
						cUFit		:= 	Padr (cUFVld, 2)
						cFase 		:= 	Iif (!Empty(cCmpUti),cCmpUti,cFaseVld)
						cGten		:= 	cGrpVld

						nItem++
						If (RecLock ("ITE", .T.))
							ITE->I_CNPJ		:=	cCNPJ
							ITE->I_UF		:=	cUFit
							If lCv115A17 .And. !(cEspec == "06")
								ITE->I_TPASSI	:=	'0'
							Else
								ITE->I_TPASSI	:= cTPAssVld
							EndIf
							If lCv128A17
								ITE->I_FASE		:=	"1"
								ITE->I_GRPTENS	:=	"00"
							Else
								ITE->I_FASE		:=	cFase
								ITE->I_GRPTENS	:=	cGten
							EndIf
							ITE->I_EMISSAO	:=	nDataEm
							ITE->I_MODELO	:=	IIF(cEspec=="28","01",cEspec)
							ITE->I_SERIE	:=	(cAliasSFT)->FT_SERIE
							ITE->I_SDOC		:=	SerieNfId(cAliasSFT,2,"FT_SERIE")
							ITE->I_NUMERO	:=	cNumNf
							ITE->I_CFOP		:=	cCFOP
							ITE->I_ITEM		:=	nItem
							ITE->I_CODPROD	:=	cProd
							ITE->I_DESPROD	:=	Padr ((cAliasSFT)->B1_DESC, 40)
							ITE->I_CODCLIT	:=	Iif (!Empty(cCmpClIt),cCmpClIt,cCodClVld)
							//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
							//ณConforme Convenio 133/05, quando o item estiver classificado nos grupos 08 e 09ณ
							//ณda Tabela de Classifica็ใo, o CFOP deve ser apresentado zerado.                ณ
							//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
							If ITE->I_CODCLIT $ "0801/0802/0803/0804/0805/0806/0807/0808/0899/0901/0902/0903/0904/0905/0906/0999"
								ITE->I_CFOP	:= "0000"
							Endif
							ITE->I_UM		:=	Padr ((cAliasSFT)->B1_UM, 6)
							If (!lSimples)
								ITE->I_ALQICMS	:=	nAliqIcms
							Else
								ITE->I_ALQICMS	:=	0
							Endif
							If lCv115A17 .And. !Empty(aInfosMES[1])
								ITE->I_SITUAC := aInfosMES[1]
							Else
								ITE->I_SITUAC := cSituac
							Endif
							ITE->I_ANOMES	:=	cAnoMes
							ITE->I_NOMEARQ	:=	cICorrente
						Else
							lContinua	:=	MsgYesNo (STR0085+"ITE"+STR0086, STR0087)	//"Problemas no lock da tabela de trabalho ["###"]. Deseja continuar?"###"Problemas Lock."
						EndIf
					EndIf
					If (lContinua)
							If lCv128A17
								ITE->I_QTDCONT	+=	0
								ITE->I_QTDPRES	+=	0
							Else
								ITE->I_QTDCONT	+=	(cAliasSFT)->FT_QUANT
								If lCv115A17
									ITE->I_QTDPRES	+=	Iif(cEspec == "06",(cAliasSFT)->FT_QUANT,0)
								Else
									ITE->I_QTDPRES	+=	(cAliasSFT)->FT_QUANT
								EndIF
							EndIf
							ITE->I_QTDFAT	+=	(cAliasSFT)->FT_QUANT
							ITE->I_TOTAL	+=	(cAliasSFT)->FT_VALCONT + IIf(lCv115A17, 0, (cAliasSFT)->FT_DESCONT)
							ITE->I_DESC		+=	nDesc
							ITE->I_ACRESC	+=	nAcres
							ITE->I_ALIQPIS	:=	(cAliasSFT)->FT_ALIQPIS
							ITE->I_VALPIS	+=	(cAliasSFT)->FT_VALPIS
							ITE->I_ALIQCOF	:=	(cAliasSFT)->FT_ALIQCOF
							ITE->I_VALCOF	+=	(cAliasSFT)->FT_VALCOF
						If (!lSimples)
							ITE->I_BCICMS	+=	(cAliasSFT)->FT_BASEICM
							ITE->I_ICMS		+=	(cAliasSFT)->FT_VALICM
							ITE->I_ISENTAS	+=	(cAliasSFT)->FT_ISENICM
							ITE->I_OUTRAS	+=	(cAliasSFT)->FT_OUTRICM
						Else
							ITE->I_BCICMS	:=	0
							ITE->I_ICMS		:=	0
							ITE->I_ISENTAS	:=	0
							ITE->I_OUTRAS	:=	(cAliasSFT)->FT_VALCONT + IIf(lCv115A17, 0, (cAliasSFT)->FT_DESCONT)
						EndIf
						ITE->I_CONTRAT	:=	Iif(lCv128A17,Space(15),cContrat)
						ITE->I_DESCJUD	:=	" "
						ITE->I_ISENRED	:=	Iif(lCv128A17,"00"     ,cIsenRed)
						MsUnLock ()
					EndIf

					(cAliasSFT)->(DbSkip())

					////// O c๓digo abaixo ้ executado se a empresa for optante pelo simples nacional. Substitui a se็ใo Simples Nacional do CAT79I.INI             \\\\\\
					////// Um item ้ incluํdo no fim da grava็ใo de todos os registros de uma nota, sua descri็ใo demonstra a alํquota ICMS referente เquela nota.  \\\\\\

						If lSimples .And. lExistCAT79 .And.;
						 oCashFil["SFT"]+cChaveNf<>oCashFil["SFT"]+(cAliasSFT)->(DToS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA) .And.;
						 cRotina == "CAT79" .And. (RecLock ("ITE", .T.)) // Optante simples nacional / Existem campos da CAT79 / Iniciando leitura de outra nota / cRotina == "CAT79" / RecLock

							ITE->I_CNPJ		:=	cCNPJ
							ITE->I_UF		:=	cUFit
							ITE->I_TPASSI	:=	'0'
							ITE->I_FASE		:=	cFase
							ITE->I_GRPTENS	:=	cGten
							ITE->I_EMISSAO	:=	nDataEm
							ITE->I_MODELO	:=	cEspec
							ITE->I_SERIE	:=	cSerie
							ITE->I_NUMERO	:=	cNumNf
							ITE->I_CFOP		:=	cCFOP
							ITE->I_ITEM		:=	nItem + 1
							ITE->I_CODPROD	:=	Replicate("0",10)
							ITE->I_DESPROD	:=	"OPTANTE SN - ALIQUOTA "+ AllTrim(TransForm(IIF(!Empty(nAliqIcms), nAliqIcms, oCashSX6["MV_ALIQSIM"]),"@E 99.99"))+Space(22)
							ITE->I_CODCLIT	:=	Iif (!Empty(cCmpClIt),cCmpClIt,cCodClVld)
							ITE->I_UM		:=	Padr ((cAliasSFT)->B1_UM, 6)
							ITE->I_QTDCONT	:=	0
							ITE->I_QTDPRES	:=	0
							ITE->I_TOTAL	:=	0
							ITE->I_DESC		:=	0
							ITE->I_ACRESC	:=	0
							ITE->I_BCICMS	:=	0
							ITE->I_ICMS		:=	0
							ITE->I_ISENTAS	:=	0
							ITE->I_OUTRAS	:=	0
							ITE->I_ALQICMS	:=	0
							ITE->I_SITUAC 	:= 	cSituac
							ITE->I_ANOMES	:=	cAnoMes
							ITE->I_CONTRAT	:=	cContrat
							ITE->I_QTDFAT	:=	0
							ITE->I_ALIQPIS	:=	(cAliasSFT)->FT_ALIQPIS
							ITE->I_VALPIS	:=	(cAliasSFT)->FT_VALPIS
							ITE->I_ALIQCOF	:=	(cAliasSFT)->FT_ALIQCOF
							ITE->I_VALCOF	:=	(cAliasSFT)->FT_VALCOF
							ITE->I_DESCJUD	:=	" "
							ITE->I_ISENRED	:=	"00"
							ITE->I_NOMEARQ	:=	cICorrente

							msUnlock()

							aMestre[nPosM][4]++

						EndIf

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณReinicializacao do numero do item a cada nota fiscal.ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If oCashFil["SFT"]+cChaveNf<>oCashFil["SFT"]+(cAliasSFT)->(DToS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA)

						nItem	:=	0
						SF3->(dbSetOrder(1))
						If SF3->(Fieldpos(cMVMD579))>0 .And. SF3->(dbSeek(xFilial("SF3")+cChaveNf))
							While !SF3->(Eof()) .And.;
								xFilial("SF3")+cChaveNf==SF3->(F3_FILIAL+DToS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
								RecLock("SF3", .F.)
									SF3->F3_REPROC	:=	"N"
									SF3->(FieldPut(SF3->(Fieldpos(cMVMD579)),Md5(cAutDig2)))
								MsUnLock()
								SF3->(dbSkip())
							End
						EndIf
					EndIf
				EndDo

				DbSelectArea(cAliasSFT)
				DbCloseArea()

				ITE->(DbSetOrder(2))
			EndIf
		Next

		D5GerArqs(aArqsAbr, aMestre, cNormaM, cNormaI, cNormaD, cDiretorio, lCv115A17)

	EndIf
	
	if !lAutomato
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณFechamento dos TRB's.ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		For nI := 1 To Len (aArqsAbr)
			If File (aArqsAbr[ni][1]+GetDBExtension ())
				DbSelectArea (aArqsAbr[nI][2])
				(aArqsAbr[nI][2])->(DbCloseArea ())
				Ferase (aArqsAbr[nI][1]+GetDBExtension ())
				Ferase (aArqsAbr[nI][1]+OrdBagExt ())
			Endif
		Next
	endif

	oMd5IcmsDados:destroy()

	FreeObj(oMd5IcmsDados)
	oMd5IcmsDados := Nil
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณR79GerArqsณ Autor ณGustavo G. Rueda       ณ Data ณ23.10.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao utilizada como interpretadora de ini's, onde atraves ณฑฑ
ฑฑณ          ณde algumas funcoes do MATA950 estarei processando os inis.  ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet = Retornando Sucesso ou Falha da funcao.       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpA - aArqsAbr = Array contendo os TRB's criados.          ณฑฑ
ฑฑณ          ณExpA - aMestre = Array contendo arquivos mestres a serem    ณฑฑ
ฑฑณ          ณ  gerados.                                                  ณฑฑ
ฑฑณ          ณExpC - cNormaM = Intrucao normativa para o arquivo MESTRE.  ณฑฑ
ฑฑณ          ณExpC - cNormaI = Intrucao normativa para o arquivo ITENS.   ณฑฑ
ฑฑณ          ณExpC - cNormaD = Intrucao normativa para o arquivo CADASTRO.ณฑฑ
ฑฑณ          ณExpC - cDiretorio = Diretorio de geracao dos arquivos.      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function D5GerArqs (aArqsAbr, aMestre, cNormaM, cNormaI, cNormaD, cDiretorio, lCv115A17)
	Local	lRet		:=	.T.
	Local	lContinua	:=	.T.
	Local	nInd1		:=	0
	Local	nInd2		:=	0
	Local	nInd3		:=	0
	Local	nPosArq		:=	0
	Local	aNormas		:=	{{cNormaM, "M"}, {cNormaI, "I"}, {cNormaD, "D"}}
	Local	nHandle		:=	0
	Local	nX			:=	0
	Local	lFuncFRen	:=	FindFunction ("FRENAMEEX")	//Funcao disponivel no binario do ftp. (24/08/2004)
	Local	cMensArq	:=	""
	Local	nProcFil	:=	MV_PAR06
	Default lCv115A17	:= 	.F.

	If nProcFil == 1
		cDiretorio := cDiretorio + Alltrim(cFilAnt) + "\"
	EndIf
	//
	For nInd1 := 1 To (Len (aNormas))
		If (File (aNormas[nInd1][1]+".INI"))
			If (aNormas[nInd1][2]$"M")
				For nInd2 := 1 To (Len (aMestre))
					//
					For nInd3 := 1 To aMestre[nInd2][3]
 						nPosArq	:=	aScan (aArqsAbr, {|M| M[2]="MES"})
						DbSelectArea (aArqsAbr[nPosArq][2])
						//
						cArqDest	:=	AllTrim (aMestre[nInd2][1]+"."+StrZero (nInd3, 3))
						//
						Set Filter To Alltrim((aArqsAbr[nPosArq][2])->M_NOMEARQ) == Alltrim(cArqDest)
							(aArqsAbr[nPosArq][2])->(DbGoTop ())
							FwMsgRun (,{||ProcNorma (aNormas[nInd1][1]+".INI", cArqDest, cDiretorio)},;
								STR0088+cArqDest+"...", STR0057+aNormas[nInd1][1]+".INI")	//"Gerando "###"Processando "
						DbClearFilter ()
						//
						If (lFuncFRen)
							FRenameEx (cDiretorio+cArqDest, Upper(cDiretorio+cArqDest))
							cMensArq := "Nใo foi possํvel gerar o arquivo em " + cDiretorio+cArqDest + chr(13) + chr(10)
							cMensArq += "Verifique se voc๊ possui permissใo para grava็ใo nessa pasta"
							If !File(cDiretorio+cArqDest)
								MsgAlert (cMensArq)
							EndIf
						EndIf
					Next (nInd3)
					//
				Next (nInd2)
			ElseIf (aNormas[nInd1][2]=="I")
				For nInd2 := 1 To (Len (aMestre))
					//
					For nInd3 := 1 To aMestre[nInd2][3]
						nPosArq	:=	aScan (aArqsAbr, {|I| I[2]="ITE"})
						DbSelectArea (aArqsAbr[nPosArq][2])
						//
						If lCv115A17
							cArqDest	:=	AllTrim (Left (aMestre[nInd2][1], 28)+"I."+StrZero (nInd3, 3))
						Else
							cArqDest	:=	AllTrim (Left (aMestre[nInd2][1], 10)+"I."+StrZero (nInd3, 3))
						EndIf
						//
						Set Filter To Alltrim((aArqsAbr[nPosArq][2])->I_NOMEARQ) == Alltrim(cArqDest)
							(aArqsAbr[nPosArq][2])->(DbGoTop ())
							FwMsgRun (,{||ProcNorma (aNormas[nInd1][1]+".INI", cArqDest, cDiretorio)},;
								STR0088+cArqDest+"...", STR0057+aNormas[nInd1][1]+".INI")	//"Gerando "###"Processando "
						DbClearFilter ()
						//
						If (lFuncFRen)
							FRenameEx (cDiretorio+cArqDest, Upper(cDiretorio+cArqDest))
							cMensArq := "Nใo foi possํvel gerar o arquivo em " + cDiretorio+cArqDest + chr(13) + chr(10)
							cMensArq += "Verifique se voc๊ possui permissใo para grava็ใo nessa pasta"
							If !File(cDiretorio+cArqDest)
								MsgAlert (cMensArq)
							EndIf
						EndIf
					Next (nInd3)
					//
				Next (nInd2)
			ElseIf (aNormas[nInd1][2]=="D")
				For nInd2 := 1 To (Len (aMestre))
					//
					nPosArq	:=	aScan (aArqsAbr, {|D| D[2]="CAD"})
					DbSelectArea (aArqsAbr[nPosArq][2])
					IndRegua (aArqsAbr[nPosArq][2], CriaTrab (, .F.), "D_ORDMEST")
					(aArqsAbr[nPosArq][2])->(DbGoTop ())
					//
					For nInd3 := 1 To aMestre[nInd2][3]
						//
						If lCv115A17
							cArqDest	:=	AllTrim (Left (aMestre[nInd2][1], 28)+"D."+StrZero (nInd3, 3))
						Else
							cArqDest	:=	AllTrim (Left (aMestre[nInd2][1], 10)+"D."+StrZero (nInd3, 3))
						EndIf
						//
						Set Filter To Alltrim((aArqsAbr[nPosArq][2])->D_NOMEARQ) == Alltrim(cArqDest)
							(aArqsAbr[nPosArq][2])->(DbGoTop ())
							FwMsgRun (,{||ProcNorma (aNormas[nInd1][1]+".INI", cArqDest, cDiretorio)},;
								STR0088+cArqDest+"...", STR0057+aNormas[nInd1][1]+".INI")	//"Gerando "###"Processando "
						DbClearFilter ()
						//
						If (lFuncFRen)
							FRenameEx (cDiretorio+cArqDest, Upper(cDiretorio+cArqDest))
							cMensArq := "Nใo foi possํvel gerar o arquivo em " + cDiretorio+cArqDest + chr(13) + chr(10)
							cMensArq += "Verifique se voc๊ possui permissใo para grava็ใo nessa pasta"
							If !File(cDiretorio+cArqDest)
								MsgAlert (cMensArq)
							EndIf
						EndIf
					Next (nInd3)
					//
				Next (nInd2)
			EndIf
			DbClearFilter ()
		Else
			lContinua	:=	MsgYesNo (STR0058+aNormas[nInd1][1]+STR0059, STR0060)
		EndIf
		If !(lContinua)
			Exit
		EndIf
	Next (nInd1)
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณD5EstrArq ณ Autor ณGustavo G. Rueda       ณ Data ณ27.01.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณCria estrutura dos arquivos de trabalhos.                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpA -> aRet -> Array contendo os TRB's criados.            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณdDataDe -> Dada do inํcio do perํodo.                       ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function R79EstrArq (dDataDe, lCv115A17)
	Local	aRet	:=	{}
	Local	aStru	:=	{}
	Local	cArqM	:=	""
	Local	cArqI	:=	""
	Local	cArqII	:=	""
	Local	cArqD	:=	""
	Default lCv115A17	 := .F.
	//
	aAdd (aStru, {"M_CNPJ",		"C",	014,	0})
	aAdd (aStru, {"M_IE",		"C",	014,	0})
	aAdd (aStru, {"M_RSOCIAL",	"C",	035,	0})
	aAdd (aStru, {"M_UF",		"C",	002,	0})
	aAdd (aStru, {"M_TPASSI",	"C",	001,	0})
	aAdd (aStru, {"M_FASE",		"C",	001,	0})
	aAdd (aStru, {"M_GRPTENS",	"C",	002,	0})
	aAdd (aStru, {"M_CODCLI",	"C",	012,	0})
	aAdd (aStru, {"M_EMISSAO",	"N",	008,	0})
	aAdd (aStru, {"M_MODELO",	"N",	002,	0})
	aAdd (aStru, {"M_SERIE",	"C",	TamSx3("FT_SERIE")[1],	0})
	aAdd (aStru, {"M_SDOC",		"C",	003,	0})
	aAdd (aStru, {"M_NUMERO",   "C",   TamSx3("FT_NFISCAL")[1], 0})
	aAdd (aStru, {"M_CODAUT1",	"C",	032,	0})
	aAdd (aStru, {"M_VLRTOT",	"N",	012,	2})
	aAdd (aStru, {"M_BCICMS",	"N",	012,	2})
	aAdd (aStru, {"M_ICMS",		"N",	012,	2})
	aAdd (aStru, {"M_ISENTAS",	"N",	012,	2})
	aAdd (aStru, {"M_OUTRAS",	"N",	012,	2})
	aAdd (aStru, {"M_SITUAC",	"C",	001,	0})
	aAdd (aStru, {"M_ANOMES",	"N",	004,	0})
	aAdd (aStru, {"M_REFITEM",	"N",	009,	0})
	aAdd (aStru, {"M_NTELCON",	"C", Iif(dDataDe >= CTOD("01/07/2012"),012,010),0})
	aAdd (aStru, {"M_TPCGC",	"C",	001,	0})
	aAdd (aStru, {"M_TPCLI",	"C",	002,	0})
	aAdd (aStru, {"M_SUBCLAS",	"C",	002,	0})
	aAdd (aStru, {"M_NTERM",	"C",	012,	0})
	aAdd (aStru, {"M_CNPJEMI",	"C",	014,	0})
	aAdd (aStru, {"M_FATURA",	"C",	020,	0})
	aAdd (aStru, {"M_TOTFAT",	"N",	012,	2})
	aAdd (aStru, {"M_LEITANT",	"N",	008,	0})
	aAdd (aStru, {"M_LEITATU",	"N",	008,	0})
	aAdd (aStru, {"M_INFOADI",	"C",	030,	0})
	aAdd (aStru, {"M_CODAUT2",	"C",	032,	0})
	If lCv115A17
		aAdd (aStru, {"M_NOMEARQ",	"C",	033,	0})
	Else
		aAdd (aStru, {"M_NOMEARQ",	"C",	015,	0})
	EndIF
	//
	cArqM	:=	CriaTrab (aStru)
	DbUseArea (.T., __LocalDriver, cArqM, "MES")
	IndRegua("MES", cArqM, "M_NUMERO+M_SERIE+M_CNPJ")
	//
	aStru		:=	{}
	//
	aAdd (aStru, {"I_CNPJ",		"C",	014,	0})
	aAdd (aStru, {"I_UF",		"C",	002,	0})
	aAdd (aStru, {"I_TPASSI",	"C",	001,	0})
	aAdd (aStru, {"I_FASE",		"C",	001,	0})
	aAdd (aStru, {"I_GRPTENS",	"C",	002,	0})
	aAdd (aStru, {"I_EMISSAO",	"N",	008,	0})
	aAdd (aStru, {"I_MODELO",	"C",	002,	0})
	aAdd (aStru, {"I_SERIE",	"C",	TamSx3("FT_SERIE")[1],	0})
	aAdd (aStru, {"I_SDOC",		"C",	003,	0})
	aAdd (aStru, {"I_NUMERO",	"C",	009,	0})
	aAdd (aStru, {"I_CFOP",		"C",	004,	0})
	aAdd (aStru, {"I_ITEM",		"N",	003,	0})
	aAdd (aStru, {"I_CODPROD",	"C",	010,	0})
	aAdd (aStru, {"I_DESPROD",	"C",	040,	0})
	aAdd (aStru, {"I_CODCLIT",	"C",	004,	0})
	aAdd (aStru, {"I_UM",		"C",	006,	0})
	aAdd (aStru, {"I_QTDCONT",	"N",	011,	3})
	aAdd (aStru, {"I_QTDPRES",	"N",	011,	3})
	aAdd (aStru, {"I_TOTAL",	"N",	014,	2})
	aAdd (aStru, {"I_DESC",		"N",	011,	2})
	aAdd (aStru, {"I_ACRESC",	"N",	011,	2})
	aAdd (aStru, {"I_BCICMS",	"N",	014,	2})
	aAdd (aStru, {"I_ICMS",		"N",	011,	2})
	aAdd (aStru, {"I_ISENTAS",	"N",	011,	2})
	aAdd (aStru, {"I_OUTRAS",	"N",	011,	2})
	aAdd (aStru, {"I_ALQICMS",	"N",	005,	2})
	aAdd (aStru, {"I_SITUAC",	"C",	001,	0})
	aAdd (aStru, {"I_ANOMES",	"C",	004,	0})
	aAdd (aStru, {"I_CONTRAT",	"C",	015,	0})
	aAdd (aStru, {"I_QTDFAT",	"N",	012,	3})
	aAdd (aStru, {"I_TARIFA",	"N",	011,	6})
	aAdd (aStru, {"I_ALIQPIS",	"N",	010,	4})
	aAdd (aStru, {"I_VALPIS",	"N",	011,	2})
	aAdd (aStru, {"I_ALIQCOF",	"N",	010,	4})
	aAdd (aStru, {"I_VALCOF",	"N",	011,	2})
	aAdd (aStru, {"I_DESCJUD",	"C",	001,	0})
	aAdd (aStru, {"I_ISENRED",	"C",	002,	0})
	aAdd (aStru, {"I_CODAUT2",	"C",	032,	0})
	If lCv115A17
		aAdd (aStru, {"I_NOMEARQ",	"C", 	033,	0})
	Else
		aAdd (aStru, {"I_NOMEARQ",	"C", 	015,	0})
	EndIf
	//
	cArqI	:=	CriaTrab (aStru)
	cArqII	:=	CriaTrab (aStru)
	DbUseArea (.T., __LocalDriver, cArqI, "ITE")
	IndRegua("ITE", cArqI, "I_NUMERO+I_SERIE+I_CNPJ+I_CODPROD+I_CFOP")
	IndRegua("ITE", cArqII,"I_NUMERO+I_SERIE+I_CNPJ+STR(I_ITEM)+I_CODPROD+I_CFOP")
	dbClearIndex()

	dbSelectArea("ITE")
	dbSetIndex(cArqI+OrdBagExt())
	dbSetIndex(cArqII+OrdBagExt())
	dbSetOrder(1)
	//
	aStru		:=	{}
	//
	aAdd (aStru, {"D_CNPJ",		"C",	014,	0})
	aAdd (aStru, {"D_IE",		"C",	014,	0})
	aAdd (aStru, {"D_RSOCIAL",	"C",	035,	0})
	aAdd (aStru, {"D_LOGRAD",	"C",	045,	0})
	aAdd (aStru, {"D_NUMERO",	"N",	005,	0})
	aAdd (aStru, {"D_COMPL",	"C",	015,	0})
	aAdd (aStru, {"D_CEP",		"N",	008,	0})
	aAdd (aStru, {"D_BAIRRO",	"C",	015,	0})
	aAdd (aStru, {"D_MUNIC",	"C",	030,	0})
	aAdd (aStru, {"D_UF",		"C",	002,	0})
	aAdd (aStru, {"D_FONE",		"N", Iif(dDataDe >= CTOD("01/07/2012") ,012,010 ),0})
	aAdd (aStru, {"D_CODIDEN",	"C",	012,	0})
	aAdd (aStru, {"D_NTELCON",	"C", Iif(dDataDe >= CTOD("01/07/2012") ,012 ,010 ),0})
	aAdd (aStru, {"D_NTERM",	"C",	012,	0})
	aAdd (aStru, {"D_EMISSAO",	"N",	008,	0})
	aAdd (aStru, {"D_MODELO",	"N",	002,	0})
	aAdd (aStru, {"D_SERIE",	"C",	003,	0})
	aAdd (aStru, {"D_NUMNF",	"C",	TamSx3("FT_NFISCAL")[1],	0})
	aAdd (aStru, {"D_CODMUN",	"C",	007,	0})
	aAdd (aStru, {"D_CODAUT2",	"C",	032,	0})
	If lCv115A17
		aAdd (aStru, {"D_NOMEARQ",	"C", 	033,	0})
	Else
		aAdd (aStru, {"D_NOMEARQ",	"C", 	015,	0})
	EndIF
	aAdd (aStru, {"D_ORDMEST", 	"C",	010,	0})
	cArqD	:=	CriaTrab (aStru)
	DbUseArea (.T., __LocalDriver, cArqD, "CAD")
	IndRegua("CAD", cArqD, "D_CNPJ+D_NOMEARQ")

	
	dbSelectArea("CAD")
	dbSetIndex(cArqD+OrdBagExt())
	dbSetOrder(1)
	//
	aAdd (aRet, {cArqM, "MES"})
	aAdd (aRet, {cArqI, "ITE"})
	aAdd (aRet, {cArqD, "CAD"})
Return (aRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณsfValidDocณ Autor ณGustavo G. Rueda       ณ Data ณ27.01.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณValida numero do Documento tirando caracteres nao validos.  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpC1 -> cRet ฤ Numero RG valido.                           ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1 -> cDoc ฤ Numero do documento.                        ณฑฑ
ฑฑณ          ณExpL2 -> lNum ฤ Valida numero (.T.) ou nao (.F.)            ณฑฑ
ฑฑณ          ณExpL3 -> lAlp ฤ Valida caracter (.T.) ou nao (.F.)          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function sfValidDoc (cDoc, lNum, lAlp)
	Local cRet	:=	""
	Local nI	:=	1
	//
	For nI := 1 To (Len (cDoc))
		If ((Isdigit (SubStr (cDoc, nI, 1))) .And. lNum) .Or. ((IsAlpha (SubStr (cDoc, nI, 1))) .And. lAlp)
			cRet	+=	SubStr (cDoc, nI, 1)
		Endif
	Next
Return (cRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณsfRetNum  ณ Autor ณGustavo G. Rueda       ณ Data ณ27.10.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณRetorna o numero contido no endereco apos a virgula e um    ณฑฑ
ฑฑณ          ณespaco em branco.                                           ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpC1 -> cRet ฤ Numero RG valido.                           ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1 -> cDoc ฤ Numero do documento.                        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function sfRetNum (cEnd)
	Local cRet	:=	""
	Local nI	:=	1
	//
	For nI := 1 To (Len (cEnd))
		If (SubStr (cEnd, nI, 1)==",")
			cRet	:=	SubStr (cEnd, nI+2, 6)
			Exit
		Endif
	Next
Return (sfValidDoc (cRet, .T., .F.))
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณFsGmb2004 ณ Autor ณ Nereu Humberto Junior ณ Data ณ30.03.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Totalizacao de Campos do Fiscal por CFOP                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpA1: [1] Total da coluna Valor Contabil                   ณฑฑ
ฑฑณ          ณExpA1: [2] Total da coluna Base de ICMS                     ณฑฑ
ฑฑณ          ณExpA1: [3] Total da coluna Isentas                          ณฑฑ
ฑฑณ          ณExpA1: [4] Total da coluna Outras                           ณฑฑ
ฑฑณ          ณExpA1: [5] Total da coluna ICMS Retido                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function FsGmb2004()

Local aStru		:= {}
Local aTRBS		:= {}
Local aGrpPais	:= {}
Local cAliasSF3 := "SF3"
Local cQuery    := ""
Local cArqTrab  := ""
Local cArq		:= ""
Local cKey      := ""
Local cChave    := ""
Local cCondicao := ""
Local cCfoComp  := "1101/1102/1116/1117/1118/1122/1151/1152/1451"
Local cCodMuni  := GetNewPar("MV_CODMGMB","")
Local cCFATGMB	:= GetNewPar("MV_CFATGMB","")
Local cRegistro	:= ""
Local nIndex    := 0
Local nX        := 0
Local nPos		:= 0
Local nChave	:= 0
Local cInscr	:= ""
Local cTipo 	:= ""
Local nVCContr	:=	0
Local nVCNCont	:=	0
Local nBCContr	:=	0
Local nBCNCont	:=	0
Local cMVGMBBCIO:=	GetNewPar("MV_GMBBCIO","1116/1117/2116/2117/5116/5117/6116/6117/")
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCria arquivo temporario para o Anexo 1 - Produtorณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
AADD(aStru,{"CODMUN"  ,"C",003,0})
AADD(aStru,{"VALCONT" ,"N",014,2})
AADD(aStru,{"IEPRODUT","C",010,0})

cArq :=	CriaTrab(aStru)
dbUseArea(.T.,__LocalDriver,cArq,"TR2")
IndRegua("TR2",cArq,"IEPRODUT")

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCria arquivo temporario para o Anexo 4 - Entradasณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aStru := {}
AADD(aStru,{"UF"	   	,"C",002,0})
AADD(aStru,{"VALCONT" 	,"N",014,2})
AADD(aStru,{"BASEICM" 	,"N",014,2})
AADD(aStru,{"OUTRICM"	,"N",014,2})
AADD(aStru,{"ISENICM"	,"N",014,2})
AADD(aStru,{"ICMSRET"	,"N",014,2})

cArq :=	CriaTrab(aStru)
dbUseArea(.T.,__LocalDriver,cArq,"TR3")
IndRegua("TR3",cArq,"UF")

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCria arquivo temporario para o Anexo 4 - Saidasณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aStru := {}
AADD(aStru,{"UF"	   	,"C",002,0})
AADD(aStru,{"VALCONNC" 	,"N",014,2})
AADD(aStru,{"VALCONC" 	,"N",014,2})
AADD(aStru,{"BASEICNC" 	,"N",014,2})
AADD(aStru,{"BASEICC" 	,"N",014,2})
AADD(aStru,{"OUTRICM"	,"N",014,2})
AADD(aStru,{"ISENICM"	,"N",014,2})
AADD(aStru,{"ICMSRET"	,"N",014,2})

cArq :=	CriaTrab(aStru)
dbUseArea(.T.,__LocalDriver,cArq,"TR4")
IndRegua("TR4",cArq,"UF")

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCria arquivo temporario para o Anexo 6 - Servicos Internacionais ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
aStru := {}
AADD(aStru,{"GRUPO"		,"N",003,0})
AADD(aStru,{"REGISTRO"	,"C",525,0})

cArq :=	CriaTrab(aStru)
dbUseArea(.T.,__LocalDriver,cArq,"TR6")
IndRegua("TR6",cArq,"STR(GRUPO)")

Aadd(aTRBS,"TR2")
Aadd(aTRBS,"TR3")
Aadd(aTRBS,"TR4")
Aadd(aTRBS,"TR6")

dbSelectArea("SF3")
dbSetOrder(3)
#IFDEF TOP
	 cAliasSF3 := "GMBSF3"
	 aStru  := SF3->(dbStruct())
	 cQuery := "SELECT F3_CFO, F3_VALCONT, F3_CLIEFOR, F3_LOJA, F3_ISENICM, F3_OUTRICM, F3_ESTADO, F3_BASEICM, F3_ICMSRET, F3_TIPO "
	 cQuery += "FROM "+RetSqlName("SF3")+" "
	 cQuery += "WHERE F3_FILIAL='"+xFilial("SF3")+"' AND "
	 cQuery += "F3_ENTRADA >='"+Dtos(dDmainc)+"' AND "
     cQuery += "F3_ENTRADA <='"+Dtos(dDmaFin)+"' AND "
	 cQuery += "F3_DTCANC = '"+Space(Len(Dtos(SF3->F3_DTCANC)))+"' AND "
     cQuery += "F3_OBSERV NOT LIKE '%CANCELAD%' AND "
	 cQuery += "D_E_L_E_T_ = ' ' "
	 cQuery += "ORDER BY "+SqlOrder(SF3->(IndexKey()))

	 cQuery := ChangeQuery(cQuery)
	 dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3,.T.,.T.)

	 For nX := 1 To Len(aStru)
		 If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
			 TcSetField(cAliasSF3,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
		 EndIf
	 Next nX
#ELSE
     cArqTrab  := CriaTrab(NIL,.F.)
	 cKey	   := SF3->(IndexKey())
	 cCondicao := 'F3_FILIAL=="'+xFilial("SF3")+'".And.'
	 cCondicao += 'DTOS(F3_ENTRADA)>="'+DTOS(dDmainc)+'".And.DTOS(F3_ENTRADA)<="'+DTOS(dDmaFin)+'"'
     cCondicao += '.And. Empty(F3_DTCANC) .And. !("CANCELAD"$F3_OBSERV)'

	 IndRegua(cAliasSF3,cArqTrab,cKey,,cCondicao)
	 nIndex := RetIndex("SF3")
	 dbSelectArea("SF3")
	 dbSetIndex(cArqTrab+OrdBagExt())

	 dbSetOrder(nIndex+1)
	 dbGoTop()
#ENDIF

SA1->(DbSetOrder(1))
SA2->(DbSetOrder(1))

dbSelectArea(cAliasSF3)

While (cAliasSF3)->(!Eof())
	nVCContr	:=	0
	nVCNCont	:=	0
	nBCContr	:=	0
	nBCNCont	:=	0

	SA1->(MsSeek(xFilial("SA1")+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA))
	SA2->(MsSeek(xFilial("SA2")+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA))
	If Val(Substr((cAliasSF3)->F3_CFO,1,1)) < 5
		cInscr	:= If((cAliasSF3)->F3_TIPO$"DB",SA1->A1_INSCR,SA2->A2_INSCR)
		cTipo   	:= If((cAliasSF3)->F3_TIPO$"DB",SA1->A1_TIPO,SA2->A2_TIPO)
	Else
		cInscr	:= If((cAliasSF3)->F3_TIPO$"DB",SA2->A2_INSCR,SA1->A1_INSCR)
		cTipo 	:= If((cAliasSF3)->F3_TIPO$"DB",SA2->A2_TIPO,SA1->A1_TIPO)
	EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณVerificacao - Contribuinte ou nao   ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	//Nao Contribuinte
    If (AllTrim ((cAliasSF3)->F3_CFO)$"618/619/545/645/553/653/751/563/663") .Or.;
    	(AllTrim ((cAliasSF3)->F3_CFO)$"6107/6108/5258/6258/5307/6307/5357/6357") .Or.;
        "ISENT" $Upper(cInscr) .Or. (Empty (cInscr) .And. cTipo!="L")
		nVCNCont	:=	(cAliasSF3)->F3_VALCONT
		nBCNCont	:=	(cAliasSF3)->F3_BASEICM

	//Contribuinte
  	Else
		nVCContr	:=	(cAliasSF3)->F3_VALCONT
		nBCContr	:=	(cAliasSF3)->F3_BASEICM
	EndIf

	If Left((cAliasSF3)->F3_CFO,1)<"5"
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณArmazena os valores por UF, desconsiderando a base de calculo nos CFOPs configurados no parametroณ
		//ณAnexo 4 - Entradas                                                                               ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If ! TR3->(dbSeek((cAliasSF3)->F3_ESTADO))
			RecLock("TR3",.T.)
			TR3->UF			:= (cAliasSF3)->F3_ESTADO
			TR3->VALCONT	:= Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,(cAliasSF3)->F3_VALCONT)
			TR3->BASEICM	:= Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,(cAliasSF3)->F3_BASEICM)
			TR3->OUTRICM	:= (cAliasSF3)->F3_OUTRICM
			TR3->ISENICM	:= (cAliasSF3)->F3_ISENICM
			TR3->ICMSRET	:= (cAliasSF3)->F3_ICMSRET
			MsUnlock()
		Else
			RecLock("TR3",.F.)
			TR3->VALCONT	+= Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,(cAliasSF3)->F3_VALCONT)
			TR3->BASEICM	+= Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,(cAliasSF3)->F3_BASEICM)
			TR3->OUTRICM	+= (cAliasSF3)->F3_OUTRICM
			TR3->ISENICM	+= (cAliasSF3)->F3_ISENICM
			TR3->ICMSRET	+= (cAliasSF3)->F3_ICMSRET
			MsUnlock()
		Endif
	Else
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณArmazena os valores por UF, desconsiderando a base de calculo nos CFOPs configurados no parametroณ
		//ณAnexo 4 - Saidas                                                                                 ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If ! TR4->(dbSeek((cAliasSF3)->F3_ESTADO))
			RecLock("TR4",.T.)
			TR4->UF			:= (cAliasSF3)->F3_ESTADO
			TR4->VALCONNC	:=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,nVCNCont)
			TR4->VALCONC	:=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,nVCContr)
			TR4->BASEICNC	:=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,nBCNCont)
			TR4->BASEICC	:=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,nBCContr)
			TR4->OUTRICM	:= (cAliasSF3)->F3_OUTRICM
			TR4->ISENICM	:= (cAliasSF3)->F3_ISENICM
			TR4->ICMSRET	:= (cAliasSF3)->F3_ICMSRET
			MsUnlock()
		Else
			RecLock("TR4",.F.)
			TR4->VALCONNC	+=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,nVCNCont)
			TR4->VALCONC	+=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cMVGMBBCIO,0,nVCContr)
			TR4->BASEICNC	+=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,nBCNCont)
			TR4->BASEICC	+=	Iif(Alltrim((cAliasSF3)->F3_CFO)$cCFATGMB,0,nBCContr)
			TR4->OUTRICM	+= (cAliasSF3)->F3_OUTRICM
			TR4->ISENICM	+= (cAliasSF3)->F3_ISENICM
			TR4->ICMSRET	+= (cAliasSF3)->F3_ICMSRET
			MsUnlock()
		Endif
	EndIf
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณAnexo 1 - Produtorณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If AllTrim((cAliasSF3)->F3_CFO) $ AllTrim(cCfoComp) .And. (cAliasSF3)->F3_ISENICM+(cAliasSF3)->F3_OUTRICM > 0
		dbSelectArea("SA2")
		dbSetOrder(1)
		If dbSeek(xFilial("SA2")+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA) .And. !Empty(SA2->A2_TIPORUR)
		    If !Empty(cCodMuni) .AND. !Empty(SA2->&(cCodMuni))
			    dbSelectArea("TR2")
			    cChave := Left(ARETDIG(SA2->A2_INSCR,.F.),10)
			    If !dbSeek(cChave)
					Reclock("TR2",.T.)
					TR2->CODMUN   := Left(SA2->&(cCodMuni),3)
					TR2->IEPRODUT := cChave
				Endif
				Reclock("TR2",.F.)
				TR2->VALCONT  += (cAliasSF3)->F3_ISENICM+(cAliasSF3)->F3_OUTRICM
				MsUnlock()
		    Endif
		Endif
	Endif
	(cAliasSF3)->(dbSkip())
Enddo

#IFDEF TOP
    dbSelectArea(cAliasSF3)
    dbCloseArea()
#ELSE
   	dbSelectArea("SF3")
	RetIndex("SF3")
	dbClearFilter()
	Ferase(cArqTrab+OrdBagExt())
#ENDIF
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณProcessando as movimentacoes por Pais - Anexo 6                       ณ
//ณSera gerada uma linha para cada 15 paises cadastrados no manual da GMBณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณGrupos de paises                    ณ
//ณ[01] Codigo do Grupo                ณ
//ณ[02] Codigo do Pais                 ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
// Grupo 001
For nX :=  1 To 15
	Aadd(aGrpPais,{01,nX,0,0})
Next
// Grupo 002
For nX :=  16 To 30
	Aadd(aGrpPais,{02,nX,0,0})
Next
//Grupo 003
For nX :=  31 To 45
	Aadd(aGrpPais,{03,nX,0,0})
Next
// Grupo 004
For nX :=  46 To 53
	Aadd(aGrpPais,{04,nX,0,0})
Next
For nX :=  100 To 106
	Aadd(aGrpPais,{04,nX,0,0})
Next
// Grupo 005
For nX :=  107 To 119
	Aadd(aGrpPais,{05,nX,0,0})
Next
Aadd(aGrpPais,{05,200,0,0})
Aadd(aGrpPais,{05,201,0,0})
// Grupo 006
Aadd(aGrpPais,{06,202,0,0})
For nX :=  300 To 310
	Aadd(aGrpPais,{06,nX,0,0})
Next
// Brasil nao deve ser apresentado
Aadd(aGrpPais,{06,0,0,0})
Aadd(aGrpPais,{06,400,0,0})
Aadd(aGrpPais,{06,402,0,0})
// Grupo 007
For nX :=  403 To 417
	Aadd(aGrpPais,{07,nX,0,0})
Next
// Grupo 008
For nX :=  418 To 432
	Aadd(aGrpPais,{08,nX,0,0})
Next
// Grupo 009
For nX :=  433 To 442
	Aadd(aGrpPais,{09,nX,0,0})
Next
For nX :=  500 To 504
	Aadd(aGrpPais,{09,nX,0,0})
Next
// Grupo 010
For nX :=  505 To 519
	Aadd(aGrpPais,{10,nX,0,0})
Next
// Grupo 011
For nX :=  520 To 534
	Aadd(aGrpPais,{11,nX,0,0})
Next
// Grupo 012
For nX :=  535 To 546
	Aadd(aGrpPais,{12,nX,0,0})
Next
For nX :=  600 To 602
	Aadd(aGrpPais,{12,nX,0,0})
Next
// Grupo 013
For nX :=  603 To 613
	Aadd(aGrpPais,{13,nX,0,0})
Next

ResumeF3("IC",dDmainc,dDmaFin,"*",.F.,.F.,1,.F.,2,Nil,Nil,{},{},"",.T.,"EXP",.F.,.T.,,,,,,,,,,,,,,,,,,,,,,,,.F.)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณValor contabil das entradas e saidas por paisณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
EXP->(dbGoTop())
Do While ! EXP->(Eof())

	nPos := aScan(aGrpPais,{|x| x[02] == Val(EXP->CODPAIS)})
	If AllTrim(EXP->CFOP) == "ENTR"
		aGrpPais[nPos][03] += EXP->VALCONT
	Else
		aGrpPais[nPos][04] += EXP->VALCONT
	Endif

	EXP->(dbSkip())

Enddo

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณMontando o temporario com 15 paises por linhaณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
nChave 		:= 1
cRegistro	:= ""
For nX := 1 To Len(aGrpPais)
	// Grava apenas 1 registro por grupo de pais
	If nChave <> aGrpPais[nX][01]
		RecLock("TR6",.T.)
		TR6->GRUPO		:= nChave
		TR6->REGISTRO 	:= cRegistro
		MsUnLock()
		cRegistro	:= StrZero(aGrpPais[nX][02],3) + StrTran(StrZero(aGrpPais[nX][03],17,2),".","") + StrTran(StrZero(aGrpPais[nX][04],17,2),".","")
		nChave 		:= aGrpPais[nX][01]
	Else
		cRegistro 	:= AllTrim(cRegistro) + StrZero(aGrpPais[nX][02],3) + StrTran(StrZero(aGrpPais[nX][03],17,2),".","") + StrTran(StrZero(aGrpPais[nX][04],17,2),".","")
	Endif
Next
// Ultimo Registro
If nChave <> 1 .And. !Empty(cRegistro)
	RecLock("TR6",.T.)
	TR6->GRUPO		:= nChave
	TR6->REGISTRO 	:= AllTrim(cRegistro) + Replicate("0",525-Len(Alltrim(cRegistro)))
	MsUnLock()
Endif

Return(aTRBS)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณxMagValFisณ Autor ณGustavo G. Rueda       ณ Data ณ31.08.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณRetorna valores fiscais por item (SD1, SD2).                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณnRet -> Valor encontrado de acordo com a referencia passada.ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณnEntSai -> Indica o tratamento de NF Entrada=1 ou NF Saida=2ณฑฑ
ฑฑณ          ณnRecSf1 -> Indica o Recno da tabela SF1 caso o alias nao    ณฑฑ
ฑฑณ          ณ  nao seja passado.                                         ณฑฑ
ฑฑณ          ณcAliasSf1 -> Indica o alias para a tabela SF1 (podendo ser  ณฑฑ
ฑฑณ          ณ  uma query). Se passarmos este alias, esta presumindo que  ณฑฑ
ฑฑณ          ณ  a tabela SF1 ja esteja posicionada, caso esta variavel es-ณฑฑ
ฑฑณ          ณ  teja vazio, he necessario passar o recno para o posiciona-ณฑฑ
ฑฑณ          ณnItem -> Indica o numero do registro da tabela SD1 a ser    ณฑฑ
ฑฑณ          ณ  processada.                                               ณฑฑ
ฑฑณ          ณcReferencia -> Valor a ser encontrado. Referencia relaciona-ณฑฑ
ฑฑณ          ณ  da ao campo do Livro na MatxFis.                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function xMagValFis (nEntSai, nRecSF, cAliasSf, nItem, cReferencia)
	Local	nRet	:=	0
	Default nRecSF	:=	0
	//
   	MaFisIniNf (nEntSai, nRecSF,, cAliasSf, .F.)
        nRet	:=	MaFisRet (nItem, cReferencia)
    MaFisEnd ()
Return (nRet)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออัออออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFunctionณPosTms      บAutor  ณGustavo G. Rueda    บ Data ณ  25/07/00   บฑฑ
ฑฑฬออออออออุออออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.   ณIntegracao com o Tms para identificacao do destinatario da    บฑฑ
ฑฑบ        ณ mercadoria.                                                  บฑฑ
ฑฑฬออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso     ณ MATA972                                                      บฑฑ
ฑฑศออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function PosTms (cDoc, cSerie)
	Local	lRet		:=	.T.
	Local	aSavAreaAnt	:=	GetArea ()
	//
	DbSelectArea ("DT6")
		DT6->(DbSetOrder (1))
	DT6->(DbSeek (xFilial ("DT6")+cFilAnt+cDoc+cSerie))
	//
	Do Case
	   Case DT6->DT6_DEVFRE == "1" //Remetente
		   SA1->(dbSeek (xFilial ("SA1")+DT6->DT6_CLIDES+DT6->DT6_LOJDES))
	   Case DT6->DT6_DEVFRE == "2" //Destinatario
		   SA1->(dbSeek (xFilial ("SA1")+DT6->DT6_CLIREM+DT6->DT6_LOJREM))
	   Case DT6->DT6_DEVFRE == "3" //Consignatario
		   SA1->(dbSeek (xFilial ("SA1")+DT6->DT6_CLICON+DT6->DT6_LOJCON))
	   Case DT6->DT6_DEVFRE == "4" //Despachante
		   SA1->(dbSeek (xFilial ("SA1")+DT6->DT6_CLIDPC+DT6->DT6_LOJDPC))
	EndCase
	//
	RestArea (aSavAreaAnt)
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณxMagWizardณ Autor ณGustavo G. Rueda       ณ Data ณ29.10.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณGravo os dados inseridos nos objetos no txt (.WIZ).         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet (.T.)                                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC -> Nome do arquivo a ser importado para um array.      ณฑฑ
ฑฑณ          ณExpA -> Array contendo o conteudo da importacao do TXT.     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function xMagWizard (aTxtApre, aPaineis, cNomeWizard,cNomeAnt)
	Local 	aArea 		:=	GetArea()
	Local	nInd  		:=	0
	Local	nInd2 		:=	0
	//
	Local	oFont
	Local	oWizard
	Local	cVar		:=	""
	Local 	aVarPaineis	:=	{}
	Local	nLinha		:=	0
	Local	nColuna		:=	10
	Local	nTamCmpDlg	:=	115
	Local	lMarkCB		:=	.F.
	Local	aIniWiz		:=	{}
	Local	lIniWiz		:=	.F.
	Local	lFim		:=	.F.
	Local	nObject		:=	0
	Local	lRet		:=	.T.
	Local	lGetRdOnly	:=	.F.
	Local	bProcura	:=	{||}
	Local	cAlsF3		:=	""
	Local	lInitPad	:= .F.
	Local	bValidGet	:=	{||}
	Local	aFunParGet	:=	{}
	//-- Verifico se ้ Execu็ใo via rotina automatica
	local  lAutomato   := IiF(IsBlind(),.T.,.F.)

	Default cNomeAnt	:= ""

If !lAutomato
	lIniWiz := xMagLeWiz (If(Empty(cNomeAnt),cNomeWizard,cNomeAnt), @aIniWiz)

	//
	Define FONT oFont NAME "Arial" SIZE 0, -11 BOLD
	//
	Define WIZARD oWizard ;
		TITLE SubStr (aTxtApre[1], 1, 80);
		HEADER SubStr (aTxtApre[2], 1, 80);
		MESSAGE SubStr (aTxtApre[3], 1, 80);
		TEXT aTxtApre[4];
		NEXT {|| .T.};
		FINISH {|| .T.}
	//
	For nInd := 1 To Len (aPaineis)
		CREATE PANEL oWizard  ;
			HEADER aPaineis[nInd][1];
			MESSAGE aPaineis[nInd][2];
			BACK {||.T.} ;
			NEXT {|| .T.};
			FINISH {|| lFim := .T.}
		/*
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณEsta array aVarPaineis contem as variaveis objetos dos componentes de cada painel . Sua estrutura e a seguinte:ณ
		//ณ1-{<conteudo atribuido ao componente atraves da dialog>,<variavel do objeto componente>}                       ณ
		//ณ2-...                                                                                                          ณ
		//ณ3-...                                                                                                          ณ
		//ณ.                                                                                                              ณ
		//ณ.                                                                                                              ณ
		//ณOBS: As linhas do array indicam cada componente do respectivo painel.                                          ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		*/
		aAdd (aVarPaineis, {})
		//
		nLinha	:=	0
		nColuna	:=	10
		nObject	:=	0
		//
		For nInd2 := 1 To Len (aPaineis[nInd][3])
			If (nInd2%2==0)
				nColuna	:=	nTamCmpDlg+20
			Else
				nColuna	:=	10
				nLinha	+=	10
			EndIf
			//
            nTpObj		:=	Iif (aPaineis[nInd][3][nInd2][1]==Nil, 0, aPaineis[nInd][3][nInd2][1])					//Tipo do objeto = 1=SAY, 2=MSGET, 3=COMBOBOX, 4=CHECKBOX, 5=LISTBOX, 6=RADIO       (OBRIGATORIO)
            cTitObj		:=	Iif (aPaineis[nInd][3][nInd2][2]==Nil, "", OemToAnsi (aPaineis[nInd][3][nInd2][2]))	//Titulo do objeto, quando tiver. Ex: SAY(Caption), CHECKBOX.						(G=OPCIONAL, E=OBRIGATORIO)
            cPctObj		:=	Iif (aPaineis[nInd][3][nInd2][3]==Nil, "", aPaineis[nInd][3][nInd2][3])					//Picture quando for necessario. Ex: MSGET.											(G=OPCIONAL, E=OBRIGATORIO)
            cTpContObj	:=	Iif (aPaineis[nInd][3][nInd2][4]==Nil, "", aPaineis[nInd][3][nInd2][4])					//Tipo de conteudo do objeto. Ex: 1=Caracter, 2=Numerico, 3=Data.					(G=OPCIONAL, E=OBRIGATORIO)
            nDecObj		:=	Iif (aPaineis[nInd][3][nInd2][5]==Nil, 0, aPaineis[nInd][3][nInd2][5])					//Numero de casas decimais do objeto MSGET caso seja numerico.						(G=OPCIONAL, E=OBRIGATORIO)
            aItObj		:=	Iif (aPaineis[nInd][3][nInd2][6]==Nil, {}, aPaineis[nInd][3][nInd2][6])					//Itens de selecao dos objetos. Ex: COMBOBOX, LISTBOX, RADIO.					    (G=OPCIONAL, E=OBRIGATORIO)
            lMarkCB		:=	Iif (aPaineis[nInd][3][nInd2][7]==Nil, .F., aPaineis[nInd][3][nInd2][7])				//Opcao de selecao do item quando CHECKBOX. Determina se iniciara marcado ou nao.	(G=OPCIONAL, E=OBRIGATORIO)
            nNumIntObj	:=	Iif (aPaineis[nInd][3][nInd2][8]==Nil, 0, aPaineis[nInd][3][nInd2][8])					//Numero de casas inteiras quando o conteudo do objeto MSGET for numerico.			(G=OPCIONAL, E=OBRIGATORIO)
            //
            //--------------------------------------------------
            //Tratamento para casos em que eh passada posicao 9
            //--------------------------------------------------
            If (Len (aPaineis[nInd][3][nInd2])>=9) .And. !aPaineis[nInd][3][nInd2][9]==Nil
	            lGetRdOnly	:=	aPaineis[nInd][3][nInd2][9][1]
            	cTitObj		:=	aPaineis[nInd][3][nInd2][9][2]
            	If Len(aPaineis[nInd][3][nInd2][9]) >= 3
            		lInitPad := aPaineis[nInd][3][nInd2][9][3]
            	Else
	            	lInitPad := aPaineis[nInd][3][nInd2][9][1]
            	EndIf
            Else
	            lGetRdOnly	:=	.F.
            EndIf
            //--------------------------------------------------
			//Tratamento para casos em que eh passada posicao 10
			//--------------------------------------------------
            If (Len (aPaineis[nInd][3][nInd2])>=10) .And. !aPaineis[nInd][3][nInd2][10]==Nil
				lGetFile	:=	aPaineis[nInd][3][nInd2][10]
			Else
				lGetFile	:=	.F.
			EndIf
			//--------------------------------------------------
			//Tratamento para casos em que eh passada posicao 11
			//--------------------------------------------------
			If (Len (aPaineis[nInd][3][nInd2])>=11) .And. !aPaineis[nInd][3][nInd2][11]==Nil
				cAlsF3	:=	aPaineis[nInd][3][nInd2][11]
			Else
				cAlsF3	:=	""
			EndIf
			//--------------------------------------------------
			//Tratamento para casos em que eh passada posicao 12
			//
			//Utilizado para validar o conteudo dos campos da wizard. Devera ser enviado dentro de um array o nome da funcao que
			//sera utilizada para realizar a validacao e os parametros necessarios para processar esta funcao.
			//Exemplo de utilizacao: SPEDFISCAL (SpedMntWiz)
			//--------------------------------------------------
			If (Len (aPaineis[nInd][3][nInd2])>=12) .And. !aPaineis[nInd][3][nInd2][12]==Nil
				aFunParGet	:=	aPaineis[nInd][3][nInd2][12]
			Else
				aFunParGet	:=	{}
				bValidGet	:=	{||}
			EndIf
			/*
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณSe ja exisitir um .WIZ criado anteriormente carrego-o para exibicao e alteracao conforma necessidade.ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			*/
            If (lIniWiz) .And. (nTpObj>=2 .And. nTpObj<=6)	//Somente objetos que geram txt.
            	//Contador somente dos objetos que irao gerar o txt para que se possa recupera-lo na ordem de exibicao dos objetos de cada painel.
	            nObject++
	            //No caso de CHECKBOX nao posso armazenar "" e sim logico.
	            If (nTpObj==4)
		            aAdd (aVarPaineis[nInd], {Iif (nTpObj==4, lMarkCB, ""),})
	           	Else
		           	aAdd (aVarPaineis[nInd], {"",})
	  			EndIf
				//Contem somente o conteudo que sera atribuido em cada objeto. Sem o clausula {OBJ???} que eh gerado no txt.
				If( Len( aIniWiz )>=nInd )
					If (Len (aIniWiz[nInd])>=nObject)
			            cStrIniWiz	:=	SubStr (aIniWiz[nInd][nObject], 13)
			  		Else
				  		cStrIniWiz	:=	""
				  	EndIf
		  		Else
			  		cStrIniWiz	:=	""
			  	EndIf
			  	//
			  	//Caso venha conteudo a ser utilizado pelo wizard devo desconsiderar os valores de antes e assumir sempre o default passado como parametro
	            If (lInitPad) .And. !(Empty (cTitObj)) .And. nTpObj==2
					cStrIniWiz	:=	cTitObj
				EndIf
	     	ElseIf	(lIniWiz) .And. (nTpObj>=0 .And. nTpObj<=1)	//Somente objetos que NAO geram txt.
		     	aAdd (aVarPaineis[nInd], {"",})

		    ElseIf !(lIniWiz) .And. (nTpObj>=0 .And. nTpObj<=6)	//Caso nao tenha um .WIZ anterior, carrego os objetos normalmente e no padrao. (Branco ou logicos).

	            If (lGetRdOnly) .And. !(Empty (cTitObj)) .And. nTpObj==2
					cStrIniWiz	:=	cTitObj
				EndIf
				aAdd (aVarPaineis[nInd], {Iif (nTpObj==4, lMarkCB, ""),})
            EndIf
			//
			//Quando o tipo de objeto for SAY, devo tratar comente como informativo, ou seja, somente para exibicao na dialog.
			If (nTpObj==1)
				aVarPaineis[nInd][nInd2][2]	:=	TSay ():New (nLinha, nColuna, &("{ | u | If( PCount() == 0, aVarPaineis["+Str (nInd)+"]["+ Str (nInd2)+"][1], aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1] := u ) }"), oWizard:oMPanel[nInd+1],,,.F.,.F.,.F., .T., CLR_BLUE,, nTamCmpDlg, 10, .F., .F., .F., .F., .F.)
					aVarPaineis[nInd][nInd2][2]:cCaption	:=	cTitObj

			//Quando o tipo de objeto for tipo MSGET devo tratar os casos de terem conteudo como Caracter, Numerico ou Data.
			ElseIf (nTpObj==2)
				If (cTpContObj==1)	//Caracter
					If (lIniWiz)
						aVarPaineis[nInd][nInd2][1]	:=	cStrIniWiz + IIf(nNumIntObj > Len(cStrIniWiz),Space(nNumIntObj - Len(cStrIniWiz)),"")
					Else
						aVarPaineis[nInd][nInd2][1]	:=	Iif (!Empty (cTitObj), cTitObj, Space (nNumIntObj))
					EndIf

				ElseIf (cTpContObj==2)	//Numerico
					If (lIniWiz)
						aVarPaineis[nInd][nInd2][1]	:=	Val (cStrIniWiz)
					ElseIf (nDecObj==0)
						aVarPaineis[nInd][nInd2][1]	:=	Val (Replicate ("0", nNumIntObj))
					Else
						aVarPaineis[nInd][nInd2][1]	:=	Val (Replicate ("0", nNumIntObj)+"."+Replicate ("0", nDecObj))
					EndIf

				ElseIf (cTpContObj==3)	//Data
					If (lIniWiz)
						aVarPaineis[nInd][nInd2][1]	:=	SToD (cStrIniWiz)
					Else
						aVarPaineis[nInd][nInd2][1]	:=	CToD ("  /  /  ")
					EndIf

				EndIf

				//Verifica se utiliza validacao do conteudo do campo na wizard. Executa bloco de codigo conforme funcao e parametros enviados
				If !Empty(aFunParGet)
					aFunparGet[2]	:=	Iif ( ValType(aFunparGet[2])=="N",	Str(aFunparGet[2]),	aFunparGet[2] )
					aAdd(aFunParGet,Alltrim ( Iif ( ValType(cTpContObj)=="N",Str(cTpContObj),cTpContObj) ) )
					bValidGet	:=	& ( '{|| ' + aFunParGet[1] + '(' + aFunParGet[2] + ',' + aFunParGet[3] + ', aVarPaineis['+Str(nInd)+']['+Str(nInd2)+']' + ') }' )
				Endif

				aVarPaineis[nInd][nInd2][2]	:=	TGet ():New (nLinha, nColuna, &("{ | u | If( PCount() == 0, aVarPaineis["+Str (nInd)+"]["+ Str (nInd2)+"][1], aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1] := u ) }"), oWizard:oMPanel[nInd+1], nTamCmpDlg-Iif (lGetFile, 30, 0), 9, cPctObj,bValidGet,,,,,, .T.,,,,,,,lGetRdOnly,,cAlsF3)
				If lGetFile
					bProcura	:=	&('{|| aVarPaineis['+Str (nInd)+']['+str(nInd2)+'][1] := cGetFile ("", OemToAnsi ("Procurar"),,,,12345), Iif (Empty (aVarPaineis['+Str (nInd)+']['+str(nInd2)+'][1]), aVarPaineis['+Str (nInd)+']['+str(nInd2)+'][1] := Space (115), Nil)}')
					TButton ():New (nLinha, nColuna+nTamCmpDlg-30, OemToAnsi (STR0104), oWizard:oMPanel[nInd+1], bProcura, 30, 12,,, .F., .T., .F.,, .F.,,, .F.)
				EndIf

			ElseIf (nTpObj==3)		//Quando o objeto for do tipo COMBOBOX
				If (lIniWiz)
					aVarPaineis[nInd][nInd2][1]	:=	cStrIniWiz
				EndIf
				aVarPaineis[nInd][nInd2][2]	:=	TCombobox ():New (nLinha, nColuna, &("{ | u | If( PCount() == 0, aVarPaineis["+Str (nInd)+"]["+ Str (nInd2)+"][1], aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1] := u ) }"), aItObj, nTamCmpDlg, 10, oWizard:oMPanel[nInd+1],,,,,,.T.)

			ElseIf (nTpObj==4)		//Quando o objetvo for do tipo CHECKBOX devo converter caso exista um .WIZ para booleano.
				If (lIniWiz)
					If ("T"$cStrIniWiz)
						aVarPaineis[nInd][nInd2][1]		:=	.T.
					Else
						aVarPaineis[nInd][nInd2][1]		:=	.F.
					EndIf
				EndIf
		  		//
			 	aVarPaineis[nInd][nInd2][2]	:=	TCheckBox ():New (nLinha, nColuna, cTitObj, &("{ | u | If( PCount() == 0, aVarPaineis["+Str (nInd)+"]["+Str (nInd2)+"][1], aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1] := u ) }"), oWizard:oMPanel[nInd+1], nTamCmpDlg, 10,,,,, CLR_BLUE,,,.T.)
/*
			ElseIf (nTpObj==5)
				@nInd2*10, 010 LISTBOX aVarPaineis[nInd2][2] Var aVarPaineis[nInd2][1] ITEMS aItObj SIZE 050, 10 PIXEL OF oWizard:oMPanel[nInd+1]
				aVarPaineis[nInd2][2]:SetArray (aItObj)
*/
			ElseIf (nTpObj==6)
				If (lIniWiz)
					aVarPaineis[nInd][nInd2][1]	:=	Val (cStrIniWiz)
				EndIf
				aVarPaineis[nInd][nInd2][2]	:=	TRadMenu ():New (nLinha, nColuna, aItObj, &("{ | u | If( PCount() == 0, aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1], aVarPaineis["+Str (nInd)+"]["+str(nInd2)+"][1] := u ) }"), oWizard:oMPanel[nInd+1],,,,,,,, nTamCmpDlg, 10,,,, .T.)
			EndIf
		Next (nInd2)
	Next (nInd)
	//
	Activate WIZARD oWizard Centered
	//
	//lFim indica se o botao fim foi pressionado. .T.=Sim ou .F.=Nao.
	If (lFim)
		GravaWizard (cNomeWizard, aVarPaineis, aPaineis)
	Else
		lRet	:=	.F.
	EndIf
	//
	RestArea(aArea)
EndIf

Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณGravaWizarณ Autor ณGustavo G. Rueda       ณ Data ณ29.10.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณGravo os dados inseridos nos objetos no txt (.WIZ).         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet (.T.)                                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC -> Nome do arquivo a ser importado para um array.      ณฑฑ
ฑฑณ          ณExpA -> Array contendo o conteudo da importacao do TXT.     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function GravaWizard (cNomeWizard, aVarPaineis, aPaineis)
	Local	lRet			:=	.T.
	Local	cConteudo		:=	""
	Local	cFile			:=	cNomeWizard+".CFP"
	Local	cArqBkp			:=	StrTran	(cFile,	".CFP",	".#FP")
	Local	nInd			:=	0
	Local	nInd2			:=	0
	Local	nQtdCasasInt	:=	0
	Local	nQtdCasasDec	:=	0
	Local	nTipObj			:=	0
	Local	nCtdObj			:=	1
	Local	nPadR			:=	0
	//
	If (File (cFile))
		If File (cArqBkp)
			FErase (cArqBkp)
		Endif
		FRename (cFile, cArqBkp)
	Endif
	nHandle	:=	MsFCreate (cFile)
	//
	For nInd := 1 To Len (aVarPaineis)
		//
		nCtdObj		:=	1
		cConteudo	:=	"{PAINEL"+StrZero (nInd, 3)+"}"+Chr (13)+Chr (10)
		FWrite (nHandle, cConteudo, Len (cConteudo))
		//
		For nInd2 := 1 To Len (aVarPaineis[nInd])
			nQtdCasasInt	:=	aPaineis[nInd][3][nInd2][8]
			nQtdCasasDec	:=	aPaineis[nInd][3][nInd2][5]
			nTipObj			:=	aPaineis[nInd][3][nInd2][1]
			//
			//Tratamento para gravacao de objetos com retorno logigos, tipo CHECKBOX
			If (ValType (aVarPaineis[nInd][nInd2][1])=="L")
				If (aVarPaineis[nInd][nInd2][1])
					cConteudo	:=	"T"+Chr (13)+Chr (10)
				Else
					cConteudo	:=	"F"+Chr (13)+Chr (10)
				EndIf
				nPadR	:=	1

			//Tratamento da gravacao do objeto GET com conteudo do tipo DATA
			ElseIf (ValType (aVarPaineis[nInd][nInd2][1])=="D")
				cConteudo	:=	DToS (aVarPaineis[nInd][nInd2][1])+Chr (13)+Chr (10)
				nPadR		:=	8

			//tratamento da gravacao do objeto GET com conteudo NUMERICO+CASAS DECIMAIS.
			ElseIf (ValType (aVarPaineis[nInd][nInd2][1])=="N")
				If nTipObj==6
					cConteudo	:=	StrZero (aVarPaineis[nInd][nInd2][1], 3, 0)+Chr (13)+Chr (10)
					nPadR	:=	3
				ElseIf (nQtdCasasDec==0)
					cConteudo	:=	StrZero (aVarPaineis[nInd][nInd2][1], nQtdCasasInt, 0)+Chr (13)+Chr (10)
					nPadR	:=	nQtdCasasInt
				Else
					cConteudo	:=	StrZero (aVarPaineis[nInd][nInd2][1], nQtdCasasInt+nQtdCasasDec+1, nQtdCasasDec)+Chr (13)+Chr (10)	//O 1 eh por causa do ponto Ex: 99.99
					nPadR	:=	nQtdCasasInt+nQtdCasasDec+1
				EndIf

			Else
				//Tratamento do objeto GET para conteudos CARACTER onde devera menter a quantidade de casas na gravacao para que nao
				//	ocasione problema de truncagem no momendo da recuperacao das informacoes para exibicao no CFP.
				If (nQtdCasasInt<>Nil .And. nQtdCasasInt>0)
					cConteudo	:=	SubStr (aVarPaineis[nInd][nInd2][1], 1, nQtdCasasInt)+Chr (13)+Chr (10)
					nPadR		:=	nQtdCasasInt
				Else
					cConteudo	:=	aVarPaineis[nInd][nInd2][1]+Chr (13)+Chr (10)
					nPadR		:=	Len (aVarPaineis[nInd][nInd2][1])
				EndIf

			EndIf
			//
			If (nTipObj>1)
				cConteudo	:=	"{OBJ"+StrZero (nCtdObj++, 3)+";"+AllTrim (StrZero (nPadR, 3))+"}"+cConteudo
				FWrite (nHandle, cConteudo, Len (cConteudo))
			EndIf
		Next (nInd2)
	Next (nInd)
	//
	If (nHandle>=0)
		FClose (nHandle)
	Endif
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณxMagLeWiz ณ Autor ณGustavo G. Rueda       ณ Data ณ29.10.2004ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณLe o TXT WIZ.                                               ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet (.T.)                                          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC -> Nome do arquivo a ser importado para um array.      ณฑฑ
ฑฑณ          ณExpA -> Array contendo o conteudo da importacao do TXT.     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function xMagLeWiz (cArqIni, aIniWiz, lSubStr)
	Local 		cIni		:=	cArqIni+".CFP"
	Local 		nI			:=	0
	Local 		nJ			:=	0
	Local		lRet		:=	.T.
	Local		nPadR		:=	0
	local  lAutomato   := IiF(IsBlind(),.T.,.F.)
	//
	Default	lSubStr	:=	.F.

If !lAutomato
	//
	If !File (cIni)
		lRet	:=	.F.
	Else
		FT_FUse(cIni)
		FT_FGoTop()
		While ( !FT_FEof() )
			cLinha := FT_FReadLn()
			If ("PAINEL"$cLinha)
				aAdd (aIniWiz, {})
			Else
				aAdd (aIniWiz[Len (aIniWiz)], cLinha)
			EndIf
			FT_FSkip()
		Enddo
		FT_FUse()
	Endif
	//
	If (lSubStr)
		For nJ := 1 To Len (aIniWiz)
			For nI := 1 To Len (aIniWiz[nJ])
				If (SubStr (aIniWiz[nJ][nI], 8, 1)==";")
					nPadR	:=	Val (SubStr (aIniWiz[nJ][nI], 9, 3))
					aIniWiz[nJ][nI]	:=	SubStr (aIniWiz[nJ][nI], 13, nPadR)
				Else
					aIniWiz[nJ][nI]	:=	SubStr (aIniWiz[nJ][nI], 9)
				EndIf
			Next (nI)
		Next (nJ)
	EndIf
Else
	If Type("aWizAuto") == "A"
		aIniWiz := aWizAuto
	EndIf	
EndIf

Return (lRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณA325Producaoณ Autor ณ Nereu Humberto Junior ณ Data ณ 11.11.04 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณRetorna quantidade produzida (Envasados - SD3)                ณฑฑ
ฑฑณ          ณRetorna quantidade produzida (Insumos - SD3)                  ณฑฑ
ฑฑณ          ณRetorna quantidade utilizada na producao (Insumos - SD3)      ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function A325Producao(aLocais,dDtIni,dDtFim,nTipProd,cTpDecl)

Local aArea	 		:= GetArea()
Local nX     		:= 0
Local nQuant 		:= 0
Local nUtiliza		:= 0
Local cDec   		:= ""
Local cAliasSD3		:= "SD3"
Local cAliasSB1 	:= "SB1"
Local cAliasSB5		:= "SB5"
Local lQuery		:= .F.
Local lValido		:= .T.
Local nVolReci		:= 0
Local nOutEnt		:= 0
Local nOutSai		:= 0
#IFDEF TOP
	Local aStruSD3	:= {}
#ELSE
	Local cIndSD3	:= ""
	Local cChave	:= ""
	Local cFiltro	:= ""
	Local nIndex 	:= 0
#ENDIF

dbSelectArea("SD3")
dbSetOrder(1)
#IFDEF TOP
	lQuery 		:= .T.
	cAliasSD3 	:= "SRF325SD3"
	cAliasSB5 	:= "SRF325SD3"
	cAliasSB1 	:= "SRF325SD3"
	aStruSD3  	:= SD3->(dbStruct())
    cQuery := "SELECT SD3.*,SB1.B1_POSIPI, SB1.B1_EX_NCM, SB1.B1_COD, SB5.B5_INSUMO, SB5.B5_VOLRECI, SB5.B5_CODISRF, SB5.B5_COD "
    cQuery += "FROM "+RetSqlName("SD3")+" SD3, "
    cQuery += RetSqlName("SB1")+" SB1, "
   	cQuery += RetSqlName("SB5")+" SB5 "
    cQuery += "WHERE SD3.D3_FILIAL='"+F3Filial("SD3")+"' AND "
	cQuery += "SD3.D3_EMISSAO BETWEEN '"+DTOS(dDtIni)+"' AND '"+DTOS(dDtFim)+"' AND "
    cQuery += "SD3.D_E_L_E_T_=' ' AND "
    cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
    cQuery += "SB1.B1_COD=SD3.D3_COD AND "
    If nTipProd == 1
	    cQuery += "(SB1.B1_POSIPI IN('39011010','39011091','39011092','39012011','39012019','39012021','39012029') OR "
	    cQuery += "SB1.B1_POSIPI IN('39021010','39021020','39023000','39076000','39232110','39232190','39233000') OR "
		cQuery += "SB1.B1_POSIPI IN('39235000','45031000','48115122','48115923','70109011','70109021','70109090') OR "
		cQuery += "SB1.B1_POSIPI IN('73102110','73102910','76129019','83091000','83099000') ) AND "
	ElseIf nTipProd == 2
	   	cQuery += "(SB1.B1_POSIPI LIKE '2201%' OR SB1.B1_POSIPI LIKE '2202%' OR SB1.B1_POSIPI LIKE '2203%' OR SB1.B1_POSIPI LIKE '2204%' OR "
	   	cQuery += "SB1.B1_POSIPI LIKE '2205%' OR SB1.B1_POSIPI LIKE '2206%' OR SB1.B1_POSIPI LIKE '2208%') AND "
	Endif
    cQuery += "SB1.D_E_L_E_T_=' ' AND "
   	cQuery += "SB5.B5_FILIAL='"+xFilial("SB5")+"' AND "
    cQuery += "SB5.B5_COD=SD3.D3_COD AND "
    cQuery += "SB5.D_E_L_E_T_=' '  "
   	cQuery += "ORDER BY "+SqlOrder(SD3->(IndexKey()))

    cQuery := ChangeQuery(cQuery)
    dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD3)
    For nX := 1 To Len(aStruSD3)
   	 	If aStruSD3[nX][2]<>"C"
			TcSetField(cAliasSD3,aStruSD3[nX][1],aStruSD3[nX][2],aStruSD3[nX][3],aStruSD3[nX][4])
		EndIf
    Next nX
#ELSE
	dbSelectArea(cAliasSD3)
	cIndSD3	:=	CriaTrab(NIL,.F.)
	cChave	:=	IndexKey()
	cFiltro	:=	"D3_FILIAL=='"+F3Filial("SD3")+"'"
	cFiltro	+=	" .And. DTOS(D3_EMISSAO)>='"+DTOS(dDtIni)+"' .AND. DTOS(D3_EMISSAO)<='"+DTOS(dDtFim)+"'"
	IndRegua(cAliasSD3,cIndSD3,cChave,,cFiltro)
	nIndex := RetIndex("SD3")
	dbSelectArea("SD3")
	dbSetIndex(cIndSD3+OrdBagExt())
	dbSetOrder(nIndex+1)
	dbSelectArea(cAliasSD3)
	dbGoTop()
#ENDIF

While (cAliasSD3)->(!Eof())

	lValido := .F.

	SB1->(MsSeek(xFilial("SB1")+(cAliasSD3)->D3_COD))
	nVolReci := &(SuperGetMv("MV_VOLRECI"))

	If !lQuery

		SB5->(dbSetOrder(1))
		lValido := SB5->(MsSeek(xFilial("SB5")+(cAliasSD3)->D3_COD))

		If nTipProd == 1
		    If nTipProd == 1 .And. lValido .And. ;
			    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39011010#39011091#39011092#39012011#39012019#39012021#39012029" .And.;
	   		    !Alltrim((cAliasSB1)->B1_POSIPI) $ "39021010#39021020#39023000#39076000#39232110#39232190#39233000" .And.;
				!Alltrim((cAliasSB1)->B1_POSIPI) $ "39235000#45031000#48115122#48115923#70109011#70109021#70109090" .And.;
				!Alltrim((cAliasSB1)->B1_POSIPI) $ "73102110#73102910#76129019#83091000#83099000"
				lValido := .F.
			Endif
		ElseIf nTipProd == 2 .And. lValido
			If !(Left((cAliasSB1)->B1_POSIPI,4) $ "2201#2202#2203#2204#2205#2206#2208")
				lValido := .F.
			Endif
		Endif
	Else
		lValido := .T.
	EndIf

	If lValido

		If cTpDecl=="1" // mensal
			cDec := SubStr(DTOS((cAliasSD3)->D3_EMISSAO),1,6)+"0"
		Else
			cDec := SubStr(DTOS((cAliasSD3)->D3_EMISSAO),1,6)+IIF(Day((cAliasSD3)->D3_EMISSAO)<=10,"1",IIF(Day((cAliasSD3)->D3_EMISSAO)<=20,"2","3"))
		Endif

		dbSelectArea("TRB")
		nCapacidade := Iif (nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
		If !MsSeek(Str((cAliasSB5)->B5_CODISRF,6)+Str((cAliasSB5)->B5_INSUMO,3)+Str(nCapacidade,5)+(cAliasSB5)->B5_COD+cDec)
			RecLock("TRB",.T.)
			TRB->CODIGO 	:= (cAliasSB1)->B1_COD
			TRB->NCM 		:= (cAliasSB1)->B1_POSIPI
			TRB->DECENDIO 	:= cDec
			TRB->EX  		:= (cAliasSB1)->B1_EX_NCM
			TRB->INSUMO  	:= (cAliasSB5)->B5_INSUMO
			TRB->CODIGOSRF 	:= (cAliasSB5)->B5_CODISRF
			TRB->VOLRECI 	:= IIF(nVolReci==0,(cAliasSB5)->B5_VOLRECI,nVolReci)
			TRB->EMISSAO 	:= (cAliasSD3)->D3_EMISSAO
			TRB->DLOCAL 	:= (cAliasSD3)->D3_LOCAL
		    TRB->FILB5  	:=  xFilial("SB5")
			If Substr(cDec,7,1) == "1" .Or. Substr(cDec,7,1) == "0"
				aSaldo := CalcEst((cAliasSD3)->D3_COD,(cAliasSD3)->D3_LOCAL,dDtIni)
				TRB->ESTINICIO := aSaldo[1]
			Endif
		    MsUnlock()
		Endif
		nPos := Ascan(aLocais,{|x|x[1]==(cAliasSD3)->D3_COD .And. x[2]==(cAliasSD3)->D3_LOCAL .And. x[3]==(cAliasSB5)->B5_CODISRF .And. x[4]==(cAliasSB5)->B5_INSUMO .And. x[5]==(cAliasSB5)->B5_VOLRECI .And. x[6]==(cAliasSB5)->B5_COD})
		If nPos==0
			Aadd(aLocais,{(cAliasSD3)->D3_COD,(cAliasSD3)->D3_LOCAL,(cAliasSB5)->B5_CODISRF,(cAliasSB5)->B5_INSUMO,(cAliasSB5)->B5_VOLRECI,(cAliasSB5)->B5_COD})
        Endif
    EndIf

	(cAliasSD3)->(dbSkip())

Enddo

For nX := 1 To Len(aLocais)

	dbSelectArea("SD3")
	dbSetOrder(7)
	dbSeek(xFilial("SD3")+aLocais[nX][1]+aLocais[nX][2]+Dtos(dDtIni),.T.)
	While !Eof() .And. SD3->D3_FILIAL+SD3->D3_COD+SD3->D3_LOCAL==xFilial("SD3")+aLocais[nX][1]+aLocais[nX][2] .And. SD3->D3_EMISSAO<=dDtFim

		nQuant 		:= 0
		nOutEnt		:= 0
		nOutSai		:= 0
		nUtiliza 	:= 0
		cDec		:= ""

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProducao Manual              ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If SD3->D3_CF =="PR0" .And. SD3->D3_ESTORNO<>"S" .And. !Empty(SD3->D3_OP)
			nQuant += SD3->D3_QUANT
		Endif

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณEstorno de Producao Manual   ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If SD3->D3_CF == "ER0"
	        nQuant -= SD3->D3_QUANT
	    Endif

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณDevolucao Manual             ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If SD3->D3_CF == "DE0"
	        nOutEnt += SD3->D3_QUANT
	    Endif

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณRequisicao Manual            ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If SD3->D3_CF == "RE0"
	        nOutSai += SD3->D3_QUANT
	    Endif

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณInsumos utilizados na producao                                         ณ
		//ณComo a instrucao normativa solicita a apresentacao de efetivo + perdas,ณ
		//ณas perdas nao foram consideradas.                                      ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If !Empty(SD3->D3_OP) .And. SD3->D3_TM > "500" .And. SD3->D3_ESTORNO <> "S"
			nUtiliza += SD3->D3_QUANT
		Endif

		If cTpDecl=="1" // mensal
			cDec := SubStr(DTOS(SD3->D3_EMISSAO),1,6)+"0"
		Else
			cDec := SubStr(DTOS(SD3->D3_EMISSAO),1,6)+IIF(Day(SD3->D3_EMISSAO)<=10,"1",IIF(Day(SD3->D3_EMISSAO)<=20,"2","3"))
		Endif

	    If TRB->(dbSeek(Str(aLocais[nX][3],6)+Str(aLocais[nX][4],3)+Str(aLocais[nX][5],5)+aLocais[nX][6]+cDec))
	        RecLock("TRB",.F.)
       		If nTipProd == 1 	//Insumos
		        TRB->UTILIZA	+= nUtiliza
		        TRB->OUTRASENT 	+= (nQuant+nOutEnt)
			Else				//Envasados
		        TRB->ENVASADOS 	+= nQuant
		        TRB->OUTRASENT 	+= nOutEnt
		    Endif
	        TRB->OUTRASAID	+= nOutSai
	        MsUnlock()
	    Endif

		dbSelectArea("SD3")
		dbSkip()
	Enddo
Next

If lQuery
	dbSelectArea(cAliasSD3)
	dbCloseArea()
EndIf

RestArea(aArea)

Return Nil
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณxMagHelpFis Autor ณ Gustavo G. Rueda      ณ Data ณ 22/11/00	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Funcoes utilizadas para exibicao de nao conformidades no di- |ฑฑ
ฑฑณ          ณ  cionario de dados. Apresenta o problema e a solucao que deve|ฑฑ
ฑฑณ          ณ  ser passado por parametros para a funcao montar a DIALOG.   |ฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณSintaxe e ณ xMagHelpFis (cTitBarra, cProblema, cSolucao)                 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณcTitBarra -> Titulo da barra da janela.                       ณฑฑ
ฑฑณ          ณcProblema -> Descricao do problema a ser apresentado.         ณฑฑ
ฑฑณ          ณcSolucao -> Descricao da solucao para o problema.             ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                     	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ PROGRAMADOR  ณ DATA   ณ BOPS ณ  MOTIVO DA ALTERACAO                   	ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤลฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function xMagHelpFis (cTitBarra, cProblema, cSolucao)
	Local	oDlgHelp
	Local	oBtOk
	Local	oSayProb
	Local	oSaySolu
	Local	oGetProb
	Local	oGetSolu
	Local	lRet		:=	.T.
	Local	oFont		:=	TFont ():New ("Arial",, 15,, .F.)
	Local	oFontB		:=	TFont ():New ("Arial",, 15,, .T.)
	//
	Default	cTitBarra	:=	""
	Default	cProblema	:=	""
	Default	cSolucao	:=	""
	//
	DEFINE MSDIALOG oDlgHelp FROM 000,000 TO 325, 416 TITLE cTitBarra PIXEL
	//
	@005, 005 SAY oSayProb VAR STR0100 SIZE 205, 010 FONT oFontB OF oDlgHelp PIXEL COLOR CLR_RED
		@015, 005 GET oGetProb VAR cProblema OF oDlgHelp MEMO SIZE 199, 055 FONT oFont PIXEL READONLY //NOBORDER
	//
	@075, 005 SAY oSaySolu VAR STR0101 SIZE 205, 010 FONT oFontB OF oDlgHelp PIXEL COLOR CLR_RED
		@085, 005 GET oGetSolu VAR cSolucao OF oDlgHelp MEMO SIZE 199, 055 FONT oFont PIXEL READONLY //NOBORDER
	//
	DEFINE SBUTTON oBtOk FROM 145, 180 TYPE 1 ACTION (lRet := .T., oDlgHelp:End ()) ENABLE OF oDlgHelp
	//
	ACTIVATE MSDIALOG oDlgHelp CENTERED
Return (lRet)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |xMagEstru  ณ Autor ณGustavo G. Rueda       ณ Data ณ 24.11.04 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณProcessa Estrutura dos Produtos (SG1) - Funcao Recursiva     ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function xMagEstru (cProd, lGeraTrb, lFecha, aTrb)
	Local		aStru		:=	{}
	Local		cArq		:=	""
	Local       cProdComp   :=  ""
	//
	Default	lGeraTrb	:=	.F.
	Default	aTrb		:=	{}
    Default	lFecha		:=	.F.
	//
	If !(lFecha)
		If (lGeraTrb)
			aAdd (aStru, {"CODPROD",	"C",	TAMSX3 ("G1_COD")[1],	TAMSX3 ("G1_COD")[2]})	//Codigo do Produto
			aAdd (aStru, {"QUANT",		"N",	TAMSX3 ("G1_QUANT")[1],	TAMSX3 ("G1_QUANT")[2]})	//Codigo do Produto
			//
			cArq	:=	CriaTrab (aStru)
			DbUseArea (.T., __LocalDriver, cArq, "EST")
			IndRegua ("EST", cArq, "CODPROD")
			//
			aTrb		:=	{"EST", cArq}
		EndIf
		//
		SG1->(DbGoTop ())
		If SG1->(DbSeek (xFilial ("SG1")+cProd))
			Do While !SG1->(Eof ()) .And. (SG1->G1_FILIAL+SG1->G1_COD==xFilial("SG1")+cProd)
				//Insiro a primeira vez o produto Pai pois os REG 30 e 31 necessitam
				If !(EST->(DbSeek (cProd)))
					RecLock ("EST", .T.)
						EST->CODPROD	:=	cProd
					MsUnLock ()
				EndIf
				//Insiro todos os produtos que formam o produto Pai
				cProdComp := SG1->G1_COMP
				If !(EST->(DbSeek (cProdComp)))
					RecLock ("EST", .T.)
						EST->CODPROD	:=	cProdComp
						EST->QUANT		:=	SG1->G1_QUANT
					MsUnLock ()
				EndIf
				SG1->(DbSkip ())
			Enddo
		Else
		//Insiro uma vez o produto Pai mesmo que nใo encontre na estrutura pois os REG 30 e 31 necessitam
			If !(EST->(DbSeek (cProd)))
				RecLock ("EST", .T.)
					EST->CODPROD	:=	cProd
				MsUnLock ()
			EndIf
		Endif
	Else
		(aTrb[1])->(DbCloseArea ())
		Ferase(aTrb[2]+GetDBExtension ())
		Ferase(aTrb[2]+OrdBagExt ())
	EndIf
Return (.T.)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  |CtbTmpAT7  ณ Autor ณSimone Mie Sato        ณ Data ณ 01.06.05 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณCriar arquivo temporario AT7 em branco para SIGACON.(MANAD)  ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function CtbTmpAT7(dDataIni,dDataFim,dDataLP,lAlimenta,cFilIni,cFilFim,lManad,cArqTmp,cContaIni,cContaFim,cMoeda,cTpSald)

Local aSaveArea		:= GetArea()
Local aCampos

Local oMeter
Local oText
Local oDlg
Local lEnd

DEFAULT lAlimenta	:= .T.
DEFAULT cFilIni		:= Space(02)
DEFAULT cFilFim 	:= Space(02)
DEFAULT lManad		:= .F.
DEFAULT cArqTmp     := ""
DEFAULT cContaIni	:= ""
DEFAULT cContaFim	:= "ZZZZZZZZZZZZZZZZZZZZ"
DEFAULT cMoeda		:= "01"
DEFAULT cTpSald		:= "1"

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Monta Arquivo Temporario para Impressao							  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
MsgMeter({|	oMeter, oText, oDlg, lEnd | ;
				CTMovMes(dDataIni,dDataFim,cContaIni,cContaFim,cMoeda,cTpSald,dDataLP,oMeter,oText,oDlg,@lEnd,lAlimenta,cFilIni,cFilFim,lManad,@cArqTmp)},;
				(STR0032),;  //"Indexando Registros..."
				("Gerando arquivo temporario..."))	//"Gerando arquivo temporario..."

dbSelectArea("AT7")

If IndexOrd() > 0
	RestArea(aSaveArea)
EndIf

Return cArqTmp

/*/
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณConAT7Clos  ณ Autor ณ Simone Mie Sato      ณ Data ณ 28.03.2005		ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Fecha arquivo temporario.                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณSintaxe   ณ ConAT7Clos()                                                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ SigaCtb                                                   			ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณ                                    	                     		   	ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function ConAT7Clos(cArqTmp,lCriouTOP,cArq)

Local aSaveArea	:= GetArea()

DEFAULT lCriouTOP := .F.
DEFAULT cArq      := ""

dbSelectArea("AT7")
dbCloseArea()

If Select("AT7") == 0
	FErase(cArqTmp+GetDBExtension())
	FErase(cArqTmp+OrdBagExt())
EndIF

If lCriouTOP
	If TcCanOpen(cArq)
		MsErase(cArq,,"TOPCONN")
	EndIf
EndIf

RestArea(aSaveArea)

Return
/*/
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณGetCgC      ณ Autor ณ Andressa Ataides     ณ Data ณ 22/06/2005        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Retorna o CNPJ/CPF                                                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ SigaFis                                                              ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GetCgc(cVar)

Local aArea := GetArea()
Local cRet  := ""

If cVar == "E"
	cRet := STRZERO(IIF(!SF3->F3_TIPO$"DB",Val(SA2->A2_CGC),Val(SA1->A1_CGC)),14)
Else
	cRet := STRZERO(IIF(SF3->F3_TIPO$"DB",Val(SA2->A2_CGC),Val(SA1->A1_CGC)),14)
Endif

If SM0->M0_CGC == cRet
	cRet := "MESMO CNPJ/CPF"
Else
	If Empty(Val(cRet)) .And. cVar <> "E"
		cRet := "NAO POSSUI"
    Endif
Endif

RestArea(aArea)

Return(cRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao     ณRetAIDF     ณ Autor ณ Sergio S. Fuzinaka   ณ Data ณ 18.07.2005 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao  ณRetorna os dados da AIDF                                       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros ณcNFiscal - Numero da Nota Fiscal                               ณฑฑ
ฑฑณ           ณcSerie   - Serie da Nota Fiscal                                ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso        ณGenerico                                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function RetAIDF(cNFiscal, cSerie, lSpedFis)

Local aRet		:= {"", "", "", "", CToD ("  /  /  "), "", ""}
Local aArea		:= GetArea ()
Local aSFS		:= {}
Local cIDAidf	:= ""
Local lIDAidf	:= .F.

Default lSpedFis := .F.

If cPaisLoc == "BRA"
	cIDAidf	:= GetNewPar("MV_IDAIDF","")
	lIDAidf := !Empty(cIDAidf) .And. SFS->(FieldPos(cIDAidf)) > 0

	aSFS := SFS->(GetArea())

	DbSelectArea("SFS")
	SFS->(DbSetOrder(2))

	// lSpedFis soh sera .T. quando a funcao for chamada do SPEDFISCAL - Compatibilidade com os arqs. magneticos que a utilizam.
	If lSpedFis
		SFS->(dbSeek(xFilial("SFS")+cSerie))
	Else
		If !(SFS->(DbSeek(xFilial ("SFS")+cSerie+cNFiscal, .T.)) .And. !SFS->(Bof()) .And. !SFS->(Eof()))
			SFS->(DbSkip(-1))
		EndIf
	EndIf

	Do While !SFS->(Eof ()) .And. SFS->FS_FILIAL+SFS->FS_SERIE==xFilial("SFS")+cSerie
		If (Val(cNFiscal)>=Val (SFS->FS_NUMINI)) .And. (Val(cNFiscal)<=Val (SFS->FS_NUMFIM))
			aRet[1] := SFS->FS_AIDF		//Numero da AIDF
			aRet[2] := SFS->FS_TPIMPR	//Tipo de Impressao ou Dispositivo
			aRet[3] := SFS->FS_NUMINI	//Numero Inicial
			aRet[4] := SFS->FS_NUMFIM	//Numero Final
			aRet[5] := SFS->FS_DATA		//Data de Autorizacao
			aRet[6] := SFS->FS_MODELO	//Modelo da Nota Fiscal
			If lIDAidf
				aRet[7] := SFS->&(cIDAidf)
			Else
				aRet[7] := ""
			Endif
			Exit
		EndIf
		SFS->(DbSkip ())
	EndDo
	RestArea(aSFS)
	RestArea(aArea)
EndIf

Return(aRet)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณCTMovMes  บAutor  ณMarcos S. Lobo      บ Data ณ  09/13/05   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ                                                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CTMovMes(dDataIni,dDataFim,cContaIni,cContaFim,cMoeda,cTpSald,dDataLP,oMeter,oText,oDlg,lEnd,lAlimenta,cFilIni,cFilFim,lManad,cArqTmp)

Local aSaveArea 	:= GetArea()
Local aCampos		:= {}
Local lCtbInUse		:= CtbInUse()
Local nTCta			:= TAMSX3(If(lCtbInUse,"CT1_CONTA","I1_CODIGO"))[1]
Local nTDesc 		:= TAMSX3(If(lCtbInUse,"CT1_DESC"+cMoeda,"I1_DESC"))[1]
Local lObj			:= 	oMeter <> Nil
Local nMeter		:= 0

Local aSaldoAnt		:= {}
Local aSaldoAtu		:= {}

Local cFilCT1		:= ""
Local lAntLP		:= .F.
Local lRetSaldo 	:= .F.
Local lTop			:= .F.
Local lAbriuAT7     := .F.
Local lSI1Shared	:= .F.

Local nMoeda		:= 1

Local aAreaSM0		:= SM0->(GetArea ())


DEFAULT lAlimenta	:= .T.	//	.T. alimenta o arquivo AT7; .F. apenas cria-o
DEFAULT cFilIni		:= Space(02)
DEFAULT cFilFim 	:= Space(02)
DEFAULT lManad		:= .F.
DEFAULT cArqTmp     := ""

If Empty(dDataIni)
	dDataIni := FirstDay(dDataBase)
EndIf
If Empty(dDataFim)
	dDataFim := LastDay(dDataIni)
EndIf
If Empty(cMoeda)
	cMoeda := "01"
EndIf
If Empty(cTpSald)
	cTpSald := "1"
EndIf
If Empty(cContaFim)
	If Empty(cContaIni)
		cContaFim := Repl("Z",nTCta)
	Else
		cContaIni := cContaIni
	EndIf
EndIf
If Empty(dDataLP)
	dDataLP := CTOD("  /  /  ")
	lAntLP  := .F.
Else
	lAntLP  := .T.
EndiF

#IFDEF TOP
	If TcSrvType() <> "AS/400"
		lTop := UPPER(AllTrim(TcGetDb())) $ "MSSQL/MSSQL7/ORACLE/DB2/SYBASE/INFORMIX"
	EndIf
#ENDIF


aCampos := { { "CONTA"		, "C", nTCta,	0 },;	// Codigo da Conta
			 { "DATASLD"	, "D", 8, 		0 },;	// Conta Superior
			 { "SUPERIOR"	, "C", nTCta, 	0 },;	// Conta Superior
	 		 { "NORMAL"		, "C", 01, 		0 },;	// Situacao
			 { "CTARES"		, "C", 10, 		0 },; 	// Codigo Reduzido da Conta
			 { "DESCCTA"	, "C", nTDesc, 	0 },; 	// Descricao da Conta
			 { "SALDOANT"	, "N", 17, 		2 },; 	// Saldo Anterior
			 { "SALDODEB"	, "N", 17, 		2 },;  	// Debito no Mes
			 { "SALDOCRD"	, "N", 17, 		2 },;  	// Credito no Mes
			 { "SALDOATU"	, "N", 17, 		2 },;  	// Saldo Atual
			 { "TIPOCONTA"	, "C", 01, 		0 },;	// Conta Analitica / Sintetica
			 { "NIVEL1"		, "L", 01, 		0 } }	// Logico para identificar se ้ uma conta de 1บ nivel

cArqTmp := CriaTrab(aCampos, .T.)
If Select("AT7") > 0
	dbSelectArea("AT7")
	dbCloseArea()
EndIf

If lAlimenta .And. lTop .And. lCtbInUse
	cArqTmp := "TMP_"+cArqTMP
	If TcCanOpen(cArqTMP)
		MsErase(cArqTMP,,"TOPCONN")
	EndIf
	MsCreate(cArqTmp,aCampos,"TOPCONN")
	Sleep(1000)
	dbUseArea(.T.,"TOPCONN",cArqTmp,"AT7",.F.,.F.)
Else
	AbreAT7(cArqTmp)
	lAbriuAT7 := .T.
EndIf

If lAlimenta

	If lCtbInUse		/// OBTENCAO DOS SALDOS NO CTB

		#IFDEF TOP
			// Se nao eh AS/400, executa a fun็ใo SaldoCT7SP (CTBXFUN)
	    	If TcSrvType() <> "AS/400" .And. lTop
				If Empty( xFilial("CT7") )
					cFilIni := Space(02)
					cFilFim := Space(02)
				ElseIf !lManad
					cFilIni := xFilial("CT7")
					cFilFim := xFilial("CT7")
				EndIf
				CONOUT( "INICIO REGISTRO I150: " + DtoC(DATE()) + " - " + TIME() )
				lRetSaldo := SaldoCT7SP(dDataIni,dDataFim,cMoeda,cFilIni,cFilFim,lObj,oMeter)
                If lRetSaldo
					CONOUT( "FINAL  REGISTRO I150: " + DtoC(DATE()) + " - " + TIME() )
				Else
					CONOUT( "ERRO NA PROCEDURE DO REGISTRO I150. SEGUE A EXECUวยO SEM A PROCEDURE: " + DtoC(DATE()) + " - " + TIME() )
				EndIf
			EndIf
		#ENDIF

		If ! lRetSaldo		//	Se nใo executou a fun็ใo SaldoCT7SP() (Saldos atraves de Procedure),
							//	ou se ocorreu algum problema na sua execu็ใo, executar via CodeBase

			CONOUT( "INICIO REGISTRO I150 (SEM PROCEDURE): " + DtoC(DATE()) + " - " + TIME() )

			If !lAbriuAT7
				cArqTmp := SubStr(cArqTmp,5)
				AbreAT7( cArqTmp )
				lAbriuAT7 := .T.
			EndIf

			// Executando para todas as Filiais, substituindo assim o CONSOLIDADO do Manad.ini
			If Empty (cFilIni) .And. Empty (cFilFim)
				cFilIni	:=	cFilAnt
				cFilFim	:=	cFilAnt
			EndIf

			DbSelectArea("SM0")
			SM0->(DbSeek (cEmpAnt+cFilIni, .T.))

			Do While !SM0->(Eof()) .And. (FWGrpCompany() + FWCodFil()) <= (cEmpAnt + cFilFim)
				dbSelectArea("CT1")
				If lObj
					oMeter:SetTotal(CT1->(RecCount()))
					oMeter:Set(0)
					//oMeter:nTotal := CT1->(RecCount())
				EndIf
				dbSetOrder(3)
				cFilCT1	:= xFilial("CT1")
				dbSeek(cFilCT1+"2"+cContaIni,.T.)
				While CT1->(!Eof()) .and. CT1->CT1_FILIAL == cFilCT1 .and. CT1->CT1_CONTA <= cContaFim
					dDataFAtu := dDataIni
					l1stMes	 := .T.

					If lObj
						nMeter++
				   	 	oMeter:Set(nMeter)
				  	EndIf

					While dDataFAtu <= dDataFim
						If l1stMes
							l1stMes := .F.
							dDataIAtu := dDataIni-1					/// DATA FINAL IMEDIATAMENTE ANTERIOR
							dDataFAtu := LastDay(dDataIni)			/// ULTIMO DIA DO MES

							aSaldoAnt := SaldoCT7(CT1->CT1_CONTA,dDataIAtu,cMoeda,cTpSald,'CTBXFUN',/*lAntLP*/,/*dDataLP*/,If(FWModeAccess("CT7",3)=="C",NIL,FWCodFil()))//SEM DEFINICAO SALDO ANTES/APOS APURACAO
						Else
							aSaldoAnt := aClone(aSaldoAtu)

							dDataFAtu := LastDay(dDataFAtu+1)		/// ULTIMO DIA DO MES SEGUINTE
						EndIf

						If dDataFAtu > dDataFim
							dbSkip()
							Loop
						EndIf

						aSaldoAtu := SaldoCT7(CT1->CT1_CONTA,dDataFAtu,cMoeda,cTpSald,'CTBXFUN',/*lAntLP*/,/*dDataLP*/,If(FWModeAccess("CT7",3)=="C",NIL,FWCodFil())) //SEM DEFINICAO SALDO ANTES/APOS APURACAO

						If !(AT7->(DbSeek( CT1->CT1_CONTA + DTOS(FirstDay(dDataFAtu)) )))
							RecLock('AT7',.T.)
							Field->CONTA     := CT1->CT1_CONTA
							Field->DATASLD   := FirstDay(dDataFAtu)			// Data do Saldo
							Field->SUPERIOR  := CT1->CT1_CTASUP				// Conta Superior
							Field->NORMAL    := CT1->CT1_NORMAL				// Situacao
							Field->DESCCTA   := &("CT1->CT1_DESC"+cMoeda)	// Descricao da Conta
							Field->TIPOCONTA := CT1->CT1_CLASSE				// Conta Analitica / Sintetica
							Field->SALDOANT  := aSaldoAnt[5] - aSaldoAnt[4]	// Saldo Anterior
							Field->SALDODEB  := aSaldoAtu[4] - aSaldoAnt[4]	// Debito no Mes
							Field->SALDOCRD  := aSaldoAtu[5] - aSaldoAnt[5]	// Credito no Mes
							Field->SALDOATU  := aSaldoAtu[5] - aSaldoAtu[4] 	// Saldo Atual
							Field->NIVEL1    := EMPTY(CT1->CT1_CTASUP)		// Logico para identificar se ้ Mae do Grupo
						Else
							RecLock('AT7',.F.)
							Field->SALDOANT += (aSaldoAnt[5] - aSaldoAnt[4])	// Saldo Anterior
							Field->SALDODEB += (aSaldoAtu[4] - aSaldoAnt[4])	// Debito no Mes
							Field->SALDOCRD += (aSaldoAtu[5] - aSaldoAnt[5])	// Credito no Mes
							Field->SALDOATU += (aSaldoAtu[5] - aSaldoAtu[4]) 	// Saldo Atual
						EndIf
						AT7->(MsUnlock())
					EndDo
					CT1->(dbSkip())
				EndDo

				/// SE NAO FOR MANAD, CALCULA O SALDO DAS SINTETICAS E ATUALIZA NO TRB (AT7)
				dbSelectArea("AT7")
				dbSetOrder(1)
				If !lManad
					//Atualizacao de sinteticas para codebase e topconnect
					CtbSintSup(cMoeda,oMeter,oText,oDlg)
				EndIf

				SM0->( DbSkip() )

			EndDo

			CONOUT( "FINAL REGISTRO I150 (SEM PROCEDURE): " + DtoC(DATE()) + " - " + TIME() )

		EndIf

	Else		/// OBTENCAO DOS SALDOS NO SIGACON

		// Executando para todas as Filiais, substituindo assim o CONSOLIDADO do Manad.ini
		If Empty (cFilIni) .And. Empty (cFilFim)
			cFilIni	:=	cFilAnt
			cFilFim	:=	cFilAnt
		EndIf

		lSI1Shared := Empty( SI1->( xFilial("SI1") ) )

		DbSelectArea("SM0")
		SM0->(DbSeek (cEmpAnt+cFilIni, .T.))

		Do While !SM0->(Eof()) .And. (FWGrpCompany() + FWCodFil()) <= (cEmpAnt + cFilFim)

			nMoeda := Val(cMoeda)
			cExerc := GetMv("MV_EXERC1")
			cExercI:= ALLTRIM(STR(Year(dDataIni)))

			If cExercI == cExerc .or. cExercI == Soma1(cExerc)
				//// SO GERA PARA O EXERCICIO CORRENTE OU 5 MESES POSTERIORES
				dbSelectArea("SI1")
				If lObj
					oMeter:SetTotal(SI1->(RecCount()))
					oMeter:Set(0)
					//oMeter:nTotal := SI1->(RecCount())
				EndIf
				dbSetOrder(1)
				If lSI1Shared
					cFilSI1	:= xFilial("SI1")
				Else
					cFilSI1	:= FWCodFil()
				EndIf
				dbSeek(cFilSI1,.T.)

				nPeriodI:= Month(dDataIni)
				If cExercI <> cExerc
					nPeriodI := nPeriodI + 12
				EndIf

				cExercF:= ALLTRIM(STR(Year(dDataFim)))
				If cExercF > Soma1(cExerc)
					cExerc := Soma1(cExerc)
				EndIf

				nPeriodF:= Month(dDataFim)

				If cExercF <> cExerc
					nPeriodF := nPeriodF + 12
					If nPeriodF > 17
						nPeriodF := 17
					EndIf
				EndIf

				While SI1->(!Eof()) .and. SI1->I1_FILIAL == cFilSI1

					If (SI1->I1_CODIGO < cContaIni .or. SI1->I1_CODIGO > cContaFim) .Or.;
					   (SI1->I1_CLASSE <> "A")	//	Se nao for Analitica

						SI1->(dbSkip())
						Loop
					EndIf

					If lObj
						nMeter++
				   	 	oMeter:Set(nMeter)
				  	EndIf

			        nPerAtu := nPeriodI
			        nAnoAtu := Val(cExercI)
			        l1StPer	:= .T.

			    	nSldAnt := 0

					While nPerAtu <= nPeriodF .and. nPerAtu <= 17

						If nPerAtu = 13			/// SE PASSAR O 12 MES INCREMENTA O ANO
							nAnoAtu += 1
						EndIf

						If l1StPer
							nSldAnt := CalcSaldo(nPerAtu-1,nMoeda,.T.)//Saldo(SI1->I1_CODIGO,nPerAtu-1,nMoeda,nAnoAtu)
						Else
							nSldAnt := AT7->SALDOATU
						EndIf

						If nPerAtu > 12
							dDataFAtu :=  FirstDay(CTOD("01/"+STRZERO(nPerAtu-12,2)+"/"+RIGHT(STRZERO(nAnoAtu,4),2)))
						Else
							dDataFAtu :=  FirstDay(CTOD("01/"+STRZERO(nPerAtu,2)+"/"+RIGHT(STRZERO(nAnoAtu,4),2)))
						EndIf

						If lSI1Shared .OR. !(AT7->(DbSeek( SI1->I1_CODIGO + DTOS(dDataFAtu) )))
							RecLock("AT7",.T.)
							Field->CONTA     := SI1->I1_CODIGO
							Field->DATASLD   := dDataFAtu								// Data do Saldo
							Field->SUPERIOR  := SI1->I1_CTASUP							// Conta Superior
							Field->NORMAL    := SI1->I1_NORMAL			  				// Situacao
							Field->DESCCTA   := SI1->I1_DESC				 			// Descricao da Conta
							Field->TIPOCONTA := SI1->I1_CLASSE							// Conta Analitica / Sintetica
							Field->SALDOANT  := nSldAnt									// Saldo Anterior
							Field->SALDODEB  := &("SI1->I1_DEBM"+strzero(nPerAtu,2))	// Debito no Mes
							Field->SALDOCRD  := &("SI1->I1_CRDM"+strzero(nPerAtu,2))	// Credito no Mes
							Field->SALDOATU  := nSldAnt+(AT7->(SALDOCRD-SALDODEB)) 	// Saldo Atual
							Field->NIVEL1    := EMPTY(SI1->I1_CTASUP)					// Logico para identificar se ้ Mae do Grupo

							If l1StPer
								l1StPer := .F.
							EndIf

						Else	// Se tiver o Plano de Contas (SI1) Exclusivo
							RecLock("AT7",.F.)
							If l1StPer
								// Somente qdo. for o primeiro periodo, somar o saldo anterior de cada filial
								Field->SALDOANT  += nSldAnt								// Saldo Anterior
								l1StPer := .F.
							Else
								Field->SALDOANT  := nSldAnt								// Saldo Anterior
							EndIf
							Field->SALDODEB  += &("SI1->I1_DEBM"+strzero(nPerAtu,2))	// Debito no Mes
							Field->SALDOCRD  += &("SI1->I1_CRDM"+strzero(nPerAtu,2))	// Credito no Mes
							Field->SALDOATU  := nSldAnt+(AT7->(SALDOCRD-SALDODEB)) 	// Saldo Atual
						EndIf
						AT7->(MsUnlock())
						nPerAtu++
					EndDo
					SI1->(dbSkip())
				EndDo

			EndIf

			// Se o SI1 for Compartilhado, nao deve processar para as demais filiais
			If lSI1Shared
				Exit
			Else
				SM0->( DbSkip() )
			EndIf

		EndDo

	EndIf

EndIf

RestArea(aAreaSM0)

Return cArqTmp

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณMATXMAG   บAutor  ณMicrosiga           บ Data ณ  09/14/05   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ                                                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CtbSintSup(cMoeda,oMeter,oText,oDlg)

Local aSaveArea	:= GetArea()
Local cContaSup	:= ""
Local cDesc		:= ""
Local nRegTmp	:= 0
Local nMeter	:= 0

Local lObj		:= oMeter <> Nil

Local cFilCT1 := ""

nSldAnt	:= 0
nMovDeb	:= 0
nMovCrd	:= 0
nSldAtu	:= 0

// Grava sinteticas
dbSelectArea("AT7")
dbGoTop()

If lObj
	oMeter:SetTotal(AT7->(RecCount()))
	oMeter:Set(0)
EndIf

While AT7->(!Eof())

	nRegTmp	:= Recno()

	nSldAnt	:= AT7->SALDOANT
	nMovDeb	:= AT7->SALDODEB
	nMovCrd	:= AT7->SALDOCRD
	nSldAtu	:= AT7->SALDOATU

	cDataSld	:= DTOS(AT7->DATASLD)
	dDataSLD	:= AT7->DATASLD
	cContaSup 	:= AT7->SUPERIOR

	dbSelectArea("CT1")
	dbSetOrder(1)

	If Empty(cContaSup)
		dbSelectArea("AT7")
		Replace NIVEL1 With .T.
		dbSelectArea("CT1")
	EndIf

	cFilCT1 := xFilial("CT1")
	MsSeek(cFilCT1+cContaSup)

	While CT1->(!Eof()) .And. CT1->CT1_FILIAL == cFilCT1

		cDesc := &("CT1->CT1_DESC"+cMoeda)
		If Empty(cDesc)		// Caso nao preencher descricao da moeda selecionada
			cDesc := CT1->CT1_DESC01
		Endif

   		dbSelectArea("AT7")
		dbSetOrder(1)
		If !MsSeek(cContaSup+cDataSld)
			dbAppend()
			Replace CONTA		With cContaSup
			Replace DATASLD		With dDataSLD
			Replace SUPERIOR	With CT1->CT1_CTASUP
			Replace NORMAL   	With CT1->CT1_NORMAL
			Replace DESCCTA		With cDesc
			Replace TIPOCONTA	With CT1->CT1_CLASSE
		EndIf

		Replace	SALDOANT 	With SALDOANT 	+ nSldAnt
		Replace SALDODEB 	With SALDODEB 	+ nMovDeb
		Replace SALDOCRD 	With SALDOCRD 	+ nMovCrd
		Replace SALDOATU 	With SALDOATU 	+ nSldAtu

		dbSelectArea("CT1")
		cContaSup := CT1->CT1_CTASUP
		If Empty(CT1->CT1_CTASUP)
			dbSelectArea("AT7")
			Replace NIVEL1 With .T.
			dbSelectArea("CT1")
			Exit
		EndIf
		MsSeek(cFilCT1+cContaSup)
	EndDo
	dbSelectArea("AT7")
	dbGoto(nRegTmp)
	dbSkip()

	If lObj
		nMeter++
   		oMeter:Set(nMeter)
  	EndIf
EndDo


RestArea(aSaveArea)

Return
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณ TpFolha  ณ Autor ณ Andreia Santos        ณ Data ณ 17.06.02 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Retorna o Tipo de movimento na folha                       ณฑฑ
ฑฑณ          ณ   1 = Folha Normal                                         ณฑฑ
ฑฑณ          ณ   2 = Folha de 13o Salario                                 ณฑฑ
ฑฑณ          ณ   3 = Folha de Ferais                                      ณฑฑ
ฑฑณ          ณ   4 = Folha complementar a normal                          ณฑฑ
ฑฑณ          ณ   5 = Folha complementar ao 13o                            ณฑฑ
ฑฑณ          ณ   6 = Outras Folhas                                        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณSintaxe   ณ TpFolha(cCodPd)                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ GENERICO                                                   ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function fTp_Folha(cCodPD,cInstr)
Local cTpFolha	:=" "
Local nRecSRD	:= SRD->( recno())
Local cPD13		:= ""
Local cAlias	:= "SRV"
DEFAULT cInstr := ""

#IFDEF TOP
	If (cInstr == "MANAD" .or. cInstr == "IN86") .and. TcSrvType()<>"AS/400"
		cAlias := "SRD"
	Else
		cAlias := "SRV"
	EndIf
#ELSE

	   IF Type("nRecSRV") == "U"
	   			nRecSRV := SRV->(Recno())
	   Endif
	   IF Type("nSRVOrd") == "U"
	   			nSRVOrd := SRV->(Indexord())
	   Endif
#ENDIF

cTpFolha	:= "1"

If cInstr # "IN86"
	cPD13	:= _aTotal[013, 27,1]+"#"+_aTotal[013, 62,1]+"#"+_aTotal[013,108,1]+"#"+_aTotal[013,109,1]+"#"+_aTotal[013,129,1]
	cPd13 	+= "#"+_aTotal[013,163,1]+"#"+_aTotal[013,169,1]+"#"+_aTotal[013,299,1]
EndIf

If cInstr == "MANAD"
	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
	If SubStr(SRD->RD_ROTEIR,1,2) == '13'	//Base IR 13o
	   	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
	ElseIf SRD->RD_ROTEIR == 'FER'	//Base IR Ferias
	   	cTpFolha	:= "3"
	ElseIf SRD->RD_ROTEIR == 'PLR'	//Base IR PLR
	   	cTpFolha	:= "6"
	Endif

ElseIf cInstr == "IN86"
	If  (cAlias)->RV_REFFER = "S"
		cTipFol := '3'
	Elseif  (cAlias)->RV_REF13 = "S" .Or. SUBS( SRD->RD_DATARQ,5,2) = '13'
		cTipFol := '2'
	Else
		cTipFol := '1'
	Endif
else
	If cCodPD $ _aTotal[013, 15,1] //Base IR Folha
		cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
	ElseIf cCodPD $ _aTotal[013, 16,1] .Or. (cAlias)->RV_REFFER == "S" .Or.  cCodPD == _aTotal[013, 22,1]	//Base IR Ferias ou Verbas que referem-se a ferias
		//TMP_FILIAL+TMP_CNPJ+TMP_MAT+TMP_COMP+TMP_INDFL
	    //Antes de alterar o tipo de registro para Ferias verifico de existe K250 gravado para modificar a informa็ao
	    If TMP->(Dbseek(SRA->RA_FILIAL+SM0->M0_CGC+SRA->RA_MAT+SRD->RD_DATARQ+"3"))
	       	cTpFolha	:= "3"
	    Endif
	ElseIf (SRD->RD_TIPO2 #"R" .and. substr(SRD->RD_DATARQ,5,2) =="12" .AND. (cAlias)->RV_REF13 == "S") .OR.;  //Complementar de 13o
	          (SRD->RD_PD $ cPd13 .and. SRD->RD_TIPO2 #"R" .and. substr(SRD->RD_DATARQ,5,2) =="12")     //Complementar de 13o
	 	cTpFolha	:= "5"
	ElseIf cCodPD $ _aTotal[013, 27,1]	.Or. SubStr(SRD->RD_DATARQ,5,2) == '13' .or. ( (cAlias)->RV_REF13 == "S" .And. !(cCodPD $_aTotal[013, 22,1]+"*"+_aTotal[013, 163,1]) ) //Base IR 13o
			//TMP_FILIAL+TMP_CNPJ+TMP_MAT+TMP_COMP+TMP_INDFL
	    	//Antes de alterar o tipo de registro para 13o salแrio verifico de existe K250 gravado para modificar a informa็ao
	   	If TMP->(Dbseek(SRA->RA_FILIAL+SM0->M0_CGC+SRA->RA_MAT+SRD->RD_DATARQ+"2"))
	    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
	    Endif
	ElseIf cCodPD $ _aTotal[013,151,1]+"/"+_aTotal[013,152,1]	//Base IR Distribuicao de Lucros
	   	cTpFolha	:= "6"
	ElseIf cCodPD $ _aTotal[013, 13,1]+"/"+_aTotal[013,14, 1]+"/"+_aTotal[013,221,1]+"/"+_aTotal[013,225, 1] //Base de INSS Folha
	   	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
	ElseIf cCodPD $ _aTotal[013, 19,1]+"/"+ _aTotal[013,20,1] .and. SubStr(SRD->RD_DATARQ,5,2) == '13'//Base de INSS 13o
	   	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
	EndIf
EndIf

If cInstr # "MANAD" .and. !(cTpFolha$"1#2#3")
	cTpFolha := '4'
EndIf

#IFNDEF TOP

	IF Select('SRV') > 0
		SRV->(dbSetOrder(nSRVOrd))
		SRV->( dbGoto(nRecSRV) )
	Endif
#ENDIF
SRD->( dbGoto(nRecSRD) )

Return(cTpFolha)
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษอออออออออัอออออออออออัอออออออัออออออออออออออออออออัออออออัอออออออออออออปฑฑ
ฑฑบFuncao   ณCriaSRDTempณAutor  ณAndreia dos Santos  ณ Data ณ  10/10/05   บฑฑ
ฑฑฬอออออออออุอออออออออออฯอออออออฯออออออออออออออออออออฯออออออฯอออออออออออออนฑฑ
ฑฑบDesc.    ณ Cria arquivo temporario para gerar reg. K250 do MANAD.      บฑฑ
ฑฑฬอออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso      ณ AP5                                                         บฑฑ
ฑฑศอออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CriaSRDTemp(nTipo)

Local aCampos   := {}
Local cArqTMP	:= ""

If nTipo == 1
	If Select("TMP")# 0
		If TMP->( FieldPos("TMP_OCORR")) > 0
			return( cArqTMP )
		EndIf
	EndIf

	AADD( aCampos, { "TMP_FILIAL"	, "C", FWGETTAMFILIAL	, 0 })
	AADD( aCampos, { "TMP_CNPJ"		, "C", 014				, 0 })
	AADD( aCampos, { "TMP_INDFL"	, "C", 001				, 0 })
	AADD( aCampos, { "TMP_LCT"		, "C", 020	 			, 0 })
	AADD( aCampos, { "TMP_MAT"		, "C", 006				, 0 })
	AADD( aCampos, { "TMP_COMP"		, "C", 006	 			, 0 })
	AADD( aCampos, { "TMP_PGTO"		, "C", 008	 			, 0 })
	AADD( aCampos, { "TMP_CBO"		, "C", 007	  			, 0 })
	AADD( aCampos, { "TMP_CARGO"	, "C", 030	  			, 0 })
	AADD( aCampos, { "TMP_DEP_IR"	, "N", 012				, 0 })
	AADD( aCampos, { "TMP_DEP_SF"	, "N", 012				, 0 })
	AADD( aCampos, { "TMP_BS_IR"	, "C", 017				, 0 })
	AADD( aCampos, { "TMP_BS_PS"	, "C", 017				, 0 })
	AADD( aCampos, { "TMP_OCORR"	, "C", 002		 		, 0 })

	cArqTMP  :=	CriaTrab(aCampos)
	dbUseArea(.T.,__LocalDriver,cArqTMP,"TMP",.T.,.F.)
	IndRegua("TMP",cArqTMP,"TMP_FILIAL+TMP_CNPJ+TMP_MAT+TMP_COMP+TMP_INDFL")
	DbSelectArea("TMP")
	DbClearIndex()
	DbSetIndex(cArqTMP+OrdBagExt())
Else
	cArqTmp := _aTotal[059]+GetDBExtension()
	cArqTMP := RetArq(__LocalDriver,cArqTMP,.T.)
	Ferase(cArqTmp)
	FErase(cArqTmp+OrdBagExt())
EndIf

Return( cArqTMP )

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณMontaTMP  บAutor  ณAndreia Santos      บ Data ณ  10/10/05   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Seleciona informacoes do SRD e inclui no arquivo temporarioบฑฑ
ฑฑบ          ณpara posterior utilizacao no MANAD.                         บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function MontaTMP(cPerIni, cPerFim,lNorma89)
Local cTpFolha	:= 	""
Local cMesFinal := 	""
Local cCargo	:= 	""
Local cCargoDesc:=  ""
Local dCompIni	:=	""
Local dCompPesq	:=	cTod('')
Local aFolha	:= {}
Local nI		:= 1
Local nValorIr	:= 0
Local nValorSrd	:= 0
Local lBaseIr13	:= .F.
Local nDepIR	:= 0 //numero de dependesntes PARA IR
Local nDepSalFam:= 0 //numero de dependesntes PARA Salario famia

DEFAULT lNorma89 := .F.

#IFNDEF TOP
	SRD->(dbSetOrder(6))
	SRD->(MsSeek (SRA->RA_FILIAL+SRA->RA_MAT))
#ENDIF

While SRD->( !Eof() ).and. SRD->RD_FILIAL+SRD->RD_MAT == SRA->RA_FILIAL+SRA->RA_MAT .and. SRD->RD_DATARQ >= cPerIni .and. SRD->RD_DATARQ <= cPerFim

	//Nao considera lanctos de base e desconto de IR de mes anterior
	If SRD->RD_PD == _aTotal[013, 106,1] .OR. SRD->RD_PD == _aTotal[013, 107,1] ;
		.OR. RD_PD == _aTotal[013,318,1]
		// A verba '318' foi retirada, conforme definicao da equipe: Sustentacao/RH.
		SRD->( dbSkip())
		Loop
	EndIf

	cMesFinal 	:= Iif(substr(SRD->RD_DATARQ ,5,2)="13","12",substr(SRD->RD_DATARQ ,5,2))
	dCompIni 	:= cToD("01/"+cMesFinal+"/"+substr(SRD->RD_DATARQ ,1,4))

	If !lNorma89
		If dCompPesq # dCompIni
			fBuscaFunc(dCompIni, @cCargo, @cCargoDesc   )
			dCompPesq := dCompIni
		EndIf
	EndIf
	nBInssFl	:= 0
	nBInss13	:= 0
	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
	nDepIR		:= 0 //numero de dependentes PARA IR
	nDepSalFam	:= 0 //numero de dependentes PARA Salario famia

	SRV->(MsSeek (xFilial("SRV")+SRD->RD_PD ))

	nValorSrd := SRD->RD_VALOR

	If !lNorma89
		//-- Verbas de Base de Ir e Base de Inss a serem considerados no registro K250
		If SRD->RD_PD $	_aTotal[013,015,1]+"/"+_aTotal[013,027,1]+"/"+_aTotal[013,016,1]+"/"+;
						_aTotal[013,013,1]+"/"+_aTotal[013,014,1]+"/"+_aTotal[013,221,1]+"/"+_aTotal[013,225,1]+"/"+;
						_aTotal[013,019,1]+"/"+_aTotal[013,020,1]+"/"+_aTotal[013,100,1]
			cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			If substr(SRD->RD_ROTEIR,1,2) =="13"	//13o salario

		    	IF SRD->RD_SEMANA == "01"
		    		cTpFolha	:= "2"
		    	Else
		    		cTpFolha	:=  "5"
			    	lBaseIr13	:= .T. //(SRD->RD_PD == _aTotal[013, 27,1])
			    endif
				If SRD->RD_PD $ _aTotal[013,019,1]+"/"+ _aTotal[013,020,1] //Base de INSS 13o
			    	nBInss13 	:= SRD->RD_VALOR
			 	EndIf
			Elseif SRD->RD_ROTEIR == "FER"
				cTpFolha := "3"
		 	Else
				If SRD->RD_PD $ _aTotal[013,013,1]+"/"+_aTotal[013,014, 1]+"/"+_aTotal[013,221,1]+"/"+_aTotal[013,225,1]+"/"+_aTotal[013,019,1]+"/"+ _aTotal[013,020,1] //Base de INSS Folha e 13o salario
			    	nBInssFl 	:= SRD->RD_VALOR
				Endif
			Endif
		//-- Outras verbas existentes no movimento que indicam que houve movimento no mes porem nao houve base para
		//-- a previdencia social
		ElseIf SRD->RD_PD $	_aTotal[013,028,1]+"/"+_aTotal[013,152,1]+"/"+_aTotal[013,126,1]+"/"+_aTotal[013,029,1]+"/"+;
							_aTotal[013,045,1]+"/"+;
							_aTotal[013,030,1]+"/"+_aTotal[013,043,1]+"/"+_aTotal[013,026,1]+"/"+_aTotal[013,022,1]
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Elseif SRD->RD_ROTEIR == "FER"
				cTpFolha := "3"
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
			nValorSrd := 0.00
		//-- Salvo valor do Fgts do Mes porem nao considero como ocorrencia de movimento para o K250
		//-- a previdencia social
		ElseIf SRD->RD_PD == _aTotal[013,018,1]	//Base de Fgts
			_aTotal[014]	:= SRD->RD_VALOR
			nValorSrd := 0.00
		ElseIf SRD->RD_PD $ _aTotal[013, 059,1] //Dependente de IR
		 	nDepIR := SRD->RD_HORAS
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Elseif SRD->RD_ROTEIR == "FER"
				cTpFolha := "3"
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
			nValorSrd := 0.00
		ElseIf SRD->RD_PD $ _aTotal[013, 034,1] //Dependente de Salario Familia
			nDepSalFam := SRD->RD_HORAS
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Elseif SRD->RD_ROTEIR == "FER"
				cTpFolha := "3"
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
			nValorSrd := 0.00
		ElseIf SRD->RD_PD $ _aTotal[013,100,1]+"/"+_aTotal[013,167,1]
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Elseif SRD->RD_ROTEIR == "FER"
				cTpFolha := "3"
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
		ElseIf SRD->RD_PD == _aTotal[013,168,1]
	    	cTpFolha	:= "1"
	    	nValorSrd 	:= VerValPd(3)
		ElseIf SRD->RD_PD == _aTotal[013,169,1]
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
		Elseif SRD->RD_PD == _aTotal[013,151,1]
			cTpFolha = "6"
		ElseIf !(SRD->RD_PD $ _aTotal[013,106,1]+"/"+_aTotal[013,107,1])
	    	If subs(SRD->RD_ROTEIR,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
			nValorSrd := 0.00
		Endif
	Else
	    If SRD->RD_PD $ _aTotal[013, 15,1] //Base IR Folha
	    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
		ElseIf SRD->RD_PD $ _aTotal[013, 27,1] .and. ( substr(SRD->RD_DATARQ,5,2) =="13" .Or. SRD->RD_TIPO2 == "R" )	//Base IR 13o
	    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		ElseIf SRD->RD_PD $ _aTotal[013, 16,1]	//Base IR Ferias
	    	cTpFolha	:= "3"
		ElseIf SRD->RD_PD $ _aTotal[013,19,1]+"/"+ _aTotal[013,20,1] .and. substr(SRD->RD_DATARQ,5,2) =="12" //Base de INSS 13o Complementar
	    	cTpFolha	:= "5"
	    	nBInss13 	:= SRD->RD_VALOR
	    	nValorSrd 	:= 0
		ElseIf SRD->RD_PD $ _aTotal[013,151,1]+"/"+_aTotal[013,152,1]	//Base IR Distribuicao de Lucros
	    	cTpFolha	:= "6"
		ElseIf SRD->RD_PD $ _aTotal[013, 13,1]+"/"+_aTotal[013,14, 1]+"/"+_aTotal[013,221,1]+"/"+_aTotal[013,225, 1] //Base de INSS Folha
	    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
	    	nBInssFl 	:= SRD->RD_VALOR
		ElseIf SRD->RD_PD $ _aTotal[013,19,1]+"/"+ _aTotal[013,20,1] .and. substr(SRD->RD_DATARQ,5,2) =="13" //Base de INSS 13o
	    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
	    	nBInss13 	:= SRD->RD_VALOR
		ElseIf SRD->RD_PD == _aTotal[013, 18, 1]
			_aTotal[014] := SRD->RD_VALOR
	    ElseIf  (SRD->RD_PD $ _aTotal[013, 27,1] .and. SRD->RD_TIPO2 #"R" .and. substr(SRD->RD_DATARQ,5,2) =="12") .OR.;    //Complementar de 13o
				(SRV->RV_REF13 =="S" .and. SRD->RD_TIPO2 #"R" .and. substr(SRD->RD_DATARQ,5,2) =="12")
	    	cTpFolha	:= "5"
	    	lBaseIr13	:= (SRD->RD_PD == _aTotal[013, 27,1])
	    	If lNorma89 .and. !lBaseIr13
				nValorSrd := 0.00
	    	Endif
	    Elseif Empty(cTpFolha)
	    	If subs(SRD->RD_ROTEIRO,1,2) == "13"
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","2","5")
		    ElseIf SRD->RD_ROTEIRO == "FER"
		    	cTpFolha	:= "3"
		    ElseIf SRD->RD_ROTEIRO == "PLR"
		    	cTpFolha	:= "6"
		    Else
		    	cTpFolha	:= IIF(SRD->RD_SEMANA == "01","1","4")
			Endif
			nValorSrd := 0.00
		EndIf
	Endif

	If lNorma89 .and. (cTpFolha$"5#6")
		cTpFolha := "4"
	EndIf

	nPos := Ascan(aFolha,{|x|x[1]+x[2]+x[6]==SRD->RD_DATARQ+cTpFolha+SRD->RD_CC})
	nElem := If( nPos > 0, nPos, len(aFolha) +1 )
	If nPos == 0 .and. !empty(cTpFolha)
		Aadd( aFolha, {	SRD->RD_DATARQ						,;//01) Periodo
					cTpFolha								,;//02)	Tipo de Folha
					SRD->RD_DATPGT							,;//03)	Data de pagamento
					cCargo									,;//04)	Cargo
					cCargoDesc								,;//05)	Descricao do Cargo
					SRD->RD_CC								,;//06)	Centro de Custo
					If(cTpFolha == "1" .and. nBInssFl==0 .and. nBInss13==0,nValorSrd,0),;//07) Base IR Folha
					If(cTpFolha == "2" .and. nBInssFl==0 .and. nBInss13==0,nValorSrd,0),;//08) Base IR 13o
					If(cTpFolha == "3" .and. nBInssFl==0 .and. nBInss13==0,nValorSrd,0),;//09) Base IR Ferias
					If(cTpFolha == "5" .and. nBInssFl==0 .and. nBInss13==0 .and. lBaseIr13,nValorSrd,0),;//10) Base IR Folha complementar 13o
					If(cTpFolha == "6" .and. nBInssFl==0 .and. nBInss13==0,nValorSrd,0),;//11) Base IR Distribuicao de Lucros
					nBInssFl								,;//12)	Base Inss folha
					nBInss13								,;//13) Base Inss 13o
					If(cTpFolha == "4" .and. nBInssFl==0 .and. nBInss13==0 ,nValorSrd,0) ,;//14)Base Ir IN 89 outros
					nDepIR									,;//15) numero de dependentes PARA IR
					nDepSalFam								; //16) numero de dependentes PARA Salario familia
					})
	Else
		If cTpFolha == "1"
			aFolha[nElem,07]	+= If(nBInssFl==0,nValorSrd,0)	//Base IR Folha
			aFolha[nElem,12]	+= nBInssFl						//Base Inss folha
			aFolha[nElem,15]	:= If( nDepIR#0 , nDepIr, aFolha[nElem,15] )		//numero de dependentes PARA IR
			aFolha[nElem,16]	:= If( nDepSalFam # 0,nDepSalFam,aFolha[nElem,16])	//numero de dependentes PARA Salario Familia
		ElseIf cTpFolha == "2"
			aFolha[nElem,08]	+= If(nBInss13==0,nValorSrd,0)	//Base IR 13o
			aFolha[nElem,13]	+= nBInss13						//Base Inss 13o
			aFolha[nElem,15]	:= If( nDepIR#0 , nDepIr, aFolha[nElem,15] )		//numero de dependentes PARA IR
			aFolha[nElem,16]	:= If( nDepSalFam # 0,nDepSalFam,aFolha[nElem,16])	//numero de dependentes PARA Salario Familia
		ElseIf cTpFolha == "3"
			aFolha[nElem,09]	+= nValorSrd	//Base IR Ferias
			aFolha[nElem,15]	:= If( nDepIR#0 , nDepIr, aFolha[nElem,15] )		//numero de dependentes PARA IR
			aFolha[nElem,16]	:= If( nDepSalFam # 0,nDepSalFam,aFolha[nElem,16])	//numero de dependentes PARA Salario Familia
		ElseIf cTpFolha == "5" .and. !lNorma89
			aFolha[nElem,10]	+= If( lBaseIr13,nValorSrd,0)	//Base IR Folha complementar 13o
			aFolha[nElem,13]	+= nBInss13						//Base Inss 13o
			aFolha[nElem,15]	:= If( nDepIR#0 , nDepIr, aFolha[nElem,15] )		//numero de dependentes PARA IR
			aFolha[nElem,16]	:= If( nDepSalFam # 0,nDepSalFam,aFolha[nElem,16])	//numero de dependentes PARA Salario Familia
		ElseIf cTpFolha == "6" .and. !lNorma89
			aFolha[nElem,11]	+= nValorSrd  	//Base IR Distribuicao de Lucros
			aFolha[nElem,15]	:= If( nDepIR#0 , nDepIr, aFolha[nElem,15] )		//numero de dependentes PARA IR
			aFolha[nElem,16]	:= If( nDepSalFam # 0,nDepSalFam,aFolha[nElem,16])	//numero de dependentes PARA Salario Familia
		ElseIf cTpFolha =="4" .or. lNorma89
			aFolha[nElem,14]	+= If(nBInssFl==0,nValorSrd,0)  	//Base IR IN89 Outras
			aFolha[nElem,12]	+= nBInssFl  	//Base INSS Complementar
    	EndIF
	Endif
	If fBusIns(SRD->RD_FILIAL,SRD->RD_MAT,SRD->RD_DATARQ,_aTotal[013, 045, 1])
		aFolha[nElem,07] := 0
	Endif
	SRD->( dbSkip())
	lBaseIr13 := .F.
EndDo

For nI := 1 to Len(aFolha)
	nValorIr	:= 0
	cMesFinal 	:= Iif(substr(aFolha[nI,1],5,2)="13","12",substr(aFolha[nI,1],5,2))
	dCompIni 	:= cToD("01/"+cMesFinal+"/"+substr(aFolha[nI,1],1,4))

	If !empty(aFolha[nI,7])			//Base IR Folha
	 	nValorIr 	:= 	aFolha[nI,07]
	ElseIf !empty(aFolha[nI,08])		//Base IR 13o
	 	nValorIr 	:= 	aFolha[nI,08]
	ElseIf !empty(aFolha[nI,09])		//Base IR Ferias
	 	nValorIr 	:= 	aFolha[nI,09]
	ElseIf !empty(aFolha[nI,10])		//Base IF Folha complementar 13o
	 	nValorIr 	:= 	aFolha[nI,10]
	ElseIf !empty(aFolha[nI,11])	//Base IR Distribuicao de Lucros
	 	nValorIr 	:= 	aFolha[nI,11]
	ElseIf !empty(aFolha[nI,14])	//Base IR IN89(Outras folhas)
	 	nValorIr 	:= 	aFolha[nI,14]
	EndIf

	RecLock("TMP",.T.)
	TMP->TMP_FILIAL	:= SRA->RA_FILIAL
	TMP->TMP_CNPJ	:= AllTrim (SM0->M0_CGC)
	TMP->TMP_INDFL	:= aFolha[nI,2]
	TMP->TMP_LCT	:= aFolha[nI,6]
	TMP->TMP_MAT	:= SRA->RA_MAT
	TMP->TMP_COMP	:= aFolha[nI,1]
	TMP->TMP_PGTO	:= DataInt(aFolha[nI,3])
	TMP->TMP_CBO	:=	"0"+fCodCBO (SRA->RA_FILIAL,aFolha[nI,4], dCompIni, .T.)
	TMP->TMP_CARGO 	:= aFolha[nI,5]
	TMP->TMP_DEP_IR	:= aFolha[nI,15]
	TMP->TMP_DEP_SF	:= aFolha[nI,16]
	TMP->TMP_BS_IR	:= STRTRAN(TRANSFORM(ABS(nValorIr),"@R 99999999999999.99"),".",",")
	If SRA->RA_AFASFGT == "A" .And. nValorIr == 0
		TMP->TMP_BS_PS	:= STRTRAN(TRANSFORM(ABS(0),"@R 99999999999999.99"),".",",")
	Else
		TMP->TMP_BS_PS	:= STRTRAN(TRANSFORM(ABS(If(aFolha[nI,2] $"1#4",aFolha[nI,12],If(aFolha[nI,2] $"2#5",aFolha[nI,13],0))),"@R 99999999999999.99"),".",",")
	EndIf
	If TYPE("SRA->RA_OCORREN") # "U"
		If !Empty(SRA->RA_OCORREN)
			TMP->TMP_OCORR := SRA->RA_OCORREN
		Else
			TMP->TMP_OCORR := "00"
		EndIf
	Else
		TMP->TMP_OCORR	:= "01"
	EndIf
	MsUnlock()
Next nI

_aTotal[085] := aFolha

Return .T.

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณMATXMAG   บAutor  ณMicrosiga           บ Data ณ  07/12/07   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Verifica se existe lancamento no SRD para este funcionario บฑฑ
ฑฑบ          ณe se foi gerado um registro para ele no TMP, que posterior- บฑฑ
ฑฑบ          ณmente se tornara no registro K250. Se existir lancamento no บฑฑ
ฑฑบ          ณSRD e nao foi gerado registro no TMP, gera um registro com  บฑฑ
ฑฑบ          ณas bases de INSS e IR zeradas.                              บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ MANAD                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ChkItens(aFolha,cPerIni, cPerFim)

Local cPer01 	:= MesAno(cPerIni)
Local dCompPesq := ctod('')
Local cMesFinal	:= ""
Local dCompIni	:= ctod("")
Local cCargo	:= ""
Local cCargoDesc:= ""
Local cMes		:= ""
Local cAno		:= ""
Local lGrava	:= .F.
Local aCusto	:= {}
Local cCusAux	:= ""
Local nI		:= 0

While cPer01  <= cPerFim
	If Ascan(aFolha,{|x|x[1] == cPer01 }) == 0
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณSe nใo encontrar o perํodo no array afolha, verifica se tem lancamento no SRD.ณ
	//ณSe tiver lancamento grava um registro no TMP para poder gerar um registro k250ณ
	//ณreferente a esse funcionario.                                                 ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		If SRD->( MsSeek(SRA->RA_FILIAL+SRA->RA_MAT+cPer01 ) ) .and. SRD->RD_EMPRESA= SPACE(2)
			//--Nใo considero as verbas de IR de mes anterior e de autonomo
			While SRD->(! Eof() .And. RD_PD <> _aTotal[013,106,1] .And. SRD->(RD_FILIAL+RD_MAT) == SRA->(RA_FILIAL+RA_MAT) .AND. ;
						RD_PD <> _aTotal[013,107,1] .And. RD_PD <> _aTotal[013,208,1] .And. RD_PD <> _aTotal[013,318,1] )
				lGrava := .T.
				if cCusAux <> SRD->RD_CC .and. Ascan(aCusto,{|x| x == SRD->RD_CC }) == 0
					aadd(aCusto,SRD->RD_CC)
					cCusAux := SRD->RD_CC
				endif
				SRD->(dbSkip())
			EndDo

			If lGrava
				SRD->( MsSeek(SRA->RA_FILIAL+SRA->RA_MAT+cPer01 ) )
				cMesFinal 	:= Iif(substr(SRD->RD_DATARQ ,5,2)="13","12",substr(SRD->RD_DATARQ ,5,2))
				dCompIni 	:= cToD("01/"+cMesFinal+"/"+substr(SRD->RD_DATARQ ,1,4))

				If dCompPesq # dCompIni
					fBuscaFunc(dCompIni, @cCargo, @cCargoDesc   )
					dCompPesq := dCompIni
				EndIf

				For nI := 1 to len(aCusto)
					RecLock("TMP",.T.)
					TMP->TMP_FILIAL	:= SRA->RA_FILIAL
					TMP->TMP_CNPJ	:= AllTrim (SM0->M0_CGC)
					TMP->TMP_INDFL	:= fTp_Folha(SRD->RD_PD,"MANAD")
					TMP->TMP_LCT	:= aCusto[nI]
					TMP->TMP_MAT	:= SRA->RA_MAT
					TMP->TMP_COMP	:= cPer01
					TMP->TMP_PGTO	:= DataInt(SRD->RD_DATPGT)
					TMP->TMP_CBO	:=	"0"+fCodCBO (SRA->RA_FILIAL,cCargo, dCompIni, .T.)
					TMP->TMP_CARGO 	:= cCargoDesc
					TMP->TMP_DEP_IR	:= If( SRD->RD_PD $ _aTotal[013, 059,1], SRD->RD_HORAS,0)
					TMP->TMP_DEP_SF	:= If( SRD->RD_PD $ _aTotal[013, 034,1], SRD->RD_HORAS,0)
					TMP->TMP_BS_IR	:= "0"
					TMP->TMP_BS_PS	:= "0"
					If TYPE("SRA->RA_OCORREN") # "U"
						If !Empty(SRA->RA_OCORREN)
							TMP->TMP_OCORR := SRA->RA_OCORREN
						Else
							TMP->TMP_OCORR := "00"
						EndIf
					Else
						TMP->TMP_OCORR	:= "01"
					EndIf
					MsUnlock()
				Next
			EndIf

	    EndIf
	EndIf

	cMes := StrZero(Val(substr(cPer01,5,2)) +1,2)
	cAno := strzero(Val(substr(cPer01,1,4)),4)
	If cMes > '13'
		cAno := strzero(Val(substr(cPer01,1,4))+1 ,4)
		cPer01 := cAno+"01"
	Else
		cPer01 := cAno+cMes
	EndIf
	aCusto	:= {}
EndDo

_aTotal[085] := ""

Return .T.



/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณVer_PD    บAutor  ณAndreia dos Santos  บ Data ณ  24/10/05   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna o tipo da verba: Provento, Desconto, Base           บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function Ver_PD(cVerba,cInstr)
Local cTipo := ""
Local cAlias := "SRV"

DEFAULT cInstr := ""

#IFDEF TOP
	If TcSrvType()<>"AS/400"
		If cInstr == "MANAD"
			cAlias := "SRV"
		   	cChave := If(FWModeAccess("SRV",3)=="E", SRD->RD_FILIAL ,xFILIAL("SRV") )+ cVerba
		   	SRV->( MsSeek( cChave )	)
		Else
			cAlias := "SRV"
		EndIf
	Else
		cAlias := "SRV"
		cChave := If(FWModeAccess("SRV",3)=="E", SRD->RD_FILIAL ,xFILIAL("SRV") )+ cVerba
		SRV->( MsSeek( cChave )	)
	EndIf
#ELSE
	cChave := If(FWModeAccess("SRV",3)=="E", SRD->RD_FILIAL ,xFILIAL("SRV") )+ cVerba
	SRV->( MsSeek( cChave )	)
#ENDIF

If (cAlias)->RV_TIPOCOD == "1"
	cTipo := "P"
ElseIf (cAlias)->RV_TIPOCOD == "2"
	cTipo := "D"
ElseIf (cAlias)->RV_TIPOCOD == "3" .and. cInstr # "MANAD"
	cTipo := "B"
ElseIf (cAlias)->RV_TIPOCOD $"3#4" .and. cInstr == "MANAD"
	cTipo := "O"
EndIf
Return( cTipo )

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณVER_TRANSFบAutor  ณAndreia dos Santos  บ Data ณ  20/02/06   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Verifica se o funcionario teve transferencias e consite se บฑฑ
ฑฑบ          ณele ja estava na empresa dentro do periodo solicitado       บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function VER_TRANSF()
Local lRet 		:= .T.
Local aTransf 	:= {}
Local nX		:= 1
Local nPos		:= 0
Local dDataTrf	:= _aTotal[68]

IF fTransf(@aTransf,,.f.,.f.,,,,.T.)

	//-- Avalia a transferencia "Para"
	For nX := 1 To Len( aTransf )
		//Avalia a transferencia somente quando a Empresa "Para" ou Filial "Para" corresponder ao registro
		//do funcionario que esta sendo processado. Porem despreza as transferencias por centro de custos
		//uma vez que elas nao devem influenciar a geracao do funcionario.
 		If 	( aTransf[nX,04] == cEmpAnt .And. aTransf[nX,01] <> aTransf[nX,04] );
			.or.;
			( (aTransf[nX,04] == cEmpAnt .AND. aTransf[nX,10] == SRA->RA_FILIAL) .And. aTransf[nX,08] <> aTransf[nX,10]  )
			If aTransf[nx, 07] > _aTotal[002] //Data da transferencia maior que a data de pesquisa
		   		lRet	:= .F.
		   	Else
		   		dDataTrf:= aTransf[nX,07]
		   		exit
		   	EndIf
		EndIf
	Next nX

	//-- Avalia a transferencia "De"
	nPos	:= Ascan(aTransf,{|X| X[1] == cEmpAnt .And. X[2] == SRA->(RA_FILIAL+RA_MAT) .And. X[1]+X[8] <> X[4]+X[10] })
	//-- Avalia origem da transferencia para identificar se houve uma transferencia anterior que esteja dentro do periodo
	//-- de geracao do manad, pois isto indica que dentro do periodo do manad houve movimentacao anterior a "Transferencia
	//-- Para"
	If nPos > 0
		//-- Ja encontrou transferencia "Para" e deve avaliar a transferencia "De"
		If lRet .And. aTransf[nPos,7] <= dDataTrf .And. aTransf[nPos,7] >= _aTotal[001] .And. aTransf[nPos,7] <= _aTotal[002]
			dDataTrf	:= _aTotal[68]
		//-- Nao encontrou transferencia "Para"
		ElseIf !lRet .And. aTransf[nPos,7] >= _aTotal[001]
			lRet		:= .T.
		Endif
	Endif
	//-- Verifica se a nova data encontrada eด diferente da data de admissao.
	If dDataTrf <> _aTotal[68]
		_aTotal[68]	:= dDataTrf
	Endif
EndIf
Return( lRet )

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณCalcRB     ณ Autor ณSergio S. Fuzinaka     ณ Data ณ 20.06.05 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณCalcula o Total Acumulado da Receita Bruta                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpD1: Data Inicial                                          ณฑฑ
ฑฑณ          ณExpD2: Data Final                                            ณฑฑ
ฑฑณ          ณExpN3: Receita Mensal                                        ณฑฑ
ฑฑณ          ณExpL4: Calculo da Receita Bruta Mensal                       ณฑฑ
ฑฑณ          ณExpC5: Array com o total mensal da receita                   ณฑฑ
ฑฑณ          ณExpL6: Calculo referente a receita bruta de telecominicacoes ณฑฑ
ฑฑณ          ณExpL7: Processa range de filiais                             ณฑฑ
ฑฑณ          ณExpC8: Filial inicial para processamento do range            ณฑฑ
ฑฑณ          ณExpC9: Filial final para processamento do range              ณฑฑ
ฑฑณ          ณExpC10: Calculo ISS                                          ณฑฑ
ฑฑณ          ณExpC11: Calculo ST                                           ณฑฑ
ฑฑณ          ณExpC12:Identifica Simples Nacional                           ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function CalcRB(dDataIni,dDataFim,nRBMensal,lMensal,aTotMes,lTeleCom,lProcFil,cFilIni,cFilFin,nRBServ,nRBST,lSimplesN,nRBLoc,cTPRecSN,nSeRecSN,nRBServRet, dDtIn, dDtFim, nRBMesExp,lTotalRB)

Local aRBAcMan		:= ""
Local aArq			:= {"SF2","","TRSF2"}
Local aArqF1		:= {"SF1",""}
Local aAreaSm0		:= SM0->(GetArea())

Local cDbf			:= ""
Local cTop			:= ""
Local cDbfF1		:= ""
Local cTopF1		:= ""
Local cCNAE			:= ""
Local cFilTele		:= GetNewPar("MV_CFTECOM","")

Local lM913F1		:= ExistBlock ("M913F1")
Local lM913F2		:= ExistBlock ("M913F2")
Local lSimpFis		:= .F.
Local cTesAtvMob    := GetNewPar("MV_TESATMB","")

Local nItem			:= 0
Local nTotalRB 		:= 0		//Total da Receita Bruta
Local nDedTelCom 	:= 0
Local nX			:= 0
Local nValBrut		:= 0
Local nValIss		:= 0
Local nVlRetIss		:= 0
Local nValST		:= 0
Local nValLoc		:= 0
Local cLocacao		:= GetNewPar("MV_LOCACAO","")
Local cTabAux   	:= ""
Local cExTprspl		:= ""
Local nMeses		:= 0
Local cTesDup       := ""
#IFDEF TOP
	Local cAliasSF2	:= ""
#ENDIF

Default aTotMes		:= {}
Default nRBMensal	:= 0
Default nRBServ		:= 0
Default nRBServRet	:= 0
Default nRBST		:= 0
Default nRBLoc		:= 0
Default lMensal		:= .F.
Default lTeleCom	:= .F.
Default lProcFil	:= .F.
Default cFilIni		:= ""
Default cFilFin		:= ""
Default lSimplesN   := .F.
Default cTPRecSN    := ""
Default nSeRecSN	:= 1
Default nRBMesExp 	:= 0
Default lTotalRB	:= .T.
Default dDtIn := dDataIni

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณVerifica se a funcao devera processar um range de filiaisณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If !lProcFil
	cFilIni := cFilAnt
	cFilFin := cFilAnt
Endif

cCNAE := SM0->M0_CNAE

dbSelectArea("SM0")
SM0->(dbSeek(cEmpAnt+cFilIni,.T.))

nRBMensal := 0
aTotMes	  := {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0}}

Do While !SM0->(Eof()) .And. FWGrpCompany() + FWCodFil() <= cEmpAnt + cFilFin

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณQuando estiver processando mais de uma filial, somente faraoณ
	//ณparte do calculo da receita bruta as empresas com mesmo ramoณ
	//ณde atividade (CNAE).                                        ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If SM0->M0_CNAE <> cCNAE
		SM0->(dbSkip())
		Loop
	Endif

	cFilAnt	:=	FWCodFil()

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณSe o contribuinte utiliza apenas o fiscal para o processamento,ณ
	//ณnao existe o ValFat (carregado pelo faturamento).              ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	lSimpFis := GetNewPar("MV_SIMPFIS",.T.)
	If lSimpFis
		cDbf	:= "F2_FILIAL=='"+xFilial("SF2")+"' .AND. DTOS(F2_EMISSAO)>='"+Dtos(dDataIni)+"' .AND. DTOS(F2_EMISSAO)<='"+Dtos(dDataFim)+"' .AND. F2_TIPO$' NCP' .AND. F2_VALFAT>0"
		cTop	:= "F2_FILIAL='"+xFilial("SF2")+"' AND F2_EMISSAO>='"+Dtos(dDataIni)+"' AND F2_EMISSAO<='"+Dtos(dDataFim)+"' AND F2_TIPO IN ('N','C','P') AND F2_VALFAT>0"
	Else
		cDbf	:= "F2_FILIAL=='"+xFilial("SF2")+"' .AND. DTOS(F2_EMISSAO)>='"+Dtos(dDataIni)+"' .AND. DTOS(F2_EMISSAO)<='"+Dtos(dDataFim)+"' .AND. F2_TIPO$' NCP'"
		cTop	:= "F2_FILIAL='"+xFilial("SF2")+"' AND F2_EMISSAO>='"+Dtos(dDataIni)+"' AND F2_EMISSAO<='"+Dtos(dDataFim)+"' AND F2_TIPO IN ('N','L','C','P')"
	Endif
	cDbfF1	:= "F1_FILIAL=='"+xFilial("SF1")+"' .AND. DTOS(F1_DTDIGIT)>='"+Dtos(dDataIni)+"' .AND. DTOS(F1_DTDIGIT)<='"+Dtos(dDataFim)+"' .AND. F1_TIPO=='D'"
	cTopF1	:= "F1_FILIAL='"+xFilial("SF1")+"' AND F1_DTDIGIT>='"+Dtos(dDataIni)+"' AND F1_DTDIGIT<='"+Dtos(dDataFim)+"' AND F1_TIPO='D'"
	If  (nSeRecSN) == 2 .And. lTotalRB
		cDbf	+= " .AND. SF4.F4_TPRSPL $ "+cTPRecSN
		cTop	+= " AND SF4.F4_TPRSPL IN ("+cTPRecSN+")"
		cDbfF1	+= " .AND. SF4.F4_TPRSPL $ "+cTPRecSN
		cTopF1	+= " AND SF4.F4_TPRSPL IN ("+cTPRecSN+")"
	EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณPonto de Entrada - Simples Federal   ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If (lM913F1)
		cTopF1	+=	" AND "
		cTopF1	+=	ExecBlock("M913F1",.F.,.F.,)
		cDbfF1	+=	" .And. "
		cDbfF1	+=	ExecBlock("M913F1",.F.,.F.,)
	EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณPonto de Entrada - Simples Federal   ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If (lM913F2)
		cTop	+=	" AND "
		cTop	+=	ExecBlock("M913F2",.F.,.F.,)
		cDbf	+=	" .And. "
		cDbf	+=	ExecBlock("M913F2",.F.,.F.,)
	EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณReceita Bruta Acumulada informada manualmente     ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	IF !Empty(GetNewPar("MV_RBACMAN",""))
		aRBAcMan := &(GetNewPar("MV_RBACMAN",{0,0}))
		// O Parโmetro de data Inicial deve estar preenchido e a data de gera็ใo do arquivo deve ser sempre maior ou igual a data de inicio de utiliza็ใo do sistema. Caso contrแrio ele nใo usava o sistema do periodo que esta gerando o arquivo.
		IF  Len(aRBAcMan) == 12 .And. !Empty(aRBAcMan) .And. !Empty(GetNewPar("MV_DTINISI",""))  .And. dDtIn >= ctod(GetNewPar("MV_DTINISI",""))
				nMeses :=  DateDiffMonth(dDtIn, ctod(GetNewPar("MV_DTINISI","") ))
				IF nMeses == 0
					nMeses:= 12
					For nX := 1 to Len(aRBAcMan)
						nTotalRB+= aRBAcMan[nX,2]
					Next
				Else
						nMeses := 12 - DateDiffMonth(dDtIn, ctod(GetNewPar("MV_DTINISI","") ))
						IF   nMeses <> 0
							For nX := 1 to nMeses
								nTotalRB+= aRBAcMan[nX,2]
							Next
						EndIf
				EndIf
		EndIf
    EndIf

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณProcessa Notas Fiscais de Saida                   ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

 	#IFDEF TOP
		dbSelectArea("SF2")
		SF2->(dbsetorder(1))
	    If TcSrvType()<>"AS/400"

		    cSelect := "%SD2.D2_CF, SF4.F4_CODIGO, SF4.F4_INCSOL, SF4.F4_DUPLIC, SF4.F4_SITTRIB, SF2.F2_EMISSAO, SD2.D2_GRUPO, SF2.F2_EST, "
      		If cPaisLoc == "BRA"
      			cSelect	+=	"SFT.FT_RECISS, SB1.B1_FUSTF, "
	    	EndIf
	    	cSelect	+=	"SF4.F4_TPRSPL, "
   		    cSelect += "SUM(SD2.D2_VALBRUT) NVALBRUTO, SUM(SD2.D2_VALICM) NVALICM, SUM(SD2.D2_BASEISS) NBASEISS, SUM( SD2.D2_ICMSRET) NICMSRET, "
 		    cSelect += "SUM(SFT.FT_VALCONT) NVALCONT, SUM(SFT.FT_VALPIS) NVALPIS, SUM(SFT.FT_VALCOF) NVALCOF%"
  		    cFrom   := "%"+RetSqlName("SF2")+" SF2 "
	        cFrom	+=	" LEFT JOIN "+RetSqlName("SD2")+" SD2 ON SD2.D2_FILIAL='"+xFilial("SD2")+"' AND SF2.F2_DOC=SD2.D2_DOC AND SF2.F2_SERIE=SD2.D2_SERIE AND SF2.F2_CLIENTE=SD2.D2_CLIENTE AND SF2.F2_LOJA=SD2.D2_LOJA AND SD2.D_E_L_E_T_=' '"
	        cFrom	+=	" LEFT JOIN "+RetSqlName("SFT")+" SFT ON SFT.FT_FILIAL='"+xFilial("SFT")+"' AND SD2.D2_DOC=SFT.FT_NFISCAL AND SD2.D2_SERIE=SFT.FT_SERIE AND SD2.D2_CLIENTE=SFT.FT_CLIEFOR AND SD2.D2_LOJA=SFT.FT_LOJA AND SD2.D2_ITEM=SFT.FT_ITEM AND SFT.D_E_L_E_T_=' '"
	        cFrom	+=	" LEFT JOIN "+RetSqlName("SB1")+" SB1 ON SB1.B1_FILIAL='"+xFilial("SB1")+"' AND SD2.D2_COD=SB1.B1_COD AND SB1.D_E_L_E_T_=' '"
		    cFrom	+=	" LEFT JOIN "+RetSqlName("SF4")+" SF4 ON SF4.F4_FILIAL='"+xFilial("SF4")+"' AND SD2.D2_TES=SF4.F4_CODIGO AND SF4.D_E_L_E_T_=' '%"
        	cWhere  :=  "%" + cTop + " AND "
		    cWhere	+=	"SF2.D_E_L_E_T_=' '"
	    	If cPaisLoc == "BRA"
	    		cGroupBy := " GROUP BY SD2.D2_CF, SF4.F4_CODIGO, SF4.F4_INCSOL, SF4.F4_DUPLIC, SF4.F4_SITTRIB, SF2.F2_EMISSAO, SD2.D2_GRUPO, SB1.B1_FUSTF, SFT.FT_RECISS, SF2.F2_EST"
    		Else
    			cGroupBy := " GROUP BY SD2.D2_CF, SF4.F4_CODIGO, SF4.F4_INCSOL, SF4.F4_DUPLIC, SF4.F4_SITTRIB, SF2.F2_EMISSAO, SD2.D2_GRUPO,SF2.F2_EST"
    		EndIf
    		cGroupBy	+= ", SF4.F4_TPRSPL "
    	    cOrderBy :=	" ORDER BY 1%"

	 	   	cAliasSF2 := "CALCRBF2"
			BeginSql Alias cAliasSF2
				COLUMN F2_EMISSAO AS DATE

				SELECT
					%Exp:cSelect%

				FROM
					%Exp:cFrom%

				WHERE
					%Exp:cWhere+cGroupBy+cOrderBy%

			EndSql

			dbSelectArea(cAliasSF2)

		EndIf

		(cAliasSF2)->(DbGoTop ())
	 	While (cAliasSF2)->(!Eof())

		   	nDedTelCom 	:= 0
		   	nValBrut	:= 0
		   	nValIss		:= 0
		   	nVlRetIss	:= 0
		   	nValICMS	:= 0
		   	nValST		:= 0
		   	nValLoc		:= 0

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณReceita Bruta ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณPara o calculo da receita bruta de comunicacao e telecomunicacao e necessario ณ
			//ณverificar se o CFOP do documento fiscal deve ser processado, visto que apenas ณ
			//ณmovimentos deste tipo devem ser considerados para o calculo.                  ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		cExTprspl := (cAliasSF2)->F4_TPRSPL
		If ALLTRIM(cTPRecSN) == ALLTRIM(cExTprspl) .Or. Empty(cTPRecSN) .Or. nSeRecSN == 1 .Or.  nSeRecSN == 2 .Or.  nSeRecSN == 3
			If lTeleCom .And. !Empty(cFilTele)

				If cPaisLoc == "BRA"
					cFust := (cAliasSF2)->B1_FUSTF
				EndIf
			    If !(Alltrim((cAliasSF2)->D2_CF) $ cFilTele) .Or. cFust=="2"
				   	(cAliasSF2)->(dbSkip())
				   	Loop
			    Endif
			    nValBrut 	:= (cAliasSF2)->NVALBRUTO
			    //Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
			    If cPaisLoc == "BRA" .And. (cAliasSF2)->FT_RECISS == "1"
			    	nVlRetIss	:=	(cAliasSF2)->NBASEISS
			    Else
			    	nValIss		:=	(cAliasSF2)->NBASEISS
			    Endif
			Else
			  //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			  //|Se for gerada pelo Faturamento verifico se gera duplicataณ
			  //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	   		 If lSimpFis//MV_SIMPFIS
			    If (cAliasSF2)->F4_DUPLIC=="S"
			    	If lSimplesN //Simples Nacional
						If !(cAliasSF2)->F4_CODIGO $ cTesAtvMob
							//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
					     	If cPaisLoc == "BRA" .And. (cAliasSF2)->FT_RECISS == "1"
						    	nVlRetIss	:=	(cAliasSF2)->NBASEISS
						    Else
						    	nValIss		:=	(cAliasSF2)->NBASEISS
						    Endif
					    	If (cAliasSF2)->NICMSRET > 0 //ICMS-ST nใo ้ uma receita
			   			    	If !(cAliasSF2)->F4_INCSOL$"A,N,D"
			   			    		If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
						    			nValST		:= ((cAliasSF2)->NVALBRUTO - (cAliasSF2)->NICMSRET)
						    		EndIf
						    		nValBrut 	:= ((cAliasSF2)->NVALBRUTO - (cAliasSF2)->NICMSRET)
						    	Else
			   			    		If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
						    			nValST		:= (cAliasSF2)->NVALBRUTO
						    		EndIf
						    		nValBrut 	:= (cAliasSF2)->NVALBRUTO
						    	EndIf
					    	Else
							   	If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
						    		nValST		:= (cAliasSF2)->NVALBRUTO
							   	EndIf
							   	If (cAliasSF2)->D2_GRUPO $ cLocacao
				    				 nValLoc 	:= (cAliasSF2)->NVALBRUTO
				       			Endif
					    		nValBrut 	:= (cAliasSF2)->NVALBRUTO
					    	EndIf
					 	EndIf
					 Else
						 If (cAliasSF2)->D2_GRUPO $ cLocacao
				    		 nValLoc 	:= (cAliasSF2)->NVALBRUTO
				    	Endif
				    	nValBrut 	:= (cAliasSF2)->NVALBRUTO
				    	//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
				    	If cPaisLoc == "BRA" .And. (cAliasSF2)->FT_RECISS == "1"
					    	nVlRetIss	:=	(cAliasSF2)->NBASEISS
					    Else
					    	nValIss		:=	(cAliasSF2)->NBASEISS
					    Endif
				    EndIf
			    EndIf
			 Else
			  	If lSimplesN
			  		If !(cAliasSF2)->F4_CODIGO $ cTesAtvMob
				  		//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
				  		If cPaisLoc == "BRA" .And. (cAliasSF2)->FT_RECISS == "1"
					    	nVlRetIss	:=	(cAliasSF2)->NBASEISS
					    Else
					    	nValIss		:=	(cAliasSF2)->NBASEISS
					    Endif
				  		If (cAliasSF2)->NICMSRET > 0 //ICMS-ST nใo ้ uma receita
		   			    	If !(cAliasSF2)->F4_INCSOL$"A,N,D"
		   			    		If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
					    			nValST		:= ((cAliasSF2)->NVALBRUTO - (cAliasSF2)->NICMSRET)
					    		EndIf
					    		nValBrut 	:= ((cAliasSF2)->NVALBRUTO - (cAliasSF2)->NICMSRET)
					    	Else
					    		If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
					    			nValST		:= (cAliasSF2)->NVALBRUTO
					    		EndIf
					    		nValBrut 	:= (cAliasSF2)->NVALBRUTO
					    	EndIf
				    	Else
				    		If ALLTRIM((cAliasSF2)->F4_SITTRIB)$"10/30/60/70"
					    		nValST		:= (cAliasSF2)->NVALBRUTO
				    		EndIf
				    		If (cAliasSF2)->D2_GRUPO $ cLocacao
					    		 nValLoc 	:= (cAliasSF2)->NVALBRUTO
					    	Endif
				    		nValBrut 	:= (cAliasSF2)->NVALBRUTO
				    	EndIf
				    EndIf
			    Else
			    	If (cAliasSF2)->D2_GRUPO $ cLocacao
			    		 nValLoc 	:= (cAliasSF2)->NVALBRUTO
			    	Endif
			    	nValBrut 	:= (cAliasSF2)->NVALBRUTO
			    	//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
			    	If cPaisLoc == "BRA" .and. (cAliasSF2)->FT_RECISS == "1"
				    	nVlRetIss	:=	(cAliasSF2)->NBASEISS
				    Else
				    	nValIss		:=	(cAliasSF2)->NBASEISS
				    Endif
			    EndIf
			  EndIf
            EndIf

			If lTeleCom
				nValICMS	:= (cAliasSF2)->NVALICM
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณReceita Bruta referente ao ICMS ST ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	   		If (cAliasSF2)->NICMSRET > 0
		   		aTotMes[Month((cAliasSF2)->F2_EMISSAO)][2] := ((cAliasSF2)->NVALCONT)
		   	Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤadminฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณO valor do PIS e da Cofins sera deduzido da receita bruta de telecomunicacoesณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		   	If lTeleCom
		   		/*
		   		If Type("aNfItem") == "U"
		   			MaFisIniNf(2, 0,, "TRSF2", .F.)
		   		EndIf
			   	nDedTelCom += MaFisRet(nItem,"IT_VALPS2")
			   	nDedTelCom += MaFisRet(nItem,"IT_VALCF2")*/

			   	nDedTelCom += (cAliasSF2)->NVALPIS
			   	nDedTelCom += (cAliasSF2)->NVALCOF
			Endif

			aTotMes[Month((cAliasSF2)->F2_EMISSAO)][1] +=  nValBrut

		    If lMensal
		    	If (cAliasSF2)->F2_EMISSAO >= dDataIni .And. (cAliasSF2)->F2_EMISSAO <= dDataFim
					nTotalRB 	+= nValBrut   			// Mensal
					nRBServ 	+= nValIss				// Mensal Servico
					nRBServRet	+= nVlRetIss			// Mensal Servico Retido
					nRBST		+= nValST				// Mensal ST
					nRBLoc		+= nValLoc				// Mensal Locacao
				Endif
			Else
				nTotalRB 		+= nValBrut  			// Acumulado
				nRBServ 		+= nValIss				// Acumulado Servico
				nRBServRet		+= nVlRetIss			// Acumulado Servico Retido
				nRBST			+= nValST				// Acumulado ST
				nRBLoc			+= nValLoc				// Acumulado Locacao
			Endif

			If (cAliasSF2)->F2_EMISSAO >= dDataIni
				nRBMensal += nValBrut
				//Quando a opera็ใo for com o exterior
				If (cAliasSF2)->F2_EST=="EX"
					nRBMesExp 	+= nValBrut 	// Mensal exportacao
				Endif
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณQuando for o processamento da receita bruta para telecomunicacoesณ
			//ณ(para calculo do FUST e FUNTTEL) e necessario deduzir o valor do ณ
			//ณICMS, do PIS e da Cofins.                                        ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If lTeleCom
				nDedTelCom 	+= nValICMS
				nTotalRB	:= nTotalRB - nDedTelCom
			Endif
		EndIf

			(cAliasSF2)->(dbSkip())
		Enddo

		(cAliasSF2)->(DbCloseArea())

		dbSelectArea("SF1")
		SF1->(dbsetorder(1))
	    If TcSrvType()<>"AS/400"

		    cSelect := "%SD1.D1_CF, SF4.F4_CODIGO, SF4.F4_INCSOL, SF4.F4_SITTRIB, SF1.F1_DTDIGIT, "
    		If cPaisLoc == "BRA"
    			cSelect	+=	"SB1.B1_FUSTF, "
    		EndIf
    		If (SF4->(FieldPos("F4_TPRSPL"))>0)
	    		cSelect	+=	"SF4.F4_TPRSPL, "
	    	EndIf
   		    cSelect += "SUM(SD1.D1_TOTAL) NTOTAL, SUM( SD1.D1_ICMSRET) NICMSRET, "
 		    cSelect += "SUM(SD1.D1_VALICM) NVALICM, SUM(SFT.FT_VALCONT) NVALCONT, SUM(SFT.FT_VALPIS) NVALPIS, SUM(SFT.FT_VALCOF) NVALCOF%"
  		    cFrom   := "%"+RetSqlName("SF1")+" SF1 "
  	        cFrom	+=	" LEFT JOIN "+RetSqlName("SD1")+" SD1 ON SD1.D1_FILIAL='"+xFilial("SD1")+"' AND SF1.F1_DOC=SD1.D1_DOC AND SF1.F1_SERIE=SD1.D1_SERIE AND SF1.F1_FORNECE=SD1.D1_FORNECE AND SD1.D1_LOJA=SF1.F1_LOJA  AND SD1.D_E_L_E_T_=' '"
	        cFrom	+=	" LEFT JOIN "+RetSqlName("SFT")+" SFT ON SFT.FT_FILIAL='"+xFilial("SFT")+"' AND SD1.D1_DOC=SFT.FT_NFISCAL AND SD1.D1_SERIE=SFT.FT_SERIE AND SD1.D1_FORNECE=SFT.FT_CLIEFOR AND SD1.D1_LOJA=SFT.FT_LOJA AND SFT.FT_ITEM=SD1.D1_ITEM AND SFT.D_E_L_E_T_=' '"
            cFrom	+=	" LEFT JOIN "+RetSqlName("SB1")+" SB1 ON SB1.B1_FILIAL='"+xFilial("SB1")+"' AND SD1.D1_COD=SB1.B1_COD AND SB1.D_E_L_E_T_=' '"
            cFrom	+=	" LEFT JOIN "+RetSqlName("SF4")+" SF4 ON SF4.F4_FILIAL='"+xFilial("SF4")+"' AND SD1.D1_TES=SF4.F4_CODIGO AND SF4.D_E_L_E_T_=' '%"
		    cWhere  :=  "%" + cTopF1 + " AND "
		    cWhere	+=	"SF1.D_E_L_E_T_=' '"
		    If lSimplesN .And. lSimpFis
		    	cWhere  += " AND D1_NFORI NOT IN (SELECT D2_DOC FROM " +RetSqlName("SD2")+  " INNER JOIN "+ RetSqlName("SF4") + " ON F4_CODIGO = D2_TES WHERE D2_DOC = D1_NFORI AND D2_SERIE = D1_SERIORI AND F4_DUPLIC = 'N' )"
		    EndIf
		    cGroupBy := " GROUP BY SD1.D1_CF, SF4.F4_CODIGO, SF4.F4_INCSOL, SF4.F4_SITTRIB, SF1.F1_DTDIGIT"
		    If cPaisLoc == "BRA"
		    	cGroupBy +=" , SB1.B1_FUSTF "
		    EndIf
		    If (SF4->(FieldPos("F4_TPRSPL"))>0)
		    		cGroupBy	+= ", SF4.F4_TPRSPL "
		    EndIf
    	    cOrderBy :=	" ORDER BY 1%"

	 	   	cAliasSF1 := "CALCRBF1"
			BeginSql Alias cAliasSF1
				COLUMN F1_DTDIGIT AS DATE

				SELECT
					%Exp:cSelect%

				FROM
					%Exp:cFrom%

				WHERE
					%Exp:cWhere+cGroupBy+cOrderBy%

			EndSql

			dbSelectArea(cAliasSF1)

		EndIf

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProcessa Notas Fiscais de Saida - Devolvidas      ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		(cAliasSF1)->(DbGoTop ())
		While (cAliasSF1)->(!Eof())
			nValBrut := 0
			If (lTeleCom .And. !Empty(cFilTele)) .Or. lSimplesN
				nValBrut	:= 0
			Else
				nValBrut 	:= (cAliasSF1)->NTOTAL
			Endif

	   		nDedTelCom 	:= 0
	   		nValST		:= 0
	   		nValICMS    := 0
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณReceita Bruta referente ao ICMS ST ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		   	If (cAliasSF1)->NICMSRET > 0 .Or. lTeleCom .Or. lSimplesN

				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณPara o calculo da receita bruta de comunicacao e telecomunicacao e necessario ณ
				//ณverificar se o CFOP do documento fiscal deve ser processado, visto que apenas ณ
				//ณmovimentos deste tipo devem ser considerados para o calculo.                  ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

				If lTeleCom .And. !Empty(cFilTele)
			    	//alem do CFOP tenho que verificar no cadastro de produto se ira calcular FUST/FUNTTEL

			    	If cPaisLoc == "BRA"
			    		cFust := (cAliasSF1)->B1_FUSTF
				    EndIf
				    If !(Alltrim((cAliasSF1)->D1_CF) $ cFilTele) .Or. cFust=="2"
					   	(cAliasSF1)->(dbSkip())
					   	Loop
				    Endif
				    nValBrut 	:= (cAliasSF1)->NTOTAL
				Endif

				If lTeleCom
					nValICMS	:= (cAliasSF1)->NVALICM
				Endif

	            If lSimplesN
			  		If (cAliasSF1)->NICMSRET > 0 //ICMS-ST nใo ้ uma receita

	   			    	If !(cAliasSF1)->F4_INCSOL$"A,N,D"
	   			    		If ALLTRIM((cAliasSF1)->F4_SITTRIB)$"10/30/60/70"
	   			    					nValST		:= ((cAliasSF1)->NVALCONT - (cAliasSF1)->NICMSRET)
				   			EndIf
				    		nValBrut 	:= ((cAliasSF1)->NVALCONT - (cAliasSF1)->NICMSRET)
				    	Else
				    		If ALLTRIM((cAliasSF1)->F4_SITTRIB)$"10/30/60/70"
				    			nValST		:= (cAliasSF1)->NVALCONT
				    		EndIf
				    		nValBrut 	:= (cAliasSF1)->NVALCONT
				    	EndIf
			    	Else
		    			If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
			    			nValST		:= ((cAliasSF1)->NVALCONT - (cAliasSF1)->NICMSRET)
			   			EndIf
			    		nValBrut 	:= (cAliasSF1)->NVALCONT//(cAliasSF1)->NTOTAL
			    	EndIf
			    EndIf

		   		If (cAliasSF1)->NICMSRET > 0
			   		aTotMes[Month((cAliasSF1)->F1_DTDIGIT)][2] -= (cAliasSF1)->NVALCONT
			   	Endif
				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณO valor do PIS e da Cofins sera deduzido da receita bruta de telecomunicacoesณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			   	If lTeleCom
				   	nDedTelCom += (cAliasSF1)->NVALPIS
				   	nDedTelCom += (cAliasSF1)->NVALCOF
				Endif

		   	Endif

		   	aTotMes[Month((cAliasSF1)->F1_DTDIGIT)][1] -= nValBrut
		    If lMensal
		    	If (cAliasSF1)->F1_DTDIGIT >= dDataIni .And. (cAliasSF1)->F1_DTDIGIT <= dDataFim
					nTotalRB 	-= nValBrut   	// Mensal
					nRBST		-= nValST
				Endif
			Else
				nTotalRB 	-= nValBrut		// Acumulado
				nRBST		-= nValST
			Endif

			If (cAliasSF1)->F1_DTDIGIT >= dDataIni
				nRBMensal -= nValBrut
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณQuando for o processamento da receita bruta para telecomunicacoesณ
			//ณ(para calculo do FUST e FUNTTEL) e necessario deduzir o valor do ณ
			//ณICMS, do PIS e da Cofins.                                        ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If lTeleCom
				nDedTelCom 	+= nValICMS
				nTotalRB	:= nTotalRB + nDedTelCom
			Endif

		    (cAliasSF1)->(dbSkip())
		Enddo

		(cAliasSF1)->(DbCloseArea())

	#ELSE

		/*---DBF---*/

		cTabAux := "TRSF2"
		dbSelectArea("SF2")
		dbSetOrder(1)
		FsQuery(aArq,1,cTop,cDbf,SF2->(IndexKey()))
		dbGoTop()

		While TRSF2->(!Eof())

		   	nDedTelCom 	:= 0
		   	nValBrut	:= 0
		   	nValIss		:= 0
		   	nVlRetIss	:= 0
		   	nValICMS	:= 0
		   	nValST		:= 0
		   	nValLoc		:= 0

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณReceita Bruta ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	   		SD2->(dbSetOrder(3))
	   		If !SD2->(dbSeek(xFilial("SD2")+TRSF2->F2_DOC+TRSF2->F2_SERIE+TRSF2->F2_CLIENTE+TRSF2->F2_LOJA))
	   			TRSF2->(dbSkip())
	   			Loop
	   		Endif
	   		nItem := 0

	   		Do While ! SD2->(Eof()) .And. ;
		   		xFilial("SD2")+TRSF2->F2_DOC+TRSF2->F2_SERIE+TRSF2->F2_CLIENTE+TRSF2->F2_LOJA == ;
		   		SD2->D2_FILIAL+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA

		   		// Posiciono TES
		   		SF4->(dbSeek(xFilial("SF4")+SD2->D2_TES))

		   		//Posiciono Item do Livro Fiscal
		   		SFT->(MsSeek(xFilial("SFT")+"S"+SD2->D2_SERIE+SD2->D2_DOC+SD2->D2_CLIENTE+SD2->D2_LOJA+SD2->D2_ITEM+SD2->D2_COD))

				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณPara o calculo da receita bruta de comunicacao e telecomunicacao e necessario ณ
				//ณverificar se o CFOP do documento fiscal deve ser processado, visto que apenas ณ
				//ณmovimentos deste tipo devem ser considerados para o calculo.                  ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				If lTeleCom .And. !Empty(cFilTele)
			    	//alem do CFOP tenho que verificar no cadastro de produto se ira calcular FUST/FUNTTEL
			    	SB1->(dbSetOrder(1))
			    	SB1->(dbSeek(xFilial("SB1")+SD2->D2_COD))
			    	If cPaisLoc == "BRA"
			    		cFust := SB1->B1_FUSTF
					EndIf
				    If !(Alltrim(SD2->D2_CF) $ cFilTele) .Or. cFust=="2"
					   	SD2->(dbSkip())
					   	nItem++
					   	Loop
				    Endif
				    nValBrut 	+= SD2->D2_VALBRUT

				    //Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
			    	If cPaisLoc == "BRA" .And. SFT->FT_RECISS == "1"
				    	nVlRetIss	+=	SD2->D2_BASEISS
				    Else
				    	nValIss		+=	SD2->D2_BASEISS
				    Endif

				Else
				  //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				  //|Se for gerada pelo Faturamento verifico se gera duplicataณ
				  //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				  If lSimpFis//MV_SIMPFIS
				    If SF4->F4_DUPLIC=="S"
				    	If lSimplesN //Simples Nacional
							If !SF4->F4_CODIGO $ cTesAtvMob
						     	//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
						    	If cPaisLoc == "BRA" .And. SFT->FT_RECISS == "1"
							    	nVlRetIss	+=	SD2->D2_BASEISS
							    Else
							    	nValIss		+=	SD2->D2_BASEISS
							    Endif
						    	If SD2->D2_ICMSRET > 0 //ICMS-ST nใo ้ uma receita
				   			    	If !SF4->F4_INCSOL$"A,N,D"
				   			    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
							    			nValST		+= (SD2->D2_VALBRUT - SD2->D2_ICMSRET)
							    		EndIf
							    		nValBrut 	+= (SD2->D2_VALBRUT - SD2->D2_ICMSRET)
							    	Else
				   			    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
							    			nValST		+= SD2->D2_VALBRUT
							    		EndIf
							    		nValBrut 	+= SD2->D2_VALBRUT
							    	EndIf
						    	Else
								    	If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
							    			nValST		+= SD2->D2_VALBRUT
								    	EndIf
								    	If SD2->D2_GRUPO $ cLocacao
					    					 nValLoc 	+= SD2->D2_VALBRUT
					       				Endif
						    		nValBrut 	+= SD2->D2_VALBRUT
						    	EndIf
						 	EndIf
						 Else
							 If SD2->D2_GRUPO $ cLocacao
					    		 nValLoc 	+= SD2->D2_VALBRUT
					    	Endif
					    	nValBrut 	+= SD2->D2_VALBRUT
					    	//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
					    	If cPaisLoc == "BRA" .And. SFT->FT_RECISS == "1"
						    	nVlRetIss	+=	SD2->D2_BASEISS
						    Else
						    	nValIss		+=	SD2->D2_BASEISS
						    Endif
					    EndIf
				    EndIf
				  Else
				  	If lSimplesN
				  		If !SF4->F4_CODIGO $ cTesAtvMob
					  		//Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
					    	If cPaisLoc == "BRA" .And. SFT->FT_RECISS == "1"
						    	nVlRetIss	+=	SD2->D2_BASEISS
						    Else
						    	nValIss		+=	SD2->D2_BASEISS
						    Endif
					  		If SD2->D2_ICMSRET > 0 //ICMS-ST nใo ้ uma receita
			   			    	If !SF4->F4_INCSOL$"A,N,D"
			   			    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
						    			nValST		+= (SD2->D2_VALBRUT - SD2->D2_ICMSRET)
						    		EndIf
						    		nValBrut 	+= (SD2->D2_VALBRUT - SD2->D2_ICMSRET)
						    	Else
						    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
						    			nValST		+= SD2->D2_VALBRUT
						    		EndIf
						    		nValBrut 	+= SD2->D2_VALBRUT
						    	EndIf
					    	Else
					    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
						    		nValST		+= SD2->D2_VALBRUT
					    		EndIf
					    		If SD2->D2_GRUPO $ cLocacao
						    		 nValLoc 	+= SD2->D2_VALBRUT
						    	Endif
					    		nValBrut 	+= SD2->D2_VALBRUT
					    	EndIf
					    EndIf
				    Else
				    	If SD2->D2_GRUPO $ cLocacao
				    		 nValLoc 	+= SD2->D2_VALBRUT
				    	Endif
				    	nValBrut 	+= SD2->D2_VALBRUT
					    //Verifico se o valor de ISS foi Retido pelo Cliente, pois o valor nao deve ser apurado
				    	If cPaisLoc == "BRA" .And. SFT->FT_RECISS == "1"
					    	nVlRetIss	+=	SD2->D2_BASEISS
					    Else
					    	nValIss		+=	SD2->D2_BASEISS
					    Endif
				    EndIf
				  EndIf
	            EndIf

				If lTeleCom
					nValICMS	+= SD2->D2_VALICM
				Endif

				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณReceita Bruta referente ao ICMS ST ณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	            If nItem == 0
					MaFisEnd()
					MaFisIniNf(2, 0,, "TRSF2", .F.)
					nItem++
				Endif
		   		If SD2->D2_ICMSRET > 0
			   		aTotMes[Month(TRSF2->F2_EMISSAO)][2] += MaFisRet(nItem,"LF_VALCONT")
			   	Endif

				//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
				//ณO valor do PIS e da Cofins sera deduzido da receita bruta de telecomunicacoesณ
				//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			   	If lTeleCom
			   		If Type("aNfItem") == "U"
			   			MaFisIniNf(2, 0,, "TRSF2", .F.)
			   		EndIf
				   	nDedTelCom += MaFisRet(nItem,"IT_VALPS2")
				   	nDedTelCom += MaFisRet(nItem,"IT_VALCF2")
				Endif

			   	SD2->(dbSkip())
			   	nItem++
			Enddo

			aTotMes[Month(TRSF2->F2_EMISSAO)][1] +=  nValBrut

		    If lMensal
		    	If TRSF2->F2_EMISSAO >= dDataIni .And. TRSF2->F2_EMISSAO <= dDataFim
					nTotalRB 	+= nValBrut   			// Mensal
					nRBServ 	+= nValIss   			// Mensal Servico
					nRBServRet	+= nVlRetIss			// Mensal Servico Retido
					nRBST		+= nValST				// Mensal ST
					nRBLoc		+= nValLoc				// Mensal Locacao
				Endif
			Else
				nTotalRB 		+= nValBrut  			// Acumulado
				nRBServ 		+= nValIss  			// Acumulado Servico
				nRBServRet		+= nVlRetIss			// Acumulado Servico Retido
				nRBST			+= nValST				// Acumulado ST
				nRBLoc			+= nValLoc				// Acumulado Locacao
			Endif

			If TRSF2->F2_EMISSAO >= dDataIni
				nRBMensal += nValBrut
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณQuando for o processamento da receita bruta para telecomunicacoesณ
			//ณ(para calculo do FUST e FUNTTEL) e necessario deduzir o valor do ณ
			//ณICMS, do PIS e da Cofins.                                        ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If lTeleCom
				nDedTelCom 	+= nValICMS
				nTotalRB	:= nTotalRB - nDedTelCom
			Endif

			TRSF2->(dbSkip())
		Enddo

		FsQuery(aArq,2)

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProcessa Notas Fiscais de Saida - Devolvidas      ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		dbSelectArea("SF1")
		dbSetOrder(1)
		FsQuery(aArqF1,1,cTopF1,cDbfF1,SF1->(IndexKey()))
		dbGoTop()
		While SF1->(!Eof())

			If (lTeleCom .And. !Empty(cFilTele)) .Or. lSimplesN
				nValBrut	:= 0
			Else
				nValBrut 	:= SF1->F1_VALBRUT
			Endif

		   	nDedTelCom 	:= 0
	   		nValST		:= 0
	   		nValICMS    := 0
			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณReceita Bruta referente ao ICMS ST ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		   	If SF1->F1_ICMSRET > 0 .Or. lTeleCom .Or. lSimplesN

		   		SD1->(dbSetOrder(1))
		   		If !SD1->(dbSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA))
		   			SF1->(dbSkip())
		   			Loop
		   		Endif

		   		//Caso a Tes de Sainda no Gere Duplicata nao deve constar abater do movimento.
		   		If lSimplesN .And. lSimpFis
		   			SD2->(DbSetOrder(3))
	        		If SD2->(DbSeek(SD1->D1_FILIAL +SD1->D1_NFORI + SD1->D1_SERIORI + SD1->D1_FORNECE+ SD1->D1_LOJA+ SD1->D1_COD))
	        			cTesDup := Posicione("SF4",1,xFilial("SF4")+ SD2->D2_TES ,"F4_DUPLIC")
	        			If cTesDup == "N"
	        				SF1->(dbSkip())
		   					Loop
	        			EndIf
	        		EndIf
		   		EndIf

		   		nItem := 0

		   		Do While ! SD1->(Eof()) .And. ;
			   		xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA	== ;
			   		SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA

					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณPara o calculo da receita bruta de comunicacao e telecomunicacao e necessario ณ
					//ณverificar se o CFOP do documento fiscal deve ser processado, visto que apenas ณ
					//ณmovimentos deste tipo devem ser considerados para o calculo.                  ณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
					If lTeleCom .And. !Empty(cFilTele)
				    	//alem do CFOP tenho que verificar no cadastro de produto se ira calcular FUST/FUNTTEL
			    		SB1->(dbSetOrder(1))
				    	SB1->(dbSeek(xFilial("SB1")+SD1->D1_COD))
				    	If cPaisLOc == "BRA"
				    		cFust := SB1->B1_FUSTF
						EndIf
					    If !(Alltrim(SD1->D1_CF) $ cFilTele) .Or. cFust=="2"
						   	SD1->(dbSkip())
						   	nItem++
						   	Loop
					    Endif
					    nValBrut 	+= SD1->D1_TOTAL
					Endif

					If lTeleCom
						nValICMS	+= SD1->D1_VALICM
					Endif

		            If nItem == 0
						MaFisEnd()
						MaFisIniNf(1, 0,, "SF1", .F.)
						nItem++
					Endif
		            //
		            If lSimplesN
				  		If SD1->D1_ICMSRET > 0 //ICMS-ST nใo ้ uma receita
				  			// Posiciono TES
		   					SF4->(dbSeek(xFilial("SF4")+SD1->D1_TES))

		   			    	If !SF4->F4_INCSOL$"A,N,D"
		   			    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
					    			nValST		+= (SD1->D1_TOTAL - SD1->D1_ICMSRET)
					   			EndIf
					    		nValBrut 	+= (SD1->D1_TOTAL - SD1->D1_ICMSRET)
					    	Else
					    		If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
					    			nValST		+= SD1->D1_TOTAL
					    		EndIf
					    		nValBrut 	+= SD1->D1_TOTAL
					    	EndIf
				    	Else
			    			If ALLTRIM(SF4->F4_SITTRIB)$"10/30/60/70"
				    			nValST		+= (SD1->D1_TOTAL - SD1->D1_ICMSRET)
				   			EndIf
				    		nValBrut 	+= SD1->D1_TOTAL
				    	EndIf
				    EndIf



			   		If SD1->D1_ICMSRET > 0
				   		aTotMes[Month(SF1->F1_DTDIGIT)][2] -= MaFisRet(nItem,"LF_VALCONT")
				   	Endif
					//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
					//ณO valor do PIS e da Cofins sera deduzido da receita bruta de telecomunicacoesณ
					//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
				   	If lTeleCom
				   		If Type("aNfItem") == "U"
				   			MaFisIniNf(2, 0,, "SF2", .F.)
				   		EndIf
					   	nDedTelCom += MaFisRet(nItem,"IT_VALPS2")
					   	nDedTelCom += MaFisRet(nItem,"IT_VALCF2")
					Endif
				   	SD1->(dbSkip())
				   	nItem ++
				Enddo
		   	Endif

		   	aTotMes[Month(SF1->F1_DTDIGIT)][1] -= nValBrut
		    If lMensal
		    	If SF1->F1_DTDIGIT >= dDataIni .And. SF1->F1_DTDIGIT <= dDataFim
					nTotalRB 	-= nValBrut   	// Mensal
					nRBST		-= nValST
				Endif
			Else
				nTotalRB 	-= nValBrut		// Acumulado
				nRBST		-= nValST
			Endif

			If SF1->F1_DTDIGIT >= dDataIni
				nRBMensal -= nValBrut
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณQuando for o processamento da receita bruta para telecomunicacoesณ
			//ณ(para calculo do FUST e FUNTTEL) e necessario deduzir o valor do ณ
			//ณICMS, do PIS e da Cofins.                                        ณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If lTeleCom
				nDedTelCom 	+= nValICMS
				nTotalRB	:= nTotalRB + nDedTelCom
			Endif

		    SF1->(dbSkip())
		Enddo

		FsQuery(aArqF1,2)

	#ENDIF

	SM0->(dbSkip())

Enddo

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณMais devolucoes que faturamentosณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If nTotalRB < 0
	nTotalRB := 0
Endif
If nRBMensal < 0
	nRBMensal := 0
Endif
If nRBServ < 0
	nRBServ := 0
Endif
If nRBServRet < 0
	nRBServRet := 0
Endif
If nRBST < 0
	nRBST := 0
Endif
If nRBLoc < 0
	nRBLoc := 0
Endif

For nX := 1 to Len(aTotMes)
	If aTotMes[nX][1] < 0
		aTotMes[nX][1] := 0
	Endif
	If aTotMes[nX][2] < 0
		aTotMes[nX][2] := 0
	Endif
Next
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณRestaura a integridade da rotina                                        ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤณ
RestArea(aAreaSm0)
cFilAnt	:=	FWCodFil()
Return(nTotalRB)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณCalcIcms   ณ Autor ณRodrigo Zatt           ณ Data ณ 09.05.08 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณCalcula o Total Acumulado da Receita Bruta e Receita Bruta   ณฑฑ
ฑฑณ          ณsujeita a Icms  no periodo - Simples                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpD1: Data Inicial                                          ณฑฑ
ฑฑณ          ณExpD2: Data Final                                            ณฑฑ
ฑฑณ          ณExpN3: Calculo da Receita Bruta do Periodo - Simples         ณฑฑ
ฑฑณ          ณExpL4: Calculo da Receita Bruta Sujeita a Icms do Periodo -  ณฑฑ
ฑฑณ          ณ       Simples                                               ณฑฑ
ฑฑณ          ณExpC5: Array com o total mensal da receita Bruta total do    ณฑฑ
ฑฑณ          ณ       mes - Simples e receita sujeita a Icms do mes -Simplesณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CalcIcms(dDataIni,dDataFim,nValBrutoS,nSujIcmsS,cSimples)

Local aAreaAnt  := GetArea()
Local cAliasSD2 := "SD2"
Local nVez      := 1
Local nMesFim   := Month(dDataFim)
Local lQuery    := .F.
Local aTotalMes := {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0}}

#IFDEF TOP
	Local aStruSD2  := {}
	Local cQuery    := ""
	Local nX        := 0
#ELSE
	Local cIndex    := ""
	Local cCondicao := ""
#ENDIF
Default nValBrutoS  := 0
Default nSujIcmsS   := 0
Default cSimples    := ""

dbSelectArea(cAliasSD2)
dbSetOrder(1)
ProcRegua(LastRec())
#IFDEF TOP
	If TcSrvType()<>"AS/400"
		cAliasSD2:= "SD2Query"
		aStruSD2 := SD2->(dbStruct())
		lQuery := .T.
		cQuery := "SELECT SD2.D2_VALBRUT, SD2.D2_VALICM, SD2.D2_VALISS, SD2.D2_EMISSAO "
		cQuery += "FROM " + RetSqlName("SD2") + " SD2 "
		cQuery += "WHERE SD2.D2_FILIAL = '" + xFilial("SD2") + "' AND "
		cQuery += "SD2.D2_EMISSAO >= '" + DtoS(dDataIni) + "' AND "
		cQuery += "SD2.D2_EMISSAO <= '" + Dtos(dDataFim) + "' AND "
		cQuery += "SD2.D2_TIPO IN('N','C','P') AND "
		cQuery += "SD2.D_E_L_E_T_ = ' ' "
		cQuery += "ORDER BY SD2.D2_EMISSAO "
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2)
		For nX := 1 To len(aStruSD2)
			If aStruSD2[nX][2] <> "C" .And. FieldPos(aStruSD2[nX][1])<>0
				TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
			EndIf
		Next nX
		dbSelectArea(cAliasSD2)
	Else
#ENDIF
	cIndex    := CriaTrab(NIL,.F.)
	cCondicao := 'D2_FILIAL == "' + xFilial("SD2") + '" '
	cCondicao += '.And. DTOS(D2_EMISSAO) >= "' + DTOS(dDataIni) + '" .And. DTOS(D2_EMISSAO) <= "' + DTOS(dDataFim) + '" '
	cCondicao += '.And. D2_TIPO $ "NCP"'
	IndRegua(cAliasSD2,cIndex,SD2->(IndexKey()),,cCondicao)
	dbSelectArea(cAliasSD2)
	ProcRegua(LastRec())
	dbGoTop()
#IFDEF TOP
	Endif
#ENDIF
While !(cAliasSD2)->(Eof())
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณTotalizador de Simples Bruto e sujeito a Icms no Periodo.               ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If (cAliasSD2)->D2_VALBRUT > 0
		nValBrutoS +=(cAliasSD2)->D2_VALBRUT
		If (cAliasSD2)->D2_VALICM > 0  .And. (cAliasSD2)->D2_VALISS = 0
			nSujIcmsS += (cAliasSD2)->D2_VALBRUT
		Endif
	Endif
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณTotalizador do Simples Bruto e sujeito a Icms no Periodo por Mes.       ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If (cAliasSD2)->D2_EMISSAO >= dDataIni .And. (cAliasSD2)->D2_EMISSAO <= dDataFim
		If D2_VALBRUT > 0
			aTotalMes[Month((cAliasSD2)->D2_EMISSAO)][1] +=(cAliasSD2)->D2_VALBRUT
			If (cAliasSD2)->D2_VALICM > 0  .And. (cAliasSD2)->D2_VALISS = 0
				aTotalMes[Month((cAliasSD2)->D2_EMISSAO)][2] +=(cAliasSD2)->D2_VALBRUT
			EndIf
		EndIf
	EndIf
	(cAliasSD2)->(dbSkip())
EndDo
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณFuncao para retornar arry conforme lay out. ex.: Mes|Valor bruto Simples|Valor bruto sujeito a Icms ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	Do While nVez <= 12
		cSimples := cSimples + StrZero(nMesFim,2) + StrTran(StrZero(aTotalMes[nMesFim][1],17,2),".","") + StrTran(StrZero(aTotalMes[nMesFim][2],17,2),".","")
		nMesFim := nMesFim - 1
	If nMesFim == 0
		nMesFim := 12
	Endif
		nVez ++
	End
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Exclui as areas de trabalho                                  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If lQuery
	dbSelectArea(cAliasSD2)
	dbCloseArea()
Else
	dbSelectArea(cAliasSD2)
	RetIndex(cAliasSD2)
	dbClearFilter()
	Ferase(cIndex+OrdBagExt())
EndIf

RestArea(aAreaAnt)
Return (nSujIcmsS)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหอออออออัอออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณManadResultบAutor  ณBruno Sobieski     บ Data ณ  01/09/06   บฑฑ
ฑฑฬออออออออออุอออออออออออสอออออออฯอออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณFuncao para utilizar no MANAD, que gera um arquivo as contasบฑฑ
ฑฑบ          ณde resultados informadas no Wizard.                         บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ MANAD                                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ManadResult(cContas,cData,lAlimenta,cFilIni,cFilFim)

Local nAt        	:= At(";",cContas)
Local cConta     	:= cContas
Local cContasAnt
Local nSaldo     	:= 0

Local nTamConta   	:= Iif ("CTB" $ GETMV("MV_MCONTAB"),TamSX3('CT1_CONTA')[1],TamSX3('I1_CODIGO')[1])
Local aCampos		:= {}
Local aAreaSM0		:= SM0->(GetArea ())

Local lCtbInUse		:= CtbInUse()
Local lSI1Shared
Local cFilSI1

DEFAULT lAlimenta	:= .T.	//	.T. alimenta o arquivo M01; .F. apenas cria-o
DEFAULT cFilIni		:= Space(02)
DEFAULT cFilFim		:= Space(02)

If Empty (cFilIni) .And. Empty (cFilFim)
	cFilIni	:=	cFilAnt
	cFilFim	:=	cFilAnt
EndIf

AADD(aCampos,{"CONTA"      , "C", nTamConta, 0})
AADD(aCampos,{"RECCONTA"   , "N", 12       , 0})
AADD(aCampos,{"SALDO"      , "N", 17       , 2})

cArqTMP  :=	CriaTrab(aCampos)
If Select("M01") > 0
	dbSelectArea("M01")
	dbCloseArea()
EndIf

dbUseArea(.T.,__LocalDriver,cArqTMP,"M01",.T.,.F.)
IndRegua("M01",cArqTMP,"CONTA")
DbSelectArea("M01")
DbClearIndex()
DbSetIndex(cArqTMP+OrdBagExt())

lSI1Shared := !lCtbInUse .And. Empty( SI1->( xFilial("SI1") ) )

If lAlimenta .And. !Empty( cContas )
	If Substr(Alltrim(cContas),Len(Alltrim(cContas)),1) <> ";"
		cContas	:=	Alltrim(cContas)+";"
	Endif
	cConta     := cContas
	cContasAnt := cContas


	// Executando para todas as Filiais, substituindo assim o CONSOLIDADO do Manad.ini
	DbSelectArea("SM0")
	SM0->(DbSeek (cEmpAnt+cFilIni, .T.))

	Do While !SM0->(Eof()) .And. (FWGrpCompany() + FWCodFil()) <= (cEmpAnt + cFilFim)

		cContas := cContasAnt

		While !Empty(cContas)
			nAt:= At(";",cContas)
			cConta	:=	Substr(cContas,1,nAt-1)
			cContas	:=	Substr(cContas,nAt+1)
			If ".." $ cConta
				cContaIni	:=	Padr(Substr(cConta,1,At("..",cConta)-1),nTamConta)
				cContaFim	:=	Padr(Substr(cConta,At("..",cConta)+2),nTamConta)
			Else
				cContaIni	:=	cConta
				cContaFim	:=	cConta
			Endif
			If lCtbInUse
				DbSelectArea('CT1')
				DbSetOrder(1)
				DbSeek(xFilial('CT1')+cContaIni,.T.)
				While !Eof() .And. CT1_FILIAl+CT1_CONTA <= xFilial('CT1')+cContaFim
					If CT1->CT1_CLASSE == '2'
						nSaldo := SaldoCT7( CT1->CT1_CONTA,STOD(cData,2),"01","1",,.T.,STOD(cData,2),If(FWModeAccess("CT7",3)=="C",NIL,FWCodFil()) )[1]
						If !(M01->(DbSeek(CT1->CT1_CONTA)))
							RecLock('M01',.T.)
							M01->CONTA := CT1->CT1_CONTA
							M01->SALDO := nSaldo
						Else
							RecLock('M01',.F.)
							M01->SALDO += nSaldo
						EndIf
						MsUnLock()
					Endif
					DbSelectArea('CT1')
					DbSkip()
				Enddo
			Else
				If lSI1Shared
					cFilSI1	:= xFilial("SI1")
				Else
					cFilSI1	:= FWCodFil()
				EndIf
				DbSelectArea('SI1')
				DbSetOrder(1)
				DbSeek(cFilSI1+cContaIni,.T.)
				While !Eof() .And. I1_FILIAl+I1_CODIGO <= cFilSI1+cContaFim
					If SI1->I1_CLASSE == 'A'
						nSaldo := CalcSaldo( Month( STOD(cData) ) )
						If !(M01->(DbSeek(SI1->I1_CODIGO)))
							RecLock('M01',.T.)
							M01->CONTA    := SI1->I1_CODIGO
							M01->SALDO    := nSaldo
						Else
							RecLock('M01',.F.)
							M01->SALDO += nSaldo
						EndIf
						MsUnLock()
					Endif
					DbSelectArea('SI1')
					DbSkip()
				Enddo
			Endif
		Enddo

		If lCtbInUse .Or. !lSI1Shared	//	Se for CTB ou o SI1 for exclusivo
			SM0->( DbSkip() )
		Else
			Exit
		EndIf

	EndDo

	RestArea(aAreaSM0)

EndIf

Return

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณRetExpImp ณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 17.11.06 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณRetorna os Dados de Exportacao e Importacao.                ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray de Exportacao:                                        ณฑฑ
ฑฑณ          ณArray[1] - RE - Numero do Registro de Exportacao            ณฑฑ
ฑฑณ          ณArray[2] - DDE - Numero do Despacho de Exportacao           ณฑฑ
ฑฑณ          รฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณArray de Importacao:                                        ณฑฑ
ฑฑณ          ณArray[1] - DI - Numero da Declaracao de Importacao          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณcTipo - E-Exportacao ou I-Importacao                        ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณNORMA086 - Arquivo 4.4.1 - Exportacao e 4.4.2 - Importacao  ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function RetExpImp(cTipo,lNor08655)

Local aArea	:= GetArea()
Local aRet	:= {0,0}
Local lExp	:= GetNewPar("MV_EECFAT",.F.)			//Integracao com SIGAECC - EXPORTACAO
Local lImp	:= (GetNewPar("MV_EASY",.F.)=="S")		//Integracao com SIGAEIC - IMPORTACAO
Default lNor08655 := .F.

If cTipo == "E"		//Exportacao
	If lExp
	    dbSelectArea("SD2")
	    dbSetOrder(3)
	    If dbSeek(xFilial("SD2")+SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA)
	    	While !Eof() .And. ;
	    		SD2->D2_FILIAL+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA==xFilial("SD2")+SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA
	    		If !Empty(SD2->D2_PREEMB)
					dbSelectArea("EEX")		//Capa da DDE
					dbSetOrder(1)
					If dbSeek(xFilial("EEX")+SD2->D2_PREEMB)
						aRet[2] := Val(Left(Alltrim(EEX->EEX_NUM),12))			//DDE-Numero do Despacho de Exportacao
					Endif

					dbSelectArea("EE9")
					dbSetOrder(3)
					If dbSeek(xFilial("EE9")+SD2->D2_PREEMB)
						While !Eof() .And. EE9_FILIAL+EE9_NF+EE9_SERIE == xFilial("EE9")+SD2->D2_DOC+SD2->D2_SERIE
							If SD2->D2_PEDIDO == Posicione("EE7",1,xFilial("EE7")+EE9->EE9_PEDIDO,"EE7_PEDFAT") .And. ;
								SD2->D2_ITEMPV == Posicione("EE8",1,xFilial("EE8")+EE9->EE9_PEDIDO+EE9->EE9_SEQUEN,"EE8_FATIT")
								aRet[1] := Val(Left(Alltrim(EE9->EE9_RE),11)) 	//RE-Numero do Registro de Exportacao
								Exit
			                Endif
							dbSelectArea("EE9")
							dbSkip()
						Enddo
					Endif
					If !Empty(aRet[1]) .Or. !Empty(aRet[2])
						Exit
					Endif
				Endif
				dbSelectArea("SD2")
				dbSkip()
			Enddo
		Endif
	Endif
Else
	If lImp
		If lNor08655
			If !Empty(SF1->F1_HAWB)
				dbSelectArea("SW6")
				dbSetOrder(1)
				If dbSeek(xFilial("SW6")+SF1->F1_HAWB)
					aRet[1] := Val(Left(Alltrim(SW6->W6_DI_NUM),10))					//DI-Numero da Declaracao de Importacao
				Endif
			EndIf
		Else
			dbSelectArea("SF1")
			SF1->(dbSetOrder(1))
			If dbSeek(xFilial("SF1")+SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA)
				dbSelectArea("SW6")
				dbSetOrder(1)
				If dbSeek(xFilial("SW6")+SF1->F1_HAWB)
					aRet[1] := Val(Left(Alltrim(SW6->W6_DI_NUM),10))					//DI-Numero da Declaracao de Importacao
				Endif
			Endif
		EndIf
	Else
		If lNor08655
			If !Empty(SF1->F1_HAWB)
				aRet[1] := Val(SF1->F1_HAWB)
			Else
				DbSelectArea("SD1")
				SD1->(DbSetOrder(1))
				If cPaisLoc == "BRA" .And. SD1->(DbSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA))
				    DbSelectArea("CD5")
					CD5->(DbSetOrder(4))
					If CD5->(DbSeek(xFilial("CD5")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_ITEM))
					aRet[1] := Val(CD5->CD5_NDI)
				EndIf
			EndIf
		EndIf
		EndIf
	Endif
Endif

RestArea(aArea)

Return(aRet)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณUpdSX6    ณ Autor ณ Sergio S. Fuzinaka    ณ Data ณ 09.04.07 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao ณAltera o conteudo do Parametro (SX6).                       ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณNenhum                                                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณExpC1 : Parametro                                           ณฑฑ
ฑฑณ          ณExpC2 : Filial                                              ณฑฑ
ฑฑณ          ณExpC3 : Conteudo em Portugues                               ณฑฑ
ฑฑณ          ณExpC4 : Conteudo em Espanhol                                ณฑฑ
ฑฑณ          ณExpC5 : Conteudo em Ingles                                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณGenerico                                                    ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function UpdSx6(cPar,cConteud,cContSpa,cContEng)

Local aArea			:= GetArea()
Local aAreaSX6		:= SX6->(GetArea())

Default cConteud	:= ""
Default cContSpa	:= ""
Default cContEng	:= ""

If FWSX6Util():ExistsParam( cPar )
	PutMV( cPar, cConteud)
Endif

RestArea(aArea)
RestArea(aAreaSX6)

Return Nil

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณMANAD     บAutor  ณAndreia dos Santos  บ Data ณ  13/04/07   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ                                                            บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function ChecaSRV()

Local lRet := .F.
#IFNDEF TOP
	SRV->(MsSeek (xFilial ("SRV")+SRD->RD_PD))
	If SRV->RV_TIPOCOD # "3"
		lRet := .T.
	Else
		lRet := .F.
	EndIf
#ELSE
	lRet := .T.
#ENDIF
Return( lRet  )

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออออออหออออออัออออออออออปฑฑ
ฑฑบFuncao    ณAbreAT7   บAutor  ณEduardo Nunes Cirqueira บ Data ณ 15/08/07 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออออออสออออออฯออออออออออนฑฑ
ฑฑบDesc.     ณ Abre e cria indice para o arquivo temporario (AT7)          บฑฑ
ฑฑบ          ณ referente ao registro I150 do Manad (Saldos das Contas)     บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ Manad                                                       บฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function AbreAT7(cArqTmp)
Local cArqInd := ""

If Select("AT7") > 0
	AT7->( DbCloseArea() )
EndIf
dbUseArea( .T.,, cArqTmp, "AT7", .F., .F. )
															// totalizador do relatorio]
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Cria Indice Temporario do Arquivo de Trabalho 1.             ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
cArqInd	:= CriaTrab(Nil, .F.)

IndRegua("AT7",cArqInd,"CONTA+DTOS(DATASLD)",,,OemToAnsi(STR0001))  //"Selecionando Registros..."

dbSelectArea("AT7")
DbClearIndex()
dbSetIndex(cArqInd+OrdBagExt())

dbSelectArea("AT7")
dbSetOrder(1)

Return Nil

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณMtxGuiaRecบAutor  ณMary C. Hergert     บ Data ณ  09/10/2007 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณFuncao para retornar as guias de recolhimento relacionadas  บฑฑ
ฑฑบ          ณao documento fiscal                                         บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณaGuias: Array contendo as informacoes da guia, sendo:       บฑฑ
ฑฑบ          ณ[01] : Nome do campo da tabela SF6                          บฑฑ
ฑฑบ          ณ[02] : Conteudo do campo                                    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณExpC1 : Tipo de operacao (1=entrada, 2=saida)               บฑฑ
ฑฑบ          ณExpC2 : Numero do documento                                 บฑฑ
ฑฑบ          ณExpC3 : Serie do documento                                  บฑฑ
ฑฑบ          ณExpC4 : Codigo do cliente/fornecedor                        บฑฑ
ฑฑบ          ณExpC5 : Codigo da loja do cliente/fornecedor                บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณSigaFis                                                     บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function MtxGuiaRec(cOper,cDocto,cSerie,cClieFor,cLoja)

Local aGuias	:= {}
Local aCampos	:= {}

Local cAliasSF6	:= "SF6"
Local cCampos	:= ""

Local lQuery	:= .F.

Local nPos		:= 0
Local nX		:= 0

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณVerificando todos os campos disponiveis no SF6ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
dbSelectArea("SX3")
dbSetOrder(1)
SX3->(dbSeek("SF6"))
Do While !SX3->(Eof()) .And. (SX3->X3_ARQUIVO == 'SF6') .And. (SX3->X3_CONTEXT <> 'V')
	aAdd(aCampos,{Alltrim(SX3->X3_CAMPO),""})
	If Empty(cCampos)
		cCampos += Alltrim(SX3->X3_CAMPO)
	Else
		cCampos += ", " + Alltrim(SX3->X3_CAMPO)
	Endif
	SX3->(dbSkip())
Enddo

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณCampos que serao adicionados a query somente se existirem na baseณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If Empty(cCampos)
	cCampos := "%%"
Else
	cCampos := "% " + cCampos + " %"
Endif

#IFDEF TOP

	If TcSrvType()<>"AS/400"

		lQuery    := .T.
		cAliasSF6 := GetNextAlias()

		BeginSql Alias cAliasSF6
			COLUMN F6_DTARREC AS DATE
			COLUMN F6_DTVENC  AS DATE
			SELECT %Exp:cCampos%

			FROM %table:SF6% SF6

			WHERE SF6.F6_FILIAL = %xFilial:SF6% AND
				SF6.F6_OPERNF = %Exp:cOper% AND
				SF6.F6_DOC = %Exp:cDocto% AND
				SF6.F6_SERIE = %Exp:cSerie% AND
				SF6.F6_CLIFOR = %Exp:cClieFor% AND
				SF6.F6_LOJA = %Exp:cLoja% AND
				SF6.%NotDel%

			ORDER BY %Order:SF6%
		EndSql

		dbSelectArea(cAliasSF6)

	Else

#ENDIF
		cArqInd   := CriaTrab(Nil,.F.)
		cChave    := SF6->(IndexKey())
		cCondicao := 'F6_FILIAL == "' + xFilial("SF6") + '" .And. '
		cCondicao += 'F6_OPERNF == "' + cOper + '" .And. '
		cCondicao += 'F6_DOC == "' + cDocto + '" .And. '
		cCondicao += 'F6_SERIE == "' + cSerie + '" .And. '
		cCondicao += 'F6_CLIFOR == "' + cClieFor + '" .And. '
		cCondicao += 'F6_LOJA == "' + cLoja + '"'
		IndRegua(cAliasSF6,cArqInd,cChave,,cCondicao,"Selecionando Registros")
		#IFNDEF TOP
			DbSetIndex(cArqInd+OrdBagExt())
		#ENDIF
		(cAliasSF6)->(dbGotop())
#IFDEF TOP
	Endif
#ENDIF

Do While !((cAliasSF6)->(Eof()))

	aAdd(aGuias,aClone(aCampos))
	nPos := Len(aGuias)

	For nX := 1 to Len(aCampos)
		nCampo := aScan(aGuias[nPos],{|x| x[1] == aCampos[nX][01]})
		aGuias[nPos][nCampo][02] := (cAliasSF6)->(&(aCampos[nX][01]))
	Next

	(cAliasSF6)->(dbSkip())

Enddo

If lQuery
	dbSelectArea(cAliasSF6)
	dbCloseArea()
Else
	RetIndex("SF6")
	dbClearFilter()
	Ferase(cArqInd+OrdBagExt())
Endif

Return aGuias

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณNFWSSINAL ณAutor  ณLiber De Esteban    ณ Data ณ  05/03/08   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDesc.     ณApresenta uma tela para o usuario selecionar os NF's que    ณฑฑ
ฑฑณ          ณirใo compor o lote na geracao do WSSINAL                    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArray com as NF's selecionadas                              ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณ SIGAFIS                                                    ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Function NFWSSINAL()

Local aNFWS := {}
Local oDlgNFWS
Local oLbNotas
Local oBtnAll
Local oBtnInv
Local oOk      := LoadBitmap( GetResources(), "LBOK" )
Local oNo      := LoadBitmap( GetResources(), "LBNO" )

If Type("lAbtMT950")=="U"
	lAbtMT950 := .F.
EndIf

SF2->(dbGoTop())
While !SF2->(EOF())
	AADD(aNFWS,{.F., SF2->F2_DOC, SF2->F2_SERIE, SF2->F2_EMISSAO, SF2->F2_VALBRUT, SF2->F2_PBRUTO })
	SF2->(dbSkip())
EndDo

If len(aNFWS) > 0
	DEFINE MSDIALOG oDlgNFWS TITLE STR0123 FROM 0,0 TO 250,450 PIXEL OF oMainWnd // "Selecione as NF's que Irใo Compor o Lote"

	@ .3,.4 LISTBOX oLbNotas FIELDS HEADER "", RetTitle("F2_DOC"),RetTitle("F2_SERIE"), RetTitle("F2_EMISSAO"), RetTitle("F2_VALBRUT"), RetTitle("F2_PBRUTO");
	COLSIZES 15,35,35,35,50,50;
	SIZE 220,100 OF oDlgNFWS ;
	ON DBLCLICK (MarcaNF(@aNFWS, oLbNotas:nAt), oLbNotas:Refresh())

	oLbNotas:SetArray(aNFWS)
	oLbNotas:bLine   := { || {If(aNFWS[oLbNotas:nAt,1],oOk,oNo), aNFWS[oLbNotas:nAt,2], aNFWS[oLbNotas:nAt,3],aNFWS[oLbNotas:nAt,4],Transform(aNFWS[oLbNotas:nAt,5],PesqPict("SF2","F2_VALBRUT")),Transform(aNFWS[oLbNotas:nAt,6],PesqPict("SF2","F2_PBRUTO")) } }

	@ 109,005	BUTTON oBtnAll PROMPT STR0124 SIZE 40,11 PIXEL ACTION(MarcaTodos(@aNFWS),oLbNotas:Refresh()) // "&Marca Todas"
	@ 109,048	BUTTON oBtnInv PROMPT STR0125 SIZE 45,11 PIXEL ACTION(Inv_Selecao(@aNFWS),oLbNotas:Refresh()) // "&Inverter Sele็ใo"
	DEFINE SBUTTON FROM 109,160  TYPE 1 ACTION oDlgNFWS:End() ENABLE OF oDlgNFWS
	DEFINE SBUTTON FROM 109,190  TYPE 2 ACTION (oDlgNFWS:End(),lAbtMT950 := .T.) ENABLE OF oDlgNFWS

	ACTIVATE DIALOG oDlgNFWS CENTERED
Else
	MsgInfo(STR0126,STR0127) // "Nใo foram encontradas notas para o perํodo informado!"#"Aten็ใo"
	lAbtMT950 := .T.
EndIf

SF2->(dbGoTop())
Return aNFWS


/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณDESCZFSINALณAutor  ณMarcelo Alexandre   ณ Data ณ  06/05/09  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDesc.     ณFuncao para somar os valores do desconto do ICMS da Zona    ณฑฑ
ฑฑณ          ณFranca de Manaus. Informa็ใo Gravada no campo D2_DESCZFR.   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณValor total de desconto da nota fiscal                      ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum													  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso       ณ SIGAFIS                                                    ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Function DESCZFSINAL(cFilF3,cNF,cSerie,cCliFor,cLoja,lLimpa)

Local nValDescZf := 0
Local cChaveNF   := ""
Local cAliasSF3  := "SF3"

Default lLimpa   := .F.

If lLimpa
	nValDescZf := 0
EndIf
(cAliasSF3)->(dbSetOrder(5))
IF (cAliasSF3)->(dbSeek(xFilial(cAliasSF3)+cSerie+cNF+cCliFor+cLoja))
	cChaveNF := cFilF3+cSerie+cNF+cCliFor+cLoja
	While !(cAliasSF3)->(Eof()) .And. cChaveNF==((cAliasSF3)->F3_FILIAL+(cAliasSF3)->F3_SERIE+(cAliasSF3)->F3_NFISCAL+(cAliasSF3)->F3_CLIEFOR+(cAliasSF3)->F3_LOJA)
		nValDescZf += (cAliasSF3)->F3_DESCZFR
		((cAliasSF3))->(DbSkip())
	EndDo
EndIf

Return(nValDescZf)

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณ MarcaNF   บAutor ณLiber De Esteban    บ Data ณ  18/01/08   บฑฑ
ฑฑฬออออออออออุอออออออออออสออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณSelecao de NF no listBOX                                    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Static Function MarcaNF(aNFWS, nLin)
If aNFWS[nLin, 1]
	aNFWS[nLin, 1] := .F.
Else
	aNFWS[nLin, 1] := .T.
Endif
Return Nil

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณMarcaTodos บAutor ณLiber De Esteban    บ Data ณ  18/01/08   บฑฑ
ฑฑฬออออออออออุอออออออออออสออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณMarcar todas as linhas do listbox.                          บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Static Function MarcaTodos(aNFWS)
Local nX	:=	0
for nX:=1 to Len(aNFWS)
	aNFWS[nX][1] := .T.
Next
Return

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณInv_SelecaoบAutor ณLiber De Esteban    บ Data ณ  18/01/08   บฑฑ
ฑฑฬออออออออออุอออออออออออสออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณInverter a selecao das linhas do listbox.                   บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Static Function Inv_Selecao(aNFWS)
Local nX	:=	0
For nX:=1 to Len(aNFWS)
	aNFWS[nX][1] := !aNFWS[nX][1]
Next
Return

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณNFConjugadaบ Autor ณ    Murilo Alves    บ Data ณ  07/02/08   บฑฑ
ฑฑฬออออออออออุอออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณ Retorna se e' ou nao e' Nota Fiscal Conjugada               บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณcNFiscal - Numero da nota fiscal                             บฑฑ
ฑฑบ          ณcSerie   - Serie da nota fiscal                              บฑฑ
ฑฑบ          ณcClieFor - Cli/For da nota fiscal                            บฑฑ
ฑฑบ          ณcLoja    - Loja do Cli/For da nota fiscal                    บฑฑ
ฑฑบ          ณcTipo    - Entrada / Saida                                   บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ (.T.) - e' NF Conjugada | (.F.) - nao e' NF Conjugada       บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออฯอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ Generico                                                    บฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Function NFConjugada(cNFiscal, cSerie, cClieFor, cLoja, cTipo)
Local aArea     := GetArea()
Local cAlias    := "SFT"
Local cIndex    := ""
Local cQuery    := ""
Local lQuery    := .F.
Local lConjugada:= .F.

#IFDEF TOP
	Local nX       := 0
	Local aStruSFT := {}
#ELSE
	Local cChave   := ""
#ENDIF

DbSelectArea("SFT")
SFT->(DbSetOrder(2))
ProcRegua(LastRec())

#IFDEF TOP
	If (TcSrvType()!="AS/400")
		lQuery := .T.
		cAlias := "FT_DSGRAM"
		aStru  := SFT->(dbStruct())
		cQuery := "SELECT SFT.FT_NFISCAL, SFT.FT_SERIE, SFT.FT_CLIEFOR, SFT.FT_LOJA, SFT.FT_TIPO "
		cQuery += "FROM "+RetSqlName("SFT")+" SFT "
		cQuery += "WHERE SFT.FT_FILIAL='"+xFilial("SFT")+"' AND "
		cQuery +=       "SFT.FT_NFISCAL='"+cNfiscal+"' AND "
		cQuery +=       "SFT.FT_SERIE='"+cSerie+"' AND "
		cQuery +=       "SFT.FT_CLIEFOR='"+cClieFor+"' AND "
		cQuery +=       "SFT.FT_LOJA='"+cLoja+"' AND "
		cQuery +=       "SFT.FT_TIPOMOV='"+cTipo+"' AND "
		cQuery +=       "SFT.D_E_L_E_T_ = ' ' "
		cQuery += "ORDER BY "+SqlOrder("FT_FILIAL+FT_TIPOMOV+DTOS(FT_ENTRADA)+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA")
		cQuery	:= ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)
		For nX := 1 To len(aStruSFT)
			If aStruSFT[nX][2] <> "C" .And. FieldPos(aStruSFT[nX][1])<>0
				TcSetField(cAlias,aStruSFT[nX][1],aStruSFT[nX][2],aStruSFT[nX][3],aStruSFT[nX][4])
			EndIf
		Next nX
		dbSelectArea(cAlias)
	Else
#ENDIF
	cIndex := CriaTrab(NIL,.F.)
	cChave := IndexKey()
	cQuery := "FT_FILIAL='"+xFilial("SFT")+"' .AND. "
	cQuery += "FT_NFISCAL=='"+cNFiscal+"' .AND. "
	cQuery += "FT_SERIE=='"+cSerie+"' .AND. "
	cQuery += "FT_CLIEFOR=='"+cClieFor+"' .AND. "
	cQuery += "FT_LOJA=='"+cLoja+"' .AND. "
	cQuery += "FT_TIPOMOV=='"+cTipo+"'  "
	IndRegua(cAlias,cIndex,cChave,,cQuery)
	nIndex := RetIndex(cAlias)
	#IFNDEF TOP
		dbSetIndex(cIndex+OrdBagExt())
	#ENDIF
	dbSelectArea("SFT")
	dbSetOrder(nIndex+1)
	dbSelectArea(cAlias)
	ProcRegua(LastRec())
	dbGoTop()
#IFDEF TOP
	Endif
#ENDIF

Do While !(cAlias)->(Eof())
	If (cAlias)->FT_TIPO<>"S"
		lConjugada := .T.
	Else
		lConjugada := .F.
	EndIf
	(cAlias)->(dbSkip())
Enddo

If lQuery
	dbSelectArea(cAlias)
	dbCloseArea()
Else
	RetIndex("SFT")
	dbClearFilter()
	fErase(cIndex+OrdBagExt())
Endif
RestArea(aArea)
Return(lConjugada)


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหอออออออัอออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณCriaSRD_DBFบAutor  ณMicrosiga          บ Data ณ  12/16/08   บฑฑ
ฑฑฬออออออออออุอออออออออออสอออออออฯอออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณUtilizada na geracao do MANAD. Quando em ambiente CDX,      บฑฑ
ฑฑบ          ณcria uma tabela temporaria para armazenar os dados do SRD   บฑฑ
ฑฑบ          ณacumulando os valores que tem a mesma verba+cc+Mat e somenteบฑฑ
ฑฑบ          ณsequencia diferente.                                        บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION CriaSRD_DBF(nTipo)

Local aArea     := GetArea()
Local cIndSRD	:= ""
Local cArqSRD	:= ""
Local cFiltro	:= ""
Local nI 		:= 0
Local aCampos   := {}

If nTipo == 1
	aCampos   := SRD->( dbStruct() )
	cArqSRD  :=	CriaTrab(aCampos)
	dbUseArea(.T.,__LocalDriver,cArqSRD,"MOV",.T.,.F.)
	cFiltro := "RD_FILIAL>='"+_aTotal[009][1][8]	+"' .AND. RD_FILIAL<='"+ _aTotal[009][1][9]+"' .AND. RD_DATARQ	>='"+MesAno(_aTotal[001])+"' .AND. RD_DATARQ<='"+ _aTotal[060]+"' .AND. RD_EMPRESA='"+ SPACE(02)+"'"
	IndRegua("MOV",cArqSRD,"RD_FILIAL+RD_MAT+RD_DATARQ+RD_PD+RD_CC",,cFiltro,"Indexando registros...")

	DbSelectArea("MOV")
	DbClearIndex()
	DbSetIndex(cArqSRD+OrdBagExt())


	DbSelectArea("SRD")
	cIndSRD := CriaTrab(,.F.)
	cFiltro := "RD_FILIAL>='"+_aTotal[009][1][8]	+"' .AND. RD_FILIAL<='"+ _aTotal[009][1][9]+"' .AND. RD_DATARQ	>='"+MesAno(_aTotal[001])+"' .AND. RD_DATARQ<='"+ _aTotal[060]+"' .AND. RD_EMPRESA='"+ SPACE(02)+"'"
	IndRegua("SRD",cIndSRD,"RD_FILIAL+RD_MAT+RD_DATARQ+RD_PD+RD_CC",,cFiltro,"Indexando registros...")
	DbClearIndex()
	DbSetIndex(cIndSRD+OrdBagExt())

	SRD->(DbGoTop ())
	While SRD->(!Eof()) .and. SRD->RD_FILIAL <=_aTotal[009][1][9]

		If SRD->RD_DATARQ >= MesAno(_aTotal[001]) .AND. SRD->RD_DATARQ <= _aTotal[060] .AND. RD_EMPRESA= SPACE(02)

			If MOV->(dbSeek(SRD->RD_FILIAL+SRD->RD_MAT+SRD->RD_DATARQ+SRD->RD_PD+SRD->RD_CC))
				RecLock("MOV",.F.)
				MOV->RD_VALOR += SRD->RD_VALOR
			Else
				RecLock("MOV",.T.)
				For nI := 1 to len(aCampos)
				     FieldPut(nI, SRD->( FieldGet(nI) ) )
				Next
			EndIf
		EndIf
		SRD->(dbSkip())
	EndDo

	SRD->( dbCloseArea() )
	FErase(cIndSRD+OrdBagExt())

	DbSelectArea("SRD")
	restArea( aArea )

	Return( cArqSRD )
ElseIf nTipo == 2
	dbSelectArea("MOV")
	dbCloseArea()
	dbSelectArea("SRD")
	dbCloseArea()
	dbUseArea(.T.,__LocalDriver,_aTotal[092],"SRD",.T.,.F.)
	DbClearIndex()
	DbSetIndex(_aTotal[092]+OrdBagExt())
    return(.T.)
ElseIf nTipo == 3
	cArqSRD := _aTotal[092]
	dbSelectArea("SRD")
	dbCloseArea()

	FErase(cArqSRD+OrdBagExt())

	cArqSRD := RetArq(__LocalDriver,cArqSRD,.T.)
	Ferase(cArqSRD)

	dbSelectArea("SRD")

	restArea( aArea )
	Return( .T.)
EndIf

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณ RetCred  บAutor  ณLuciana Pires       บ Data ณ 04/03/2008  บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Retorna os valores de creditos por movimentacoes de saida  บฑฑ
ฑฑบ          ณ dos produtos com incentivo PRODEPE - Decreto 31.249        บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ Matr987 / P9Autotext.PE                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function RetCred(dDataIni, dDataFim, aFaixa)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Definicao de Variaveis                                       ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
Local cAliasSFT := "SFT"
Local cNCM		:= ""
Local cNIncent	:= ""

Local lQuery    := .F.
Local lFaixa	:= .T.
Local lRProdep  := .F.

Local aRetCred	:= {}
Local aProdI	:= {}
Local aIncent   := GetNewPar("MV_PRODEP1",{{"XXX",0}})
Local aMVPDEPE  := {}

Local nPosicao	:= 0
Local nQIncent	:= 0
Local nX		:= 0
Local nTipo		:= 0
Local nPos2		:= 0

#IFDEF TOP
	Local aStru		:= {}
#ELSE
	Local cChave	:= ""
#ENDIF

Default dDataIni	:= dDataBase
Default dDataFim    := dDataBase
Default aFaixa		:= {}

aIncent   := Iif (Len(aIncent) > 1,&(aIncent),aIncent)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณAcrescenta mais NCPs de incentivo atraves dos parametros SX6  ณ
//ณMV_PDEPExx onde xx pode ser 01, 02, 03, n... ampliando a      ณ
//ณcapacidade de conteudo para acrescentar novos codigos de NCP  ณ
//ณao array aIncent.                                             ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If LeMVPDEPE(@aMVPDEPE)
	If Len(aMVPDEPE) > 0
		For nX := 1 to Len(aMVPDEPE)
			Aadd(aIncent,aMVPDEPE[nX])
		Next nX
	EndIf
EndIf


//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Seleciona Movimentacao de Saida                              ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

DbSelectArea("SFT")
SFT->(DbSetOrder(2))
ProcRegua(LastRec())

#IFDEF TOP
	If ( TcSrvType()!="AS/400" )
		lQuery 		:= .T.
		cAliasSFT	:= "SFT_PRODEPE"
		aStru  		:= SFT->(dbStruct())
		cQuery 		:= "SELECT SFT.FT_FILIAL, SFT.FT_NFISCAL, SFT.FT_SERIE, "
		cQuery		+= "SFT.FT_CFOP, SFT.FT_VALICM, SFT.FT_TIPO, SFT.FT_ENTRADA, "
		cQuery		+= "SFT.FT_DTCANC, SFT.FT_OBSERV, SFT.FT_PRODUTO, SFT.FT_QUANT, "
		cQuery		+= "SFT.FT_ALIQICM "
		cQuery 		+= "FROM " + RetSqlName("SFT") + " SFT , "
		cQuery		+= "WHERE SFT.FT_FILIAL = '" + xFilial("SFT") + "' AND "
		cQuery 		+= "SFT.FT_TIPO <> 'S' AND "
		cQuery 		+= "SFT.FT_VALICM > 0 AND "
		cQuery 		+= "SFT.FT_CFOP >= '5' AND "
		cQuery 		+= "SFT.FT_CFOP < '7' AND "
		cQuery 		+= "SFT.FT_ENTRADA >= '" + Dtos(dDataIni) + "' AND "
		cQuery 		+= "SFT.FT_ENTRADA <= '" + Dtos(dDataFim) + "' AND "
		cQuery		+= "SFT.FT_DTCANC = '"+Space(Len(Dtos(SFT->FT_DTCANC)))+"' AND "
		cQuery 		+= "SFT.FT_OBSERV NOT LIKE '%CANCELAD%' AND SFT.D_E_L_E_T_ = ' ' "
		cQuery 		+= "ORDER BY "+SqlOrder("FT_FILIAL+FT_PRODUTO+DTOS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE")
		cQuery		:= ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFT,.T.,.T.)

		For nX := 1 To len(aStru)
			If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
			   TcSetField(cAliasSFT,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
			EndIf
		Next nX
		dbSelectArea(cAliasSFT)
	Else
#ENDIF

	cIndex := CriaTrab(NIL,.F.)
    cChave := "FT_FILIAL+FT_PRODUTO+DTOS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE"
	cQuery := "FT_FILIAL='"+xFilial("SFT")+"' .AND. "
	cQuery += "DTOS(FT_ENTRADA)>='"+DTOS(dDataIni)+"' .AND. "
	cQuery += "DTOS(FT_ENTRADA)<='"+DTOS(dDataFim)+"' .AND. "
	cQuery += "FT_TIPO <> 'S' .AND. "
	cQuery += "FT_VALICM > 0 .AND. "
	cQuery += "FT_CFOP >= '5' .AND."
	cQuery += "FT_CFOP < '7' .AND."
	cQuery += "Empty(FT_DTCANC) .AND. "
	cQuery += "!(FT_OBSERV $ 'CANCELAD') "

    IndRegua(cAliasSFT,cIndex,cChave,,cQuery)
    nIndex := RetIndex(cAliasSFT)

	#IFNDEF TOP
		dbSetIndex(cIndex+OrdBagExt())
	#ENDIF
	dbSelectArea("SFT")
    dbSetOrder(nIndex+1)
    dbSelectArea(cAliasSFT)
    ProcRegua(LastRec())
   	dbGoTop()
#IFDEF TOP
	Endif
#ENDIF

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Verifico a Movimentacao de Saida - COM INCENTIVO             ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

While !(cAliasSFT)->(Eof())

	SB1->(dbSetOrder(1))
	SB1->(dbSeek(xFilial("SB1")+(cAliasSFT)->FT_PRODUTO))
	cNCM		:= Alltrim(SB1->B1_POSIPI)

	lRProdep  := IIF(cPaisLoc == "BRA", AllTrim(SB1->B1_RPRODEP), "")

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณSomente produtos com incentivo      ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If Empty(cNCM) .Or. lRProdep <> "1" .Or. Len(aIncent) < 2
		(cAliasSFT)->(dbSkip())
		Loop
	Else
		cNIncent := IIF(aScan(aIncent,{|x| x[1] == AllTrim(cNCM)})>0,aIncent[aScan(aIncent,{|x| x[1] == AllTrim(cNCM)})][1],"")
		If Empty(cNIncent)
			(cAliasSFT)->(dbSkip())
			Loop
		Endif
	Endif

    //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Acumula valores por NCM, faixa de incentivo e percentual     |
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	nTipo := Iif(Substr((cAliasSFT)->FT_CFOP,1,1) == "5",1,2) //1 - Operacao Interna / 2 - Operacao Interestadual

	nPosicao := aScan(aProdI,{|x| x[1] <= (cAliasSFT)->FT_ALIQICM .And. x[2] >= (cAliasSFT)->FT_ALIQICM .And. x[3] == nTipo .And. x[4] == cNCM })
	lFaixa	:= .T.
	If nPosicao == 0
		For nX := 1 to Len(aFaixa)
			nPos2 := aScan(aFaixa,{|x| x[4] == nTipo .And. x[1] <= (cAliasSFT)->FT_ALIQICM .And. x[2] >= (cAliasSFT)->FT_ALIQICM	})
			lFaixa := .F.
			If nPos2 > 0
				lFaixa := .T.
				aadd(aProdI,{aFaixa[nPos2][1],;	//1 - Faixa Aliq Ini
							 aFaixa[nPos2][2],;    	//2 - Faixa Aliq Fim
							 nTipo,;				//3 - Tipo Operacao
							 cNCM,;     			//4 - NCM Produto
							 aFaixa[nPos2][3],;		//5 - Valor Percentual Aplicado
							 0,; 					//6 - Quantidade Produto
							 0}) 					//7 - Valor ICMS
				nPosicao := Len(aProdI)
				Exit
			Endif
		 Next
	EndIf
	If lFaixa
		aProdI[nPosicao][6] += (cAliasSFT)->FT_QUANT
		aProdI[nPosicao][7] += (cAliasSFT)->FT_VALICM
    Endif
	(cAliasSFT)->(dbSkip())
EndDo

For nX := 1 to Len(aProdI)
	nQIncent := IIF(aScan(aIncent,{|x| x[1] == AllTrim(aProdI[nX][4])})>0,aIncent[aScan(aIncent,{|x| x[1] == AllTrim(aProdI[nX][4])})][2],0)
	If aProdI[nX][6] < nQIncent
		aadd(aRetCred,{aProdI[nX][1],;		//1 - Faixa Aliq Ini
					 aProdI[nX][2],;   		//2 - Faixa Aliq Fim
					 aProdI[nX][3],;		//3 - Tipo Operacao
					 aProdI[nX][4],;     	//4 - NCM Produto
					 aProdI[nX][5],;		//5 - Valor Percentual Aplicado
					 aProdI[nX][6],; 		//6 - Quantidade Produto
					 aProdI[nX][7]}) 		//7 - Valor ICMS
	Endif
Next

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Exclui as areas de trabalho                                  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If lQuery
	dbSelectArea(cAliasSFT)
	dbCloseArea()
Else
	Ferase(cIndex+OrdBagExt())
	RetIndex("SFT")
EndIf

Return(aRetCred)

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณLeMVPDEPE  บ Autor ณAlexandre Lemes     บ Data ณ 16/12/2009  บฑฑ
ฑฑฬออออออออออุอออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณ Funcao que le o conteudo de todos os parametros SX6 inciadosบฑฑ
ฑฑบ          ณ por MV_PDEPExx onde XX sera o numero do novo parametro, Ex: บฑฑ
ฑฑบ          ณ 01, 02, 03, n... seu uso e para ampliar a capacidade de in  บฑฑ
ฑฑบ          ณ clusao de novos codigos de NCMs do parametro MVPRODEP1 quan บฑฑ
ฑฑบ          ณ do nao houver mais espaco no conteudo do mesmo.             บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบExemplo   ณExemplo de conteudo dos parametros MV_PDEPE01 - Tipo Caracterบฑฑ
ฑฑบ          ณ60011010=1000;60024020=20000; onde o primeiro numero e o NCM บฑฑ
ฑฑบ          ณo segundo a qtde do decreto PRODEPE, a string deve ser       บฑฑ
ฑฑบ          ณfinalisada obrigatoriamente com ;                            บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaRegra -> Conteudo do parametro MV_PDEPExx                   บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออัอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบRetorno   ณ (.T.) Se Houver Conteudo| (.F.) Se nao existir SX6 ou Brancoบฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออฯอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ RetCred()                                                   บฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Static Function LeMVPDEPE(aRegra)

Local	lRet		:=	.F.
Local	nInd		:=	0
Local	cLetra		:=	""
Local	cRegra		:=	""
Local	cDireita	:=	""
Local	cEsquerda	:=	""

DbSelectArea ("SX6")
SX6->(DbSetOrder (1))
If (SX6->(DbSeek (xFilial ("SX6")+"MV_PDEPE")))
	Do While !SX6->(Eof ()) .And. xFilial ("SX6")==SX6->X6_FIL .And. "MV_PDEPE"$SX6->X6_VAR
		cVar	:=	AllTrim (SX6->X6_CONTEUD)

		For nInd := 1 To Len (cVar)
			lRet	:=	.T.
			cLetra	:=	SubStr (cVar, nInd, 1)
			If (";"$cLetra)
				cDireita	:=	cRegra
				cRegra	:=	""
			ElseIf ("="$cLetra)
				cEsquerda	:=	cRegra
				cRegra	:=	""
			Else
				cRegra	+=	cLetra
			EndIf
			If (";"$cLetra)
				aAdd (aRegra, {cEsquerda, Val(cDireita)})
			EndIf

		Next (nInd)
		SX6->(DbSkip ())
	EndDo
EndIf

Return lRet


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณ RetCred2 บAutor  ณLuciana Pires       บ Data ณ 13/03/2008  บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Retorna os valores de creditos por movimentacoes de saida  บฑฑ
ฑฑบ          ณ dos produtos com incentivo PRODEPE - Decreto 31.250        บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ Matr988 / P9Autotext.PE                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function RetCred2(dDataIni, dDataFim, nValDevA, cArqAnt)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Definicao de Variaveis                                       ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
Local cAliasSFT := "SFT"
Local cNCM		:= ""
Local cIncent   := GetNewPar("MV_PRODEP2","")

Local lQuery    := .F.
Local lCred		:= .F.

Local aRetCred	:= {}
Local aProdI	:= {}
Local aValPerc	:= GetNewPar("MV_PRODEP3",{0,0,0})

Local nPosicao	:= 0
Local nX		:= 0
Local nPos2		:= 0
Local nTNota	:= 0
Local nTICMS	:= 0
Local nValTotS 	:= 0
Local nValDif	:= 0
Local nValCred	:= 0
Local nTCred	:= 0

#IFDEF TOP
	Local aStru		:= {}
#ELSE
	Local cChave	:= ""
#ENDIF

Default dDataIni	:= dDataBase
Default dDataFim    := dDataBase
Default nValDevA    := 0
Default cArqAnt	    := ""

aValPerc   := Iif (Len(aValPerc) > 1,&(aValPerc),aValPerc)

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณVerifico a existencia da tabela utilizada   ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If (nValDevA == 0 .And. Empty(cArqAnt))
	Return(aRetCred)
EndIf

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Verifico saldo devedor do periodo anterior                   |
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If nValDevA == 0
	nValDevA := LoadAnt(cArqAnt, "011") //Saldo Devedor
	If nValDevA == 0 //Se nao possuir saldo devedor anterior nao tera direito ao beneficio
		Return(aRetCred)
	Endif
Endif

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Seleciona Movimentacao de Saida                              ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

DbSelectArea("SFT")
SFT->(DbSetOrder(2))
ProcRegua(LastRec())

#IFDEF TOP
	If ( TcSrvType()!="AS/400" )
		lQuery 		:= .T.
		cAliasSFT	:= "SFT_PROD2"
		aStru  		:= SFT->(dbStruct())
		cQuery 		:= "SELECT SFT.FT_FILIAL, SFT.FT_NFISCAL, SFT.FT_SERIE, "
		cQuery		+= "SFT.FT_CFOP, SFT.FT_VALICM, SFT.FT_TIPO, SFT.FT_ENTRADA, "
		cQuery		+= "SFT.FT_DTCANC, SFT.FT_OBSERV, SFT.FT_PRODUTO, SFT.FT_QUANT, "
		cQuery		+= "SFT.FT_ALIQICM, SFT.FT_VALCONT "
		cQuery 		+= "FROM " + RetSqlName("SFT") + " SFT , "
		cQuery		+= "WHERE SFT.FT_FILIAL = '" + xFilial("SFT") + "' AND "
		cQuery 		+= "SFT.FT_TIPO <> 'S' AND "
		cQuery 		+= "SFT.FT_VALICM > 0 AND "
		cQuery 		+= "SFT.FT_CFOP >= '6' AND "
		cQuery 		+= "SFT.FT_CFOP < '7' AND "
		cQuery 		+= "SFT.FT_ENTRADA >= '" + Dtos(dDataIni) + "' AND "
		cQuery 		+= "SFT.FT_ENTRADA <= '" + Dtos(dDataFim) + "' AND "
		cQuery		+= "SFT.FT_DTCANC = '"+Space(Len(Dtos(SFT->FT_DTCANC)))+"' AND "
		cQuery 		+= "SFT.FT_OBSERV NOT LIKE '%CANCELAD%' AND SFT.D_E_L_E_T_ = ' ' "
		cQuery 		+= "ORDER BY "+SqlOrder("FT_FILIAL+FT_PRODUTO+DTOS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE")
		cQuery		:= ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFT,.T.,.T.)

		For nX := 1 To len(aStru)
			If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
			   TcSetField(cAliasSFT,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
			EndIf
		Next nX
		dbSelectArea(cAliasSFT)
	Else
#ENDIF

	cIndex := CriaTrab(NIL,.F.)
    cChave := "FT_FILIAL+FT_PRODUTO+DTOS(FT_ENTRADA)+FT_NFISCAL+FT_SERIE"
	cQuery := "FT_FILIAL='"+xFilial("SFT")+"' .AND. "
	cQuery += "DTOS(FT_ENTRADA)>='"+DTOS(dDataIni)+"' .AND. "
	cQuery += "DTOS(FT_ENTRADA)<='"+DTOS(dDataFim)+"' .AND. "
	cQuery += "FT_TIPO <> 'S' .AND. "
	cQuery += "FT_VALICM > 0 .AND. "
	cQuery += "FT_CFOP >= '6' .AND."
	cQuery += "FT_CFOP < '7' .AND."
	cQuery += "Empty(FT_DTCANC) .AND. "
	cQuery += "!(FT_OBSERV $ 'CANCELAD') "

    IndRegua(cAliasSFT,cIndex,cChave,,cQuery)
    nIndex := RetIndex(cAliasSFT)

	#IFNDEF TOP
		dbSetIndex(cIndex+OrdBagExt())
	#ENDIF
	dbSelectArea("SFT")
    dbSetOrder(nIndex+1)
    dbSelectArea(cAliasSFT)
    ProcRegua(LastRec())
   	dbGoTop()
#IFDEF TOP
	Endif
#ENDIF

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Verifico a Movimentacao de Saida Interestadual               ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

While !(cAliasSFT)->(Eof())
	SB1->(dbSetOrder(1))
	SB1->(dbSeek(xFilial("SB1")+(cAliasSFT)->FT_PRODUTO))
	cNCM	:= Alltrim(SB1->B1_POSIPI)

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณSomente produtos com incentivo      ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If Empty(cNCM) .Or. Empty(cIncent)
		(cAliasSFT)->(dbSkip())
		Loop
	Else
		If !(cNCM$cIncent)
			(cAliasSFT)->(dbSkip())
			Loop
		Endif
	Endif

    //ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณ Acumula valores Op. Interestaduais por NCM                   |
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	nPosicao := aScan(aRetCred,{|x| x[1] == cNCM})
	If nPosicao == 0
		aadd(aRetCred,{cNCM,;				//1 - NCM
					 .F.,; 					//2 - Tem direito ao credito? .T. ou .F.
					 0,;					//3 - Valor Total
					 0}) 					//4 - Valor Credito
		nPosicao := Len(aRetCred)
	EndIf

	aRetCred[nPosicao][3] += (cAliasSFT)->FT_VALCONT

	nTICMS	+= (cAliasSFT)->FT_VALICM
	nTNota	+= (cAliasSFT)->FT_VALCONT

	(cAliasSFT)->(dbSkip())
EndDo

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Incluo no array o total geral                                |
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
nValTotS 	:= (nTNota * aValPerc[1]) / 100   	//Valor Total * Percentual 1 -> 5%
nValDif		:= (nTICMS - nValTotS)				//Valor ICMS Normal - nValTotS
nValCred	:= (nValDif * aValPerc[2]) / 100	//Percentual 2 -> 70% * Diferenca (nDif)
lCred		:= 	Iif(nValCred + nValTotS > ((nValDevA * aValPerc[3]) / 100),.T.,.F.) //Valor Devedor Anterior * Percentual 3 -> 15%
nTCred		:= (nValCred + nValTotS) // Soma dos creditos presumidos

Aadd(aRetCred,{"TOTAL",;					//1 - TOTAL Geral
			 lCred,;						//2 - Tem direito ao credito? .T. ou .F.
			 nTNota,;						//3 - Valor Total
			 nTCred })						//4 - Valor Credito

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Altero a posicao 2 do array pq soh tenho como saber se tem   ณ
//ณ direito ao credito no final                                  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

For nX := 1 to Len(aRetCred)
	aRetCred[nX][2] := lCred
Next

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณ Exclui as areas de trabalho                                  ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If lQuery
	dbSelectArea(cAliasSFT)
	dbCloseArea()
Else
	Ferase(cIndex+OrdBagExt())
	RetIndex("SFT")
EndIf

Return(aRetCred)

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณ GIARSSX1 ณ Autor ณ Rodrigo Zatt          ณ Data ณ23.04.2008ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Ajuste das perguntas para geracao do arquivo magnetico     ณฑฑ
ฑฑณ          ณ GMB do Sistema de Apuracao dos Indices dos Municipios (RS) ณฑฑ
ฑฑ|          |                                                            |ฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GIARSSX1()


Return ()

/*
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัอออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณCAT102     บAutor  ณMarcos Taranta      บData  ณ23/07/09     บฑฑ
ฑฑฬออออออออออุอออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณAtualiza o valor do campo F3_CAT102 da tabela SF3.           บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบParametrosณaRegistros - Array contendo os registros a serem atualizados.บฑฑ
ฑฑบ          ณ             [1] Recno                                       บฑฑ
ฑฑบ          ณ             [2] Valor a ser atribuido                       บฑฑ
ฑฑฬออออออออออุอออออออออออออออออออออออออฯอออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณCAT102                                                       บฑฑ
ฑฑศออออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿*/
Function CAT102(aRegistros)

Local nRecno := 0
Local cValor := ""
Local nX     := 0

Default aRegistros := {}

If Empty(aRegistros) .And. cPaisLoc != "BRA"
	Return
EndIf

DBSelectArea("SF3")

For nX := 1 To Len(aRegistros)
	nRecno := aRegistros[nX][1]
	If aRegistros[nX][2]
		cValor := "1"
	Else
		cValor := ""
	EndIf

	SF3->(DBGoto(nRecno))

	Reclock("SF3", .F.)
	SF3->F3_CAT102 := cValor
	MSUnlock()

Next nX

Return
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao     ณRetNotConj  ณ Autor ณ Rodrigo Zatt         ณ Data ณ 30.09.2009 ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescricao  ณRetorna um Array com valores caso nota seja conjugada          ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametros ณcNFiscal - Numero da nota fiscal                               ณฑฑ
ฑฑณ           ณcSerie   - Serie  da nota fiscal                               ณฑฑ
ฑฑณ           ณcClieFor - Cli/For da nota fiscal                              ณฑฑ
ฑฑณ           ณcLoja    - Loja do Cli/For da nota fiscal                      ณฑฑ
ฑฑณ           ณcTipo    - Entrada / Saida                                     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno    ณArry                                                           ณฑฑ
ฑฑณ           ณ01   - ChaveSFT                                                ณฑฑ
ฑฑณ           ณ02   - Valor Total do Item                                     ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณUso        ณGenerico                                                       ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function RetNotConj(cNFiscal, cSerie, cClieFor, cLoja, cTipo)
Local aArea			:= GetArea()
Local cAlias      	:= "SFT"
Local cIndex      	:= ""
Local cQuery		:= ""
Local lQuery      	:= .F.
Local aValores		:= {}
Local nPos          := 0
Local aAreaSFT		:= {}

#IFDEF TOP
	Local nX          := 0
	Local aStruSFT    := {}
#ELSE
	Local cChave	:= ""
#ENDIF

aAreaSFT := SFT->(GetArea())

DbSelectArea("SFT")
SFT->(DbSetOrder(2))
ProcRegua(LastRec())

#IFDEF TOP
	If ( TcSrvType()!="AS/400" )
		lQuery := .T.
		cAlias := "FT_DSGRAM"
		aStru  := SFT->(dbStruct())
		cQuery := "SELECT SFT.FT_NFISCAL, SFT.FT_SERIE, SFT.FT_CLIEFOR, SFT.FT_LOJA, SFT.FT_TIPO, SFT.FT_TOTAL "
		cQuery += "FROM "+RetSqlName("SFT")+" SFT "
		cQuery += "WHERE SFT.FT_FILIAL='"+xFilial("SFT")+"' AND "
		cQuery +=       "SFT.FT_NFISCAL='"+cNfiscal+"' AND "
		cQuery +=       "SFT.FT_SERIE='"+cSerie+"' AND "
		cQuery +=       "SFT.FT_CLIEFOR='"+cClieFor+"' AND "
		cQuery +=       "SFT.FT_LOJA='"+cLoja+"' AND "
		cQuery +=       "SFT.FT_TIPOMOV='"+cTipo+"'  "
		cQuery += "ORDER BY "+SqlOrder("FT_FILIAL+FT_TIPOMOV+DTOS(FT_ENTRADA)+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA")
		cQuery	:= ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)

		For nX := 1 To len(aStruSFT)
			If aStruSFT[nX][2] <> "C" .And. FieldPos(aStruSFT[nX][1])<>0
				TcSetField(cAlias,aStruSFT[nX][1],aStruSFT[nX][2],aStruSFT[nX][3],aStruSFT[nX][4])
			EndIf
		Next nX
		dbSelectArea(cAlias)
	Else
#ENDIF

	cIndex := CriaTrab(NIL,.F.)
    cChave :=	IndexKey()
	cQuery := "FT_FILIAL='"+xFilial("SFT")+"' .AND. "
	cQuery += "FT_NFISCAL=='"+cNFiscal+"' .AND. "
	cQuery += "FT_SERIE=='"+cSerie+"' .AND. "
	cQuery += "FT_CLIEFOR=='"+cClieFor+"' .AND. "
	cQuery += "FT_LOJA=='"+cLoja+"' .AND. "
	cQuery += "FT_TIPOMOV=='"+cTipo+"'  "

    IndRegua(cAlias,cIndex,cChave,,cQuery)
    nIndex := RetIndex(cAlias)

	#IFNDEF TOP
		dbSetIndex(cIndex+OrdBagExt())
	#ENDIF
	dbSelectArea("SFT")
    dbSetOrder(nIndex+1)
    dbSelectArea(cAlias)
    ProcRegua(LastRec())
   	dbGoTop()
#IFDEF TOP
	Endif
#ENDIF
cChaveSfT := cNFiscal+cSerie+cClieFor+cLoja+cTipo
Do While !(cAlias)->(Eof())

	If (cAlias)->FT_TIPO<>"S" 	// Se achar com esta chave o tipo igual a "N" ้ uma Nota Fiscal conjugada, pois no ini a query
		If cTipo == "S"
			nPos := Ascan(aValores,{|x|x[01]==cChaveSfT})
			If nPos > 0
				aValores[nPos,02] +=(cAlias)->FT_TOTAL
			Else
				AADD(aValores,{cChaveSfT,(cAlias)->FT_TOTAL})
		    EndIF
		Endif
	Endif

(cAlias)->(dbSkip())
Enddo
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณExclui area de trabalho utilizada - SFTณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
If !lQuery
	RetIndex("SFT")
	dbClearFilter()
	Ferase(cIndex+OrdBagExt())
Else
	dbSelectArea(cAlias)
	dbCloseArea()
Endif

RestArea (aArea)
RestArea (aAreaSFT)

Return(aValores)



/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษอออออออออัอออออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao   ณCretArroz    บAutor  ณ Rodrigo Zatt       บ Data ณ  21/12/09   บฑฑ
ฑฑฬอออออออออุอออออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.    ณ Calcula credito Presumido das opera็ao de Arroz estado SC     บฑฑ
ฑฑฬอออออออออุอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso      ณ P9AUTOTEXT                                                    บฑฑ
ฑฑศอออออออออฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/


Function CretArroz( dDataIn, dDataFi )

Local	dDataDe      := CtoD('  /  /  ')
Local	dDataAte     := CtoD('  /  /  ')

Local	cAliasSFT    := "SFT"
Local	cAliasSB1    := "SB1"
Local	cFiltro	     := " "
Local   cCfopAux     := " "
Local 	cCondicao    := " "
Local	cMVCfop		 := " "	//CFOP de Entrada e Saida separados por "/" que nao vใo fazer parte do calculo do credito
Local	cB1Arr       := SuperGetMv("MV_B1ARROZ",.F.,"")    //SB1 - Campo que indica se produto entra no calculo do Credito.
Local	cCampos	     := " "
Local	cChave		 := " "

Local	aTotSFT      := {}

Local	nPos	   	 := 0
Local	nCredArroz 	 := 0
Local	nToVEstad 	 := 0
Local	nToCEstad 	 := 0
Local	nToCIntEstad := 0
Local   nPernc       := 0
Local 	nSoma        := 0
Local	nx 		     := 0
Local	nPercArr     := SuperGetMv("MV_SCPERC",.F.,"")
Local	nVez         := 1
Local	nMesFim      := Month(dDataFi)
Local	nAnoFim 	 := Year(dDataFi)

Local	lCampB1      := !Empty(cB1Arr) .And. SB1->(FieldPos(cB1Arr)) > 0
Local	lEnd	     := .F.
Local   lFiltroSB1   := .F.

Do While nVez <= 12
	nMesFim := nMesFim - 1
If nMesFim == 0
	nMesFim := 12
	nAnoFim := nAnoFim - 1
Endif
	nVez ++
	dDataIn := CtoD("01/"+StrZero(nMesFim,2)+"/"+StrZero(nAnoFim,4))
End

If !Empty (dDataIn) .And. !Empty(dDataFi)
    dDataDe := dDataIn
    dDataAte:= dDataFi
Endif

/*
//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณParametro com CFOPs que nao sera considerado para calculo do credito.ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
*/
SX6->(dbGoTop())
SX6->(dbSeek(xFilial("SX6")+"MV_CFARR"))
Do While !SX6->(Eof()) .And. xFilial("SX6") == SX6->X6_FIL .And. "MV_CFARR" $ SX6->X6_VAR
	cMVCfop += "/" + Alltrim(SX6->X6_CONTEUD)
	SX6->(dbSkip())
Enddo


#IFDEF TOP

	cCfopAux := cMVCfop
	cCfopAux := StrTran(cCfopAux,"/",",")
	cCfopAux	:= Alltrim(cCfopAux)
	If Right(cCfopAux,1) == ","
		cCfopAux := SubStr(cCfopAux,1,Len(cCfopAux)-1)
	Endif
	cCfopAux := StrTran(cCfopAux,",","','")
	cCfopAux := "'" + cCfopAux + "'"
	cCfopAux := "(" + cCfopAux + ")"
	cCfopAux := "% " + cCfopAux + " %"
	If lCampB1
		cFiltro := " SB1." + Alltrim(cB1Arr) + " = 'S' "
	Endif
	if Empty(cFiltro)
		cFiltro := "%%"
	Else
		cFiltro := "% " + cFiltro + " %"
	Endif
	If lCampB1
		cCampos += " ,SB1." + Alltrim(cB1Arr) + " "
	Endif
	If Empty(cCampos)
		cCampos := "%%"
	Else
		cCampos := "% " + cCampos + " %"
	Endif

#ELSE

	cCfopAux   := cMVCfop
	lFiltroSB1 := .T.

#ENDIF


    DbSelectArea ("SM0")
  	SM0->(DbSeek (cEmpAnt+cFilAnt, .T.))
	DbSelectArea (cAliasSFT)
	(cAliasSFT)->(DbSetOrder (2))
	#IFDEF TOP
	    If (TcSrvType ()<>"AS/400")
	    	cAliasSFT	:= GetNextAlias()
	    	cAliasSB1	:= cAliasSFT

	       	BeginSql Alias cAliasSFT

			COLUMN FT_EMISSAO AS DATE
	    	COLUMN FT_ENTRADA AS DATE
	    	COLUMN FT_DTCANC AS DATE

			SELECT
				SFT.FT_CFOP,SFT.FT_ENTRADA,SFT.FT_TIPOMOV,SFT.FT_FILIAL,SFT.FT_NFISCAL,SFT.FT_CLIEFOR,
				SFT.FT_CFPS,SFT.FT_TIPO,SFT.FT_EMISSAO,SFT.FT_DTCANC,SFT.FT_PRODUTO,
				SFT.FT_TOTAL,SFT.FT_CLASFIS,SFT.FT_PRCUNIT,SFT.FT_ESTADO,SFT.FT_POSIPI,
				SB1.B1_FILIAL,SB1.B1_COD
				%Exp:cCampos%
			FROM
				%Table:SFT% SFT, %table:SB1% SB1
			WHERE
				SFT.FT_FILIAL  =  %xFilial:SFT% AND
				SFT.FT_ENTRADA >= %Exp:DToS (dDataDe)% AND
				SFT.FT_ENTRADA <= %Exp:DToS (dDataAte)% AND
				SFT.FT_DTCANC  =  %Exp:Dtos(Ctod(''))% AND
				SFT.FT_TIPO <> 'S' AND
			 	SFT.FT_CFOP NOT IN %Exp:cCfopAux% AND
			 	SB1.B1_FILIAL = %xFilial:SB1% AND
				SFT.FT_PRODUTO = SB1.B1_COD AND
			 	SB1.%NotDel% AND
				%Exp:cFiltro% AND
				SFT.%NotDel%

				ORDER BY SFT.FT_CFOP,SFT.FT_TIPOMOV
			EndSql
		Else
	#ENDIF
		    cIndex	:= CriaTrab(NIL,.F.)
		    cFiltro	:= 'FT_FILIAL=="'+xFilial ("SFT")+'".And.'
		   	cFiltro += 'DToS (FT_ENTRADA)>="'+DToS (dDataDe)+'".And.DToS (FT_ENTRADA)<="'+DToS (dDataAte)+'" '
			cFiltro += '.And. FT_TIPO <>"S" '
			cFiltro += '.And. !(ALLTRIM(FT_CFOP) $ "' + cCfopAux + '")'
		    IndRegua (cAliasSFT, cIndex, SFT->(IndexKey ()),, cFiltro)
		    nIndex := RetIndex(cAliasSFT)

			#IFNDEF TOP
				DbSetIndex (cIndex+OrdBagExt ())
			#ENDIF

			DbSelectArea (cAliasSFT)
		    DbSetOrder (nIndex+1)
	#IFDEF TOP
		Endif
	#ENDIF

	DbSelectArea (cAliasSFT)
	(cAliasSFT)->(DbGoTop ())
   	ProcRegua ((cAliasSFT)->(RecCount ()))
	Do While !(cAliasSFT)->(Eof ())
		cChave := (cAliasSFT)->FT_TIPOMOV+SubStr((cAliasSFT)->FT_CFOP,1,1)+SubStr(DTOS((cAliasSFT)->FT_ENTRADA),1,6)
		If Interrupcao(lEnd)
			Exit
		EndIf
		IncProc("Cr้dito Presumido Opera็๕es Interestaduais do Arroz")

		If  lFiltroSB1
			DbSelectArea (cAliasSB1)
			(cAliasSB1)->(dbSetOrder(1))
			If (cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSFT)->FT_PRODUTO))
			    If lCampB1  .And. (cAliasSB1)->(Alltrim(&cB1Arr)) <> "S"
					(cAliasSFT)->(DbSkip())
					Loop
				EndIf
			EndIf
	    EndIf

		nPos := Ascan(aTotSFT,{|x|x[01]==cChave})
		If nPos > 0
			aTotSFT[nPos,02] += (cAliasSFT)->FT_TOTAL  // Valor Total por Item
		Else
			AADD(aTotSFT,{ cChave,;                 				 // Chave
						 (cAliasSFT)->FT_TOTAL,;   					 // Valor Total por Item
						 SubStr(DTOS((cAliasSFT)->FT_ENTRADA),1,6)}) // Data : ANO MES
        EndIf
		(cAliasSFT)->(DbSkip ())
	EndDo

	#IFDEF TOP
		If (TcSrvType ()<>"AS/400")
			DbSelectArea (cAliasSFT)
			(cAliasSFT)->(DbCloseArea ())
		Else
	#ENDIF
			RetIndex("SFT")
			FErase(cIndex+OrdBagExt ())
	#IFDEF TOP
		EndIf
	#ENDIF

For nx := 1 to len(aTotSFT)
	If SubStr(aTotSFT[nx][01],1,2) == "E1" .And. aTotSFT[nx][03] <> SubStr(DTOS(dDataAte),1,6)
		nToCEstad    += aTotSFT[nx][02]
	ElseIf SubStr(aTotSFT[nx][01],1,2) == "E2" .And. aTotSFT[nx][03] <> SubStr(DTOS(dDataAte),1,6)
		nToCIntEstad += aTotSFT[nx][02]
	ElseIf SubStr(aTotSFT[nx][01],1,2) == "S6" .And. aTotSFT[nx][03] == SubStr(DTOS(dDataAte),1,6)
		nToVEstad    += aTotSFT[nx][02]
	EndIf
Next

If !Empty (nToVEstad) .And. !Empty (nPercArr)
     nSoma  	:= nToCEstad + nToCIntEstad
     nPernc 	:= nToCEstad / nSoma
     nCredArroz := (nToVEstad * nPernc) * (nPercArr/100)
EndIf

Return (nCredArroz)
/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuno    ณISCERastroณ Autor ณ Rodrigo Zatt          ณ Data ณ10/03/2010ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao criada para retornar o valor unitario da base de     ณฑฑ
ฑฑณ          ณICMS ST e valor ICMS ST.0, utiliza verificacao da tabela    ณฑฑ
ฑฑณ          ณSB8 Lotes                                                   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณSintaxe   ณISCERastro                                                  ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณRetorna													  ณฑฑ
ฑฑณ 		 |cBaseIcm : Base do ICMS ST da nota de entrada - Unitario    ณฑฑ
ฑฑณ 		 |cValIcm  : Valor do Icms St da nota de entrada - Unitario   ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ Uso      ณ ICMSTRES.INI                                               ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function ISCERastro(cProduto,cLoteCtl,cBaseIcm,cValIcm)
Local cSeek	     := ""


If !Empty(cProduto) .And. !Empty(cLoteCtl)

	dbSelectArea("SB8")
	dbSetOrder(5)
	If MsSeek(xFilial("SB8")+cProduto+cLoteCtl)
		cSeek :=cProduto+SB8->B8_DOC+SB8->B8_SERIE+SB8->B8_CLIFOR+SB8->B8_LOJA
		dbSelectArea("SD1")
		dbSetOrder(2)
		If MsSeek(xFilial("SD1") + cSeek)
			cBaseIcm   := (SD1->D1_BRICMS / SB8->B8_QTDORI)
			cValICM    := (SD1->D1_ICMSRET / SB8->B8_QTDORI)
		EndIf
    EndIf
EndIf

Return ()


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณVerValPd  บAutor  ณAllyson Mesashi     บ Data ณ  21/12/12   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna o valor da verba           						  บฑฑ
ฑฑบ          ณ                                                            บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                         บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function VerValPd(nTipo)

Local aAreaSRD	:= SRD->( GetArea() )
Local cAliasSRD	:= "MANADSRD"
Local cCposQry	:= ""
Local cDatArq	:= ""
Local cDInssFm	:= SuperGetMV("MV_DINSSFM",,SRD->RD_FILIAL)
Local nValor	:= 0

DEFAULT nTipo := 1

If nTipo == 1
	//Se nao for a verba de ferias pagas mes anterior, pega o valor do lancamento
	If SRD->RD_PD != _aTotal[013, 164, 1]
		nValor := SRD->RD_VALOR
	Else
		//Guarda o valor da competencia anterior
		cDatArq := SubMesAno( SRD->RD_DATARQ )
		//Guarda o valor das ferias pagas mes anterior
		nValor := SRD->RD_VALOR
		//Busca o abono e o 1/3 de abono pecuniario
		If ( Select( cAliasSRD ) > 0 )
			( cAliasSRD )->( dbCloseArea() )
		EndIf
		cCposQry += "% SRD.RD_FILIAL, SRD.RD_MAT, SRD.RD_CC, SRD.RD_DATARQ, SRD.RD_PD, SRD.RD_VALOR,SRD.RD_ROTEIR %"
		cWhere		:=	" ( SRD.RD_FILIAL = '" + SRD->RD_FILIAL + "' AND SRD.RD_MAT = '" + SRD->RD_MAT + "' AND " +;
						" SRD.RD_DATARQ = '" + cDatArq + "' AND SRD.RD_CC = '" + SRD->RD_CC + "' AND " +;
						" SRD.RD_PD IN ('" + _aTotal[013, 205, 1] + "', '" + _aTotal[013, 206, 1] + "', '" + _aTotal[013, 207, 1] + "', '" + _aTotal[013, 208, 1] + "' ) ) "
		cWhere		:= "%" + cWhere + "%"
		//Faz a query
		BeginSql alias cAliasSRD
			SELECT %exp:cCposQry%
			FROM %table:SRD% SRD
			WHERE  %exp:cWhere%
	  				AND SRD.%notDel%
		EndSql
	    //Subtrai o valor referente o abono mes seguinte e o 1/3 de abono pecuniario mes seguinte
		While ( cAliasSRD )->( !Eof() )
			nValor -= (cAliasSRD)->RD_VALOR
			( cAliasSRD )->( dbSkip() )
		End While
	EndIf
ElseIf nTipo == 2
	If SRD->RD_PD != _aTotal[013, 164, 1]
		nValor := SRD->RD_VALOR
	Else
		cDatArq := SubMesAno( SRD->RD_DATARQ )
		nValor := SRD->RD_VALOR
		//Subtrai o valor referente o abono mes seguinte
		If SRD->( dbSeek( SRD->RD_FILIAL + SRD->RD_MAT + cDatArq + _aTotal[013, 205, 1] ) )
			nValor -= SRD->RD_VALOR
		EndIf
		//Subtrai o valor referente 1/3 de abono pecuniario mes seguinte
		If SRD->( dbSeek( SRD->RD_FILIAL + SRD->RD_MAT + cDatArq + _aTotal[013, 206, 1] ) )
			nValor -= SRD->RD_VALOR
		EndIf
		//Subtrai o valor referente a diferenca do abono mes seguinte
		If SRD->( dbSeek( SRD->RD_FILIAL + SRD->RD_MAT + cDatArq + _aTotal[013, 207, 1] ) )
			nValor -= SRD->RD_VALOR
		EndIf
		//Subtrai o valor referente a diferenca de 1/3 de abono pecuniario mes seguinte
		If SRD->( dbSeek( SRD->RD_FILIAL + SRD->RD_MAT + cDatArq + _aTotal[013, 208, 1] ) )
			nValor -= SRD->RD_VALOR
		EndIf
	EndIf
ElseIf nTipo == 3
	nValor 	:= SRD->RD_VALOR
	If cDInssFm != "S"
		If IfDefTop() .And. TcSrvType() != "AS/400"
			If ( Select( cAliasSRD ) > 0 )
				( cAliasSRD )->( dbCloseArea() )
			EndIf
			cCposQry += "% COUNT (*) AS CONT %"
			cWhere		:=	" ( SRD.RD_FILIAL = '" + SRD->RD_FILIAL + "' AND SRD.RD_MAT = '" + SRD->RD_MAT + "' AND " +;
							" SRD.RD_DATARQ = '" + SRD->RD_DATARQ + "' AND SRD.RD_PD = '" + _aTotal[013, 164, 1] + "' ) "
			cWhere		:= "%" + cWhere + "%"
			BeginSql alias cAliasSRD
				SELECT %exp:cCposQry% FROM %table:SRD% SRD WHERE %exp:cWhere% AND SRD.%notDel%
			EndSql
			If ( cAliasSRD )->CONT > 0
				nValor := 0
			EndIf
		Else
			If SRD->( dbSeek( SRD->RD_FILIAL + SRD->RD_MAT + SRD->RD_DATARQ + _aTotal[013, 164, 1] ) )
				nValor := 0
			EndIf
		EndIf
	EndIf
ENDIF

RestArea( aAreaSRD )

Return( nValor )


Function GIARSQE( cOpc, dData)

Local nRef45 := 0	//Estoque Inicial Prop.,Trib., no Estab. E/ou Poder de Terc.
Local nRef46 := 0	//Estoque Inicial Prop,Isento/Nใo Trib, Estab E/ou Poder Terc.
Local nRef47 := 0	//Estoque Inicial Pertencente ao Estab. Em Poder de Terc
Local nRef48 := 0	//Estoque Inicial Pertencente a Terc. Em Poder do Estab
Local nRef49 := 0	//Estoque Final Prop.,Trib., no Estab. E/ou Poder de Terc
Local nRef50 := 0	//Estoque Final Prop,Isento/Nใo Trib, Estab E/ou Poder Terc.
Local nRef51 := 0	//Estoque Final Pertencente ao Estab. Em Poder de Terc.
Local nRef52 := 0	//Estoque Final Pertencente a Terc. Em Poder do Estab.
Local nEmTer := 0
Local nDeTer := 0
Local nX	 := 0
Local aEmTer := {}
Local aDeTer := {}
Local cAliasSB9	:= "SB9"
Local cAliasSB1	:= "SB1"
Local lTop	 := .F.

Default cOpc := "A"

DbSelectArea(cAliasSB1)
(cAliasSB1)->( DbsetOrder(1) )
DbSelectArea(cAliasSB9)
(cAliasSB9)->( DbsetOrder(1) )

DbSelectArea (cAliasSB9)
(cAliasSB9)->(DbSetOrder (1))
#IFDEF TOP
    If (TcSrvType ()<>"AS/400")
    	lTop	:= .T.
    	cAliasSB9	:=	GetNextAlias()

    	BeginSql Alias cAliasSB9

			COLUMN B9_DATA AS DATE

			SELECT
				SB9.B9_COD , SB9.B9_DATA, SB9.B9_LOCAL, SB9.B9_VINI1,
				SB1.B1_COD, SB1.B1_CLASFIS
			FROM
				%Table:SB9% SB9
				LEFT JOIN %Table:SB1% SB1 ON(SB1.B1_FILIAL=%xFilial:SB1%  AND SB1.B1_COD=SB9.B9_COD AND SB1.%NotDel%)
			WHERE
				SB9.B9_FILIAL=%xFilial:SB9% AND
				SB9.B9_DATA=%Exp:DToS(dData)% AND
				SB9.%NotDel%
			ORDER BY SB9.B9_COD
		EndSql
	Else
#ENDIF
	    cIndex	:= CriaTrab(NIL,.F.)
	    cFiltro	:= 'B9_FILIAL=="'+xFilial ("SB9")+'".And.'
	   	cFiltro += 'DToS (B9_DATA)=="'+DToS(dData)+'"'

	    IndRegua (cAliasSB9, cIndex, SB9->(IndexKey ()),, cFiltro)
	    nIndex := RetIndex(cAliasSB9)

		#IFNDEF TOP
			DbSetIndex (cIndex+OrdBagExt ())
		#ENDIF

		DbSelectArea (cAliasSB9)
	    DbSetOrder (nIndex+1)
#IFDEF TOP
	Endif
#ENDIF

If lTop
	cAliasSB1 := cAliasSB9
EndIf

DbSelectArea (cAliasSB9)
(cAliasSB9)->(DbGoTop())

While (cAliasSB9)->(!EoF())

	If !lTop
		(cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSB9)->B9_COD))
	EndIf
	If cOpc=="A"
		If Empty((cAliasSB1)->B1_CLASFIS) .Or. (cAliasSB1)->B1_CLASFIS $ "00/10/20/30/50/51/60/70"
			nRef45	+= (cAliasSB9)->B9_VINI1
		ElseIf (cAliasSB1)->B1_CLASFIS $ "40/41/90"
			nRef46	+= (cAliasSB9)->B9_VINI1
		EndIf
	ElseIf cOpc=="E"
		If Empty((cAliasSB1)->B1_CLASFIS) .Or. (cAliasSB1)->B1_CLASFIS $ "00/10/20/30/50/51/60/70"
			nRef49	+= (cAliasSB9)->B9_VINI1
		ElseIf (cAliasSB1)->B1_CLASFIS $ "40/41/90"
			nRef50	+= (cAliasSB9)->B9_VINI1
		EndIf
	EndIf
	(cAliasSB9)->(!DbSkip())

EndDo

// Saldo em terceito
aEmTer := SaldoTerc(Space(TamSX3("B1_COD")[1]),Space(TamSX3("B9_LOCAL")[1]),"T",dData,Replicate("Z",TamSX3("B9_LOCAL")[1]),,Replicate("Z",TamSX3("B1_COD")[1]))
If Len(aEmTer)>0 .And. Len(aEmTer[1])>0
	For nX := 1 to Len(aEmTer)
		nEmTer	+= aEmTer[nX][3]
	Next(nX)
EndIf

// Saldo de terceito
aDeTer := SaldoTerc(Space(TamSX3("B1_COD")[1]),Space(TamSX3("B9_LOCAL")[1]),"D",dData,Replicate("Z",TamSX3("B9_LOCAL")[1]),,Replicate("Z",TamSX3("B1_COD")[1]))
If Len(aDeTer)>0 .And. Len(aDeTer[1])>0
	For nX := 1 to Len(aDeTer)
		nDeTer	+= aDeTer[nX][3]
	Next(nX)
EndIf

If cOpc=="A"
	nRef47	:= nEmTer
	nRef48	:= nDeTer
Else
	nRef51	:= nEmTer
	nRef52	:= nDeTer
EndIf

Return {nRef45,nRef46,nRef47,nRef48,nRef49,nRef50,nRef51,nRef52}


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณDMSSAL    บAutor  ณGraziele Paro       บ Data ณ  16/01/2013 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณRetorna as informacoes dos Docs Fiscais recebebidos		  บฑฑ
ฑฑบ          ณna contrata็ใo de Subempreitadas para o servico e           บฑฑ
ฑฑบ          |Notas recebidas na compra de materiais para uso no servico  บฑฑ
ฑฑบ          |para a DMS de Salvador                                      บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ DMSSALCC.INI e DMSSALCN                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DMSSAL( dDataIni, dDataFin, TpServ, SubSer, cArq, aFilsCalc)
Local aCampos := {}
Local aCampos1 := {}
Local aCampos2 := {}
Local aCampos3 := {}
Local cQuery 	:= ""
Local cArqTrab 	:= ""
Local cArqTrab1 := ""
Local cArqTrab2 := ""
Local cArqTrab3 := ""
Local cAliasSF2	:= "SF2"
Local cAliasSC5	:= "SC5"
Local cAliasCE2	:= "CE2"
Local cAliasSF1	:= "SF1"
Local cAliasSA2	:= "SA2"
Local cAliasSA1	:= "SA1"
Local cAliasSC6	:= "SC6"
Local lTop	 := .F.
Local cPrefixo := ""
Local lLocTitIss :=.F.
Local lLocTit := .F.
Local cIss:= MVISS
Local lAchouSD1 := .F.
Local lAchouSE2 := .F.
Local lAchouSB5 := .F.
Local nAliqISS := 0
Local nValIss := 0
Local cDataBaixa := ""
Local cFornecTit := ""
Local cMunic:= ""
Local cProduto := ""
Local cWhere:= ""
Local cCFOP := ""
Local cTpSev := ""
Local cSelect := ""
Local nForFilial:= 0
Local cFilOrig	:= cFilAnt
Default aFilsCalc:= { { .T., cFilAnt } }

//VETOR COM A ESTRUTURA DA TABELA TEMPORARIA -COMPRA DE MATERIAIS PARA USO NO SERVICO
aadd(aCampos,{"EMISSAO",   'C',10,0})
aadd(aCampos,{"SERIE", 	'C',05,0})
aadd(aCampos,{"SUBSERIE", 	'C',05,0})
aadd(aCampos,{"NUMERONF",	'C',10,0})
aadd(aCampos,{"VALOR",  	'N',15,0})
aadd(aCampos,{"CNPJ", 		'C',14,0})
aadd(aCampos,{"SITUAC", 	'C',01,0})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"ABC",.F.,.F.)
IndRegua( "ABC", cArqTrab,"EMISSAO+SERIE+SUBSERIE+NUMERONF")
dbSelectArea("ABC")

//VETOR COM A ESTRUTURA DA TABELA TEMPORARIA - DOCS RECEBIDOS CONTRATACAO DE SUBEMPREITADAS PARA O SERVICO
aadd(aCampos1,{"EMISSAO",   'C',10,0})
aadd(aCampos1,{"SERIE", 	 'C',05,0})
aadd(aCampos1,{"SUBSERIE", 	'C',05,0})
aadd(aCampos1,{"NUMERONF",	'C',10,0})
aadd(aCampos1,{"TIPONF",  	'C',02,0})
aadd(aCampos1,{"VALOR",  	'N',15,0})
aadd(aCampos1,{"ISSRETIDO",	'C',01,0})
aadd(aCampos1,{"ALIQISS", 	'N',04,0})
aadd(aCampos1,{"VALORISS", 	'N',15,0})
aadd(aCampos1,{"CNPJ", 		'C',15,0})
aadd(aCampos1,{"MUNIC",    	'C',03,0})
aadd(aCampos1,{"DATARET",  'C',10,0})
aadd(aCampos1,{"SIMPLES",   'C',01,0})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab1 :=CriaTrab(aCampos1,.T.)
dbUseArea(.T.,,cArqTrab1,"RET",.F.,.F.)
IndRegua( "RET", cArqTrab1, "EMISSAO+SERIE+SUBSERIE+NUMERONF")
dbSelectArea("RET")

//VETOR COM A ESTRUTURA DA TABELA TEMPORARIA -COMPRA DE MATERIAIS PARA USO NO SERVICO
aadd(aCampos2,{"EMISSAO",   'C',10,0})
aadd(aCampos2,{"SERIE", 	'C',05,0})
aadd(aCampos2,{"SUBSERIE", 	'C',05,0})
aadd(aCampos2,{"NUMERONF",	'C',10,0})
aadd(aCampos2,{"VALOR",  	'N',15,0})
aadd(aCampos2,{"CNPJ", 		'C',14,0})
aadd(aCampos2,{"VALAPLIC", 	'N',15,0})
aadd(aCampos2,{"SITUAC", 	'C',01,0})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab2 :=CriaTrab(aCampos2,.T.)
dbUseArea(.T.,,cArqTrab2,"DEF",.F.,.F.)
IndRegua( "DEF", cArqTrab2,"EMISSAO+SERIE+SUBSERIE+NUMERONF")
dbSelectArea("DEF")

//VETOR COM A ESTRUTURA DA TABELA TEMPORARIA - DOCS RECEBIDOS CONTRATACAO DE SUBEMPREITADAS PARA O SERVICO
aadd(aCampos3,{"EMISSAO",   'C',10,0})
aadd(aCampos3,{"SERIE", 	 'C',05,0})
aadd(aCampos3,{"SUBSERIE", 	'C',05,0})
aadd(aCampos3,{"NUMERONF",	'C',10,0})
aadd(aCampos3,{"TIPONF",  	'C',02,0})
aadd(aCampos3,{"VALOR",  	'N',15,0})
aadd(aCampos3,{"ISSRETIDO",	'C',01,0})
aadd(aCampos3,{"ALIQISS", 	'N',04,0})
aadd(aCampos3,{"VALORISS", 	'N',15,0})
aadd(aCampos3,{"CNPJ", 		'C',15,0})
aadd(aCampos3,{"MUNIC",    	'C',03,0})
aadd(aCampos3,{"DATARET",  'C',10,0})
aadd(aCampos3,{"VALAPLIC", 	'N',15,0})
aadd(aCampos3,{"SIMPLES",   'C',01,0})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab3 :=CriaTrab(aCampos3,.T.)
dbUseArea(.T.,,cArqTrab3,"GHI",.F.,.F.)
IndRegua( "GHI", cArqTrab3, "EMISSAO+SERIE+SUBSERIE+NUMERONF")
dbSelectArea("GHI")

dbSelectArea("SD2")
SD2->(DbSetOrder(3))
dbSelectArea("SD1")
SD1->(DbSetOrder(1))
dbSelectArea("CC2")
CC2->(DbSetOrder(1))
dbSelectArea("SE2")
SE2->(DbSetOrder (1))
dbSelectArea("CE2")
CE2->(DbSetOrder (1))
dbSelectArea("SF1")
SF1->(DbSetOrder (1))
dbSelectArea("SA2")
SA2->(DbSetOrder (1))
dbSelectArea("SA1")
SA1->(DbSetOrder (1))
DbselectArea("SC6")
SC6->(DbSetOrder(4))

If cArq == "DMSSALCC"
	If  SubSer == "CS"
		cWhere := "%SA1.A1_COD_MUN ='27408'%"
	Else
		cWhere := "% SA1.A1_COD_MUN <>'27408'%"
	Endif
Else
	cWhere := "%1=1%"
Endif

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]

		#IFDEF TOP
		If (TcSrvType ()<>"AS/400")
			lTop	:= .T.
			cAliasSF2	:=	GetNextAlias()

			If SerieNfId("SF1",3,"F1_SERIE") <> "F1_SERIE" .And. PaisLoc $ "BRA|MEX"
				cSelect := "% ,SF1.F1_SDOC, SC5.C5_MUNPRES %"
			ElseIf SerieNfId("SF1",3,"F1_SERIE") <> "F1_SERIE" .And. !PaisLoc $ "BRA|MEX"
				cSelect := "% ,SF1.F1_SDOC %"
			Else
			    cSelect := "%%"
			EndIf

	    	BeginSql Alias cAliasSF2

				COLUMN F2_EMISSAO AS DATE
				COLUMN F1_EMISSAO AS DATE

				SELECT SF2.F2_DOC,
				       SF2.F2_SERIE,
				       SF2.F2_EMISSAO,
				       SF2.F2_CLIENTE,
				       SF2.F2_LOJA,
				       SF2.F2_VALISS,
				       SC5.C5_NUM,
				       SC5.C5_CLIENTE,
				       SC5.C5_FORNISS,
				       SC5.C5_NOTA,
				       SC5.C5_SERIE,
				       CE2.CE2_NUMPV,
				       CE2.CE2_DOCNF,
				       CE2.CE2_SERINF,
				       CE2.CE2_DTDIGT,
				       CE2.CE2_ABTSER,
			           CE2.CE2_ABTMAT,
			           CE2.CE2_PRODPV,
				       SF1.F1_FILIAL,
				       SF1.F1_EMISSAO,
				       SF1.F1_DOC,
				       SF1.F1_SERIE,
	                   SF1.F1_NFELETR,
	                   SF1.F1_LOJA,
	                   SF1.F1_DUPL,
	                   SF1.F1_PREFIXO,
	                   SF1.F1_ISS,
	                   SF1.F1_VALMERC,
	                   SC5.C5_MUNPRES,
	                   SC5.C5_DESCMUN,
	                   SA2.A2_RECISS,
	                   SA2.A2_NATUREZ,
	                   SA2.A2_CGC,
	                   SA2.A2_SIMPNAC,
	                   SA1.A1_COD,
	                   SA1.A1_COD_MUN,
	                   SA1.A1_EST
				       %EXP:cSelect%
				FROM
				    %TABLE:SF2% SF2
				    INNER JOIN %TABLE:SC5% SC5 ON(SF2.F2_DOC = SC5.C5_NOTA AND SF2.F2_SERIE = SC5.C5_SERIE)
				    INNER JOIN %TABLE:CE2% CE2 ON(CE2.CE2_NUMPV = SC5.C5_NUM)
				    INNER JOIN %TABLE:SF1% SF1 ON(SF1.F1_DOC = CE2_DOCNF)
				    INNER JOIN %TABLE:SA2% SA2 ON(CE2.CE2_FORNNF = SA2.A2_COD AND CE2.CE2_LOJANF = SA2.A2_LOJA)
				    INNER JOIN %TABLE:SA1% SA1 ON(SF2.F2_CLIENTE = SA1.A1_COD AND SF2.F2_LOJA = SA1.A1_LOJA)
				WHERE
					SF2.F2_FILIAL=%XFILIAL:SF2%
	       			AND SC5.C5_FILIAL=%XFILIAL:SC5%
	       			AND CE2.CE2_FILIAL=%XFILIAL:CE2%
	       			AND SA2.A2_FILIAL=%XFILIAL:SA2%
	       			AND SF1.F1_FILIAL=%XFILIAL:SF1%
	       			AND SF2.%NOTDEL%
	       			AND SC5.%NOTDEL%
	       			AND CE2.%NOTDEL%
	       			AND SA2.%NOTDEL%
	       			AND SF1.%NOTDEL%
	       			AND SF2.F2_EMISSAO >= %EXP:DTOS(DDATAINI)%
	       			AND SF2.F2_EMISSAO <= %EXP:DTOS(DDATAFIN)%
	       			AND %EXP:cWhere%
				ORDER BY SF2.F2_EMISSAO
			EndSql
			DbSelectArea (cAliasSF2)
			(cAliasSF2)->(DbGoTop())
		Else
		#ENDIF
		cIndex	:= CriaTrab(NIL,.F.)
		cFiltro	:= 'F2_FILIAL=="'+xFilial ("SF2")+'".And.'
		cFiltro += 'DTOS (F2_EMISSAO)>="'+DTOS(DDATAINI)+'" .And. '
		cFiltro += 'DTOS (F2_EMISSAO)<="'+DTOS(DDATAFIN)+'"'

		IndRegua (cAliasSF2, cIndex, SF2->(IndexKey ()),, cFiltro)
		nIndex := RetIndex(cAliasSF2)

		#IFNDEF TOP
			DbSetIndex (cIndex+OrdBagExt ())
		#ENDIF

		DbSelectArea (cAliasSF2)
		DbSetOrder (nIndex+1)
		#IFDEF TOP
		Endif
		#ENDIF


		If lTop
			cAliasSC5	:= cAliasSF2
			cAliasCE2	:= cAliasSF2
			cAliasSF1	:= cAliasSF2
			cAliasSA2	:= cAliasSF2
			cAliasSA1	:= cAliasSF2
			cAliasSC6   := cAliasSF2
		EndIf

		DbSelectArea (cAliasSF2)
		(cAliasSF2)->(DbGoTop())

		While (cAliasSF2)->(!EOF())

			IF !lTop
				(cAliasSC6)->(MsSeek(xFilial("SC6")+(cAliasSF2)->F2_DOC+(cAliasSF2)->F2_SERIE))
				(cAliasSC5)->(MsSeek(xFilial("SC5")+(cAliasSC6)->C6_NUM))
				(cAliasCE2)->(MsSeek(xFilial("CE2")+ (cAliasSC5)->C5_NUM))
				(cAliasSF1)->(MsSeek(xFilial("SF1")+ (cAliasCE2)->CE2_DOCNF))
				(cAliasSA2)->(MsSeek(xFilial("SA2")+ (cAliasCE2)->CE2_FORNNF + (cAliasCE2)->CE2_LOJANF))
				(cAliasSA1)->(MsSeek(xFilial("SA1")+ (cAliasSF2)->F2_CLIENTE + (cAliasSF2)->F2_LOJA))
			ENDIF

			lLocTitIss :=.F.
			cPrefixo:= IIf(Empty((cAliasSF1)->F1_PREFIXO),&(SuperGetMV("MV_2DUPREF")),(cAliasSF1)->F1_PREFIXO)
			cPrefixo:= Padr(cPrefixo,TamSx3('E2_PREFIXO')[1])

			lAchouSE2 := SE2->(DbSeek(xFilial("SE2")+cPrefixo+(cAliasSF1)->F1_DUPL))
			If cPaisLoc $ "ANG|BRA|CHI|COL|COS|DOM|EQU|HAI|MEX|PER|PTG|VEN"
				dbSelectArea("CC2")
				CC2->(DbSetOrder(1))

				IF	CC2->(DbSeek(xFilial("CC2")+(cAliasSA1)->A1_EST+(cAliasSA1)->A1_COD_MUN))
					cMunic:= CC2->CC2_MUN
				EndIf
			EndIf

			While  lAchouSE2 .And. SE2->(!eof()).And. (xFilial("SE2")+cPrefixo+(cAliasSF1)->F1_DUPL==SE2->E2_FILIAL+SE2->E2_PREFIXO+SE2->E2_NUM)
				lLocTit := .T.
	       		If SE2->E2_TIPO ==cIss
			    	nValIss := SE2->E2_VALOR
			       	cDataBaixa := SE2->E2_BAIXA
			       	cFornecTit := SE2->E2_FORNECE
	       			lLocTitIss :=.T.
				Endif
				SE2->(dbSkip())
			EndDo

			lAchouSD1 := SD1->(DbSeek(xFilial("SD1")+(cAliasSF1)->F1_DOC+(cAliasSF1)->F1_SERIE))

			While lAchouSD1 .And. SD1->(!EOF())  .And. (xFilial("SD1")+(cAliasSF1)->F1_DOC+(cAliasSF1)->F1_SERIE==SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE)
				If SD1->D1_ALIQISS >0 .And. SD1->D1_BASEISS >0 .And. SD1->D1_LOJA == (cAliasSF1)->F1_LOJA
					nAliqISS:=SD1->D1_ALIQISS
					cCFOP := SD1->D1_CF
				Endif
				SD1->(dbSkip())
			Enddo

			lAchouSD2 := SD2->(DbSeek(xFilial("SD2")+(cAliasSF2)->F2_DOC+(cAliasSF2)->F2_SERIE+(cAliasSF2)->F2_CLIENTE+(cAliasSF2)->F2_LOJA))
			If lAchouSD2 .And. SB5->(DbSeek(xFilial("SB5")+SD2->D2_COD))
				If cPaisLoc == "BRA"
					cTpSev:= SB5->B5_TPSERV
				EndIf
				lAchouSB5 := .T.
			EndIf

	       	If  lLocTit .And. lLocTitIss

	       	    If cArq == "DMSSALCC" .And. ((lAchouSB5 .And. cTpSev == "1") .Or. (!lAchouSB5))
		       	    // Se for Contrucao Civil e Reforma
			   		RecLock("RET",.T.)
					RET->EMISSAO := StrZero(Day ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Month ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Year ((cAliasSF1)->F1_EMISSAO), 4)
					RET->SERIE   := Iif(!Empty((cAliasSF1)->F1_NFELETR) .AND. "1"$ SerieNfId( cAliasSF1 ,2,"F1_SERIE"),"A", SerieNfId( cAliasSF1 ,2,"F1_SERIE") )
					RET->SUBSERIE :=Space (05)
					RET->NUMERONF :=StrZero (Val((cAliasSF1)->F1_DOC), 10)
					RET->TIPONF := IIF(!Empty((cAliasSF1)->F1_NFELETR),"12","01")
					RET->VALOR := (cAliasSF1)->F1_ISS*100
					RET->ISSRETIDO := IIF(lLocTitIss,"S","N")
					RET->ALIQISS := IIF(lLocTitIss,	nAliqISS*100,0)
					RET->VALORISS := IIF(lLocTitIss,nValIss*100,0)
					RET->CNPJ := StrZero (Val ((cAliasSA2)->A2_CGC), 15)
					RET->MUNIC := IIF(cMunic$"SALVADOR","SSA","OUT")
					RET->DATARET := IIF(lLocTitIss,StrZero(Day(cDataBaixa), 2)+"/"+StrZero (Month (cDataBaixa), 2)+"/"+StrZero (Year (cDataBaixa), 4),Space (10))

					If Empty((cAliasSA2)->a2_simpnac)
					   RET->SIMPLES := "N"
					Elseif (cAliasSA2)->a2_simpnac  == "1"
					   RET->SIMPLES := "S"
					Else
					   RET->SIMPLES := "N"
					Endif

		 			RET->(MSunlock())
		 		Elseif cArq == "DMSSALCN" .And.(lAchouSB5 .And. cTpSev == "2")
		 			// Concretagem
		 			RecLock("GHI",.T.)
					GHI->EMISSAO := StrZero(Day ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Month ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Year ((cAliasSF1)->F1_EMISSAO), 4)
					GHI->SERIE   := Iif(!Empty((cAliasSF1)->F1_NFELETR) .AND. "1"$ SerieNfId( cAliasSF1 ,2,"F1_SERIE"),"A", SerieNfId( cAliasSF1 ,2,"F1_SERIE") )
					GHI->SUBSERIE :=Space (05)
					GHI->NUMERONF :=StrZero (Val ((cAliasSF1)->F1_DOC), 10)
					GHI->TIPONF := IIF(!Empty((cAliasSF1)->F1_NFELETR),"12","01")
					GHI->VALOR := (cAliasSF1)->F1_ISS*100
					GHI->ISSRETIDO := IIF(lLocTitIss,"S","N")
					GHI->ALIQISS := IIF(lLocTitIss,	nAliqISS*100,0)
					GHI->VALORISS := IIF(lLocTitIss,nValIss*100,0)
					GHI->CNPJ := StrZero (Val ((cAliasSA2)->A2_CGC), 15)
					GHI->MUNIC := IIF(cMunic$"SALVADOR","SSA","OUT")
					GHI->DATARET := IIF(lLocTitIss,StrZero(Day(cDataBaixa), 2)+"/"+StrZero (Month (cDataBaixa), 2)+"/"+StrZero (Year (cDataBaixa), 4),Space (10))
					GHI->VALAPLIC:=0

					If Empty((cAliasSA2)->a2_simpnac)
					    GHI->SIMPLES := "N"
					Elseif (cAliasSA2)->a2_simpnac  == "1"
					   GHI->SIMPLES := "S"
					Else
					   GHI->SIMPLES := "N"
					Endif

		 			GHI->(MSunlock())
		 		 EndIf
	 		Endif

	 		If lLocTit .And. !lLocTitIss .And. (cAliasSF1)->F1_ISS <= 0
	 		    If cArq == "DMSSALCC" .And. ((lAchouSB5 .And. cTpSev == "1") .Or. (!lAchouSB5))
		 		     // Se for Contrucao Civil e Reforma
			 		RecLock("ABC",.T.)
			 		ABC->EMISSAO := StrZero(Day ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Month ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Year ((cAliasSF1)->F1_EMISSAO), 4)
					ABC->SERIE   :=Iif(!Empty((cAliasSF1)->F1_NFELETR) .AND. "1"$ SerieNfId( cAliasSF1 ,2,"F1_SERIE"),"A", SerieNfId( cAliasSF1 ,2,"F1_SERIE") )
			 		ABC->SUBSERIE := Space (05)
			 		ABC->NUMERONF :=StrZero (Val ((cAliasSF1)->F1_DOC), 10)
			 		ABC->VALOR   := (cAliasSF2)->F2_VALISS*100
			 		ABC->CNPJ    := StrZero (Val ((cAliasSA2)->A2_CGC), 14)
			 		ABC->SITUAC  := IIF(cCFOP$"1151/1152/1154", "T", "A")
			 		ABC->(MSunlock())
			  	Elseif cArq == "DMSSALCN" .And.(lAchouSB5 .And. cTpSev == "2")
			 		// Concretagem
			 		RecLock("DEF",.T.)
			 		DEF->EMISSAO := StrZero(Day ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Month ((cAliasSF1)->F1_EMISSAO), 2)+"/"+StrZero (Year ((cAliasSF1)->F1_EMISSAO), 4)
					DEF->SERIE   := Iif(!Empty((cAliasSF1)->F1_NFELETR) .AND. "1"$ SerieNfId( cAliasSF1 ,2,"F1_SERIE"),"A", SerieNfId( cAliasSF1 ,2,"F1_SERIE") )
			 		DEF->SUBSERIE := Space (05)
			 		DEF->NUMERONF :=StrZero (Val ((cAliasSF1)->F1_DOC), 10)
			 		DEF->VALOR   := (cAliasSF2)->F2_VALISS*100
			 		DEF->CNPJ    := StrZero (Val ((cAliasSA2)->A2_CGC), 14)
			 		DEF->VALAPLIC := 0
			 		DEF->SITUAC  := IIF(cCFOP$"1151/1152/1154", "T", "A")
			 		DEF->(MSunlock())
			 	Endif
	 		EndIf
	 		(cAliasSF2)->(dbSkip())
 		EndDo

	EndIf

Next
cFilAnt := cFilOrig

Return

//-------------------------------------------------------------------
/*/{Protheus.doc} xMagGetCon
Funcao que valida conteudo digitado nos campos da wizard, conforme
parametros enviados

@param  nOpc  		- 	Opcao que sera validada com os tipos que serao aceitos
						Para cada campo podera selecionar se ira permitir apenas
						alphanumerico, numerico, etc
		nTpContObj  - 	Tipo do conteudo (caracter, numerico, data)
		aObj  		- 	Objeto que esta sendo validado (conteudo do campo)

@return lRet -	Conteudo validado ou nao. Se o conteudo nao for aceito, apresenta
				mensagem de erro e mantem o foco no preenchimento do mesmo campo

@author Luccas Curcio
@since 04/03/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function xMagGetCon(nOpc,nTpContObj,aObj)
Local	lRet	:=	.T.
Local	nX		:=	0
Local	cChrNum	:=	""
Local	cContent:=	Iif( ValType( aObj[1] ) == "D" , Alltrim( DToS( aObj[1] ) ) , Alltrim( aObj[1] ) )
Local	cCharAux:=	""
Local	lTypeChr:=	ValType(cContent) == "C"

If !Empty(cContent)

	//Verifica caracter por caracter
	For nX := 1 To Len(cContent)

		cChrNum	:=	Iif( lTypeChr, Substr(cContent,nX,1), Str(Substr(cContent,nX,1)) )

		//Valida objeto do tipo caracter
		If nTpContObj == 1

			//Para a opcao 1, o conteudo devera ser alphanumerico
			If nOpc == 1

				If !(lRet := (IsAlpha(cChrNum) .Or. IsDigit(cChrNum) ) )
					Exit
				Endif

			//Para a opcao 2, o conteudo devera ser apenas letras
			Elseif nOpc == 2

				If !(lRet := IsAlpha(cChrNum) .Or. cChrNum == " "  )
					Exit
				Endif

			//Para a opcao 3, o conteudo devera ser numerico
			Elseif nOpC == 3

				If !(lRet := IsDigit(cChrNum) )
					Exit
				Endif

			//Para a opcao 4, o conteudo devera ser alphanumerico ou "*" (Livros Fiscais)
			Elseif nOpC == 4

				If !(lRet := (IsAlpha(cChrNum) .Or. IsDigit(cChrNum) .Or. cChrNum == "*" ) )
					Exit
				Endif

			Endif

		//Valida objeto do tipo data
		Elseif nTpContObj == 3

			cCharAux	+=	cChrNum

		Endif
	Next nX
Endif

If !lRet
	MsgInfo("Campo preenchido com conte๚do invแlido")
Elseif nTpContObj == 3
	If Empty(cCharAux)
		lRet	:=	.F.
		MsgInfo("Campo data nใo preenchido")
	Endif
Endif

Return lRet

//-------------------------------------------------------------------
/*/{Protheus.doc} GIARSLanc
Busca os valores de cr้dito presumido e D้bitos de responsabilidade dos lan็amentos da CDA para
GIARS
parametros enviados

@param  dDataIni  	- 	Data Final
		dDataFin	- 	Data Inicial
		cAlias  	- 	Alias de Cr้dito Presumido
		nQARef10	- Valor da Referencia 10 do Quadro A

@return lRet -	Executou sem erro algum

@author Caio Oliveira
@since 30/03/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function GIARSLanc( dDataIni, dDataFin,  cAlias, nCRP, nQARef10)

Local lRet 		:= .T.
Local cFiltro 	:= ""
Local cIndex	:= ""
Local nIndex	:= 0
Local lTop		:= .F.
Local cAliasSFT := "SFT"
Local cAliasSD1 := "SD1"
Local cAliasSD2 := "SD2"
Local cAliasSF4 := "SF4"
Local cAliasCDA := "CDA"
Local cTabela	:= ""

DbSelectArea(cAliasSD1)
(cAliasSD1)->( DbsetOrder(1) )
DbSelectArea(cAliasSD2)
(cAliasSD2)->( DbsetOrder(1) )
DbSelectArea(cAliasSF4)
(cAliasSF4)->( DbsetOrder(1) )
DbSelectArea(cAliasCDA)
(cAliasCDA)->( DbsetOrder(1) )
DbSelectArea(cAliasSFT)
(cAliasSFT)->( DbsetOrder(1) )


If lRet
	#IFDEF TOP
	    If (TcSrvType ()<>"AS/400")
	    	lTop	:= .T.
	    	cAliasSFT	:=	GetNextAlias()

	    	BeginSql Alias cAliasSFT

				COLUMN FT_ENTRADA AS DATE
				COLUMN FT_DTCANC  AS DATE

				SELECT
					SFT.FT_ENTRADA, SFT.FT_TIPOMOV, SFT.FT_FORMUL, SFT.FT_ESPECIE, SFT.FT_NFISCAL ,  SFT.FT_SERIE , SFT.FT_CLIEFOR , SFT.FT_LOJA, SFT.FT_ITEM, SFT.FT_CFOP,
					CDA.CDA_TPMOVI, CDA.CDA_ESPECI, CDA.CDA_FORMUL, CDA.CDA_NUMERO, CDA.CDA_SERIE, CDA.CDA_CLIFOR, CDA.CDA_LOJA, CDA.CDA_NUMITE, CDA.CDA_CODLAN,CDA.CDA_BASE,CDA.CDA_ALIQ,CDA.CDA_VALOR, CDA.CDA_TPLANC,
					SF4.F4_CODIGO, SF4.F4_TABGIAC, SF4.F4_TABGIAI, SF4.F4_TABGIAO
				FROM
					%Table:SFT% SFT
					JOIN %Table:CDA% CDA ON( CDA.CDA_FILIAL=%xFilial:CDA% AND CDA.CDA_TPLANC='2' AND CDA.CDA_TPMOVI=SFT.FT_TIPOMOV  AND CDA.CDA_ESPECI=SFT.FT_ESPECIE AND CDA.CDA_NUMERO=SFT.FT_NFISCAL AND CDA.CDA_SERIE=SFT.FT_SERIE AND CDA.CDA_CLIFOR=SFT.FT_CLIEFOR AND CDA.CDA_LOJA=SFT.FT_LOJA AND CDA.%NotDel%)
					LEFT JOIN %Table:SD1% SD1 ON(SFT.FT_TIPOMOV='E' AND SD1.D1_FILIAL=%xFilial:SD1% AND SD1.D1_DOC=SFT.FT_NFISCAL AND SD1.D1_SERIE=SFT.FT_SERIE AND SD1.D1_FORNECE=SFT.FT_CLIEFOR AND SD1.D1_LOJA=SFT.FT_LOJA AND SD1.D1_COD=SFT.FT_PRODUTO AND SD1.D1_ITEM=SFT.FT_ITEM AND SD1.%NotDel%)
					LEFT JOIN %Table:SD2% SD2 ON(SFT.FT_TIPOMOV='S' AND SD2.D2_FILIAL=%xFilial:SD2% AND SD2.D2_DOC=SFT.FT_NFISCAL AND SD2.D2_SERIE=SFT.FT_SERIE AND SD2.D2_CLIENTE=SFT.FT_CLIEFOR AND SD2.D2_LOJA=SFT.FT_LOJA AND SD2.D2_COD=SFT.FT_PRODUTO AND SD2.D2_ITEM=SFT.FT_ITEM AND SD2.%NotDel%)
					JOIN %Table:SF4% SF4 ON(SF4.F4_FILIAL=%xFilial:SF4% AND SF4.%NotDel% AND ( (SFT.FT_TIPOMOV='E' AND SF4.F4_CODIGO=SD1.D1_TES) OR (SFT.FT_TIPOMOV='S' AND SF4.F4_CODIGO=SD2.D2_TES) ) )
				WHERE
					SFT.FT_FILIAL=%xFilial:SFT% AND
					SFT.FT_ENTRADA>=%Exp:DToS(dDataIni)% AND
					SFT.FT_ENTRADA<=%Exp:DToS(dDataFin)% AND
					SFT.FT_DTCANC = %Exp:Dtos(Ctod(''))% AND
					SFT.%NotDel%
				ORDER BY %Order:SFT%
			EndSql
		Else
	#ENDIF
			cIndex	:= CriaTrab(NIL,.F.)
			cFiltro	:= 'FT_FILIAL=="'+xFilial ("SFT")+'".And.'
			cFiltro += 'DToS (FT_ENTRADA)>="'+DToS(dDataIni)+'".And.'
			cFiltro += 'DToS (FT_ENTRADA)<="'+DToS(dDataFin)+'".And.'
			cFiltro += 'Empty(FT_DTCANC)'
			IndRegua (cAliasSFT, cIndex, SFT->(IndexKey ()),, cFiltro)
			nIndex := RetIndex(cAliasSFT)
			#IFNDEF TOP
				DbSetIndex (cIndex+OrdBagExt ())
			#ENDIF
			DbSelectArea (cAliasSFT)
			DbSetOrder (nIndex+1)
	#IFDEF TOP
		Endif
	#ENDIF

	If lTop
		cAliasSF4 := cAliasSD1 :=  cAliasSD2 := cAliasCDA := cAliasSFT
	EndIf

	DbSelectArea (cAliasSFT)
	(cAliasSFT)->(DbGoTop())

	While (cAliasSFT)->(!EoF())

		If !lTop
			If !(cAliasCDA)->(MsSeek(xFilial("CDA")+(cAliasSFT)->(FT_TIPOMOV+FT_ESPECIE+Iif(Empty(FT_FORMUL),'S',FT_FORMUL)+FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA)))
				(cAliasSFT)->( DbSkip() )
				Loop
			ElseIf (cAliasSFT)->FT_TIPOMOV=="E"
				If 	!(cAliasSD1)->(MsSeek(xFilial("SD1")+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA+(cAliasSFT)->FT_PRODUTO+(cAliasSFT)->FT_ITEM)) .Or.;
					!(cAliasSF4)->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
					(cAliasSFT)->( DbSkip() )
					Loop
				EndIf
			Else
				If 	!(cAliasSD2)->(MsSeek(xFilial("SD2")+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA+(cAliasSFT)->FT_PRODUTO+(cAliasSFT)->FT_ITEM)) .Or.;
					!(cAliasSF4)->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))
					(cAliasSFT)->( DbSkip() )
					Loop
				EndIf
			EndIf
		EndIf

		If (cAliasSFT)->FT_TIPOMOV =="E"
			If (cAliasCDA)->CDA_CODLAN$"RS10009269/RS10009314/RS10009223" //Cr้dito presumido
		      	cTabela := StrZero(Val((cAliasSF4)->F4_TABGIAC),TamSx3("F4_TABGIAC")[1])
				nCRP += (cAliasCDA)->CDA_VALOR

				If (cAlias)->(MsSeek(AllTrim(cTabela)))
					RecLock(cAlias,.F.)
				Else
				    RecLock(cAlias,.T.)
					(cAlias)->TABELA	:= AllTrim(cTabela)
				EndIf
				(cAlias)->CRDPRES		+= (cAliasCDA)->CDA_VALOR
				(cAlias)->(MsUnlock())
	        EndIf
	    Else
	    	If (cAliasCDA)->CDA_CODLAN$"RS40000010/RS40001010" //D้bito de Responsabilidade
	    		nQARef10+= (cAliasCDA)->CDA_VALOR
	    	EndIf
	    EndIf

		(cAliasSFT)->( DbSkip())

	EndDo

EndIf

Return lRet

//-------------------------------------------------------------------
/*/{Protheus.doc} xMagChkID
Funcao que valida Informacoes de Identificacao do Contribuinte
(Mesmo tratamento do SpedXFun)

@param  cInsc	->	Inscricao
		lContr	->	Indica se retorna a palavra ISENTO
		lIsent	->	Indica tratamento para Isento

@return cRet	-> String convertida

@author Luccas Curcio
@since 02/04/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function xMagChkID(cInsc,lContr,lIsent)
Local		cRet	:=	""
Local		nI		:=	1
Default		lContr	:=	.T.
Default		lIsent	:=	.T.

For nI := 1 To Len(cInsc)

	If Isdigit(Subs(cInsc,nI,1)) .Or. IsAlpha(Subs(cInsc,nI,1))
		cRet	+=	Subs(cInsc,nI,1)
	Endif

Next

cRet	:=	AllTrim(cRet)

If lIsent

	If "ISENT" $ Upper(cRet)
		cRet := ""
	EndIf

	If !(lContr) .And. !Empty(cRet)
		cRet := "ISENTA"
	EndIf

EndIf

Return cRet

//-------------------------------------------------------------------
/*/{Protheus.doc} xMagConType
Funcao que converte e formata string (copiada do NFeSefaz)

@param  xValor	->	Conteudo a ser convertido
		nTam	->	Tamanho a ser retornado

@return cRet	-> String convertida

@author Luccas Curcio
@since 02/04/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function xMagConType(xValor,nTam)
Local	cRet	:=	""

If nTam==Nil
	xValor := AllTrim(xValor)
EndIf

Default	nTam	:= 60

cRet := AllTrim(EnCodeUtf8(NoAcento(SubStr(xValor,1,nTam))))

Return cRet

//-------------------------------------------------------------------
/*/{Protheus.doc} xMagLeReg

Funcao que le o registro e retorna o conteudo do campo desejado conforme
parametros informados

@param	cReg	->	Registro que sera lido
		nCampo	->	Campo que deseja retornar o conteudo
		lSepar	->	Separador de campos do registro

@return

@author Luccas Curcio
@since 26/03/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function xMagLeReg( cReg , nCampo , lSepar , lIncPipe)
Local	nPosCmp	:=	0
Local	nY		:=	0
Local	nX		:=	0
Local	nCont	:=	0
Local	cRet	:=	""
Local	cAlpha	:=	""
Local	cRegAux	:=	""
Default	lSepar	:=	"|"

If lIncPipe
	cRegAux	:=	lSepar + cReg
Endif

For nY := 1 To Len(cRegAux)

	If (cAlpha := Substr(cRegAux,nY,1) ) == lSepar
		nCont	+=	1
	Endif

	If nCont == nCampo
		nPosCmp	:=	nY + 1

		For nX := nPosCmp To Len(cRegAux)
			If (cAlpha := Substr(cRegAux,nX,1) ) == lSepar
				Exit
			Endif
			cRet += cAlpha
		Next nX
		Exit
	Endif
Next nY

Return cRet

//-------------------------------------------------------------------
/*/{Protheus.doc} SX1DAPIMG
Inclui perguntas na SX1 para gera็ใo da DAPIMG.
@param
@return
@author Alexis Duarte
@since 30/04/2013
@version 1.0
/*/
//-------------------------------------------------------------------
Function SX1DAPIMG()

// Removemos a fun็ใo EngSX1117 para corre็ใo de debitos tecnico, mas mantemos a fun็ใo  SX1DAPIMG para evitar errorlog para os clientes que nใo atualizeram o dapimg.ini com a versใo sem a fun็ใo SX1DAPIMG

Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณCSLL036   บAutor  ณMarcio Nuness       บ Data ณ  06/05/2013 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณProcessa valores de Imposto de renda retido CSLL para       บฑฑ
ฑฑบ          ณgerar o registro R36 que serแ importado via programa        บฑฑ
ฑฑบ          |validador do PER/DCOMP.                                     บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CSLL036(dDataIni,dDataFin,aFilsCalc)

Local cAliasSE5		:= "SE5"
Local cAliasSE1		:= "SE1"
Local cAliasSA1		:= "SA1"
Local cCampos		:= ""
Local cReceita		:= ""
Local lTop			:= .F.
Local aCampos		:= {}
Local nForFilial:= 0
Local cFilOrig	:= cFilAnt
Default aFilsCalc:= { { .T., cFilAnt } }


//Array com campo da tabela temporแria
aadd(aCampos,{"CNPJDE"		,'C'	,14	,0})
aadd(aCampos,{"DTINI"		,'C'	,08	,0})
aadd(aCampos,{"DTFIN"		,'C'	,08	,0})
aadd(aCampos,{"CNPJFPAG"	,'C'	,14	,0})
aadd(aCampos,{"CODRECEITA"	,'C'	,04	,0})
aadd(aCampos,{"VARIACAO"	,'C'	,01	,0})
aadd(aCampos,{"RETORGPUB"	,'C'	,01	,0})
aadd(aCampos,{"VALOR"		,'N'	,15	,2})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"CSL",.F.,.F.)
IndRegua( "CSL", cArqTrab,"CNPJFPAG+CODRECEITA")
dbSelectArea("CSL")

cCampos += "SE5.E5_PREFIXO,SE5.E5_NUMERO,SE5.E5_PARCELA,SE5.E5_TIPO,SE5.E5_CLIFOR,SE5.E5_LOJA,SE5.E5_SEQ,SE5.E5_NATUREZ,SE1.E1_VALOR,SE1.E1_CLIENTE,"
cCampos += "SE1.E1_LOJA,SA1.A1_CGC,SA1.A1_TPESSOA,SED.ED_CODIGO"
cCampos +=",SED.ED_CDRECSL"
cCampos := "%" + cCampos + "%"

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]
		#IFDEF TOP
		    If (TcSrvType ()<>"AS/400")
				lTop	:= .T.
		    	cAliasSE5	:=	GetNextAlias()

		    	BeginSql Alias cAliasSE5

					COLUMN E5_DATA  AS DATE
					COLUMN E1_BAIXA AS DATE

					SELECT
						%Exp:cCampos%

					FROM
					    %TABLE:SE5% SE5
					    LEFT JOIN %Table:SE1% SE1 ON(SE1.E1_FILIAL=%xFilial:SE1%  AND SE5.E5_PREFIXO=SE1.E1_PREFIXO AND SE5.E5_NUMERO=SE1.E1_NUM AND SE5.E5_DATA = SE1.E1_BAIXA AND (SE1.E1_TIPO = 'CS-' OR SE1.E1_TIPO = 'CSL') AND SE1.E1_STATUS = 'B' AND SE1.%NotDel%)
						LEFT JOIN %Table:SA1% SA1 ON(SA1.A1_FILIAL=%xFilial:SA1%  AND SA1.A1_COD = SE1.E1_CLIENTE AND  SA1.A1_LOJA = SE1.E1_LOJA AND SA1.%NotDel%)
						LEFT JOIN %Table:SED% SED ON(SED.ED_FILIAL=%xFilial:SED%  AND SED.ED_CODIGO = SE5.E5_NATUREZ AND SED.%NotDel%)
					WHERE
						SE5.E5_FILIAL=%XFILIAL:SE5%
		       			AND SE5.E5_DATA >= %EXP:DTOS(dDataIni)%
		       			AND SE5.E5_DATA <= %EXP:DTOS(dDataFin)%
		       			AND SED.ED_CODIGO = SE5.E5_NATUREZ
		       			AND SE5.E5_TIPODOC NOT IN ('DC','JR','MT')
		       			AND SE5.E5_FILORIG = %EXP:cFilAnt%
		       			AND SE5.%NotDel%

				ORDER BY SE5.E5_DATA
		     	EndSql
			 	DbSelectArea (cAliasSE5)
		     	(cAliasSE5)->(DbGoTop())
			Else
		#ENDIF
		         cIndex	 := CriaTrab(NIL,.F.)
		         cFiltro := 'E5_FILIAL=="'+xFilial ("SE5")+'".And.'
		         cFiltro += 'DTOS (E5_DATA)>="'+DTOS(dDataIni)+'" .And. '
		         cFiltro += 'DTOS (E5_DATA)<="'+DTOS(dDataFin)+'" .AND. '
		         cFiltro += '!E5_TIPODOC $ "DC/JR/MT" .And. '
		         cFiltro += 'E5_FILORIG=="'+cFilAnt+'"

			    IndRegua (cAliasSE5, cIndex, SE5->(IndexKey ()),, cFiltro)
			    nIndex := RetIndex(cAliasSE5)

				#IFNDEF TOP
					DbSetIndex (cIndex+OrdBagExt ())
				#ENDIF

				DbSelectArea (cAliasSE5)
			    DbSetOrder (nIndex+1)
		#IFDEF TOP
			Endif
		#ENDIF

		ProcRegua ((cAliasSE5)->(RecCount ()))
		(cAliasSE5)->(DbGoTop ())
		DO While !(cAliasSE5)->(EOF())
			IncProc(cEmpAnt+"/"+cFilAnt+" - Verificando Baixas do Tํtulo :" + (cAliasSE5)->E5_NUMERO)
			IF lTop
				cAliasSE1 	:= cAliasSE5
				cAliasSA1   := cAliasSE5
			Else
				//Para DBF faz seek e posiciona no tํtulo de abatimento e no cliente
				SE1->(DbSetOrder(2))
				SE1->(MsSeek (xFilial("SE1")+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA+(cAliasSE5)->E5_PREFIXO+(cAliasSE5)->E5_NUMERO+(cAliasSE5)->E5_PARCELA))

			 	SA1->(dbSetOrder(1))
				SA1->(MsSeek(xFilial("SA1")+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA))
			EndIF

			//Verifica se a baixa foi cancelada
			If TemBxCanc((cAliasSE5)->E5_PREFIXO+(cAliasSE5)->E5_NUMERO+(cAliasSE5)->E5_PARCELA+(cAliasSE5)->E5_TIPO+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA+(cAliasSE5)->E5_SEQ)
				(cAliasSE5)->(dbskip())
				loop
			EndIF

			//Para DBF faz a verifica็ใo do tipo e status separado.
			IF !lTop
		    	IF (cAliasSE1)->E1_STATUS <> "B" .OR. (cAliasSE5)->E5_DATA <> (cAliasSE1)->E1_BAIXA .OR. !(cAliasSE1)->E1_TIPO $ MVIRABT
					(cAliasSE5)->(dbskip())
					loop
				EndIF
			EndIF

			//Atribui o c๓digo da receita se o campo existir.
			cReceita:= AllTrim((cAliasSA1)->ED_CDRECSL)

			//Irแ agrupar por CNPJ do cliente e c๓digo de receita
			dbSelectArea("CSL")
			DbSetOrder(1)
			If MsSeek((cAliasSA1)->A1_CGC+cReceita)  //Verificar para utilizar indice com c๓digo de receita
				RecLock("CSL",.F.)
			Else
				RecLock("CSL",.T.)
			EndIF

			IncProc(cEmpAnt+"/"+cFilAnt+" - Processando CSLL do Tํtulo :" + (cAliasSE5)->E5_NUMERO)
			CSL->CNPJFPAG		:= SM0->M0_CGC
			CSL->DTINI    		:= FormatDate(dDataIni)
			CSL->DTFIN    		:= FormatDate(dDataFin)
			CSL->CNPJFPAG		:= (cAliasSA1)->A1_CGC
			CSL->CODRECEITA 	:= cReceita
			CSL->VARIACAO    	:= Iif(cReceita == "5987","1","0")
			CSL->RETORGPUB   	:= Iif((cAliasSA1)->A1_TPESSOA == "EP","1","0")
			CSL->VALOR       	+= (cAliasSE1)->E1_VALOR

			CSL->(MsUnlock())
			(cAliasSE5)->(DbSkip())
		EndDo

		#IFDEF TOP

			If (TcSrvType ()<>"AS/400")
				DbSelectArea (cAliasSE5)
				(cAliasSE5)->(DbCloseArea())
			Else
		#ENDIF
				RetIndex("SE5")
				FErase(cIndex+OrdBagExt())
		#IFDEF TOP
			EndIf
		#ENDIF

	EndIf
Next
cFilAnt := cFilOrig


Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณDCCC042   บAutor  ณMarcio Nuness       บ Data ณ  06/05/2013 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณProcessa valores de Imposto de renda retido DCCC042 para    บฑฑ
ฑฑบ          ณgerar o registro R42 que serแ importado via programa        บฑฑ
ฑฑบ          |validador do PER/DCOMP.                                     บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DCCC042(dDataIni,dDataFin,aFilsCalc)

Local cAliasSF2		:= "SF2"
Local cAliasSA1		:= "SA1"
Local cCampos		:= ""
Local lTop			:= .F.
Local aCampos		:= {}
Local nForFilial	:= 0
Local cFilOrig		:= cFilAnt
Default aFilsCalc	:= { { .T., cFilAnt } }

//Array com campo da tabela temporแria
aadd(aCampos,{"CNPJDE"		,'C'	,14	,0})
aadd(aCampos,{"DTANOCAL"  	,'C'	,04	,0})
aadd(aCampos,{"CNPJFPAG"	,'C'	,14	,0})
aadd(aCampos,{"DTMES"		,'C'	,02	,0})
aadd(aCampos,{"VALOR"		,'N'	,15	,2})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"DCC",.F.,.F.)
IndRegua( "DCC", cArqTrab,"CNPJFPAG")
dbSelectArea("DCC")

cCampos += "SF2.F2_EMISSAO,SF2.F2_CLIENTE,SF2.F2_DOC,SF2.F2_VALBRUT,SF2.F2_LOJA,SF2.F2_VALIRRF,"
cCampos += "SA1.A1_TPESSOA,SA1.A1_COD,SA1.A1_CGC"
cCampos := "%" + cCampos + "%"

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]
		#IFDEF TOP
		    If (TcSrvType ()<>"AS/400")
				lTop	:= .T.
		    	cAliasSF2	:=	GetNextAlias()


		    	BeginSql Alias cAliasSF2

					SELECT
						%Exp:cCampos%

					FROM
					    %TABLE:SF2% SF2
						LEFT JOIN %Table:SA1% SA1 ON(SA1.A1_FILIAL=%xFilial:SA1%  AND SA1.A1_COD = SF2.F2_CLIENTE AND SA1.%NotDel%)
					WHERE
						SF2.F2_FILIAL=%XFILIAL:SF2%
		       			AND SF2.F2_EMISSAO >= %EXP:DTOS(dDataIni)%
		       			AND SF2.F2_EMISSAO <= %EXP:DTOS(dDataFin)%
		       			AND (SA1.A1_TPESSOA =  'OS' )
		       			AND SF2.F2_CLIENTE = SA1.A1_COD
		       			AND SF2.%NotDel%

				ORDER BY SF2.F2_EMISSAO
		     	EndSql
			 	DbSelectArea (cAliasSF2)
		     	(cAliasSF2)->(DbGoTop())
			Else
		#ENDIF
		         cIndex	 := CriaTrab(NIL,.F.)
		         cFiltro := 'F2_FILIAL=="'+xFilial ("SF2")+'".And.'
		         cFiltro += 'DTOS (F2_EMISSAO)>="'+DTOS(dDataIni)+'" .And. '
		         cFiltro += 'DTOS (F2_EMISSAO)<="'+DTOS(dDataFin)+'" '

			    IndRegua (cAliasSF2, cIndex, cAliasSF2->(IndexKey ()),, cFiltro)
			    nIndex := RetIndex(cAliasSF2)

				#IFNDEF TOP
					DbSetIndex (cIndex+OrdBagExt ())
				#ENDIF

				DbSelectArea (cAliasSF2)
			    DbSetOrder (nIndex+1)
		#IFDEF TOP
			Endif
		#ENDIF

		ProcRegua ((cAliasSF2)->(RecCount ()))
		(cAliasSF2)->(DbGoTop ())
		DO While !(cAliasSF2)->(EOF())
			IncProc("Verificando Documentos: " + (cAliasSF2)->F2_DOC)

			 (cAliasSA1)->(MsSeek(xFilial("SA1") + (cAliasSF2)->F2_CLIENTE + (cAliasSF2)->F2_LOJA))

			//Irแ agrupar por CNPJ do cliente e c๓digo de receita
			dbSelectArea("DCC")
			DbSetOrder(1)
			If MsSeek((cAliasSA1)->A1_CGC)
				RecLock("DCC",.F.)
			Else
				RecLock("DCC",.T.)
			EndIF

			IncProc("Processando Documentos:" + (cAliasSF2)->F2_DOC)
			DCC->DTANOCAL	:=	SubStr((cAliasSF2)->F2_EMISSAO,1,4)
			DCC->CNPJFPAG 	:=  (cAliasSA1)->A1_CGC
			DCC->DTMES 		:=	SubStr((cAliasSF2)->F2_EMISSAO,5,2)
			DCC->VALOR 		:=	(cAliasSF2)->F2_VALIRRF

			DCC->(MsUnlock())
			(cAliasSF2)->(DbSkip())
		EndDo

		#IFDEF TOP

			If (TcSrvType ()<>"AS/400")
				DbSelectArea (cAliasSF2)
				(cAliasSF2)->(DbCloseArea())
			Else
		#ENDIF
				RetIndex("SF2")
				FErase(cIndex+OrdBagExt())
		#IFDEF TOP
			EndIf
		#ENDIF

	EndIf
Next
cFilAnt := cFilOrig

Return


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณIRRFR029  บAutor  ณErick G. Dias       บ Data ณ  21/05/2013 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณProcessa valores de Imposto de renda retido IRRF para       บฑฑ
ฑฑบ          ณgerar o registro R29 que serแ importado via programa        บฑฑ
ฑฑบ          |validador do PER/DCOMP.                                     บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function IRRFR029(dDataIni,dDataFin,aFilsCalc)

Local cAliasSE5		:= "SE5"
Local cAliasSE1		:= "SE1"
Local cAliasSA1		:= "SA1"
Local cCampos		:= ""
Local cReceita		:= ""
Local lTop			:= .F.
Local aCampos		:= {}
Local nForFilial	:= 0
Local cFilOrig		:= cFilAnt
Default aFilsCalc	:= { { .T., cFilAnt } }

//Array com campo da tabela temporแria
aadd(aCampos,{"CNPJDE"		,'C'	,14	,0})
aadd(aCampos,{"DTINI"		,'C'	,08	,0})
aadd(aCampos,{"DTFIN"		,'C'	,08	,0})
aadd(aCampos,{"CNPJFPAG"	,'C'	,14	,0})
aadd(aCampos,{"CODRECEITA"	,'C'	,04	,0})
aadd(aCampos,{"VARIACAO"	,'C'	,01	,0})
aadd(aCampos,{"RETORGPUB"	,'C'	,01	,0})
aadd(aCampos,{"VALOR"		,'N'	,15	,2})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"IRF",.F.,.F.)
IndRegua( "IRF", cArqTrab,"CNPJFPAG+CODRECEITA")
dbSelectArea("IRF")

cCampos += "SE5.E5_PREFIXO,SE5.E5_NUMERO,SE5.E5_PARCELA,SE5.E5_TIPO,SE5.E5_CLIFOR,SE5.E5_LOJA,SE5.E5_SEQ,SE1.E1_VALOR,SE1.E1_CLIENTE,"
cCampos += "SE1.E1_LOJA,SA1.A1_CGC,SA1.A1_TPESSOA,E1_CODIRRF"
cCampos := "%" + cCampos + "%"

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]
		#IFDEF TOP
		    If (TcSrvType ()<>"AS/400")
			lTop	:= .T.
		    cAliasSE5	:=	GetNextAlias()


		    	BeginSql Alias cAliasSE5

					COLUMN E5_DATA  AS DATE
					COLUMN E1_BAIXA AS DATE

					SELECT
						%Exp:cCampos%

					FROM
					    %TABLE:SE5% SE5
						LEFT JOIN %Table:SE1% SE1 ON(SE1.E1_FILIAL=%xFilial:SE1%  AND SE5.E5_PREFIXO=SE1.E1_PREFIXO AND SE5.E5_NUMERO=SE1.E1_NUM AND SE5.E5_PARCELA=SE1.E1_PARCELA AND SE5.E5_DATA = SE1.E1_BAIXA AND SE1.%NotDel%)
						LEFT JOIN %Table:SA1% SA1 ON(SA1.A1_FILIAL=%xFilial:SA1%  AND SA1.A1_COD = SE1.E1_CLIENTE AND  SA1.A1_LOJA = SE1.E1_LOJA AND SA1.%NotDel%)
					WHERE
						SE5.E5_FILIAL=%XFILIAL:SE5%
		       			AND SE5.E5_DATA >= %EXP:DTOS(dDataIni)%
		       			AND SE5.E5_DATA <= %EXP:DTOS(dDataFin)%
		       			AND SE5.E5_TIPODOC NOT IN ('DC','JR','MT')
		       			AND SE5.E5_FILORIG = %EXP:cFilAnt%
		       			AND SE1.E1_TIPO = %EXP:MVIRABT%
		       			AND SE1.E1_STATUS = 'B'
		       			AND SE5.%NotDel%

				ORDER BY SE5.E5_DATA
		     EndSql
			 DbSelectArea (cAliasSE5)
		     (cAliasSE5)->(DbGoTop())
		Else
		#ENDIF
		         cIndex	 := CriaTrab(NIL,.F.)
		         cFiltro := 'E5_FILIAL=="'+xFilial ("SE5")+'".And.'
		         cFiltro += 'DTOS (E5_DATA)>="'+DTOS(dDataIni)+'" .And. '
		         cFiltro += 'DTOS (E5_DATA)<="'+DTOS(dDataFin)+'" .AND. '
		         cFiltro += '!E5_TIPODOC $ "DC/JR/MT" .And. '
		         cFiltro += 'E5_FILORIG=="'+cFilAnt+'"

			    IndRegua (cAliasSE5, cIndex, SE5->(IndexKey ()),, cFiltro)
			    nIndex := RetIndex(cAliasSE5)

				#IFNDEF TOP
					DbSetIndex (cIndex+OrdBagExt ())
				#ENDIF

				DbSelectArea (cAliasSE5)
			    DbSetOrder (nIndex+1)
		#IFDEF TOP
			Endif
		#ENDIF

		ProcRegua ((cAliasSE5)->(RecCount ()))
		(cAliasSE5)->(DbGoTop ())
		DO While !(cAliasSE5)->(EOF())
			IncProc(cEmpAnt+"/"+cFilAnt+" - Verificando Baixas do Tํtulo :" + (cAliasSE5)->E5_NUMERO)
			IF lTop
				cAliasSE1 	:= cAliasSE5
				cAliasSA1   := cAliasSE5
			Else
				//Para DBF faz seek e posiciona no tํtulo de abatimento e no cliente
				SE1->(DbSetOrder(2))
				SE1->(MsSeek (xFilial("SE1")+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA+(cAliasSE5)->E5_PREFIXO+(cAliasSE5)->E5_NUMERO+(cAliasSE5)->E5_PARCELA))

			 	SA1->(dbSetOrder(1))
				SA1->(MsSeek(xFilial("SA1")+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA))
			EndIF

			//Verifica se a baixa foi cancelada
			If TemBxCanc((cAliasSE5)->E5_PREFIXO+(cAliasSE5)->E5_NUMERO+(cAliasSE5)->E5_PARCELA+(cAliasSE5)->E5_TIPO+(cAliasSE5)->E5_CLIFOR+(cAliasSE5)->E5_LOJA+(cAliasSE5)->E5_SEQ)
				(cAliasSE5)->(dbskip())
				loop
			EndIF

			//Para DBF faz a verifica็ใo do tipo e status separado.
			IF !lTop
		    	IF (cAliasSE1)->E1_STATUS <> "B" .OR. (cAliasSE5)->E5_DATA <> (cAliasSE1)->E1_BAIXA .OR. !(cAliasSE1)->E1_TIPO $ MVIRABT
					(cAliasSE5)->(dbskip())
					loop
				EndIF
			EndIF

			//Atribui o c๓digo da receita
			cReceita:= (cAliasSA1)->E1_CODIRRF

			//Irแ agrupar por CNPJ do cliente e c๓digo de receita
			dbSelectArea("IRF")
			DbSetOrder(1)
			If MsSeek((cAliasSA1)->A1_CGC+cReceita)  //Verificar para utilizar indice com c๓digo de receita
				RecLock("IRF",.F.)
			Else
				RecLock("IRF",.T.)
			EndIF

			IncProc(cEmpAnt+"/"+cFilAnt+" - Processando IRRF do Tํtulo :" + (cAliasSE5)->E5_NUMERO)
			IRF->CNPJFPAG		:= SM0->M0_CGC
			IRF->DTINI    		:= FormatDate(dDataIni)
			IRF->DTFIN    		:= FormatDate(dDataFin)
			IRF->CNPJFPAG		:= (cAliasSA1)->A1_CGC
			IRF->CODRECEITA 	:= cReceita
			IRF->VARIACAO    	:= "0"
			IRF->RETORGPUB   	:= Iif((cAliasSA1)->A1_TPESSOA == "EP","1","0")
			IRF->VALOR       	+= (cAliasSE1)->E1_VALOR

			IRF->(MsUnlock())
			(cAliasSE5)->(DbSkip())
		EndDo

		#IFDEF TOP
			If (TcSrvType ()<>"AS/400")
				DbSelectArea (cAliasSE5)
				(cAliasSE5)->(DbCloseArea())
			Else
		#ENDIF
				RetIndex("SE5")
				FErase(cIndex+OrdBagExt())
		#IFDEF TOP
			EndIf
		#ENDIF

	EndIf
Next

cFilAnt := cFilOrig

Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณSEF081SC  บAutor  ณBeatriz Scarpa      บ Data ณ  02/07/2013 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Filtro relativo as informacoes da EFD - Escrituracao       บฑฑ
ฑฑบ          ณ Fiscal Digital dos exercicios 2009 a 2012 conforme         บฑฑ
ฑฑบ          | Portaria SEF N. 081/2013 de Santa Catarina.                บฑฑ
ฑฑบ          | Funcao utilizada no fonte SEF081SC.INI                     บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function SEF081SC()

Local cAliasTRB := "TRB"

#IFDEF TOP
	If TcSrvType()<>"AS/400"

		BeginSql Alias cAliasTRB

			COLUMN FT_ENTRADA AS DATE
			COLUMN FT_EMISSAO AS DATE

			SELECT
				FT_TIPOMOV, FT_ENTRADA, FT_EMISSAO, FT_NFISCAL, FT_PRODUTO, FT_QUANT, FT_TOTAL, FT_DESCZFR,
				FT_BASERET, FT_VALICM, FT_CREDPRE, FT_ICMSRET, CDA_CODLAN, A1_CGC, SA2.A2_CGC, COMP.A2_CGC CGC_COMPL, B1_DESC, B1_PICMENT,
				B1_PICM, CD0_DOCENT, CD0_VALBST
			FROM
				%Table:SFT% SFT
				JOIN %Table:CDA% CDA ON (CDA.CDA_FILIAL = %Exp:xFilial("CDA")% AND SFT.FT_NFISCAL = CDA.CDA_NUMERO AND SFT.FT_SERIE = CDA.CDA_SERIE AND SFT.FT_CLIEFOR = CDA.CDA_CLIFOR AND SFT.FT_LOJA = CDA.CDA_LOJA AND SFT.FT_ITEM = CDA.CDA_NUMITE AND CDA.CDA_TPLANC = '1' AND CDA.CDA_CODLAN IN ('SC100001','SC120002','SC120003') AND CDA.%NotDel%)
		   		LEFT JOIN %Table:SA1% SA1 ON (SA1.A1_FILIAL = %Exp:xFilial("SA1")% AND SFT.FT_CLIEFOR = SA1.A1_COD AND SFT.FT_LOJA = SA1.A1_LOJA AND SA1.%NotDel%)
		   		LEFT JOIN %Table:SA2% SA2 ON (SA2.A2_FILIAL = %Exp:xFilial("SA2")% AND SFT.FT_CLIEFOR = SA2.A2_COD AND SFT.FT_LOJA = SA2.A2_LOJA AND SA2.%NotDel%)
				LEFT JOIN %Table:SB1% SB1 ON (SB1.B1_FILIAL = %Exp:xFilial("SB1")% AND SFT.FT_PRODUTO = SB1.B1_COD AND SB1.%NotDel%)
				LEFT JOIN %Table:CD0% CD0 ON (CD0.CD0_FILIAL = %Exp:xFilial("CD0")% AND SFT.FT_NFISCAL = CD0.CD0_DOC AND SFT.FT_SERIE = CD0.CD0_SERIE AND SFT.FT_CLIEFOR = CD0.CD0_CLIFOR AND SFT.FT_LOJA = CD0.CD0_LOJA AND	SFT.FT_ITEM = CD0.CD0_ITEM AND CD0.%NotDel%)
				LEFT JOIN %Table:SA2% COMP ON (COMP.A2_FILIAL = %Exp:xFilial("SA2")% AND COMP.A2_COD = CD0.CD0_FORNE AND COMP.A2_LOJA = CD0.CD0_LOJENT AND COMP.%NotDel%)
			WHERE
				SFT.FT_FILIAL = %Exp:xFilial("SFT")%
				AND SFT.FT_ENTRADA >= %Exp:DTOS(MV_PAR01)% AND SFT.FT_ENTRADA <= %Exp:DTOS(MV_PAR02)%
				AND SFT.FT_ESTADO <> %Exp:GetNewPar("MV_ESTADO")%
				AND SFT.%NotDel%
		EndSql
	EndIf
#ENDIF
Return(cAliasTRB)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณAjtGmb2004  บAutor  ณAlexis F. Duarte  บ Data ณ 15/07/2013  บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณFun็ใo responsแvel por ajustar o Help das purguntas, da     บฑฑ
ฑฑบ          ณGMB2004.													  บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function AjtGmb2004()

return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณfFilManad  บAutor  ณLuis Artuso       บ Data ณ 27/08/2013  บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณFun็ใo responsแvel por avaliar o criterio de geracao o pre- บฑฑ
ฑฑบ          ณregistro do bloco K150. Valida tambem a existencia da  ver- บฑฑ
ฑฑบ          ณba, garantindo que nao haja duplicidade.                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function fFilManad(cFilSRV)

	lRet	:= fFilManRH(cFilSRV)

Return lRet

//-----------------------------------------------------------------------
/*/{Protheus.doc} xMagRelObra
Funcao que relaciona um codigo de obra com a nota fiscal de servico que
foram amarradas notas fiscais de abatimento de materiais.
A funcao retorna um array com as informacoes do documento discal de servico
da obra.

@param	cCodObra	->	Codigo da obra que ira mapear a nf-s relacionada
		cAlsSD		->	Tabela que ira relacionar a obra e documentos

@author Luccas Curcio
@since 11/10/2013
@version 1.00

@Return	aNfs	->	Informacoes da nota fiscal de servico
/*/
//-----------------------------------------------------------------------
Function xMagRelObra( cCodObra , cAlsSD )
Local	aNfs		:=	{}
Local	aCmpsSlct	:=	{}
Local	cAlsNfs		:=	""
Local	cSelect		:=	""
Local	cFrom		:=	""
Local	cWhere		:=	""
Local	cCmpCliFor	:=	Iif( cAlsSD $ "SD1" , "_FORNECE" , "_CLIENTE" )
Local	cCmpVlrNf	:=	Iif( cAlsSD $ "SD1" , "F1_TOTAL" , "F2_VALBRUT" )
Local	cPrfxCmp	:=	SubStr( cAlsSD , 2 , 2 )
Local	nX			:=	0


#IFDEF TOP
	If (TcSrvType ()<>"AS/400")

		// 			--- SELECT ---
		// Campos utilizados no select abaixo
		aCmpsSlct	:=	{	"_DOC"			,;
							"_SERIE"		,;
							cCmpCliFor		,;
							"_LOJA" 		,;
							"_EMISSAO"		,;
							cCmpVlrNf		,;
							"F3_NFELETR"	}

		cSelect	:=	"%"
		For nX := 1 To Len( aCmpsSlct )
			If SubStr( aCmpsSlct[nX] , 1 , 1 ) == "_"
				cSelect	+=	cPrfxCmp + aCmpsSlct[nX] + ", "
			Else
				cSelect	+=	aCmpsSlct[nX] + ", "
			Endif
		Next nX
		cSelect	:=	SubStr( cSelect , 1 , Len( cSelect ) - 2 )
		cSelect	+=	"%"

		// 			--- FROM ---
		cFrom	:=	"%"
		cFrom	+=	RetSqlName( cAlsSD ) + " " + cAlsSD + " "
		If cAlsSD == "SD2"
			cFrom	+=	"JOIN " + RetSqlName( "SC5" ) + " SC5 "
			cFrom	+=	"	ON "
			cFrom	+=	"	SC5.C5_FILIAL		= '" + xFilial( "SC5" ) + "' 	AND "
			cFrom	+=	"	SC5.C5_NUM			= SD2.D2_PEDIDO 				AND "
			cFrom	+=	"	SC5.D_E_L_E_T_		= '' "
			cFrom	+=	"JOIN " + RetSqlName( "SF3" ) + " SF3 "
			cFrom	+=	"	ON "
			cFrom	+=	"	SF3.F3_FILIAL		= '" + xFilial( "SF3" ) + "' 	AND "
			cFrom	+=	"	SF3.F3_NFISCAL		= SD2.D2_DOC 					AND "
			cFrom	+=	"	SF3.F3_SERIE		= SD2.D2_SERIE 					AND "
			cFrom	+=	"	SF3.F3_CLIEFOR		= SD2.D2_CLIENTE				AND "
			cFrom	+=	"	SF3.F3_LOJA			= SD2.D2_LOJA 					AND "
			cFrom	+=	"	SF3.D_E_L_E_T_	= '' "
			cFrom	+=	"JOIN " + RetSqlName( "SF2" ) + " SF2 "
			cFrom	+=	"	ON "
			cFrom	+=	"	SF2.F2_FILIAL		= '" + xFilial( "SF2" ) + "' 	AND "
			cFrom	+=	"	SF2.F2_DOC			= SD2.D2_DOC 					AND "
			cFrom	+=	"	SF2.F2_SERIE		= SD2.D2_SERIE 					AND "
			cFrom	+=	"	SF2.F2_CLIENTE		= SD2.D2_CLIENTE				AND "
			cFrom	+=	"	SF2.F2_LOJA			= SD2.D2_LOJA 					AND "
			cFrom	+=	"	SF2.D_E_L_E_T_	= '' "
		Endif
		cFrom	+=	"%"

		// 			--- WHERE ---
		cWhere	:=	"%"
		cWhere	+=	cAlsSD + "." + cPrfxCmp + "_FILIAL = '" + xFilial( cAlsSD ) + "' AND "
		cWhere	+=	cAlsSD + ".D_E_L_E_T_ = '' AND "
		cWhere	+=	"SF3.F3_TIPO = 'S' AND "
		If cAlsSD == "SD2"
			cWhere	+=	"SC5.C5_OBRA = '" + cCodObra + "' "
		Endif
		cWhere	+=	"%"

		cAlsNfs	:=	GetNextAlias()

		BeginSql Alias cAlsNfs

			SELECT
				%Exp:cSelect%

			FROM
				%Exp:cFrom%

			WHERE
				%Exp:cWhere%

	    EndSql
	Endif
#ENDIF

If cAlsSD == "SD2"
	aNfs	:=	{	(cAlsNfs)->( D2_DOC )		,;	// -> Numero do Documento Fiscal
					(cAlsNfs)->( D2_SERIE )		,;	// -> Serie do Documento Fiscal
					(cAlsNfs)->( D2_CLIENTE )	,;	// -> Cliente do Documento Fiscal
					(cAlsNfs)->( D2_LOJA )		,;	// -> Loja do Documento Fiscal
					(cAlsNfs)->( D2_EMISSAO )	,;	// -> Data de Emissao do Documento Fiscal
					(cAlsNfs)->( F2_VALBRUT )	,;	// -> Valor Bruto do Documento Fiscal
					(cAlsNfs)->( F3_NFELETR )	}	// -> Numero da Nota Fiscal Eletronica do Documento Fiscal
Endif

Return aNfs

//-------------------------------------------------------------------
/*/{Protheus.doc} DEC5035013
Fun็ใo que irแ atender o Decreto 50350/2013, para industria referente
cigarros.

@param	cCodIni	-> C๓digo do Produto Inicial para o processamento
		cCodFin	-> C๓digo do Produto Final para o processamento.

@return lRet

@author Erick Dias
@since  25/11/2013
@version 11.80
/*/
//-------------------------------------------------------------------

Function DEC5035013(cCodIni, cCodFin, aFilsCalc)

Local cAliasSF7		:= "SF7"
Local cAliasSS1		:= "SS1"
Local cAliasSB1		:= "SB1"
Local cAliasSS4		:= "SS4"
Local cCampos		:= ""
Local cMvEstado		:= SuperGetMv("MV_ESTADO",,.F.)
Local cB1PUPCCST	:= SuperGetMv("MV_PUPCCST",,.F.)
Local cS4PUPCCST	:= "S4_" + Substr(cB1PUPCCST,4,7)
Local cFiltro		:= ""
Local cDtIni		:= ""
Local cDtAnt		:= ""
Local nPreco		:= 0
Local nPrecoAnt		:= 0
Local lRet			:= .F.
Local lHist			:= HistFiscal()
Local aCampos		:= {}
Local nForFilial:= 0
Local cFilOrig	:= cFilAnt

Default aFilsCalc:= { { .T., cFilAnt } }
Default cCodIni	:= ""
Default cCodFin	:= ""

//Array com campo da tabela temporแria
aadd(aCampos,{"CNPJ"		,'C'	,14	,0})
aadd(aCampos,{"COD"			,'C'	,60	,0})
aadd(aCampos,{"GTIN"		,'C'	,14	,0})
aadd(aCampos,{"DESCR"		,'C'	,120,0})
aadd(aCampos,{"UF"			,'C'	,02	,0})
aadd(aCampos,{"PRECO"		,'N'	,08	,2})
aadd(aCampos,{"INICTAB"		,'C'	,08	,0})
aadd(aCampos,{"INICTABANT"  ,'C'	,08	,0})

dbSelectArea("SF7")
dbSelectArea("SB1")
If cPaisLoc == "BRA"
	dbSelectArea("SS1") //Tabela de hist๓rico SF7
	dbSelectArea("SS4")	//Tabela de hist๓rico SB1
EndIf

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"PRC",.F.,.F.)
IndRegua( "PRC", cArqTrab,"CNPJ+COD+INICTAB+UF")
dbSelectArea("PRC")

For nForFilial := 1 to Len(aFilsCalc)
	If aFilsCalc[nForFilial, 1]
		cFilAnt := aFilsCalc[ nForFilial, 2 ]
		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProcessa cadastro de produtoณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		IF lHist .AND. SS4->(FieldPos (cS4PUPCCST))>0 .AND. SB1->(FieldPos (cB1PUPCCST))>0

			#IFDEF TOP
			    If (TcSrvType ()<>"AS/400")
				lTop	:= .T.
			    cAliasSB1	:=	GetNextAlias()
			    cCampos := "SB1.B1_COD,SB1.B1_DESC,SB1.B1_IDHIST,SB1." + cB1PUPCCST
				cCampos := "%" + cCampos + "%"
				cFiltro	:= "SB1." + cB1PUPCCST + " > 0"
				cFiltro := "%" + cFiltro + "%"

		    	BeginSql Alias cAliasSB1

					SELECT
						%Exp:cCampos%
					FROM
					    %TABLE:SB1% SB1
					WHERE
						SB1.B1_FILIAL=%XFILIAL:SB1%
		       			AND SB1.B1_COD >= %EXP:cCodIni%
		       			AND SB1.B1_COD <= %EXP:cCodFin%
		       			AND %Exp:cFiltro%
		       			AND SB1.%NotDel%

			   		ORDER BY SB1.B1_COD
			    EndSql
				DbSelectArea (cAliasSB1)
			    (cAliasSB1)->(DbGoTop())
			EndiF
			#ENDIF

			ProcRegua ((cAliasSB1)->(RecCount ()))
			(cAliasSB1)->(DbGoTop ())
			Do While !(cAliasSB1)->(EOF())
				IncProc(cEmpAnt+"/"+cFilAnt+" - Processando produto :" + (cAliasSB1)->B1_COD)
		        lRet	:= .T.
				nPreco		:=(cAliasSB1)->&(cB1PUPCCST)
				nPrecoAnt	:= 0
				cDtIni		:= SubStr((cAliasSB1)->B1_IDHIST,1,8)
				ProcPRC(cS4PUPCCST,cAliasSB1,nPreco,cDtIni,cDtAnt,nPrecoAnt,cMvEstado,"SS4")
				(cAliasSB1)->(DbSkip())
			EndDo
			#IFDEF TOP
				If (TcSrvType ()<>"AS/400")
					DbSelectArea (cAliasSB1)
					(cAliasSB1)->(DbCloseArea())
				EndIF
			#ENDIF
		EndIF

		//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
		//ณProcessa Exce็ใo Fiscal.ณ
		//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
		IF lHist

			#IFDEF TOP
			    If (TcSrvType ()<>"AS/400")
				lTop	:= .T.
			    cAliasSF7	:=	GetNextAlias()
			    cCampos := "SF7.F7_GRTRIB,SF7.F7_PRCUNIC,SF7.F7_IDHIST , SF7.F7_SEQUEN, SF7.F7_EST, SB1.B1_COD, SB1.B1_DESC"
				cCampos := "%" + cCampos + "%"

			 	BeginSql Alias cAliasSF7

					SELECT
						%Exp:cCampos%
					FROM
					    %TABLE:SF7% SF7
						JOIN %Table:SB1% SB1 ON (SB1.B1_FILIAL = %Exp:xFilial("SB1")% AND SB1.B1_GRTRIB = SF7.F7_GRTRIB AND SB1.%NotDel%)
					WHERE
						SF7.F7_FILIAL=%XFILIAL:SF7%
			       		AND SF7.F7_PRCUNIC > 0
			       		AND SB1.B1_COD >= %EXP:cCodIni%
		       			AND SB1.B1_COD <= %EXP:cCodFin%
			       		AND SF7.%NotDel%
			     EndSql
				 DbSelectArea (cAliasSF7)
			     (cAliasSF7)->(DbGoTop())
			EndiF
			#ENDIF

			ProcRegua ((cAliasSF7)->(RecCount ()))
			(cAliasSF7)->(DbGoTop ())
			Do While !(cAliasSF7)->(EOF())
		        lRet	:= .T.
				nPreco		:=(cAliasSF7)->F7_PRCUNIC
				nPrecoAnt	:= 0
				cDtIni		:= SubStr((cAliasSF7)->F7_IDHIST,1,8)
				ProcPRC(cS4PUPCCST,cAliasSF7,nPreco,cDtIni,cDtAnt,nPrecoAnt,(cAliasSF7)->F7_EST,"SS1")
				(cAliasSF7)->(DbSkip())
			EndDo

			#IFDEF TOP
				If (TcSrvType ()<>"AS/400")
					DbSelectArea (cAliasSF7)
					(cAliasSF7)->(DbCloseArea())
				EndIF
			#ENDIF
		EndIF

	EndIf

Next

cFilAnt := cFilOrig
Return lRet

//-------------------------------------------------------------------
/*/{Protheus.doc} HistS1S4
Fun็ใo que ir[a realizar busca nas tabelas de hist๓rico, irแ buscar
data de altera็ใo.

@param	cS4PUPCCST	-> Campo criado manualmente pelo usuแrio que cont้m o pre็o de venda
		lDif   		-> Indica se buscar pre็o igual ou diferente na tabela de hist๓rico
		cCodPro     -> C๓digo do produto
		nAlq		-> Pre็o em questใo que estแ sendo processado
		cDt 		-> Data de altera็ใo
		nPrecoAnt   -> Pre็o anterior ao atual
		cHist 		-> Indica se irแ processar SS1 ou SS4
		cSequen     -> Seque๊ncia do cadastro de exce็ใo fiscal

@return lRet

@author Erick Dias
@since  25/11/2013
@version 11.80
/*/
//-------------------------------------------------------------------

Static Function HistS1S4(cS4PUPCCST,lDif,cCodPro, nAlq,cDt,nPrecoAnt, cHist,cSequen)

Local cAliasSS1		:= "SS1"
Local cAliasSS4		:= "SS4"
Local cCampos		:= ""
Local cOrdem		:= ""
Local cFiltro		:= ""
Local cFrom			:= ""

DEFAULT cS4PUPCCST	:= ""
DEFAULT cSequen		:= ""

//Hist๓rico da exce็ใo Fiscal
If cHist == "SS1"

	cCampos := "%SS1.S1_GRTRIB, SS1.S1_IDHIST,	SS1.S1_PRCUNIC%"
	cFiltro	:= "SS1.S1_GRTRIB = '" +  cCodPro + "'  AND SS1.S1_SEQUEN = '" + cSequen + "'  AND SS1.S1_PRCUNIC " + Iif(lDif," <> " ," = ") + cValtochar(nAlq) + " AND  SS1.D_E_L_E_T_='' "
	cFrom	:=	"%"+RetSqlName("SS1")+" SS1 %"
	cOrdem	:= "SS1.S1_IDHIST "
	If lDif
		cOrdem	+= " DESC "
	EndIF

//Hist๓rico do cadastro de produto.
ElseIf cHist == "SS4"

	cCampos := "%SS4.S4_COD,	SS4.S4_IDHIST,	SS4." + cS4PUPCCST + "%"
	cFiltro	:= "SS4.S4_COD = '" +  cCodPro + "' AND SS4." + cS4PUPCCST + Iif(lDif," <> " ," = ") + cValtochar(nAlq) + " AND SS4.D_E_L_E_T_='' "
	cFrom	:=	"%"+RetSqlName("SS4")+" SS4 %"
	cOrdem	:= "SS4.S4_IDHIST "
	If lDif
		cOrdem	+= "  DESC "
	EndIF

EndIF

cOrdem	:= "%" + cOrdem + "%"
cFiltro	:= "%" + cFiltro + "%"

#IFDEF TOP
	If (TcSrvType ()<>"AS/400")
		cAlias	:=	GetNextAlias()
		BeginSql Alias cAlias

			SELECT
				%Exp:cCampos%

			FROM
				%Exp:cFrom%

			WHERE
				%Exp:cFiltro%

			Order By %Exp:cOrdem%
		EndSql
	EndIF
#ENDIF

ProcRegua ((cAlias)->(RecCount ()))
(cAlias)->(DbGoTop ())
DO While !(cAlias)->(EOF())
	If cHist == "SS1"
		If lDif
			nPrecoAnt	:=	(cAlias)->S1_PRCUNIC
		Else
			cDt	:= SubStr((cAlias)->S1_IDHIST,1,8)
		EnDIF
	ElseIf cHist == "SS4"
		If lDif
			nPrecoAnt	:=	(cAlias)->&(cS4PUPCCST)
		Else
			cDt	:= SubStr((cAlias)->S4_IDHIST,1,8)
		EnDIF
	EndIf

	Exit

	(cAlias)->(DbSkip())
EndDo

#IFDEF TOP
	If (TcSrvType ()<>"AS/400")
		DbSelectArea (cAlias)
		(cAlias)->(DbCloseArea())
	EndIF
#ENDIF

Return


//-------------------------------------------------------------------
/*/{Protheus.doc} ProcPRC
Fun็ใo que irแ realizar a grava็ใo na tabela temporแria para processar o arquivo .Ini
data de altera็ใo.

@param	cCmpPreco	-> Campo criado manualmente pelo usuแrio que cont้m o pre็o de venda
		cAlias   	-> Alias da SB1 ou da SF7
		nPreco     -> Pre็o atual
		cDtIni		-> Data de altera็ใo do pre็o atual
		cDtAnt 		-> Data de altera็ใo do pre็o anterior ao atual
		nPrecoAnt   -> Pre็o anterior ao atual
		cUf 		-> UF que serแ considerada para gera็ใo do arquivo
		cHist       -> Seque๊ncia do cadastro de exce็ใo fiscal

@return lRet

@author Erick Dias
@since  25/11/2013
@version 11.80
/*/
//-------------------------------------------------------------------
Static Function ProcPRC(cCmpPreco,cAlias,nPreco,cDtIni,cDtAnt,nPrecoAnt,cUf,cHist)

Local aUF	:= {}
Local nCont	:= 0

//Busca data de altera็ใo para pre็o atual
HistS1S4(cCmpPreco,.F., Iif(cHist== "SS4",(cAlias)->B1_COD,(cAlias)->F7_GRTRIB), nPreco,@cDtIni,          ,cHist,Iif(cHist== "SS1",(cAlias)->F7_SEQUEN,""))
//Se a data de altera็ใo do pre็o atual nใo estiver entre o perํodo selecionado na tela, produto nใo serแ considerado no arquivo

//Busca pre็o anterior ao pre็o atual
HistS1S4(cCmpPreco,.T.,Iif(cHist== "SS4",(cAlias)->B1_COD,(cAlias)->F7_GRTRIB), nPreco,@cDtIni,@nPrecoAnt,cHist,Iif(cHist== "SS1",(cAlias)->F7_SEQUEN,""))
If nPrecoAnt > 0
	//Busca data de altera็ใo da alํquota anterior.
	HistS1S4(cCmpPreco,.F.,Iif(cHist== "SS4",(cAlias)->B1_COD,(cAlias)->F7_GRTRIB), nPrecoAnt,@cDtAnt,,cHist,Iif(cHist== "SS1",(cAlias)->F7_SEQUEN,""))
EndIF

dbSelectArea("PRC")
DbSetOrder(1)
//Caso na exce็ใo fiscal o estado estiver com **, serแ gerado registro para cada estado
IF cUf == "**"
	SX5->(dbSeek(xFilial("SX5")+'12'))
	While !SX5->(Eof()) .AND. SX5->X5_TABELA == "12"
			AADD(aUF,Alltrim(SX5->X5_CHAVE))
		SX5->(DbSkip())
	EndDo
Else
	AADD(aUF,cUf)
EndIF

If Empty(cDtAnt)
	cDtAnt	:=	cDtIni
EndIF

For nCont:= 1 to Len(aUF)

	If !MsSeek(SM0->M0_CGC+(cAlias)->B1_COD+cDtIni+aUF[nCont])
		RecLock("PRC",.T.)
		PRC->CNPJ			:= SM0->M0_CGC
		PRC->COD    		:= (cAlias)->B1_COD
		PRC->GTIN   		:= SPACE(14)
		PRC->DESCR			:= (cAlias)->B1_DESC
		PRC->UF 			:= aUF[nCont]
		PRC->PRECO    		:= nPreco
		PRC->INICTAB   		:= cDtIni
		PRC->INICTABANT 	:= cDtAnt
		PRC->(MsUnlock())
	EndIF

Next nCont

Return

//-------------------------------------------------------------------
/*/{Protheus.doc} GIAPRREG63
Fun็ใo que irแ retornar o valor do campo 63 da GIA-PR.

@param	lVlrSiscred	-> Informa se os valores referentes ao SISCRED devem ou nใo ser considerados

@return nValor

@author Joใo Victor Pellegrini

@since  16/12/2013
@version 11.80
/*/
//-------------------------------------------------------------------
Function GIAPRREG63(lVlrSisCred)

Local nValor := 0
Local nPos006 := 0
Local nCont := 0
Local cLinhaApur := GetNewPar("MV_GIAPR63", "")

nPos006 := aScan(_aTotal[50], {|a| a[1] == "006"})

If nPos006 <> 0
	If lVlrSisCred .Or. AllTrim(cLinhaApur) == ""
		nValor := _aTotal[50][nPos006][3]
	Else
		// Se nใo considerar os valores do SISCRED, os valores das linhas especificadas no parametro MV_GIAPR63
		// serใo desconsiderados no registro 63.
		For nCont := nPos006 to Len(_aTotal[50])

			If _aTotal[50][nCont][1] == "006" .And. _aTotal[50][nCont][4] <> "006.00" .And. !AllTrim(_aTotal[50][nCont][4]) $ cLinhaApur
				nValor += _aTotal[50][nCont][3]
			EndIf

		Next nCont
	EndIf
EndIf

Return nValor


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณAPURSIENRO  บAutor  ณLMDT - Totvs Partnerบ Data ณ  27/02/14 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณApura็ใo da SIEN (Sistema de Entradas de Notas / RO )       บฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณArquivo de trabalho                                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณUtiliza privates disponํveis na execu็ใo do SIENRO.INI       ฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SIGAFIS                                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Function APURSIENRO()

Local aCampos	:= {}
Local nRegEmp   := SM0->(RecNo())

#IFDEF TOP
	Local cQuery 	:= ""
	Local lSelFil	:= IiF(MV_PAR06==1, .T., .F.)		// Define se seleciona filiais pela rotina MATA950 que estแ ativa neste momento
	Local lAglut	:= .F.
	Local nX		:= 0
	Local nEmpresa	:= 0

	lAglut	:= _aTotal[012][1][3] == 'S'				// Define se aglutina registros no wizard do arquivo de configura็ใo SIENRO.INI
	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXฟ
	//ณVariแvel Private declarada no MATA950, serve para sair do loop de filiais e ณ
	//ณprocessar uma ๚nica vez, se utilizou a sele็ใo e aglutina็ใo de filiais.    ณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤXู
	lExitPFil	:= lSelFil .and. lAglut
#ELSE
	Local cIndex	:= ''
	Local nIndex	:= 0
	Local cFiltro	:= ''
#ENDIF

//Array com campo da tabela temporแria
aadd(aCampos,{"F1_FILIAL"	,'C'	,TamSX3('F1_FILIAL')[1]		,TamSX3('F1_FILIAL')[2]})
aadd(aCampos,{"F1_SERIE"	,'C'	,TamSX3('F1_SERIE')[1]		,TamSX3('F1_SERIE')[2]})
aadd(aCampos,{"F1_FORNECE"	,'C'	,TamSX3('F1_FORNECE')[1]	,TamSX3('F1_FORNECE')[2]})
aadd(aCampos,{"F1_LOJA"		,'C'	,TamSX3('F1_LOJA')[1]		,TamSX3('F1_LOJA')[2]})
aadd(aCampos,{"F1_VALBRUT"	,'N'	,TamSX3('F1_VALBRUT')[1]	,TamSX3('F1_VALBRUT')[2]})
aadd(aCampos,{"F1_ESPECIE"	,'C'	,TamSX3('F1_ESPECIE')[1]	,TamSX3('F1_ESPECIE')[2]})
aadd(aCampos,{"F1_DOC"		,'C'	,TamSX3('F1_DOC')[1]		,TamSX3('F1_DOC')[2]})
aadd(aCampos,{"F1_EMISSAO"	,'D'	,08	,0})
aadd(aCampos,{"A2_TIPORUR"	,'C'	,TamSX3('A2_TIPORUR')[1]	,TamSX3('A2_TIPORUR')[2]})
//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"TMP",.F.,.F.)
IndRegua( "TMP", cArqTrab,"F1_FILIAL+DTOS(F1_EMISSAO)+F1_ESPECIE+F1_DOC+F1_SERIE+F1_FORNECE+F1_LOJA")


//Deve ser configurado mesmo ano de Inicio e Fim ou nใo exibe registros
If substr(dtoc(_aTotal[5]),7,2) # substr(dtoc(_aTotal[6]),7,2)
	Return
EndIf


#IFDEF TOP
	For nEmpresa := 1 To Len(aFilsCalc)
		If !aFilsCalc[nEmpresa][1]
			Loop
		EndIf
		cFilAnt	:= aFilsCalc[nEmpresa][2]

		cQuery	:= "SELECT SF1.F1_FILIAL, SF1.F1_SERIE, SF1.F1_FORNECE, SF1.F1_LOJA, SF1.F1_VALBRUT, SF1.F1_ESPECIE, SF1.F1_DOC, SF1.F1_EMISSAO, SA2.A2_TIPORUR "
		cQuery	+= "FROM "+RetSqlName('SF1')+" SF1, "+RetSqlName('SA2')+" SA2 "
		cQuery	+= "WHERE SF1.F1_FILIAL = '"+xFilial('SF1')+"' "
		//DATA de EMISSAO da NF deve estar entre as datas selecionadas
		cQuery	+= "AND SF1.F1_EMISSAO >= '"+DtoS(_aTotal[05])+"' AND SF1.F1_EMISSAO <= '"+DtoS(_aTotal[06])+"' "
		cQuery	+=	"AND SF1.D_E_L_E_T_=' ' "
		//POSICIONA NO FORNECEDOR
		cQuery	+= "AND SA2.A2_FILIAL = '"+xFilial('SA1')+"' AND SA2.A2_COD = SF1.F1_FORNECE AND SA2.A2_LOJA = SF1.F1_LOJA "
		cQuery	+=	"AND SA2.A2_TIPORUR <> ' ' AND SA2.D_E_L_E_T_=' ' "
		cQuery 	+=	"ORDER BY F1_FILIAL,F1_EMISSAO,F1_ESPECIE,F1_DOC,F1_SERIE,F1_FORNECE,F1_LOJA "
		cQuery 	:= ChangeQuery (cQuery)
		DbUseArea (.T., "TOPCONN", TcGenQry (,, cQuery), 'TRB' )

		aStruSF1	:= SF1->(dbStruct())
		For nX := 1 To Len (aStruSF1)
			If (aStruSF1[nX][2]<>"C") .And. (FieldPos(aStruSF1[nX][1])<>0)
				TcSetField ('TRB', aStruSF1[nX][1], aStruSF1[nX][2], aStruSF1[nX][3], aStruSF1[nX][4])
			EndIf
		Next nX

		TRB->(dbGoTop())
		While !TRB->(Eof())
			GrvTmpSie( TRB->F1_FILIAL, TRB->F1_SERIE, TRB->F1_FORNECE, TRB->F1_LOJA, TRB->F1_VALBRUT, TRB->F1_ESPECIE, TRB->F1_DOC, TRB->F1_EMISSAO, TRB->A2_TIPORUR)
			TRB->(dbSkip())
		EndDo
		TRB->(dbCloseArea())

		If FWModeAccess("SF1",3)=="C"
			Exit
		Endif

	Next


#ELSE
	// Em ambiente xBase, processa somente filial corrente, independente de parametriza็๕es
	SA2->(dbSetOrder(1))
	dbSelectArea('SF1')
	SF1->(dbSetOrder(1))
    cIndex	 := CriaTrab(NIL,.F.)
    cFiltro := "F1_EMISSAO >= '"+DtoS(_aTotal[05])+"' AND SF1.F1_EMISSAO <= '"+DtoS(_aTotal[06])+"' '
    IndRegua ('SF1', cIndex, SF1->(IndexKey ()),, cFiltro)
	nIndex := RetIndex('SF1')
	DbSetIndex(cIndex+OrdBagExt())
	dbGoTop()
	While !SF1->(Eof())
		SA2->(dbSeek(xFilial("SA2")+SF1->F1_FORNECE+SF1->F1_LOJA))
		GrvTmpSie( SF1->F1_FILIAL, SF1->F1_SERIE, SF1->F1_FORNECE, SF1->F1_LOJA, SF1->F1_VALBRUT, SF1->F1_ESPECIE, SF1->F1_DOC, SF1->F1_EMISSAO, SA2->A2_TIPORUR)
		SF1->(dbSkip())
    EndDo
    RetIndex('SF1')

#ENDIF


SM0->(dbGoTo(nRegEmp))
cFilAnt := FWCodFil()

Return(Nil)



/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณGrvTempSien  บAutor  ณMicrosiga           บ Data ณ  02/26/14บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Fun็ใo auxiliar para grava็ใo de temporแrio independente doบฑฑ
ฑฑบ          ณ ambiente que o sistema utilizar.						      บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ AP                                                        บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Static Function GrvTmpSie( cFilSF1, cSerie, cFornece, cLoja, nValBrut, cEspecie, cDoc, dEmissao, cTpRural)

If Select('TMP') > 0
	RecLock('TMP', .T.)
    TMP->F1_FILIAL	:= cFilSF1
    TMP->F1_SERIE	:= cSerie
    TMP->F1_FORNECE	:= cFornece
    TMP->F1_LOJA	:= cLoja
    TMP->F1_VALBRUT	:= nValBrut
    TMP->F1_ESPECIE	:= cEspecie
    TMP->F1_DOC		:= cDoc
    TMP->F1_EMISSAO	:= dEmissao
    TMP->A2_TIPORUR	:= cTpRural
	msUnlock()
EndIf

Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณGIARSXVI  บAutor  ณGraziele Paro       บ Data ณ  05/03/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณGera informa็๕es para gera็ใo do anexo XVI da Gia RS		  บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ GIARS.INI                                                  บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function GIARSXVI(dDataIni, dDataFin)
Local aCampos   := {}
Local cTransp   := "5351', '5352', '5353', '5354', '5355', '5356', '5357', '5359', '6351', '6352', '6353', '6354', '6355', '6356', '6357', '6359"
Local cEnergDis := "5252', '5253', '5254', '5255', '5256', '5257', '5258"
Local cComunic  := "5301', '5302', '5303', '5304', '5305', '5306', '5307', '6301', '6302', '6303', '6304', '6305', '6306', '6307', '7301"
Local cVenForEst:= "5103', '5104', '6103', '6104"
Local cEnergEle := "5251', '6251', '7251"
Local cAgua     := "5101', '5102"
Local cCMGIARS  := SuperGetMv("MV_CMGIARS")
Local cCampo    := ""
Local cMunDes   := ""
Local cCodMun   := ""
Local nCodMun   := 0
Local cAliasSFT := "SFT"
Local cAliasSA1 := "SA1"
Local lTop      := .F.
Local cMesAno   := ""
Local nSeq      := 0
Local lIntTMS   := GetNewPar("MV_INTTMS",.F.)

//Verifica se o Parโmetro esta preenchido e se o campo para informar o municipio existe.
If ((Empty(cCMGIARS)) .OR. (SA1->(FieldPos(AllTrim (SuperGetMv("MV_CMGIARS"))))=0))
	cCampo+= "'0'"
ElseIf (SA1->(FieldPos(AllTrim (SuperGetMv("MV_CMGIARS"))))>0)
	cCampo+= "SA1."+SuperGetMv("MV_CMGIARS")
EndIf

cCampo := "%" + cCampo + "%"

//VETOR COM A ESTRUTURA DA TABELA TEMPORARIA PARA GERAวรO DOS REGISTROS XVI
aadd(aCampos,{"SEQ01",'C',04,0}) //TP
aadd(aCampos,{"SEQ02",'C',02,0}) //Versใo
aadd(aCampos,{"SEQ03",'C',02,0}) //Dia inicial do m๊s de refer๊ncia
aadd(aCampos,{"SEQ04",'C',02,0}) //Dia final do m๊s de refer๊ncia
aadd(aCampos,{"SEQ05",'N',06,0}) //M๊s e Ano do m๊s de refer๊ncia ou de atividade
aadd(aCampos,{"SEQ06",'C',10,0}) //Inscri็ใo Estadual
aadd(aCampos,{"SEQ07",'N',04,0}) //Sequencia
aadd(aCampos,{"SEQ08",'C',04,0}) //ID do Registro
aadd(aCampos,{"SEQ09",'C',02,0}) //Identifica a Natureza do Anexo
aadd(aCampos,{"SEQ10",'C',08,0}) //Ato Declarat๓rio
aadd(aCampos,{"SEQ11",'C',16,0}) //Ato Declarat๓rio
aadd(aCampos,{"SEQ12",'C',02,0}) //Qtde. Ocorr๊ncias
aadd(aCampos,{"SEQ13",'C',03,0}) //C๓digo Municํpio
aadd(aCampos,{"SEQ14",'N',16,2}) //Valor Servi็o

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"XVI",.F.,.F.)
IndRegua("XVI", cArqTrab,"SEQ09+SEQ13") //SEQ05+SEQ09+SEQ12
dbSelectArea("XVI")
DbClearIndex()
DbSetIndex(cArqTrab+OrdBagExt())

#IFDEF TOP
If (TcSrvType ()<>"AS/400")
	lTop := .T.
	cAliasSFT := GetNextAlias()
	cAliasSA1 := cAliasSFT

	BeginSql Alias cAliasSFT

		COLUMN FT_EMISSAO AS DATE

		SELECT
			SFT.FT_TIPOMOV,
			SFT.FT_FILIAL,
			SFT.FT_ESPECIE,
			SFT.FT_NFISCAL,
			SFT.FT_SERIE,
			SFT.FT_CLIEFOR,
			SFT.FT_LOJA,
			SFT.FT_TIPOMOV,
			SFT.FT_EMISSAO,
			SFT.FT_PRODUTO,
			SFT.FT_CFOP,
			SFT.FT_VALCONT,
			SFT.FT_BASEICM,
			SFT.FT_ISENICM,
			SFT.FT_OUTRICM,
			SFT.FT_OBSERV,
			SA1.A1_MUN,
			%Exp:cCampo% AS CODMUNIC,
			SF3.F3_VALOBSE
		FROM %TABLE:SFT% SFT
			INNER JOIN %TABLE:SA1% SA1 ON(SA1.A1_FILIAL = %XFILIAL:SA1% AND SFT.FT_CLIEFOR = SA1.A1_COD AND SFT.FT_LOJA = SA1.A1_LOJA AND SA1.%NOTDEL%)
			INNER JOIN %TABLE:SF3% SF3 ON(SF3.F3_FILIAL = %XFILIAL:SF3% AND SFT.FT_NFISCAL = SF3.F3_NFISCAL AND SFT.FT_SERIE = SF3.F3_SERIE AND SFT.FT_CLIEFOR = SF3.F3_CLIEFOR AND SFT.FT_LOJA = SF3.F3_LOJA AND SF3.%NOTDEL%)
		WHERE
			SFT.FT_FILIAL = %XFILIAL:SFT% AND
			SFT.FT_TIPOMOV = "S" AND
			SFT.%NOTDEL% AND
			SFT.FT_EMISSAO >= %EXP:DTOS(dDataIni)% AND
			SFT.FT_EMISSAO <= %EXP:DTOS(dDataFin)%
		ORDER BY SFT.FT_EMISSAO
	EndSql
Else
#ENDIF
	cIndex  := CriaTrab(NIL,.F.)
	cFiltro := 'FT_FILIAL=="'+xFilial ("SFT")+'".And.'
	cFiltro += 'DTOS (FT_EMISSAO)>="'+DTOS(dDataIni)+'" .And. '
	cFiltro += 'DTOS (FT_EMISSAO)<="'+DTOS(dDataFin)+'"'
	IndRegua (cAliasSFT, cIndex, SFT->(IndexKey ()),, cFiltro)
	nIndex := RetIndex(cAliasSFT)
	#IFNDEF TOP
		DbSetIndex (cIndex+OrdBagExt ())
	#ENDIF
	DbSelectArea (cAliasSFT)
	DbSetOrder (nIndex+1)
#IFDEF TOP
EndIf
#ENDIF

dbSelectArea("SFT")
SFT->(DbSetOrder(4))
dbSelectArea("SA1")
SA1->(DbSetOrder(1))

DbSelectArea(cAliasSFT)
While (cAliasSFT)->(!EOF())
	cMesAno := Alltrim(Str(Month((cAliasSFT)->FT_EMISSAO)))+Alltrim(Str(Year((cAliasSFT)->FT_EMISSAO)))
	If !lTop
		(cAliasSA1)->(MsSeek(xFilial("SA1")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
	EndIf
	If (cAliasSFT)->CODMUNIC == "0"
		cCodMun := "000"
	Else
		cCodMun :=(cAliasSFT)->CODMUNIC
	EndIf
	cMunDes := (cAliasSA1)->A1_MUN
	If lIntTMS .And. Alltrim((cAliasSFT)->FT_CFOP)$cTransp //Transporte
		//-- Buscar codigo municipio do cliente destino - SIGATMS
		If	nCodMun == 0 .And. ! Empty(GetNewPar("MV_CMGIARS",""))
			nCodMun := SA1->(FieldPos((GetNewPar("MV_CMGIARS",""))))
		EndIf
		//-- Se parametro informado usa numero do campo definido no parametro.
		If	nCodMun > 0
			DbSelectArea("DT6")
			DT6->(dbSetOrder(1)) //DT6_FILIAL+DT6_FILDOC+DT6_DOC+DT6_SERIE
			If DT6->(MsSeek(xFilial("DT6")+(cAliasSFT)->FT_FILIAL+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE))
				DbSelectArea("SA1")
				SA1->(DbSetOrder(1)) //A1_FILIAL+A1_COD+A1_LOJA
				If SA1->(DbSeek(xFilial("SA1")+DT6->(DT6_CLIREM+DT6_LOJREM)))
					cMunDes := SA1->A1_MUN
					cCodMun := SA1->(FieldGet(nCodMun))
				EndIf
			EndIf
		EndIf
	EndIf
	If Alltrim(SM0->M0_CODMUN) <> Alltrim(cMunDes) .And. Empty((cAliasSFT)->FT_OBSERV) //Opera็๕es Intermunicipais.
		If Alltrim((cAliasSFT)->FT_CFOP)$cTransp //Transporte
			If	XVI->(MsSeek("01"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := Substr(SM0->M0_INSC,1,10)
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "01" //Transporte
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
				XVI->(MSunlock())
			EndIf
		ElseIf  Alltrim((cAliasSFT)->FT_CFOP)$cEnergDis //Energia Distribui็ใo
			If	XVI->(MsSeek("02"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := SM0->M0_INSC
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "02" //Energia Distribui็ใo
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
				XVI->(MSunlock())
			EndIf
		ElseIf Alltrim((cAliasSFT)->FT_CFOP)$cComunic //Comunica็ใo
			If	XVI->(MsSeek("03"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := SM0->M0_INSC
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "03" //Comunica็ใo
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
				XVI->(MSunlock())
			EndIf
		ElseIf Alltrim((cAliasSFT)->FT_ESPECIE) == "NFFA" .And. Alltrim((cAliasSFT)->FT_CFOP)$cAgua //มgua
			If	XVI->(MsSeek("04"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := SM0->M0_INSC
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "04" //มgua
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
				XVI->(MSunlock())
			EndIf
		ElseIf  Alltrim((cAliasSFT)->FT_CFOP)$cVenForEst //Venda Fora do Estabelecimento
			If	XVI->(MsSeek("05"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM + (cAliasSFT)->F3_VALOBSE
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := SM0->M0_INSC
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "05" //Venda Fora do Estabelecimento
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM + (cAliasSFT)->F3_VALOBSE
				XVI->(MSunlock())
			EndIf
		ElseIf  Alltrim((cAliasSFT)->FT_CFOP)$cEnergEle //Energia El้trica - Gera็ใo
			If	XVI->(MsSeek("06"+cCodMun))
				XVI->SEQ14 += (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
			Else
				RecLock("XVI",.T.)
				XVI->SEQ01 := "****"
				XVI->SEQ02 := "08"
				XVI->SEQ03 := Day2Str(FirstDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ04 := Day2Str(LastDate((cAliasSFT)->FT_EMISSAO))
				XVI->SEQ05 := Val(Alltrim(cMesAno))
				XVI->SEQ06 := SM0->M0_INSC
				XVI->SEQ07 := nSeq + 1
				XVI->SEQ08 := "X16"
				XVI->SEQ09 := "06" //Energia El้trica - Gera็ใo
				XVI->SEQ10 := "00000000"
				XVI->SEQ11 := "0000000000000000"
				XVI->SEQ12 := "01"
				XVI->SEQ13 := Substr(cCodMun,1,3)
				XVI->SEQ14 := (cAliasSFT)->FT_BASEICM + (cAliasSFT)->FT_ISENICM + (cAliasSFT)->FT_OUTRICM
				XVI->(MSunlock())
			EndIf
		EndIf
	EndIf
(cAliasSFT)->(dbSkip())
EndDo
(cAliasSFT)->(DBCloseArea())
Return(cArqTrab)

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออออปฑฑ
ฑฑบFuncao    ณ CAT15   บAutor  ณ Cleber Maldonado    บ Data ณ  09/04/2014   บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออออนฑฑ
ฑฑบDesc.     ณGera informa็๕es para gera็ใo do arquivo magn้tico da CAT15-SPบฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ CAT15S.INI / CAT15D.INI                                      บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function CAT15(dDataIni,dDataFin,cArqINI,cArqTXT,cPath)
Local aCampos  := {}
Local cCnpjSA1 := ""
Local cChavMD5 := ""
Local cCampos  := ""
Local cAliasNF := "C15NF"
Local cNomeArq := SM0->M0_CGC+Right(Str(Year(DDATABASE),4),2)+StrZero(Month(DDATABASE),2)+"CD"+IIF(MV_PAR05=1,"N","S")+".TXT"
Local nArq     := 0

Aviso("Aten็ใo!","Esta instru็ใo normativa possui nome de arquivo definido pela SEFAZ/SP. O nome do arquivo informado serแ desconsiderado.",{"OK"})

dbSelectArea("SF3")
dbSetOrder(6)
dbGoTop()

If (TcSrvType()<>"AS/400")

	If SerieNfId("SF3",3,"F3_SERIE") == "F3_SDOC"
		cCampos := ", SF3.F3_SDOC"
	Endif

	//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
	//ณCampos que serao adicionados a query somente se existirem na baseณ
	//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
	If Empty(cCampos)
		cCampos := "%%"
	Else
		cCampos := "% " + cCampos + " %"
	Endif

	BeginSql Alias cAliasNF
		COLUMN F3_ENTRADA AS DATE
		SELECT
			SF3.F3_SERIE,SF3.F3_NFISCAL,SF3.F3_VALCONT,SF3.F3_BASEICM,SF3.F3_VALICM,SF3.F3_ISENICM,SF3.F3_OUTRICM,
			SF3.F3_ESPECIE,SF3.F3_ENTRADA,SF3.F3_CLIEFOR,SF3.F3_LOJA
			%Exp:cCampos%
		FROM
			%table:SF3% SF3
		WHERE
			SF3.F3_FILIAL=%xFilial:SF3% AND
			SF3.F3_ENTRADA>=%Exp:DTOS(dDataIni)% AND
			SF3.F3_ENTRADA<=%Exp:DTOS(dDataFim)% AND
			SF3.F3_CFO IN('5301','5302','5303','5304','5305','5306','5307','6301','6302','6303','6304','6305','6306','6307') AND
			SF3.F3_OBSERV NOT LIKE '%CANCELADA%' AND
			SF3.F3_OBSERV NOT LIKE '%DENEGADA%' AND
			SF3.%NotDel%
		ORDER BY
			1,2
	EndSql
Endif
If Alltrim(cArqINI) == "CAT15-S"

	nArq := FOPEN(cNomeArq)
	IF FERROR() <> 0
		Final("Erro de Leitura. C๓digo: " + STR(FERROR()))
	ENDIF

	If File(cNomeArq)
		If Empty(cChavMD5)
			aAttrib := Directory(Alltrim(cNomeArq))
			If !Empty(aAttrib) .AND. "R" $ aAttrib[1][5]
				Aviso("Aviso!","Arquivo possui atributo somente leitura.",{"OK"})
				cChavMD5 := ""
			Else
				cChavMD5 := MD5FILE(cNomeArq)
			Endif
		Endif
	Else
		Aviso("Aviso!","Arquivo detalhado nใo encontrado na pasta SYSTEM",{"OK"})
	Endif
	AADD(aCampos,{"CNPJIMP"  ,"C",014,0})
	AADD(aCampos,{"IEIMP"    ,"C",014,0})
	AADD(aCampos,{"NOMEIMP"   ,"C",035,0})
	AADD(aCampos,{"RESPIMP"  ,"C",035,0})
	AADD(aCampos,{"CARGOIMP" ,"C",020,0})
	AADD(aCampos,{"TELIMP"   ,"C",012,0})
	AADD(aCampos,{"MAILIMP"  ,"C",035,0})
	AADD(aCampos,{"CNPJEMIT" ,"C",014,0})
	AADD(aCampos,{"EMITIE"   ,"C",014,0})
	AADD(aCampos,{"NOMEEMIT" ,"C",035,0})
	AADD(aCampos,{"PERIODO"  ,"C",006,0})
	AADD(aCampos,{"MODELO"   ,"N",002,0})
	AADD(aCampos,{"SDOC"     ,"C",003,0})
	AADD(aCampos,{"SERIE"    ,"C",TamSx3("F3_SERIE")[1],0})
	AADD(aCampos,{"NFINI"    ,"C",009,0})
	AADD(aCampos,{"NFFIM"    ,"C",009,0})
	AADD(aCampos,{"TOTAL"    ,"N",012,2})
	AADD(aCampos,{"BASEICM"  ,"N",012,2})
	AADD(aCampos,{"ICMS"     ,"N",012,2})
	AADD(aCampos,{"ISENTAS"  ,"N",012,2})
	AADD(aCampos,{"OUTRAS"   ,"N",012,2})
	AADD(aCampos,{"SITUACAO" ,"C",001,0})
	AADD(aCampos,{"SITMD5"   ,"C",032,0})
	cTRB	:=	CriaTrab(aCampos)
	dbUseArea(.T.,__LocalDriver,cTRB,"CAT15",.T.,.F.)
	IndRegua("CAT15",cTRB,"SERIE")
	DbSelectArea("CAT15")
	DbClearIndex()
	DbSetIndex(cTRB+OrdBagExt())
	While (cAliasNF)->(!eof())
		If !dbSeek((cAliasNF)->F3_SERIE)
			RecLock("CAT15",.T.)
			CAT15->CNPJIMP   := SM0->M0_CGC
			CAT15->IEIMP     := SM0->M0_INSC
			CAT15->NOMEIMP   := SM0->M0_NOMECOM
			CAT15->RESPIMP   := MV_PAR01
			CAT15->CARGOIMP  := MV_PAR02
			CAT15->TELIMP    := MV_PAR03
			CAT15->MAILIMP   := MV_PAR04
			CAT15->CNPJEMIT  := SM0->M0_CGC
			CAT15->EMITIE    := SM0->M0_INSC
			CAT15->NOMEEMIT  := SM0->M0_NOMECOM
			CAT15->PERIODO   := Right(Str(Year(DDATABASE),4),2)+StrZero(Month(DDATABASE),2)
			CAT15->MODELO    := Val(aModNot((cAliasNF)->F3_ESPECIE))
			CAT15->SERIE     := (cAliasNF)->F3_SERIE
			CAT15->SDOC      := SerieNfId(cAliasNF,2,"F3_SERIE")
			CAT15->NFINI     := (cAliasNF)->F3_NFISCAL
			CAT15->NFFIM     := (cAliasNF)->F3_NFISCAL
			CAT15->TOTAL     := (cAliasNF)->F3_VALCONT
			CAT15->BASEICM   := (cAliasNF)->F3_BASEICM
			CAT15->ICMS      := (cAliasNF)->F3_VALICM
			CAT15->ISENTAS   := (cAliasNF)->F3_ISENICM
			CAT15->OUTRAS    := (cAliasNF)->F3_OUTRICM
			CAT15->SITUACAO  := IIF(MV_PAR05==1,"N","S")
			CAT15->SITMD5    := cChavMD5
		Else
			Reclock("CAT15",.F.)
			CAT15->NFFIM    := (cAliasNF)->F3_NFISCAL
			CAT15->TOTAL    += (cAliasNF)->F3_VALCONT
			CAT15->BASEICM  += (cAliasNF)->F3_BASEICM
			CAT15->ICMS     += (cAliasNF)->F3_VALICM
			CAT15->ISENTAS  += (cAliasNF)->F3_ISENICM
			CAT15->OUTRAS   += (cAliasNF)->F3_OUTRICM
		Endif
		MsUnlock()
		(cAliasNF)->(dbSkip())
	End
Else
	AADD(aCampos,{"CNPJIMP"		,"C",014,0})
	AADD(aCampos,{"NFFIM"		,"C",020,0})
	AADD(aCampos,{"CNPJEMIT"	,"C",014,0})
	AADD(aCampos,{"CNPJDEST"	,"C",014,0})
	AADD(aCampos,{"REFAPUR"		,"C",006,0})
	AADD(aCampos,{"MODELO"		,"N",002,0})
	AADD(aCampos,{"SDOC"		,"C",003,0})
	AADD(aCampos,{"SERIE"		,"C",TamSx3("F3_SERIE")[1],0})
	AADD(aCampos,{"NFINI"		,"C",009,0})
	AADD(aCampos,{"EMISSAO"		,"C",008,0})
	AADD(aCampos,{"TOTAL"		,"N",012,2})
	AADD(aCampos,{"BASEICM"		,"N",012,2})
	AADD(aCampos,{"ICMS"		,"N",012,2})
	AADD(aCampos,{"ISENTAS"		,"N",012,2})
	AADD(aCampos,{"OUTRAS"		,"N",012,2})
	AADD(aCampos,{"SITUACAO"	,"C",001,0})
	cTRB := CriaTrab(aCampos)
	dbUseArea(.T.,__LocalDriver,cTRB,"CAT15",.T.,.F.)
	IndRegua("CAT15",cTRB,"SERIE")
	DbSelectArea("SA1")
	DbSelectArea("CAT15")
	DbClearIndex()
	DbSetIndex(cTRB+OrdBagExt())
	While (cAliasNF)->(!eof())
		cCnpjSA1 := IIF(SA1->(MsSeek(xFilial("SA1")+(cAliasNF)->F3_CLIEFOR+(cAliasNF)->F3_LOJA)),SA1->A1_CGC,"")
		RecLock("CAT15",.T.)
		CAT15->CNPJIMP	:= SM0->M0_CGC
		CAT15->NFFIM	:= (cAliasNF)->F3_NFISCAL
		CAT15->CNPJEMIT	:= SM0->M0_CGC
		CAT15->CNPJDEST	:= cCnpjSA1
		CAT15->REFAPUR	:= Substr(Dtos((cAliasNF)->F3_ENTRADA),1,6)
		CAT15->MODELO	:= Val(aModNot((cAliasNF)->F3_ESPECIE))
		CAT15->SERIE	:= (cAliasNF)->F3_SERIE
		CAT15->SDOC		:= SerieNfId(cAliasNF,2,"F3_SERIE")
		CAT15->NFINI	:= (cAliasNF)->F3_NFISCAL
		CAT15->EMISSAO	:= Dtos((cAliasNF)->F3_ENTRADA)
		CAT15->TOTAL	:= (cAliasNF)->F3_VALCONT
		CAT15->BASEICM	:= (cAliasNF)->F3_BASEICM
		CAT15->ICMS		:= (cAliasNF)->F3_VALICM
		CAT15->ISENTAS	:= (cAliasNF)->F3_ISENICM
		CAT15->OUTRAS	:= (cAliasNF)->F3_OUTRICM
		CAT15->SITUACAO	:= IIF(MV_PAR05==1,"N","S")
		MsUnlock()
		(cAliasNF)->(dbSkip())
	EndDo
Endif
Return
/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณRecStCE  บAutor  ณGraziele Paro       บ Data ณ  23/04/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณInstru็ใo Normativa sobre Ressarcimento ICMSST no CE 		  บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ RecStCE.INI                                                บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function RecStCE(dDataIni,dDataFin, iEReq)
Local aArea		:=  GetArea()
Local aReg1 := {}
Local aReg2	:= {}
Local cArqTbReg1 := ""
Local cArqTbReg2 := ""
Local cAliasSFT	 := ""
Local cAliasISB1	:= "SB1"
Local cAliasSB7	:= "SB7"
Local lTop		 := .F.
Local cMvEstado	:= SuperGetMv("MV_ESTADO",,.F.)
Local nMvProStCe:= SuperGetMv("MV_PROSTCE",,1)
Local nInscRem	:= 0
Local nInscDest	:= 0
Local aProdutos := {}
Local cProdutos := ""
Local nY		:= 0
Local cCampos := ""
Default iEReq := "00000000000"

aadd(aReg1,{"IEREQ",    	'N',14,0}) //Incri็ใo do representante ao ressarcimento no CGF da Sefaz/CE
aadd(aReg1,{"IEREMET",    	'N',14,0}) //Inscri็ใo estadual do remetente na Sefaz/CE ou Fisco de origem
aadd(aReg1,{"IEDESTI", 		'N',14,0}) //Inscria็ใo estadual do destinatario na UF de destino das mercadorias
aadd(aReg1,{"NUMERONF",		'C',09,0}) //Numero NF
aadd(aReg1,{"SERIE",		'C',03,0}) //S้rie NF
aadd(aReg1,{"EMISSAO",  	'D',08,0}) //Data de emissใo da NF no padrใo: DD/MM/AAAA
aadd(aReg1,{"CFOP", 		'N',04,0}) // C๓digo Fiscal de Opera็ใo e Presta็๕es,conforme Ajuste SINIEF 07/01
aadd(aReg1,{"UF", 			'C',02,0}) //Unidade da federa็ใo de origem nas compras e do destinatarionas vendas
aadd(aReg1,{"CODINT", 		'C',14,0}) //Codigo interno odo produto de informe
aadd(aReg1,{"QUANT", 		'N',13,3}) //Quantidade de embalagens do produto (com 3 decimais)
aadd(aReg1,{"VALOR", 		'N',13,3}) //Valor total do produto (com 3 deciamais)
aadd(aReg1,{"DESCONTO", 	'N',13,2}) //Valor Desconto concedido (com 2 deciamais)
aadd(aReg1,{"BCICMS", 		'N',13,2}) //Base de cแlculo do ICMS pr๓prio (com 2 deciamais)
aadd(aReg1,{"VALICMS", 		'N',13,2}) //Valor do ICMS pr๓prio de opera็ใo (com 2 decimais)
aadd(aReg1,{"DESPACES", 	'N',13,2}) //Valotr de despesa acess๓rio (frete,seguro e outros encargo, com 2 decimais)
aadd(aReg1,{"ALIQIPI", 		'N',05,2}) //Alํquota utilizada no cแculo do IPI (com 2 deciamis)
aadd(aReg1,{"VALIPI",  		'N',13,2}) //Valor de IPI (com 2 deciamis)
aadd(aReg1,{"BCICMST", 		'N',13,2}) //Base de cแlculo do ICMS retido por substitui็ใo tributaria (com 2 deciamis)
aadd(aReg1,{"VALICMST", 	'N',13,2}) //ICMS retido por substitui็ใo tributaraia (c0m 2 decimais)
aadd(aReg1,{"EVENTO", 		'C',01,0}) //Codigo do eveneto da opra็ใo:C-compra,V-vendas e I-inventario

//CRIA TABELA TEMPORARIA E INDICE QUE SERA UTILIZADO NO REGISTRO 1
cArqTbReg1 := CriaTrab(aReg1,.T.)
dbUseArea(.T.,,cArqTbReg1,"TRB",.F.,.F.)
IndRegua("TRB",cArqTbReg1,"DTOS(EMISSAO)+NUMERONF+SERIE+CODINT")
dbSelectArea("TRB")
DbClearIndex()
DbSetIndex(cArqTbReg1+OrdBagExt())

aadd(aReg2,{"IEREQ",    	'N',14,0}) //Inscri็ใo estadual do remetente na Sefaz/CE ou Fisco de origem
aadd(aReg2,{"CODINTERNO", 	'C',14,0}) //Codigo interno do produto do informante
aadd(aReg2,{"DESCRICAO",	'C',53,0}) //Descri็ใo do produto
aadd(aReg2,{"UN",  			'C',06,0}) //Unidade de medidasde comercializa็ใo do produto
aadd(aReg2,{"PESO", 		'N',07,3}) // Peso da unidade de comercializa็ใo (em kg) co 3 deciamais
aadd(aReg2,{"NCM", 			'C',10,0}) //Codifica็ใo da Nomenclatura Comum do Mercosul (9999.99.99)

//CRIA TABELA TEMPORARIA E INDICE QUE SERA UTILIZADO NO REGISTRO 2
cArqTbReg2 := CriaTrab(aReg2,.T.)
dbUseArea(.T.,,cArqTbReg2,"PRD",.F.,.F.)
IndRegua( "PRD", cArqTbReg2,"CODINTERNO+DESCRICAO")
dbSelectArea("PRD")

IF cMvEstado == "CE"
	dbSelectArea("SB1")
	SB1->(DbSetOrder(1))
	#IFDEF TOP
		If (TcSrvType ()<>"AS/400")

			If SerieNfId("SF3",3,"F3_SERIE") == "F3_SDOC"
				cCampos := ", SF3.F3_SDOC"
			Endif

			//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
			//ณCampos que serao adicionados a query somente se existirem na baseณ
			//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู
			If Empty(cCampos)
				cCampos := "%%"
			Else
				cCampos := "% " + cCampos + " %"
			Endif

			lTop	:= .T.
			cAliasSFT	:=	GetNextAlias()

			BeginSql Alias cAliasSFT

				COLUMN FT_EMISSAO AS DATE

				SELECT
					SFT.FT_FILIAL,
					SFT.FT_TIPOMOV,
					SFT.FT_EMISSAO,
					SFT.FT_NFISCAL,
					SFT.FT_SERIE,
					SFT.FT_SERIE,
					SFT.FT_CLIEFOR,
					SFT.FT_LOJA,
					SFT.FT_ESTADO,
					SFT.FT_CFOP,
					SFT.FT_PRODUTO,
					SB1.B1_DESC,
					SFT.FT_POSIPI,
					SFT.FT_QUANT,
					SFT.FT_DESCONT,
					SFT.FT_TOTAL,
					SFT.FT_BASEICM,
					SFT.FT_VALICM,
					SFT.FT_FRETE + FT_SEGURO + FT_DESPESA DESPESAS,
					SFT.FT_ALIQIPI,
					SFT.FT_VALIPI,
					SFT.FT_BASERET,
					SFT.FT_ICMSRET,
					SB1.B1_UM,
					SFT.FT_PESO,
					SFT.FT_POSIPI
					%Exp:cCampos%
				FROM
				    %TABLE:SFT% SFT
				    INNER JOIN %TABLE:SB1% SB1 ON(SFT.FT_PRODUTO = SB1.B1_COD AND SFT.FT_FILIAL = SB1.B1_FILIAL)
				WHERE
					SFT.FT_ICMSRET > 0
					AND SFT.FT_OBSERV NOT LIKE '%CANCELAD%'
					AND SFT.FT_ESTADO <> %EXP:cMvEstado%
					AND SFT.FT_FILIAL=%XFILIAL:SFT%
					AND SFT.%NOTDEL%
					AND SB1.%NOTDEL%
					AND SFT.FT_EMISSAO >= %EXP:DTOS(DDATAINI)%
					AND SFT.FT_EMISSAO <= %EXP:DTOS(DDATAFIN)%
				ORDER BY SFT.FT_EMISSAO
			EndSql
			DbSelectArea (cAliasSFT)
			(cAliasSFT)->(DbGoTop())
		Else
	#ENDIF
			cIndex	:= CriaTrab(NIL,.F.)
			cFiltro	:= 'FT_FILIAL=="'+xFilial ("SFT")+'".And.'
			cFiltro += 'DTOS (FT_EMISSAO)>="'+DTOS(DDATAINI)+'" .And. '
			cFiltro += 'DTOS (FT_EMISSAO)<="'+DTOS(DDATAFIN)+'"'
			IndRegua (cAliasSFT, cIndex, SFT->(IndexKey ()),, cFiltro)
			nIndex := RetIndex(cAliasSFT)
			#IFNDEF TOP
				DbSetIndex (cIndex+OrdBagExt ())
			#ENDIF
			DbSelectArea (cAliasSFT)
			DbSetOrder (nIndex+1)
	#IFDEF TOP
		Endif
	#ENDIF

	If lTop
		cAliasSB1	:= cAliasSFT
	EndIf

	While (cAliasSFT)->(!EOF())

		IF !lTop
		   (cAliasSB1)->(MsSeek(xFilial("SB1")+(cAliasSFT)->FT_PRODUTO))
		ENDIF

		IF Val((cAliasSFT)->FT_CFOP) >= 5 //saida
			SA1->(DbSetOrder(1))
			IF (SA1->(dbSeek(xFilial("SA1")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA)))
				nInscRem:= SM0->M0_INSC
		   		nInscDest:= SA1->A1_INSCR
		   	EndIf
		Else
			SA2->(DbSetOrder(1)) //Entrada
			IF (SA2->(dbSeek(xFilial("SA2")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA)))
				nInscRem:= SA2->A2_INSCR
		   		nInscDest:=SM0->M0_INSC
		   	EndIf
		EndIf

		RecLock("TRB",.T.)
		TRB->IEREQ 		:= Val(iEReq)
		TRB->IEREMET	:= Val(nInscRem)
		TRB->IEDESTI	:= Val(nInscDest)
		TRB->NUMERONF	:= (cAliasSFT)->FT_NFISCAL
		TRB->SERIE		:= SerieNfId(cAliasSFT,2,"FT_SERIE")
		TRB->EMISSAO	:= (cAliasSFT)->FT_EMISSAO
		TRB->CFOP		:= Val((cAliasSFT)->FT_CFOP)
		TRB->UF			:= (cAliasSFT)->FT_ESTADO
		TRB->CODINT		:= IIF(nMvProStCe==2,Right((cAliasSFT)->FT_PRODUTO,14),	Left((cAliasSFT)->FT_PRODUTO,14))
		TRB->QUANT		:= (cAliasSFT)->FT_QUANT
		TRB->VALOR		:= (cAliasSFT)->FT_TOTAL
		TRB->DESCONTO	:= (cAliasSFT)->FT_DESCONT
		TRB->BCICMS		:= (cAliasSFT)->FT_BASEICM
		TRB->VALICMS	:= (cAliasSFT)->FT_VALICM
		TRB->DESPACES	:= (cAliasSFT)->DESPESAS
		TRB->ALIQIPI	:= NoRound((cAliasSFT)->FT_ALIQIPI,2)
		TRB->VALIPI		:= (cAliasSFT)->FT_VALIPI
		TRB->BCICMST	:= (cAliasSFT)->FT_BASERET
		TRB->VALICMST	:= (cAliasSFT)->FT_ICMSRET
		TRB->EVENTO		:= IIF((cAliasSFT)->FT_TIPOMOV =="S","V","C")
		TRB->(MSunlock())

		RecLock("PRD",.T.)
		PRD->IEREQ		:=	Val(iEReq)
		PRD->CODINTERNO	:= IIF(nMvProStCe==2,Right((cAliasSFT)->FT_PRODUTO,14),	Left((cAliasSFT)->FT_PRODUTO,14))
		PRD->DESCRICAO	:= LEFT((cAliasSB1)->B1_DESC,53)
		PRD->UN 		:= (cAliasSB1)->B1_UM
		PRD->PESO       := (cAliasSFT)->FT_PESO
		PRD->NCM        := (cAliasSFT)->FT_POSIPI
		PRD->(MSunlock())

		IF Ascan(aProdutos,{|x|x[2]==(cAliasSFT)->FT_PRODUTO}) == 0
			aAdd(aProdutos,{(cAliasSFT)->FT_EMISSAO, (cAliasSFT)->FT_PRODUTO})
		EndIf

   (cAliasSFT)->(dbSkip())
	EndDo

	cProdutos := "("
	For nY = 1 to Len(aProdutos)
		cProdutos += "'"+aProdutos[nY,2]+"'"
		IF nY <> Len(aProdutos)
			cProdutos += ","
		Else
			cProdutos += ")"
		EndIf
	Next nY
	cProdutos := "%" + cProdutos + "%"


	//Query para buscar os registros de Inventแrio
	#IFDEF TOP
	If (TcSrvType ()<>"AS/400")
	     lTop	:= .T.
	     cAliasSB7	:=	GetNextAlias()

	    	BeginSql Alias cAliasSB7

	    	COLUMN B7_DATA AS DATE

	    	SELECT 	SB7.B7_FILIAL,
	    			SB7.B7_COD,
					SB7.B7_LOCAL,
			   		SB7.B7_TIPO,
					SB7.B7_DOC,
					SB7.B7_QUANT,
					SB7.B7_DATA,
					SB1.B1_DESC,
					SB1.B1_POSIPI,
					SB1.B1_UM
			FROM 	%TABLE:SB7% SB7
			INNER JOIN %TABLE:SB1% SB1 ON(SB7.B7_COD = SB1.B1_COD AND SB7.B7_FILIAL = SB1.B1_FILIAL)
			WHERE	SB7.%NOTDEL%
					AND SB7.B7_COD IN%Exp:cProdutos%
	       			AND SB7.B7_DATA >= %EXP:DTOS(DDATAINI)%
	       			AND SB7.B7_DATA <= %EXP:DTOS(DDATAFIN)%
			ORDER BY SB7.B7_DATA
			EndSql
		 DbSelectArea (cAliasSB7)
	     (cAliasSB7)->(DbGoTop())
	Else
	#ENDIF
	         cIndex	:= CriaTrab(NIL,.F.)
	         cFiltro	:= 'B7_FILIAL=="'+xFilial ("SB7")+'".And.'
	         cFiltro += 'DTOS (B7_DATA)>="'+DTOS(DDATAINI)+'" .And. '
	         cFiltro += 'DTOS (B7_DATA)<="'+DTOS(DDATAFIN)+'"'

		    IndRegua (cAliasSB7, cIndex, SFT->(IndexKey ()),, cFiltro)
		    nIndex := RetIndex(cAliasSB7)

			#IFNDEF TOP
				DbSetIndex (cIndex+OrdBagExt ())
			#ENDIF

			DbSelectArea (cAliasSB7)
		    DbSetOrder (nIndex+1)
	#IFDEF TOP
		Endif
	#ENDIF

	If lTop
		cAliasISB1	:= cAliasSB7
	EndIf

   While (cAliasSB7)->(!EOF())

			IF !lTop
		   		(cAliasISB1)->(MsSeek(xFilial("SB1")+(cAliasSB7)->B7_COD))
			ENDIF

			RecLock("TRB",.T.)
			TRB->IEREQ 		:= 0
			TRB->IEREMET	:= 0
			TRB->IEDESTI	:= 0
			TRB->NUMERONF	:= "000000000"
			TRB->SERIE		:= "000"
			TRB->EMISSAO	:= (cAliasSB7)->B7_DATA
			TRB->CFOP		:= 0
			TRB->UF			:= "CE"
			TRB->CODINT		:= IIF(nMvProStCe==2,Right((cAliasSB7)->B7_COD,14),	Left((cAliasSB7)->B7_COD,14))
			TRB->QUANT		:= (cAliasSB7)->B7_QUANT
			TRB->VALOR		:= 0
			TRB->DESCONTO	:= 0
			TRB->BCICMS		:= 0
			TRB->VALICMS	:= 0
			TRB->DESPACES	:= 0
			TRB->ALIQIPI	:= 0
			TRB->VALIPI		:= 0
			TRB->BCICMST	:= 0
			TRB->VALICMST	:= 0
			TRB->EVENTO		:= "I"
			TRB->(MSunlock())

			RecLock("PRD",.T.)
			PRD->IEREQ		:= 0
			PRD->CODINTERNO	:= IIF(nMvProStCe==2,Right((cAliasSB7)->B7_COD,14),	Left((cAliasSB7)->B7_COD,14))
			PRD->DESCRICAO	:= LEFT((cAliasISB1)->B1_DESC,53)
			PRD->UN 		:= (cAliasISB1)->B1_UM
			PRD->PESO       := 0
			PRD->NCM        := (cAliasISB1)->B1_POSIPI
			PRD->(MSunlock())
	(cAliasSB7)->(dbSkip())
	EndDo

	TRB->(DbGoTop())
	PRD->(DbGoTop())
	RestArea(aArea)
EndIf
Return

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณPrograma  ณMd5SX1    ณ Autor ณGustavo G. Rueda       ณ Data ณ21.10.2003ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณFuncao para ajustar as perguntas do SX1.                    ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณRetorno   ณExpL -> lRet = Retornando Sucesso ou Falha da funcao.       ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณParametrosณNenhum                                                      ณฑฑ
ฑฑณ          ณ                                                            ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ   DATA   ณ Programador   ณManutencao Efetuada                         ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณ          ณ               ณ                                            ณฑฑ
ฑฑภฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤูฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Static Function Md5SX1 (cPerg)

Return Nil

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑฺฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฟฑฑ
ฑฑณFuncao    ณ GUIRSSX1 ณ Autor ณ Rodrigo Zatt          ณ Data ณ23.04.2008ณฑฑ
ฑฑรฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤดฑฑ
ฑฑณDescrio ณ Ajuste das perguntas para geracao do arquivo magnetico     ณฑฑ
ฑฑณ          ณ GMB do Sistema de Apuracao dos Indices dos Municipios (RS) ณฑฑ
ฑฑ|          |                                                            |ฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/
Function GUIRSSX1()

Return Nil

//-------------------------------------------------------------------
/*/{Protheus.doc} FisGetEIC

Retorna array com os dados do processo de importa็ใo

@param		cFil	Filial do registro enviado
@param		cNF		N๚mero da nota de entrada
@param 		cSer	S้rie da nota de entrada
@param 		cFor	Fornecedor da nota de entrada
@param 		cLoj	Loja do fornecedor da nota de entrada
@param 		cCpo	Rela็ใo de campos para a sele็ใo.
					Se for omitido retorna todos os campos das tabelas SWN, SW6, SW7 e SW8.
					Nesse caso o array retorna duas posi็๕es, sendo: 1-conteudo campo e 2-nome campo

@return	aDados	Array com o conteudo dos campos solicitados

@author	Mauro A. Goncalves
@since		12/08/2014
@version	11.8
/*/
//-------------------------------------------------------------------

Function FisGetEIC(cFil, cNF, cSer, cFor, cLoj, cHAWB, aCpo,cLinha,cProduto,cTec,cDtEmi,cTp,nMoeda)
Local	aDados		:= {}
Local	cCampos	:= ""
Local	nA			:= 0
Local	cAlsEIC	:=	GetNextAlias()

Default cFil := ""
Default cNF  := ""
Default cSer := ""
Default cFor := ""
Default cLoj := ""
Default aCpo := {}
Default cDtEmi := ""
Default cTP := ""
Default nMoeda := 0

For nA:=1 To Len(aCpo)
	cCampos += aCpo[nA] + ","
Next

If !(cTp$"N")
	lNomCpo := Empty(cCampos)
	cCampos := IIf(lNomCpo," SWN.*, SW4.*, SW6.*, SW7.*, SW8.*, SYD.*, SYE.* ", cCampos)
	cCampos := "%" + Left(cCampos,Len(cCampos)-1) + " " + "%"

	cWhere := 	"%" + "SWN.WN_FILIAL = '" + xFilial("CD5") + "' AND "

	If !Empty(cNF)
		cWhere	+=	"SWN.WN_DOC='"+cNF+"' AND "
	Endif

	If !Empty(cSer)
		cWhere	+=	"SWN.WN_SERIE='"+cSer+"' AND "
	Endif

	If !Empty(cTec)
		cWhere	+=	"SWN.WN_TEC = '" + cTec +"' AND "
	EndIf

	IF !Empty(cFor) .And. !Empty(cLoj)
		cWhere	+=	"SWN.WN_FORNECE='"+cFor+	"' AND "
		cWhere	+=	"SWN.WN_LOJA='"+cLoj+"' AND "
	Endif

	IF !Empty(cHAWB)
		cWhere	+=	"SWN.WN_HAWB='"+cHAWB+"' AND "
	Endif

	If !Empty(cLinha)
		cWhere	+=	"SWN.WN_LINHA = " + Alltrim(Str(cLinha)) +" AND "
	EndIf

	If !Empty(cProduto)
		cWhere	+=	"SWN.WN_PRODUTO = '" + cProduto +"' AND "
	EndIf

	cWhere	+=	"SWN.D_E_L_E_T_=' '%"

	#IfDef TOP
		//SWN-Nota fiscal de importa็ใo
		//SW4-Capa Prepara็ใo de Licen็a Importa็ใo
		//SW6-Declara็ใo de importa็ใo
		//SW7-Itens da Declara็ใo de Importa็ใo
		//SW8-Itens da invoice
		//SWD-Despesas
		//SYE-Taxas de Conversใo

		BeginSql Alias cAlsEIC
			SELECT %Exp:cCampos%
			FROM %Table:SWN% SWN
			JOIN %Table:SW4% SW4 ON (SW4.W4_FILIAL=%xFilial:SW4% And SW4.W4_PGI_NUM=SWN.WN_PGI_NUM And SW4.%NotDel%)
			JOIN %Table:SW6% SW6 ON (SW6.W6_FILIAL=%xFilial:SW6% And SW6.W6_HAWB=SWN.WN_HAWB And SW6.%NotDel%)
			JOIN %Table:SW7% SW7 ON (SW7.W7_HAWB=SWN.WN_HAWB And SW7.W7_SI_NUM=SWN.WN_SI_NUM And SW7.W7_CC=SWN.WN_CC And SW7.%NotDel%)
			JOIN %Table:SW8% SW8 ON (SW8.W8_FILIAL=%xFilial:SW8% And SW8.W8_HAWB=SWN.WN_HAWB And SW8.W8_INVOICE=SWN.WN_INVOICE And SW8.W8_PO_NUM=SWN.WN_PO_EIC And SW8.W8_POSICAO=SWN.WN_ITEM And SW8.%NotDel%)
			JOIN %Table:SYD% SYD ON (SYD.YD_FILIAL=%xFilial:SYD% And SYD.YD_TEC=SWN.WN_TEC And SYD.YD_EX_NCM=SWN.WN_EX_NCM And SYD.%NotDel%)
			LEFT JOIN %Table:SYE% SYE ON (SYE.YE_FILIAL=%xFilial:SYE% And SYE.YE_DATA=SW6.W6_DT_NF And SYE.YE_MOEDA=SW4.W4_MOEDA And SYE.%NotDel%)
			WHERE %Exp:cWhere%
		EndSql

		For nA:=1 To (cAlsEIC)->(FCOUNT())
			If lNomCpo
				AADD(aDados,{(cAlsEIC)->(FIELDGET(nA)),(cAlsEIC)->(FIELDNAME(nA))})
			Else
				AADD(aDados,(cAlsEIC)->(FIELDGET(nA)))
			Endif
		Next

		(cAlsEIC)->(DBCloseArea())
	#EndIf
Else

	#IfDef TOP
		cWhere := "%SYE.YE_FILIAL = '" + xFilial("SYE")
		cWhere += "' AND SYE.YE_DATA = '" + DTOS(cDtEmi)
		cWhere += "' AND SYE.YE_MOE_FIN = " + ALLTRIM(STR(nMoeda))
		cWhere += "  AND SYE.D_E_L_E_T_= ' '%"

		BeginSql Alias cAlsEIC
			SELECT SYE.YE_VLFISCA
			FROM %Table:SYE% SYE
			WHERE %Exp:cWhere%
		EndSql

		AADD(aDados, (cAlsEIC)->YE_VLFISCA) // Valor da cota็ใo da moeda no EASY no mesmo dia da EMISSAO DA NOTA
		(cAlsEIC)->(DbCloseArea())
	#EndIf
EndIf

Return aDados

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณSinCliFor  บAutor  ณJoใo Paulo Balbino บ Data ณ  17/06/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณ Carrega as areas de trabalho de Cli / For (SINCONF)   	    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SINCOF.INI                                                 บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function SinCliFor (cAliasSA)

Local cIni			:= DTOS(dDataIni)
Local cFim			:= DTOS(dDataFim)
Local cApelido		:= IIF(cAliasSA == "SA1", "TR1", "TR2")
Local cCfAux1		:= IIF(cAliasSA == "SA2","1","5")
Local cCfAux2		:= IIF(cAliasSA == "SA2","2","6")
Local cCfAux3		:= IIF(cAliasSA == "SA2","3","7")
Local cSelect		:= ""
Local cFrom			:= ""
Local cWhere		:= ""
Local cSubWhe		:= ""
Local cCondic 		:= "SF3->F3_FILIAL = '" + cFilAnt + "' .AND. DTOS(F3_ENTRADA) >= '" + cIni + "' .AND. DTOS(F3_ENTRADA) <= '"+ cFim +"'"
Local cAux			:= &( '{|| ' + cCondic + ' }')
Local aStru			:= {}
Local cArq1			:= NIL
Local lRet			:= .F.
Local cCampo		:= " "
Local cDbfFil		:= " "
Local cDbfCod		:= " "
Local cDbfLoj		:= " "

#IFDEF TOP
	If TcSrvType() <> "AS/400"

		cCampo		:= cAliasSA + "." + SUBSTR(cAliasSA,2,2) + "_"

		cSelect 	:= "%" + cCampo + "FILIAL" + ", "  + cCampo + "COD"  +", "+ cCampo + "LOJA %"
		cFrom   	:= "%"+ RetSqlName(cAliasSA) + " " + cAliasSA + "%"
		cWhere		:= "%"+ cCampo + "COD" + xOperConcat() + cCampo + "LOJA %"
		cSubWhe		:= "%SF3.F3_CLIEFOR" + xOperConcat() + "SF3.F3_LOJA %"

		BeginSql Alias cApelido

				COLUMN F3_ENTRADA AS DATE

				SELECT
					%Exp:cSelect%
				FROM
					%Exp:cFrom%
				WHERE
					%Exp:cWhere% IN (SELECT DISTINCT %Exp:cSubWhe%

										FROM  %Table:SF3% SF3
										WHERE SF3.F3_FILIAL = %Exp:xFilial("SF3")% AND SF3.F3_ENTRADA >= %Exp:cIni% AND SF3.F3_ENTRADA <= %Exp:cFim% AND SUBSTRING(SF3.F3_CFO,1,1) IN (%EXP:cCfAux1%,%EXP:cCfAux2%,%EXP:cCfAux3%) AND %NotDel%  )

		EndSql

	ELSE
#ELSE
		DbSelectArea("SF3")
		DbSetOrder(4)
		DbSetFilter(cAux ,cCondic)

			cCampo 	:= SUBSTR(cALiasSA, 2,2)+"_"
			cDbfFil	:= cCampo + "FILIAL"
			cDbfCod	:= cCampo + "COD"
			cDbfLoj	:= cCampo + "LOJA"

			Aadd(aStru,{cDbfFil 	  	,"C",08	,0})
			Aadd(aStru,{cDbfCod			,"C",06	,0})
			Aadd(aStru,{cDbfLoj 		,"C",02	,0})

			cArq1 	:= CriaTrab(aStru, .T. )


			dbUseArea(.T.,,cArq1,cApelido,.T.,.F.)

			(cAliasSA)->(DbSelectArea((cAliasSA)))
			(cAliasSA)->(DbSetOrder(1))

			While SF3->(!EOF())
				lRet := .F.
				IF (cAliasSA)->(DbSeek(xFilial((cAliasSA)) + SF3->F3_CLIEFOR + SF3->F3_LOJA))

					Reclock(cApelido,.T.)
						(cApelido)->(cDbfFil)	:= (cAliasSA)->(cDbfFil)
						(cApelido)->(cDbfCod)	:= (cAliasSA)->(cDbfCod)
						(cApelido)->(cDbfLoj)	:= (cAliasSA)->(cDbfLoj)
					MsUnlock()

					WHILE ((cApelido)->(cDbfCod)	+ (cApelido)->(cDbfLoj) == SF3->F3_CLIEFOR + SF3->F3_LOJA)
						SF3->(DbSkip())
						lRet := .T.
						Loop

					ENDDO

				ENDIF

				IF!(lRet)
						SF3->(DbSkip())
				ENDIF

			ENDDO

			(cApelido)->(DbGoTop())
			SF3->(DbGoTop())


#ENDIF

#IFDEF TOP
	END IF
#ENDIF
Return .T.

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณxOperConcatบAutor  ณJoใo Paulo Balbino บ Data ณ  17/06/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณFun็ใo para tratar a concatena็ใo em diversos bancos de dadosฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ SINCOF.INI                                                 บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/

Static Function xOperConcat()
Local cTipoDB
Local cSrvType
Local lOracle
Local lPostgres
Local lDB2
Local lInformix
Local cOperConcat

//----------------------------------------------
// Fun็ใo para tratar a concatena็ใo em diversos
// bancos de dados
//----------------------------------------------

//carrega as variaveis static
#IFDEF TOP
	cTipoDB	:= Alltrim(Upper(TCGetDB()))
	cSrvType	:= Alltrim(Upper(TCSrvType()))
#ELSE
	cTipoDB	:= ""
	cSrvType	:= Alltrim(Upper(TCSrvType()))
#ENDIF

lOracle	:= "ORACLE"   $ cTipoDB
lPostgres 	:= "POSTGRES" $ cTipoDB
lDB2		:= "DB2"      $ cTipoDB
lInformix 	:= "INFORMIX" $ cTipoDB

cOperConcat := If( lOracle .Or. lPostgres .Or. lDB2 .Or. lInformix, " || ", " + " )

Return cOperConcat

//-------------------------------------------------------------------
/*/{Protheus.doc} GIARSIC

Tratamento para gera็ใo dos registros dos anexos I.c. e V.c.
referentes เ coluna Ajuste/Excluido
Serใo gerados apenas os c๓digos 1, 2 e 4, devido a legisla็ใo
nใo estar clara quanto aos demais c๓digos

@param		cAlias	  Alias referente a Apura็ใo de ICMS

@return	Return .T.

@author	Mauro A. Gon็alves
@since		03/11/2014

/*/
//-------------------------------------------------------------------
Function GIARSIC(cAlias)
Local aArea		:= GetArea()
Local cTMP		:= ""
Local cCFOP		:= ""
Local aCpo		:= {}
Local nSeq		:= 0
Local nVlAju	:= 0

//Cria arquivo temporario
AADD(aCpo,{"CFOP"		,"C",04,0})
AADD(aCpo,{"CODAJU"	,"C",03,0})
AADD(aCpo,{"SEQAJU"	,"N",02,0})
AADD(aCpo,{"VALAJU"	,"N",13,2})
AADD(aCpo,{"ESPAJU"	,"C",60,0})

If Select("AJU") > 0
	AJU->(DbCloseArea())
Endif

cTMP := CriaTrab(aCpo)
dbUseArea(.T.,__LocalDriver,cTMP,"AJU",.T.,.F.)

(cAlias)->(DbGotop())
While !(cAlias)->(EOF())
	nSeq	:= 0
	cCFOP	:= (cAlias)->CFOP
	While !(cAlias)->(EOF()) .And. (cAlias)->CFOP==cCFOP
		RecLock(cAlias,.F.) //libera alias da apura็ใo
		nSeq += 1
		//Substitui็ใo
		//If (cAlias)->ICMSRET  > 0 .And. VerCodAju("RS",(cAlias)->CFOP,"1")
		If (cAlias)->VlRETIC  > 0 .And. VerCodAju("RS",(cAlias)->CFOP,"1") // O IF foi alterado, devido inconsistencias no registro IC [VlRETIC] PROPRIEDADE CRIADA NO FISXAฺRA 12.1.14 15/03/2017
			(cAlias)->VLEXCLRS += (cAlias)->VlRETIC //grava no alias apura็ใo o total dos ajustes/exclusoes
			RecLock("AJU",.T.)
			AJU->CFOP 	:= (cAlias)->CFOP
			AJU->CODAJU	:= "001"
			AJU->SEQAJU	:= nSeq
			AJU->VALAJU	:= (cAlias)->VlRETIC
			AJU->ESPAJU	:= Space(60)
			MsUnLock()
		Endif
		//IPI
		If (cAlias)->(ColumnPos("VLIPIOBS")> 0 .and. VLIPIOBS > 0) .And. VerCodAju("RS",(cAlias)->CFOP,"2")
			(cAlias)->VLEXCLRS += ((cAlias)->IPIOBS + (cAlias)->VALIPI) //grava no alias apura็ใo o total dos ajustes/exclusoes
			RecLock("AJU",.T.)
			AJU->CFOP 	:= (cAlias)->CFOP
			AJU->CODAJU	:= "002"
			AJU->SEQAJU	:= nSeq
			AJU->VALAJU	:= ((cAlias)->IPIOBS + (cAlias)->VALIPI)
			AJU->ESPAJU	:= Space(60)
			MsUnLock()
		Endif
		//Contแbil menor que a base de ICMS
		If (cAlias)->(VALCONT < BASEICM) .And. VerCodAju("RS",(cAlias)->CFOP,"4")
			(cAlias)->VLEXCLRS += (cAlias)->(BASEICM-VALCONT) //grava no alias apura็ใo o total dos ajustes/exclusoes
			RecLock("AJU",.T.)
			AJU->CFOP	:= (cAlias)->CFOP
			AJU->CODAJU	:= "004"
			AJU->SEQAJU	:= nSeq
			AJU->VALAJU	:= (cAlias)->(BASEICM-VALCONT)
			AJU->ESPAJU	:= Space(60)
			MsUnLock()
		Endif
		//Sempre serแ gerado quando houver rela็ใo com o cfop
		If VerCodAju("RS",(cAlias)->CFOP,"5")
			(cAlias)->VLEXCLRS += (cAlias)->(BASEICM+ISENICM+OUTRICM) //grava no alias apura็ใo o total dos ajustes/exclusoes
			RecLock("AJU",.T.)
			AJU->CFOP	:= (cAlias)->CFOP
			AJU->CODAJU	:= "005"
			AJU->SEQAJU	:= nSeq
			AJU->VALAJU	:= (cAlias)->(BASEICM+ISENICM+OUTRICM)
			AJU->ESPAJU	:= Space(60)
			MsUnLock()
		Endif
		//Complementar/Pauta
		If VerCodAju("RS",(cAlias)->CFOP,"6")
			If (cAlias)->ICMSCOM > 0
				nVlAju := (cAlias)->ICMSCOM
			Else
				nVlAju := (cAlias)->(BASEICM-(BSICMOR+OUTRICM+ISENICM))
			Endif
			If nVlAju > 0
				(cAlias)->VLEXCLRS += nVlAju //grava no alias apura็ใo o total dos ajustes/exclusoes
				RecLock("AJU",.T.)
				AJU->CFOP	:= (cAlias)->CFOP
				AJU->CODAJU	:= "006"
				AJU->SEQAJU	:= nSeq
				AJU->VALAJU	:= nVlAju
				AJU->ESPAJU	:= Space(60)
				MsUnLock()
			Endif
		Endif
		(cAlias)->(DbSkip())
	Enddo
Enddo

RestArea(aArea)

Return .t.

//-------------------------------------------------------------------
/*/{Protheus.doc} VerCodAju

Verifica se o C๓digo Ajuste pertence ao CFOP

@param		cUF			  UF do C๓digo de Ajuste
			cCodAju	  C๓digo de Ajuste

@return	Return .T.

@author	Mauro A. Gon็alves
@since		27/04/2015

/*/
//-------------------------------------------------------------------
Function VerCodAju(cUF,cCFOP,cCodAju)
Local aArea		:= GetArea()
Local cAlsQry	:= ""
Local lRet		:= .F.

If AliasIndic("F00")
	#IFDEF TOP
		If (TcSrvType()<>"AS/400")
			cAlsQry := GetNextAlias()

			BeginSql Alias cAlsQry
				COLUMN F00_DTFIMV AS DATE
				SELECT Count(*) F00_Count
				FROM %Table:F00%
				WHERE	F00_FILIAL = %xFilial:F00% AND
						F00_UF = %Exp:cUF% AND
						F00_CFOP = %Exp:cCFOP% AND
						F00_CODAJU = %Exp:cCodAju% AND
						F00_DTFIMV = '        ' AND
						%NotDel%
			EndSql
		EndIf
	#ENDIF
	lRet := (cAlsQry)->F00_Count > 0
	(cAlsQry)->(DbCloseArea())
EndIf
RestArea(aArea)

Return lRet

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณIssFort  บAutor  ณGraziele Paro       บ Data ณ  24/12/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณInstru็ใo Normativa s		  บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ IssFort.INI                                                บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function IssFort(dDataIni,dDataFin, aWizard)
Local aArea		:=  GetArea()
Local aTRB := {}
Local nISSRet		:= 0
Local cArq		:= ""
Local cTipoTrib := 1
Local cVersao		:= aWizard[01][01]
Local cAliasSFT	 := ""
Local cEspNCons	 := Alltrim(aWizard[01][02])
Local cDentMunic	 := ""
Local nTipoDoc 	 := ""
Local cWhere		 := ""
Local cCodUFLoc	 := ""
Local cCodCidLoc	 := ""
Local lISSXMUN   := SuperGetMv("MV_ISSXMUN",,.F.)
Local dDtCpIss   := cTod(" \  \   ")
Local cSelect			:= ""

DEFAULT  cVersao := "2.0"


DbSelectArea("SM0")
SM0->(DbGoTop ())
SM0->(MsSeek(cEmpAnt + cFilAnt))


aadd(aTRB,{"VERSAO",   	 	'C',03,0}) //1-Indicador da Versใo do Layout
aadd(aTRB,{"TPSERVICO",    	'N',01,0}) //2-Tipo da Presta็ใo de Servi็o
aadd(aTRB,{"TPPESSOA", 		'N',01,0}) //3-Tipo de Pessoa
aadd(aTRB,{"CPFCNPJ",		'C',14,0}) //4-CPF ou CNPJ
aadd(aTRB,{"RSOCIAL",		'C',115,0}) //5-Nome ou Razใo Social
aadd(aTRB,{"INSCMUNIC",  	'C',07,0}) //6-Inscri็ใo municipal Sem dํgito. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo de ordem 2.
aadd(aTRB,{"CODPAIS", 		'C',04,0}) //7-Conforme Anexo I: Paํs. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo de ordem 2
aadd(aTRB,{"CODUF", 			'C',02,0}) //8-C๓digo da Unidade de Federa็ใo
aadd(aTRB,{"CODCID", 		'C',07,0}) //9-Cidade IBGE. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo
aadd(aTRB,{"CEP", 			'C',08,0}) //10-CEP
aadd(aTRB,{"LOGRADOURO", 	'C',125,0}) //11-Nome do Logradouro
aadd(aTRB,{"NUMERO", 		'C',10,0}) //12-N๚mero do Endere็o
aadd(aTRB,{"COMPLEM", 		'C',60,0}) //13-Complemento do Endere็o
aadd(aTRB,{"BAIRRO", 		'C',60,0}) //14-Bairro
aadd(aTRB,{"TEL", 			'C',12,0}) //15-Telefone
aadd(aTRB,{"EMAIL",  		'C',80,0}) //16-EMAIL
aadd(aTRB,{"TIPODOC", 		'N',2,0}) //17-Conforme anexo IV: Tipo de Documento Digitado
aadd(aTRB,{"NOTAFISCAL", 	'C',18,0}) //18-N๚mero da Nota Fiscal
aadd(aTRB,{"SERIE",  		'C',10,0}) //19-S้rie da Nota Fiscal
aadd(aTRB,{"EMISSAO", 		'C',10,0}) //20-Data de Emissใo
aadd(aTRB,{"SITUACAO", 	   'N',01,0}) //21-Situa็ใo da Nota Fiscal 1 - NORMAL; 2 - CANCELADA
aadd(aTRB,{"MES", 		   'C',02,0}) //22-M๊s de compet๊ncia do documento
aadd(aTRB,{"ANO",    	   'C',04,0}) //23-Ano de Compet๊ncia do Documento
aadd(aTRB,{"CNAE",   	 	'C',09,0}) //24-CNAE (C๓digo da Classifica็ใo Nacional de Atividades Econ๔micas versใo 2.1) da Atividade ou Servi็o Prestado
aadd(aTRB,{"ALIQUOTA", 		'C',03,0}) //25-Alํquota
aadd(aTRB,{"SERVICO",		'C',200,0}) //26-Descri็ใo do Servi็o Prestado
aadd(aTRB,{"CODPAISLOC",		'C',04,0}) //27-C๓digo do Paํs Onde Ocorreu a Presta็ใo do Servi็o
aadd(aTRB,{"CODUFLOC",  		'C',02,0}) //28-C๓digo da Unidade de Federa็ใo Onde Ocorreu a Presta็ใo do Servi็o
aadd(aTRB,{"CODCIDLOC", 		'C',07,0}) //29-C๓digo da Cidade Onde Ocorreu a Presta็ใo do Servi็o
aadd(aTRB,{"CODNAT", 		'N',01,0}) //30-C๓digo da Natureza da Opera็ใo
aadd(aTRB,{"CODART", 		'C',15,0}) //31-C๓digo ART Apenas para Constru็ใo Civil
aadd(aTRB,{"CODOBRA", 		'C',15,3}) //32-C๓digo da Obra Apenas para Constru็ใo Civil
aadd(aTRB,{"VALSERVICO", 	'C',19,0}) //33-Valor do Servi็o Prestado
aadd(aTRB,{"VALDEDUC", 		'C',19,0}) //34-Valor das Dedu็๕es
aadd(aTRB,{"DESCONTOIN", 	'C',19,0}) //35-Descontos Incondicionados
aadd(aTRB,{"DESCONTOCO", 	'C',19,0}) //36-Descontos Condicionados
aadd(aTRB,{"OUTRET", 		'C',19,0}) //37-Outras Reten็๕es
aadd(aTRB,{"VALIR", 			'C',19,0}) //38-Valor IR
aadd(aTRB,{"VALPIS", 		'C',19,0}) //39-Valor PIS
aadd(aTRB,{"VALCOFINS",  	'C',19,0}) //40-Valor COFINS
aadd(aTRB,{"VALCSLL", 		'C',19,0}) //41-Valor CSLL
aadd(aTRB,{"VALINSS", 		'C',19,2}) //42-Valor INSS
aadd(aTRB,{"EMPENHO", 		'C',10,0}) //43-N๚mero do Empenho
aadd(aTRB,{"ISSRETIDO", 		'N',01,0}) //44-Indicador de ISS Retido 0 - Nใo; 1  Sim
aadd(aTRB,{"TIPOTRIB", 		'N',01,0}) //45-Tipo de Tributa็ใo do Tomador
aadd(aTRB,{"INSMUNIC", 		'C',07,0}) //46-Inscri็ใo municipal Sem dํgito. Referente ao Contribuinte que estแ importando a escritura็ใo.

//CRIA TABELA TEMPORARIA E INDICE QUE SERA UTILIZADO NO REGISTRO 1
cArq := CriaTrab(aTRB,.T.)
dbUseArea(.T.,,cArq,"TRB",.T.,.F.)
IndRegua("TRB",cArq,"STR(TPSERVICO)+CPFCNPJ+NOTAFISCAL+SERIE+EMISSAO+STR(SITUACAO)+SERVICO")
dbSelectArea("TRB")
DbClearIndex()

Do While !SM0->(Eof()) .And. cEmpAnt==SM0->M0_CODIGO .And. cFilAnt == FWCodFil()

	IF SuperGetMv("MV_ESTADO",,.F.) == "CE" .And. UPPER(ALLTRIM(SM0->M0_CIDENT)) == "FORTALEZA"

		If cPaisLoc == "BRA"
			cSelect	+=	"% SFT.FT_RECISS %"
		EndIf
		If !Empty(cEspNCons)
			cWhere := "%SFT.FT_ESPECIE NOT IN("+ cEspNCons+")%"
		Else
			cWhere := "%1=1%"
		Endif

		cAliasSFT	:=	GetNextAlias()

		BeginSql Alias cAliasSFT

			COLUMN FT_EMISSAO AS DATE

						SELECT
							SFT.FT_FILIAL,
							SFT.FT_TIPOMOV,
							SFT.FT_EMISSAO,
							SFT.FT_NFISCAL,
							SFT.FT_SERIE,
							SFT.FT_ESPECIE,
							SFT.FT_DTCANC,
							SFT.FT_CLIEFOR,
							SFT.FT_LOJA,
							SFT.FT_ESTADO,
							SFT.FT_CFOP,
							SFT.FT_ITEM,
							SB1.B1_COD,
							SB1.B1_DESC,
							SB1.B1_CNAE,
							SB1.B1_MEPLES,
							SFT.FT_POSIPI,
							SFT.FT_QUANT,
							SFT.FT_DESCONT,
							SFT.FT_TOTAL,
							SFT.FT_ALIQICM,
							SFT.FT_VALICM,
							SFT.FT_ISSSUB,
							SFT.FT_VALIRR,
							SFT.FT_VRETPIS,
							SFT.FT_VRETCOF,
							SFT.FT_VRETCSL,
							SFT.FT_VALINS,
							SFT.FT_CSTISS,
							SFT.FT_VALCONT,
							SFT.FT_ISSST,
							%Exp:cSelect%
						FROM
						    %TABLE:SFT% SFT
						    INNER JOIN %TABLE:SB1% SB1 ON(SFT.FT_PRODUTO = SB1.B1_COD)
						WHERE
							SFT.FT_FILIAL=%XFILIAL:SFT%
							AND SB1.B1_FILIAL=%XFILIAL:SB1%
			       			AND SFT.%NOTDEL%
			       			AND SB1.%NOTDEL%
			       			AND SFT.FT_CODISS <> ' '
			       			AND SFT.FT_EMISSAO >= %EXP:DTOS(DDATAINI)%
			       			AND SFT.FT_EMISSAO <= %EXP:DTOS(DDATAFIN)%
			       			AND %EXP:cWhere%
					ORDER BY SFT.FT_EMISSAO
			     EndSql
				 DbSelectArea (cAliasSFT)
			     (cAliasSFT)->(DbGoTop())


			While (cAliasSFT)->(!EOF())

					RecLock("TRB",.T.)

					nISSRet := 0
					cCodUFLoc := ""

					TRB->VERSAO		:= cVersao 		//1-Indicador da Versใo do Layout
					TRB->TPSERVICO 	:= IIF(Val(Substr((cAliasSFT)->FT_CFOP,1,1)) >= 5, 1, 2)	//2-Tipo da Presta็ใo de Servi็o

					IF Val(Substr((cAliasSFT)->FT_CFOP,1,1)) >= 5
						SA1->(DbSetOrder(1))
						IF (SA1->(dbSeek(xFilial("SA1")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA)))

							nISSRet := Iif(cPaisLoc == "BRA" .And. (cAliasSFT)->FT_RECISS$"1", 0, 1)

							cTipoTrib := IIF(cPaisLoc == "BRA" .And. SA1->A1_TPJ$ "1|2", 5, IIF(cPaisLoc == "BRA" .And. SA1->A1_TPJ = "3", 6, 1))

							cDentMunic := IIF(ALLTRIM(UfCodIBGE(SA1->A1_EST)+SA1->A1_COD_MUN) == ALLTRIM(SM0->M0_CODMUN),.T., .F.)

							//3-Tipo de Pessoa
							IF SA1->A1_PESSOA == "F"
								TRB->TPPESSOA := 1
							ElseIf SA1->A1_PESSOA == "J"
								TRB->TPPESSOA := 2
							EndIf

							IF 	SA1->A1_EST = 'EX'
								TRB->TPPESSOA := 3
							EndIf

							TRB->CPFCNPJ		:=	ALLTRIM(SA1->A1_CGC)	  					//4-CPF ou CNPJ
							TRB->RSOCIAL 		:=	ALLTRIM(SA1->A1_NOME)    						//5-Nome ou Razใo Social

							IF UPPER(ALLTRIM(SA1->A1_MUN)) == "FORTALEZA"
								TRB->INSCMUNIC	:=	ALLTRIM(SA1->A1_INSCRM)  		//**6-Inscri็ใo municipal Sem dํgito.
							Else
								TRB->INSCMUNIC	:= ""
							EndIf
							If cPaisLoc == "BRA"
								TRB->CODPAIS 		:=	RIGHT(ALLTRIM(SA1->A1_CODPAIS),4)					//7-Conforme Anexo I: Paํs. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo de ordem 2
							EndIf
							TRB->CODUF 		:=	ALLTRIM(SA1->A1_EST)							//8-C๓digo da Unidade de Federa็ใo
							TRB->CODCID 		:=	ALLTRIM(UfCodIBGE(SA1->A1_EST)+SA1->A1_COD_MUN)		//9-Cidade IBGE. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo
							TRB->CEP 			:=	ALLTRIM(SA1->A1_CEP)						//10-CEP
							TRB->LOGRADOURO 	:=	ALLTRIM(FisGetEnd(SA1->A1_END)[1])			//11-Nome do Logradouro
							TRB->NUMERO 		:=	ALLTRIM(FisGetEnd(SA1->A1_END)[3])			//12-N๚mero do Endere็o
							TRB->COMPLEM 		:=	ALLTRIM(FisGetEnd(SA1->A1_END)[4])			//13-Complemento do Endere็o
							TRB->BAIRRO 		:=	ALLTRIM(SA1->A1_BAIRRO)						//14-Bairro
							TRB->TEL			:=	ALLTRIM(SA1->A1_TEL)							//15-Telefone
							TRB->EMAIL 		:=	ALLTRIM(SA1->A1_EMAIL)						//16-EMAIL

							IF lISSXMUN
								SD2->(DbSetOrder(3))
								IF SD2->(dbSeek(xFilial("SD2")+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
									 SC5->(DbSetOrder(1))
									 SC5->(dbSeek(xFilial("SC5")+SD2->D2_PEDIDO))
	 								 IF cPaisLoc $ "BRA|MEX" .And. !Empty(SC5->C5_ESTPRES) .And. !Empty(SC5->C5_MUNPRES)
		 								 cCodUFLoc := ALLTRIM(SC5->C5_ESTPRES)
		 								 cCodCidLoc := ALLTRIM(UfCodIBGE(SC5->C5_ESTPRES)+SC5->C5_MUNPRES)
		 							 EndIf
								EndIf
							EndIf

						EndIf
					Else
						SA2->(DbSetOrder(1)) //Entrada
						IF (SA2->(dbSeek(xFilial("SA2")+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA)))	//// ENTRADA COLOCO DADOS DO FORNECEDOR

							nISSRet := Iif(cPaisLoc == "BRA" .And. (cAliasSFT)->FT_RECISS$"1", 0, 1)

							cTipoTrib := IIF(cPaisLoc == "BRA" .And. SA2->A2_TPJ$"1|2", 5, IIF(cPaisLoc == "BRA" .And. SA2->A2_TPJ = "3", 6, 1))

							cDentMunic := IIF(ALLTRIM(UfCodIBGE(SA2->A2_EST)+SA2->A2_COD_MUN) == ALLTRIM(SM0->M0_CODMUN),.T., .F.)

							//3-Tipo de Pessoa
							IF SA2->A2_TIPO == "F"
								TRB->TPPESSOA := 1
							ElseIf SA2->A2_TIPO == "J"
								TRB->TPPESSOA := 2
							EndIf

							IF 	SA2->A2_EST = 'EX'
								TRB->TPPESSOA := 3
							EndIf


							TRB->CPFCNPJ		:=	ALLTRIM(SA2->A2_CGC)	  				//4-CPF ou CNPJ
							TRB->RSOCIAL 		:=	ALLTRIM(SA2->A2_NOME)    						//5-Nome ou Razใo Social


							IF UPPER(ALLTRIM(SA2->A2_MUN)) == "FORTALEZA"
								TRB->INSCMUNIC	:=	ALLTRIM(SA2->A2_INSCRM)  		//**6-Inscri็ใo municipal Sem dํgito.
							Else
								TRB->INSCMUNIC	:= ""
							EndIf
							If cPaisLoc == "BRA"
								TRB->CODPAIS 		:=	RIGHT(ALLTRIM(SA2->A2_CODPAIS),4)					//7-Conforme Anexo I: Paํs. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo de ordem 2
							EndIf
							TRB->CODUF 		:=	ALLTRIM(SA2->A2_EST)							//8-C๓digo da Unidade de Federa็ใo
							TRB->CODCID 		:=	ALLTRIM(UfCodIBGE(SA2->A2_EST)+SA2->A2_COD_MUN)		//9-Cidade IBGE. Referente ao Tomador ou Prestador, correspondente ao tipo da presta็ใo de servi็o informado no campo
							TRB->CEP 			:=	ALLTRIM(SA2->A2_CEP)						//10-CEP
							TRB->LOGRADOURO 	:=	ALLTRIM(FisGetEnd(SA2->A2_END)[1])			//11-Nome do Logradouro
							TRB->NUMERO 		:=	ALLTRIM(FisGetEnd(SA2->A2_END)[3])			//12-N๚mero do Endere็o
							TRB->COMPLEM 		:=	ALLTRIM(FisGetEnd(SA2->A2_END)[4])			//13-Complemento do Endere็o
							TRB->BAIRRO 		:=	ALLTRIM(SA2->A2_BAIRRO)						//14-Bairro
							TRB->TEL			:=	ALLTRIM(SA2->A2_TEL)							//15-Telefone
							TRB->EMAIL 		:=	ALLTRIM(SA2->A2_EMAIL)							//16-EMAIL

							If cPaisLoc == "BRA"
								IF lISSXMUN
									SF1->(DbSetOrder(1))
									IF SF1->(dbSeek(xFilial("SF1")+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
										IF !Empty(SF1->F1_ESTPRES) .And. !Empty(SF1->F1_INCISS)
											cCodUFLoc := ALLTRIM(SF1->F1_ESTPRES)
			 								cCodCidLoc := ALLTRIM(UfCodIBGE(SF1->F1_ESTPRES)+SF1->F1_INCISS)
			 							EndIf
			 						EndIf
								EndIf
							   If !lISSXMUN //For็o o seek na SF1 para pegar a data de competencia
                              SF1->(DbSetOrder(1))
                              SF1->(dbSeek(xFilial("SF1")+(cAliasSFT)->FT_NFISCAL+(cAliasSFT)->FT_SERIE+(cAliasSFT)->FT_CLIEFOR+(cAliasSFT)->FT_LOJA))
							   EndIf
							   dDtCpIss  :=  SF1->F1_DTCPISS
						    EndIf

						EndIf
					EndIf

					IF cDentMunic
						IF Val(Substr((cAliasSFT)->FT_CFOP,1,1)) < 5 .And. Alltrim((cAliasSFT)->FT_ESPECIE)$"NFSE"
							nTipoDoc	:= 12
						ElseIf Alltrim((cAliasSFT)->FT_ESPECIE)$"NFSE"
							nTipoDoc	:= 1
						ElseIf Alltrim((cAliasSFT)->FT_ESPECIE)$"NFA"
							nTipoDoc	:= 3
						ElseIf Alltrim((cAliasSFT)->FT_ESPECIE)$"RPS"
							nTipoDoc	:= 6
						Else
							nTipoDoc	:= 4
						EndIf
					Else
						If Alltrim((cAliasSFT)->FT_ESPECIE)$"NFSE"
							nTipoDoc	:= 7
						ElseIf Alltrim((cAliasSFT)->FT_ESPECIE)$"NFA"
							nTipoDoc	:= 	9
						Else
							nTipoDoc	:= 	10
						EndIf
					EndIf

					TRB->TIPODOC		:= nTipoDoc 										//17-Conforme anexo IV: Tipo de Documento Digitado
					TRB->NOTAFISCAL	:= Alltrim((cAliasSFT)->FT_NFISCAL) 				//18-N๚mero da Nota Fiscal
					TRB->SERIE			:= (cAliasSFT)->FT_SERIE 						//19-S้rie da Nota Fiscal
					TRB->EMISSAO		:= StrZero(DAY((cAliasSFT)->FT_EMISSAO),2)+"/"+StrZero(Month((cAliasSFT)->FT_EMISSAO),2)+"/"+StrZero(Year((cAliasSFT)->FT_EMISSAO),4)  					//20-Data de Emissใo
					TRB->SITUACAO		:= IIF(Empty((cAliasSFT)->FT_DTCANC), 1 , 2)	//21-Situa็ใo da Nota Fiscal 1 - NORMAL; 2 - CANCELADA
					TRB->MES 			:= Iif(!Empty(dDtCpIss),Month2Str(dDtCpIss),Month2Str((cAliasSFT)->FT_EMISSAO)) 	//22-M๊s de compet๊ncia do documento
					TRB->ANO 			:= Iif(!Empty(dDtCpIss), Year2Str(dDtCpIss), Year2Str((cAliasSFT)->FT_EMISSAO)) 	//23-Ano de Compet๊ncia do Documento
					TRB->CNAE			:= ALLTRIM((cAliasSFT)->B1_CNAE) 					//24-CNAE (C๓digo da Classifica็ใo Nacional de Atividades Econ๔micas versใo 2.1) da Atividade ou Servi็o Prestado
					TRB->ALIQUOTA		:= IIF((cAliasSFT)->FT_ALIQICM > 0, ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_ALIQICM,"@R 9.99"),".","")) , "")						//25-Alํquota
					TRB->SERVICO		:= Alltrim((cAliasSFT)->B1_DESC) 							//26-Descri็ใo do Servi็o Prestado
					TRB->CODPAISLOC	:= TRB->CODPAIS 									//27-C๓digo do Paํs Onde Ocorreu a Presta็ใo do Servi็o

					TRB->CODUFLOC		:= IIF(lISSXMUN .And. !Empty(cCodUFLoc),cCodUFLoc,IIF(TRB->CODUF <> 'EX',TRB->CODUF, ''))										//28-C๓digo da Unidade de Federa็ใo Onde Ocorreu a Presta็ใo do Servi็o
					TRB->CODCIDLOC	:= IIF(lISSXMUN .And. !Empty(cCodCidLoc),cCodCidLoc,IIF(TRB->CODUF <> 'EX',TRB->CODCID, ''))								//29-C๓digo da Cidade Onde Ocorreu a Presta็ใo do Servi็o

					//30-C๓digo da Natureza da Opera็ใo
					IF (cAliasSFT)->FT_ISSST$"1|2|3|4|5|6"
						TRB->CODNAT	:= 	Val((cAliasSFT)->FT_ISSST)
					Else
						TRB->CODNAT	:= 7
					EndIf


					TRB->CODART		:= "" 												//31-C๓digo ART Apenas para Constru็ใo Civil
					TRB->CODOBRA 		:= "" 												//32-C๓digo da Obra Apenas para Constru็ใo Civil
					TRB->VALSERVICO	:= IIF((cAliasSFT)->FT_VALCONT>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VALCONT,"@R 9999999999999999.99"),".","")),"")  						//33-Valor do Servi็o Prestado
					TRB->VALDEDUC		:= IIF((cAliasSFT)->FT_ISSSUB>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_ISSSUB,"@R 99999999999999.99"),".","")),"")					//34-Valor das Dedu็๕es
					TRB->DESCONTOIN	:= "" 												//35-Descontos Incondicionados
					TRB->DESCONTOCO	:= IIF((cAliasSFT)->FT_DESCONT>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_DESCONT,"@R 99999999999999.99"),".","")),"") 						//36-Descontos Condicionados
					TRB->OUTRET		:= "" 												//37-Outras Reten็๕es
					TRB->VALIR			:= IIF((cAliasSFT)->FT_VALIRR>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VALIRR,"@R 99999999999999.99"),".","")),"")						//38-Valor IR
					TRB->VALPIS		:= IIF((cAliasSFT)->FT_VRETPIS>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VRETPIS,"@R 99999999999999.99"),".","")),"") 						//39-Valor PIS
					TRB->VALCOFINS	:= IIF((cAliasSFT)->FT_VRETCOF>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VRETCOF,"@R 99999999999999.99"),".","")), "")						//40-Valor COFINS
					TRB->VALCSLL		:= IIF((cAliasSFT)->FT_VRETCSL>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VRETCSL,"@R 99999999999999.99"),".","")), "")						//41-Valor CSLL
					TRB->VALINSS		:= IIF((cAliasSFT)->FT_VALINS>0,ALLTRIM(STRTRAN(TRANSFORM((cAliasSFT)->FT_VALINS,"@R 99999999999999.99"),".","")), "") 						//42-Valor INSS
					TRB->EMPENHO		:= "" 												//43-N๚mero do Empenho
					TRB->ISSRETIDO	:= nISSRet 										//44-Indicador de ISS Retido 0 - Nใo; 1  Sim
					TRB->TIPOTRIB		:= cTipoTrib										//45-Tipo de Tributa็ใo do Tomador
					TRB->INSMUNIC		:= ALLTRIM(SM0->M0_INSCM)					   //46-Inscri็ใo municipal Sem dํgito. Referente ao Contribuinte que estแ importando a escritura็ใo.
					TRB->(MSunlock())
			   (cAliasSFT)->(dbSkip())
			EndDo

			(cAliasSFT)->(DbCloseArea())
			TRB->(DbGoTop())
	EndIf
	SM0->(DbSkip ())
EndDo
RestArea(aArea)
Return


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณIssItap  บAutor  ณJorge Souza          บ Data ณ  09/03/2015 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณInstru็ใo Normativas						    				    บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ IssItap.INI                                                บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function IssItap(dDataIni,dDataFin)
Local aArea		:=  GetArea()
Local aTRB 		:= {}
Local aTRBIT		:= {}
Local cArq			:= ""
Local cSelect := ""

Local cAlias	:= ""
Local nCont		:= 0
Local nValServ	:= 0
Local nValImp 	:= 0
Local nValTot		:= 0
Local nValCof		:= 0
Local nValPis		:= 0
Local nValIr		:= 0
Local nValInss	:= 0
Local nValCsll	:= 0
Local nAliqIss	:= 0

DbSelectArea("SM0")
SM0->(DbGoTop ())
SM0->(MsSeek(cEmpAnt + cFilAnt))

////////////////////////
////// NOTA FISCAL 1////
////////////////////////
aadd(aTRB,{"TIPOREG",   	 	'C',01,0}) //1- (1) Registro Detalhe
aadd(aTRB,{"SEQUENCIA",    	'C',08,0}) //2-Seq. de registros de Nf comentando com 1 p/ cada arq.
aadd(aTRB,{"NF",     		'C',08,0}) //3-(0)Preencher obrigatoriamente com zeros
aadd(aTRB,{"SITUACNF",		'C',01,0}) //4-(1) Situra็ใo normal (2)Situa็ใo Cancelada
aadd(aTRB,{"DTEMISSAO",		'C',08,0}) //5-Data de Emissใo da Nota
aadd(aTRB,{"CODATIV",      	'C',06,0}) //6-C๓digo de Atividade
aadd(aTRB,{"CFPS",    		'C',03,0}) //7-C๓d Fiscal de Presta็ใo de Servi็o(verificar tabela)
aadd(aTRB,{"SERIE", 			'C',02,0}) //8-S้rio da Nota Fiscal ( Valor "17" fixo)
aadd(aTRB,{"CPFCNPJ", 		'C',14,0}) //9-Indentifica็ใo da Empresa Tomadora
aadd(aTRB,{"RSOCIAL",		'C',100,0})//10-Nome
aadd(aTRB,{"CEP", 			'C',08,0}) //11-CEP
aadd(aTRB,{"ENDERECO",    	'C',100,0}) //12-Nome do endere็o
aadd(aTRB,{"BAIRRO", 		'C',50,0}) //13-Bairro
aadd(aTRB,{"CIDADE", 		'C',60,0}) //14-Cidade
aadd(aTRB,{"CODUF", 	    	'C',02,0}) //15-Estado
aadd(aTRB,{"ENDCOBRAN",   	'C',100,0})//16-End. Cobran็a
aadd(aTRB,{"EMAIL", 	    	'C',80,0}) //17-Emial
aadd(aTRB,{"ENVEMAIL", 		'C',01,0}) //18-Enviar por Email S-SIM ou NรO
aadd(aTRB,{"ISSRETIDO", 		'C',01,0}) //19-Indicador de ISS Retido S - SIM; N  NรO
aadd(aTRB,{"VALSERVICO", 	'N',14,2}) //20-Valor do Servi็o Prestado
aadd(aTRB,{"VALDEDUC", 		'N',14,2}) //21-Valor das Dedu็๕es
aadd(aTRB,{"VALIMPOST", 		'N',14,2}) //22-Valor de Imposto
aadd(aTRB,{"ALIQUOTA", 		'N',04,2}) //23-Alํquota
aadd(aTRB,{"VALTOTNF", 		'N',14,2}) //24-Valor total da nota
aadd(aTRB,{"VALCOF",        'N',14,2}) //25-Valor COFINS
aadd(aTRB,{"VALPIS", 		'N',14,2}) //26-Valor PIS
aadd(aTRB,{"VALIR", 			'N',14,2}) //27-Valor IR
aadd(aTRB,{"VALINSS", 		'N',14,2}) //28-Valor INSS
aadd(aTRB,{"VALCSLL", 		'N',14,2}) //29-Valor CSLL
aadd(aTRB,{"RPS", 			'C',08,0}) //30-Numero do Rec. Prov. de Servi็o
aadd(aTRB,{"MODELO",			'C',01,0}) //31-(F) FATURA OU (S) SIMPLES - Modelo de NF
aadd(aTRB,{"OBSERV",			'C',255,0})//32- Observa็ใo
aadd(aTRB,{"DTEMISRPS",		'C',08,0}) //33-Data de Emissใo do Recibo Provis๓rio de Servi็o
aadd(aTRB,{"TIPOTOMAD",		'C',01,0}) //34-(J) Pessoa Jurํdica, (F)PEssoa Fํsica ou (O) Outro
aadd(aTRB,{"RGINSEST",		'C',20,0}) //35-Numero do RG ou Ins. Estadual da Empresa
aadd(aTRB,{"TRANSPNOME",		'C',150,0})//36-Nome da Transportadora
aadd(aTRB,{"TRANSCNPJ",		'C',20,0}) //37-CNPJ da Transportadora
aadd(aTRB,{"TRANSEND",		'C',250,0})//38-End. da Transportadora
aadd(aTRB,{"TRANSFRE",		'C',100,0})//39-Tipo de Frete. da Transportadora
aadd(aTRB,{"TRANSPQTD",		'N',14,2}) //40-Qtnd do produto Transportado
aadd(aTRB,{"TRANESPE",		'C',50,0}) //41-Especie do produto Transportado
aadd(aTRB,{"TRANPLIQ",		'N',14,2}) //42-Qtnd Liquido Transportado
aadd(aTRB,{"TRANPBRUT",		'N',14,2}) //43-Peso bruto do produto Transportado
aadd(aTRB,{"CSDECUNI",		'N',01,0}) //44-Qntd de casas decimais para o valor unitแrio
aadd(aTRB,{"CSDECTOT",		'N',01,0}) //45-Qntd de casas decimais para o valor total
aadd(aTRB,{"OUTROSDESC",		'N',14,2}) //46-Outros tipos de reten็๕es**
aadd(aTRB,{"CCMTOMADOR",		'N',14,0}) //47-CCM do tomador
aadd(aTRB,{"SERVCIDADE",		'C',100,0})//48-Cidade onde o servi็o foi prestado
aadd(aTRB,{"SERVESTADO",		'C',02,0}) //49-Estado onde o servi็o foi prestado
aadd(aTRB,{"VALAPRXIMP",		'N',14,2}) //50-Valor Aprox. do Imp. da Nota
aadd(aTRB,{"ALIQIMPPX",		'N',05,2}) //51-Valor da Aliq. Aprox. do Imp.
aadd(aTRB,{"FONTEIMPPX",		'C',11,0}) //52-Fonte do Imp. Aprox.
aadd(aTRB,{"CLIENTE",		'C',TamSX3("A1_COD")[1],0}) //52-Cliente

//CRIA TABELA TEMPORARIA E INDICE QUE SERA UTILIZADO NO REGISTRO 1
cArq := CriaTrab(aTRB,.T.)
dbUseArea(.T.,,cArq,"TRB",.T.,.F.)


///////////////////////////
////// DETALHE DO ITEM 2///
///////////////////////////
aadd(aTRBIT,{"TIPOREG",   	 	'C',01,0}) //1- (1) Registro Detalhe
aadd(aTRBIT,{"SEQUENCIA",    	'C',08,0}) //2-Seq. de registros de Nf comentando com 1 p/ cada arq.
aadd(aTRBIT,{"ITEM",				'C',08,0}) //3-Item
aadd(aTRBIT,{"QNTDITEM",			'N',14,4}) //4-qntd Item
aadd(aTRBIT,{"UN",				'C',02,0}) //5-Unidade do item
aadd(aTRBIT,{"VLRUNIT",			'N',19,9}) //6-Vlr Unitario
aadd(aTRBIT,{"VLRTOTITEM",		'N',19,9}) //7-Vlr Total do Item
aadd(aTRBIT,{"DESCR",			'C',911,0}) //8-Descri็ใo

//CRIA TABELA TEMPORARIA E INDICE QUE SERA UTILIZADO NO REGISTRO 2
cArq := CriaTrab(aTRBIT,.T.)
dbUseArea(.T.,,cArq,"TRI",.T.,.F.)

Do While !SM0->(Eof()) .And. cEmpAnt==SM0->M0_CODIGO .And. 	cFilAnt == FWCodFil()


	If SuperGetMv("MV_ESTADO",,.F.) == "SP"

		cAlias	:=	GetNextAlias()

		If SerieNfId("SFT",3,"FT_SERIE")<>"FT_SERIE"
			cSelect := "% ,SFT.FT_SDOC %"
		Else
			cSelect := "%%"
		EndIf

		BeginSql Alias cAlias

			COLUMN FT_EMISSAO AS DATE
			COLUMN FT_DTCANC AS DATE

			SELECT	SFT.FT_DTCANC,
					SFT.FT_EMISSAO,
					SFT.FT_ITEM,
					SFT.FT_NFISCAL,
					SFT.FT_SERIE,
					SFT.FT_ESPECIE,
					SFT.FT_CLIEFOR,
					SFT.FT_CFOP,
					SFT.FT_CODISS,
					SFT.FT_CFPS,
					SFT.FT_QUANT,
					SFT.FT_TOTAL,
					SFT.FT_PRCUNIT,
					SFT.FT_VALCONT,
					SFT.FT_VALCOF,
					SFT.FT_VALPIS,
					SFT.FT_VALINS,
					SFT.FT_VALCSL,
					SFT.FT_VALIRR,
					SB1.B1_COD,
					SB1.B1_DESC,
					SB1.B1_CNAE,
					SD2.D2_DOC,
					SD2.D2_UM,
					SD2.D2_QUANT,
					SD2.D2_VALISS,
					SD2.D2_ALIQISS,
					SD2.D2_VALCOF,
					SD2.D2_VALPIS,
					SD2.D2_VALIRRF,
					SD2.D2_VALINS,
					SD2.D2_VALCSL,
					SD2.D2_TOTAL,
					SA1.A1_COD,
					SA1.A1_LOJA,
					SA1.A1_CGC,
					SA1.A1_NOME,
					SA1.A1_CEP,
					SA1.A1_END,
					SA1.A1_BAIRRO,
					SA1.A1_MUN,
					SA1.A1_EST,
					SA1.A1_EMAIL,
					SA1.A1_RECISS,
					SA1.A1_PESSOA
					%EXP:cSelect%
				FROM
				    %TABLE:SFT% SFT
				    INNER JOIN %TABLE:SB1% SB1
				    ON(SB1.B1_FILIAL=%XFILIAL:SB1%
						AND SFT.FT_PRODUTO = SB1.B1_COD
						AND SB1.%NOTDEL%)
				    INNER JOIN %TABLE:SD2% SD2
				    ON(SD2.D2_FILIAL=%XFILIAL:SD2%
                   	AND SFT.FT_NFISCAL = SD2.D2_DOC
                   	AND SFT.FT_SERIE = SD2.D2_SERIE
                  	AND SFT.FT_CLIEFOR = SD2.D2_CLIENTE
                   	AND SFT.FT_LOJA = SD2.D2_LOJA
						AND SFT.FT_ITEM = SD2.D2_ITEM)
				 	INNER JOIN %TABLE:SA1% SA1
				    ON(SA1.A1_FILIAL=%XFILIAL:SA1%
				     	AND SA1.A1_COD = SFT.FT_CLIEFOR
				     	AND SA1.A1_LOJA = SFT.FT_LOJA
				     	AND SA1.%NOTDEL%)
				WHERE
					SFT.FT_FILIAL=%XFILIAL:SFT%
	      			AND SFT.FT_EMISSAO >= %EXP:DTOS(DDATAINI)%
	      			AND SFT.FT_EMISSAO <= %EXP:DTOS(DDATAFIN)%
	      			AND SFT.FT_CODISS <> ' '
	      			AND SFT.%NOTDEL%
	      			ORDER BY SFT.FT_EMISSAO, SFT.FT_NFISCAL
			    EndSql
				 DbSelectArea (cAlias)
			    (cAlias)->(DbGoTop())


			While (cAlias)->(!EOF())

				//NOTA FISCAL
				nCont++
				RecLock("TRB",.T.)
				TRB->TIPOREG 		:= "1"														//1- (1) Registro Detalhe
				TRB->SEQUENCIA	:=	StrZero(nCont,8)							   			//2-Seq. de registros de Nf comentando com 1 p/ cada arq.
				TRB->NF			:=	"00000000"												//3-(0)Preencher obrigatoriamente com zeros
				TRB->SITUACNF 	:=	Iif(Empty((cAlias)->FT_DTCANC),"1","2")			//4-(1) Situra็ใo normal (2)Situa็ใo Cancelada
				TRB->DTEMISSAO 	:=  StrTran(Dtoc((cAlias)->FT_EMISSAO),"/","")		//5-Data de Emissใo da Nota
				TRB->CODATIV		:= 	Alltrim((cAlias)->B1_CNAE)							//6-C๓digo de Atividade
				TRB->CFPS			:=	(cAlias)->FT_CFPS										//7-C๓d Fiscal de Presta็ใo de Servi็o(verificar tabela)
				TRB->SERIE			:=	SerieNfId( cAlias ,2,"FT_SERIE") 			//8-S้rio da Nota Fiscal ( Valor "17" fixo)
				TRB->CPFCNPJ		:=	(cAlias)->A1_CGC 				  				//9-CPF ou CNPJ
				TRB->RSOCIAL 		:=	(cAlias)->A1_NOME    						//10-Nome ou Razใo Social
				TRB->CEP 			:=	(cAlias)->A1_CEP								//11-CEP
				TRB->ENDERECO		:=	StrTran((cAlias)->A1_END,",","")	 		//12-Endereco
				TRB->BAIRRO 		:=	(cAlias)->A1_BAIRRO							//13-Bairro
				TRB->CIDADE 		:=	(cAlias)->A1_MUN								//14-Cidade
				TRB->CODUF 		:=	(cAlias)->A1_EST								//15-C๓digo da Unidade de Federa็ใo
				TRB->EMAIL 		:=	(cAlias)->A1_EMAIL							//16-EMAIL
				TRB->ISSRETIDO 	:= Iif((cAlias)->A1_RECISS$"1", "S", "N") 	//19-Indicador de ISS Retido S - SIM; N  NรO
				//Tipo de Pessoa
				TRB->TIPOTOMAD := (cAlias)->A1_PESSOA								//34-(J) Pessoa Jurํdica, (F)PEssoa Fํsica ou (O) Outro
				IF 	(cAlias)->A1_EST = 'EX'
					TRB->TIPOTOMAD := "O"											//34-(J) Pessoa Jurํdica, (F)PEssoa Fํsica ou (O) Outro
				EndIf
				TRB->RPS			:=	Right((cAlias)->FT_NFISCAL,8)								//30-Numero do Rec. Prov. de Servi็o
				TRB->MODELO		:=	Iif((cAlias)->FT_ESPECIE=="RPS","F","S")		//31-(F) FATURA OU (S) SIMPLES - Modelo de NF
				TRB->DTEMISRPS	:=	StrTran(Dtoc((cAlias)->FT_EMISSAO),"/","")	//33-Data de Emissใo do Recibo Provis๓rio de Servi็o
				TRB->CSDECUNI 	:= TamSX3("FT_PRCUNIT")[2]							//44-Qntd de casas decimais para o valor unitแrio
				TRB->CSDECTOT 	:= TamSX3("FT_VALCONT")[2] 							//45-Qntd de casas decimais para o valor total

				TRB->(MSunlock())

				cChave 	:= (cAlias)->(DTOS(FT_EMISSAO) + FT_NFISCAL)
				nValServ	:= 0
				nValImp 	:= 0
				nValTot	:= 0
				nValCof	:= 0
				nValPis	:= 0
				nValIr		:= 0
				nValInss	:= 0
				nValCsll	:= 0
				While (cAlias)->(!EOF()) .and. cChave ==  (cAlias)->(DTOS(FT_EMISSAO) + FT_NFISCAL)
					//DETALHE DO ITEM
					RecLock("TRI",.T.)
					TRI->TIPOREG 		:= "2"								//1- (2) Registro Detalhe
					TRI->SEQUENCIA 	:=	StrZero(nCont,8)				//2-Seq. de registros de Nf comentando com 1 p/ cada arq.
					TRI->ITEM			:= StrZero(Val((cAlias)->FT_ITEM),8)   //3-Item
					TRI->QNTDITEM		:= (cAlias)->D2_QUANT			//4-qntd Item
					TRI->UN			:= (cAlias)->D2_UM				//5-Unidade do item
					TRI->VLRUNIT		:= (cAlias)->FT_PRCUNIT			//6-Vlr Unitario
					TRI->VLRTOTITEM	:= (cAlias)->FT_TOTAL			//7-Vlr Total do Item
					TRI->DESCR			:= (cAlias)->B1_DESC				//8-Descr. do Item
					TRI->(MSunlock())

					nValServ	+=		(cAlias)->FT_VALCONT		//20-Valor do Servi็o Prestado
					nValImp 	+=		(cAlias)->D2_VALISS 		//22-Valor de Imposto
					nValTot	+=		(cAlias)->D2_TOTAL
					nAliqIss	:=		(cAlias)->D2_ALIQISS
					nValCof	+=		(cAlias)->FT_VALCOF		//25-Valor COFINS
					nValPis	+=		(cAlias)->FT_VALPIS 		//26-Valor PIS
					nValIr		+=		(cAlias)->FT_VALIRR		//27-Valor IR
					nValInss	+=		(cAlias)->FT_VALINS		//28-Valor CSLL
					nValCsll	+=		(cAlias)->FT_VALCSL		//29-Valor CSLL

			   		(cAlias)->(dbSkip())
			   	enddo

				RecLock("TRB",.F.)
				TRB->VALSERVICO 	:=	nValServ					//20-Valor do Servi็o Prestado
				TRB->VALIMPOST 	:=	nValImp					//22-Valor de Imposto
				TRB->ALIQUOTA		:=	nAliqIss					//23-Alํquota
				TRB->VALTOTNF		:=	nValTot					//24-Valor total da nota
				TRB->VALCOF		:=	nValCof					//25-Valor COFINS
				TRB->VALPIS		:=	nValPis					//26-Valor PIS
				TRB->VALIR			:=	nValIr						//27-Valor IR
				TRB->VALINSS		:=	nValInss					//28-Valor CSLL
				TRB->VALCSLL		:=	nValCsll					//29-Valor CSLL
				TRB->(MSunlock())

			EndDo
			(cAlias)->(DbCloseArea())
	EndIf
	SM0->(DbSkip ())
EndDo
RestArea(aArea)
TRB->(DbGoTop())
TRI->(DbGoTop())

Return
//-------------------------------------------------------------------
/*/{Protheus.doc} SelNFSer

Seleciona as Notas Fiscais de Servi็o pela Data de Emissใo (F3_EMISSAO) ou
pela Data da Baixa do Tํtulo (E5_DATA)

@param		dDtIni		Data Incํo perํodo
			dDtFim		Data Final perํodo
			cSel		Seleciona: E - Emissใo ou B - Baixa
			cTipo		T-Servi็o Tomado ou P-Prestado
			lFinanc	Indica que deve fazer ou nao o join com o financeiro quando a sele็ใo for E
			cCpoRefSel	Nome do campo indicando a data de sele็ใo das informa็๕es quando for sele็ใo E (Ex. SE2.E2_VENCTO, SF3.F3_EMISSAO)

@return	Return .T.

@author	Mauro A. Gon็alves
@since		08/05/2015

/*/
//-------------------------------------------------------------------
Function SelNFSer(dDtIni,dDtFim,cSel,cTipo,lFinanc,cCpoRefSel,cCpoSel)
Local cAlsQry	:= "SF3"
Local cSelect	:= "% SF3.*, SE5.E5_DATA, SE2.E2_VENCTO "
Local cFrom	:= "%"
Local cWhere	:= "%"
Local cPrefixo := SuperGetMv("MV_2DUPREF",,.F.)

Default lFinanc		:= .F.
Default cCpoRefSel	:= "SF3.F3_EMISSAO"
Default cCpoSel		:= ""

#IFDEF TOP
	If (TcSrvType()<>"AS/400")

		If Left(cSel,1)=="B"
			cFrom	+= RetSqlName("SE5")+" SE5 "
			cFrom	+=	"JOIN "+RetSqlName("SE2")+" SE2 ON (SE2.E2_FILIAL='"+xFilial("SE2")+"' AND SE5.E5_PREFIXO=SE2.E2_PREFIXO AND SE5.E5_NUMERO=SE2.E2_NUM AND SE5.E5_PARCELA=SE2.E2_PARCELA AND SE5.E5_TIPO=SE2.E2_TIPO AND SE5.E5_CLIFOR=SE2.E2_FORNECE AND SE2.E2_LOJA=SE5.E5_LOJA AND SE2.D_E_L_E_T_=' ') "
			cFrom	+=	"JOIN "+RetSqlName("SF3")+" SF3 ON (SF3.F3_FILIAL='"+xFilial("SF3")+"' AND SE2.E2_FORNECE=SF3.F3_CLIEFOR and SE2.E2_LOJA=SF3.F3_LOJA and SE2.E2_PREFIXO='"+&(cPrefixo)+"' AND SE2.E2_NUM=SF3.F3_NFISCAL AND SUBSTRING(SF3.F3_CFO,1,1)<='3' AND SF3.F3_TIPO='S' AND SF3.D_E_L_E_T_=' ') "
			cWhere	+=	"SE5.E5_FILIAL='"+xFilial("SE5") + "' AND "
			cWhere	+=	"SE5.E5_DATA>='"+DToS(dDtIni)+"' AND SE5.E5_DATA<='"+DToS(dDtFim) + "' AND "
			cWhere	+=	"SE5.E5_TIPO='NF' AND SE5.E5_PARCELA IN (' ','1','A') AND "
			cWhere	+=	"SE5.E5_SITUACA<>'C' AND SE5.E5_TIPODOC<>'ES' AND SE5.D_E_L_E_T_=' ' AND "
			cWhere	+=	"(SELECT COUNT(*) FROM "+RetSqlName("SE5")+" WHERE E5_FILIAL=SE5.E5_FILIAL AND E5_PREFIXO=SE5.E5_PREFIXO AND E5_NUMERO=SE5.E5_NUMERO AND E5_PARCELA=SE5.E5_PARCELA AND E5_TIPO=SE5.E5_TIPO AND E5_CLIFOR=SE5.E5_CLIFOR AND E5_LOJA=SE5.E5_LOJA AND E5_SEQ='01' AND E5_TIPODOC='ES' AND E5_DATA >= SE5.E5_DATA AND D_E_L_E_T_<>'*')=0"
		Else
			cFrom  += RetSqlName("SF3")+" SF3 "
			If lFinanc
				cFrom		+=	"JOIN "+RetSqlName("SE2")+" SE2 ON (SE2.E2_FILIAL='"+xFilial("SE2")+"' AND SE2.E2_PREFIXO='"+&(cPrefixo)+"' AND SE2.E2_NUM=SF3.F3_NFISCAL AND SE2.E2_EMISSAO=SF3.F3_EMISSAO AND SE2.E2_FORNECE=SF3.F3_CLIEFOR AND SE2.E2_LOJA=SF3.F3_LOJA AND SE2.E2_PARCELA IN (' ','1','A') AND SE2.D_E_L_E_T_=' ') "
				cFrom		+=	"Left JOIN "+RetSqlName("SE5")+" SE5 ON (SE5.E5_FILIAL='"+xFilial("SE5")+"' AND SE5.E5_TIPO=SE2.E2_TIPO AND SE5.E5_PREFIXO=SE2.E2_PREFIXO AND SE5.E5_NUMERO=SE2.E2_NUM AND SE5.E5_PARCELA=SE2.E2_PARCELA AND SE5.E5_CLIFOR=SE2.E2_FORNECE AND SE5.E5_LOJA=SE2.E2_LOJA AND SE5.D_E_L_E_T_=' ') "
			Else
				If !Empty(cCpoSel)
					cSelect	:= "% " + cCpoSel
				Else
					cSelect	:= "% SF3.* "
				EndIf
			Endif
			cWhere	+=	"SF3.F3_FILIAL='"+xFilial("SF3") + "' AND "
			cWhere	+=	cCpoRefSel+">='"+DToS(dDtIni)+"' AND "+cCpoRefSel+"<='"+DToS(dDtFim) + "' AND "
			If cTipo == "T"
				cWhere	+=	"SUBSTRING(SF3.F3_CFO,1,1)<='3' AND "
			ElseIf cTipo == "P"
				cWhere	+=	"SUBSTRING(SF3.F3_CFO,1,1)>='5' AND "
			EndIf
			cWhere	+=	"SF3.F3_TIPO='S' AND SF3.D_E_L_E_T_=' ' "
		Endif
		cSelect	+=	"%"
		cFrom	+=	"%"
		cWhere	+=	"%"

		SF3->(DbCloseArea())

		BeginSql Alias cAlsQry

			COLUMN E2_VENCTO AS DATE
			COLUMN E5_DATA AS DATE
			COLUMN F3_ENTRADA AS DATE
			COLUMN F3_EMISSAO AS DATE
			COLUMN F3_DTCANC AS DATE

			SELECT %Exp:cSelect%
			FROM   %Exp:cFrom%
			WHERE  %Exp:cWhere%
			ORDER BY SF3.F3_FILIAL,SF3.F3_ENTRADA,SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_CFO,SF3.F3_ALIQICM

		EndSql
	Endif
#ENDIF

Return .T.

//-------------------------------------------------------------------
/*/{Protheus.doc} DAPIMGDedTrans

Gera os registros de Dedu็ใo da DAPI-MG referentes เ Compensa็ใo de
Saldo entre Estabelecimentos. (Transfer๊ncia entre filiais)
REGISTRO TIPO 24 Campo 98

@param		dDTIni		Data Inicial
			dDTFim	  	Data Final

@return	Return .T.

@author	Mauro A. Gon็alves
@since		18/06/2015

/*/
//-------------------------------------------------------------------
Function DAPIMGDedTrans(dDTIni,dDTFim)
Local aArea		:= GetArea()
Local cAlias	:= GetNextAlias()
Local nTotReg24	:= 0

#IFDEF TOP
If (TcSrvType()<>"AS/400")
	BeginSql Alias cAlias
		COLUMN D1_DTDIGIT AS DATE
		COLUMN D1_EMISSAO AS DATE

		SELECT SD1.D1_DOC,SD1.D1_SERIE,SD1.D1_EMISSAO,D1_TES,SD1.D1_TOTAL,SA2.A2_INSCR
		FROM %table:SD1% SD1
		JOIN %TABLE:SA2% SA2 ON(SA2.A2_FILIAL=%XFILIAL:SA2% AND SA2.A2_COD=SD1.D1_FORNECE AND SA2.A2_LOJA=SD1.D1_LOJA AND SA2.%NOTDEL%)
		JOIN %TABLE:SF4% SF4 ON(SF4.F4_FILIAL=%XFILIAL:SF4% AND SF4.F4_CODIGO=SD1.D1_TES AND SF4.F4_TRFICM='1' AND SF4.%NOTDEL%)
		WHERE
		SD1.%NotDel% AND
		SD1.D1_FILIAL=%xFilial:SD1% AND
		SD1.D1_DTDIGIT>=%Exp:DTOS(dDtIni)% AND
		SD1.D1_DTDIGIT<=%Exp:DTOS(dDtFim)% AND
		SD1.D1_CF='1602' AND
		(SD1.D1_CODISS IS NULL OR (SD1.D1_CODISS=' ' AND SD1.D1_TIPO<>'S'))
		ORDER BY 1,2,3
	EndSql
Endif
#ENDIF
//REGISTRO TIPO 24
While !(cAlias)->(Eof())
	R24->(dbSetOrder(1))
	If R24->(MsSeek((cAlias)->A2_INSCR+(cAlias)->(D1_DOC+D1_SERIE)))
		R24->(RecLock("R24", .F.))
		R24->VALOR	+= (cAlias)->D1_TOTAL
		R24->(MsUnLock())
	Else
		RecLock("R24",.T.)
		R24->INSC 		:= (cAlias)->A2_INSCR
		R24->NF			:= (cAlias)->D1_DOC
		R24->SERIE		:= (cAlias)->D1_SERIE
		R24->SDOC		:= SerieNfId(cAlias,2,"D1_SERIE")
		R24->DTNF		:= (cAlias)->D1_EMISSAO
		R24->DTVISTO	:= (cAlias)->D1_EMISSAO
		R24->VALOR		:= (cAlias)->D1_TOTAL
		R24->(MsUnLock())
	Endif
	nTotReg24 += (cAlias)->D1_TOTAL
	(cAlias)->(DbSkip())
Enddo
(cAlias)->(DbCloseArea())
//REGISTRO TIPO 23 - Detalhamento 04 (Detalhamento de Dedu็๕es  Campo 98 da DAPI 01)
If nTotReg24 > 0
	R23->(RecLock("R23", .T.))
	R23->COMCREEMPP	:= nTotReg24
	R23->TOTDEDPER	:= nTotReg24
	R23->(MsUnLock())
Endif
RestArea(aArea)
Return .T.

//-------------------------------------------------------------------
/*/{Protheus.doc} IssJoinvPai

Posiciona o Registro do SE1 no Titulo pai para a funcao SumAbatRec
para que seja gerados corretamente os impostos de IRRF, CSLL, PIS,
COFINS, INSS, utilizado na instrucao normativa do issjoinv.

@return	Return  .T.

@author	Rene Julian
@since	30/07/2015

/*/
//-------------------------------------------------------------------
Function IssJoinvPai()
Local lRet := .F.
Local cChave := xFilial("SF3")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL

SE1->(dbSetOrder(2))
//posiciona no registro do SE1.
SE1->(dbSeek(xFilial("SE1")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL))
While !EOF() .AND. cChave == xFilial("SE1")+SE1->E1_CLIENTE+SE1->E1_LOJA+SE1->E1_PREFIXO+SE1->E1_NUM
	If Empty(SE1->E1_TITPAI)
 		lRet := .T.
 		Exit
 	EndIf
 	SE1->(DbSkip())
End
Return(lRet)



//-------------------------------------------------------------------
/*/{Protheus.doc} DAPIMGDedTrans
Para municipio Recife
Monta um arquivo de trabalhao com as notas de servi็o
Se nใo houve a reten็ใo de ISS, a pesquisa na base ้ pela data de digita็ใo
Se houve a reten็ใo a pesquisa na base ้ pela data do pagamento

@param		dDTIni		Data Inicial
			dDTFim	  	Data Final

@return	Return NULO

@author	Henrique F. P. Pereira
@since		15/07/2015

/*/
//-------------------------------------------------------------------

Function ISSRECIFE(dIni, Dfim, lfecha, lAuto)

	Local aCampos  as array
	Local cQuery   as character
	Local cAlsSF3  as character
	Local cAlsSE5  as character
	Local cTRB     as character
	Local nTamIss  as numeric
	Local nTamSe2  as numeric
	Local nTamDtc  as numeric
	Local nTamFK7  as numeric
	Local oPrepare as object
	Local l12_1_2610 := GetRpoRelease() >= "12.1.2610"

	Default lfecha := .F.
	Default dIni   := Ctod("//")
	Default Dfim   := Ctod("//")
	Default lAuto  := .F.

	aCampos := {}
	cQuery  := ""
	cAlsSF3 := ""
	cAlsSE5 := ""
	cTRB    := ""
	nTamIss := GetSX3Cache("F3_CODISS", "X3_TAMANHO")
	nTamSe2 := GetSX3Cache("E2_BAIXA", "X3_TAMANHO") //F3_CODISS F3_DTCANC
	nTamDtc := GetSX3Cache("F3_DTCANC", "X3_TAMANHO")
	nTamFK7 := GetSX3Cache("FK7_IDPAI", "X3_TAMANHO")

	If !lfecha

		AADD(aCampos,{"NFISCAL"	,"C",GetSX3Cache("F3_NFISCAL", "X3_TAMANHO"),0})
		AADD(aCampos,{"SERIE"	,"C",GetSX3Cache("F3_SERIE", "X3_TAMANHO"),0})
		AADD(aCampos,{"CLIEFOR"	,"C",GetSX3Cache("F3_CLIEFOR", "X3_TAMANHO"),0})
		AADD(aCampos,{"LOJA"	,"C",GetSX3Cache("F3_LOJA", "X3_TAMANHO"),0})

		cTRB	:=	CriaTrab(aCampos)
		dbUseArea(.T.,__LocalDriver,cTRB,"T40",.T.,.F.)
		IndRegua("T40",cTRB,"NFISCAL+SERIE+CLIEFOR+LOJA")
		DbSelectArea("T40")
		DbClearIndex()
		DbSetIndex(cTRB+OrdBagExt())

		//Pesquisa por F3_ENTRADA, data quandoa NF foi digitada no sistema

		cQuery := " SELECT F3_NFISCAL, F3_SERIE, F3_CLIEFOR, F3_LOJA "
		cQuery += " FROM " + RetSqlName("SF3")+" SF3 "
		cQuery += " WHERE F3_FILIAL = ? "
		cQuery += " AND F3_ENTRADA BETWEEN ? AND ? "
		cQuery += " AND SUBSTRING(F3_CFO,1,1) < ? AND F3_CODISS <> ? AND F3_RECISS = ? "
		cQuery += " AND F3_DTCANC = ? "
		cQuery += " AND SF3.D_E_L_E_T_ = ? "
		cQuery += " ORDER BY SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_CLIEFOR,SF3.F3_LOJA "

		cQuery := ChangeQuery(cQuery)

		oPrepare := FwExecStatement():New(cQuery)

		oPrepare:setString(1, xFilial("SF3"))
		oPrepare:setDate(2, dIni)
		oPrepare:setDate(3, dFim)
		oPrepare:setString(4, '5' )
		oPrepare:setString(5, space(nTamIss) )
		oPrepare:setString(6, '1' )
		oPrepare:setString(7, space(nTamDtc) )
		oPrepare:setString(8, ' ' )

		cAlsSF3 := oPrepare:OpenAlias()

		While !(cAlsSF3)->(Eof ())
			If !T40->(DbSeek((cAlsSF3)->F3_NFISCAL+(cAlsSF3)->F3_SERIE+(cAlsSF3)->F3_CLIEFOR+(cAlsSF3)->F3_LOJA))
				T40->(RecLock("T40", .T.))
				T40->NFISCAL := (cAlsSF3)->F3_NFISCAL
				T40->SERIE   := (cAlsSF3)->F3_SERIE
				T40->CLIEFOR := (cAlsSF3)->F3_CLIEFOR
				T40->LOJA    := (cAlsSF3)->F3_LOJA
				T40->(MsUnLock())
			EndIf
			(cAlsSF3)->(dbSkip())
		EndDo
		(cAlsSF3)->(DbCloseArea())

		If oPrepare != Nil
			oPrepare:Destroy()
			oPrepare := nil
		EndIf

		//Pesquisa por E2_BAIXA

		cQuery := " SELECT F3_NFISCAL, F3_SERIE, F3_CLIEFOR, F3_LOJA "
		cQuery += " FROM " + RetSqlName("SE5")+" SE5 "
		cQuery += " INNER JOIN " +RetSqlName("SF3")+" SF3 "
		cQuery += " ON SF3.F3_FILIAL = ? AND SF3.F3_NFISCAL = SE5.E5_NUMERO AND SF3.F3_CLIEFOR = SE5.E5_CLIFOR "
		cQuery += " AND SF3.F3_LOJA = SE5.E5_LOJA "
		cQuery += " AND SF3.D_E_L_E_T_ = ? "
		cQuery += " INNER JOIN "+RetSqlName("SE2")+" SE2 "
		cQuery += " ON SE2.E2_FILIAL = ? AND SE2.E2_NUM = SF3.F3_NFISCAL "
		cQuery += " AND SE2.E2_FORNECE = SF3.F3_CLIEFOR AND SE2.E2_LOJA = SF3.F3_LOJA "
		cQuery += " AND SE2.D_E_L_E_T_ = ? "
		cQuery += " INNER JOIN "+RetSqlName("SF1")+" SF1 "
		cQuery += " ON SF1.F1_FILIAL = SF3.F3_FILIAL AND SF1.F1_DOC = SF3.F3_NFISCAL "
		cQuery += " AND SF1.F1_FORNECE = SF3.F3_CLIEFOR AND SF1.F1_LOJA = SF3.F3_LOJA "
		cQuery += " AND SF1.D_E_L_E_T_ = ? "
		If l12_1_2610 .or. lAuto
			cQuery += " INNER JOIN "+RetSqlName("FK7")+" FK7 "
			cQuery += " ON FK7.FK7_ALIAS = ? AND FK7.FK7_FILTIT = SE2.E2_FILIAL AND FK7.FK7_PREFIX = SE2.E2_PREFIXO "
			cQuery += " AND FK7.FK7_NUM = SE2.E2_NUM AND FK7.FK7_PARCEL = SE2.E2_PARCELA AND FK7.FK7_TIPO = SE2.E2_TIPO "
			cQuery += " AND FK7.FK7_CLIFOR = SE2.E2_FORNECE AND FK7.FK7_LOJA = SE2.E2_LOJA AND FK7.D_E_L_E_T_ = ? "
			cQuery += " INNER JOIN "+RetSqlName("FK7")+" FK7T "
			cQuery += " ON FK7T.FK7_FILIAL = FK7.FK7_FILIAL AND FK7T.FK7_IDPAI = FK7.FK7_IDDOC "
			cQuery += " AND FK7T.FK7_TIPO = ? AND FK7T.FK7_IDPAI <> ? AND FK7T.D_E_L_E_T_ = ? "
			cQuery += " WHERE SE5.E5_FILIAL = ? "
			cQuery += " AND SE5.E5_DATA BETWEEN ? AND ? "
			cQuery += " AND SE5.E5_TIPO = ? AND SE5.E5_VRETISS > ? "
			cQuery += " AND SE5.E5_PARCELA IN (?) AND SE2.E2_BAIXA <> ? "
			cQuery += " AND SF3.F3_CFO < ? AND SF3.F3_CODISS <> ? AND SF3.F3_RECISS = ? AND SE5.D_E_L_E_T_ = ? "
		Else
			cQuery += " WHERE SE5.E5_FILIAL = ? "
			cQuery += " AND SE5.E5_DATA BETWEEN ? AND ? "
			cQuery += " AND SE5.E5_TIPO = ? AND SE5.E5_VRETISS > ? "
			cQuery += " AND SE5.E5_PARCELA IN (?) AND SE2.E2_BAIXA <> ? "
			cQuery += " AND SF3.F3_CFO < ? AND SF3.F3_CODISS <> ? AND SF3.F3_RECISS = ? AND SE5.D_E_L_E_T_ = ? "
			cQuery += "  AND EXISTS(SELECT E2_PREFIXO,E2_NUM,'NF' AS E2_TIPO FROM "+RetSqlName("SE2")+" SE2T "
			cQuery += "  WHERE SE2T.E2_FILIAL = ? "
			cQuery += "  AND SE2T.E2_TITPAI = SE2.E2_PREFIXO || SE2.E2_NUM ||SE2.E2_PARCELA || SE2.E2_TIPO || SE2.E2_FORNECE || SE2.E2_LOJA "
			cQuery += "  AND SE2T.E2_BAIXA <> ? AND SE2T.E2_TIPO = ? AND SE2T.D_E_L_E_T_ = ? ) "
		EndIf

		cQuery += " ORDER BY SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_CLIEFOR,SF3.F3_LOJA "

		cQuery := ChangeQuery(cQuery)

		oPrepare := FwExecStatement():New(cQuery)

		oPrepare:setString(1, xFilial("SF3") )
		oPrepare:setString(2, ' ' )
		oPrepare:setString(3, xFilial("SE2") )
		oPrepare:setString(4, ' ' )
		oPrepare:setString(5, ' ' )
		If l12_1_2610 .or. lAuto
			oPrepare:setString(6, 'SE2' )
			oPrepare:setString(7, ' ' )
			oPrepare:setString(8, 'ISS' )
			oPrepare:setString(9, space(nTamFK7) )
			oPrepare:setString(10, ' ' )
			oPrepare:setString(11, xFilial("SE5"))
			oPrepare:setDate(12, dIni)
			oPrepare:setDate(13, dFim)
			oPrepare:setString(14, 'NF' )
			oPrepare:setNumeric(15, 0 )
			oPrepare:setIn(16, {' ', '1','A'} )
			oPrepare:setString(17, space(nTamSe2) )
			oPrepare:setString(18, '5' )
			oPrepare:setString(19, space(nTamIss) )
			oPrepare:setString(20, '2' )
			oPrepare:setString(21, ' ' )
		Else
			oPrepare:setString(6, xFilial("SE5"))
			oPrepare:setDate(7, dIni)
			oPrepare:setDate(8, dFim)
			oPrepare:setString(9, 'NF' )
			oPrepare:setNumeric(10, 0 )
			oPrepare:setIn(11, {' ', '1','A'} )
			oPrepare:setString(12, space(nTamSe2) )
			oPrepare:setString(13, '5' )
			oPrepare:setString(14, space(nTamIss) )
			oPrepare:setString(15, '2' )
			oPrepare:setString(16, ' ' )
			oPrepare:setString(17, xFilial("SE2") )
			oPrepare:setString(18, space(nTamSe2) )
			oPrepare:setString(19, 'ISS' )
			oPrepare:setString(20, ' ' )
		EndIf

		cAlsSE5 := oPrepare:OpenAlias()

		While !(cAlsSE5)->(Eof ())
			If !T40->(DbSeek((cAlsSE5)->F3_NFISCAL+(cAlsSE5)->F3_SERIE+(cAlsSE5)->F3_CLIEFOR+(cAlsSE5)->F3_LOJA))
				T40->(RecLock("T40", .T.))
				T40->NFISCAL := (cAlsSE5)->F3_NFISCAL
				T40->SERIE   := (cAlsSE5)->F3_SERIE
				T40->CLIEFOR := (cAlsSE5)->F3_CLIEFOR
				T40->LOJA    := (cAlsSE5)->F3_LOJA
				T40->(MsUnLock())
			EndIf
			(cAlsSE5)->(dbSkip())
		EndDo
		(cAlsSE5)->(DbCloseArea())

		If oPrepare != Nil
			oPrepare:Destroy()
			oPrepare := nil
		EndIf

	Else
		DbSelectArea("T40")
		T40->(DbCloseArea())
	EndIf

Return

/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณDCCCS13   บAutor  ณ Cleber Maldonado   บ Data ณ  26/04/2016 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณProcessa valores de INSS retido para gerar o registro S13   บฑฑ
ฑฑบ          ณpara importa็ใo atrav้s do programa PER/DCOMP               บฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DCCCS13(dDataIni,dDataFin,aWizard)
Local cAliasSE1	:= "SE1"
Local cCampos	:= ""
Local lTop		:= .F.
Local aCampos	:= {}

//Array com campo da tabela temporแria
aadd(aCampos,{"TPESSOA"		,'C'	,02	,0})
aadd(aCampos,{"CGC"		  	,'C'	,14	,0})
aadd(aCampos,{"NFISCAL"		,'C'	,09	,0})
aadd(aCampos,{"SERIE"		,'C'	,03	,0})
aadd(aCampos,{"EMISSAO"		,'C'	,08	,0})
aadd(aCampos,{"VALBRUT"		,'N'	,14	,2})
aadd(aCampos,{"VALRET"		,'N'	,14	,2})
aadd(aCampos,{"ANO"		  	,'C'	,04	,0})
aadd(aCampos,{"MES"			,'C'	,02	,0})
aadd(aCampos,{"CODREC"		,'C'	,04	,0})

//CRIA TABELA TEMPORARIA E INDICE
cArqTrab :=CriaTrab(aCampos,.T.)
dbUseArea(.T.,,cArqTrab,"S13",.F.,.F.)
IndRegua( "S13", cArqTrab,"CGC")
dbSelectArea("S13")

cCampos += "SE1.E1_NUM,SE1.E1_PREFIXO,SE1.E1_EMISSAO,SE1.E1_VALOR,SE1.E1_INSS,"
cCampos += "SA1.A1_TPESSOA,SA1.A1_CGC"
cCampos := "%" + cCampos + "%"

#IFDEF TOP
	If (TcSrvType ()<>"AS/400")
		lTop := .T.
		cAliasSE1 := GetNextAlias()
		BeginSql Alias cAliasSE1
			SELECT
				%Exp:cCampos%
			FROM
				%TABLE:SE1% SE1, %TABLE:SA1% SA1
			WHERE
				SE1.E1_FILIAL=%XFILIAL:SE1% AND
				SA1.A1_FILIAL=%XFILIAL:SA1% AND
				SE1.E1_CLIENTE=SA1.A1_COD AND
				SE1.E1_LOJA=SA1.A1_LOJA AND
				SE1.E1_CLIENTE BETWEEN %exp:aWizard[1,3]% AND %exp:aWizard[1,5]% AND
				SE1.E1_LOJA    BETWEEN %exp:aWizard[1,4]% AND %exp:aWizard[1,6]% AND
				SE1.E1_INSS > 0 AND
				SE1.E1_EMISSAO between %exp:mv_par01% AND %exp:mv_par02% AND
				SE1.E1_EMISSAO <= %exp:dDataBase% AND
				SE1.%NotDel% AND
				SA1.%NotDel%
			ORDER BY SA1.A1_CGC
		EndSql
		DbSelectArea(cAliasSE1)
		(cAliasSE1)->(DbGoTop())
	Else
#ENDIF
		cIndex  := CriaTrab(NIL,.F.)
		cFiltro := 'E1_FILIAL=="'+xFilial ("SE1")+'".And.'
		cFiltro += 'DTOS(E1_EMISSAO)>="'+DTOS(dDataIni)+'" .And. '
		cFiltro += 'DTOS(E1_EMISSAO)<="'+DTOS(dDataFin)+'" '
		IndRegua(cAliasSE1,cIndex,cAliasSE1->(IndexKey()),,cFiltro)
		nIndex := RetIndex(cAliasSE1)
		#IFNDEF TOP
			DbSetIndex(cIndex+OrdBagExt())
		#ENDIF
		DbSelectArea(cAliasSE1)
		DbSetOrder(nIndex+1)
#IFDEF TOP
	Endif
#ENDIF

ProcRegua((cAliasSE1)->(RecCount()))
(cAliasSE1)->(DbGoTop())
dbSelectArea("S13")
DbSetOrder(1)
DO While !(cAliasSE1)->(EOF())
	IncProc("Verificando Documentos: ")
	If MsSeek((cAliasSE1)->A1_CGC)
		RecLock("S13",.F.)
		S13->VALBRUT	+= (cAliasSE1)->E1_VALOR
		S13->VALRET		+= (cAliasSE1)->E1_INSS
	Else
		RecLock("S13",.T.)
		S13->TPESSOA	:=	(cAliasSE1)->A1_TPESSOA
		S13->CGC	 	:=  (cAliasSE1)->A1_CGC
		S13->NFISCAL	:=	(cAliasSE1)->E1_NUM
		S13->SERIE 		:=	(cAliasSE1)->E1_PREFIXO
		S13->EMISSAO	:=  SubStr((cAliasSE1)->E1_EMISSAO,7,2)+SubStr((cAliasSE1)->E1_EMISSAO,5,2)+SubStr((cAliasSE1)->E1_EMISSAO,1,4)
		S13->VALBRUT	:=	(cAliasSE1)->E1_VALOR
		S13->VALRET		:=	(cAliasSE1)->E1_INSS
		S13->ANO		:=	aWizard[1,1]
		S13->MES		:=	aWizard[1,2]
		S13->CODREC		:=	aWizard[1,7]
	EndIF
	IncProc("Processando Documentos")
	(cAliasSE1)->(DbSkip())
EndDo

If lTop
	DbSelectArea (cAliasSE1)
	(cAliasSE1)->(DbCloseArea())
Else
	RetIndex("SE1")
	FErase(cIndex+OrdBagExt())
EndIf

Return


/*

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบFuncao    ณDCCCR21   บAutor  ณ Alex Fagundes      บ Data ณ  26/10/2018 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDesc.     ณProcessa as Apura็๕es de IPI para o Perํodo informado, para บฑฑ
ฑฑบ			 ณgerar o registro R21 para importa็ใo atrav้s do programa    บฑฑ
ฑฑบ          ณPER/DCOMP               									  บฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DCCCR21(dDataIni,dDataFin,aWizard,lAglFil,aFilsCalc)

Local cTipo			:= "R21"
Local cMesAtual		:= ""
Local cAnoAtual		:= ""
Local cChave		:= ""
Local cQryCDP		:= ""
Local cAliasCDP		:= ""
Local aCampos		:= {}
Local aBind			:= {}
Local aR21 			:= {}
Local nForFilial	:= 0
Local nX 			:= 0
Local oTempTable	:= Nil
Local oR21			:= JsonObject():New()

Default lAglFil 	:= .F.
Default aFilsCalc 	:= {}

//De x Para C๓digo e Campo
aadd(aR21,{"001","CRDINTERNO"})
aadd(aR21,{"002","CRDEXTERNO"})
aadd(aR21,{"004","ESTDEBITO"})
aadd(aR21,{"005","CRDOUTRO"})
aadd(aR21,{"009","DEBINTERNO"})
aadd(aR21,{"010","ESTCRD"})
aadd(aR21,{"011","RECCRD"})
aadd(aR21,{"012","DEBOUTRO"})

For nX := 1 To Len(aR21)
	cChave			:= aR21[nX][1]
	oR21[cChave]	:= aR21[nX][2]
Next nX

//Array com campo da tabela temporแria
aadd(aCampos,{"TIPO"		,'C'	,03	,0})
aadd(aCampos,{"CNPJEmp"		,'C'	,14	,0})
aadd(aCampos,{"CNPJSuce"	,'C'	,14	,0})
aadd(aCampos,{"CNPJDet" 	,'C'	,14	,0})
aadd(aCampos,{"ANO"			,'C'	,04	,0})
aadd(aCampos,{"MES"			,'C'	,02	,0})
aadd(aCampos,{"PERIODO"		,'C'	,01	,0})
aadd(aCampos,{"MOVIMENTO"	,'N'	,01	,0})
aadd(aCampos,{"CRDINTERNO"	,'N'	,14	,2})
aadd(aCampos,{"CRDEXTERNO"	,'N'	,14	,2})
aadd(aCampos,{"ESTDEBITO"	,'N'	,14	,2})
aadd(aCampos,{"CRDPRES"		,'N'	,14	,2})
aadd(aCampos,{"CRDEXTEMP"	,'N'	,14	,2})
aadd(aCampos,{"CRDOUTRO"	,'N'	,14	,2})
aadd(aCampos,{"DEBINTERNO"	,'N'	,14	,2})
aadd(aCampos,{"ESTCRD"		,'N'	,14	,2})
aadd(aCampos,{"RECCRD"		,'N'	,14	,2})
aadd(aCampos,{"DEBOUTRO"	,'N'	,14	,2})

//-------------------
//Cria็ใo do objeto
//-------------------
oTempTable := FWTemporaryTable():New( cTipo )

oTemptable:SetFields( aCampos )
oTempTable:AddIndex("indice1", {"TIPO", "ANO", "MES" })

//------------------
//Cria็ใo da tabela
//------------------
oTempTable:Create()

cQryCDP := "SELECT CDP.CDP_FILIAL, CDP.CDP_TIPOIP, CDP.CDP_TIPOPR, CDP.CDP_PERIOD, CDP.CDP_DTINI, CDP.CDP_LIVRO,"
cQryCDP += " CDP.CDP_SEQUEN, CDP.CDP_LINHA, CDP.CDP_SEQLIN, CDP.CDP_VALOR"
cQryCDP += "FROM "+RetSqlName("CDP")+" CDP "
cQryCDP += "WHERE CDP.CDP_FILIAL= ? AND "
cQryCDP += "CDP.CDP_TIPOIP = ? AND "
cQryCDP += "CDP.CDP_DTINI = ? AND "
cQryCDP += "CDP.CDP_DTFIM = ? AND "
cQryCDP += "CDP.CDP_LIVRO = ? AND "
cQryCDP += "CDP.CDP_SEQUEN=(SELECT MAX(B.CDP_SEQUEN) FROM "+RetSqlName("CDP")+" B WHERE B.CDP_FILIAL=CDP.CDP_FILIAL AND B.CDP_TIPOIP=CDP.CDP_TIPOIP AND B.CDP_TIPOPR=CDP.CDP_TIPOPR AND B.CDP_PERIOD=CDP.CDP_PERIOD AND B.CDP_DTINI=CDP.CDP_DTINI AND B.CDP_LIVRO=CDP.CDP_LIVRO AND B.D_E_L_E_T_=' ') AND "
cQryCDP += "CDP.D_E_L_E_T_= ? "
cQryCDP += "ORDER BY "+SqlOrder(CDP->(IndexKey()))
cQryCDP := ChangeQuery(cQryCDP)

If lAglFil

	For nForFilial := 1 To Len( aFilsCalc )

		If aFilsCalc[nForFilial,1]

			cChave 		:= ""
			aBind 		:= {}
			cAliasCDP 	:= GetNextAlias()

			AADD(aBind,aFilsCalc[nForFilial,2])
			AADD(aBind,"IP")
			AADD(aBind,DtoS(dDataIni))
			AADD(aBind,DtoS(dDataFin))
			AADD(aBind,"*")
			AADD(aBind,Space(1))

			dbUseArea(.T.,"TOPCONN",TcGenQry2(,,cQryCDP,aBind),cAliasCDP,.T.,.T.)
			(cAliasCDP)->(DBGoTop())

			If (cAliasCDP)->(!EOF())

				cMesAtual := StrZero(Month(StoD((cAliasCDP)->(CDP_DTINI))),2)
				cAnoAtual := Alltrim(Str(Year(StoD((cAliasCDP)->(CDP_DTINI)))))
				cChave := cTipo + cAnoAtual + cMesAtual

				DbSelectArea(cTipo)
				If !(cTipo)->(MsSeek(cChave))

					RecLock(cTipo,.T.)
					(cTipo)->TIPO		:= cTipo
					(cTipo)->CNPJEmp	:= aWizard[1][1]
					(cTipo)->CNPJSuce	:= aWizard[1][2]
					(cTipo)->CNPJDet	:= aWizard[1][3]
					(cTipo)->MES 		:= cMesAtual
					(cTipo)->ANO 		:= cAnoAtual
					(cTipo)->PERIODO	:= aWizard[2][3]

					DbSelectArea(cAliasCDP)
					While (cAliasCDP)->(!EOF())
						If oR21:hasProperty((cAliasCDP)->(CDP_LINHA))
							(cTipo)->&(oR21[(cAliasCDP)->(CDP_LINHA)]) := (cAliasCDP)->(CDP_VALOR)
						EndIf
						(cAliasCDP)->(DbSkip())
					EndDo

				Else
					DbSelectArea(cAliasCDP)
					While (cAliasCDP)->(!EOF())
						If oR21:hasProperty((cAliasCDP)->(CDP_LINHA))
							(cTipo)->&(oR21[(cAliasCDP)->(CDP_LINHA)]) += (cAliasCDP)->(CDP_VALOR)
						EndIf
						(cAliasCDP)->(DbSkip())
					EndDo
				EndIf

				(cTipo)->(MsUnlock())

			EndIf

			(cAliasCDP)->(dbCloseArea())

		EndIf	

	Next nForFilial

Else

	aBind := {}
	cAliasCDP := GetNextAlias()

	AADD(aBind,xFilial("CDP"))
	AADD(aBind,"IP")
	AADD(aBind,DtoS(dDataIni))
	AADD(aBind,DtoS(dDataFin))
	AADD(aBind,"*")
	AADD(aBind,Space(1))

	dbUseArea(.T.,"TOPCONN",TcGenQry2(,,cQryCDP,aBind),cAliasCDP,.T.,.T.)
	(cAliasCDP)->(DBGoTop())

	If (cAliasCDP)->(!EOF())

		cMesAtual := StrZero(Month(StoD((cAliasCDP)->(CDP_DTINI))),2)
		cAnoAtual := Alltrim(Str(Year(StoD((cAliasCDP)->(CDP_DTINI)))))
		cChave := cTipo + cAnoAtual + cMesAtual

		DbSelectArea(cTipo)
		If !(cTipo)->(MsSeek(cChave))

			RecLock(cTipo,.T.)
			(cTipo)->TIPO		:= cTipo
			(cTipo)->CNPJEmp	:= aWizard[1][1]
			(cTipo)->CNPJSuce	:= aWizard[1][2]
			(cTipo)->CNPJDet	:= aWizard[1][3]
			(cTipo)->MES 		:= cMesAtual
			(cTipo)->ANO 		:= cAnoAtual
			(cTipo)->PERIODO	:= aWizard[2][3]

			DbSelectArea(cAliasCDP)
			While (cAliasCDP)->(!EOF())
				If oR21:hasProperty((cAliasCDP)->(CDP_LINHA))
					(cTipo)->&(oR21[(cAliasCDP)->(CDP_LINHA)]) := (cAliasCDP)->(CDP_VALOR)
				EndIf
				(cAliasCDP)->(DbSkip())
			EndDo
			
			(cTipo)->(MsUnlock())
		EndIf

	EndIf

	(cAliasCDP)->(dbCloseArea())

EndIf	

(cTipo)->(dbGoTop())

FreeObj(oR21)
oR21 := Nil

Return

//------------------------------------------------------------------
/*/{Protheus.doc} InvDMA

calcular quadro 12 inventario DMA BA

@author Rafael Oliveira
@since  28/07/2016
@version 1.0

Nota do boletim t้cnico:
OBSERVAวีES : Este quadro s๓ deverแ ser preenchido quando ocorrer Baixa de Inscri็ใo Estadual, Mudan็a de condi็ใo ou m๊s de referencia Fevereiro.
Deverแ ser informado na DMA de Fevereiro, a partir do exercํcio de 2002, o estoque inicial e final do exercํcio anterior, mesmo que se trate de uma declara็ใo de baixa ou mudan็a de condi็ใo. A classifica็ใo acima descrita deverแ obedecer ao definido no art. 330 do RICMS-BA/97.
O demonstrativo do estoque (quadro 12) na DMA serแ enviado anualmente com base no Registro de Inventแrio. Serใo informados os dados relativos aos estoques inicial e final do exercํcio imediatamente anterior, conforme determina o Art. 255, III do RICMS-BA.
/*/
//------------------------------------------------------------------
Function InvDMA(Status,dData,aDadAdi)
Local aArea     := {}
Local dDataDe   := FirstDay(dData)
Local dDataAte  := dData
Local cAliasSFT := ""
Local cAliasSB9 := ""
Local cProd		:= ""
Local cNat		:= ""
Local cAlias 	:= ""
Local nTtQuant	:= 0
Local nQuant	:= 0
Local nQuantFT	:= 0
Local lAchouFT	:= .F.
Local lSFTQuant	:= .F.

aArea := GetArea()

//Procura quantidade em Estoque
cAliasSB9	:=	GetNextAlias()

BeginSql Alias cAliasSB9
	SELECT
		B9_COD,B9_LOCAL,B9_QINI
	FROM
		%Table:SB9% SB9
	WHERE
		SB9.B9_FILIAL=%xFilial:SB9% AND
		SB9.B9_DATA=%Exp:DToS(dData)% AND
		SB9.%NotDel%
	ORDER BY SB9.B9_COD
EndSql

DbSelectArea(cAliasSB9)
While (cAliasSB9)->(!EoF())
	//--Quadro 12 sempre sera informado no mes de fevereiro.
	IF MV_PAR02 == 2 .Or. Posicione("SB5",1,xFilial("SB5")+(cAliasSB9)->B9_COD,"B5_ALTTRIB") == "1"
		//Restaura data inicial por tipo de produto
		dDataDe   := FirstDay(dData)
		dDataAte  := dData

		cProd  := (cAliasSB9)->B9_COD
		nQuant := (cAliasSB9)->B9_QINI
		nQuantFT := 0

		IF nQuant <= 0 //Nใo processa se nใo existir estoque
			(cAliasSB9)->(DbSkip())
			Loop
		Endif

		lAchouFT  := .F.
		lSFTQuant := .F.

		//Verifica se existe nota de entrada para este produto
		cAlias := GetNextAlias()
		BeginSql Alias cAlias
			SELECT SUM(SFT.FT_QUANT) QUANT
			FROM %TABLE:SFT% SFT
			WHERE
			SFT.FT_FILIAL=%XFILIAL:SFT% AND
			SFT.FT_PRODUTO =%EXP:cProd% AND
			SFT.FT_ENTRADA>=%Exp:DToS(FirstYDate(dDataDe))%  AND //Retorna a Data do Primeiro dia do Ano da Data Passada
			SFT.FT_ENTRADA<=%Exp:DToS(dDataAte)% AND
			SFT.FT_TIPO NOT IN ('D','B') AND
			SFT.FT_TIPOMOV = 'E' AND
			SFT.FT_DTCANC = '' AND
			SFT.%NOTDEL%
		EndSql
		DbSelectArea (cAlias)

		IF (cAlias)->QUANT >= nQuant
			lAchouFT  := .T.
		Elseif(cAlias)->QUANT > 0 .and. (cAlias)->QUANT < nQuant // Processa pela quantidade encontrada na SFT
			lSFTQuant := .T.
			nQuantFT  := (cAlias)->QUANT
		Endif
		(cAlias)->(dbCloseArea())

		//Processar notas de entrada
		If lAchouFT .Or. lSFTQuant
			cProd := (cAliasSB9)-> B9_COD
			If lSFTQuant
				nQuant := nQuantFT
			Else
				nQuant := (cAliasSB9)-> B9_QINI
			EndIf

			nTtQuant := 0
			cNat     := ""

			While nTtQuant < nQuant
				cAliasSFT := GetNextAlias()

				BeginSql Alias cAliasSFT
					SELECT
						B1_TIPO NATUREZA, SUM(FT_QUANT) QUANT, SUM(FT_VALICM) VALTRIB,SUM(FT_ISENICM) ISENICM, SUM(FT_OUTRICM) OUTRICM
					FROM
						%TABLE:SFT% SFT
					INNER JOIN %TABLE:SB1% SB1 ON(SB1.B1_FILIAL=%xFilial:SB1% AND SFT.FT_PRODUTO=SB1.B1_COD AND SB1.%NotDel%)
					WHERE
						SFT.FT_FILIAL=%XFILIAL:SFT% AND
						SFT.FT_PRODUTO =%EXP:cProd% AND
						SFT.FT_ENTRADA>=%Exp:DToS(dDataDe)% AND
						SFT.FT_ENTRADA<=%Exp:DToS(dDataAte)% AND
						SFT.FT_DTCANC = '' AND
						SFT.FT_TIPOMOV = 'E' AND
						SFT.FT_TIPO NOT IN ('D','B') AND
						SFT.%NOTDEL%
					GROUP BY SB1.B1_TIPO
				EndSql
				DbSelectArea (cAliasSFT)
				nTtQuant += (cAliasSFT)->QUANT
				IF (cAliasSFT)->QUANT > 0
					//Grava Valores por B1_TiPO
					Do Case
						Case (cAliasSFT)->NATUREZA == 'ME' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[1]
							cNat := "1"
						Case (cAliasSFT)->NATUREZA == 'MC' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[2]
							cNat := "2"
						Case (cAliasSFT)->NATUREZA == 'MP' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[3]
							cNat := "3"
						Case (cAliasSFT)->NATUREZA == 'PI' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[4]
							cNat := "4"
						Case (cAliasSFT)->NATUREZA == 'EM' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[5]
							cNat := "5"
						Case (cAliasSFT)->NATUREZA == 'PP' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[6]
							cNat := "6"
						Case (cAliasSFT)->NATUREZA == 'PA' .Or. (cAliasSFT)->NATUREZA $ aDadAdi[7]
							cNat := "7"
					EndCase
					IF Status == "I" .And. INV->(MsSeek(cNat))
						Reclock("INV",.F.)
						INV->I_VALTRIB  += (cAliasSFT)->VALTRIB
						INV->I_ISENICM  += (cAliasSFT)->ISENICM
						INV->I_OUTRICM  += (cAliasSFT)->OUTRICM
						INV->I_VALTOTAL += (cAliasSFT)->VALTRIB+(cAliasSFT)->ISENICM+(cAliasSFT)->OUTRICM
						MSunlock()
					ElseIf Status == "F" .And. INVF->(MsSeek(cNat))
						Reclock("INVF",.F.)
						INVF->F_VALTRIB  += (cAliasSFT)->VALTRIB
						INVF->F_ISENICM  += (cAliasSFT)->ISENICM
						INVF->F_OUTRICM  += (cAliasSFT)->OUTRICM
						INVF->F_VALTOTAL += (cAliasSFT)->VALTRIB+(cAliasSFT)->ISENICM+(cAliasSFT)->OUTRICM
						MSunlock()
					Endif
				Endif
				(cAliasSFT)->(dbCloseArea())

				//Primeiro dia
				dDataDe	:= FirstDay(dDataDe)
				dDataDe := dDataDe - 1
				dDataDe	:= FirstDay(dDataDe)

				//Ultimo Dia
				dDataAte := FirstDay(dDataAte)
				dDataAte :=  dDataAte - 1

			Enddo
		Endif
	Endif
	(cAliasSB9)->(DbSkip())
Enddo
(cAliasSB9)->(dbCloseArea())

RestArea(aArea)

Return

/*Fun็ใo para retorno da Situa็ใo do documento e
  retorno das informa็๕es adicionais
  Estrutura do array posi็ใo 2
	Refer๊ncia de apura็ใo AAMM(4 algarismos),
	Modelo MO (2 caracteres),
	S้rie SSS (3 caracteres),
	N๚mero NNNNNNNNN (9 algarismos)
	Data de emissใo AAAAMMDD (8 algarismos)

	Criado por: Henrique Fabiano Pateno Pereira
	05/01/2017

*/
Static Function C115InfAdd(cAliasSFT, dDataDe, dDataAte, lCancFor, oCashFil)
	Local aRetInfo		:= {"",""} //AAMM_MO_SSS_NNNNNNNNN_AAAAMMDD

	Default dDataDe		:= STOD("//")
	Default dDataAte	:= STOD("//")

	If (cAliasSFT)->FT_CFOP >= '5000'
		If "CANCELAD"$(cAliasSFT)->FT_OBSERV .And. !Empty((cAliasSFT)->FT_DTCANC)
			//Tratamento para que seja possivel considerar cancelamento fora do perํodo de escritura็ใo
			//obs. Realizada esta altera็ใo pois nใo hแ embasamento legal que informe que nใo pode ser considerado.
			If !lCancFor
				If((cAliasSFT)->FT_DTCANC >= dDataDe .And. (cAliasSFT)->FT_DTCANC <= dDataAte)
					aRetInfo[1] := 'S'
				Else
					aRetInfo[1] := 'N'
				EndIf
			Else
				aRetInfo[1] := 'S'
			EndIf
		EndIf

		If (cAliasSFT)->FT_TIPO $ "I|P|C" // Complementos			
			If SF2->(MsSeek(oCashFil["SF2"]+(cAliasSFT)->(FT_NFORI+FT_SERORI+FT_CLIEFOR+FT_LOJA+FT_FORMUL+"N")))
				aRetInfo[1] := 'C'
				aRetInfo[2]	:= SubStr(Dtos(SF2->F2_EMISSAO),3,2)+SubStr(Dtos(SF2->F2_EMISSAO),5,2)+'_'
				aRetInfo[2]	+= aModNot(SF2->F2_ESPECIE)+'_'
				aRetInfo[2]	+= Alltrim(SF2->F2_SERIE)+REPLICATE('_',len(SF2->F2_SERIE)-Len(Alltrim(SF2->F2_SERIE)))+'_'
				aRetInfo[2]	+= PadL(Alltrim(SF2->F2_DOC),9,"0")+'_'
				aRetInfo[2]	+= Dtos(SF2->F2_EMISSAO)
			EndIf
		EndIf
	EndIf

Return aRetInfo

//------------------------------------------------------------------
/*/{Protheus.doc} DMDBA

Rotina de escritura็ใo do meio magn้tico DMDABA

@Return ( Nil )

@author Henrique Pereira
@since  03/08/2017
@version 1.0

/*/
//-------------------------------------------------------------------

Function DMDBA(nOpc)

If nOpc == 1
	OpenTrb()
ElseIf nOpc == 2
	ProcDMDBA()
EndIf

Return

//------------------------------------------------------------------
/*/{Protheus.doc} ProcDMDBA

Rotina que alimenta os TRBs criados por OpenTrb()

@Return ( Nil )

@author Henrique Pereira
@since  03/08/2017
@version 1.0

/*/
//-------------------------------------------------------------------

Static Function ProcDMDBA()
Local cCondicao	 := ''
Local cCamposPrd := ''
Local cCamposMn1 := ''
Local cCamposMn2 := ''
Local cAgrupPrd  := ''
Local cAgrupMn1  := ''
Local cAgrupMn2  := ''
Local cDMDB5     := GetNewPar("MV_DMDB5","")
Local cAliasSFT  := GetNextAlias()
Local nX         := 0
Local aProdutos  := {}
Local lCodPrdDf  := SB5->(ColumnPos('B5_CDDMDBA')) > 0
Local lCodHabB5  := SB5->(ColumnPos(cDMDB5))       > 0
Local lCodHabBZ  := SBZ->(ColumnPos('BZ_HABDIF'))  > 0
Local lCodMBAC2  := CC2->(ColumnPos('CC2_CODMBA')) > 0
Local cCodMBAC2  := ''
Local cCodPrdDf  := ''
Local cLastDay   := StrZero(Day(LastDay(StoD(MV_PAR01+MV_PAR02+'01'))),2)
Local lInscrito  := .T.

//ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
//ณPara montagem da query com o campo de icms diferido informado no sb5ณ
//ณNumero da habilitacao para comercializacao com diferimento          ณ
//ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

	If lCodPrdDf
		cCamposPrd := "SB5.B5_CDDMDBA, "
		cAgrupPrd  := "SB5.B5_CDDMDBA, "
	EndIf

	If !Empty(cDMDB5)
		If lCodHabB5
			cCamposPrd += "SB5." + Alltrim(cDMDB5) + " PRD_HABDIF,"
			cAgrupPrd  += "SB5." + Alltrim(cDMDB5) + ","
		Else
			lCodHabBZ := .F.
		EndIf
	Else
		If lCodHabBZ
			cCamposPrd += "SBZ.BZ_HABDIF"          + " PRD_HABDIF,"
			cAgrupPrd  += "SBZ.BZ_HABDIF,"
		Else
			lCodHabB5 := .F.
		EndIf
	EndIf

	If lCodMBAC2
		cCamposMn1 := "ISNULL(CC2A1.CC2_CODMBA,'') A1_CODMBA, "
		cCamposMn2 := "ISNULL(CC2A2.CC2_CODMBA,'') A2_CODMBA, "
		cAgrupMn1  := "CC2A1.CC2_CODMBA,"
		cAgrupMn2  := "CC2A2.CC2_CODMBA,"
	EndIf

	cCamposPrd	:= "% " + cCamposPrd + " %"
	cCamposMn1	:= "% " + cCamposMn1 + " %"
	cCamposMn2	:= "% " + cCamposMn2 + " %"
	cAgrupPrd	:= "% " + cAgrupPrd  + " %"
	cAgrupMn1	:= "% " + cAgrupMn1  + " %"
	cAgrupMn2	:= "% " + cAgrupMn2  + " %"

	BeginSql Alias cAliasSFT

		COLUMN FT_ENTRADA AS DATE
		COLUMN FT_DTCANC AS DATE

		SELECT SFT.FT_FILIAL,
			SFT.FT_TIPOMOV,
			SFT.FT_PRODUTO,
			%Exp:cCamposPrd%
			ISNULL(SA1.A1_EST,'')       A1_EST,
			ISNULL(SA1.A1_COD_MUN,'')   A1_CODMUN,
			%Exp:cCamposMn1%
			ISNULL(SA1.A1_COD,'')       A1_COD,
			ISNULL(SA1.A1_LOJA,'')      A1_LOJA,
			ISNULL(SA1.A1_INSCR,'')     A1_INSCR,
			ISNULL(SA1.A1_CONTRIB,'')   A1_CONTRIB,
			ISNULL(SA1.A1_TPJ,'')       A1_TPJ,
			ISNULL(SA1.A1_INSCRUR,'')   A1_INSCRUR,
			ISNULL(SA1.A1_TIPO,'')      A1_TIPO,
			ISNULL(SA2.A2_EST,'')       A2_EST,
			ISNULL(SA2.A2_COD_MUN,'')   A2_CODMUN,
			%Exp:cCamposMn2%
			ISNULL(SA2.A2_COD,'')       A2_COD,
			ISNULL(SA2.A2_LOJA,'')      A2_LOJA,
			ISNULL(SA2.A2_INSCR,'')     A2_INSCR,
			ISNULL(SA2.A2_CONTRIB,'')   A2_CONTRIB,
			ISNULL(SA2.A2_TIPORUR,'')   A2_TIPORUR,
			SUM(SFT.FT_QUANT)           FT_QUANT,
			SUM(SFT.FT_TOTAL)           FT_TOTAL
		FROM  %table:SFT% SFT LEFT OUTER JOIN %table:SA1% SA1   ON (SA1.A1_FILIAL   =%xFilial:SA1% AND SA1.A1_COD  =SFT.FT_CLIEFOR   AND SA1.A1_LOJA     =SFT.FT_LOJA    AND ((SFT.FT_TIPOMOV='S' AND SFT.FT_TIPO NOT IN ('D','B')) OR (SFT.FT_TIPOMOV='E' AND SFT.FT_TIPO IN ('D','B'))))
						      LEFT OUTER JOIN %table:SA2% SA2   ON (SA2.A2_FILIAL   =%xFilial:SA2% AND SA2.A2_COD  =SFT.FT_CLIEFOR   AND SA2.A2_LOJA     =SFT.FT_LOJA    AND ((SFT.FT_TIPOMOV='E' AND SFT.FT_TIPO NOT IN ('D','B')) OR (SFT.FT_TIPOMOV='S' AND SFT.FT_TIPO IN ('D','B'))))
						      LEFT OUTER JOIN %table:CC2% CC2A1 ON (CC2A1.CC2_FILIAL=%xFilial:CC2% AND CC2A1.CC2_EST=SA1.A1_EST      AND CC2A1.CC2_CODMUN=SA1.A1_COD_MUN AND CC2A1.%NotDel%)
						      LEFT OUTER JOIN %table:CC2% CC2A2 ON (CC2A2.CC2_FILIAL=%xFilial:CC2% AND CC2A2.CC2_EST=SA2.A2_EST      AND CC2A2.CC2_CODMUN=SA2.A2_COD_MUN AND CC2A2.%NotDel%)
						      LEFT OUTER JOIN %table:SB5% SB5   ON (SB5.B5_FILIAL   =%xFilial:SB5% AND SB5.B5_COD  =SFT.FT_PRODUTO   AND SB5.%NotDel%)
						      LEFT OUTER JOIN %table:SBZ% SBZ   ON (SBZ.BZ_FILIAL   =%xFilial:SBZ% AND SBZ.BZ_COD  =SFT.FT_PRODUTO   AND SBZ.%NotDel%)
		WHERE SFT.FT_FILIAL  = %xFilial:SFT%                                                           AND
			  SFT.FT_ENTRADA BETWEEN %Exp:mv_par01+mv_par02+'01'% AND %Exp:mv_par01+mv_par02+cLastDay% AND
			  SFT.FT_ICMSDIF > 0                                                                       AND
			  SFT.FT_DTCANC = ''                                                                       AND
			  SFT.FT_TIPO NOT IN ('I','P')                          								   AND
			  SFT.%NotDel%
		GROUP BY SFT.FT_FILIAL,
		         SFT.FT_TIPOMOV,
				 SFT.FT_PRODUTO,
				%Exp:cAgrupPrd%
		         SA1.A1_EST,
				 SA1.A1_COD_MUN,
				%Exp:cAgrupMn1%
		         SA1.A1_COD,
				 SA1.A1_LOJA,
		         SA1.A1_INSCR,
		         SA1.A1_CONTRIB,
		         SA1.A1_TPJ,
		         SA1.A1_INSCRUR,
		         SA1.A1_TIPO,
		         SA2.A2_EST,
				 SA2.A2_COD_MUN,
				%Exp:cAgrupMn2%
				 SA2.A2_COD,
				 SA2.A2_LOJA,
				 SA2.A2_INSCR,
				 SA2.A2_CONTRIB,
				 SA2.A2_TIPORUR

		EndSql

	DbSelectArea(cAliasSFT)
	(cAliasSFT)->(DbGoTop())
	While !(cAliasSFT)->(EOF())
			cCodPrdDf := Iif(lCodPrdDf,(cAliasSFT)->B5_CDDMDBA, Space(5))

			If !Empty((cAliasSFT)->A1_COD)
				//---Valida็ใo de Inscrito / Nใo inscrito para cliente retirada do Matxfis ---//
				lInscrito := Iif(Empty((cAliasSFT)->A1_INSCR) .Or. "ISENT"$(cAliasSFT)->A1_INSCR .Or. "RG"$(cAliasSFT)->A1_INSCR .Or. (cAliasSFT)->A1_CONTRIB == "2",.F.,.T.)

				If (cAliasSFT)->A1_CONTRIB == "1" .And. (cAliasSFT)->A1_TPJ == "3" .And. (Empty((cAliasSFT)->A1_INSCR) .And. "ISENT" $ (cAliasSFT)->A1_INSCR)
					lInscrito := .T. 
				EndIf

				If !Empty((cAliasSFT)->A1_INSCRUR) .And. "L" $ (cAliasSFT)->A1_TIPO .And. (cAliasSFT)->A1_CONTRIB <> "2"
					lInscrito := .T.
				EndIf

				cCodMBAC2 := Iif((cAliasSFT)->A1_EST == 'BA', Iif(lCodMBAC2, (cAliasSFT)->A1_CODMBA, Space(5)), '99994') //--- 99994 - Outras Uf - C๓digo retirado do validador da DMD--//
			Else
				//---Valida็ใo de Inscrito / Nใo inscrito para fornecedor retirada do relat๓rio Fisr003 ---//
				lInscrito := IIf(Empty((cAliasSFT)->A2_INSCR) .Or. "ISENT"$(cAliasSFT)->A2_INSCR .Or. "RG"$(cAliasSFT)->A2_INSCR .Or. SA2->A2_CONTRIB == "2" .Or. (!Empty(SA2->A2_TIPORUR)), .F., .T.)
				cCodMBAC2 := Iif((cAliasSFT)->A2_EST == 'BA', Iif(lCodMBAC2, (cAliasSFT)->A2_CODMBA, Space(5)), '99994') //--- 99994 - Outras Uf - C๓digo retirado do validador da DMD--//
			EndIf

			// T02 - Entradas
			If (cAliasSFT)->FT_TIPOMOV == "E"
				If !T02->(DbSeek(cCodPrdDf+cCodMBAC2))
					RecLock('T02',.T.)
					T02->ANODMD		:= MV_PAR01
					T02->MESDMD		:= MV_PAR02
					T02->IEDMD		:= Substr(ALLTRIM(SM0->M0_INSC),1,9)
					T02->CODPRODDIF	:= cCodPrdDf
					T02->MUNICIPIO	:= Substr(ALLTRIM(cCodMBAC2),1,5)
					If !lInscrito
						T02->QTDPROINS	:= 0
						T02->VLCOMINSC	:= 0
						T02->QTDPRONINS	:= (cAliasSFT)->FT_QUANT
						T02->VLCOMNINSC	:= (cAliasSFT)->FT_TOTAL
					Else
						T02->QTDPROINS	:= (cAliasSFT)->FT_QUANT
						T02->VLCOMINSC	:= (cAliasSFT)->FT_TOTAL
						T02->QTDPRONINS	:= 0
						T02->VLCOMNINSC	:= 0
					EndIf
				Else
					RecLock('T02',.F.)
					If !lInscrito
						T02->QTDPRONINS	+= (cAliasSFT)->FT_QUANT
						T02->VLCOMNINSC	+= (cAliasSFT)->FT_TOTAL
					Else
						T02->QTDPROINS	+= (cAliasSFT)->FT_QUANT
						T02->VLCOMINSC	+= (cAliasSFT)->FT_TOTAL
					EndIf
				EndIf
			EndIf

			//T03 - Saํdas
			If (cAliasSFT)->FT_TIPOMOV == "S"
				If !T03->(DbSeek(cCodPrdDf+cCodMBAC2))
					RecLock('T03',.T.)
					T03->ANODMD		:= MV_PAR01
					T03->MESDMD		:= MV_PAR02
					T03->IEDMD		:= Substr(ALLTRIM(SM0->M0_INSC),1,9)
					T03->CODPRODDIF	:= cCodPrdDf
					T03->MUNICIPIO	:= Substr(ALLTRIM(cCodMBAC2),1,5)
					If !lInscrito
						T03->QTDPROINS	:= 0
						T03->VLCOMINSC	:= 0
						T03->QTDPRONINS	:= (cAliasSFT)->FT_QUANT
						T03->VLCOMNINSC	:= (cAliasSFT)->FT_TOTAL
					Else
						T03->QTDPROINS	:= (cAliasSFT)->FT_QUANT
						T03->VLCOMINSC	:= (cAliasSFT)->FT_TOTAL
						T03->QTDPRONINS	:= 0
						T03->VLCOMNINSC	:= 0
					EndIf
				Else
					RecLock('T03',.F.)
					If !lInscrito
						T03->QTDPRONINS	+= (cAliasSFT)->FT_QUANT
						T03->VLCOMNINSC	+= (cAliasSFT)->FT_TOTAL
					Else
						T03->QTDPROINS	+= (cAliasSFT)->FT_QUANT
						T03->VLCOMINSC	+= (cAliasSFT)->FT_TOTAL
					EndIf
				EndIf
			EndIf

			// T01 - Identifica็ใo da Empresa
			If ASCAN(aProdutos, {|x|x[1] == cCodPrdDf}) == 0
				AADD(aProdutos, {})
				nPos := Len(aProdutos)
				aadd(aProdutos[nPos],cCodPrdDf)
				aadd(aProdutos[nPos],Iif(lCodHabB5 .Or. lCodHabBZ, Substr(AllTrim((cAliasSFT)->PRD_HABDIF),1,12), Space(12)))
			EndIf
			(cAliasSFT)->(DbSkip())
	EndDo

	For nX := 1 to Len(aProdutos)
		// T01 - Identifica็ใo da Empresa
		RecLock('T01',.T.)
		T01->ANODMD		:= mv_par01
		T01->MESDMD		:= mv_par02
		T01->IEDMD		:= Substr(ALLTRIM(SM0->M0_INSC),1,9)
		T01->RETIFICA	:= Iif(mv_par03 = 1,"S","N")
		T01->MOTIVOBX	:= Iif(mv_par04 = 1,"S","N")
		T01->CODPRODDIF	:= aProdutos[nX][1]
		T01->RAZAOSOCI	:= Substr(ALLTRIM(SM0->M0_NOME),1,50)
		T01->CONSOLPER	:= Iif(mv_par04 = 1,"S","N")
		T01->NUMHABILIT	:= aProdutos[nX][2]
		T01->MUNICIPIO	:=Iif(lCodMBAC2, Posicione("CC2",1,xFilial("CC2")+SM0->M0_ESTENT+Substr(ALLTRIM(SM0->M0_CODMUN),3,5),"CC2_CODMBA"), Space(5))
	Next
DbSelectArea(cAliasSFT)
dbCloseArea()

Return

//------------------------------------------------------------------
/*/{Protheus.doc} OpenTrb

Rotina que cria os TRBs que serใo usados para escritura็ใo do arquivo

@Return ( Nil )

@author Henrique Pereira
@since  03/08/2017
@version 1.0

/*/
//-------------------------------------------------------------------

Static Function OpenTrb()
Local cTRB		:= ''
Local aCampos	:= {}

// T01
AADD(aCampos,{"ANODMD"    ,"C",004,0})
AADD(aCampos,{"MESDMD"    ,"C",002,0})
AADD(aCampos,{"IEDMD"     ,"C",009,0})
AADD(aCampos,{"RETIFICA"  ,"C",001,0})
AADD(aCampos,{"MOTIVOBX"  ,"C",001,0})
AADD(aCampos,{"CODPRODDIF","C",005,0})
AADD(aCampos,{"RAZAOSOCI" ,"C",050,0})
AADD(aCampos,{"CONSOLPER" ,"C",001,0})
AADD(aCampos,{"NUMHABILIT","C",012,0})
AADD(aCampos,{"MUNICIPIO" ,"C",005,0})

cTRB := CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTRB,"T01",.T.,.F.)
IndRegua("T01",cTRB,"CODPRODDIF")
aCampos := {}

// T02 - Entradas
AADD(aCampos,{"ANODMD"    ,"C",004,0})
AADD(aCampos,{"MESDMD"    ,"C",002,0})
AADD(aCampos,{"IEDMD"     ,"C",009,0})
AADD(aCampos,{"CODPRODDIF","C",005,0})
AADD(aCampos,{"MUNICIPIO" ,"C",005,0})
AADD(aCampos,{"QTDPROINS" ,"N",010,0})
AADD(aCampos,{"VLCOMINSC" ,"N",012,2})
AADD(aCampos,{"QTDPRONINS","N",010,0})
AADD(aCampos,{"VLCOMNINSC","N",012,2})

cTRB := CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTRB,"T02",.T.,.F.)
IndRegua("T02",cTRB,"CODPRODDIF+MUNICIPIO")
aCampos := {}

// T03 - Saํdas
AADD(aCampos,{"ANODMD"    ,"C",004,0})
AADD(aCampos,{"MESDMD"    ,"C",002,0})
AADD(aCampos,{"IEDMD"     ,"C",009,0})
AADD(aCampos,{"CODPRODDIF","C",005,0})
AADD(aCampos,{"MUNICIPIO" ,"C",005,0})
AADD(aCampos,{"QTDPROINS" ,"N",010,0})
AADD(aCampos,{"VLCOMINSC" ,"N",012,2})
AADD(aCampos,{"QTDPRONINS","N",010,0})
AADD(aCampos,{"VLCOMNINSC","N",012,2})

cTRB := CriaTrab(aCampos)
dbUseArea(.T.,__LocalDriver,cTRB,"T03",.T.,.F.)
IndRegua("T03",cTRB,"CODPRODDIF+MUNICIPIO")
aCampos := {}

Return
//-------------------------------------------------------------------
/*/{Protheus.doc} DescPontual(dDataIni,dDataFim, cCodLancto)
Busca valor de dedu็ใo do imposto apurado; incentivo เ pontuilidade
do recolhimento de tributos. Informado manualmente na apura็ใo do ICMS

@param dDataIni   -> Data inicial do perํodo de apura็ใo
@param dDataFim   -> Data final do perํodo de apura็ใo
@param cCodLancto -> C๓digo de lan็amento informado no parโmetro

@owner	SIGAFIS - Livros Fiscais

@author Vogas J๚nior
@since 05/07/2018
@version 12.1.17
/*/
//-------------------------------------------------------------------
Static Function DescPontual(cTipoImp, cNrLivro, cApuracao, cPeriod, dDataIni, dDataFim, cCodLancto)
	Local oQryTmp := nil as object
	Local cQuery := "" as character
	Local cAliasCDH := "" as character
	Local cRetSqlCDH := retSqlName("CDH") as character
	Local nDescpontualidade := 0 as numeric
	
	cQuery := " SELECT CDH_VALOR DESCPONTU "
	cQuery += " FROM " + cRetSqlCDH + " CDH "
	cQuery += " WHERE CDH.CDH_FILIAL = ? "
	cQuery += 	" AND CDH.CDH_TIPOIP = ? "
	cQuery += 	" AND CDH.CDH_TIPOPR = ? "
	cQuery += 	" AND CDH.CDH_PERIOD = ? "
	cQuery += 	" AND CDH.CDH_DTINI = ? "
	cQuery += 	" AND CDH.CDH_DTFIM = ? "
	cQuery += 	" AND CDH.CDH_LIVRO = ? "
	cQuery += 	" AND CDH.CDH_CODLAN = ? "
	cQuery += 	" AND CDH_SEQUEN = "
	cQuery += 					"( "
	cQuery += 						" SELECT MAX(CDH_SEQUEN) "
	cQuery += 						" FROM " + cRetSqlCDH + " CDH2 "
	cQuery += 						" WHERE CDH2.CDH_FILIAL = CDH.CDH_FILIAL "
	cQuery += 						" AND CDH2.CDH_TIPOIP = CDH.CDH_TIPOIP "
	cQuery += 						" AND CDH2.CDH_TIPOPR = CDH.CDH_TIPOPR "
	cQuery += 						" AND CDH2.CDH_DTINI = CDH.CDH_DTINI "
	cQuery += 						" AND CDH2.CDH_DTFIM = CDH.CDH_DTFIM "
	cQuery += 						" AND CDH2.CDH_LIVRO = CDH.CDH_LIVRO "
	cQuery += 						" AND CDH2.CDH_CODLAN = CDH.CDH_CODLAN "
	cQuery += 						" AND CDH2.D_E_L_E_T_ = ? "
	cQuery += 					" ) "
	cQuery += 	" AND CDH.D_E_L_E_T_ = ? "

	oQryTmp := fwExecStatement():new(changeQuery(cQuery))

	oQryTmp:setString(1, xFilial("CDH"))
	oQryTmp:setString(2, cTipoImp)
	oQryTmp:setString(3, cApuracao)
	oQryTmp:setString(4, cPeriod)
	oQryTmp:setDate(5, dDataIni)
	oQryTmp:setDate(6, dDataFim)
	oQryTmp:setString(7, cNrLivro)
	oQryTmp:setString(8, cCodLancto)
	oQryTmp:setString(9, " ")
	oQryTmp:setString(10, " ")

	cAliasCDH := oQryTmp:openAlias(getNextAlias())

	nDescpontualidade := (cAliasCDH)->DESCPONTU

	(cAliasCDH)->(dbCloseArea())

	oQryTmp:destroy()
	oQryTmp := nil

Return nDescpontualidade

//-----------------------------------------------------------------------
/*/{Protheus.doc}  GrvLinR10
Grava registros na tabela R10
@param		aLinha		Array de 4 posi็๕es sendo TIPO+LINHA+COLUNA+VALOR
@param		lPlus		Soma a quarta posi็ใo do array (CAMPO VALOR)
@param		lInclui		Inclui novo registro
@return
@author Thiago Yoshiaki Miyabara Nascimento - Shiny
@since 16/10/2019
@version 1.0
/*/
//-----------------------------------------------------------------------
Static Function GrvLinR10(aLinha, lPlus, lInclui)

Local aArea		:= GetArea()
Local nTamLin	:= Len(aLinha)
Local nI		:= 0
Default lPlus	:= .T.
Default lInclui	:= .F.

	For nI := 1 To nTamLin
		If lInclui .Or. !R10->(MsSeek(aLinha[nI][1]+aLinha[nI][2]+aLinha[nI][3]))
			RecLock("R10",.T.)
			R10->TIPO		:=aLinha[nI][1]
			R10->LINHA		:=aLinha[nI][2]
			R10->COLUNA		:=aLinha[nI][3]
		Else
			RecLock("R10",.F.)
		Endif
		If lPlus
			R10->VALOR			+=	aLinha[nI][4]
		Else
			R10->VALOR			-=	aLinha[nI][4]
		EndIf
		R10->(MsUnLock())
	Next (nI)

RestArea(aArea)

Return

//------------------------------------------------------------------
/*/{Protheus.doc} DescComp

Busca descri็ใo complementar para nota. (primeiro busca CDT, segundo SC5, terceiro F4_CODOBSE)

@Return ( Nil )

@author Matheus Massarotto
@since  28/04/2020
@version 12

/*/
//-------------------------------------------------------------------
Static Function DescComp(cTpMov,cDoc,cSerie,cCliente,cLoja,cTes)
Local cChvCDT 	:= ""
Local cObs		:= ""
Local aAreaCDT	:= CDT->(GetArea())
Local aAreaSF4	:= SF4->(GetArea())
Local aAreaCCE	:= CCE->(GetArea())

CDT->(DbSetOrder(1))
SF4->(DbSetOrder(1))
CCE->(DbSetOrder(1))

cChvCDT:=xFilial("CDT")+cTpMov+cDoc+cSerie+cCliente+cLoja

//CDT_FILIAL, CDT_TPMOV, CDT_DOC, CDT_SERIE, CDT_CLIFOR, CDT_LOJA, CDT_IFCOMP
if CDT->(MsSeek(cChvCDT)) .and. empty(cObs)
	While CDT->(!EOF()) .and. cChvCDT == CDT->CDT_FILIAL+CDT->CDT_TPMOV+CDT->CDT_DOC+CDT->CDT_SERIE+CDT->CDT_CLIFOR+CDT->CDT_LOJA
		if !empty(CDT->CDT_DCCOMP)
			cObs+=alltrim(CDT->CDT_DCCOMP)+" "
		endif
		CDT->(DbSkip())
	Enddo
elseif empty(cObs) .and. SF4->(MsSeek(xFilial("SF4")+cTes))
	if !empty(SF4->F4_CODOBSE) .and. CCE->(MsSeek(xFilial("CCE")+SF4->F4_CODOBSE))
		cObs:=alltrim(CCE->CCE_DESCR)
	endif
endif

RestArea(aAreaCDT)
RestArea(aAreaSF4)
RestArea(aAreaCCE)

Return(cObs)


/*

ฑฑบPrograma  ณMPER_IIBB บAutor  ณMercado Internacional  บ Data  ณ 22/10/04บฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION MPER_IIBB(cIB,cProv,lSiapIB,cTipo,cSubcon,cSuc,nOpc)

	P_IIBB(cIB,cProv,lSiapIB,cTipo,cSubcon,cSuc,nOpc)

Return 

/*

ฑฑบPrograma  ณPERC_IBBA  บAutor  ณMercado Internacional  บ Data ณ  22/10/04บฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION PERC_IBBA(cIB,cProv,lSiapIB,cTipo,cSuc,cArqTrab,aRel)

	P_IBBA(cIB,cProv,lSiapIB,cTipo,cSuc,cArqTrab,aRel)

Return 

/*

ฑฑบPrograma  ณDEL_IBBA  บAutor  ณMercado Internacional  บ Data ณ  22/10/04บฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
Function DEL_IBBA(aDelArqs)

	D_IBBA(aDelArqs)

Return 

/*

ฑฑบPrograma  ณMRET_IIBB  บAutor  ณMercado Internacional  บ Data ณ  22/10/04บฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION MRET_IIBB(cIB,cProv,lSiapIB,cTipo,cSubcon,cSuc,nOpc)

	R_IIBB(cIB,cProv,lSiapIB,cTipo,cSubcon,cSuc,nOpc)

Return 

/*

ฑฑบPrograma  ณRET_IBBA  บAutor  ณMercado Internacional  บ Data ณ  22/10/04บฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
*/
FUNCTION RET_IBBA(cImp,cProv,lSiapIB,cTipo,cSubcon,cSuc,cArqTrab,aRel)

	R_IBBA(cImp,cProv,lSiapIB,cTipo,cSubcon,cSuc,cArqTrab,aRel)

Return 


/*/{Protheus.doc} SelNFRio

Seleciona as Notas Fiscais de Servi็o pela Data de Emissใo (F3_EMISSAO) ou
pela Data da Baixa do Tํtulo (E5_DATA)

@param   dDtIni   Data Incํo perํodo
      dDtFim   Data Final perํodo
      cSel    Nใo usado
      cTipo    T-Servi็o Tomado ou P-Prestado
      lFinanc Indica que deve fazer ou nao o join com o financeiro quando a sele็ใo for E
      cWhereComp Where complementar retornado do arquivo .ini para utilizar os filtros dos parametros
      cCpoSel   Campos a serem acrescentados ao SELECT
      cProcessa  B=Baixa; E=Emissใo; " "=Ambos

@return Return .T.

@author Jose Ricardo Bernardo
@since   10/02/2021

/*/
//-------------------------------------------------------------------
Function SelNFRio(dDtIni,dDtFim,cSel,cTipo,lFinanc,cWhereComp,cCpoSel,cProcessa)

Local cAliasRet := "SF3"
Local cAliasFin := ""
Local cAliasTmp := "TMP"
Local cAliasSF1 := "SF1TMP"
Local cSelect   := "% SF3.F3_FILIAL,SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_ENTRADA,SF3.F3_EMISSAO,SF3.F3_TIPO,SF3.F3_ISSST,SF3.F3_ISSSUB,SF3.F3_ISSMAT,SF3.F3_DTCANC,SF3.F3_ISENICM,SF3.F3_OUTRICM,SF3.F3_VALCONT,SF3.F3_VALICM,SF3.F3_ALIQICM,SF3.F3_RECISS,SF3.F3_CODISS,SF3.F3_CFO,SF3.F3_ESPECIE,SF3.F3_ESPECIE
Local cFrom     := "%"
Local cWhere    := "%"
Local aStru_SF3

Local nPosicao  := 0

Default cSel 		:= ""
Default cCpoSel 	:= ""
Default cProcessa 	:= ""

DBSelectArea("SF3")
aStru_SF3 := SF3->(dbStruct())
SF3->(DBCloseArea())

//-------------------
//Cria็ใo do objeto e tabela temporaria que sera lida pelo arquivo .ini
//-------------------
oTempTable:=FWTemporaryTable():New( cAliasRet )
oTemptable:SetFields( aStru_SF3 )
oTempTable:AddIndex("indice1", {"F3_FILIAL","F3_ENTRADA","F3_NFISCAL","F3_SERIE","F3_CLIEFOR","F3_LOJA"} )
oTempTable:Create()

If  Empty(cProcessa) .or. cProcessa == "B" 
    DBUseArea( .T., 'TOPCONN', RetSQLName("SF3"), cAliasTmp )
    IndRegua( cAliasTmp, GetNextAlias(), "F3_FILIAL+F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA",,"F3_FILIAL=='"+xFilial("SF3")+"'")

    DBUseArea( .T., 'TOPCONN', RetSQLName("SF1"), cAliasSF1 )
    IndRegua( cAliasSF1, GetNextAlias(), "F1_FILIAL+F1_DOC+F1_PREFIXO+F1_FORNECE+F1_LOJA+F1_TIPO",,"F1_FILIAL=='"+xFilial("SF1")+"'")

    cAliasFin := ISSFiscal(dDtIni, dDtFim,,,,"P") //---Componente do Financeiro que retorna reten็๕es---//
    (cAliasFin)->(DbGoTop())

    dbSelectArea(cAliasSF1)
    dbSelectArea(cAliasTmp)
    dbSelectArea(cAliasRet)
    While (cAliasFin)->(!Eof())
		// Posiciona na tabela SF1 utilizando o Prefixo do Titulo para suprir parametro MV_2DUPREF que quando utilizado ้ diferente da Serie da Nota Fiscal
		If (cAliasSF1)->( dbSeek( xFilial("SF1")+(cAliasFin)->NUMERO+(cAliasFin)->PREFIXO+(cAliasFin)->CLIFOR + (cAliasFin)->LOJA+(cAliasFin)->TIPO) )
			If ( cAliasTmp )->( dbSeek( xFilial("SF3") + (cAliasSF1)->F1_SERIE + (cAliasFin)->NUMERO + (cAliasFin)->CLIFOR + (cAliasFin)->LOJA ) )
				// Gera registros na tabela temporaria de retorno para as NFs de servi็os que tiveram reten็๕es de ISS baixadas no perํodo
				If !( cAliasRet )->( dbSeek( xFilial("SF3") + DTOS((cAliasTmp)->F3_ENTRADA) + (cAliasTmp)->F3_NFISCAL + (cAliasTmp)->F3_SERIE + (cAliasTmp)->F3_CLIEFOR + (cAliasTmp)->F3_LOJA ) )
					RecLock( cAliasRet , .T. )
					for nPosicao := 1 to len( aStru_SF3)
						&(cAliasRet+"->"+aStru_SF3[nPosicao,1]) := &(cAliasTmp+"->"+aStru_SF3[nPosicao,1])
					next
					(cAliasRet)->(MsUnLock())
				Endif
			Endif
		Endif
		(cAliasFin)->(dbSkip())
	EndDo
	(cAliasFin)->(dbCloseArea())
	(cAliasTmp)->(dbCloseArea())
	(cAliasSF1)->(dbCloseArea())
Endif

If  Empty(cProcessa) .or. cProcessa == "E" 
    cSelect +=  cCpoSel
    cFrom   +=  RetSqlName("SF3")+" SF3 "
    cWhere  +=  cWhereComp + " AND "
    cWhere  +=  "SF3.F3_RECISS = '1' AND "
    cWhere  +=  "SF3.D_E_L_E_T_ = '' "

    cSelect +=  "%"
    cFrom   +=  "%"
    cWhere  +=  "%"

    BeginSql Alias cAliasTmp

        SELECT %Exp:cSelect%
        FROM   %Exp:cFrom%
        WHERE  %Exp:cWhere%
        ORDER BY SF3.F3_FILIAL,SF3.F3_ENTRADA,SF3.F3_NFISCAL,SF3.F3_SERIE,SF3.F3_CLIEFOR,SF3.F3_LOJA,SF3.F3_CFO,SF3.F3_ALIQICM

    EndSql

    dbSelectArea(cAliasRet)
    While !(cAliasTmp)->(eof())

        If !(cAliasRet)->( dbSeek( xFilial("SF3") + (cAliasTmp)->F3_ENTRADA + (cAliasTmp)->F3_NFISCAL + (cAliasTmp)->F3_SERIE + (cAliasTmp)->F3_CLIEFOR + (cAliasTmp)->F3_LOJA ) )

            RecLock( cAliasRet , .T. )
            (cAliasRet)->F3_FILIAL  := (cAliasTmp)->F3_FILIAL
            (cAliasRet)->F3_NFISCAL := (cAliasTmp)->F3_NFISCAL
            (cAliasRet)->F3_SERIE   := (cAliasTmp)->F3_SERIE
            (cAliasRet)->F3_CLIEFOR := (cAliasTmp)->F3_CLIEFOR
            (cAliasRet)->F3_LOJA    := (cAliasTmp)->F3_LOJA
            (cAliasRet)->F3_ENTRADA := STOD( (cAliasTmp)->F3_ENTRADA )
            (cAliasRet)->F3_EMISSAO := STOD( (cAliasTmp)->F3_EMISSAO )
            (cAliasRet)->F3_TIPO    := (cAliasTmp)->F3_TIPO
            (cAliasRet)->F3_ISSST   := (cAliasTmp)->F3_ISSST
            (cAliasRet)->F3_ISSSUB  := (cAliasTmp)->F3_ISSSUB
            (cAliasRet)->F3_ISSMAT  := (cAliasTmp)->F3_ISSMAT
            (cAliasRet)->F3_DTCANC  := STOD((cAliasTmp)->F3_DTCANC)
            (cAliasRet)->F3_ISENICM := (cAliasTmp)->F3_ISENICM
            (cAliasRet)->F3_OUTRICM := (cAliasTmp)->F3_OUTRICM
            (cAliasRet)->F3_VALCONT := (cAliasTmp)->F3_VALCONT
            (cAliasRet)->F3_VALICM  := (cAliasTmp)->F3_VALICM
            (cAliasRet)->F3_ALIQICM := (cAliasTmp)->F3_ALIQICM
            (cAliasRet)->F3_RECISS  := (cAliasTmp)->F3_RECISS
            (cAliasRet)->F3_CODISS  := (cAliasTmp)->F3_CODISS
            (cAliasRet)->F3_CFO     := (cAliasTmp)->F3_CFO
            (cAliasRet)->F3_ESPECIE := (cAliasTmp)->F3_ESPECIE
            (cAliasRet)->(MsUnLock())
        Endif

        (cAliasTmp)->(dbSkip())

    Enddo
    (cAliasTmp)->(dbCloseArea())

Endif

dbSelectArea( cAliasRet )
(cAliasRet)->(dbGoTop())

Return .T.

/*/{Protheus.doc} CLASS Md5IcmsDados
   
    Classe para ajudar no processamento dos inis ca79.ini conv128.ini conv115.ini

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
/*/
CLASS Md5IcmsDados
	Data oCashSX3 		as object 	READONLY
	Data oCashMvSX3		as object 	READONLY
	Data oCashSX6 		as object 	READONLY
	Data oCashFil 		as object 	READONLY
	Data oQryPri 		as object 	READONLY
	Data aMvParam		as array 	READONLY
	Data nTamMvParam	as integer 	READONLY
	Data cEspecie01		as string	READONLY
	
	Method new() CONSTRUCTOR
	Method getCashSX3()
	Method getCashMvSX3()
	Method getCashFil()
	Method getCashSX6()
	Method qryPriMatxMag()
	Method loadSX3MatxMag()
	Method loadMvSX3MatxMag()
	Method loadSX6MatxMag()	
	Method loadFilMatxMag()
	Method convModxEsp()
	Method parseMVSer79()
	Method getCmpFieldPos()
	Method destroy()
ENDCLASS

/*/{Protheus.doc} Md5IcmsDados:New
   
    M้todo de instโncia do objeto

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
/*/
Method New() Class Md5IcmsDados
	Self:aMvParam  	  := {}
	Self:nTamMvParam  := 0
	Self:oQryPri  	  := Nil
	Self:cEspecie01	  := ""
	Self:oCashSX6 	  := Self:loadSX6MatxMag()
	Self:oCashFil 	  := Self:loadFilMatxMag()
	Self:oCashSX3	  := Self:loadSX3MatxMag()
	Self:oCashMvSX3	  := Self:loadMvSX3MatxMag(&(Self:oCashSX6["MV_D5ICMS"]), &(Self:oCashSX6["MV_ENDCOB"]))	
Return

/*/{Protheus.doc} Md5IcmsDados:getCashMvSX3
   
    M้todo retornar o cash dos campos SX3 existentes na base com base nos parโmetros MV_D5ICMS e MV_ENDCOB

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return Self:oCashMvSX3, json, retorna o json com o cash dos campos SX3 existentes na base
/*/
Method getCashMvSX3() Class Md5IcmsDados
	If !(Self:oCashMvSX3:hasProperty("CFILANT")) .Or. Self:oCashMvSX3["CFILANT"] != cFilAnt
		Self:oCashMvSX3 := Self:loadMvSX3MatxMag(&(Self:oCashSX6["MV_D5ICMS"]), &(Self:oCashSX6["MV_ENDCOB"]))
	EndIf
Return Self:oCashMvSX3

/*/{Protheus.doc} Md5IcmsDados:loadMvSX3MatxMag
   
    M้todo para valiar os campos SX3 existentes na base com base nos parโmetros MV_D5ICMS e MV_ENDCOB

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return oCashSX3, json, retorna o json com o cash dos campos SX3 existentes na base
/*/
Method loadMvSX3MatxMag(aMvD5ICMS, aEndCob) Class Md5IcmsDados
	Local oCashMvSX3   := JsonObject():New()
	Local nTamMvD5ICMS := 0
	Local nTamEndCob   := 0
	Local lExistCAT79  := .F.
	Local lEndCob79    := .F.
	Local nX		   := 0

	If ValType(aMvD5ICMS) == "A"
		nTamMvD5ICMS := len(aMvD5ICMS)
		lExistCAT79  := nTamMvD5ICMS > 0
	EndIf

	If ValType(aEndCob) == "A"
		nTamEndCob  := len(aEndCob)
		lEndCob79 	:= nTamEndCob > 0
	EndIf

	If lEndCob79 .And. nTamEndCob >= 5
		aAdd(Self:aMvParam, { "MV_A1_END"	 , "SA1", aEndCob[1]})
		aAdd(Self:aMvParam, { "MV_A1_CEP"	 , "SA1", aEndCob[2]})
		aAdd(Self:aMvParam, { "MV_A1_BAIRRO" , "SA1", aEndCob[3]})
		aAdd(Self:aMvParam, { "MV_A1_MUNIC"	 , "SA1", aEndCob[4]})
		aAdd(Self:aMvParam, { "MV_A1_UF"	 , "SA1", aEndCob[5]})
	EndIf

	If lExistCAT79
		aAdd(Self:aMvParam, { "MV_A1_PASS", "SA1", aMvD5ICMS[1]})

		If nTamMvD5ICMS >= 2
			aAdd(Self:aMvParam, { "MV_A1_UTI", "SA1", aMvD5ICMS[2]})
		EndIf
		If nTamMvD5ICMS >= 3
			aAdd(Self:aMvParam, { "MV_A1_TEN", "SA1", aMvD5ICMS[3]})
		EndIf
		If nTamMvD5ICMS >= 4
			aAdd(Self:aMvParam, { "MV_A1_NUMTC", "SA1", aMvD5ICMS[4]})
		EndIf
		If nTamMvD5ICMS >= 5
			aAdd(Self:aMvParam, { "MV_B5_CLIT", "SB5", aMvD5ICMS[5]})
		EndIf
		If nTamMvD5ICMS >= 6
			aAdd(Self:aMvParam, { "MV_A1_TPCLI", "SA1", aMvD5ICMS[6]})
		EndIf
		If nTamMvD5ICMS >= 7
			aAdd(Self:aMvParam, { "MV_A1_NUMTM", "SA1", aMvD5ICMS[7]})
		EndIf
		If nTamMvD5ICMS >= 8
			aAdd(Self:aMvParam, { "MV_A1_CONTR", "SA1", aMvD5ICMS[8]})
		EndIf
		If nTamMvD5ICMS >= 9
			aAdd(Self:aMvParam, { "MV_F4_ISENC", "SF4", aMvD5ICMS[9]})
		EndIf
	EndIf

	Self:nTamMvParam := len(Self:aMvParam)

	oCashMvSX3["CFILANT"] := cFilAnt  //Armazeno a filial para refazer o cash quando trocar

	For nX := 1 To Self:nTamMvParam
		oCashMvSX3[Self:aMvParam[nX,1]] := ((Self:aMvParam[nX,2])->(FieldPos(Self:aMvParam[nX,3]))) > 0
	Next nX
Return oCashMvSX3

/*/{Protheus.doc} Md5IcmsDados:getCashSX3
   
    M้todo para retornar o cash dos campos SX3 existentes na base

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return Self:oCashSX3, json, retorna o json com o cash dos campos SX3 existentes na base
/*/
Method getCashSX3()	Class Md5IcmsDados	
Return Self:oCashSX3

/*/{Protheus.doc} Md5IcmsDados:loadSX3MatxMag
   
    M้todo para validar os campos SX3 existentes na base

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return oCashSX3, json, retorna o json com o cash dos campos SX3 existentes na base
/*/
Method loadSX3MatxMag() Class Md5IcmsDados
	Local oCashSX3 	:= JsonObject():New()
	Local aParam 	:= {}
	Local nX 		:= 0
	Local nTamParam := 0

	aParam := {							  ;
				{ "SFU" , "FU_SUBCLC"	},;
				{ "SFU" , "FU_AREATER"	},;
				{ "SFU" , "FU_TERMINA"	},;
				{ "SFU" , "FU_DTANT"	},;
				{ "SFU"	, "FU_TIPLIGA"	},;
				{ "SFX"	, "FX_TIPSERV"	} ;
			  }

	nTamParam := Len(aParam)

	For nX := 1 To nTamParam
		oCashSX3[aParam[nX,2]] := ((aParam[nX,1])->(FieldPos(aParam[nX,2]))) > 0
	Next nX
	aSize(aParam,0)
Return oCashSX3

/*/{Protheus.doc} Md5IcmsDados:getCashSX6
   
    M้todo para retornar o cash de parโmetros SX6

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return Self:oCashSX6, json, retorna o json com o cash dos parโmetros
/*/
Method getCashSX6()	Class Md5IcmsDados
	If !(Self:oCashSX6:hasProperty("CFILANT")) .Or. Self:oCashSX6["CFILANT"] != cFilAnt
		Self:oCashSX6 := Self:loadSX6MatxMag()
	EndIf
Return Self:oCashSX6

/*/{Protheus.doc} Md5IcmsDados:loadSX6MatxMag
   
    M้todo para validar os parโmetros SX6 existentes na base e pegar o seu conte๚do

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return oCashSX6, json, retorna o json com o cash dos parโmetros
/*/
Method loadSX6MatxMag() Class Md5IcmsDados
	Local oCashSX6  := JsonObject():New()		
	Local aParam := {									  ;
						{"MV_D5ICMS"	, "{}"			},; 
						{"MV_MD579" 	, "F3_CAT79"	},;
						{"MV_SER79" 	, ""			},;
						{"MV_SIMPLES" 	, ""			},;
						{"MV_ENDCOB" 	, "{}"			},;
						{"MV_ESTADO" 	, ""			},;
						{"MV_CANCFOR" 	, .F.			},;
						{"MV_ESPNFX5" 	, .F.			},;
						{"MV_DSSERIE" 	, ""			},;
						{"MV_SERCAT" 	, .T.			},;
						{"MV_ALIQSIM" 	, "00,00"		} ;
					}
	Local nX 		:= 0
	Local nTamParam := Len(aParam)

	oCashSX6["CFILANT"] := cFilAnt //Armazeno a filial para refazer o cash quando trocar
	For nX := 1 To nTamParam
		oCashSX6[aParam[nX,1]] := GetNewPar(aParam[nX,1], aParam[nX,2])
	Next nX
	aSize(aParam,0)
Return oCashSX6

/*/{Protheus.doc} Md5IcmsDados:getCashFil
   
    M้todo retornar o cash de filiais oCashFil

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return Self:oCashFil, json, retorna o json com o cash de filiais oCashFil["SF3"] = xFilial("SF3")
/*/
Method getCashFil() Class Md5IcmsDados
	If !(Self:oCashFil:hasProperty("CFILANT")) .Or. Self:oCashFil["CFILANT"] != cFilAnt
		Self:oCashFil := Self:loadFilMatxMag()
	EndIf
Return Self:oCashFil

/*/{Protheus.doc} Md5IcmsDados:loadFilMatxMag
   
    M้todo para processar o cash de filiais

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return oCashFil, json, retorna um json com o cash de filiais oCashFil["SF3"] = xFilial("SF3")
/*/
Method loadFilMatxMag() Class Md5IcmsDados
	Local oCashFil  := JsonObject():New()
	Local aParam 	:= {"SF3", "SFT", "SB1", "SB5", "SD2", "SA1", "SF4", "SFU", "SFX", "SF2"}
	Local nX 		:= 0
	Local nTamParam := Len(aParam)
	
	oCashFil["CFILANT"] := cFilAnt
	For nX := 1 To nTamParam
		oCashFil[aParam[nX]] := xFilial(aParam[nX])
	Next nX
	aSize(aParam,0)
Return oCashFil

/*/{Protheus.doc} Md5IcmsDados:qryPriMatxMag
   
    M้todo para fazer a query principal do D5Proc e abrir o alias

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
	@param lOraclePostGre, logical, valida se o banco ้ Oracle ou Postegres
	@param nTamFTNFiscal, integer, tamanho do campo FT_NFISCAL = TamSx3("FT_NFISCAL")[1]
    @param dDataDe, date, data inicial
    @param dDataAte, date, data final
    @param cModelos, string, modelos da nota
	@param lExistCAT79, logical, variแvel para validar se o parโmetro existe = IIF(ValType(aMvD5ICMS)=="A".And.Len(aMvD5ICMS)>0,.T.,.F.)
    @return cAlias, string, retorna o alias aberta da query
/*/
Method qryPriMatxMag(lOraclePostGre, nTamFTNFiscal, dDataDe, dDataAte, cModelos, lExistCAT79) Class Md5IcmsDados
	Local cQryPri := ""
	Local cAlias  := ""
	Local cTamDC  := alltrim(str(nTamFTNFiscal))
	Local cIni	  := "REPLICATE('0', " + cTamDC + " - LEN(FT_NFISCAL)) + FT_NFISCAL   "

	If lOraclePostGre
		cIni := " LPAD(TRIM(FT_NFISCAL)," + cTamDC + ",'0')   "
	EndIf

	If Self:oQryPri == Nil
		cQryPri	:= " SELECT ? FT_FISCAL, "
		cQryPri	+= 	" FT_ESPECIE, FT_TIPOMOV, FT_NFISCAL, FT_SERIE, FT_CLIEFOR, FT_LOJA, FT_PRODUTO, FT_ITEM, FT_CFOP, FT_TIPO, FT_OBSERV, "
		cQryPri	+= 	" FT_NFORI, FT_SERORI, FT_FORMUL, "
		cQryPri	+= 	" FT_EMISSAO, FT_ENTRADA, FT_DTCANC, "
		cQryPri	+= 	" FT_TOTAL, FT_QUANT, FT_VALCONT, FT_DESCONT, FT_DESPESA, "
		cQryPri	+= 	" FT_BASEICM, FT_ALIQICM, FT_VALICM, FT_ISENICM, FT_OUTRICM, "
		cQryPri	+= 	" FT_ALIQPIS, FT_VALPIS, FT_ALIQCOF, FT_VALCOF, "
		cQryPri	+= 	" B1_COD, B1_DESC, B1_UM, "
		cQryPri	+= 	" A1_COD, A1_LOJA, A1_NOME, A1_CGC, A1_INSCR, A1_PESSOA, A1_EST, A1_END, A1_CEP, A1_BAIRRO, A1_COD_MUN, A1_MUN, A1_COMPLEM, A1_DDD, A1_TEL, "
		cQryPri	+= 	" F4_DUPLIC, F4_CODIGO, F4_INCSOL, F4_SITTRIB, "
		cQryPri	+= 	" FU_FILIAL, FU_TIPOMOV, FU_SERIE,	FU_DOC, FU_CLIFOR, FU_LOJA, FU_ITEM, FU_COD, "
		cQryPri	+= 	" FU_GRPCLAS, FU_CLASSIF, FU_DTLEIT, "
		cQryPri	+= 	" FX_FILIAL, FX_TIPOMOV, FX_SERIE, FX_DOC, FX_CLIFOR, FX_LOJA, FX_ITEM, FX_COD, "
		cQryPri	+= 	" FX_GRPCLAS, FX_CLASSIF, FX_DTINI, FX_DTFIM "
		cQryPri	+= 	" ? "
		cQryPri	+= " FROM " + RetSqlName("SFT") + " SFT "
		cQryPri	+= " LEFT JOIN " + RetSqlName("SB1") + " SB1 "
		cQryPri	+= 		" ON SB1.B1_FILIAL = ? AND SB1.B1_COD=SFT.FT_PRODUTO AND SB1.D_E_L_E_T_= ? "
		cQryPri	+= " LEFT JOIN " + RetSqlName("SA1") + " SA1 "
		cQryPri	+= 		" ON SA1.A1_FILIAL = ? AND SA1.A1_COD=SFT.FT_CLIEFOR AND SA1.A1_LOJA = SFT.FT_LOJA AND SA1.D_E_L_E_T_ = ? "
		cQryPri	+= " LEFT JOIN " + RetSqlName("SF4") + " SF4 "
		cQryPri	+= 		" ON SF4.F4_FILIAL= ? AND SF4.F4_CODIGO=SFT.FT_TES AND SF4.D_E_L_E_T_ = ? "
		cQryPri	+= " LEFT JOIN " + RetSqlName("SFU") + " SFU "
		cQryPri	+= 		" ON SFU.FU_FILIAL = ? AND SFU.FU_TIPOMOV=SFT.FT_TIPOMOV AND SFU.FU_SERIE=SFT.FT_SERIE "
		cQryPri	+= 		" AND SFU.FU_DOC=SFT.FT_NFISCAL AND SFU.FU_CLIFOR=SFT.FT_CLIEFOR AND SFU.FU_LOJA=SFT.FT_LOJA AND SFU.FU_ITEM=SFT.FT_ITEM "
		cQryPri	+= 		" AND SFU.FU_COD=SFT.FT_PRODUTO " // Devem ser apresentados os registros deletados - DSERFIS1-32731
		cQryPri	+= " LEFT JOIN " + RetSqlName("SFX") + " SFX "
		cQryPri	+= 		" ON SFX.FX_FILIAL = ? AND SFX.FX_TIPOMOV=SFT.FT_TIPOMOV AND SFX.FX_SERIE=SFT.FT_SERIE "
		cQryPri	+= 		" AND SFX.FX_DOC=SFT.FT_NFISCAL AND SFX.FX_CLIFOR=SFT.FT_CLIEFOR AND SFX.FX_LOJA=SFT.FT_LOJA AND SFX.FX_ITEM=SFT.FT_ITEM "
		cQryPri	+= 		" AND SFX.FX_COD=SFT.FT_PRODUTO " // Devem ser apresentados os registros deletados - DSERFIS1-32731
		cQryPri	+= " LEFT JOIN " + RetSqlName("SB5") + " SB5 "
		cQryPri	+= 		" ON B5_FILIAL = ? AND SB5.B5_COD=SB1.B1_COD AND SB5.D_E_L_E_T_ = ? "
		cQryPri	+= " WHERE SFT.FT_FILIAL = ? "
		cQryPri	+= 	 " AND SFT.FT_TIPOMOV  = ? "
		cQryPri	+= 	 " AND SFT.FT_ENTRADA >= ? "
		cQryPri	+= 	 " AND SFT.FT_ENTRADA <= ? "
		cQryPri	+= 	 " AND SFT.FT_TIPO IN (?) "
		cQryPri	+=   " AND SFT.D_E_L_E_T_= ? "
		cQryPri	+= 	 " AND SFX.R_E_C_N_O_ = "
		cQryPri	+= 	 "     (SELECT MAX(SFX2.R_E_C_N_O_) "
		cQryPri	+= 	 "        FROM " + RetSqlName("SFX") + " SFX2 "
		cQryPri	+= 	 "       WHERE SFX2.FX_FILIAL = ? "
		cQryPri	+= 	 "         AND SFX2.FX_TIPOMOV = SFT.FT_TIPOMOV "
		cQryPri	+= 	 "         AND SFX2.FX_SERIE = SFT.FT_SERIE "
		cQryPri	+= 	 "         AND SFX2.FX_DOC = SFT.FT_NFISCAL "
		cQryPri	+= 	 "         AND SFX2.FX_CLIFOR = SFT.FT_CLIEFOR "
		cQryPri	+= 	 "         AND SFX2.FX_LOJA = SFT.FT_LOJA "
		cQryPri	+= 	 "         AND SFX2.FX_ITEM = SFT.FT_ITEM "
		cQryPri	+= 	 "         AND SFX2.FX_COD = SFT.FT_PRODUTO )"	
		cQryPri	+= 	 " AND ( 
		cQryPri	+= 		" SFT.FT_ESPECIE IN (?) "
		If lExistCAT79 .And. !empty(Self:oCashSX6["MV_SER79"])
			cQryPri	+= " OR ( SFT.FT_ESPECIE = ? AND SFT.FT_SERIE IN (?) ) " // Tratamento para CAT79 com Modelo 01 e serie com base no parametro MV_SER79
		EndIf
		cQryPri	+= 		 " ) "		
		cQryPri	+= " ORDER BY FT_FISCAL, SFT.FT_FILIAL, SFT.FT_TIPOMOV, SFT.FT_SERIE, SFT.FT_NFISCAL, SFT.FT_CLIEFOR, SFT.FT_LOJA, SFT.FT_ITEM, SFT.FT_PRODUTO "
		
		Self:oQryPri := fwExecStatement():New(changeQuery(cQryPri))
	EndIf
	
	Self:oQryPri:setUnsafe(01, cIni)
	Self:oQryPri:setUnsafe(02, Self:getCmpFieldPos())	// Acrescenta na query campos adicionais conforme parametros
	Self:oQryPri:setString(03, Self:oCashFil["SB1"] )
	Self:oQryPri:setString(04, ' ' )	
	Self:oQryPri:setString(05, Self:oCashFil["SA1"] )
	Self:oQryPri:setString(06, ' ' )
	Self:oQryPri:setString(07, Self:oCashFil["SF4"] )
	Self:oQryPri:setString(08, ' ' )
	Self:oQryPri:setString(09, Self:oCashFil["SFU"] )
	Self:oQryPri:setString(10, Self:oCashFil["SFX"] )
	Self:oQryPri:setString(11, Self:oCashFil["SB5"] )
	Self:oQryPri:setString(12, ' ' )
	Self:oQryPri:setString(13, Self:oCashFil["SFT"])
	Self:oQryPri:setString(14, 'S' )
	Self:oQryPri:setDate(15, dDataDe )
	Self:oQryPri:setDate(16, dDataAte)
	Self:oQryPri:setIn(17,  {'N','C','P','I',' '} )
	Self:oQryPri:setString(18, ' ' )	
	Self:oQryPri:setString(19, Self:oCashFil["SFX"] )
	Self:oQryPri:setIn(20, Self:convModxEsp(dDataDe, dDataAte, cModelos, lExistCAT79 ) )

	If lExistCAT79 .And. !empty(Self:oCashSX6["MV_SER79"])
		Self:oQryPri:setString(21, Self:cEspecie01)
		Self:oQryPri:setIn(22, Self:parseMVSer79() )
	EndIf

	cAlias  := Self:oQryPri:OpenAlias(GetNextAlias())
	
	TcSetField(cAlias, "FT_EMISSAO", "D", 8, 0)
	TcSetField(cAlias, "FT_ENTRADA", "D", 8, 0)
	TcSetField(cAlias, "FT_DTCANC" , "D", 8, 0)
	TcSetField(cAlias, "FU_DTLEIT" , "D", 8, 0)
	TcSetField(cAlias, "FX_DTINI"  , "D", 8, 0)
	TcSetField(cAlias, "FX_DTFIM"  , "D", 8, 0)
	If Self:oCashSX3["FU_DTANT"]
		TcSetField(cAlias, "FU_DTANT"  , "D", 8, 0)
	EndIf
	
Return cAlias

/*/{Protheus.doc} Md5IcmsDados:parseMVSer79
   
    M้todo para converter o parโmetro MV_SER79 em uma string separada com ;

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return cConteudo, string, series separadas com ;
/*/
Method parseMVSer79() Class Md5IcmsDados
	Local cConteudo := Self:oCashSX6["MV_SER79"]
	Local aTemp := {}

	cConteudo := alltrim(strTran(cConteudo, ' ', ''))
	cConteudo := strTran(strTran(alltrim(cConteudo), '/', ','),';',',')  // Padroniza substituindo os caracteres ";" e "/"
	aTemp  	  := strTokArr(cConteudo, ',')

Return aTemp

/*/{Protheus.doc} Md5IcmsDados:ConvModxEsp
   
    M้todo para converter modelo de nota em esp้cie

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @param dPeridoIni, date, data inicial
    @param dPeriodoFim, date, data final
    @param cModelos, string, modelos da nota
	@param lExistCAT79, logical, variแvel para validar se o parโmetro existe = IIF(ValType(aMvD5ICMS)=="A".And.Len(aMvD5ICMS)>0,.T.,.F.)
    @return cRet, string, especies das notas
/*/
Method convModxEsp(dPeridoIni, dPeriodoFim, cModelos, lExistCAT79) Class Md5IcmsDados
	Local aEspecie := {}
	Local cAlias   := GetNextAlias()
	Local cModel   := ""
	Local cQuery   := ""
	Local cEspecie := ""
	Local oExec    := Nil

	cQuery := " SELECT SF3.F3_ESPECIE "
	cQuery += " FROM " + RetSqlName("SF3") + " SF3 "
	cQuery += " WHERE SF3.F3_FILIAL = ? AND  SF3.F3_ENTRADA BETWEEN ? AND ? AND SF3.D_E_L_E_T_ = ? "
	cQuery += " GROUP BY SF3.F3_ESPECIE "

	oExec := FwExecStatement():New(cQuery)

	oExec:setString(1, xFilial("SF3"))
	oExec:setDate(2, dPeridoIni)
	oExec:setDate(3, dPeriodoFim)
	oExec:setString(4, ' ' )

	cAlias := oExec:openAlias()

	Do While !(cAlias)->(eof())
		cModel := aModNot((cAlias)->F3_ESPECIE)

		cEspecie := alltrim((cAlias)->F3_ESPECIE)

		//Caso seja o modelo 01 e for CAT79 e tiver conteudo no parametro, devo pegar as series com base no parametro
		If cModel == "01" .And. lExistCAT79 .And. !empty(Self:oCashSX6["MV_SER79"])
			Self:cEspecie01 := cEspecie //Pego a Especie do modelo 01 e fa็o um Loop para chamar a proxima especie
			(cAlias)->(dbSkip())
			Loop
		EndIf

		If cModel $ cModelos
			aAdd(aEspecie, cEspecie)
		EndIf
	
		(cAlias)->(dbSkip())
	EndDo

	(cAlias)->(dbCloseArea())

	oExec:destroy()
	oExec := Nil

Return aEspecie

/*/{Protheus.doc} Md5IcmsDados:getCmpFieldPos
   
    M้todo para converter os campos que existem na base e os campos de parโmetros para query

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
    @return cCampos, string, variแvel com os campos
/*/
Method getCmpFieldPos() Class Md5IcmsDados
	Local cCampos := ""
	Local nX := 0

	If Self:oCashSX3["FU_SUBCLC"]
		cCampos += " , FU_SUBCLC "
	EndIf

	If Self:oCashSX3["FU_AREATER"]
		cCampos += " , FU_AREATER "
	EndIf

	If Self:oCashSX3["FU_TERMINA"]
		cCampos += " , FU_TERMINA "
	EndIf

	If Self:oCashSX3["FU_DTANT"]
		cCampos += " , FU_DTANT "
	EndIf

	If Self:oCashSX3["FU_TIPLIGA"]
		cCampos += " , FU_TIPLIGA "
	EndIf

	If Self:oCashSX3["FX_TIPSERV"]
		cCampos += " , FX_TIPSERV "
	EndIf

	For nX := 1 To Self:nTamMvParam //Acrescento os campos dos parametros
		If Self:oCashMvSX3[Self:aMvParam[nX][1]] //Verifico no Json construido se o campo do parโmetro Existe, se existir eu acrescento na query
			cCampos	+= " , " + Self:aMvParam[nX][3] //Acrescento na query o campo
		EndIf
	Next
Return cCampos

/*/{Protheus.doc} Md5IcmsDados:destroy
   
    M้todo para converter limpar as variแveis da classe

    @type  Method
    @author Matheus Bispo
    @since 04/07/2024
    @version 12.1.2310
/*/
Method destroy() Class Md5IcmsDados
	Self:oQryPri:destroy()
	freeObj(Self:oCashSX3)
	freeObj(Self:oCashMvSX3)
	freeObj(Self:oCashSX6)
	freeObj(Self:oCashFil)
	aSize(Self:aMvParam,0)	
	
	Self:oCashSX3 	:= Nil
	Self:oCashMvSX3 := Nil
	Self:oCashSX6 	:= Nil
	Self:oCashFil 	:= Nil
	Self:oQryPri 	:= Nil
	Self:nTamMvParam := 0
Return
