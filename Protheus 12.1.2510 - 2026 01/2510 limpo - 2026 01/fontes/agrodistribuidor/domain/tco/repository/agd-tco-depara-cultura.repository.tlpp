#include 'totvs.ch'
#include 'tlpp-core.th'
#include 'fwmvcdef.ch'

#define TABLE_ALIAS "NE2"

namespace agd.tcoDeParaCulturaRepository

using namespace agd.repositoryUtils
using namespace agd.tcoRepository

/*/{Protheus.doc} agdTCODeParaCulturaRepository
Repositorio do TCO de-para para culturas
@type class
@version 12
@author beatriz.dantas
@since 11/11/2025
/*/
class agdTCODeParaCulturaRepository from agdRepositoryUtils
	public data cChaveIDRepository as character

	public method new()
	public method getFields()         		as array
    public method save()               		as logical
    public method findDeParaByCultura()     as array
    public method registrarDePara() 		as logical
	public method getCulturaDescricao()		as character
	public method getLookupCulturas()		as array
	public method existeDeParaCultura()		as logical

	private method getNextItemNumber() 		as character
endclass

/*/{Protheus.doc} agdTCODeParaCulturaRepository::new
Constructor
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param pcChaveIDRepository, character, chave
@return object, instancia da classe
/*/
method new(pcChaveIDRepository as character) class agdTCODeParaCulturaRepository
	::cChaveIDRepository := pcChaveIDRepository
	_Super:New(TABLE_ALIAS, ::getFields())
return self

/*/{Protheus.doc} agdTCODeParaCulturaRepository::getFields
Retorna os campos do repositorio
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@return array, {{campoJson, campoProtheus, tipoCampo, lShowField}, ...}
/*/
method getFields() as array class agdTCODeParaCulturaRepository
	local aFields as array

	aFields := {;
		{'filial'  		, 'NE2_FILIAL', 'C', .f.},;
		{'codigo'  		, 'NE2_CODIGO', 'C', .f.},;
		{'tipo'    		, 'NE2_TIPO'  , 'C', .f.},;
		{'contexto'		, 'NE2_CONTEX', 'C', .f.},;
		{'item'    		, 'NE2_ITEM'  , 'C', .t.},;
		{'chave'   		, 'NE2_CHAVE' , 'C', .t.},;
		{'valor'   		, 'NE2_VALOR' , 'M', .t.}}
return aFields

/*/{Protheus.doc} agdTCOFeatureComplementosRepository::save
Registra um novo complemento da Feature
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param jComplemento, json, campos do complemento
@return logical, resultado do registro
/*/
method save(jComplemento as json) as logical class agdTCODeParaCulturaRepository
	local oModel  as object
	local lResult as logical

	oModel := FwLoadModel("AGDA100")
	oModel:SetOperation(MODEL_OPERATION_INSERT)
	if oModel:Activate()

		jComplemento['item'] := ::getNextItemNumber(jComplemento['codigo'], jComplemento['tipo'], jComplemento['contexto'])
		::setValueModel(oModel:GetModel("AGDA100_NE2"), ::jsonToArrayFields(jComplemento, ::getFields()))

		if oModel:VldData() .and. oModel:CommitData()
			::setSuccess("Registro incluído com sucesso.") //"Registro incluído com sucesso."
			lResult := .t.
		else
			::setErrorByErrorMessageModel(oModel, 404)
		endIf

		oModel:deActivate()
	endIf

	oModel:destroy()
	FWFreeObj(oModel)
return lResult

/*/{Protheus.doc} findDeParaByCultura
Busca registros de De-Para para cultura específica
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param cCodigoFeature, character, Código da feature
@param cCodigoCultura, character, Código da cultura (opcional)
@return array, Lista de registros
/*/
method findDeParaByCultura(cCodigoFeature as character, cCodigoChave as character) as array class agdTCODeParaCulturaRepository
    local cQuery    as character
    local cAlias    as character
    local aResult   as array
    local aBindQry  as array
    
    aBindQry := {}
    
    cQuery := "SELECT "
    cQuery += "    NE2.NE2_ITEM, "
    cQuery += "    NE2.NE2_CHAVE AS ID_INTERNO, "
    cQuery += "    NP3.NP3_DESCRI AS DESCRICAO, "
    cQuery += "    NE2.NE2_VALOR AS ID_EXTERNO "
    cQuery += "FROM " + RetSQLName("NE2") + " NE2 "
    cQuery += "LEFT JOIN " + RetSQLName("NP3") + " NP3 ON "
    cQuery += "    NP3.NP3_FILIAL = ? "         ; aAdd(aBindQry, FWxFilial("NP3"))
    cQuery += "    AND NP3.NP3_CODIGO = NE2.NE2_CHAVE "
    cQuery += "    AND NP3.D_E_L_E_T_ = ' ' "
    cQuery += "WHERE "
    cQuery += "    NE2.NE2_FILIAL = ? "         ; aAdd(aBindQry, FWxFilial("NE2"))
    cQuery += "    AND NE2.NE2_CODIGO = ? "     ; aAdd(aBindQry, cCodigoFeature)
    cQuery += "    AND NE2.NE2_TIPO = '2' "
    cQuery += "    AND NE2.NE2_CONTEX = 'CULTURA' "
    
    if !Empty(cCodigoChave)
        cQuery += "    AND NE2.NE2_CHAVE = ? " ; aAdd(aBindQry, cCodigoChave)
    endIf
    
    cQuery += "    AND NE2.D_E_L_E_T_ = ' ' "
    cQuery += "ORDER BY NE2.NE2_ITEM"
    
    cQuery := ChangeQuery(cQuery)
    cAlias := MPSysOpenQuery(cQuery,,,,aBindQry)
    
    aResult := {}
    
    While (cAlias)->(!EOF())
        aAdd(aResult, {;
            'item'       : AllTrim((cAlias)->NE2_ITEM),;
            'idInterno'  : AllTrim((cAlias)->ID_INTERNO),;
            'descricao'  : AllTrim((cAlias)->DESCRICAO),;
            'idExterno'  : AllTrim((cAlias)->ID_EXTERNO);
        })
        (cAlias)->(DbSkip())
    End
    
    (cAlias)->(DbCloseArea())
    
    if Len(aResult) > 0
        ::setSuccess(aResult)
    else
        ::setError("Nenhum registro encontrado", 404)
    endIf
    
return aResult

method registrarDePara(cEntidade, cIdInterno, cIdExterno) class agdTCODeParaCulturaRepository
    local lSuccess as logical
    local cMsgErro as character
    
    // Usa função padrão Protheus para registrar no De-Para
    lSuccess := CFGA070Mnt( cEntidade, cIdInterno, cIdExterno, .F.)
    
    if !lSuccess
        cMsgErro := "Erro ao registrar De-Para. "
        ::setError(cMsgErro, 500)
    endIf
    
return lSuccess

/*/{Protheus.doc} getCulturaDescricao
Retorna a descrição de uma cultura
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param cCodigoCultura, character, Código da cultura (NP3_CODIGO)
@return character, Descrição da cultura
/*/
method getCulturaDescricao(cCodigoCultura as character) as character class agdTCODeParaCulturaRepository
    local cDescricao as character
    local cQuery     as character
    local cAlias     as character
    local aBindQry   as array
    
    cDescricao := ""
    aBindQry   := {}
    
    if Empty(cCodigoCultura)
        return cDescricao
    endIf
    
    cQuery := "SELECT NP3_DESCRI "
    cQuery += "FROM " + RetSQLName("NP3") + " "
    cQuery += "WHERE "
    cQuery += "    NP3_FILIAL = ? "    ; aAdd(aBindQry, FWxFilial("NP3"))
    cQuery += "    AND NP3_CODIGO = ? "; aAdd(aBindQry, cCodigoCultura)
    cQuery += "    AND D_E_L_E_T_ = ' '"
    
    cQuery := ChangeQuery(cQuery)
    cAlias := MPSysOpenQuery(cQuery,,,,aBindQry)
    
    if (cAlias)->(!EOF())
        cDescricao := AllTrim((cAlias)->NP3_DESCRI)
    endIf
    
    (cAlias)->(DbCloseArea())
    
return cDescricao

/*/{Protheus.doc} getLookupCulturas
Retorna lista de culturas para lookup
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param cFiltro, character, Filtro para pesquisa (código ou descrição)
@param nPage, numeric, Página
@param nPageSize, numeric, Tamanho da página
@return array, Lista de culturas
/*/
method getLookupCulturas(cFiltro as character, nPage as numeric, nPageSize as numeric) as array class agdTCODeParaCulturaRepository
    local cQuery    as character
    local cAlias    as character
    local aResult   as array
    local nOffset   as integer
    local aBindQry  as array
    
    Default cFiltro   := ""
    Default nPage     := 1
    Default nPageSize := 20
    
    aBindQry := {}
    nOffset  := (nPage - 1) * nPageSize
    
    cQuery := "SELECT "
    cQuery += "    NP3_CODIGO, "
    cQuery += "    NP3_DESCRI "
    cQuery += "FROM " + RetSQLName("NP3") + " "
    cQuery += "WHERE "
    cQuery += "    NP3_FILIAL = ? "    ; aAdd(aBindQry, FWxFilial("NP3"))
    
    if !Empty(cFiltro)
        cQuery += "    AND ("
        cQuery += "        NP3_CODIGO LIKE ? " ; aAdd(aBindQry, "%" + cFiltro + "%")
        cQuery += "        OR NP3_DESCRI LIKE ? " ; aAdd(aBindQry, "%" + cFiltro + "%")
        cQuery += "    ) "
    endIf
    
    cQuery += "    AND D_E_L_E_T_ = ' ' "
    cQuery += "ORDER BY NP3_DESCRI "
    
    // Paginação (varia por banco de dados)
    if TCGetDB() $ "ORACLE"
        cQuery := "SELECT * FROM (" + cQuery + ") WHERE ROWNUM BETWEEN " + cValToChar(nOffset + 1) + " AND " + cValToChar(nOffset + nPageSize)
    elseIf TCGetDB() $ "MSSQL|POSTGRES"
        cQuery += "OFFSET " + cValToChar(nOffset) + " ROWS "
        cQuery += "FETCH NEXT " + cValToChar(nPageSize) + " ROWS ONLY"
    endIf
    
    cQuery := ChangeQuery(cQuery)
    cAlias := MPSysOpenQuery(cQuery,,,,aBindQry)
    
    aResult := {}
    
    While (cAlias)->(!EOF())
        aAdd(aResult, {;
            'codigo'    : AllTrim((cAlias)->NP3_CODIGO),;
            'descricao' : AllTrim((cAlias)->NP3_DESCRI);
        })
        (cAlias)->(DbSkip())
    End
    
    (cAlias)->(DbCloseArea())
    
return aResult

/*/{Protheus.doc} existeDeParaCultura
Verifica se já existe De-Para para uma cultura específica
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param cCodigoFeature, character, Código da feature
@param cCodigoCultura, character, Código da cultura
@return logical, .T. se existe, .F. se não existe
/*/
method existeDeParaCultura(cCodigoFeature as character, cCodigoCultura as character) as logical class agdTCODeParaCulturaRepository
    local cQuery   as character
    local cAlias   as character
    local lExiste  as logical
    local aBindQry as array
    
    aBindQry := {}
    
    cQuery := "SELECT COUNT(*) AS TOTAL "
    cQuery += "FROM " + RetSQLName("NE2") + " "
    cQuery += "WHERE "
    cQuery += "    NE2_FILIAL = ? "    ; aAdd(aBindQry, FWxFilial("NE2"))
    cQuery += "    AND NE2_CODIGO = ? "; aAdd(aBindQry, cCodigoFeature)
    cQuery += "    AND NE2_TIPO = '2' "
    cQuery += "    AND NE2_CONTEX = 'CULTURA' "
    cQuery += "    AND NE2_CHAVE = ? " ; aAdd(aBindQry, cCodigoCultura)
    cQuery += "    AND D_E_L_E_T_ = ' '"
    
    cQuery := ChangeQuery(cQuery)
    cAlias := MPSysOpenQuery(cQuery,,,,aBindQry)
    
    lExiste := (cAlias)->(!EOF()) .and. (cAlias)->TOTAL > 0
    
    (cAlias)->(DbCloseArea())
    
return lExiste

/*/{Protheus.doc} agdTCODeParaCulturaRepository::getNextItemNumber
Retorna o próximo codigo do item do complemento da Feature
@type method
@version 12
@author beatriz.dantas
@since 11/11/2025
@param cCodigo, character, codigo da Feature
@param cTipo, character, '1'=Interno;'2'=De-Para
@param cContexto, character, contexto
@return character, cNewiD
/*/
method getNextItemNumber(cCodigo as character, cTipo as character, cContexto as character) as character class agdTCODeParaCulturaRepository 
	local cDefaultItem as character
	local aBindQry     as array
	local cQuery       as character
	local cAlias       as character
	local cNextId      as character

	cDefaultItem := StrZero(0, FWSX3Util():GetFieldStruct("NE2_ITEM")[3/*nTamanho*/])
	aBindQry     := {}

	cQuery := "SELECT"
	cQuery += "	COALESCE(MAX(NE2_ITEM), '" + cDefaultItem + "') AS ITEM"
	cQuery += " FROM"
	cQuery += "	" + retSQLname("NE2")
	cQuery += " WHERE"
	cQuery += "	NE2_FILIAL = ?"     ; aAdd(aBindQry, FWxFilial("NE2"))
	cQuery += "	AND NE2_CODIGO = ?" ; aAdd(aBindQry, cCodigo         )
	cQuery += "	AND NE2_TIPO = ?"   ; aAdd(aBindQry, cTipo           )
	cQuery += "	AND NE2_CONTEX = ?" ; aAdd(aBindQry, cContexto       )
	cQuery += "	AND D_E_L_E_T_ = ' '"
	cQuery := ChangeQuery(cQuery)

	cAlias  := MPSysOpenQuery(cQuery,,,,aBindQry)

	cNextId := Soma1((cAlias)->ITEM)

	(cAlias)->(DBCloseArea())
return cNextId
