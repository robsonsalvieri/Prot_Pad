#Include 'totvs.ch'
#include "tlpp-core.th"

Namespace totvs.protheus.backoffice.stock.averagecost.tables

/*/{Protheus.doc} M330TRBStr
    Retorna a estrutura do arquivo de trabalho para o recalculo do custo médio

    Movida do fonte MATXFUNA.PRX
    @type  Function
    @author Ricardo Goncalves
    @since 07/08/02
    /*/
Function M330TRBStr(nOpc)
    Local aRet		:={}
    Local nSizeFil	:= FWSizeFilial()
    Local nTamanho	:= 0
    Local aTam		:= {}
    Local cIndRdmk  := ""

    Default nOpc := 1

    If nOpc == 1 //-- Campos
        //-- Atualiza o conteúdo da filial

        AADD(aRet,{ "TRB_FILIAL"	,"C",nSizeFil,0 } )
        AADD(aRet,{ "TRB_FILTRA"	,"C",nSizeFil,0 } )
        AADD(aRet,{ "TRB_ALIAS"	,"C",03,0 } )
        AADD(aRet,{ "TRB_RECNO"	,"N",12,0 } )
        AADD(aRet,{ "TRB_ORDEM"	,"C",03,0 } )

        nTamanho := SomaCampos("D3_OP+D1_FORNECE+D3_DOC+D2_SERIE+D3_NUMSEQ+D1_DTDIGIT+D3_CF+D3_NIVEL")
        If UsaPROXNUM()
            nTamanho := nTamanho + 25
            AADD(aRet,{ "TRB_INSDT","C",25,0 } )
        EndIf
        AADD(aRet,{ "TRB_CHAVE"	,"C",nTamanho,0 } )

        AADD(aRet,{ "TRB_NIVEL"	,"C",03,0 } )
        AADD(aRet,{ "TRB_NIVSD3"	,"C",01,0 } )
        aTam:= TamSX3("B1_COD")
        AADD(aRet,{ "TRB_COD"	,"C",aTam[1], 0 } )
        AADD(aRet,{ "TRB_DTBASE"	,"D",08,0 } )
        aTam:= TamSX3("D3_OP")
        AADD(aRet,{ "TRB_OP"		,"C",aTam[1],0 } )
        aTam:= TamSX3("D3_NUMSEQ")
        AADD(aRet,{ "TRB_CF"		,"C",03,0 } )
        AADD(aRet,{ "TRB_SEQ"	,"C",aTam[1],0 } )
        If UsaPROXNUM()
            AADD(aRet,{ "TRB_SEQPRO"	,"C",aTam[1] + 25 ,0 } )
        Else
            AADD(aRet,{ "TRB_SEQPRO"	,"C",aTam[1],0 } )
        EndIf
        AADD(aRet,{ "TRB_DTORIG"	,"D",08,0 } )
        AADD(aRet,{ "TRB_RECSD1"	,"N",12,0 } )
        AADD(aRet,{ "TRB_TES"	,"C",03,0 } )
        aTam:= TamSX3(MaiorCampo("D1_DOC;D2_DOC;D3_DOC"))
        AADD(aRet,{ "TRB_DOC"	,"C",aTam[1],0 } )
        aTam:= TamSX3(MaiorCampo("D1_SERIE;D2_SERIE"))
        AADD(aRet,{ "TRB_SERIE"	,"C",aTam[1],0 } )
        AADD(aRet,{ "TRB_TIPO"	,"C",01,0 } )
        aTam:= TamSX3("B2_LOCAL")
        AADD(aRet,{ "TRB_LOCAL"	,"C",aTam[1],0 } )
        AADD(aRet,{ "TRB_RECSBD"	,"N",12,0 } )
        AADD(aRet,{ "TRB_RECTRB"	,"N",12,0 } )
        AADD(aRet,{ "TRB_TIPONF"	,"C",01,0 } )
        aTam:= TamSX3("B2_QFIM")
        AADD(aRet,{ "TRB_QINI"	,"N",aTam[1],aTam[2] } )
        AADD(aRet,{ "TRB_QUANT"	,"N",aTam[1],aTam[2] } )
        AADD(aRet,{ "TRB_QFIM"	,"N",aTam[1],aTam[2] } )
        AADD(aRet,{ "TRB_FLAG"	,"L",01,0})
        AADD(aRet,{ "TRB_RNOAUX" ,"N",12,0 } )
        AADD(aRet,{ "TRB_USATRA" ,"C",01,0 } )
        aTam:= TamSX3("D1_ITEM")
        AADD(aRet,{ "TRB_ITEM"   ,"C",aTam[1],0 } )
        AADD(aRet,{ "TRB_MOD" 	,"C",01,0 } )
        AADD(aRet,{ "TRB_THREAD ","C",15,0 } )
        AAdd(aRet,{ "TRB_THRJCM", "C", 3, 0})
    Else //-- Indices
        AADD(aRet,"TRB_FILIAL+TRB_ORDEM+TRB_COD+TRB_NIVEL+TRB_NIVSD3+TRB_CHAVE+TRB_SEQ")
        AADD(aRet,"TRB_FILIAL+TRB_ALIAS+TRB_SEQ")
        AADD(aRet,"DTOS(TRB_DTBASE)+TRB_SEQPRO+TRB_ORDEM+TRB_NIVEL+TRB_NIVSD3+TRB_CHAVE+TRB_SEQ")
        AADD(aRet,"TRB_FILIAL+TRB_ALIAS+TRB_DOC+TRB_SERIE+TRB_ITEM")
        AADD(aRet,"DTOS(TRB_DTORIG)+TRB_SEQ+TRB_NIVEL+TRB_NIVSD3")
        AADD(aRet,"TRB_FILIAL+TRB_USATRA+TRB_ALIAS+TRB_COD+TRB_FILTRA")
        AADD(aRet,"TRB_THREAD+TRB_FILIAL+TRB_ORDEM+TRB_COD+TRB_NIVEL+TRB_NIVSD3+TRB_CHAVE+TRB_SEQ")
        AADD(aRet,"TRB_FILIAL+TRB_COD+TRB_LOCAL")
        AADD(aRet,"STR(TRB_RECNO, 12, 0)+TRB_ALIAS")
        AADD(aRet,"DTOS(TRB_DTBASE)+TRB_ORDEM+TRB_CHAVE")
        If ExistBlock("MA330IND") .And. ValType(cIndRdmk := ExecBlock("MA330IND",.F.,.F.)) == "C"
            AADD(aRet,cIndRdmk)
        Else
            AADD(aRet,"TRB_FILIAL") //Indice Dummy para preservar a ordenação
        EndIf
        AADD(aRet,"TRB_FILIAL+TRB_ORDEM+TRB_THRJCM+TRB_COD+TRB_NIVEL+TRB_NIVSD3+TRB_CHAVE+TRB_SEQ")
    EndIf

Return (aRet)

/*/{Protheus.doc} M330TRXStr
    Retorna a estrutura do arquivo TRX usado no recalculo do custo médio

    Movida do fonte MATXFUNA.PRX
    @type  Function
    @author Ricardo Goncalves
    @since 07/08/02
    /*/
Function M330TRXStr(nOpc)
Local aRet:= {}
Local nSizeFil  := 2

Default nOpc := 1

If nOpc == 1 //-- Campos
	//-- Atualiza o conteúdo da filial
	nSizeFil := FWSizeFilial()

	AADD(aRet,{"TRX_FILIAL"	,"C",nSizeFil,0 } )
	AADD(aRet,{"TRX_DATA"		,"D",08,0 } )
	aTam:= TamSX3("D3_OP")
	AADD(aRet,{"TRX_OP"		,"C",aTam[1],0 } )
	aTam:= TamSX3("B1_COD")
	AADD(aRet,{"TRX_COD"		,"C",aTam[1],0 } )
	aTam:= TamSX3("B2_LOCAL")
	AADD(aRet,{"TRX_LOCAL"	,"C",aTam[1],0 } )
	aTam:=TamSX3("D3_QUANT")
	AADD(aRet,{"TRX_QUANT"	,"N",aTam[1],aTam[2] } )
	AADD(aRet,{"TRX_QPERDA"	,"N",aTam[1],aTam[2] } )
	AADD(aRet,{"TRX_TOTAL"	,"N",aTam[1],aTam[2] } )
	AADD(aRet,{"TRX_TPERDA"	,"N",aTam[1],aTam[2] } )
	AADD(aRet,{"TRX_QTDPRC"	,"N",aTam[1],aTam[2] } )
	AADD(aRet,{"TRX_RNOAUX"	,"N",12,0 } )
Else //-- Indices
	AADD(aRet,"TRX_FILIAL+DTOS(TRX_DATA)+TRX_OP+TRX_COD+TRX_LOCAL")
	AADD(aRet,"TRX_FILIAL+STR(TRX_RNOAUX, 12, 0)")
EndIf
Return (aRet)



/*/{Protheus.doc} M330TRTStr
    Retorna a estrutura do arquivo TRT usado no recalculo do custo médio

    Movida do fonte MATXFUNA.PRX
    @type  Function
    @author Ricardo Goncalves
    @since 07/08/02
    /*/
Function M330TRTStr(lCstPart,nPartes,nOpc)
Local nx		:= 0
Local nz		:= 0
Local aRet		:= {}
Local aRegraCP 	:= {}
Local aLogsPart := {}
Local lCheck	:= (lCstPart == nil) .and. (nPartes == nil)

Default nOpc := 1

If nOpc == 1 //-- Campos
	If lCheck
		If ExistBlock("MA330CP")
			aRegraCP:=ExecBlock("MA330CP",.F.,.F.)
			If ValType(aRegraCP) # "A"
				aRegraCP:={}
			EndIf
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Verifica se os campos do custo em partes estao Ok            ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Len(aRegraCP) > 0
			lCstPart:=MA330AvlCp(aRegracp,aLogsPart)
		EndIf

		nPartes:= Len(aRegraCP)
	EndIf

	aTam:=TamSX3("B1_FILIAL")
	AADD(aRet,{ "TRB_FILIAL"	,"C",aTam[1],0 } )
	aTam:=TamSX3("B1_COD")
	AADD(aRet,{ "TRB_COD"		,"C",aTam[1],0 } )
	aTam:=TamSX3("B2_QFIM")
	AADD(aRet,{ "TRB_QFIM"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_QFIM2")
	AADD(aRet,{ "TRB_QFIM2"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_VFIM1")
	AADD(aRet,{ "TRB_VFIM1"	,"N",aTam[1]+2,aTam[2]} )
	aTam:=TamSX3("B2_VFIM2")
	AADD(aRet,{ "TRB_VFIM2"	,"N",aTam[1]+2,aTam[2]} )
	aTam:=TamSX3("B2_VFIM3")
	AADD(aRet,{ "TRB_VFIM3"	,"N",aTam[1]+2,aTam[2]} )
	aTam:=TamSX3("B2_VFIM4")
	AADD(aRet,{ "TRB_VFIM4"	,"N",aTam[1]+2,aTam[2]} )
	aTam:=TamSX3("B2_VFIM5")
	AADD(aRet,{ "TRB_VFIM5"	,"N",aTam[1]+2,aTam[2]} )
	aTam:=TamSX3("B2_CM1")
	AADD(aRet,{ "TRB_CM1"		,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM2")
	AADD(aRet,{ "TRB_CM2"		,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM3")
	AADD(aRet,{ "TRB_CM3"		,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM4")
	AADD(aRet,{ "TRB_CM4"		,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM5")
	AADD(aRet,{ "TRB_CM5"		,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_QFIM")
	AADD(aRet,{ "TRB_QTDMOD"	,"N",aTam[1]+2,0       } )
	aTam:=TamSX3("B2_CM1")
	AADD(aRet,{ "TRB_TOTCM1"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM2")
	AADD(aRet,{ "TRB_TOTCM2"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM3")
	AADD(aRet,{ "TRB_TOTCM3"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM4")
	AADD(aRet,{ "TRB_TOTCM4"	,"N",aTam[1]+2,aTam[2] } )
	aTam:=TamSX3("B2_CM5")
	AADD(aRet,{ "TRB_TOTCM5"	,"N",aTam[1]+2,aTam[2] } )
	AADD(aRet,{ "TRB_PRCREA"	,"L",1,0 } )
	AADD(aRet,{ "TRB_RNOAUX"  ,"N",12,0 } )

	// Caso utilize custo em partes cria os campos no arquivo de trabalho
	If lCstPart
		For nz:=1 to nPartes + 1
			For nx:=1 to 5
				aTam:=TamSX3("B2_CM1")
				AADD(aRet,{ "TRB_CP"+StrZero(nz,2,0)+StrZero(nx,2,0),"N",aTam[1]+2,aTam[2]})
				aTam:=TamSX3("B2_VFIM1")
				AADD(aRet,{ "TRB_VF"+StrZero(nz,2,0)+StrZero(nx,2,0),"N",aTam[1]+2,aTam[2]})
				aTam:=TamSX3("B2_CM1")
				AADD(aRet,{ "TRB_TP"+StrZero(nz,2,0)+StrZero(nx,2,0),"N",aTam[1]+2,aTam[2]})
			Next nx
		Next nz
	EndIf
Else //-- Indices
	AADD(aRet,"TRB_FILIAL+TRB_COD")
	AADD(aRet,"TRB_FILIAL+STR(TRB_RNOAUX, 12, 0)")
EndIf

Return (aRet)


/*/{Protheus.doc} M330TRTStr
    Retorna a estrutura do arquivo TRA usado no recalculo do custo médio

    Movida do fonte MATXFUNA.PRX
    @type  Function
    @author Marcelo Pimentel
    @since 08/07/04
    /*/
Function M330TRAStr(nOpc)
Local aRet	   := {}
Local aTam     := {}
Local nSizeFil := 2

Default nOpc := 1

If nOpc == 1 //-- Campos
	//-- Atualiza o conteúdo da filial
	nSizeFil := FWSizeFilial()

	AADD(aRet,{ "TRA_FILIAL"	,"C",nSizeFil,0 } )
	AADD(aRet,{ "TRA_NUMSEQ"	,"C",06,0 } )
	AADD(aRet,{ "TRA_CF"	    ,"C",03,0 } )
	aTam:= TamSX3("B1_COD")
	AADD(aRet,{ "TRA_COD"	,"C",aTam[1],0 } )
	AADD(aRet,{ "TRA_RNOAUX" ,"N",12,0 } )
Else //-- Indices
	AADD(aRet,"TRA_FILIAL+TRA_NUMSEQ+TRA_CF+TRA_COD")
	AADD(aRet,"TRA_FILIAL+STR(TRA_RNOAUX, 12, 0)")
EndIf
Return (aRet)


/*/{Protheus.doc} M330TRDStr
    Retorna a estrutura do arquivo TRD usado no recalculo do custo médio

    Movida do fonte MATXFUNA.PRX
    @type  Function
    @author Marcelo Pimentel
    @since 13/02/07
    /*/
Function M330TRDStr(nOpc)
Local aRet  :={}
Local nSizeFil := 2
Local nSizeIns := TamSX3("A1_INSCR")[1]

Default nOpc := 1

If nOpc == 1 //-- Campos
	nSizeFil := FWSizeFilial()

	AADD(aRet,{ "TRD_FILIAL" ,"C",nSizeFil,0 } )
	AADD(aRet,{ "TRD_CGC"	 ,"C",14,0 } )
	AADD(aRet,{ "TRD_INSC"   ,"C",nSizeIns,0 })
Else //-- Indices
	AADD(aRet,"TRD_FILIAL+TRD_CGC")
EndIf
Return (aRet)



Static __oQryTRB := Nil
/*/{Protheus.doc} M330ThrLoad
    Prepara o balanceamento de carga das threads da ordem 100/500
    @type  Function
    @author g.moreira
    @since 16/04/2025
    /*/
Function M330ThrLoad(cNomTRB, cOrdem)
    Local oTempTable := Nil
    Local aThreads   := {}
    Local cQuery     := ""
    Local nThreads   := SuperGetMV('MV_M330THR',.F.,1)
    Local cAlTmp     := GetNextAlias()
    Local aFields    := {}
    Local cThisThr   := Strzero(ThreadID(),15)
    Local nI         := 0
    Local cAlMov     := ""
    Local cCod       := ""
    Local nQtd       := ""
    Local oQryThr    := Nil

    oTempTable := FWTemporaryTable():New(cAlTmp)
    AAdd(aFields, {"THR", "C", 3, 0})
    AAdd(aFields, {"COD", "C", TamSX3("B1_COD")[1], 0})
    AAdd(aFields, {"QTDMOV", "N", 12, 0})
    oTempTable:SetFields(aFields)
    oTempTable:AddIndex("01", {"THR", "COD", "QTDMOV"})
    oTempTable:Create()

    If nThreads < 1
        nThreads := 1
    EndIf
    If nThreads >= 100
		nThreads := 99
	EndIf

    //Cria contador de threads vazio
    For nI := 1 To nThreads
        RecLock(cAlTmp, .T.)
        (cAlTmp)->THR := Strzero(nI, 3)
        (cAlTmp)->(MsUnlock())

        AAdd(aThreads, {Strzero(nI, 3)})
    Next

    //Contagem de movimentos por produto
    If __oQryTRB == Nil
        cQuery := " Select TRB_COD COD, Count(1) QTDMOV "
        cQuery += " From "+cNomTRB+" "
        cQuery += " Where TRB_FILIAL = ? "
        cQuery += "   And TRB_ORDEM  = ? "
        cQuery += "   And TRB_THREAD = ? "
        cQuery += " Group By "
        cQuery += "    TRB_COD "
        cQuery += " Order By "
        cQuery += "     QTDMOV Desc "
        cQuery := ChangeQuery(cQuery)

        __oQryTRB := FWExecStatement():New(cQuery)
    EndIf

    __oQryTRB:SetString(1, cFilAnt)
    __oQryTRB:SetString(2, cOrdem)
    __oQryTRB:SetString(3, cThisThr)

    cAlMov := __oQryTRB:OpenAlias()

    cQuery := " Select THR, Sum(QTDMOV) SUMQTD "
    cQuery += " From "+oTempTable:GetRealName()
    cQuery += " Group By THR "
    cQuery += " Order By SUMQTD "
    cQuery := ChangeQuery(cQuery)

    oQryThr := FWExecStatement():New(cQuery)
    While !(cAlMov)->(EoF())
        cCod := (cAlMov)->COD
        nQtd := (cAlMov)->QTDMOV

        cThr := oQryThr:ExecScalar('THR')

        RecLock(cAlTmp, .T.)
        (cAlTmp)->THR := cThr
        (cAlTmp)->COD := cCod
        (cAlTmp)->QTDMOV := nQtd
        (cAlTmp)->(MsUnlock())

        cQuery := " Update "+cNomTRB+" "
        cQuery += " Set "
        cQuery += " TRB_THRJCM = '"+cThr+"' "
        cQuery += " Where "
        cQuery += "       TRB_FILIAL = '"+cFilAnt+"' "
        cQuery += "   And TRB_ORDEM  = '"+cOrdem+"' "
        cQuery += "   And TRB_COD    = '"+cCod+"' "
        cQuery += "   And TRB_THREAD = '"+cThisThr+"' "
        A330SQLExec(cQuery, 'M330ThrLoad', "Falha no balanceamento de carga")
        
        (cAlMov)->(DbSkip())
    End
    (cAlMov)->(DbCloseArea())
    
    oTempTable:Delete()
    oQryThr:Destroy()
    oQryThr := Nil

Return aThreads
