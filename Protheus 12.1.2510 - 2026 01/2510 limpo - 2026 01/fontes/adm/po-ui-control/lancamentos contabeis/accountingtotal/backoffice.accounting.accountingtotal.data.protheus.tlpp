#include "tlpp-core.th"
#Include "Protheus.ch"
#include "backoffice.reconciliation.matchtotal.data.protheus.ch"

namespace totvs.protheus.backoffice.accounting.accountingtotal

//-------------------------------------------------------------------
/*/{Protheus.doc} AccountingTotalProtheusData
Classe responsavel pela consulta de dados

@author Totvs
/*/
//-------------------------------------------------------------------
class AccountingTotalProtheusData    
    Public  method new()       
    Public  method getTotal()
    Private method tcGetQueryTotal()    
endclass

/*/{Protheus.doc} AccountingTotalProtheusData
Metodo construtor

@author Totvs
/*/
method new() class AccountingTotalProtheusData
return

/*/{Protheus.doc} getTotal
Metodo responsavel pela busca dos totais das contabilizacoes

@author Totvs
/*/
method getTotal(cAliasTmp as character, cIdProces as character, cCurrency as character, cType as character) class AccountingTotalProtheusData       
    ::tcGetQueryTotal(cAliasTmp, cIdProces, cCurrency, cType)
return cAliasTmp

/*/{Protheus.doc} tcGetQueryTotals
Retorna a proxima sequencia disponivel na temporaria

@author Totvs
/*/
method tcGetQueryTotal(cAliasTmp as character, cIdProces as character, cCurrency as character,; 
                        cType as character) class AccountingTotalProtheusData
    Local cQuery := "" as character

    //Query para buscar totalizadores
    cQuery := "SELECT CT2_FILIAL, CT2_LOTE, CT2_SBLOTE, CT2_DOC,"
    cQuery += " CASE WHEN CT2_DC = '1' OR CT2_DC = '3' THEN SUM(CT2_VALOR) ELSE 0 END TOTALDEB,"
    cQuery += " CASE WHEN CT2_DC = '2' OR CT2_DC = '3' THEN SUM(CT2_VALOR) ELSE 0 END TOTALCRED,"
    cQuery += " SUM(CT2_VALOR) TOTAL"
    cQuery += " FROM "+RetSqlName("CT2")
    cQuery += " WHERE CT2_FILIAL = '"+xFilial("CT2")+"'"
    cQuery += " AND CT2_PROCES = '"+cIdProces+"'"
    cQuery += " AND CT2_MOEDLC = '"+cCurrency+"'"
    If AllTrim(cType) == "1" .Or. AllTrim(cType) == "2"
        cQuery += " AND CT2_INCONS = '"+cType+"'"
    EndIf
    cQuery += " AND D_E_L_E_T_ = ' '"
    cQuery += " GROUP BY CT2_FILIAL, CT2_LOTE, CT2_SBLOTE, CT2_DOC, CT2_DC"

    cQuery := ChangeQuery(cQuery)
    dbUseArea(.T., "TOPCONN", TcGenQry(,, cQuery), cAliasTmp, .T., .F.)                
return
