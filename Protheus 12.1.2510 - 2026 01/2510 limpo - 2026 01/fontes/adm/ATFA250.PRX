#INCLUDE "ATFA250.CH"
#include "Protheus.ch"
Static __nExeDel 	:= 0
Static lN1Ciap 		:= Nil

//********************************
// Controle de multiplas moedas  *
//********************************
Static lMultMoed := .T.
STATIC lIsRussia	:= If(cPaisLoc$"RUS",.T.,.F.) // CAZARINI - Flag to indicate if is Russia location

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ATFA250    ³ Autor ³ Alice Y Yamamoto      ³ Data ³ 13.06.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Rotina de Aquisicao por Transferencia.                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Ativo Fixo                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function ATFA250( )

Private aRotina := MenuDef()
Private cPerg	:= "AFA250"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ativa tecla F12 para ativar parametros de lan‡amentos contab.           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Pergunte(cPerg,.F.)

ATFXKERNEL()

SetKey( VK_F12, { || Pergunte(cPerg,.T.) })

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Carrega as perguntas selecionadas:                                     ³
//³ mv_par01 - 1 Mostra lan‡amentos cont beis da Baixa                     ³
//³            2 NAO Mostra lan‡amentos cont beis da baixa                 ³
//³            3 NAO Contabiliza a baixa de adiantamentos                  ³
//³ mv_par02 - 1 Aglutina lancamentos da baixa de adiantamentos            ³
//³            2 Nao Aglutina lancamentos da baixa de adiantamentos        ³
//³ mv_par03 - 1 Repete Chapa                                              ³
//³            2 Nao Repete a Chapa                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ lClassifica usada p/ classificacao. Aqui p/ NÆo criar Automatico  ³
//³ qdo entrar na tela de inclusao no ATFA010 (lClassifica := .T.)    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Private cCodRat
Private cMarca     := GetMark()
Private cCadastro  := STR0005 // "Aquisicao por Transferencia"
Private aDiario    :={}
Private cCodDiario := ""

AF250ChkCiap()

Set Decimals to 4
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Endere‡a a fun‡„o de BROWSE ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
mBrowse( 6, 1,22,75,"SN1",,"N1_BAIXA",22)
SET KEY VK_F12 TO

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o   ³ AF250Baix  ³ Autor ³ Alice Y Yamamoto      ³ Data ³ 13.06.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o³ Aquisicao por Transferencia                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso     ³ Generico                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function af250Baix()
Local oDlg,oDlg1,oQtda,oValor
Local lInverte  	:= .F.
Local nOpcA     	:= 0
Local nOpct     	:= 0
Local dUltDepr 		:= GETMV("MV_ULTDEPR")
Local lGspInUseM 	:= If(Type('lGspInUse')=='L', lGspInUse, .F.)
Local nSaveSx8Len 	:= GetSx8Len()
Local cOrdem		:= ""
Local cBaseDe, cBaseAte
Local nIndex
Local aAF250Imp		:= {} //Controle de Impostos dos Bens Informados
Local aAF250Desc	:= {} //Controle de Descricao Estendida
Local aAF250DOri	:= {} //Controle de Descricao Estendida dos itens Originais
Local cPictVlr		:= PesqPict("SN3","N3_VORIG1")
Local cPictQtd		:= PesqPict("SN1","N1_QUANTD")
//Data de Bloqueio da Movimentação - MV_ATFBLQM
Local dDataBloq := GetNewPar("MV_ATFBLQM",CTOD(""))

Local aCampos	 	:= {}
Local aParam		:= {}
Local aRetPB		:= {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Estrutura do aAF250Imp:        ³
//³[n][1] = Imposto               ³
//³[n][2] = Credito S/N           ³
//³[n][3] = Qtd Meses para Credito³
//³[n][4] = CIAP S/N              ³
//³[n][5] = Total Original        ³
//³[n][6] = Saldo a Ratear        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Extrutura do Array aAF250Desc:                         ³
//³[n][1] = (Array) Descrição Estendida                   ³
//³   ... [1] = linha da Descricao                        ³
//³   ... [2] = Descricao (Limit a 40 Caractere)          ³
//³[n][2] = Vinculo com a linha do Grid da Descricao      ³
//³[n][3] = Logico que controla se a descricao foi editada³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Estrutura do aAF250DOri					³
//³[n][1]  = Código do bem original				³
//³[n][2]  = Item do bem original				³
//³[n][3]  = Tipo do bem original				³
//³[n][4]  = Sequencia do bem original				³
//³[n][5]  = Recno() do bem original				³
//³[n][6]  = (Array) Descrição Estendida			³
//³... [1] = linha da Descricao					³
//³... [2] = Descricao (Limitada a 40 Caractere)		³
//³[n][7]  = Numérico (indica se a descrição já foi atribuída)	³
//³ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

AF250ChkCiap()

If lGspInUseM
	//Se for GSP, pega o ultimo dia do mes anterior
	dUltDepr := MsSomaMes(dUltDepr,-1,.T.)
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ lCopia := .T. para que possa escolher a opcao no   ³
//³combo . Valida‡„o est  no SX3 AF010NAOALT().        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Private lCopia  := .T.
Private nValor  := 0
Private nQtdBem := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Valores Originais iniciais a ratear (n3_vorig1)    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//********************************
// Controle de multiplas moedas  *
//********************************
Private aValorOri	:= If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
/*Private nValorOri1	:= 0
Private nValorOri2	:= 0
Private nValorOri3	:= 0
Private nValorOri4	:= 0
Private nValorOri5	:= 0*/

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Valores de depreciacao acumulada a ratear          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//********************************
// Controle de multiplas moedas  *
//********************************
Private aValDepAc	:= If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
/*Private nValDepAc1 := 0
Private nValDepAc2 := 0
Private nValDepAc3 := 0
Private nValDepAc4 := 0
Private nValDepAc5 := 0*/

Pergunte(cPerg,.T.)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se a data ‚ v lida                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(dDataBloq) .AND. (dDataBase <= dDataBloq)
	HELP(" ",1,"AF250BLQM",,STR0123 + DTOC(dDataBloq) ,1,0)    //"A data de aquisição do bem é igual ou menor que a data de bloqueio de movimentação : "
	Return
End If

If dDataBase <= dUltDepr .Or. (dDataBase > (LastDAy(dUltDepr+1)))
	//Tipo Depreciacao diferente 02-Mes Subsequente
	If GetMv("MV_TIPDEPR") <> "2"
		HELP(" ",1,"AF250DATAT")
		Return
	ElseIF dDataBase < (FirstDay(dUltDepr))
		Help(" ",1,"AF250DEPREC",,STR0064+DTOC(GetMV("MV_ULTDEPR")),1,0)
		Return
	Endif
Endif

cLoteAtf := LoteCont("ATF")

cBaseDe  := cBaseAte := CRIAVAR("N1_CBASE")
cTipo           := "01"

While .T.

		aAdd(aCampos,{"N3_OK",,"  ",""})
		SX3->(DbSetOrder(1))
		SX3->(MsSeek("SN3"))
		Do While SX3->X3_ARQUIVO == "SN3" .And. SX3->(!EOF())
			If(X3USO(SX3->x3_usado)  .and. cNivel >= SX3->x3_nivel .and. SX3->X3_context # "V") .or.;
				(SX3->X3_PROPRI == "U" .and. SX3->X3_CONTEXT!="V" .and. SX3->X3_TIPO<>'M') .or.;
	   			Alltrim(SX3->X3_CAMPO) $ "N3_CBASE#N3_ITEM" .and. Alltrim(SX3->X3_CAMPO) != "N3_OK"

	   			aAdd(aCampos,{SX3->X3_CAMPO,,SX3->(X3TITULO()) ,SX3->X3_PICTURE})
			Endif
			SX3->(DbSkip())
		Enddo




	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 	//³ Parambox - Transferir  	        ³
   	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aAdd(aParam,{1,STR0008,space(TamSx3("N1_CBASE")[1]),"@!", "","SN1","",50,.T.})
	aAdd(aParam,{1,STR0009,space(TamSx3("N1_CBASE")[1]),"@!", "","SN1","",50,.T.})
	If !(Parambox(aParam,STR0006,aRetPB,,,.T.,80,3,,,.T.,.T.)) .or. (nOpca:=TudOk())!= 1
		Exit
	EndIf

	AjRetParam(aRetPB,aParam)
	cBaseDe	:= aRetPB[1]
	cBaseAte:= aRetPB[2]
	Pergunte(cPerg,.F.)  	//Devido ao uso da parambox se faz necessario para carregar as variaveis dos MV_PAR0x

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ BOPS 00000123127 - PROTECAO DA NUMERACAO SEQUENCIAL DA BAIXA ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !AF250VLDNM(@cOrdem)
		Exit
	Endif
	cCodRat := GetSXENum("SN3","N3_CODBAIX",,Val(cOrdem))
	ConfirmSX8()

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Filtra o arquivo por tipo e vencimento                       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SN3")
	dbSetOrder(1)
	cIndex := CriaTrab(nil,.f.)
	cChave  := IndexKey()
	IndRegua("SN3",cIndex,cChave,,FA250Check(cBaseDe,cBaseAte) + ".AND. AF250FTOV(SN3->N3_CBASE,SN3->N3_ITEM) ",STR0011) // "Selecionando Registros..."
	nIndex := RetIndex("SN3")
	dbSelectArea("SN3")
	#IFNDEF TOP
		dbSetIndex( cIndex +OrdBagExt())
	#ENDIF
	dbSelectArea("SN3")
	dbSetOrder(nIndex+1)
	dbGoTop()

	If BOF() .and. EOF()
		Help(" ",1,"RECNO")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Restaura os indices      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		RetIndex("SN3")
		Set Filter To
		fErase (cIndex+OrdBagExt())
		While GetSx8Len() > nSaveSx8Len
			RollBackSx8()
		End
		Exit
	End

	nValor  := 0
	nQtdBem := 0

	SN3->(DBEVAL({ |a| AF250DBEVA(cMarca,.F.)}))
	aSize := MSADVSIZE()

	DEFINE MSDIALOG oDlg1 TITLE STR0012 From aSize[7],0 To aSize[6],aSize[5] OF oMainWnd PIXEL // "Selecao para Transferencia"
	oDlg1:lMaximized := .T.

	oPanel := TPanel():New(0,0,'',oDlg1,, .T., .T.,, ,30,30,.T.,.T. )
	oPanel:Align := CONTROL_ALIGN_TOP

	@0.8,.8 Say STR0013 Of oPanel // "Valor Total:"
	@0.8, 7 Say oValor 	VAR nValor 	Picture cPictVlr Of oPanel
	@1.3,.8 Say STR0014 Of oPanel // "Quantidade:"
	@1.3, 9 Say oQtda 	VAR nQtdBem Picture cPictQtd SIZE 75,10 Of oPanel
	oMark := MsSelect():New("SN3","N3_OK","!N3_BAIXA",aCampos,@lInverte,@cMarca,{35,oDlg1:nLeft,oDlg1:nBottom,oDlg1:nRight})
	oMark:bMark := {|| a250Display(cMarca,lInverte,oValor,oQtda,.T.)}
	oMark:oBrowse:bAllMark := {| | SN3->(DBEVAL({ |a| AF250DBEVA(cMarca,.T.)})),SN3->(dbgoTop()),oQtda:Refresh(),oValor:Refresh()}
	oMark:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT

	ACTIVATE MSDIALOG oDlg1 ON INIT EnchoiceBar(oDlg1,	{|| IIF( AF250BxOK(@aAF250Imp, @aAF250DOri), (nOpct:=1,oDlg1:End()), nOpct:=0)},;
														{|| nOpct:=2,oDlg1:End()}) CENTERED

	If nOpct == 1
		af250Rateio(cBaseDe,cBaseAte, nIndex, @aAF250Imp, @aAF250Desc, @aAF250DOri)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Restaura os indices      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		RetIndex("SN3")
		Set Filter To
		fErase (cIndex+OrdBagExt())
	ElseIf nOpct == 2 .Or. nOpct == 0
		A250Desmar(nIndex)
		While GetSx8Len() > nSaveSx8Len
			RollBackSx8()
		End
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Restaura os indices      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		RetIndex("SN3")
		Set Filter To
		fErase (cIndex+OrdBagExt())
	Endif
	Exit
EndDo
Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ AF250BxOk ³ Autor ³ Alice Y Yamammoto     ³ Data ³ 20.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Valida a tela de marcacao dos itens para processamento      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250BxOk()                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA250                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250BxOK(aAF250Imp, aAF250DOri)
Local lRet := .T.
Local nCount := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se existem itens selecionados     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//OBS: Estou considerando o filtro da tabela SN3
SN3->( dbGoTop() )
SN3->(DBEVAL({ |a| IIF(SN3->N3_OK == cMarca,nCount++,.F.)}))
If nCount == 0
	Help(" ", 1, "AFNOSELECT",, STR0118+CRLF+STR0119+CRLF+STR0120, 1, 0) //"Não existem itens selecionados para "###"processamento. Selecione pelo menos um "###"item antes de confirmar a operacao."
    lRet := .F.
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Validacao para demais tratamentos:         ³
//³ Impostos e Descricao Estendida			   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF lRet
	// Já exibe as mensagens de erro caso pertinentes
	lRet := AF250RatInf(@aAF250Imp, @aAF250DOri)
ENDIF
SN3->( dbGoTop() )

Return lRet
/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250Rateio³ Autor ³ Alice Y Yamammoto     ³ Data ³ 20.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Rateio dos valores dos adtos a serem baixados               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250Rateio()                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA250                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250Rateio(cBaseDe, cBaseAte, nIndex, aAF250Imp, aAF250Desc, aAF250DOri)
LOCAL nOpcA			:= 0
Local aButtons		:= {}
Local nSaveSx8Len 	:= GetSx8Len()
Local aTitles		:= {STR0069,STR0070,STR0071} //'Totais do Rateio'###'Detalhes dos Impostos'###'Descrição Extendida'
Local aPages		:= {"HEADER","HEADER","HEADER"}
Local bBlqLinOk		:= {|| AF250LinOk(@aAF250Imp,@oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp) }
Local bBlqTudOk		:= {|| AF250TudOk(@aAF250Imp, @aAF250Desc, @oFolder, @oGetDadTot, @oGetDadImp, @aAF250DOri) }
Local cTexto		:= ""
Local cTextoOri		:= ""
Local aHead250Imp 	:= {}
Local aHeadTotais 	:= {}
Local aFieldDOri	:= {}
Local aSizes		:= {}
Local aCols250Imp 	:= {}
Local aColsTotais 	:= {}
Local oOk			:= LoadBitMap(GetResources(), "ENABLE")
Local oNo			:= LoadBitMap(GetResources(), "DISABLE")

Local oFolder, oDlg, oGet, oBtn1, oBtn2, oBtn3, oBtn4, oBtn5, oGetDadTot, oGetDatImp, oDscOri, oLbx
Local oPanel2, oPanel3, oPanel4, oPanel5, oPanel6, oPanel7, oPanel8, oPanel9
Local oMemo, oMemoOri
Local j

Private oValRat, oValRatICMS, oValTotICMS
PRIVATE oValor
PRIVATE aGETS[0]
PRIVATE nValRat	:= 0
PRIVATE aCols	:= {}
PRIVATE aHeader	:= {}
PRIVATE nUsado 	:= 0
Private nTotICMS	:=0
Private nValRatICMS := 0

Af250aHead()

If !AF250VAVP()
	Return
EndIf

AADD(aHeadTotais,{ STR0072,	'DESCRIC',		"@!",							30,	0,	"",	"û", 'C', '',	'',	'',	'',	".T."}) //'Tipo de Total'
AADD(aHeadTotais,{ STR0073,	'N3_VORIG1',	"@E 999,999,999,999,999.99", 	16,	2,	"",	"û", 'N', '',	'',	'',	'',	".T."}) //"Valor"
AADD(aHeadTotais,{ STR0074,	'N3_VORIG1',	"@E 999,999,999,999,999.99",	16,	2,	"",	"û", 'N', '',	'',	'',	'',	".T."}) //'Rateado'
AADD(aHead250Imp,{ STR0075,	'DESCRIC',		"@!",				30,	0,									"",	"û", 'C', '',	'',	'',	'',	".T."}) //'Imposto'

SX3->(DbSetOrder(2))

If lN1Ciap
	SX3->( dbSeek( 'N1_CALCPIS' ), .F.)
	AADD(aHead250Imp,{ STR0076,		'N1_CALCPIS',	SX3->X3_PICTURE,	SX3->X3_TAMANHO,	SX3->X3_DECIMAL,	"",	"û", SX3->X3_TIPO, '',	'',	'',	'',	".T."}) //'Credito'

	SX3->( dbSeek( 'N1_MESCPIS' ), .F.)
	AADD(aHead250Imp,{ X3Titulo(),	'N1_MESCPIS',	SX3->X3_PICTURE,	SX3->X3_TAMANHO,	SX3->X3_DECIMAL,	"",	"û", SX3->X3_TIPO, '',	'',	'',	'',	".T."})

	SX3->( dbSeek( 'N1_CIAP' ), .F.)
	AADD(aHead250Imp,{ X3Titulo(),	'N1_CIAP'	,	SX3->X3_PICTURE,	SX3->X3_TAMANHO,	SX3->X3_DECIMAL,	"",	"û", SX3->X3_TIPO, '',	'',	'',	'',	".T."})

	SX3->( dbSeek( 'N1_ICMSAPR' ), .F.)
	AADD(aHead250Imp,{ STR0078,		'N1_ICMSAPR',	SX3->X3_PICTURE,	SX3->X3_TAMANHO,	SX3->X3_DECIMAL,	"",	"û", SX3->X3_TIPO, '',	'',	'',	'',	".T."}) //'Total Original'
	AADD(aHead250Imp,{ STR0079,		'N1_ICMSAPR',	SX3->X3_PICTURE,	SX3->X3_TAMANHO,	SX3->X3_DECIMAL,	"",	"û", SX3->X3_TIPO, '',	'',	'',	'',	".T."}) //'Saldo a Ratear'
EndIf

aAdd( aSizes,		5 )
aAdd( aFieldDOri, " " )

SX3->( dbSeek( 'N1_CBASE' ), .F.)
aAdd( aSizes,		TamSx3('N1_CBASE')[1] )
aAdd( aFieldDOri, 	X3Titulo() )

SX3->( dbSeek( 'N1_ITEM' ), .F.)
aAdd( aSizes,		TamSx3('N1_ITEM')[1] )
aAdd( aFieldDOri, 	X3Titulo() )

SX3->( dbSeek( 'N3_TIPO' ), .F.)
aAdd( aSizes,		TamSx3('N3_TIPO')[1] )
aAdd( aFieldDOri, 	X3Titulo() )

SX3->( dbSeek( 'N3_SEQ' ), .F.)
aAdd( aSizes,		TamSx3('N3_SEQ')[1] )
aAdd( aFieldDOri, 	X3Titulo() )

SX3->(DbSetOrder(1))

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Cria aCOLS de acordo com Tamanho do Arquivo enviado  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
AADD(aCols,Array(nUsado+1))
nUsado := 0

For j:=1 To Len(aHeader)
	nUsado++
	If aHeader[j][8] == "C"
		If aHeader[j][2] == "N3_TIPO"
			aCols[1][nUsado] := "01"
		Else
			aCols[1][nUsado] := Space(aHeader[j][4])
		Endif
	ElseIf aHeader[j][8] == "D"
	    // Inicializa o campo N3_DINDEPR conforme parametro MV_TIPDEPR
	    If aHeader[j][2] == "N3_DINDEPR"
			aCols[1][nUsado] := RetDinDepr(dDataBase)
		Else
			aCols[1][nUsado] := dDataBase
		Endif
	Elseif AllTrim(aHeader[j][2]) $ "SN3_REC_WT|SN3_ALI_WT"
		   If AllTrim(aHeader[j][2]) == "SN3_REC_WT"
		   		aCols[1][nUsado] := SN3->(Recno())
		   	ElseIf AllTrim(aHeader[j][2]) == "SN3_ALI_WT"
		   		aCols[1][nUsado] := "SN3"
		   	EndIf
	Else
		aCols[1][nUsado] := 0
	EndIf
Next j

aCols[1][nUsado+1] := .F.
aCols[1][Ascan(AHEADER, {|e| Alltrim(e[2]) == "N1_CONSAB" } ) ]:=Criavar("N1_CONSAB",.T.)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Mostra o corpo da rateio                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpca := 0

SN1->(DbSeek(xFilial("SN1") + cBaseDe))	// Carregar variaveis para uso em gatilho
SN1->(RegToMemory("SN1", .F.))            // uso os parametros iniciais pois pode haver mais de um bem

While .T.
	aSize := MSADVSIZE()

   	DEFINE MSDIALOG oDlg TITLE STR0005 From aSize[7],0 To aSize[6],aSize[5] OF oMainWnd  PIXEL //	"Aquisicao por Transf"
 	oDlg:lMaximized := .T.
	oPanel := TPanel():New(0,0,'',oDlg,, .T., .T.,, ,60,120,.T.,.T. )
	oPanel:Align := CONTROL_ALIGN_BOTTOM

	oGet := MSGetDados():New(30,oDlg:nLeft,oDlg:nBottom,oDlg:nRight,3,bBlqLinOk,bBlqTudOk,"",.T., , ,.f., , , , ,"AF250DelLi")

	oFolder := TFolder():New(0,0,aTitles,aPages,oPanel,,,, .T., .F.,30,30,)
	oFolder:Align := CONTROL_ALIGN_ALLCLIENT
	oFolder:nOption := 1

	oPanel2 := TPanel():New(0,0,'',oFolder:aDialogs[3],, .T., .T.,, ,30,30,.T.,.T. )
	oPanel2:nWidth 	:= oFolder:oWnd:nClientWidth / 4
	oPanel2:Align 	:= CONTROL_ALIGN_LEFT

	oPanel3 := TPanel():New(0,0,'',oFolder:aDialogs[3],, .T., .T.,, ,44,30,.T.,.T. )
	oPanel3:Align 	:= CONTROL_ALIGN_LEFT
//	oPanel3:lVisible := Mv_Par05 == 2

	oPanel5 := TPanel():New(0,0,'',oFolder:aDialogs[3],, .T., .T.,, ,44,30,.T.,.T. )
	oPanel5:nWidth 	:= oFolder:oWnd:nClientWidth / 4
	oPanel5:Align 	:= CONTROL_ALIGN_LEFT
//	oPanel5:lVisible := Mv_Par05 == 2

	oPanel8 := TPanel():New(0,0,'',oPanel5,, .T., .T.,, ,15,15,.T.,.T. )
	oPanel8:Align 	:= CONTROL_ALIGN_TOP

	oSayOri := TSAY():Create(oPanel8)
	oSayOri:cName := "oSayOri"
	oSayOri:cCaption := STR0115 //"Descricao Original"
	oSayOri:nLeft := 10
	oSayOri:nTop := 10
	oSayOri:nWidth := 250
	oSayOri:nHeight := 17
	oSayOri:lShowHint := .F.
	oSayOri:lReadOnly := .T.
	oSayOri:Align := 0
	oSayOri:lVisibleControl := .T.
	oSayOri:lWordWrap := .F.
	oSayOri:lTransparent := .F.

	oPanel9 := TPanel():New(0,0,'',oPanel5,, .T., .T.,, ,8,8,.T.,.T. )
	oPanel9:Align 	:= CONTROL_ALIGN_BOTTOM

	oMemoOri := TMultiGet():Create(oPanel5)
	oMemoOri:cName := "oMemoOri"
	oMemoOri:nHeight := 180
	oMemoOri:lShowHint := .F.
	oMemoOri:lReadOnly := .T.
	oMemoOri:cVariable := "cTextoOri"
	oMemoOri:bSetGet := {|u| If(PCount()>0,cTextoOri:=u,cTextoOri) }
	oMemoOri:lVisibleControl := .T.
	oMemoOri:lWordWrap := .T.
	oMemoOri:Align 	:= CONTROL_ALIGN_ALLCLIENT

	oPanel4 := TPanel():New(0,0,'',oFolder:aDialogs[3],, .T., .T.,, ,30,30,.T.,.T. )
	oPanel4:Align 	:= CONTROL_ALIGN_ALLCLIENT
//	oPanel4:lVisible := Mv_Par05 == 2

	oLBx := TWBrowse():New( 05,10,150,50,,aFieldDOri,aSizes,oPanel4,,,,,,,,,,,,.F.,,.T.,,.F.,,,)
	oLBx:SetArray(aAF250DOri)
	oLBx:bLine 	:= { || {If(Empty(aAF250DOri[oLbx:nAt,7]),oOk,oNo),aAF250DOri[oLBx:nAT][1],aAF250DOri[oLBx:nAT][2],aAF250DOri[oLBx:nAT][3],aAF250DOri[oLBx:nAT][4]} }
	oLBx:Align := CONTROL_ALIGN_ALLCLIENT

	oPanel6 := TPanel():New(0,0,'',oPanel2,, .T., .T.,, ,15,15,.T.,.T. )
	oPanel6:Align 	:= CONTROL_ALIGN_TOP

	oSay1 := TSAY():Create(oPanel6)
	oSay1:cName := "oSay1"
	oSay1:cCaption := STR0080 //"Digite abaixo a descrição estendida"
	oSay1:nLeft := 10
	oSay1:nTop := 10
	oSay1:nWidth := 250
	oSay1:nHeight := 17
	oSay1:lShowHint := .F.
	oSay1:lReadOnly := .T.
	oSay1:Align := 0
	oSay1:lVisibleControl := .T.
	oSay1:lWordWrap := .F.
	oSay1:lTransparent := .F.

	oPanel7 := TPanel():New(0,0,'',oPanel2,, .T., .T.,, ,8,8,.T.,.T. )
	oPanel7:Align 	:= CONTROL_ALIGN_BOTTOM

	oMemo := TMultiGet():Create(oPanel2)
	oMemo:cName := "oMemo"
	oMemo:nHeight := 180
	oMemo:lShowHint := .F.
	oMemo:lReadOnly := Mv_Par05==1
	oMemo:cVariable := "cTexto"
	oMemo:bSetGet := {|u| If(PCount()>0,cTexto:=u,cTexto) }
	oMemo:lVisibleControl := .T.
	oMemo:lWordWrap := .T.
	oMemo:bChange 	:= {|| AFDescGrv(@aAF250Desc, @cTexto) } //Serao utilizados para gravar o MEMO
	oMemo:bValid 	:= {|| AFDescGrv(@aAF250Desc, @cTexto) } //Serao utilizados para gravar o MEMO
	oMemo:Align 	:= CONTROL_ALIGN_ALLCLIENT

	oGetDadTot  := MsNewGetDados():New(005,005,090,300,0,/*ValidLin*/,/*TudoOk*/,/*inicpos*/,/*aCpoHead*/,/*freeze*/,120,/*fieldok*/,/*superdel*/,/*delok*/,oFolder:aDialogs[1],aHeadTotais,aColsTotais)
	oGetDadImp  := MsNewGetDados():New(005,005,090,300,0,/*ValidLin*/,/*TudoOk*/,/*inicpos*/,/*aCpoHead*/,/*freeze*/,120,/*fieldok*/,/*superdel*/,/*delok*/,oFolder:aDialogs[2],aHead250Imp,aCols250Imp)

	oGet:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT

	oFolder:bSetOption := {|nDst| AF250CtImp(@aAF250Imp, @oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp), AF250CtDesc( @aAF250Desc, @oFolder, @oMemo, @oPanel3, @cTexto, @oPanel4) }

	oGetDadTot:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT
	oGetDadImp:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT

	oBtn1 := SBUTTON():Create(oPanel3)
	oBtn1:cName := "oBtn1"
	oBtn1:cCaption := STR0081 //Atribuir
	oBtn1:nLeft := 05
	oBtn1:nTop := 05
	oBtn1:nWidth := 80
	oBtn1:nHeight := 22
	oBtn1:lShowHint := .F.
	oBtn1:lReadOnly := .F.
	oBtn1:Align := 0
	oBtn1:lVisibleControl := .T.
	oBtn1:nType := 1
	oBtn1:bWhen := {|| AF250AtBt(1, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc, @oBtn1 ) }
	oBtn1:bAction := {|| AF250ExBut(1, @oLbx, @aAF250DOri, @aAF250Desc, @oBtn1, @cTexto, @oMemo)  }

	oBtn2 := SBUTTON():Create(oPanel3)
	oBtn2:cName := "oBtn2"
	oBtn2:cCaption := STR0082 //Desatribuir
	oBtn2:nLeft := 05
	oBtn2:nTop := 30
	oBtn2:nWidth := 80
	oBtn2:nHeight := 22
	oBtn2:lShowHint := .F.
	oBtn2:lReadOnly := .F.
	oBtn2:Align := 0
	oBtn2:lVisibleControl := .T.
	oBtn2:nType := 1
	oBtn2:bWhen := {|| AF250AtBt(2, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc, @oBtn2 ) }
	oBtn2:bAction := {|| AF250ExBut(2, @oLbx, @aAF250DOri, @aAF250Desc, @oBtn2, @cTexto, @oMemo)  }

	oBtn3 := SBUTTON():Create(oPanel3)
	oBtn3:cName := "oBtn3"
	oBtn3:cCaption := STR0083 //"Copiar"
	oBtn3:nLeft := 05
	oBtn3:nTop := 55
	oBtn3:nWidth := 80
	oBtn3:nHeight := 22
	oBtn3:lShowHint := .F.
	oBtn3:lReadOnly := .F.
	oBtn3:Align := 0
	oBtn3:lVisibleControl := .T.
	oBtn3:nType := 1
	oBtn3:bWhen := {|| AF250AtBt(3, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc, @oBtn3 ) }
	oBtn3:bAction := {|| AF250ExBut(3, @oLbx, @aAF250DOri, @aAF250Desc, @oBtn3, @cTexto, @oMemo)  }

	oBtn4 := SBUTTON():Create(oPanel3)
	oBtn4:cName := "oBtn4"
	oBtn4:cCaption := STR0084 //"Editar"
	oBtn4:nLeft := 05
	oBtn4:nTop := 80
	oBtn4:nWidth := 80
	oBtn4:nHeight := 22
	oBtn4:lShowHint := .F.
	oBtn4:lReadOnly := .F.
	oBtn4:Align := 0
	oBtn4:lVisibleControl := .T.
	oBtn4:nType := 1
	oBtn4:bWhen := {|| AF250AtBt(4, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc, @oBtn4 ) }
	oBtn4:bAction := {|| AF250ExBut(4, @oLbx, @aAF250DOri, @aAF250Desc, @oBtn4, @cTexto, @oMemo)  }

	oBtn5 := SBUTTON():Create(oPanel3)
	oBtn5:cName := "oBtn5"
	oBtn5:cCaption := STR0085 //"Limpar"
	oBtn5:nLeft := 05
	oBtn5:nTop := 105
	oBtn5:nWidth := 80
	oBtn5:nHeight := 22
	oBtn5:lShowHint := .F.
	oBtn5:lReadOnly := .F.
	oBtn5:Align := 0
	oBtn5:lVisibleControl := .T.
	oBtn5:nType := 1
	oBtn5:bWhen := {|| AF250AtBt(5, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc, @oBtn5 ) }
	oBtn5:bAction := {|| AF250ExBut(5, @oLbx, @aAF250DOri, @aAF250Desc, @oBtn5, @cTexto, @oMemo)  }
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Folder Total do Rateio                                       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For j := 1 To Len( oFolder:aDialogs )
		oFolder:aDialogs[j]:oFont := oDlg:oFont
	Next

	oGet:oBrowse:bChange:= {|| AF250CtImp(@aAF250Imp, @oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp), AF250CtDesc( @aAF250Desc, @oFolder, @oMemo, @oPanel3, @cTexto, @oPanel4), AF250AtBtR({@oBtn1,@oBtn2,@oBtn3,@oBtn4,@oBtn5}, @oMemoOri, @cTextoOri, aAF250DOri, @oLBx), oGet:oBrowse:SetFocus()  }
	oLBx:bChange := {|| AF250AtBtR({@oBtn1,@oBtn2,@oBtn3,@oBtn4,@oBtn5}, @oMemoOri, @cTextoOri, aAF250DOri, @oLBx), oLBx:SetFocus() } //, @oLbx, @aAF250DOri, @oGet, @oMemo, aAF250Desc ) }
	AF250CtImp(@aAF250Imp, @oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp)

	nTotICMS := 0
	aEval( aAF250Imp, {|ICMS| nTotICMS += If( ICMS[1]=='ICMS', ICMS[5], 0) } )


	ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,IIf(Af250TudOk(@aAF250Imp, @aAF250Desc, @oFolder, @oGetDadTot, @oGetDadImp, @aAF250DOri),oDlg:End(),nOpca := 0),.F.},{|| nOpca:=2,oDlg:End()},,aButtons)
	If nOpca == 0 .Or. nOpca == 2
		A250Desmar(nIndex)
		While GetSx8Len() > nSaveSx8Len
			RollBackSx8()
		EndDo
	Elseif nOpca == 1
		AF250GRAVA(cBaseDe,cBaseAte,nSaveSx8Len, nIndex,nOpca, aAF250Imp, aAF250Desc)
	Endif
	Exit
Enddo

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ AF250Bem   ³ Autor ³ Alice Y. Yamamoto     ³ Data ³ 20.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o novo bem ja' existe                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ ATFA250                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250Bem( cBase , cItemAtivo )
Local lExist := .F.
Local nOrdem := 0 , nPosicao := 0

dbSelectarea( "SN1" )
nOrdem := IndexOrd()
nPosicao := Recno()

dbSetOrder( 1 )
lExist := Iif( dbSeek( xFilial("SN1") + cBase + cItemAtivo ) ,.T. , .F. )

If lExist
    HELP(" ",1,"AF40JAEXIS")
Endif

dbSelectArea( "SN1" )
dbSetOrder( nOrdem )
dbGoto( nPosicao )

Return IIf( lExist , .F. , .T. )

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA250Check³ Autor ³ Alice Y Yamamoto      ³ Data ³ 10.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Retorna expressao para Indice Condicional                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FA250Check()                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function FA250Check(cBaseDe,cBaseAte)
Local cFiltro := ""

cFiltro := 'N3_FILIAL = "' + xFilial("SN3") + '" .AND. '
cFiltro += 'N3_CBASE >= "' + cBaseDe        + '" .AND. '
cFiltro += 'N3_CBASE <= "' + cBaseAte       + '" .AND. '
cFiltro += 'N3_BAIXA < "1"'
If mv_par04 == 2
	cFiltro += '.And. N3_TIPO = "03" '
Else
	cFiltro += '.And. (N3_TIPO = "01" .OR. N3_TIPO = "03") '
Endif

If ExistBlock("AF250FILTR")
	cFilAux := ExecBlock( "AF250FILTR", .F., .F., {cFiltro} )
	If Valtype( cFilAux ) == "C"
		cFiltro := cFilAux
	EndIf
Endif

Return cFiltro

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o   ³a250Display ³ Autor ³ Alice Y Yamamoto      ³ Data ³ 05.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o³Atualiza tela de sele‡ao de registros da baixa autom tica     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe  ³a250Display ( cMarca,lInverte,nValor,nQtdBem,oValor,oQtda )   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso     ³ ATFA250                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function a250Display(cMarca,lInverte,oValor,oQtda,lMarc)
Default lMarc := .F.

If IsMark("N3_OK",cMarca,lInverte)
	If A250VldAquis(SN3->N3_CBASE,SN3->N3_ITEM,lMarc)
		nValor  += (SN3->N3_VORIG1 + SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			AtfMultMoe(,,{|x| aValorOri[x] += (SN3->&("N3_VORIG"+Alltrim(Str(x)))+SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) + If(x=1,SN3->N3_VRCACM1,0)) })
		Else
			aValorOri[1] += (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)
			aValorOri[2] += SN3->N3_VORIG2+SN3->N3_AMPLIA2
			aValorOri[3] += SN3->N3_VORIG3+SN3->N3_AMPLIA3
			aValorOri[4] += SN3->N3_VORIG4+SN3->N3_AMPLIA4
			aValorOri[5] += SN3->N3_VORIG5+SN3->N3_AMPLIA5
		EndIf

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			AtfMultMoe(,,{|x| aValDepAc[x]	+= SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
		Else
			aValDepAc[1] += SN3->N3_VRDACM1
			aValDepAc[2] += SN3->N3_VRDACM2
			aValDepAc[3] += SN3->N3_VRDACM3
			aValDepAc[4] += SN3->N3_VRDACM4
			aValDepAc[5] += SN3->N3_VRDACM5
		EndIf
		nQtdBem++
	Else
		RecLock("SN3",.f.)
		SN3->N3_OK := "  "
		MsUnlock()
	Endif
Else
	nValor  -= (SN3->N3_VORIG1 + SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValorOri[x] -= (SN3->&("N3_VORIG"+Alltrim(Str(x)))+SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) + If(x=1,SN3->N3_VRCACM1,0)) })
	Else
		aValorOri[1] -= (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)
		aValorOri[2] -= SN3->N3_VORIG2+SN3->N3_AMPLIA2
		aValorOri[3] -= SN3->N3_VORIG3+SN3->N3_AMPLIA3
		aValorOri[4] -= SN3->N3_VORIG4+SN3->N3_AMPLIA4
		aValorOri[5] -= SN3->N3_VORIG5+SN3->N3_AMPLIA5
	EndIf

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValDepAc[x]	-= SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
	Else
		aValDepAc[1] -= SN3->N3_VRDACM1
		aValDepAc[2] -= SN3->N3_VRDACM2
		aValDepAc[3] -= SN3->N3_VRDACM3
		aValDepAc[4] -= SN3->N3_VRDACM4
		aValDepAc[5] -= SN3->N3_VRDACM5
	EndIf

	nQtdBem--
	nQtdBem:= Iif(nQtdBem < 0, 0, nQtdBem)
EndIf

oValor:Refresh()
oQtda:Refresh()

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A250Desmar  ³ Autor ³ Alice Yamamoto        ³ Data ³ 20.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Desmarca os bens se NAO confirmar a baixa                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³A250Desmar()                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA250                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function A250Desmar(nIndex)
Local aArea := { Alias(), IndexOrd(), Recno()}

dbSelectArea("SN3")
dbSetOrder(nIndex+1)
dbGoTop()
While !EOF()
	If !Empty(SN3->N3_OK)
		RecLock("SN3",.f.)
		SN3->N3_OK := "  "
		MsUnlock()
	Endif
	dbSkip()
	Loop
EndDo

nQtdBem := 0
nValor  := 0

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250DBEVA³ Autor ³ Wagner Xavier         ³ Data ³ 20/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Trata o dbeval para marcar e desmarcar item                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250DBEVA(ExpN1,ExpD1,ExpD2)                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1 = Limite de valor para marcar titulos                ³±±
±±³          ³ ExpD1 = Data de vencimento inicial a considerar            ³±±
±±³          ³ ExpD2 = Data de vencimento final a considerar              ³±±
±±³          ³ ExpN1 = Verifica se titulo entrara marcado ou nao          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250DBEVA³ Autor ³ Wagner Xavier         ³ Data ³ 20/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Trata o dbeval para marcar e desmarcar item                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250DBEVA(ExpN1,ExpD1,ExpD2)                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ ATFA250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function AF250DbEva(cMarca,lTela)

Local lProjeto := .F.
Local lCiap := .F.

SN1->(MsSeek(xFilial("SN1") + SN3->(N3_CBASE + N3_ITEM)))

//Verifica se houve movimentos de apropriacao (CIAP)
If !Empty(SN1->N1_CODCIAP)
	DbSelectArea("SF9")
	DbSetOrder(1)
	If DbSeek(xFilial("SF9")+ SN1->N1_CODCIAP)
		DbSelectArea("SFA")
		DbSetOrder(1)
		DbSeek(xFilial("SFA")+SF9->F9_CODIGO)
		While SFA->(!Eof() .And.  FA_FILIAL+FA_CODIGO == xFilial("SFA")+SF9->F9_CODIGO )
			If SFA->FA_DATA > dDataBase
				lCiap := .T.
			EndIf			
			SFA->(DbSkip())
		Enddo
		
		If lCiap
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Realiza a inversao³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			RecLock("SN3",.F.)
			SN3->N3_OK := IIF(Empty(SN3->N3_OK),cMarca,Space(2) ) 
			MsUnlock()
		EndIf
	Endif
EndIf

If !SN1->N1_STATUS $ "2|3"
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Realiza a inversao³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	RecLock("SN3",.F.)
	SN3->N3_OK := IIF(Empty(SN3->N3_OK),cMarca,Space(2) )
	MsUnlock()
Endif

/*
 * Se os ativo for do tipo Orçamento de Despesa de Provisão ou Provisão de Despesa para não permitir a transferência, deixar desmarcado
 */
If AllTrim(SN1->N1_PATRIM) $ "O|V"
	SN3->(RecLock("SN3",.F.))
	SN3->N3_OK := Space(2)
	SN3->(MsUnlock())
EndIf

//Validação do projeto do Ativo
lProjeto := .F.
If ATFXVerPrj(SN3->N3_CBASE,SN3->N3_ITEM)
	RecLock("SN3",.F.)
	SN3->N3_OK :=Space(2)
	MsUnlock()
	lProjeto := .T.
EndIf

//MRG
//Se o bem possuir bens gerenciais (10, 13 ou 15) não deve ser marcado
IF AF250TpGer(SN3->N3_CBASE,SN3->N3_ITEM)
	RecLock("SN3",.F.)
	SN3->N3_OK :=Space(2)
	MsUnlock()
Endif

If SN3->N3_OK == cMarca
	nValor     += (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValorOri[x] += (SN3->&("N3_VORIG"+Alltrim(Str(x)))+SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) + If(x=1,SN3->N3_VRCACM1,0)) })
	Else
		aValorOri[1] += (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)
		aValorOri[2] += SN3->N3_VORIG2+SN3->N3_AMPLIA2
		aValorOri[3] += SN3->N3_VORIG3+SN3->N3_AMPLIA3
		aValorOri[4] += SN3->N3_VORIG4+SN3->N3_AMPLIA4
		aValorOri[5]+= SN3->N3_VORIG5+SN3->N3_AMPLIA5
	EndIf

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValDepAc[x]	+= SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
	Else
		aValDepAc[1] += SN3->N3_VRDACM1
		aValDepAc[2] += SN3->N3_VRDACM2
		aValDepAc[3] += SN3->N3_VRDACM3
		aValDepAc[4] += SN3->N3_VRDACM4
		aValDepAc[5] += SN3->N3_VRDACM5
	EndIf
	nQtdBem ++
ElseIf Empty(SN3->N3_OK) .And. lTela .And. !SN1->N1_STATUS $ "2|3" .and. !lProjeto
	nValor     -= (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValorOri[x] -= (SN3->&("N3_VORIG"+Alltrim(Str(x)))+SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) + If(x=1,SN3->N3_VRCACM1,0)) })
	Else
		aValorOri[1] -= (SN3->N3_VORIG1+SN3->N3_AMPLIA1 + SN3->N3_VRCACM1)
		aValorOri[2] -= SN3->N3_VORIG2+SN3->N3_AMPLIA2
		aValorOri[3] -= SN3->N3_VORIG3+SN3->N3_AMPLIA3
		aValorOri[4] -= SN3->N3_VORIG4+SN3->N3_AMPLIA4
		aValorOri[5] -= SN3->N3_VORIG5+SN3->N3_AMPLIA5
	Endif
	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| aValDepAc[x]	-= SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
	Else
		aValDepAc[1] -= SN3->N3_VRDACM1
		aValDepAc[2] -= SN3->N3_VRDACM2
		aValDepAc[3] -= SN3->N3_VRDACM3
		aValDepAc[4] -= SN3->N3_VRDACM4
		aValDepAc[5] -= SN3->N3_VRDACM5
	EndIf
	nQtdBem --
Endif

Return Nil
/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250LinOk³ Autor ³ Alice Y Yamamoto      ³ Data ³ 12.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Valida a linha da getdados                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³             												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250LinOK(aAF250Imp,oFolder,aAF250Desc, oGetDadTot, oGetDadImp)
Local nPosBase := Ascan(aHeader, {|x| Alltrim(x[2]) == "N1_CBASE"})
Local nPosItem := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_ITEM"})
Local nPosDescr:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_DESCRIC"})
Local nPosChapa:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CHAPA"})
Local nPosHisto:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_HISTOR"})
Local nPosCCont:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_CCONTAB"})
Local nPosOrig1:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG1"})

Local nPosValICMS	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_ICMSAPR"} )
Local nPosCIAP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CIAP"} )
Local nPosCalcP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CALCPIS"} )
Local nPosMesCP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_MESCPIS"} )
Local nPosCdForn	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_FORNEC"} )
Local nPosLjForn	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_LOJA"} )

Local cMesCPis		:= GetMv('MV_ATFMAPR',.T.,'0/12/24/48')
Local nA			:= 0
Local nSomaICMS		:= 0
Local nPosImpCiap 	:= IIF(Type("oGetDadImp") == "U",0,Ascan(oGetDadImp:aHeader, {|x| Alltrim(x[2])  == "N1_CIAP"} ))
Local nPosImpCPis 	:= IIF(Type("oGetDadImp") == "U",0,Ascan(oGetDadImp:aHeader, {|x| Alltrim(x[2])  == "N1_CALCPIS"} ))
Local nPosImpMPis 	:= IIF(Type("oGetDadImp") == "U",0,Ascan(oGetDadImp:aHeader, {|x| Alltrim(x[2])  == "N1_MESCPIS"} ))
Local cChaveImp		:= ""

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Nao valida linha deletada                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aCols[n][nUsado+1]
	Return .T.
Endif

IF nPosCalcP >0 .AND. nPosMesCP > 0 .AND. nPosCIAP > 0

	If aCols[n][nPosCalcP]$ '1/2' .and. aCols[n][nPosMesCP] <> 0
		Help(" ",1,"AF250MESPIS",,STR0086+CRLF+STR0087+CRLF+STR0088+AllTrim(Str(n)),1,0) //"O campo [Meses Cl.Pis] deve estar zerado para a condição de calculo de PIS (SIM ou NÃO) , ajuste a linha "
		Return .F.
	ElseIf aCols[n][nPosCalcP]=='3' .and. aCols[n][nPosMesCP]==0
		Help(" ",1,"AF250MESPIS",,STR0089+CRLF+STR0090+AllTrim(Str(n)),1,0) //"é obrigatorio o preenchimento do campo [Meses Cl.Pis], ajuste a linha "
		Return .F.
	ElseIf aCols[n][nPosCalcP]=='3' .and. !(AllTrim(Str(Int(aCols[n][nPosMesCP]))) $ cMesCPis)
		Help(" ",1,"AF250MESPIS",,STR0091+CRLF+STR0092+CRLF+STR0093+AllTrim(Str(n)),1,0) //'é obrigatorio o preenchimento do campo [Meses Cl.Pis] com um valor válido, verifique o parâmetro MV_ATFMAPR, ajuste a linha '
		Return .F.
	ElseIf aCols[n][nPosCalcP]=='3' .and. aScan( aAF250Imp, {|MesImp| MesImp[3] == aCols[n][nPosMesCP] } ) == 0
		Help(" ",1,"AF250MCIAP",,STR0094+CRLF+STR0095+CRLF+STR0096+AllTrim(Str(n)),1,0)
		Return .F.
	EndIf

	cChaveImp := Alltrim(aCols[n][nPosCalcP]) + cValtoChar(aCols[n][nPosMesCP])+ Alltrim(aCols[n][nPosCIAP])
	If aScan(oGetDadImp:aCols,{|aItem| Alltrim(aItem[nPosImpCPis]) + cValtoChar(aItem[nPosImpMPis]) + Alltrim(aItem[nPosImpCiap]) ==  cChaveImp}) <= 0
		Help(" ",1,"AF250REGRA",,STR0121+cValTochar(n),1,0) // "Combinaçao de impostos invalida na linha "
		Return .F.
	EndIf
ENDIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se N1_CBASE+N1_ITEM ja existe no SN1      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(aCols[n][nPosBase]) .And. !Empty(aCols[n][nPosItem])
	dbSelectArea("SN1")
	dbSetOrder(1)
	If dbSeek(xFilial("SN1")+aCols[n][nPosBase]+aCols[n][nPosItem])
		Help(" ",1,"JAGRAVADO")
		Return .F.
	Endif
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Os campos cBase, n1_item, descricao, historico, cta contabil,³
//³ Valor na Moeda1 e na moeda3.                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Empty(aCols[n][nPosBase])  .Or. Empty(aCols[n][nPosItem]) .Or.;
	Empty(aCols[n][nPosDescr])  .Or. Empty(aCols[n][nPosHisto]) .Or.;
	Empty(aCols[n][nPosCCont])
	Help(" ",1,"AF250BRAN")
	Return .F.
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ O cpo val original nao pode ficar em branco.       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Empty(aCols[n][nPosOrig1])
	Help(" ",1,"AF250BRAN")
	Return .F.
Endif

If !Af250Chapa(aCols[n][nPosChapa])
	Return .F.
Endif

IF cPaisLoc == "COL" .And. nPosCdForn > 0 .And. nPosLjForn > 0
	IF EMPTY(aCols[n][nPosCdForn]) .OR. EMPTY(aCols[n][nPosLjForn])
		HELP("",1,"AF010FORNE")
		Return .F.
	ELSE
    	SA2->(DbSetOrder(1))
    	IF SA2->(DbSeek(xFilial("SA2")+aCols[n][nPosCdForn]+aCols[n][nPosLjForn]))
			IF EMPTY(SA2->A2_CGC)
				HELP("",1,"AF010NONIT")
				Return .F.
			ENDIF
    	ELSE
			HELP("",1,"AF010NOFORNEC")
			Return .F.
    	ENDIF
	ENDIF
ENDIF

If ExistBlock('AF250LOK')
	If !ExecBlock( 'AF250LOK', .F., .F., @aAF250Imp )
		Return .F.
	EndIf
EndIf

IF nPosCalcP >0 .AND. nPosMesCP > 0 .AND. nPosCIAP > 0

	For nA := 1 To Len( aAF250Imp )
		nSomaICMS := 0
		aEval( aCols, {|Linha| nSomaICMS+=If(	Linha[nPosCalcP] == aAF250Imp[nA][2] .and.;
		Linha[nPosMescP] == aAF250Imp[nA][3] .and.;
		IIf(lN1Ciap,Linha[nPosCiap] == If(aAF250Imp[nA][4],'1','2'),.T.) , Linha[nPosValICMS] , 0 )  } )
		aAF250Imp[nA][6] := nSomaICMS
	Next nA

	AF250CtImp(@aAF250Imp, @oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp)

ENDIF

Return .T.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³af250TudOk³ Autor ³ Alice Y Yamamoto      ³ Data ³ 05.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa a tela digitada									  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250TudOk)												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ ATFA250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function af250TudOK(aAF250Imp, aAF250Desc, oFolder, oGetDadTot, oGetDadImp, aAF250DOri)
Local nPosBase 	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CBASE"})
Local nPosItem 	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_ITEM"})
Local nPosDescr	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_DESCRIC"})
Local nPosChapa	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CHAPA"})
Local nPosHisto	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_HISTOR"})
Local nPosCCont	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_CCONTAB"})
Local nPosOrig1	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG1"})

Local i,j, nA, nSomaICMS, nPos := 0
Local nTamDecImp	:= TamSx3('N1_ICMSAPR')[2]
Local nPosValICMS	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_ICMSAPR"} )
Local nPosCIAP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CIAP"} )
Local nPosCalcP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_CALCPIS"} )
Local nPosMesCP		:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_MESCPIS"} )
Local nPosCdForn	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_FORNEC"} )
Local nPosLjForn	:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N1_LOJA"} )
Local cMesCPis		:= GetMv('MV_ATFMAPR',.T.,'0/12/24/48')
Local lTotalICMS	:= .T.

IF nPosCalcP >0 .AND. nPosMesCP > 0 .AND. nPosCIAP > 0

	AF250CtImp(@aAF250Imp, @oFolder, @aAF250Desc, @oGetDadTot, @oGetDadImp)

	For nA := 1 To Len( aAF250Imp )
		If Upper(AllTrim(aAF250Imp[nA][1])) == 'ICMS'
			nSomaICMS := 0
			aEval( aCols, {|Linha| nSomaICMS+=If(	Linha[nPosCalcP] == aAF250Imp[nA][2] .and.;
													Linha[nPosMescP] == aAF250Imp[nA][3] .and.;
													IIf(lN1Ciap,Linha[nPosCiap] == If(aAF250Imp[nA][4],'1','2'),.T.) , Linha[nPosValICMS] , 0 )  } )
			aAF250Imp[nA][6] := nSomaICMS
		EndIf
		If Round(NoRound(aAF250Imp[nA][5],nTamDecImp+1),nTamDecImp) <> Round(NoRound(aAF250Imp[nA][6],nTamDecImp+1),nTamDecImp)
			Help(" ",1,"AF250ICMS",,STR0097+CRLF+STR0098,1,0) //'Ainda existe saldo de Impostos a apropriar, verifique a Guia DETALHES DOS IMPOSTOS!'
			Return .F.
		EndIf
	Next nA

	nSomaICMS := 0
	aEval( aAF250Imp, {|Imp| nSomaICMS += If(AllTrim(Upper(Imp[1]))=='ICMS',Imp[6],0) } )

	If Round(NoRound(nSomaICMS,nTamDecImp+1),nTamDecImp) <> Round(NoRound(nTotICMS,nTamDecImp+1),nTamDecImp)
		Help(" ",1,"AF250ICMS",,STR0097+CRLF+STR0098,1,0) //'Ainda existe saldo de ICMS a apropriar, verifique a Guia DETALHES DOS IMPOSTOS!'
		Return .F.
	EndIf

ENDIF

For i:=1 to Len(aCols)
	If !aCols[i][nusado+1]

		IF nPosCalcP >0 .AND. nPosMesCP > 0 .AND. nPosCIAP > 0

			If aCols[i][nPosCalcP]=='1/2' .and. aCols[i][nPosMesCP] <> 0
				Help(" ",1,"AF250MESPIS",,STR0086+CRLF+STR0087+CRLF+STR0088+AllTrim(Str(n)),1,0)
				Return .F.
			ElseIf aCols[i][nPosCalcP]=='3' .and. aCols[i][nPosMesCP]==0
				Help(" ",1,"AF250MESPIS",,STR0089+CRLF+STR0090+AllTrim(Str(n)),1,0)
				Return .F.
			ElseIf aCols[i][nPosCalcP]=='3' .and. !(AllTrim(Str(Int(aCols[i][nPosMesCP]))) $ cMesCPis)
				Help(" ",1,"AF250MESPIS",,STR0091+CRLF+STR0092+CRLF+STR0093+AllTrim(Str(n)),1,0)
				Return .F.
			EndIf

		ENDIF

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Os campos cBase, n1_item, descricao, historico, cta contabil,³
		//³ Valor na Moeda1 e na moeda3.                                 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Empty(aCols[i][nPosBase])  .Or. Empty(aCols[i][nPosItem]) .Or. Empty(aCols[i][nPosDescr]) .Or.;
			Empty(aCols[i][nPosHisto])  .Or. Empty(aCols[i][nPosCCont]) .Or.;
			Empty(aCols[i][nPosOrig1])
			Help(" ",1,"AF250BRAN")
			Return .F.
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ O cpo val original nao pode ficar em branco.       ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Empty(aCols[i][nPosOrig1])
			Help(" ",1,"AF250BRAN")
			Return .F.
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Campos obrigatorios nao podem ficar em branco      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For j:=1 to Len(aHeader)
			If Empty(aCols[i][j]) .AND. X3Obrigat(aHeader[j][2])
				Help(" ",1,"OBRIGAT2",,AllTrim(RetTitle(aHeader[j][2])),3,1)
				Return .F.
			Endif
		Next j

		If ! Af250Chapa(aCols[i][nPosChapa],i)
			Return .F.
		Endif

		IF cPaisLoc == "COL" .And. nPosCdForn > 0 .And. nPosLjForn > 0
			IF EMPTY(aCols[i][nPosCdForn]) .OR. EMPTY(aCols[i][nPosLjForn])
				HELP("",1,"AF010FORNE")
				Return .F.
			ELSE
		    	SA2->(DbSetOrder(1))
		    	IF SA2->(DbSeek(xFilial("SA2")+aCols[i][nPosCdForn]+aCols[i][nPosLjForn]))
					IF EMPTY(SA2->A2_CGC)
						HELP("",1,"AF010NONIT")
						Return .F.
					ENDIF
		    	ELSE
					HELP("",1,"AF010NOFORNEC")
					Return .F.
		    	ENDIF
			ENDIF
		ENDIF

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ O valor total nÆo pode ser menor q a soma dos rateios   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Str(nValor,19,2) != Str(nValRat,19,2)
			Help(" ",1,"AF250VALOR")
			Return .F.
		Endif
	Endif
Next i

If Mv_Par05 == 2 //Atribuir
	nPos := aScan( aAF250DOri, {|DscAtr| DscAtr[7] == 0 } )
	If nPos <> 0
		Help(" ",1,"AF250DSCEST",,STR0099+CRLF+STR0100,1,0) //'Ainda existem descrições para serem atribuidas,'###'Verifique a Guia [Descrição Estendida] '
		Return .F.
	EndIf
EndIf

If ExistBlock('AF250TOK')
	If !ExecBlock( 'AF250TOK', .f., .f., {@aAF250Imp,@aAF250Desc,@aAF250DOri} )
		Return .F.
	EndIf
EndIf

Return .T.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250CalcV³ Autor ³ Alice Y Yamamoto      ³ Data ³ 05.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o Val Original para outras moedas                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250CalcV() 												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250CalcV()

Local nPercent, nVorig1, nValAnt1

//********************************
// Controle de multiplas moedas  *
//********************************
Local PosICMS,	aPosOrig
Local aPosAc
//Local nPosOrig1, nPosOrig2, nPosOrig3, nPosOrig4, nPosOrig5, nPosICMS
//Local nPosAc1, nPosAc2, nPosAc3, nPosAc4, nPosAc5
Local nPosPerc
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
Local nX


If "N3_VORIG1" $ ReadVar() // Realiza a conversao somente a partir da moeda 1

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		aPosOrig	:= AtfMultPos(aHeader,"N3_VORIG")
		aPosAc		:= AtfMultPos(aHeader,"N3_VRDACM")
	Else
		aPosOrig := {0,0,0,0,0}
		aPosOrig[1] := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG1" })
		aPosOrig[2] := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG2" })
		aPosOrig[3] := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG3" })
		aPosOrig[4] := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG4" })
		aPosOrig[5] := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VORIG5" })

		aPosAc := {0,0,0,0,0}
		aPosAc[1]   := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VRDACM1"})
		aPosAc[2]   := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VRDACM2"})
		aPosAc[3]   := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VRDACM3"})
		aPosAc[4]   := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VRDACM4"})
		aPosAc[5]   := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_VRDACM5"})
	EndIf

	nPosPerc  := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_PERC" })

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ nValor  Valor inicial a ser rateado                  ³
	//³ O valor rateado n„o pode ser maior que o valor origem³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nValAnt1:= aCols[n][aPosOrig[1]]

	nVorig1 := &(ReadVar())

	If QtdComp(nVorig1) > QtdComp(nValor)
		Help(" ",1,"AF250VALOR")
		Return .F.
	Endif

	If !aCols[n][nUsado+1]
		nValRat  := nValRat+nVorig1-nValAnt1
		If QtdComp(nValRat) > QtdComp(nValor)
			Help(" ",1,"AF250VALOR")
			nValRat := nValRat-nVorig1+nValAnt1
			Return .F.
 		Endif

		nPercent := NoRound(nVorig1/aValorOri[1],10)
		//********************************
		// Controle de multiplas moedas  *
		//********************************

		If lMultMoed
		  	For nX := 2 to __nQuantas
	   			AtfMultMoe(,,{|x| aCols[n][aPosOrig[nX]] := aValorOri[nX] * nPercent })
		  	Next
		Else
			aCols[n][aPosOrig[2]] := aValorOri[2] * nPercent
			aCols[n][aPosOrig[3]] := aValorOri[3] * nPercent
			aCols[n][aPosOrig[4]] := aValorOri[4] * nPercent
			aCols[n][aPosOrig[5]] := aValorOri[5] * nPercent
		EndIf

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			AtfMultMoe(,,{|x| aCols[n][aPosAc[x]]   := aValDepAc[x] * nPercent })
		Else
			aCols[n][aPosAc[1]]   := aValDepAc[1] * nPercent
			aCols[n][aPosAc[2]]   := aValDepAc[2] * nPercent
			aCols[n][aPosAc[3]]   := aValDepAc[3] * nPercent
			aCols[n][aPosAc[4]]   := aValDepAc[4] * nPercent
			aCols[n][aPosAc[5]]   := aValDepAc[5] * nPercent
		EndIf
		aCols[n][nPosPerc]  := Round(nPercent*100,2)

	Else
		Help(" ",1,"AF250VALOR")
		Return .F.
	Endif

Endif

Return .t.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250ExisC³ Autor ³ Alice Y Yamamoto      ³ Data ³ 11.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica se o registro ja existe no SN1                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250ExisC()												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250ExisC()
Local aArea := { Alias(), IndexOrd() }
Local lRet  := .T.
Local cItem := &(Readvar())
Local nx

If (!Empty(aCols[n][1]) .and. !Empty(cItem))
	dbSelectArea("SN1")
	dbSetOrder(1)
	If dbSeek(xFilial("SN1")+aCols[n][1]+cItem)
		Help(" ",1,"JAGRAVADO")
		lRet := .F.
		Return lRet
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Verifico se o cbase+item digitado e igual a algum an-³
	//³ terior digitado na getdados.                         ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nx := 1 to Len(aCols)-1
		If (aCols[nx][1]+aCols[nx][2]) == (aCols[n][1] + cItem)
			Help(" ",1,"JAGRAVADO")
			lRet := .F.
			Return lRet
		Endif
	Next
Endif

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
Return lRet

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250Chapa³ Autor ³ Alice Y Yamamoto      ³ Data ³ 11.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica se a chapa ja existe no SN1 ou na getdados         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250Chapa() 												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250Chapa(cChapa, nLinha)
Local aArea := GetArea()
Local lRet  := .T.
Local nPosChapa, i
Local lRepete

DEFAULT cChapa := &(Readvar())
DEFAULT nLinha := n

lRepete :=  IIf(mv_par03 == 1,.T.,.F.)

nPosChapa := ASCAN(aHeader,{|x| Alltrim(x[2])  == "N1_CHAPA" })

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifico se a chapa ja existe no SN1                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ BOPS 00000120962 - CENTRALIZACAO DA VALIDACAO DA CHAPA E P.E.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lRet := AF010CHAPA(cChapa,lRepete)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se esta chapa ja existe em linha anterior na getdados   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF lRet .AND. !lRepete

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ BOPS 00000120962 - CENTRALIZACAO DA VALIDACAO DA CHAPA E P.E.³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ExistBlock("AF250CHP")

		lRet := ExecBlock("AF250CHP",.F.,.F.,{cChapa,lRepete,nPosChapa,aCols})
		lRet := IIF(ValType(lRet) == "L",lRet,.F.)

	ELSE
		FOR i := 1 to Len(aCols)
			IF aCols[i][nPosChapa] == cChapa .And. i != nLinha
				Help(" ",1,"AFA010CHAP")
				lRet := .F.
				EXIT
			ENDIF
		NEXT
	ENDIF
ENDIF

RestArea(aArea)
Return lRet

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250TxDep³ Autor ³ Alice Y Yamamoto      ³ Data ³ 11.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Preencher a taxa de deprecia‡„o nas outras moedas           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250TxDep() 												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250TxDep()
Local aArea := { Alias(), IndexOrd() }
Local lRet  := .T.
Local nTaxa := &(Readvar())

//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aPosTxDp	:= AtfMultPos(aHeader,"N3_TXDEPR")
Else
	aPosTxDp	:= {0,0,0,0,0}
	aPosTxDp[2]:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_TXDEPR2"})
	aPosTxDp[3]:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_TXDEPR3"})
	aPosTxDp[4]:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_TXDEPR4"})
	aPosTxDp[5]:= Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_TXDEPR5"})
EndIf

If !Empty(nTaxa)
	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| If(x=1,.F.,acols[n][aPosTxDp[x]] := nTaxa)  })
	Else
		acols[n][aPosTxDp[2]] := nTaxa
		acols[n][aPosTxDp[3]] := nTaxa
		acols[n][aPosTxDp[4]] := nTaxa
		acols[n][aPosTxDp[5]] := nTaxa
	EndIf
Endif

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
Return lRet

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250Grava³ Autor ³ Alice Y Yamamoto      ³ Data ³ 11.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Grava os dados do acols e atualiza os arquivos              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250Grava() 												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250Grava(cBaseDe,cBaseAte,nSaveSx8Len, nIndex,nOpca, aAF250Imp, aAF250Desc)
Local nx,ny,nProxRec:=0
Local cPadrao := "835"
Local lPadrao := VerPadrao(cPadrao)
Local cMoedaAtf := GetMV("MV_ATFMOED")
Local cLoteAtf
Local lPrim     := .T.
Local nTotal    := 0
Local lContabiliza:= .T.
Local nPosBase := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_CBASE"})
Local nPosItem := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_ITEM"})
Local nPosTipo := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_TIPO"})
Local nPosAquis:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_AQUISIC"})
Local nPosDescr:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_DESCRIC"})
Local nPosQuant:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_QUANTD"})
Local nPosIcmsApr := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_ICMSAPR"})
Local nPosSubCdep := Ascan(aHeader, {|x| Alltrim(x[2])  == "N3_SUBCDEP"})

//Dados para gravacao do CIAP
Local nPoslCiap		:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_CIAP"})
Local nPosFornec	:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_FORNEC"})
Local nPosLoja		:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_LOJA"})
Local nPosNfSerie	:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == SerieNfId("SN1",3,"N1_NSERIE") })
Local nPosNFiscal	:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_NFISCAL"})

Local lA250GRSN4 := ExistBlock("A250GRSN4")
Local cNewCiap	 := ""
Local cERRCIAP	 := ""
Local aLogErro	 := {}
Local nLinhas	 := 0
Local nPosDesc	 := 0
Local cIDMOV	:= ""
Local cTpSaldo	:= ""
Local lSN3Saldo := .T.
Local cOcorr 	:= ""
Local aDadosComp :={}
Local aValores   := {}
Local nPosSn3		:= 0
Local cPadAnt		:= ""
Local lPadAnt
// Adicionado Ciap
Local nSf9Ciap   := 0
Local nSf9Estorn := 0
Local nSldParc   := 0
Local nQtdParc   := 0
Local nSf9SldApr := 0
Local nSF9Aux    := 0
Local nLinha	 := 0
Local cSF9_CODBAIX:= " "
Local lOnOff   	:= .T.
Local lAtfScdp  := GetMv("MV_ATFSCDP") 

Local cTypes10		:= IIF(lIsRussia,"/" + AtfNValMod({1}, "/"),"") // CAZARINI - 24/03/2017 - If is Russia, add new valuations models - main models
Local cTypesNM		:= IIF(lIsRussia,"/" + AtfNValMod({3,4}, "/"),"") // CAZARINI - 24/03/2017 - If is Russia, add new valuations models - 17 and 16 models
Private cArquivo
Private nHdlPrv

AF250ChkCiap()

nValorOr := 0
nValorDp := 0
nValorCo := 0
nValorCd := 0
nValBxOr := 0
nValBxDp := 0
nValBxCo := 0
nValBxCd := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica o n£mero do Lote do m¢dulo Ativo Fixo     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cLoteAtf := LoteCont("ATF")

lOnOff := MV_PAR06 == 1
lContabiliza := MV_PAR01 == 1

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³1¦ PARTE - EFETUO A BAIXA DOS ADIANTAMENTOS DO SN1, SN3, SN4 E ATUALIZO ³
//³  o SN5/SN6                                                             ³
//³2¦ PARTE - GERO OS NOVOS REGISTROS (BENS DO TIPO 01) NO SN1, SN3, SN4 e ³
//³  ATUALIZO O SN5/SN6.                                                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ 1¦ Parte - baixo do SN3, SN1, SN4 todos os bem marcados para serem bai-³
//³  xados atualizo o SN5/SN6. Baixo os bem com cMarca.                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Begin Transaction

PcoIniLan("000366")
dbSelectArea("SN3")
dbSetOrder(nIndex + 1)
dbSeek(xFilial("SN3")+cBaseDe, .T.)
While !Eof() .And. xFilial("SN3") == SN3->N3_FILIAL .And. SN3->N3_CBASE <= cBaseAte

	nValBxOr := 0
	nValBxDp := 0
	nValBxCo := 0
	nValBxCd := 0

	If Val(SN3->N3_BAIXA) != 0
		dbSkip()
		Loop
	Endif

	If SN3->N3_OK != cMarca
		dbSkip()
		Loop
	Endif

	dbSelectArea("SN3")
	dbSkip()
	nProxRec := RecNo()
	dbSkip(-1)

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza arquivo Movimenta‡”es (Deprecia‡„o)                        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SN1")
	dbSetOrder(1)
	If dbSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM)
		Reclock("SN1")
		SN1->N1_BAIXA := dDataBase
		MsUnLock()

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Baixa do Registro de CIAP³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nSF9Aux := nSF9Estorn
		ATFBxaCiap(SN1->N1_CBASE,SN1->N1_ITEM,cMoedaAtf,'ATFA250',dDataBase,IIf(SN3->N3_TIPO=="03","15","01"),;
				  (SN3->N3_VORIG1+SN3->N3_AMPLIA1),SerieNfId('SN1',2,'N1_NSERIE'),SN1->N1_NFISCAL,@nSf9Ciap,@nSf9Estorn,@nSldParc,@nQtdParc, @cSF9_CODBAIX)
		nSf9Estorn += nSF9Aux
		nSf9Ciap += nSf9Ciap
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza SN3         ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	RecLock("SN3")
	SN3->N3_BAIXA   := IIf(SN3->N3_TIPO=="03","2","1")
	SN3->N3_IDBAIXA := "3"
	SN3->N3_DTBAIXA := dDataBase
	SN3->N3_CODBAIX := cCodRat
	If SN3->N3_TIPO $ ('01/03/10/16/17' + cTypes10 + cTypesNM)
		SN3->N3_BXICMS  := SN1->N1_ICMSAPR
	EndIf
	MsUnLock()

	nValBxOr := SN3->N3_VORIG1+SN3->N3_AMPLIA1
	nValBxDp := SN3->N3_VRDACM1
	nValBxCo := SN3->N3_VRCACM1
	nValBxCd := SN3->N3_VRCDA1

	// Alimenta aDiario
	AADD(aDiario,{"SN3",SN3->(recno()),cCodDiario,"N3_NODIA","N3_DIACTB"})

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Gera registro de movimenta‡„o         ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cOcorr 	   := IIf(SN3->N3_TIPO=="03","15","01") // Baixa por Transferencia
	aDadosComp := ATFXCompl( /*nTaxaMedia*/,/*nTxDepre*/,'08',cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
	aValores   := AtfMultMoe(,,{|x| (SN3->&("N3_VORIG"+Alltrim(Str(x))) + SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) + If(x=1,SN3->N3_VRCACM1,0))})
	If lSN3Saldo
		cTpSaldo := SN3->N3_TPSALDO
	EndIf
	ATFXMOV(cFilAnt,@cIDMOV,dDataBase,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"1",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

	PcoDetLan("000366","01","ATFA250")

	IF lA250GRSN4
		ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"1",SN4->N4_OCORR, SN4->N4_TIPOCNT})
	ENDIF


	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza arquivo movimenta‡„o (Corre‡„o)                               ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SN3->N3_VRCACM1 > 0
		cOcorr 	   := '07'
		aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),'08',cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
		aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
		aValores[1] := Round(SN3->N3_VRCACM1 , X3Decimal("N4_VLROC1") )
		If lSN3Saldo
			cTpSaldo := SN3->N3_TPSALDO
		EndIf
		ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"2",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

		IF lA250GRSN4
			ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"1",SN4->N4_OCORR, SN4->N4_TIPOCNT})
		ENDIF

	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza arquivo Movimenta‡”es (Corre‡„o da Deprecia‡„o)               ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SN3->N3_VRCDA1 > 0
		cOcorr 	   := '08'
		aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),'08',cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
		aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
		aValores[1] := Round(SN3->N3_VRCDA1 , X3Decimal("N4_VLROC1") )
		If lSN3Saldo
			cTpSaldo := SN3->N3_TPSALDO
		EndIf
		ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"5",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

		IF lA250GRSN4
			ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"1",SN4->N4_OCORR, SN4->N4_TIPOCNT})
		ENDIF
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza arquivo Movimenta‡”es (Deprecia‡„o)                           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SN3->N3_VRDACM1 > 0
		cOcorr 	   := "01"                //Deprecia‡„o
		aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),'08',cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
		aValores   := AtfMultMoe(,,{|x| SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
		If lSN3Saldo
			cTpSaldo := SN3->N3_TPSALDO
		EndIf
		ATFXMOV(cFilAnt,@cIDMOV,dDataBase,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"4",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

		IF lA250GRSN4
			ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"1",SN4->N4_OCORR, SN4->N4_TIPOCNT})
		ENDIF

	EndIf
	Af250Saldo("R", "+")

	If lPadrao   // Se existe o Lacto padrao
		If lOnOff
			If lContabiliza  //Contabilizo baixa
				If lPrim
					nHdlPrv := HeadProva(cLoteAtf,"ATFA250",Substr(cUsername,1,6),@cArquivo)
					lPrim := .F.
				Endif
				nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
			Endif
		EndIf
	Endif

	dbSelectArea("SN3")
	dbGoto(nProxRec)

EndDo


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ No AS400 o arquivo n„o pode estar com o filtro ativo na cria‡„o de³
//³ um registro novo. ( Est  fora da condi‡„o do filtro e n„o permite ³
//³ a grava‡„o do registro)                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
RetIndex("SN3")
Set Filter To

nValBxOr := 0
nValBxDp := 0
nValBxCo := 0
nValBxCd := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³2¦ Parte - Gero os novos registros (bens do tipo 01) no SN1, SN3, SN4 e ³
//³  atualizo o SN5/SN6. Os bens est„o no aCols.                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

For nx := 1 to Len(aCols)
	nValorOr := 0
	nValorDp := 0
	nValorCo := 0
	nValorCd := 0

	If !aCols[nx][Len(aCols[nx])]

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inclusao do novo registro de CIAP³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF IIf(lN1Ciap,aCols[nx][nPoslCiap] == "1",.F.) .AND. IIf(lN1Ciap,aCols[nx][nPosIcmsApr] > 0,.F.)
			IF !ATFGrvCiap(@cNewCiap,@cERRCIAP, aCols[nx][nPosDescr], aCols[nx][nPosFornec], aCols[nx][nPosLoja], aCols[nx][nPosNFiscal],;
							aCols[nx][nPosNfSerie], "" , "", dDataBase, dDataBase, aCols[nx][nPosIcmsApr], "ATFA250", "", 18, nLinha,;
							nSf9Ciap, nSf9Estorn, nSf9SldApr,nSldParc,nQtdParc, cSF9_CODBAIX ) //Devera ser calculado o percentual de ICMS com base no valor do item
				//Gravar LOG de ERRO
				aAdd( aLogErro, {dDataBase, aCols[nX], cERRCIAP} )

				ProcLogIni()
				ProcLogAtu("INICIO")
				ProcLogAtu("ERRO", STR0101, cMensagem) //'Cadastro Novo CIAP.'
				ProcLogAtu("FIM")
			ENDIF
		ENDIF

		RecLock("SN1",.T.)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Campos com tratamento especifico que nao estao no aCols³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		SN1->N1_FILIAL  := xFilial("SN1")
		SN1->N1_AQUISIC := aCols[nx][nPosAquis]
		SN1->N1_CODCIAP := cNewCiap

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Demais campos com conteudo no aCols ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For nY := 1 to Len(aHeader)
			If Alltrim(Upper(aHeader[nY][2])) $ "N1_FILIAL|N1_AQUISIC|N1_CODCIAP"  //cpos ja gravados acima
				Loop
			EndIf
			IF SUBSTR(aHeader[nY][2],1,2) == "N1" .AND. SN1->(FieldPos(aHeader[nY][2])) > 0
				SN1->&(aHeader[nY][2]) := aCols[nx][ny]
			ENDIF
		Next nY

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Campos com tratamento especifico que estao no aCols    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		SN1->N1_QUANTD  := IIf(aCols[nx][nPosQuant] = 0,1,aCols[nx][nPosQuant])
		FkCommit()

		RecLock("SN3",.T.)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Campos com tratamento especifico que nao estao no aCols³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		SN3->N3_FILIAL   := xFilial("SN3")
		SN3->N3_CBASE    := aCols[nx][nPosBase]
		SN3->N3_ITEM     := aCols[nx][nPosItem]
		SN3->N3_BAIXA    := "0"
		SN3->N3_IDBAIXA  := " "
		SN3->N3_SEQ      := "001"
		SN3->N3_CODBAIX  := cCodRat

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Demais campos com conteudo no aCols ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For nY := 1 to Len(aHeader)
			IF SUBSTR(aHeader[nY][2],1,2) == "N3" .AND. SN3->(FieldPos(aHeader[nY][2])) > 0
				SN3->&(aHeader[nY][2]) := aCols[nx][ny]
			ENDIF
		Next nY

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Campos com tratamento especifico que estao no aCols    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lAtfScdp
			SN3->N3_SUBCTA  := aCols[nx][nPosSubCdep]
		EndIf
		FkCommit()

		nPosSn3 := SN3->(Recno())

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Grava apontamento de produção ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If cPaisLoc $ "ARG|BRA"
			If SN3->N3_TPDEPR $ "4|5|8|9|"
				//Apontamento inicial de estimativa de produção - P0
				AF110GrvAp(nPosSn3,"P0")

				//Salva o LP anterior
				cPadAnt := cPadrao
				lPadAnt := lPadrao
				cPadrao := "870"		//Apontamento de estimativa de produção
				lPadrao := VerPadrao(cPadrao)
				If ValType(nHdlPrv) == "N" .And. nHdlPrv > 0 .And. lPadrao .and. lOnOff
					nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
				EndIf

				//Restaura o LP anterior
				cPadrao := cPadAnt
				lPadrao := lPadAnt

				If (SN3->N3_PRODACM > 0) .And. (SN3->N3_VRDACM1 > 0)
					//Apontamento de produção acumulada - P5
					AF110GrvAp(nPosSn3,"P5")
				EndIf
			EndIf
		EndIf

		nPosDesc := aScan( aAF250Desc, {|aDesc| aDesc[2] == nX } )
		If nPosDesc > 0
			For nLinhas := 1 To Len( aAF250Desc[nPosDesc][1] )
				RecLock( 'SN2', .T. )
				SN2->N2_FILIAL 	:= xFilial('SN3')
				SN2->N2_CBASE	:= aCols[nx][nPosBase]
				SN2->N2_ITEM	:= aCols[nx][nPosItem]
				SN2->N2_SEQUENC	:= StrZero( nLinhas, 2 )
				SN2->N2_TIPO	:= aCols[nx][nPosTipo]
				SN2->N2_HISTOR	:= aAF250Desc[nPosDesc][1][nLinhas][2]
				SN2->N2_SEQ		:= "001"
				//SN2->( MsUnLock() )
				FkCommit()
			Next nLinhas
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ BOPS 00000119360 - PONTO DE ENTRADA APOS SN3 e ANTES SN4 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistBlock("A250GRN3")
			Execblock("A250GRN3",.F.,.F.,{Acols[nX],nX})
		Endif

		nValorOr := SN3->N3_VORIG1+SN3->N3_AMPLIA1
		nValorDp := SN3->N3_VRDACM1
		nValorCo := SN3->N3_VRCACM1
		nValorCd := SN3->N3_VRCDA1

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza Arquivo de Movimenta‡”es                   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		cOcorr 	   := "16"		// Aquisicao por transferencia
		aDadosComp := ATFXCompl(/*nTaxaMedia*/,/*nTxDepre*/,/*cMotivo*/,cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
		aValores   := AtfMultMoe(,,{|x| ( SN3->&("N3_VORIG"+Alltrim(Str(x))) + SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) ) })
		If lSN3Saldo
			cTpSaldo := SN3->N3_TPSALDO
		EndIf
		ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"1",SN1->N1_QUANTD,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

		PcoDetLan("000366","01","ATFA250")

		IF lA250GRSN4
			ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"2",SN4->N4_OCORR, SN4->N4_TIPOCNT})
		ENDIF

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza arquivo movimenta‡„o (Corre‡„o)                               ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF SN3->N3_VRCACM1 > 0
			cOcorr 	   := "07"		 //Corre‡„o
			aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),/*cMotivo*/,cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
			aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
			aValores[1] := Round(SN3->N3_VRCACM1 , X3Decimal("N4_VLROC1") )
			If lSN3Saldo
				cTpSaldo := SN3->N3_TPSALDO
			EndIf
			ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"2",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

			IF lA250GRSN4
				ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"2",SN4->N4_OCORR, SN4->N4_TIPOCNT})
			ENDIF
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza arquivo Movimenta‡”es (Corre‡„o da Deprecia‡„o)               ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF SN3->N3_VRCDA1 > 0
			cOcorr 	   := "08"
			aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),/*cMotivo*/,cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
			aValores   := If(lMultMoed, AtfMultMoe(,,{|x| 0}) , {0,0,0,0,0} )
			aValores[1] := Round(SN3->N3_VRCDA1 , X3Decimal("N4_VLROC1") )
			If lSN3Saldo
				cTpSaldo := SN3->N3_TPSALDO
			EndIf
			ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"5",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)
			IF lA250GRSN4
				ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"2",SN4->N4_OCORR, SN4->N4_TIPOCNT})
			ENDIF
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza arquivo Movimenta‡”es (Deprecia‡„o)                           ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF SN3->N3_VRDACM1 > 0
			cOcorr 	   := "06" //Deprecia‡„o
			aDadosComp := ATFXCompl(/*nTaxaMedia*/, &(If(Val(cMoedaAtf)>9,'SN3->N3_TXDEP','SN3->N3_TXDEPR')+cMoedaAtf),/*cMotivo*/,cCodRat,/*cFilOrig*/,/*cSerie*/,/*cNota*/,/*nVenda*/,/*cLocal*/, SN3->N3_PRODMES )
			aValores   := AtfMultMoe(,,{|x| SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) })
			If lSN3Saldo
				cTpSaldo := SN3->N3_TPSALDO
			EndIf
			ATFXMOV(cFilAnt,@cIDMOV,SN3->N3_AQUISIC,cOcorr,SN3->N3_CBASE,SN3->N3_ITEM,SN3->N3_TIPO,SN3->N3_BAIXA,SN3->N3_SEQ,SN3->N3_SEQREAV,"4",0,cTpSaldo,,aValores,aDadosComp,,,,,lOnOff,cPadrao)

			IF lA250GRSN4
				ExecBlock("A250GRSN4",.F.,.F.,{nOpca,SN4->N4_TIPO,"2",SN4->N4_OCORR, SN4->N4_TIPOCNT})
			ENDIF
		EndIf


		Af250Saldo("Q", "+")

		If ExistBlock("AF250GRV")  // PONTO DE ENTRADA ANTES DA COTABILIZACAO
			Execblock("AF250GRV",.F.,.F.,Acols[nX])
		Endif

		If lPadrao         // Existe Lancto padrao
			If lContabiliza .And. lOnOff// Contabiliza
				nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
			Endif
		Endif
	Endif
Next

//22/07/2010
PcoFinLan("000366")
While GetSx8len() > nSaveSx8Len
	ConfirmSX8()
End

End Transaction

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Contabilizacao da geracao do(s) novo(s) bem(s)          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lOnOff
	If lContabiliza .And. nTotal > 0
		RodaProva(nHdlPrv,nTotal)
		cA100Incl(cArquivo,nHdlPrv,3,cLoteAtf,IIf(mv_par01 == 1, .T., .F.),IIf(mv_par02 == 1, .T., .F.),,,,,,aDiario)
	Endif
EndIf

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Af250Tipo ³ Autor ³ Alice Y Yamamoto      ³ Data ³ 11.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica se tipo ‚ "01" (So pode ser '01'na baixa de adiat) ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³af250Tipo()  												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ atfa250													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250Tipo()
Local cTipo := &(ReadVar())
Local lRet  := .T.

If cTipo != "01"
	Help(" ",1,"AF250TIPO")
	lRet := .F.
	Return lRet
Endif

Return lRet

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o   ³ AF250Canc  ³ Autor ³ Alice Y Yamamoto      ³ Data ³ 14.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o³ Cancelamento dos adiantamentos                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso     ³ Generico                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250Canc(cAlias,nReg,nOpcx,aCampos,lDireto,aParam,cCodLanPco,cPrgPco)

Local oDlg
Local nOpcA := 0, nCnt, nx, nProxRec := 0
Local cBase, cItem, cTipo,cRateio
Local dDataBx, cChave
Local cPadrao 	:= "836"
Local lPadrao 	:= VerPadrao(cPadrao)
Local cLoteAtf
Local nTotal    := 0
Local lContabiliza
Local lPrim 	:= .T.
Local aTpSaldo	:= { "Q", "R"} 	// Tipo de saldo para registro origem/destino
Local nQtdBai	:= 0			// Variavel para retorno da quantidade no SN1
Local dUltDepr := GETMV("MV_ULTDEPR")
Local lGspInUseM := If(Type('lGspInUse')=='L', lGspInUse, .F.)
Local nIndex
Local lCancela	:= .T.
Local nPosCbase := 0
Local nPosItem	:= 0
Local cFilSN1	:= xFilial("SN1")
Local nPropSF9	:= 0
//********************************
// Controle de multiplas moedas  *
//********************************
Local aValorMOed
Local cPadAnt		:= ""
Local lPadAnt
Local aBxParcial	:= If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
//Data de Bloqueio da Movimentação - MV_ATFBLQM
Local dDataBloq := GetNewPar("MV_ATFBLQM",CTOD(""))


AF250ChkCiap()

If lGspInUseM
	//Se for GSP, pega o ultimo dia do mes anterior
	dUltDepr := MsSomaMes(dUltDepr,-1,.T.)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Variável que indica que a rotina será executada ³
//³de forma automatica                             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Default lDireto	:= .F.
Default aParam  := {}

//Parâmetros utilizados para estorno de lançamentos no PCO
//Se estiverem em vazias, conforme DEFAULT abaixo definido, não será feito o estorno
Default cCodLanPco := ""
Default cPrgPco    := ""

Private cArquivo
Private nHdlPrv

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Valida, caso a rotina seja acionada de forma automatica³
//³se as tabelas estão posicionadas corretamente          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lDireto
	If SN1->(EOF()) .Or. SN3->(EOF())
		Help(" ", 1, "AFDTCANCEL",,STR0116,1,0) //  "Os arquivos SN1 e SN3 devem estar corretamente posicionados"
	    Return(.F.)
	EndIf
EndIf

Pergunte("AFA250",.F.)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Carrega os parametros do pergunte ³
//³baseado no vetor de aParam        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(aParam)
	For nx := 1 to Len(aParam)
		&("MV_PAR"+Strzero(nx,2)) := aParam[nX]
	Next nx
EndIf

lContabiliza:= IIf(mv_par01 < 3, .T., .F.)  //Contabiliza baixa

nValorOr := 0
nValorDp := 0
nValorCo := 0
nValorCd := 0
nValBxOr := 0
nValBxDp := 0
nValBxCo := 0
nValBxCd := 0
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³O cancela/o das baixas de adiantamentos ‚ da seguinte maneira.          ³
//³- Se o cod. de liga‡„o (N3_CODBAIX) E a data de baixa (N3_DTBAIXA) esti-³
//³  verem preenchidos, estes geraram o(s) bem(s) definitivo(s), ou seja,  ³
//³  s„o os 'adianta/os' baixados.                                         ³
//³- Se o somente o cod. de liga‡„o estiver preenchido (N3_CODBAIX), estes ³
//³  s„o os bens definitivos gerados.                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica a validade da data                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(dDataBloq) .AND. (dDataBase <= dDataBloq)
	HELP(" ",1,"AF250BLQM",,STR0123 + DTOC(dDataBloq) ,1,0)    //"A data de aquisição do bem é igual ou menor que a data de bloqueio de movimentação : "
	Return
EndIf

If (dDataBase) <= (dUltDepr) .Or. (dDataBase) > LastDay(dUltDepr+1)
	//Tipo Depreciacao diferente 02-Mes Subsequente
	If GetMv("MV_TIPDEPR") <> "2"
		Help(" ", 1, "AFDTCANCEL")
		Return(.F.)
	ElseIF dDataBase < (FirstDay(dUltDepr))
		Help(" ",1,"AF250DSCEST",,STR0064+DTOC(SuperGetMV("MV_ULTDEPR")),1,0)
		Return(.F.)
	Endif
Endif

cLoteAtf := LoteCont("ATF")

cBase  := SN1->N1_CBASE
cItem  := SN1->N1_ITEM
cTipo  := "01"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Prepara o Alias SF9 para validacao                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DbSelectArea("SF9")
DbSetOrder(1)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Procuro no SN3 pelo registro com  preenchido        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SN3")
dbsetOrder(1)
If ! dbSeek(xFilial("SN3")+cBase+cItem) .Or. Empty(SN3->N3_CODBAIX)
	Help(1, " ", "AF250NOREC")
	Return(.F.)
Endif

cRateio := SN3->N3_CODBAIX
dDataBx := SN3->N3_DTBAIXA
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Filtra o arquivo por tipo e vencimento                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SN3")
cIndex 	:= CriaTrab(nil,.f.)
cChave  := "N3_FILIAL+N3_CODBAIX+N3_CBASE+N3_ITEM+N3_SEQ"
IndRegua("SN3",cIndex,cChave,,Af250CancBx(cRateio),STR0011) // "Selecionando Registros..."
nIndex := RetIndex("SN3")
dbSelectArea("SN3")
#IFNDEF TOP
	dbSetIndex( cIndex +OrdBagExt())
#ENDIF
dbSelectArea("SN3")
dbSetOrder(nIndex+1)
dbGoTop( )

If BOF() .and. EOF()
	Help(" ",1,"RECNO")
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Restaura os indices      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Set Filter To
	RetIndex("SN3")
	fErase (cIndex+OrdBagExt())
	Return(.F.)
Endif

If SN3->N3_IDBAIXA = "2"
	aTpSaldo := { "1", "5" }
	cPadrao  := "816"
Endif

lPadrao 	:= VerPadrao(cPadrao)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta a entrada de dados do arquivo                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Private aTELA[0][0],aGETS[0],aHeader[0],nUsado:=0

Af250aHead(.T.)

dbSelectArea("SN3")
dbSetOrder(nIndex+1)
dbGotop()
nCnt := 0
While !Eof() .And. SN3->N3_FILIAL+SN3->N3_CODBAIX==xFilial("SN3")+cRateio
	dbSelectArea("SN1")
	dbSetOrder(1)
	If dbSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM)
		nCnt++
	Endif
	dbSelectArea("SN3")
	dbSetOrder(nIndex+1)
	dbSkip()
EndDo

PRIVATE aCOLS[nCnt][Len(aHeader)+1]

dbGoTop()
nCnt := 0
While !Eof() .And. SN3->N3_FILIAL+SN3->N3_CODBAIX==xFilial("SN3")+cRateio
	dbSelectArea("SN1")
	dbSetOrder(1)
	If dbSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM)
		nCnt++
		For nx := 1 to Len(aHeader)
			If  !AllTrim(aHeader[nx][2]) $ "SN3_REC_WT|SN3_ALI_WT"
				aCols[nCnt][nx] := &(aHeader[nx][9] +"->"+aHeader[nx][2])
	   		Else
	   			If AllTrim(aHeader[nx][2]) == "SN3_REC_WT"
			   		aCols[nCnt][nx] := SN3->(Recno())
		   		ElseIf AllTrim(aHeader[nx][2]) == "SN3_ALI_WT"
		   			aCols[nCnt][nx] := "SN3"
                		EndIf


			EndIf


		Next
	Endif
	aCols[nCnt][nx] := .F.
	dbSelectArea("SN3")
	dbSetOrder(nIndex+1)
	dbSkip()
EndDo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ BOPS 00000154755 - TRATAMENTO DO CIAP NO CANCELAMENTO³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

SF9->(DbSetOrder(1))
SN1->(DbSetOrder(1))
SN4->(DbSetOrder(1))

dbSelectArea("SN3")
dbSetOrder(nIndex+1)
dbGoTop()

While SN3->(!Eof()) .And. SN3->N3_FILIAL+SN3->N3_CODBAIX==xFilial("SN3")+cRateio

	IF SN3->N3_BAIXA == "0" // ITEM ATIVO

		//Tratamento do CIAP no cancelamento
		SN1->(MsSeek(cFilSN1+SN3->N3_CBASE+SN3->N3_ITEM))
		IF !Empty(SN1->N1_CODCIAP)
			IF SF9->(MsSeek(xFilial("SF9")+	SN1->N1_CODCIAP))
				If  (SF9->F9_ICMIMOB <> SN1->N1_ICMSAPR) .OR. (SF9->F9_BXICMS <> 0 .Or. SF9->F9_MOTIVO <> " ")
					If ! MsgYesNo(STR0129+SN1->N1_CODCIAP+STR0130, STR0131 )//"O Bem possui um Credito de ICMS do Ativo Permanente (CIAP) associado com o código "##"CIAP."##"Prosseguir com o cancelamento?"
						Help("  ",1,"A100CIAPDE")
						lCancela := .F.
						Exit
					EndIf
				ENDIF
			ENDIF
		ENDIF

		//Verifica se o ativo originado já sofreu depreciação
		If 	SN4->(dbSeek(xFilial("SN4") + SN3->N3_CBASE + SN3->N3_ITEM + SN3->N3_TIPO + DTOS(SN3->N3_AQUISIC) +"05" )) .OR. ;
			SN4->(dbSeek(xFilial("SN4") + SN3->N3_CBASE + SN3->N3_ITEM + SN3->N3_TIPO + DTOS(SN3->N3_AQUISIC) +"16" ))
			If ATFVDEPRAC(SN3->N3_CBASE, SN3->N3_ITEM,SN3->N3_TIPO,,SN4->N4_OCORR ) //
				lCancela := .F.
				Help("  ",1,"AF250CANC",,STR0125,1,0) //"O ativo gerado a partir da baixa dos adiantamentos possui depreciação."
				Exit
			EndIf
		EndIf

	ENDIF

	If lCancela
		SN1->(MsSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM))
		If SN1->N1_STATUS $ "2|3"
			Help(" ",1,"A250BLCAN")
			lCancela := .F.
			Exit
		EndIf
	EndIf

	SN3->(dbSkip())
EndDo

dbSelectArea("SN3")
dbSetOrder(nIndex+1)
dbGoTop()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ BOPS 00000123127 - VALIDACAO PARA CANCELAMENTO      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lCancela .AND. ExistBlock("AF250CAN")
	lCancela := Execblock("AF250CAN",.F.,.F.,{aCols,nCnt})
	lCancela := IIF(ValType(lCancela) == "L",lCancela,.T.)
Endif

While lCancela
	nOpca := 0
	If !lDireto
		aSize := MSADVSIZE()
		DEFINE MSDIALOG oDlg TITLE STR0057 From aSize[7],0 To aSize[6],aSize[5] OF oMainWnd  PIXEL //	"Cancelamento da Baixa de Adiantamentos por Rateios"
		oDlg:lMaximized := .T.

		oPanel := TPanel():New(0,0,'',oDlg,, .T., .T.,, ,30,30,.T.,.T. )
		oPanel:Align := CONTROL_ALIGN_BOTTOM

		@ 0.8 , 35  Say STR0058 FONT oDlg:oFont Of oPanel 		// "Total de bens a Cancelar "
		@ 0.8 , 49  Say oQtdBem VAR nCnt Picture "@E 999,999,999.99" FONT oDlg:oFont Of oPanel

		oGet := MSGetDados():New(30,oDlg:nLeft,oDlg:nBottom,oDlg:nRight,2,"af250LinOk","af250TudOk","",.T., , ,.f.)
		oGet:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT

		ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,oDlg:End()},{|| nOpca:=2,oDlg:End()})

	Else
		nOpca := 1
	EndIf
	If nOpca == 1
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Apaga registros novos do SN3 e desmarca os adtos baixados        ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

		BEGIN TRANSACTION

		If !Empty(cCodLanPco)
			PcoIniLan(cCodLanPco)
		EndIf


		dbSelectArea("SN3")
		dbSetOrder(nIndex+1)
		dbGotop()
		nProxRec := 0
		nCnt := 0
		While !Eof() .And. xFilial("SN3")+cRateio==SN3->N3_FILIAL+SN3->N3_CODBAIX
			nCnt++
			nValorOr := 0
			nValorDp := 0
			nValorCo := 0
			nValorCd := 0
			nValBxOr := 0
			nValBxDp := 0
			nValBxCo := 0
			nValBxCd := 0

			If lPadrao   // Se existe o Lacto padrao
				If lContabiliza  //Contabilizo baixa
					If lPrim
						nHdlPrv := HeadProva(cLoteAtf,"ATFA250",Substr(cUsername,1,6),@cArquivo)
						lPrim := .F.
					Endif
				Endif
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Verifica se ‚ o bem origem ou se ‚ o bem definitivo.         ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			SN3->(dbSkip())
			nProxRec := Recno()
			SN3->(dbSkip(-1))

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			aOrig	 := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
			aAmplia	 := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
			//nOrig1	 := nOrig2	 := nOrig3	 := nOrig4	  := nOrig5	  := 0
			//nAmplia1 := nAmplia2 := nAmplia3 := nAmplia4 := nAmplia5 := 0
			nVrcMes1 := nVrcBal1 := nVrcAcm1 := 0
			nVrcdM1	 := nVrcdB1	 := nVrcdA1	 := 0

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			aVrdMes := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
			aVrdBal := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
			aVrdAcm := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
			//nVrdMes1 := nVrdMes2 := nVrdMes3 := nVrdMes4 := nVrdMes5 := 0
			//nVrdBal1 := nVrdBal2 := nVrdBal3 := nVrdBal4 := nVrdBal5 := 0
			//nVrdAcm1 := nVrdAcm2 := nVrdAcm3 := nVrdAcm4 := nVrdAcm5 := 0

			lParcial := .F.

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aOrig	 := AtfMultMoe(,,{|x| SN3->&("N3_VORIG"+Alltrim(Str(x)))+SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) })
			Else
				aOrig	 := {0,0,0,0,0}
				aOrig[1]	:= SN3->N3_VORIG1+SN3->N3_AMPLIA1
				aOrig[2]	:= SN3->N3_VORIG2+SN3->N3_AMPLIA2
				aOrig[3]	:= SN3->N3_VORIG3+SN3->N3_AMPLIA3
				aOrig[4]	:= SN3->N3_VORIG4+SN3->N3_AMPLIA4
				aOrig[5]	:= SN3->N3_VORIG5+SN3->N3_AMPLIA5
			EndIf

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aAmplia := AtfMultMoe("SN3","N3_AMPLIA")
			Else
				aAmplia := {0,0,0,0,0}
				aAmplia[1] := SN3->N3_AMPLIA1
				aAmplia[2] := SN3->N3_AMPLIA2
				aAmplia[3] := SN3->N3_AMPLIA3
				aAmplia[4] := SN3->N3_AMPLIA4
				aAmplia[5] := SN3->N3_AMPLIA5
			EndIf

			nVrcMes1 := SN3->N3_VRCMES1
			nVrcBal1 := SN3->N3_VRCBAL1 - nVrcMes1
			nVrcAcm1 := SN3->N3_VRCACM1 - nVrcMes1

			nVrcdM1	:= SN3->N3_VRCDM1
			nVrcdB1	:= SN3->N3_VRCDB1 - nVrcdM1
			nVrcdA1	:= SN3->N3_VRCDA1 - nVrcdM1

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aVrdMes := AtfMultMoe("SN3","N3_VRDMES")
			Else
				aVrdMes := {0,0,0,0,0}
				aVrdMes[1] := SN3->N3_VRDMES1
				aVrdMes[2] := SN3->N3_VRDMES2
				aVrdMes[3] := SN3->N3_VRDMES3
				aVrdMes[4] := SN3->N3_VRDMES4
				aVrdMes[5] := SN3->N3_VRDMES5
			EndIf

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aVrdBal := AtfMultMoe(,,{|x| SN3->&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x))) - aVrdMes[x] })
			Else
				aVrdBal	:= {0,0,0,0,0}
				aVrdBal[1] := SN3->N3_VRDBAL1 - aVrdMes[1]
				aVrdBal[2] := SN3->N3_VRDBAL2 - aVrdMes[2]
				aVrdBal[3] := SN3->N3_VRDBAL3 - aVrdMes[3]
				aVrdBal[4] := SN3->N3_VRDBAL4 - aVrdMes[4]
				aVrdBal[5] := SN3->N3_VRDBAL5 - aVrdMes[5]
			EndIf

			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aVrdAcm := AtfMultMoe(,,{|x| SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) - aVrdMes[x] })
			Else
				aVrdAcm[1] := SN3->N3_VRDACM1 - aVrdMes[1]
				aVrdAcm[2] := SN3->N3_VRDACM2 - aVrdMes[2]
				aVrdAcm[3] := SN3->N3_VRDACM3 - aVrdMes[3]
				aVrdAcm[4] := SN3->N3_VRDACM4 - aVrdMes[4]
				aVrdAcm[5] := SN3->N3_VRDACM5 - aVrdMes[5]
			EndIf

			If SN3->N3_BAIXA = "2" .And. ! Empty(SN3->N3_DTBAIXA) .And. Val(SN3->N3_SEQ) > 1
				lParcial := .T.
				dDataBx := SN3->N3_DTBAIXA
			Endif

			If 	! Empty(SN3->N3_CODBAIX) .And. (Empty(SN3->N3_DTBAIXA) .And. ! lParcial)
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Excluir os bens DESTINO (gerados)             ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				nValorOr := SN3->N3_VORIG1+SN3->N3_AMPLIA1+SN3->N3_AMPLIA1
				nValorDp := SN3->N3_VRDACM1
				nValorCo := SN3->N3_VRCACM1
				nValorCd := SN3->N3_VRCDA1

                aBxParcial := aOrig // Mantem o valor da baixa de adiantamento parcial (ATFA040) para recompor o valor do bem original
				dbSelectArea("SN1")
				dbSetorder(1)
				If dbSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM)

					dbSelectArea("SN4")
					dbSetOrder(1)

					Af250DelSn4(xFilial("SN4")+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO+;
					DTOS(SN3->N3_AQUISIC), cRateio,, { "16", "05" },;
					aTpSaldo[1] = "1",cCodLanPco,cPrgPco)

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Atualiza os arquivos de Saldos SN5/SN6 caso gerado p/ ATFA250³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If aTpSaldo[1] = "Q"
						Af250Saldo(aTpSaldo[1], "-")
					Endif
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Deleta Descri‡”es Anal?ticas³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					dbSelectArea("SN2")
					dbSeek( xFilial("SN2")+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO )
					cChave := xFilial("SN2")+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO
					While !Eof() .and. SN2->N2_FILIAL+SN2->N2_CBASE+SN2->N2_ITEM+SN2->N2_TIPO == cChave
						Reclock("SN2" ,.F.,.T.)
						dbDelete()
						FkCommit()
						dbSkip()
					End

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Exclui o REGISTRO DEFINTIVO (gerados) NO SF9 - CIAP          ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					IF !EMPTY(SN1->N1_CODCIAP)
						ATFRMVCIAP(SN1->N1_CODCIAP)
					ENDIF

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Exclui apontamento de estimativa inicial de produção	³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If cPaisLoc $ "ARG|BRA"
						dbSelectArea("FNA")
						dbSetOrder(2)		//FNA_FILIAL+FNA_CBASE+FNA_ITEM+FNA_TIPO+FNA_SEQ+FNA_SEQREA+FNA_TPSALD+DTOS(FNA_DATA)
						dbGoTop()
						If FNA->(MsSeek(xFilial("FNA")+SN3->(N3_CBASE+N3_ITEM+N3_TIPO+N3_SEQ+N3_SEQREAV+N3_TPSALDO)))
							While FNA->(!EoF()) .And.;
								FNA->(FNA_FILIAL+FNA_CBASE+FNA_ITEM+FNA_TIPO+FNA_SEQ+FNA_SEQREA+FNA_TPSALD) == SN3->(N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO+N3_SEQ+N3_SEQREAV+N3_TPSALDO)
								RecLock("FNA",.F.)

								//Salva o LP anterior
								cPadAnt := cPadrao
								lPadAnt := lPadrao

								Do Case
									Case FNA->FNA_OCORR == "P0"
										cPadrao := "875"		//Estorno de apontamento de estimativa de produção
									Case FNA->FNA_OCORR == "P1"
										cPadrao := "876"		//Estorno de apontamento de revisão de estimativa de produção
									Case FNA->FNA_OCORR == "P2"
										cPadrao := "877"		//Estorno de apontamento de produção
									Case FNA->FNA_OCORR == "P3"
										cPadrao := "878"		//Estorno de apontamento de encerramento de produção
									Case FNA->FNA_OCORR == "P4"
										cPadrao := "879"		//Estorno de apontamento de complemento de produção
								EndCase

								lPadrao := VerPadrao(cPadrao)
								If ValType(nHdlPrv) == "N" .And. nHdlPrv > 0 .And. lPadrao
									nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
								EndIf

								//Restaura o LP anterior
								cPadrao := cPadAnt
								lPadrao := lPadAnt

								dbDelete()
								MsUnlock()
							    FNA->(dbSkip())
							EndDo
						EndIf
					EndIf

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Exclui o REGISTRO DEFINTIVO (gerados) DO SN3                 ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					Reclock("SN3", .F., .T.)
					dbDelete()
					FkCommit()
					msUnlock()

			   		If SN3->N3_TIPO == '01' .Or. AllTrim(FunName()) <> 'ATFA040'
						Reclock("SN1",.F., .T.)
						dbDelete()
						FkCommit()
						MsUnlock()
			   		Endif

					// CONTABILIZAR
					If lPadrao   // Se existe o Lacto padrao
						If lContabiliza  //Contabilizo baixa
							nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
						Endif
					Endif
				Else
					Help(" ", 1, "AFDTCANCEL",, STR0117,1,0) //"Nao existe ficha de ativo para esse bem."
					DisarmTransaction()
					lPadrao := .F.
					Exit
				EndIf
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³2¦ PARTE - CANCELAR ADIANTA/OS QUE GERARAM OS BENS DEFINITIVOS³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			ElseIf !Empty(SN3->N3_CODBAIX) .And. ( ! Empty(SN3->N3_DTBAIXA) .Or.;
				lParcial)

				If ! lParcial
					dDataBx := SN3->N3_DTBAIXA
				Endif

				Af250DelSn4(xFilial("SN4")+SN3->N3_CBASE+SN3->N3_ITEM+SN3->N3_TIPO+;
				DTOS(dDataBx), cRateio, @nQtdBai,, aTpSaldo[1] = "1",cCodLanPco,cPrgPco)

				DbSelectArea("SN3")
				nRecno := Recno()
				RecLock("SN3",.F.)
				If SN3->N3_BAIXA = "2" .And. ! Empty(SN3->N3_DTBAIXA) .And. Val(SN3->N3_SEQ) > 1
					lParcial := .T.
					dDataBx := SN3->N3_DTBAIXA
				Endif
				// Cancelamento de baixa chamada pela rotina de Baixa por Adiantamento,nao
				// deve atualizar valores originais, pois naquela rotina os valores originais
				// nao sao alterados
				If nOpcX == 5 // Cancelamento da Baixa chamada pela rotina de baixa

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_VORIG",{|x| Round( SN3->&("N3_VORIG"+Alltrim(Str(x)))  + aOrig[x]  , X3Decimal("N3_VORIG"+Alltrim(Str(x))) ) })
					Else
						SN3->N3_VORIG1  := Round( SN3->N3_VORIG1  + aOrig[1]  , X3Decimal("N3_VORIG1") )
						SN3->N3_VORIG2  := Round( SN3->N3_VORIG2  + aOrig[2]  , X3Decimal("N3_VORIG2") )
						SN3->N3_VORIG3  := Round( SN3->N3_VORIG3  + aOrig[3]  , X3Decimal("N3_VORIG3") )
						SN3->N3_VORIG4  := Round( SN3->N3_VORIG4  + aOrig[4]  , X3Decimal("N3_VORIG4") )
						SN3->N3_VORIG5  := Round( SN3->N3_VORIG5  + aOrig[5]  , X3Decimal("N3_VORIG5") )
					EndIf
					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_AMPLIA",{|x| Round( SN3->&(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x)))  + aAmplia[x]  , X3Decimal(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) ) })
					Else
						SN3->N3_AMPLIA1 := Round( SN3->N3_AMPLIA1 + aAmplia[1], X3Decimal("N3_AMPLIA1") )
						SN3->N3_AMPLIA2 := Round( SN3->N3_AMPLIA2 + aAmplia[2], X3Decimal("N3_AMPLIA2") )
						SN3->N3_AMPLIA3 := Round( SN3->N3_AMPLIA3 + aAmplia[3], X3Decimal("N3_AMPLIA3") )
						SN3->N3_AMPLIA4 := Round( SN3->N3_AMPLIA4 + aAmplia[4], X3Decimal("N3_AMPLIA4") )
						SN3->N3_AMPLIA5 := Round( SN3->N3_AMPLIA5 + aAmplia[5], X3Decimal("N3_AMPLIA5") )
					EndIf

					SN3->N3_VRCMES1 := Round( SN3->N3_VRCMES1+nVrcMes1, X3Decimal("N3_VRCMES1") )
					SN3->N3_VRCBAL1 := Round( SN3->N3_VRCBAL1+nVrcBal1, X3Decimal("N3_VRCBAL1") )
					SN3->N3_VRCACM1 := Round( SN3->N3_VRCACM1+nVrcAcm1, X3Decimal("N3_VRCACM1") )

					SN3->N3_VRCDM1  := Round( SN3->N3_VRCDM1+nVrcdM1, X3Decimal("N3_VRCDM1") )
					SN3->N3_VRCDB1  := Round( SN3->N3_VRCDB1+nVrcdB1, X3Decimal("N3_VRCDB1") )
					SN3->N3_VRCDA1  := Round( SN3->N3_VRCDA1+nVrcdA1, X3Decimal("N3_VRCDA1") )

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_VRDMES",{|x| Round( SN3->&(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x)))  + aVrdMes[x]  , X3Decimal(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x))) ) })
					Else
						SN3->N3_VRDMES1 := Round( SN3->N3_VRDMES1+aVrdMes[1], X3Decimal("N3_VRDMES1") )
						SN3->N3_VRDMES2 := Round( SN3->N3_VRDMES2+aVrdMes[2], X3Decimal("N3_VRDMES2") )
						SN3->N3_VRDMES3 := Round( SN3->N3_VRDMES3+aVrdMes[3], X3Decimal("N3_VRDMES3") )
						SN3->N3_VRDMES4 := Round( SN3->N3_VRDMES4+aVrdMes[4], X3Decimal("N3_VRDMES4") )
						SN3->N3_VRDMES5 := Round( SN3->N3_VRDMES5+aVrdMes[5], X3Decimal("N3_VRDMES5") )
					EndIf

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_VRDBAL",{|x| Round( SN3->&(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x)))  + aVrdBal[x]  , X3Decimal(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x))) ) })
					Else
						SN3->N3_VRDBAL1 := Round( SN3->N3_VRDBAL1+aVrdBal[1], X3Decimal("N3_VRDBAL1") )
						SN3->N3_VRDBAL2 := Round( SN3->N3_VRDBAL2+aVrdBal[2], X3Decimal("N3_VRDBAL2") )
						SN3->N3_VRDBAL3 := Round( SN3->N3_VRDBAL3+aVrdBal[3], X3Decimal("N3_VRDBAL3") )
						SN3->N3_VRDBAL4 := Round( SN3->N3_VRDBAL4+aVrdBal[4], X3Decimal("N3_VRDBAL4") )
						SN3->N3_VRDBAL5 := Round( SN3->N3_VRDBAL5+aVrdBal[5], X3Decimal("N3_VRDBAL5") )
					EndIf

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_VRDACM",{|x| Round( SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)))  + aVrdAcm[x]  , X3Decimal(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) ) })
					Else
						SN3->N3_VRDACM1 := Round( SN3->N3_VRDACM1+aVrdAcm[1], X3Decimal("N3_VRDACM1") )
						SN3->N3_VRDACM2 := Round( SN3->N3_VRDACM2+aVrdAcm[2], X3Decimal("N3_VRDACM2") )
						SN3->N3_VRDACM3 := Round( SN3->N3_VRDACM3+aVrdAcm[3], X3Decimal("N3_VRDACM3") )
						SN3->N3_VRDACM4 := Round( SN3->N3_VRDACM4+aVrdAcm[4], X3Decimal("N3_VRDACM4") )
						SN3->N3_VRDACM5 := Round( SN3->N3_VRDACM5+aVrdAcm[5], X3Decimal("N3_VRDACM5") )
					EndIf
				ElseIf nOpcX == 4 // Cancelamento da Baixa chamada pela rotina de baixa por adiantamento

			    	// zera os valores de depreciacao  quando for canc. de baixas por adiantamento
			    	If Alltrim(FunName()) == 'ATFA040'
				    	If !lParcial
							aBxParcial := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
						EndIf
						aVrdMes := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
						aVrdBal := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
						aVrdAcm := If(lMultMoed,AtfMultMoe(,,{|x| 0}), {0,0,0,0,0} )
                	Endif

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_VORIG",{|x| Round( aOrig[x] + aBxParcial[x], X3Decimal("N3_VORIG"+Alltrim(Str(x))) ) })
					Else
						SN3->N3_VORIG1  := Round( aOrig[1], X3Decimal("N3_VORIG1") )
						SN3->N3_VORIG2  := Round( aOrig[2], X3Decimal("N3_VORIG2") )
						SN3->N3_VORIG3  := Round( aOrig[3], X3Decimal("N3_VORIG3") )
						SN3->N3_VORIG4  := Round( aOrig[4], X3Decimal("N3_VORIG4") )
						SN3->N3_VORIG5  := Round( aOrig[5], X3Decimal("N3_VORIG5") )
					EndIf

					//********************************
					// Controle de multiplas moedas  *
					//********************************
					If lMultMoed
						AtfMultMoe("SN3","N3_AMPLIA",{|x| Round( aAmplia[x]  , X3Decimal(If(x>9,"N3_AMPLI","N3_AMPLIA")+Alltrim(Str(x))) ) })
					Else
						SN3->N3_AMPLIA1 := Round( aAmplia[1], X3Decimal("N3_AMPLIA1") )
						SN3->N3_AMPLIA2 := Round( aAmplia[2], X3Decimal("N3_AMPLIA2") )
						SN3->N3_AMPLIA3 := Round( aAmplia[3], X3Decimal("N3_AMPLIA3") )
						SN3->N3_AMPLIA4 := Round( aAmplia[4], X3Decimal("N3_AMPLIA4") )
						SN3->N3_AMPLIA5 := Round( aAmplia[5], X3Decimal("N3_AMPLIA5") )
					EndIf
					SN3->N3_VRCMES1 := Round( nVrcMes1, X3Decimal("N3_VRCMES1") )
					SN3->N3_VRCBAL1 := Round( nVrcBal1, X3Decimal("N3_VRCBAL1") )
					SN3->N3_VRCACM1 := Round( nVrcAcm1, X3Decimal("N3_VRCACM1") )

					SN3->N3_VRCDM1  := Round( nVrcdM1, X3Decimal("N3_VRCDM1") )
					SN3->N3_VRCDB1  := Round( nVrcdB1, X3Decimal("N3_VRCDB1") )
					SN3->N3_VRCDA1  := Round( nVrcdA1, X3Decimal("N3_VRCDA1") )

					If Alltrim(FunName()) != "ATFA250"

						//********************************
						// Controle de multiplas moedas  *
						//********************************
						If lMultMoed
							AtfMultMoe("SN3","N3_VRDMES",{|x| Round( aVrdMes[x]  , X3Decimal(If(x>9,"N3_VRDME","N3_VRDMES")+Alltrim(Str(x))) ) })
						Else
							SN3->N3_VRDMES1 := Round( aVrdMes[1], X3Decimal("N3_VRDMES1") )
							SN3->N3_VRDMES2 := Round( aVrdMes[2], X3Decimal("N3_VRDMES2") )
							SN3->N3_VRDMES3 := Round( aVrdMes[3], X3Decimal("N3_VRDMES3") )
							SN3->N3_VRDMES4 := Round( aVrdMes[4], X3Decimal("N3_VRDMES4") )
							SN3->N3_VRDMES5 := Round( aVrdMes[5], X3Decimal("N3_VRDMES5") )
						EndIf

						//********************************
						// Controle de multiplas moedas  *
						//********************************
						If lMultMoed
							AtfMultMoe("SN3","N3_VRDBAL",{|x| Round( aVrdBal[x]  , X3Decimal(If(x>9,"N3_VRDBA","N3_VRDBAL")+Alltrim(Str(x))) ) })
						Else
							SN3->N3_VRDBAL1 := Round( aVrdBal[1], X3Decimal("N3_VRDBAL1") )
							SN3->N3_VRDBAL2 := Round( aVrdBal[2], X3Decimal("N3_VRDBAL2") )
							SN3->N3_VRDBAL3 := Round( aVrdBal[3], X3Decimal("N3_VRDBAL3") )
							SN3->N3_VRDBAL4 := Round( aVrdBal[4], X3Decimal("N3_VRDBAL4") )
							SN3->N3_VRDBAL5 := Round( aVrdBal[5], X3Decimal("N3_VRDBAL5") )
						EndIf

						// Atualiza saldo da conta de depreciacao acumulada com a diferenca do valor
						// antigo a o valor atual (Valor do estorno)
						//********************************
						// Controle de multiplas moedas  *
						//********************************
						If lMultMoed
							aValorMoed	:= AtfMultMoe(,,{|x|  SN3->&(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x)))-aVrdAcm[x] })
						EndIf
						ATFSaldo(SN3->N3_CCDEPR, dDataBase,"5", SN3->N3_VRDACM1-aVrdAcm[1],SN3->N3_VRDACM2-aVrdAcm[2],;
							SN3->N3_VRDACM3-aVrdAcm[3],SN3->N3_VRDACM4-aVrdAcm[4],SN3->N3_VRDACM5-aVrdAcm[5],;
							"+",,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMoed )

						//********************************
						// Controle de multiplas moedas  *
						//********************************
						If lMultMoed
							AtfMultMoe("SN3","N3_VRDACM",{|x| Round( aVrdAcm[x]  , X3Decimal(If(x>9,"N3_VRDAC","N3_VRDACM")+Alltrim(Str(x))) ) })
						Else
							SN3->N3_VRDACM1 := Round( aVrdAcm[1], X3Decimal("N3_VRDACM1") )
							SN3->N3_VRDACM2 := Round( aVrdAcm[2], X3Decimal("N3_VRDACM2") )
							SN3->N3_VRDACM3 := Round( aVrdAcm[3], X3Decimal("N3_VRDACM3") )
							SN3->N3_VRDACM4 := Round( aVrdAcm[4], X3Decimal("N3_VRDACM4") )
							SN3->N3_VRDACM5 := Round( aVrdAcm[5], X3Decimal("N3_VRDACM5") )
						EndIf
					Endif
				Endif

				dbSelectArea("SN1")
				dbSetorder(1)

				If dbSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM)
					Reclock("SN1",.F.)
					SN1->N1_BAIXA := CTOD("  /  /  ")
					If aTpSaldo[1] = "1"			// Baixa normal - Adiantamento
						SN1->N1_QUANTD += nQtdBai  // Retorno quantidade
					Endif
					MsUnlock()
				Endif

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Restaura o registro de CIAP SF9 vinculado ao bem original    ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				IF !EMPTY(SN1->N1_CODCIAP)
					ATFRSTCIAP(SN1->N1_CODCIAP,@nPropSF9)
				ENDIF

				cTpBaixa := SN3->N3_IDBAIXA

				SN3->N3_BAIXA   := "0"
				SN3->N3_IDBAIXA := " "
				SN3->N3_DTBAIXA := CTOD("  /  /  ")
				SN3->N3_OK      := Space(2)
				SN3->N3_CODBAIX := Space(6)
				SN3->N3_BXICMS	-= nPropSF9
				MsUnlock()

				nValBxOr := SN3->N3_VORIG1+SN3->N3_AMPLIA1
				nValBxDp := SN3->N3_VRDACM1
				nValBxCo := SN3->N3_VRCACM1
				nValBxCd := SN3->N3_VRCDA1
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Atualiza os arquivos de Saldos SN5/SN6 caso gerado p/ ATFA250³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

				If aTpSaldo[2] = "R"
					Af250Saldo(aTpSaldo[2], "-")
				Endif

				// Localizo registros no SN4 referente a baixa anterior para preencher novamente N3_CODBAIX

				DbSelectArea("SN4")
				IndRegua(	"SN4",Left(cIndex, 7) + "A",SN4->(IndexKey(1)),,;
				"N4_FILIAL  = '" + xFilial("SN4") + "' .AND. " +;
				"N4_CBASE  = '" + SN1->N1_CBASE + "' .AND. " +;
				"N4_ITEM  = '" + SN1->N1_ITEM + "' .AND. " +;
				"! Empty(N4_CODBAIX) .AND. N4_CODBAIX <> '" +;
				cRateio + "'",STR0011) // "Selecionando Registros..."
				DbGoBottom()
				If ! Eof()
					DbSelectArea("SN3")
					DbGoto(nRecno)
					Reclock( "SN3" ,.F.)
					SN3->N3_IDBAIXA := cTpBaixa
					SN3->N3_CODBAIX := SN4->N4_CODBAIX
					SN3->N3_BXICMS	-= nPropSF9
					MsUnlock()
				Endif

				DbSelectArea("SN4")
				DbClearFil()
				RetIndex("SN4")
				fErase (Left(cIndex, 7) + "A"+OrdBagExt())

				If ExistBlock("AF250GRV")  // PONTO DE ENTRADA ANTES DA COTABILIZACAO
					Execblock("AF250GRV",.F.,.F.,aCols[nCnt])
				Endif

				**********CONTABILIZAR
				If lPadrao         // Existe Lancto padrao
					If lContabiliza // Contabiliza
						nTotal += DetProva(nHdlPrv,cPadrao,"ATFA250",cLoteAtf)
					Endif
				Endif
			Endif
			dbSelectArea("SN3")
			dbSetOrder(nIndex+1)
			dbGoto(nProxRec)
		EndDo
		If !Empty(cCodLanPco)
			PcoFinLan(cCodLanPco)
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Finaliza o controle de transação para contabilizar      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		END TRANSACTION

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Contabilizacao dos cancelamentos dos bens.              ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lContabiliza .And. nTotal > 0
			RodaProva(nHdlPrv,nTotal)
			cA100Incl(cArquivo,nHdlPrv,3,cLoteAtf,IIf(mv_par01 == 1, .T., .F.),IIf(mv_par02 == 1, .T., .F.))
		Endif
	Endif
	Exit
Enddo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Restaura os indices      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DbSelectArea("SN3")
Set Filter To
RetIndex("SN3")
fErase (cIndex+OrdBagExt())

Return(.T.)

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Af250CanBx³ Autor ³ Alice Y Yamamoto      ³ Data ³ 10.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Retorna expressao para Indice Condicional                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Af250CanBx()                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250CancBx(cRateio,dDataBx)
Local cFiltro := ""

cFiltro := 'N3_FILIAL  = "' + xFilial("SN3") + '" .AND. '
cFiltro += 'N3_CODBAIX = "' + cRateio + '" '

Return cFiltro

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Af250DelLi³ Autor ³ Alice Y Yamamoto      ³ Data ³ 10.01.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao executada qdo a linha ‚ exclu¡da                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Af250DelLi()                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function Af250DelLi()
Local nPosOrig1:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG1"})
Local nValAnt1 := IIf(aCols[n][nPosOrig1]==NIL,0,aCols[n][nPosOrig1])
__nExeDel++
// Como esta rotina eh chamada duas vezes pela exclusao na GetDados, controlar
// as chamadas para nao ocorrer erro nos calculos dos dados do rodape
If (__nExeDel%2)==0
	Return .T.
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Nao valida linha deletada                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !aCols[n][nUsado+1]
	nValRat := nValRat-nValAnt1
Else
	nValRat := nValRat+nValAnt1
Endif
//oValRat:Refresh()

Return(.T.)

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Af250Saldo³ Autor ³ Wagner Mobile Costa   ³ Data ³ 04.06.02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao para atualizacao dos saldos contabeis do ativo      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Af250Saldo(cTipo, cSinal)                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cTipo  = Tipo de movimento (Q/R)                           ³±±
±±³          ³ cSinal = + ou - (Identifica se soma ou diminui)            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/

Static Function Af250Saldo(cTipo, cSinal)

//********************************
// Controle de multiplas moedas  *
//********************************
Local aValorMOed

If lMultMoed
	aValorMOed := AtfMultMoe(,,{|x| SN3->&("N3_VORIG"+Alltrim(Str(x))) + If(x=1,SN3->N3_AMPLIA1,0) })
EndIf
ATFSaldo(	SN3->N3_CCONTAB,dDataBase,cTipo,SN3->(N3_VORIG1+N3_AMPLIA1),SN3->N3_VORIG2,SN3->N3_VORIG3,;
		SN3->N3_VORIG4,SN3->N3_VORIG5 ,cSinal,,SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValorMOed )
//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aValorMOed := AtfMultMoe(,,{|x| If(x=1,SN3->N3_VRCACM1,0) })
EndIf
ATFSaldo(	SN3->N3_CCONTAB,dDataBase,"6", SN3->N3_VRCACM1,0,0,0,0 ,;
		cSinal,,SN3->N3_SUBCCON,,SN3->N3_CLVLCON,SN3->N3_CUSTBEM,"1", aValorMOed )
//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aValorMOed := AtfMultMoe(,,{|x| If(x=1,SN3->N3_VRCACM1,0) })
EndIf
ATFSaldo(	SN3->N3_CCORREC,dDataBase,"6", SN3->N3_VRCACM1,0,0,0,0 ,;
		cSinal,,SN3->N3_SUBCCOR,,SN3->N3_CLVLCOR,SN3->N3_CCCORR,"2", aValorMOed )

If FunName() != "ATFA250"
	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		aValorMOed := AtfMultMoe("SN3","N3_VRDACM")
	EndIf
	If cTipo = "R"
		ATFSaldo(	SN3->N3_CCDEPR, dDataBase,"4", SN3->N3_VRDACM1,SN3->N3_VRDACM2,SN3->N3_VRDACM3 ,;
			SN3->N3_VRDACM4,SN3->N3_VRDACM5, "-",,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMOed )
	Else
		ATFSaldo(	SN3->N3_CCDEPR, dDataBase,"4", SN3->N3_VRDACM1,SN3->N3_VRDACM2,SN3->N3_VRDACM3 ,;
			SN3->N3_VRDACM4,SN3->N3_VRDACM5 ,cSinal,,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMOed )
	Endif
	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		aValorMOed := AtfMultMoe(,,{|x| If(x=1,SN3->N3_VRCDA1,0) })
	EndIf
	ATFSaldo(	SN3->N3_CCDEPR, dDataBase,"7", SN3->N3_VRCDA1,0,0,0,0 ,;
			cSinal,,SN3->N3_SUBCCDE,,SN3->N3_CLVLCDE,SN3->N3_CCCDEP,"4", aValorMOed )
	ATFSaldo(	SN3->N3_CDESP,  dDataBase,"7", SN3->N3_VRCDA1,0,0,0,0 ,;
		cSinal,,SN3->N3_SUBCDES,,SN3->N3_CLVLDES,SN3->N3_CCCDES,"5", aValorMOed )
Endif
Return .T.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Af250aHead³ Autor ³ Wagner Mobile Costa   ³ Data ³ 18.06.02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao para criacao do aHeader para uso na Rotina          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function Af250aHead(lCancela)
LOCAL lCtb := CtbInUse()
LOCAL nX := 0
Local lAF250AHD	:= ExistBlock('AF250AHD')
Local aAF250AHD := {}
Local aOldHead	:= {}
//********************************
// Controle de multiplas moedas  *
//********************************
Local __nQuantas := If(lMultMoed,AtfMoedas(),5)
AF250ChkCiap()
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Montagem da matriz aHeader											  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nUsado := 0

SX3->(DbSetOrder(2))
If lCtb
	AADD(aHeader,{STR0015,"N1_CBASE","@!",; // "Codigo Base"
	10,0,"","û","C","SN1" } )
	AADD(aHeader,{STR0016,"N1_ITEM","@!",; // "Item Base"
	4,0,"Af250ExisC()","û","C","SN1" } )
	AADD(aHeader,{STR0017,"N3_TIPO","@!",; // "Tipo"
	2,0,"","û","C","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TIPREAV"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TIPREAV",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	AADD(aHeader,{STR0022,"N1_PATRIM","",; // "Classificacao"
	1,0,"","û","C","SN1" } )
	AADD(aHeader,{STR0018,"N3_AQUISIC","",; //  "Data Aquisic"
	8,0,"","û","D","SN3" } )
	AADD(aHeader,{STR0019,"N1_DESCRIC","@!",; // "Descr Sintetica"
	40,0,"","û","C","SN1" } )
	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_GRUPO"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"ExistCpo('SNG').AND.AF250GRUPO()","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf

	If SX3->(dbSeek("N1_NATBEM"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"Pertence('CIF')","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf

	If !lCancela
		AADD(aHeader,{STR0102,'N3_PERC','@E 999.99',6,3,"Positivo() .and. AF250Perc(M->N3_PERC)","û",'N','SN1' } ) //'Percentual % '
	EndIf
	AADD(aHeader,{STR0020,"N1_QUANTD","@E 99,999.999",;  //  "Quantd"
	8,4,"","û","N","SN1" } )
	AADD(aHeader,{STR0021,"N1_CHAPA","@!",; // "Chapa"
	TamSX3("N1_CHAPA")[1],0,"AF250CHAPA()","û","C","SN1" } )
	If !lCancela .And. lN1Ciap
		AADD(aHeader,{STR0103,'N1_CIAP',"@!",1,0,"Pertence('12')","û",'C', 'SN1' } ) //'Gera CIAP?'
	EndIf

	IF lN1Ciap
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_ICMSAPR"))
			AADD(aHeader,{X3Titulo(),"N1_ICMSAPR",X3Picture("N1_ICMSAPR"),18,2,"Positivo().AND.AF250CIAP()","û","N","SN1" } ) // "Cod. CIAP"
		EndIf
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_CALCPIS"))
			AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"Pertence('SN123')","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
		EndIf
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_MESCPIS"))
			AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
		EndIf
	ENDIF

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N1_CONSAB"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N1_CONSAB",SX3->X3_PICTURE,; // "Codigo Base"
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN1" } )
	RestArea(aArea)

	AADD(aHeader,{STR0023,"N3_HISTOR","@!",; // "Historico"
	40,0,"","û","C","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TPSALDO"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TPSALDO",SX3->X3_PICTURE,; // "Codigo Base"
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	AADD(aHeader,{STR0024,"N3_CCONTAB","@!",; // "Conta"
	20,0,"ExistCpo('CT1')","û","C","SN3" } )
	AADD(aHeader,{STR0025,"N3_CUSTBEM","@!",; // "C.Custo do Bem"
	Len(SN3->N3_CUSTBEM),0,"ExistCpo('CTT')","û","C","SN3" } )
	AADD(aHeader,{STR0026,"N3_CDEPREC","@!",; // "Cta Desp Dep"
	20,0,"ExistCpo('CT1')","û","C","SN3" } )
	AADD(aHeader,{STR0027,"N3_CCUSTO","@!",; // "C Custo"
	Len(SN3->N3_CCUSTO),0,"ExistCpo('CTT')","û","C","SN3" } )
	AADD(aHeader,{STR0028,"N3_CCDEPR","@!",; // "Cta Dep Acum"
	20,0,"ExistCpo('CT1')","û","C","SN3" } )
	AADD(aHeader,{STR0029,"N3_CDESP","@!",; // "Cta Cor Depr"
	20,0,"ExistCpo('CT1')","û","C","SN3" } )
	AADD(aHeader,{STR0030,"N3_CCORREC","@!",; // "Cta Correc"
	20,0,"ExistCpo('CT1')","û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCORR"))
	AADD(aHeader,{X3Titulo(),"N3_CCCORR","@!",;
	Len(SN3->N3_CCCORR),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCDESP"))
	AADD(aHeader,{X3Titulo(),"N3_CCDESP","@!",;
	Len(SN3->N3_CCDESP),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCDEP"))
	AADD(aHeader,{X3Titulo(),"N3_CCCDEP","@!",;
	Len(SN3->N3_CCCDEP),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCDES"))
	AADD(aHeader,{X3Titulo(),"N3_CCCDES", "@!",;
	Len(SN3->N3_CCCDES),0,SX3->X3_VALID,"û","C","SN3" } )

	AADD(aHeader,{STR0031,"N3_DINDEPR","",; // "Dta Inicio Dep"
	08,0,"","û","D","SN3" } )

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	For nX := 1 to __nQuantas

		cMoed := Alltrim(Str(nX))
		AADD(aHeader,{StrTran(STR0032,"1",cMoed),"N3_VORIG"+cMoed,"@E 9,999,999,999.99",; // "Val Orig M1"
		16,2,"Af250calcV()","û","N","SN3" } )

		If nX>9

			AADD(aHeader,{StrTran(STR0033,"1",cMoed),"N3_TXDEP"+cMoed,"@E 999.9999",; // "Tx Anual Dep M1"
			08,4,"Af250TxDep()","û","N","SN3" } )

			AADD(aHeader,{StrTran(STR0042,"1",cMoed),"N3_VRDAC"+cMoed,"@E 9,999,999,999.99",; // "Dep Acum M1"
			16,2,"","û","N","SN3" } )

		Else
			AADD(aHeader,{StrTran(STR0033,"1",cMoed),"N3_TXDEPR"+cMoed,"@E 999.9999",; // "Tx Anual Dep M1"
			08,4,"Af250TxDep()","û","N","SN3" } )

			AADD(aHeader,{StrTran(STR0042,"1",cMoed),"N3_VRDACM"+cMoed,"@E 9,999,999,999.99",; // "Dep Acum M1"
			16,2,"","û","N","SN3" } )
		EndIf

	Next

	AADD(aHeader,{STR0047,"N3_VRCACM1","@E 9,999,999,999.99",; // "Cor Acum M1"
	16,2,"","û","N","SN3" } )
	AADD(aHeader,{STR0048,"N3_VRCDA1","@E 999,999,999.99",; // "Cor Dep Acum M1"
	14,2,"","û","N","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TPDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TPDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PERDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PERDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_CRIDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_CRIDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_CALDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_CALDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_VMXDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_VMXDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_VLSALV1"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_VLSALV1",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODANO"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODANO",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODMES"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODMES",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODACM"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODACM",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	If cPaisLoc == 'PTG'
		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_COEFICI"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_COEFICI",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)

		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_CTXPERD"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_CTXPERD",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)

		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_VLACTXP"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_VLACTXP",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)

	EndIf

	AADD(aHeader,{STR0052,"N3_SUBCCON","@!",; // "Item do Bem"
	Len(SN3->N3_SUBCCON),0,"ExistCpo('CTD')","û","C","SN3" } )
	AADD(aHeader,{STR0053,"N3_SUBCCOR","@!",; // "Item Cor Bem"
	Len(SN3->N3_SUBCCOR),0,"ExistCpo('CTD')","û","C","SN3" } )
	AADD(aHeader,{STR0054,"N3_SUBCDEP","@!",; // "Item Des Dep"
	Len(SN3->N3_SUBCDEP),0,"ExistCpo('CTD')","û","C","SN3" } )
	AADD(aHeader,{STR0055,"N3_SUBCDES","@!",; // "Item Cor Dep"
	Len(SN3->N3_SUBCDES),0,"ExistCpo('CTD')","û","C","SN3" } )
	AADD(aHeader,{STR0056,"N3_SUBCCDE","@!",; // "Item Dep Acu"
	Len(SN3->N3_SUBCCDE),0,"ExistCpo('CTD')","û","C","SN3" } )
	AADD(aHeader,{STR0059,"N3_CLVLCON","@!",; // "Clvl do Bem"
	Len(SN3->N3_CLVLCON),0,"ExistCpo('CTH')","û","C","SN3" } )
	AADD(aHeader,{STR0060,"N3_CLVLCOR","@!",; // "Clvl Cor Bem"
	Len(SN3->N3_CLVLCOR),0,"ExistCpo('CTH')","û","C","SN3" } )
	AADD(aHeader,{STR0061,"N3_CLVLDEP","@!",; // "Clvl Des Dep"
	Len(SN3->N3_CLVLDEP),0,"ExistCpo('CTH')","û","C","SN3" } )
	AADD(aHeader,{STR0062,"N3_CLVLDES","@!",; // "Clvl Cor Dep"
	Len(SN3->N3_CLVLDES),0,"ExistCpo('CTH')","û","C","SN3" } )
	AADD(aHeader,{STR0063,"N3_CLVLCDE","@!",; // "Clvl Dep Acu"
	Len(SN3->N3_CLVLCDE),0,"ExistCpo('CTH')","û","C","SN3" } )

	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_FORNEC"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_LOJA"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
	SX3->(DbSetOrder(2))
	If SX3->(dbSeek(SerieNfId("SN1",3,"N1_NSERIE")))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_NFISCAL"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
Else
	AADD(aHeader,{STR0015,"N1_CBASE","@!",; // "Codigo Base"
	10,0,"","û","C","SN1" } )
	AADD(aHeader,{STR0016,"N1_ITEM","@!",; // "Item Base"
	4,0,"Af250ExisC()","û","C","SN1" } )
	AADD(aHeader,{STR0017,"N3_TIPO","@!",; // "Tipo"
	2,0,"","û","C","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TIPREAV"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TIPREAV",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)


	AADD(aHeader,{STR0022,"N1_PATRIM","",; // "Classificacao"
	1,0,"","û","C","SN1" } )
	AADD(aHeader,{STR0018,"N3_AQUISIC","",; //  "Data Aquisic"
	8,0,"","û","D","SN3" } )
	AADD(aHeader,{STR0019,"N1_DESCRIC","@!",; // "Descr Sintetica"
	40,0,"","û","C","SN1" } )
	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_GRUPO"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"ExistCpo('SNG').AND.AF012ATAXA(.T.)","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
	If !lCancela
		AADD(aHeader,{STR0102,'N3_PERC','@E 999.99',6,3,"Positivo().and.AF250Perc(M->N3_PERC)","û",'N','SN1' } )
	EndIf
	AADD(aHeader,{STR0020,"N1_QUANTD","@E 99,999.999",;  //  "Quantd"
	8,4,"","û","N","SN1" } )
	AADD(aHeader,{STR0021,"N1_CHAPA","@!",; // "Chapa"
	TamSX3("N1_CHAPA")[1],0,"AF250CHAPA()","û","C","SN1" } )
	If !lCancela .And. lN1Ciap
		AADD(aHeader,{STR0103,'N1_CIAP',"@!",1,0,"Pertence('12')","û",'C', 'SN1' } ) //'Gera CIAP?'
	EndIf

	IF lN1Ciap
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_ICMSAPR"))
			AADD(aHeader,{X3Titulo(),"N1_ICMSAPR",X3Picture("N1_ICMSAPR"),18,2,"Positivo().AND.AF250CIAP()","û","N","SN1" } )
		EndIf
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_CALCPIS"))
			AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"Pertence('SN123')","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
		EndIf
		SX3->(DbSetOrder(2))
		If SX3->(dbSeek("N1_MESCPIS"))
			AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
		EndIf
	ENDIF

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N1_CONSAB"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N1_CONSAB",SX3->X3_PICTURE,; // "Codigo Base"
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN1" } )
	RestArea(aArea)

	AADD(aHeader,{STR0023,"N3_HISTOR","@!",; // "Historico"
	40,0,"","û","C","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TPSALDO"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TPSALDO",SX3->X3_PICTURE,; // "Codigo Base"
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	AADD(aHeader,{STR0024,"N3_CCONTAB","@!",; // "Conta"
	20,0,"ExistCpo('SI1')","û","C","SN3" } )
	AADD(aHeader,{STR0025,"N3_CUSTBEM","@!",; // "C.Custo do Bem"
	Len(SN3->N3_CUSTBEM),0,"ExistCpo('SI3')","û","C","SN3" } )
	AADD(aHeader,{STR0026,"N3_CDEPREC","@!",; // "Cta Desp Dep"
	20,0,"ExistCpo('SI1')","û","C","SN3" } )
	AADD(aHeader,{STR0027,"N3_CCUSTO","@!",; // "C Custo"
	Len(SN3->N3_CCUSTO),0,"ExistCpo('SI3')","û","C","SN3" } )
	AADD(aHeader,{STR0028,"N3_CCDEPR","@!",; // "Cta Dep Acum"
	20,0,"ExistCpo('SI1')","û","C","SN3" } )
	AADD(aHeader,{STR0029,"N3_CDESP","@!",; // "Cta Cor Depr"
	20,0,"ExistCpo('SI1')","û","C","SN3" } )
	AADD(aHeader,{STR0030,"N3_CCORREC","@!",; // "Cta Correc"
	20,0,"ExistCpo('SI1')","û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCORR"))
	AADD(aHeader,{X3Titulo(),"N3_CCCORR","@!",;
	Len(SN3->N3_CCCORR),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCDESP"))
	AADD(aHeader,{X3Titulo(),"N3_CCDESP","@!",;
	Len(SN3->N3_CCDESP),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCDEP"))
	AADD(aHeader,{X3Titulo(),"N3_CCCDEP","@!",;
	Len(SN3->N3_CCCDEP),0,SX3->X3_VALID,"û","C","SN3" } )

	SX3->(DbSetOrder(2))
	SX3->(DbSeek("N3_CCCDES"))
	AADD(aHeader,{X3Titulo(),"N3_CCCDES", "@!",;
	Len(SN3->N3_CCCDES),0,SX3->X3_VALID,"û","C","SN3" } )

	AADD(aHeader,{STR0031,"N3_DINDEPR","",; // "Dta Inicio Dep"
	08,0,"","û","D","SN3" } )

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	For nX := 1 to __nQuantas

		cMoed := Alltrim(Str(nX))
		AADD(aHeader,{StrTran(STR0032,"1",cMoed),"N3_VORIG"+cMoed,"@E 9,999,999,999.99",; // "Val Orig M1"
		16,2,"Af250calcV()","û","N","SN3" } )

		If nX>9

			AADD(aHeader,{StrTran(STR0033,"1",cMoed),"N3_TXDEP"+cMoed,"@E 999.9999",; // "Tx Anual Dep M1"
			08,4,"Af250TxDep()","û","N","SN3" } )

			AADD(aHeader,{StrTran(STR0042,"1",cMoed),"N3_VRDAC"+cMoed,"@E 9,999,999,999.99",; // "Dep Acum M1"
			16,2,"","û","N","SN3" } )

		Else
			AADD(aHeader,{StrTran(STR0033,"1",cMoed),"N3_TXDEPR"+cMoed,"@E 999.9999",; // "Tx Anual Dep M1"
			08,4,"Af250TxDep()","û","N","SN3" } )

			AADD(aHeader,{StrTran(STR0042,"1",cMoed),"N3_VRDACM"+cMoed,"@E 9,999,999,999.99",; // "Dep Acum M1"
			16,2,"","û","N","SN3" } )
		EndIf
	Next nX

	AADD(aHeader,{STR0047,"N3_VRCACM1","@E 9,999,999,999.99",; // "Cor Acum M1"
	16,2,"","û","N","SN3" } )
	AADD(aHeader,{STR0048,"N3_VRCDA1","@E 999,999,999.99",; // "Cor Dep Acum M1"
	14,2,"","û","N","SN3" } )

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_TPDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_TPDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PERDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PERDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_CRIDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_CRIDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_CALDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_CALDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_VMXDEPR"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_VMXDEPR",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_VLSALV1"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_VLSALV1",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODANO"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODANO",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODMES"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODMES",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	aArea:=GetArea()
	SX3->(DbSetOrder(2))
	SX3->(DBSEEK("N3_PRODACM"))
	AADD(aHeader,{Alltrim(X3TITULO()),"N3_PRODACM",SX3->X3_PICTURE,;
	SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
	RestArea(aArea)

	If cPaisLoc == 'PTG'
		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_COEFICI"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_COEFICI",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)

		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_CTXPERD"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_CTXPERD",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)

		aArea:=GetArea()
		SX3->(DbSetOrder(2))
		SX3->(DBSEEK("N3_VLACTXP"))
		AADD(aHeader,{Alltrim(X3TITULO()),"N3_VLACTXP",SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,"û",SX3->X3_TIPO,"SN3" } )
		RestArea(aArea)
	EndIf

	AADD(aHeader,{STR0052,"N3_SUBCCON","@!",; // "Item do Bem"
	09,0,"ExistCpo('SID')","û","C","SN3" } )
	AADD(aHeader,{STR0053,"N3_SUBCCOR","@!",; // "Item Cor Bem"
	09,0,"ExistCpo('SID')","û","C","SN3" } )
	AADD(aHeader,{STR0054,"N3_SUBCDEP","@!",; // "Item Des Dep"
	09,0,"ExistCpo('SID')","û","C","SN3" } )
	AADD(aHeader,{STR0055,"N3_SUBCDES","@!",; // "Item Cor Dep"
	09,0,"ExistCpo('SID')","û","C","SN3" } )
	AADD(aHeader,{STR0056,"N3_SUBCCDE","@!",; // "Item Dep Acu"
	09,0,"ExistCpo('SID')","û","C","SN3" } )

	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_FORNEC"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf

	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_LOJA"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf

	SX3->(DbSetOrder(2))
	If SX3->(dbSeek(SerieNfId("SN1",3,"N1_NSERIE")))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf

	SX3->(DbSetOrder(2))
	If SX3->(dbSeek("N1_NFISCAL"))
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	EndIf
EndIf

SX3->(DbSeek("SN3_FILIAL"))

cUsado := SX3->X3_USADO

AADD( aHeader, { "Alias WT","SN3_ALI_WT", "", 09, 0,, cUsado, "C", "SN3", "V"} )
AADD( aHeader, { "Recno WT","SN3_REC_WT", "", 09, 0,, cUsado, "N", "SN3", "V"} )


If lAF250AHD
	aOldHead := aClone(aHeader)
	aAF250AHD := ExecBlock('AF250AHD', .F., .F., aClone(aHeader) )
	aHeader := aClone( aOldHead )
	If ValType( aAF250AHD ) == 'A'
		For nX := 1 To Len( aAF250AHD )
			If Len( aAF250AHD[nX] ) == 9 .and.	ValType( aAF250AHD[nX][1] ) == 'C' .and. ValType( aAF250AHD[nX][2] ) == 'C' .and.;
				ValType( aAF250AHD[nX][3] ) == 'C' .and. ValType( aAF250AHD[nX][4] ) == 'N' .and. ValType( aAF250AHD[nX][5] ) == 'N' .and.;
				ValType( aAF250AHD[nX][6] ) == 'C' .and. ValType( aAF250AHD[nX][7] ) == 'C' .and. ValType( aAF250AHD[nX][8] ) == 'C' .and.;
				ValType( aAF250AHD[nX][9] ) == 'C' .and. aScan( aHeader, {|aHd| aHd[2] == aAF250AHD[nX][2]} ) == 0

				Aadd( aHeader, aClone(aAF250AHD[nX]) )
			EndIf
		Next nX
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ ADICAO DOS CAMPOS OBRIGATORIOS DO SN1 / SN3 NO AHEADER       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
SX3->(DbSetOrder(1))
SX3->(DbSeek("SN1"))
WHILE SX3->(!EOF()) .AND. SX3->X3_ARQUIVO == "SN1"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ CAMPOS QUE NAO DEVEM SER ADICIONADOS POR POSSUIREM TRATAMENTO³
	//³ ESPECIFICOS                                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ALLTRIM(SX3->X3_CAMPO) $ "N1_AQUISIC" .or. ALLTRIM(SX3->X3_CAMPO) $ "N1_OK"
		SX3->(DbSkip())
		Loop
	ENDIF
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ VERIFICA SE NAO EXISTE NO AHEADER MAS E OBRIGATORIO          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF aScan(aHeader,{|x| ALLTRIM(x[2]) == ALLTRIM(SX3->X3_CAMPO)}) == 0 .AND. X3Obrigat(SX3->X3_CAMPO)
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	ENDIF

	SX3->(DbSkip())
END

SX3->(DbSetOrder(1))
SX3->(DbSeek("SN3"))
WHILE SX3->(!EOF()) .AND. SX3->X3_ARQUIVO == "SN3"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ CAMPOS QUE NAO DEVEM SER ADICIONADOS POR POSSUIREM TRATAMENTO³
	//³ ESPECIFICOS                                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ALLTRIM(SX3->X3_CAMPO) $ "N3_CBASE#N3_ITEM"
		SX3->(DbSkip())
		Loop
	ENDIF

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ VERIFICA SE NAO EXISTE NO AHEADER MAS E OBRIGATORIO          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF aScan(aHeader,{|x| ALLTRIM(x[2]) == ALLTRIM(SX3->X3_CAMPO)}) == 0 .AND. X3Obrigat(SX3->X3_CAMPO)
		AADD(aHeader,{X3Titulo(),SX3->X3_CAMPO,AllTrim(SX3->X3_PICTURE),SX3->X3_TAMANHO,SX3->X3_DECIMAL,"","û",SX3->X3_TIPO,SX3->X3_ARQUIVO } )
	ENDIF

	SX3->(DbSkip())
END

nUsado := Len(aHeader)
SX3->(DbSetOrder(1))
Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Af250DelSn4³ Autor ³ Wagner Mobile Costa  ³ Data ³ 19.06.02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao para delecao dos registros da chave atual SN3 X SN4 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Af250Del(cChave, cRateio)                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cChave  = Chave de busca na tabela de movimentos           ³±±
±±³          ³ cRateio = Codigo do rateio de ligacao entre gerado/gerador ³±±
±±³          ³ nQtdBai = Variavel para retorno da quantidade no SN1       ³±±
±±³          ³ aOcorr  = Tipos de ocorrencias para delecao de movimento   ³±±
±±³          ³ lDelSld = Indica se movimenta saldos contabeis pelo mov.   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/

Function Af250DelSn4(cChave, cRateio, nQtdBai, aOcorr, lDelSld,cCodLanPco,cPrgPco)

Local aValorMOed

DEFAULT aOcorr  := { "15", "01" }
DEFAULT lDelSld := .F.
DEFAULT cCodLanPco:= ""
DEFAULT cPrgPco	  := ""

dbSelectArea("SN4")
dbSetOrder(1)
dbSeek(cChave)		// A chave recebida ja tem a filial

While !Eof() .And. cChave==(SN4->N4_FILIAL+SN4->N4_CBASE+SN4->N4_ITEM+SN4->N4_TIPO+DTOS(SN4->N4_DATA))
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Procura pelo movimento de Baixa do valor do bem .       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

	//Verifica se deve estornar o lançamento no PCO
	If !Empty(cCodLanPco)
		PcoDetLan(cCodLanPco,"01",cPrgPco,.T.)
	EndIf

	If 	SN4->N4_OCORR=aOcorr[1] .AND. SN4->N4_SEQ==SN3->N3_SEQ .And.;
		SN4->N4_CODBAIX==cRateio
		nQtdBai := SN4->N4_QUANTD

        If lDelSld
			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMOed := AtfMultMoe("SN4","N4_VLROC")
			EndIf
		 	AtfSaldo(	SN4->N4_CONTA,SN4->N4_DATA,"5", SN4->N4_VLROC1,SN4->N4_VLROC2,SN4->N4_VLROC3,SN4->N4_VLROC4,SN4->N4_VLROC5 ,;
		 		"-",SN4->N4_TXDEPR, SN4->N4_SUBCTA,, SN4->N4_CLVL, SN4->N4_CCUSTO,SN4->N4_TIPOCNT, aValorMOed )
		Endif

		Reclock("SN4",.f.,.T.)
		dbDelete()
		FkCommit()
		MsUnlock()
	Endif

// 01 = Baixa via rotina de adiantamento

	If 	SN4->N4_OCORR = aOcorr[2] .AND. SN4->N4_SEQ == SN3->N3_SEQ .And.;
		SN4->N4_CODBAIX==cRateio
		nQtdBai := SN4->N4_QUANTD

        If lDelSld
			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMOed := AtfMultMoe("SN4","N4_VLROC")
			EndIf
		 	AtfSaldo(	SN4->N4_CONTA,SN4->N4_DATA,If(!Empty(SN4->N4_MOTIVO), "5", "1"), SN4->N4_VLROC1,SN4->N4_VLROC2,SN4->N4_VLROC3,SN4->N4_VLROC4,SN4->N4_VLROC5 ,;
		 		"-",SN4->N4_TXDEPR, SN4->N4_SUBCTA,,SN4->N4_CLVL, SN4->N4_CCUSTO,SN4->N4_TIPOCNT, aValorMOed )
		Endif

		Reclock("SN4",.f.,.T.)
		dbDelete()
		FkCommit()
		MsUnlock()
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Procura pelo movimento de DEPRECIA€O do bem.           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If SN4->N4_OCORR=="06" .AND. SN4->N4_SEQ==SN3->N3_SEQ .And. SN4->N4_CODBAIX==cRateio

        If lDelSld
			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMOed := AtfMultMoe("SN4","N4_VLROC")
			EndIf
		 	AtfSaldo(	SN4->N4_CONTA,SN4->N4_DATA,"4", SN4->N4_VLROC1,SN4->N4_VLROC2,SN4->N4_VLROC3,SN4->N4_VLROC4,SN4->N4_VLROC5 ,;
		 		"-",SN4->N4_TXDEPR, SN4->N4_SUBCTA,, SN4->N4_CLVL, SN4->N4_CCUSTO,SN4->N4_TIPOCNT, aValorMOed )

			// Variaveis para atualizacao do SN3

            If SN4->N4_TIPOCNT = "4"

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVrdMes[x] += SN4->&("N4_VLROC"+Alltrim(Str(x))) * (-1) })
				Else
					aVrdMes[1] += SN4->N4_VLROC1 * (-1)
					aVrdMes[2] += SN4->N4_VLROC2 * (-1)
					aVrdMes[3] += SN4->N4_VLROC3 * (-1)
					aVrdMes[4] += SN4->N4_VLROC4 * (-1)
					aVrdMes[5] += SN4->N4_VLROC5 * (-1)
				EndIf
				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVrdBal[x] += aVrdMes[x] })
				Else
					aVrdBal[1] += aVrdMes[1]
					aVrdBal[2] += aVrdMes[2]
					aVrdBal[3] += aVrdMes[3]
					aVrdBal[4] += aVrdMes[4]
					aVrdBal[5] += aVrdMes[5]
				EndIf

				//********************************
				// Controle de multiplas moedas  *
				//********************************
				If lMultMoed
					AtfMultMoe(,,{|x| aVrdAcm[x] += aVrdMes[x] })
				Else
					aVrdAcm[1] += aVrdMes[1]
					aVrdAcm[2] += aVrdMes[2]
					aVrdAcm[3] += aVrdMes[3]
					aVrdAcm[4] += aVrdMes[4]
					aVrdAcm[5] += aVrdMes[5]
				EndIf
			eNDIF
		Endif

		Reclock("SN4",.f.,.T.)
		dbDelete()
		FkCommit()
		msUnlock()
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Procura pelo movimento de CORRE€O da DEPREC ACUMULADA. ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If SN4->N4_OCORR=="08" .AND. SN4->N4_SEQ==SN3->N3_SEQ .And. SN4->N4_CODBAIX==cRateio

        If lDelSld .And. SN4->N4_TIPOCNT = "4"
			//********************************
			// Controle de multiplas moedas  *
			//********************************
			If lMultMoed
				aValorMOed := AtfMultMoe("SN4","N4_VLROC")
			EndIf
		 	AtfSaldo(	SN4->N4_CONTA,SN4->N4_DATA,"7", SN4->N4_VLROC1,SN4->N4_VLROC2,SN4->N4_VLROC3,SN4->N4_VLROC4,SN4->N4_VLROC5 ,;
		 		"-",SN4->N4_TXDEPR, SN4->N4_SUBCTA,, SN4->N4_CLVL, SN4->N4_CCUSTO,SN4->N4_TIPOCNT, aValorMOed )

			// Variaveis para atualizacao do SN3

            If SN4->N4_TIPOCNT = "4"
				nVrcdM1 += SN4->N4_VLROC1 * (-1)
				nVrcdB1 += nVrcdM1
				nVrcdA1 += nVrcdM1
			Endif
		Endif

		Reclock("SN4",.f.,.T.)
		dbDelete()
		FkCommit()
		msUnlock()
	Endif
	dbSkip()
EndDo

Return .T.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250VLDNM ³ Autor ³ Arnaldo Raymundo Jr. ³ Data ³ 22.05.07 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Avalia se existe o indice adequado no SIX para obtencao da ³±±
±±³          ³ numeracao sequencial adequada para a baixa.                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250VLDNUM()                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
FUNCTION AF250VLDNM(cOrdem)
Local lRet		:= .F.
Local aArea 	:= GetArea()
Local cChave	:= "N3_FILIAL+N3_CODBAIX+N3_CBASE+N3_ITEM+N3_TIPO+N3_SEQ"
Local cEOL		:= CHR(10)+CHR(13)

cOrdem 		:= IIF(Valtype(cOrdem) == "U" .OR. Empty(cOrdem),"8",cOrdem) // "N3_FILIAL+N3_CODBAIX+N3_CBASE+N3_ITEM+N3_TIPO+N3_SEQ"

dbSelectArea("SIX")
dbSetOrder(1)
IF DbSeek("SN3"+cOrdem) .AND. Alltrim(SIX->CHAVE) $ cChave
	lRet := .T.
ELSE
	MsgStop(STR0065+cEOL+STR0066,STR0067)
END

RestArea(aArea)
RETURN lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³TudOk     ºAutor  ³Erica Casale        º Data ³  31/05/08   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Se Portugal, solicita o cod. do diario p/ contabilizacao   º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ AP                                                         º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Static Function TudOk(nOpca)
nOpca :=1

If cPaisLoc == "PTG"
	cCodDiario := CTBAVerDia()
	If Empty(cCodDiario)
		nOpca :=0
		Return nOpca
	Endif
Endif


Return nOpca

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250RATINF³ Autor ³ Evaldo V. Batista    ³ Data ³ 13.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Carrega das informações nos arrays de controle aAF250IMP e ³±±
±±³          ³ aAF250DESC                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AF250RatInf(aAF250IMP, aAF250DOri)                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250RatInf(aAF250IMP, aAF250DOri)
Local nRegSn3	:= SN3->( Recno() )
Local nPosImp	:= 0
Local aRetImp	:= {}
Local nA		:= 0
Local nTamDesc	:= TamSx3('N2_HISTOR')[1]
Local lRet		:= .T.

SN1->( dbSetOrder( 1 ) ) //N1_FILIAL+N1_CBASE+N1_ITEM

//OBS: Estou considerando o filtro da tabela SN3
SN3->( dbGoTop() ) //
While !SN3->( Eof() )
	If SN3->N3_OK == cMarca
		If SN1->( dbSeek( xFilial('SN1') + SN3->(N3_CBASE+N3_ITEM), .F. ))

			IF lN1Ciap
				//Tratamento para ICMS
				nPosImp := aScan( aAF250Imp, {|Imp|	Imp[1] == 'ICMS' .and.;
													Imp[2] == SN1->N1_CALCPIS .and.;
													Imp[3] == SN1->N1_MESCPIS .and.;
													Imp[4] == !Empty(SN1->N1_CODCIAP) } )
				If nPosImp == 0
					aAdd( aAF250imp, {'ICMS', SN1->N1_CALCPIS, SN1->N1_MESCPIS, !Empty(AllTrim(SN1->N1_CODCIAP)), SN1->N1_ICMSAPR, 0 } )
				Else
					aAF250Imp[nPosImp][5] += SN1->N1_ICMSAPR
				EndIf
            Endif
		EndIf

		//Tratamento para Descricao Estendida
		If SN2->( dbSeek( SN3->(N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO), .T. ) )
			Aadd( aAF250DOri, {SN3->N3_CBASE, SN3->N3_ITEM, SN3->N3_TIPO, SN3->N3_SEQ, SN3->(Recno()), {},0} )
			While !SN2->( Eof() ) .and. SN2->(N2_FILIAL+N2_CBASE+N2_ITEM+N2_TIPO) == SN3->(N3_FILIAL+N3_CBASE+N3_ITEM+N3_TIPO)
				If SN2->N2_SEQ == SN3->N3_SEQ
					Aadd( aAF250DOri[Len(aAF250DOri),6], {SN2->N2_SEQUENC, Substr(SN2->N2_HISTOR,1,nTamDesc)} )
				EndIf
				SN2->( dbSkip() )
			EndDo
		EndIf

	EndIf
	SN3->( dbSkip() )
EndDo
SN3->( dbGoTo(nRegSN3) )

If Len( aAF250DOri ) == 0
	Aadd( aAF250DOri, {"", "", "", "", 0, {},0} )
	If Mv_Par05==2
		lRet := .F.
		Help(" ", 1, 'AF250DESCEST',, STR0108+CRLF+STR0109+CRLF+STR0101+CRLF+STR0111, 1, 0) //'Não existe [Descrição Estendida] para '###'nenhum dos bens selecionados.'###'Retorne ao inicio e defina DESCONSIDERA '###'para a pergunta [Descriçaõ estendida]'
	EndIf
EndIf
//Ponto de entrada para tratamento de outros impostos alem do ICMS
If ExistBlock('AF250RIMP')
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Devera ser retornado um array com as mesmas dimensoes e tipos de valores³
	//³que o array aAF250Imp pelo ponto de entrada.                            ³
	//³Cada linha valida retornada sera acrescentada no array aAF250Imp        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³OBS: passo o array aAF250Imp para que seja possivel verificar os impostos ja coletados.³
	//³pois e provavel que sera tratados novos impostos pelo padrao (PIS e COFINS).           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aRetImp := ExecBlock( 'AF250RIMP', .F., .F., aClone(aAF250Imp) )
	If ValType( aRetImp ) == 'A'
		For nA := 1 To Len( aRetImp )
			// Verifica se todos os tipos de dados estao corretos e se ja
			// nao existe a mesma linha retornada no array aAF250Imp
			If 	Len( aRetImp[nA] ) == 6 .and.;
				ValType(aRetImp[nA,1]) == 'C' .and.;
				ValType(aRetImp[nA,2]) == 'C' .and.;
				ValType(aRetImp[nA,3]) == 'N' .and.;
				ValType(aRetImp[nA,4]) == 'L' .and.;
				ValType(aRetImp[nA,5]) == 'N' .and.;
				ValType(aRetImp[nA,6]) == 'N' .and.;
				!('ICMS' $ Upper(aRetImp[nA,1]) )
				nPosImp :=  aScan( aAF250Imp, {|Imp| 	Imp[1] == aRetImp[nA,1] .and. Imp[2] == aRetImp[nA,2] .and.;
														Imp[3] == aRetImp[nA,3] .and. Imp[4] == aRetImp[nA,4] } )

				If nPosImp == 0
					Aadd( aAF250Imp, aClone( aRetImp[nA] ) )
				Else
					aAF250Imp[nPosImp][5] += aRetImp[nA][5]
					aAF250Imp[nPosImp][6] += aRetImp[nA][6]
				EndIF

			EndIf
		Next nA
	EndIf
EndIf

Return(lRet)

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250CTIMP ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Monta a Grid de Totais da rotina de Rateio                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe ³AF250CtImp(aAF250Imp,oFolder,aAF250Desc,oGetDadTot,oGetDadImp)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250CtImp(aAF250Imp, oFolder, aAF250Desc, oGetDadTot, oGetDadImp)
Local nA, nPosImp := 0
Local lAF250GrImp := ExistBlock('AF250GrImp')
Local aAF250GrImp := {}
Local aCols250Imp := {}
Local aColsTotais := {}

If lAF250GrImp
	//
	aAF250GrImp := ExecBlock( 'AF250GrImp', .F., .F., aClone(aAF250Imp) )
	If ValType( aAF250GrImp ) == "A"
		For nA := 1 To Len( aAF250GrImp )
			// Verifica se todos os tipos de dados estao corretos e se ja
			// nao existe a mesma linha retornada no array aAF250Imp
			If 	Len( aAF250GrImp[nA] ) == 6 .and.;
				ValType(aAF250GrImp[nA,1]) == 'C' .and.;
				ValType(aAF250GrImp[nA,2]) == 'C' .and.;
				ValType(aAF250GrImp[nA,3]) == 'N' .and.;
				ValType(aAF250GrImp[nA,4]) == 'L' .and.;
				ValType(aAF250GrImp[nA,5]) == 'N' .and.;
				ValType(aAF250GrImp[nA,6]) == 'N' .and.;
				!('ICMS' $ Upper(aAF250GrImp[nA,1]) )
				nPosImp :=  aScan( aAF250Imp, {|Imp| 	Imp[1] == aAF250GrImp[nA,1] .and. Imp[2] == aAF250GrImp[nA,2] .and.;
														Imp[3] == aAF250GrImp[nA,3] .and. Imp[4] == aAF250GrImp[nA,4] } )
				If nPosImp == 0
					Aadd( aAF250Imp, aClone( aAF250GrImp[nA] ) )
				Else
					aAF250Imp[nPosImp][5] := aAF250GrImp[nA][5]
					aAF250Imp[nPosImp][6] := aAF250GrImp[nA][6]
				EndIF
			EndIf
		Next nA
	EndIf
EndIf

Aadd( aColsTotais, {STR0105, nValor, nValRat, .F.} )
For nA := 1 To Len( aAF250Imp )
	nPosImp := aScan( aColsTotais, {|Totais| Totais[1] == aAF250Imp[nA,1] } )
	If nPosImp == 0
		Aadd( aColsTotais, {aAF250Imp[nA,1], aAF250Imp[nA,5], aAF250Imp[nA,6], .F. } )
	Else
		aColsTotais[nPosImp,2] += aAF250Imp[nA,5]
		aColsTotais[nPosImp,3] += aAF250Imp[nA,6]
	EndIf
Next nA

aEval( aAF250Imp, {|aImp| aAdd(aCols250Imp, {aImp[1], aImp[2], aImp[3], If(aImp[4],'1','2'), aImp[5], aImp[5]-aImp[6], .F.} )  } )

oGetDadTot:aCols:=aColsTotais
oGetDadTot:Refresh()

oGetDadImp:aCols:=aCols250Imp
oGetDadImp:Refresh()

oFolder:Refresh()

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250CtDesc³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Permite a atribuicao e edicao de descricoes estendidas de  ³±±
±±³          ³acordo com o parametro MV_PAR05 ("DESCRICAO ESTENDIDA")     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250CtDesc(@aAF250Desc)                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250CtDesc(aAF250Desc, oFolder, oMemo, oPanel, cTexto, oPanel4)
Local nA		:= 0
Local nTamDesc	:= TamSx3('N2_HISTOR')[1]
Local nPosDesc	:= aScan( aAF250Desc, {|aDesc| aDesc[2] == n } )

cTexto	:= ""

If nPosDesc > 0
	For nA := 1 To Len( aAF250Desc[nPosDesc][1] )
		cTexto += aAF250Desc[nPosDesc][1][nA][2]
	Next nA
EndIf

If nPosDesc > 0
	If Mv_Par05 == 1
		oMemo:lReadOnly := .F.
	Else
		oMemo:lReadOnly := !aAF250Desc[nPosDesc,3]
	EndIf
Else
	If Mv_Par05 == 1
		oMemo:lReadOnly := .F.
    Else
		oMemo:lReadOnly := .T.
    EndIF
EndIf

oMemo:Refresh()
oFolder:Refresh()

Return(.T.)

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AFDescGrv  ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Grava os dados do texto no array de controle AF250Desc     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AFDescGrv(aAF250Desc, cTexto)                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AFDescGrv(aAF250Desc, cTexto)
Local nA		:= 0
Local nLinhas	:= 0
Local nTamDesc	:= TamSx3('N2_HISTOR')[1]
Local nPosDesc	:= aScan( aAF250Desc, {|aDesc| aDesc[2] == n } )

If nPosDesc == 0
	Aadd( aAF250Desc, {{}, n, Mv_Par05==1, {}} ) //Aqui
	nLinhas := MlCount(cTexto,nTamDesc)
	For nA := 1 To nLinhas
		Aadd( aAF250Desc[Len(aAF250Desc)][1], {StrZero(nA,3), MemoLine(cTexto, nTamDesc, nA)} )
	Next
Else
	aAF250Desc[nPosDesc][1] := {}
	nLinhas := MlCount(cTexto,nTamDesc)
	For nA := 1 To nLinhas
		Aadd( aAF250Desc[nPosDesc][1], {StrZero(nA,3), MemoLine(cTexto, nTamDesc, nA)} )
	Next
EndIf

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250Perc  ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao para atualizacao dos valores de controle com base no³±±
±±³          ³percentual informado na linha de rateio                     ³±±
±±³          ³ Atualiza apenas os valores originais, depreciacao acumulada³±±
±±³          ³e totalizador de total rateado                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250Perc()                                         		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250Perc(nPerc)
Local nPercent, nVorig1, nValAnt1

//********************************
// Controle de multiplas moedas  *
//********************************
Local aPosOrig
Local aPosAc
//Local nPosOrig1, nPosOrig2, nPosOrig3, nPosOrig4, nPosOrig5
//Local nPosAc1, nPosAc2, nPosAc3, nPosAc4, nPosAc5
Local nValorItem	:= nValor

Default nPerc 		:= 0

//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aPosOrig	:= AtfMultPos(aHeader,"N3_VORIG")
Else
	aPosOrig := {0,0,0,0,0}
	aPosOrig[1] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG1" })
	aPosOrig[2] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG2" })
	aPosOrig[3] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG3" })
	aPosOrig[4] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG4" })
	aPosOrig[5] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VORIG5" })
EndIf

//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aPosAc	:= AtfMultPos(aHeader,"N3_VRDACM")
Else
	aPosAc := {0,0,0,0,0}
	aPosAc[1]   := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM1"})
	aPosAc[2]   := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM2"})
	aPosAc[3]   := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM3"})
	aPosAc[4]   := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM4"})
	aPosAc[5]   := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM5"})
EndIf
nValRat   := nValRat-aCols[n][aPosOrig[1]]

If nPerc == Nil .OR. nPerc == 0
	nPerc := &(ReadVar())
	nPerc := IIF(ValType(nPerc) == "U",0,nPerc)
EndIf

nValAnt1:= aCols[n][aPosOrig[1]]

aCols[n][aPosOrig[1]] := NoRound((nValorItem * nPerc)/100,2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ nValor  Valor inicial a ser rateado                  ³
//³ O valor rateado n"o pode ser maior que o valor origem³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nVorig1 := aCols[n][aPosOrig[1]]
If QtdComp(nVorig1) > QtdComp(nValor)
	Help(" ",1,"AF250VALOR")
	//aCols[n][aPosOrig[1]] := aValAnt[1]
	aCols[n][aPosOrig[1]] := nValAnt1
	Return .F.
Endif
If !aCols[n][nUsado+1]
	nValRat  := nValRat+nVorig1//-nValAnt1
	If QtdComp(nValRat) > QtdComp(nValor)
		Help(" ",1,"AF250VALOR")
		nValRat := nValRat-nVorig1//+nValAnt1
		aCols[n][aPosOrig[1]] := 0
		Return .F.
	Endif

	nPercent := NoRound(nVorig1/aValorOri[1],10)

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| If(x=1,.F., aCols[n][aPosOrig[x]] := aValorOri[x] * nPercent )})
	Else
		aCols[n][aPosOrig[2]] := aValorOri[2] * nPercent
		aCols[n][aPosOrig[3]] := aValorOri[3] * nPercent
		aCols[n][aPosOrig[4]] := aValorOri[4] * nPercent
		aCols[n][aPosOrig[5]] := aValorOri[5] * nPercent
	EndIf

	//********************************
	// Controle de multiplas moedas  *
	//********************************
	If lMultMoed
		AtfMultMoe(,,{|x| If(x=1,.F., aCols[n][aPosAc[x]] := aValDepAc[x] * nPercent )})
	Else
		aCols[n][aPosAc[1]]   := aValDepAc[1] * nPercent
		aCols[n][aPosAc[2]]   := aValDepAc[2] * nPercent
		aCols[n][aPosAc[3]]   := aValDepAc[3] * nPercent
		aCols[n][aPosAc[4]]   := aValDepAc[4] * nPercent
		aCols[n][aPosAc[5]]   := aValDepAc[5] * nPercent
	EndIf
Else
	Help(" ",1,"AF250VALOR")
	Return .F.
Endif

If len(aCols) > 0
	AF250ARRED(nPerc)
Endif

Return .t.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250ARRED ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Ajusta diferenca de arredondamento nos campos de valores da³±±
±±³          ³grid atuzlizados com base no percentual digitado            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250Perc(nPerc)                                     		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250ARRED(nPerc)

//********************************
// Controle de multiplas moedas  *
//********************************
Local _x, _lDetalhou, _nTotPerc:=0.00
Local _aPDepAc	:= If(lMultMoed,AtfMultMoe(,,{|x| 0.00}), {0.00,0.00,0.00,0.00,0.00} )
Local aPosAc 	:= If(lMultMoed,AtfMultMoe(,,{|x| 0.00}), {0.00,0.00,0.00,0.00,0.00} )
Local nPosPerc
//Local _x,_lDetalhou,_nPDepAc1:=0.00,_nPDepAc2:=0.00,_nPDepAc3:=0.00,;
//_nPDepAc4:=0.00,_nPDepAc5:=0.00, _nTotPerc:=0.00
//Local nPosAc1, nPosAc2, nPosAc3, nPosAc4, nPosAc5, nPosPerc
Local nPosIcms, nPosCof, nPosPis, nPosBCof, nPosBPis
Local _nPIcms  := 0.00
Local _nPCof   := 0.00
Local _nPPis   := 0.00
Local _nPBCof  := 0.00
Local _nPBPis  := 0.00

Default nPerc := 0

nPosPerc:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_PERC"})

//********************************
// Controle de multiplas moedas  *
//********************************
If lMultMoed
	aPosAc	:= AtfMultPos(aHeader,"N3_VRDACM")
Else
	aPosAc	:= {0,0,0,0,0}
	aPosAc[1] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM1"})
	aPosAc[2] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM2"})
	aPosAc[3] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM3"})
	aPosAc[4] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM4"})
	aPosAc[5] := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N3_VRDACM5"})
EndIf

nPosIcms:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_ICMSAPR"})
nPosCof := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_COFAPR"})
nPosPis := Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_PISAPR"})
nPosBCof:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_BASECOF"})
nPosBPis:= Ascan(aHeader, {|x| Alltrim(Alltrim(x[2]) ) == "N1_BASEPIS"})

_lDetalhou:=.f.
_nPercDepAc1:=0.00

// Verifico na matriz aCols se todos os percentuais ja foram digitados
For _x:=1 to len(aCols)
	If !aCols[_x][nUsado+1]

		_nTotPerc += Round(aCols[_x][nPosPerc],2) + If(n==_x .and. nPerc<>0,nPerc - Round(aCols[_x][nPosPerc],2),0)

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			AtfMultMoe(,,{|x| _aPDepAc[x] += Round(aCols[_x][aPosAc[x]],2) })
		Else
			_aPDepAc[1] += Round(aCols[_x][aPosAc[1]],2)
			_aPDepAc[2] += Round(aCols[_x][aPosAc[2]],2)
			_aPDepAc[3] += Round(aCols[_x][aPosAc[3]],2)
			_aPDepAc[4] += Round(aCols[_x][aPosAc[4]],2)
			_aPDepAc[5] += Round(aCols[_x][aPosAc[5]],2)
		EndIf

		_nPIcms   += IIF(nPosIcms > 0,Round(aCols[_x][nPosIcms],2),0)

		// Se o detalhamento atingir 100% verifico a diferenca, caso exista.
		If _nTotPerc = 100
			_lDetalhou:=.t.
		Endif
	Endif
Next

If _lDetalhou
	// Caso haja diferença de centavos no detalhamento, ajusta-se a depreciação
	//acumulada no primeiro item
	If (aValDepAc[1] - _aPDepAc[1]) <> 0

		//********************************
		// Controle de multiplas moedas  *
		//********************************
		If lMultMoed
			AtfMultMoe(,,{|x| aCols[1][aPosAc[x]]  += (aValDepAc[x] - _aPDepAc[x]) })
		Else
			aCols[1][aPosAc[1]]  += (aValDepAc[1] - _aPDepAc[1])
			aCols[1][aPosAc[2]]  += (aValDepAc[2] - _aPDepAc[2])
			aCols[1][aPosAc[3]]  += (aValDepAc[3] - _aPDepAc[3])
			aCols[1][aPosAc[4]]  += (aValDepAc[4] - _aPDepAc[4])
			aCols[1][aPosAc[5]]  += (aValDepAc[5] - _aPDepAc[5])
		EndIf
		If nPosIcms > 0
			aCols[1][nPosIcms] += (nTotIcms - _nPIcms)
		Endif
	Endif
Endif

Return .t.

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250Ciap  ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o valor de ICMS e valido                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250Ciap(nLin, nICMSApr)                          		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250Ciap(nICMSApr)
Local lRet 			:= .T.
Local nA			:= 0
Local nPosICMSAPR	:= aScan( aHeader, {|x| Upper(AllTrim(Alltrim(Alltrim(x[2]) ))) == 'N1_ICMSAPR'} )
Local nTamDecImp	:= TamSx3('N1_ICMSAPR')[2]

DEFAULT nICMSApr	:= If( ReadVar()=='M->N1_ICMSAPR', M->N1_ICMSAPR, 0 )
nValRatICMS := 0

For nA := 1 To Len( aCols )
	If nA <> n
		nValRatICMS += aCols[nA,nPosICMSAPR]
	EndIf
Next nA

If Round(NoRound(nValRatICMS+nICMSApr,nTamDecImp+1),nTamDecImp) > Round(NoRound(nTotICMS,nTamDecImp+1),nTamDecImp)
	lRet := .F.
	Help(" ",1,"AF250TOTICMS",,STR0106+CRLF+STR0107,1,0)
EndIf

If lRet
	nValRatIcms += nICMSApr
EndIf
Return( lRet )

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250AtBt  ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Define opecacoes com os botoes                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250AtBt(nBut, oLbx, aAF250DOri)                    		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function AF250AtBt(nBtn, oLbx, aAF250DOri, oGet, oMemo, aAF250Desc, oButton)
Local lRet		:= .F.
Local nPosDesc 	:= aScan( aAF250Desc, {|Desc| Desc[2] == N } )

If nBtn == 1 .or. nBtn == 2 .or. nBtn == 4
	If Mv_Par05 == 1
		oButton:lVisible := .F.
	Else
		oButton:lVisible := .T.
	EndIf
EndIf
If !Empty( aAF250DOri[oLBx:nAt, 1] )
	If nBtn == 1 .and. Mv_Par05 == 2//Atribuir
		If If(nPosDesc > 0,!aAF250Desc[nPosDesc, 3], .T.) .and. (Empty(aAF250DOri[oLbx:nAt,7])) .and. If( nPosDesc>0, aScan(aAF250Desc[nPosDesc,4], {|x| x==oLbx:nAt })==0, .T.)
			lRet := .T.
		EndIf
	ElseIf nBtn == 2  .and. Mv_Par05 == 2 //Desatribuir
		If If(nPosDesc > 0,!aAF250Desc[nPosDesc, 3], .T.) .and. (aAF250DOri[oLbx:nAt,7] == N )
			lRet := .T.
		EndIf
	ElseIf nBtn == 3 //Copiar
		If nPosDesc > 0
			If aScan( aAF250Desc[nPosDesc,4], {|x| x==oLbx:nAt } ) == 0
				lRet := .T.
			EndIf
		Else
			lRet := .T.
		EndIf
	ElseIf nBtn == 4 //Editar
		If nPosDesc == 0 .or. (nPosDesc > 0 .and. !aAF250Desc[nPosDesc, 3] )
			lRet := .T.
		EndIf
	ElseIf nBtn == 5 //Limpar
		lRet := .T.
	EndIf
EndIf
Return( lRet )

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250ExBut ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o valor de ICMS e valido                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250ExBut(nBtn, oLbx, aAF250DOri, aAF250Desc)       		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250ExBut(nBtn, oLbx, aAF250DOri, aAF250Desc, oBtn, cTexto, oMemo)
Local nPosDesc 	:= aScan( aAF250Desc, {|Desc| Desc[2] == N } )
Local nA,nB,nC	:= 0
Local nTamDesc	:= TamSx3('N2_HISTOR')[1]
lOCAL nTamLinha := TamSx3('N2_SEQUENC')[1]
Local nPos		:= 0

If nBtn == 1 .or. nBtn == 3 //Atribuir ou Copiar
	If nBtn == 1 //Atribuir
		aAF250DOri[oLbx:nAt,7] := n
	EndIf
	If nPosDesc == 0
		aAdd( aAF250Desc, {{}, N, Mv_Par05==1, {oLbx:nAt}} ) //Aqui
		nPosDesc := Len(aAF250Desc)
	Else
		aAdd( aAF250Desc[nPosDesc,4], oLbx:nAt )
	EndIf
ElseIf nBtn == 2 //Desatribuir
	aAF250DOri[oLbx:nAt,7] := 0
	If nPosDesc > 0
		nPos := aScan( aAF250Desc[nPosDesc,4], {|x| x == oLbx:nAt } )
		If nPos > 0
			aDel( aAF250Desc[nPosDesc][4], nPos )
			aSize( aAF250Desc[nPosDesc][4], Len(aAF250Desc[nPosDesc][4])-1 )
		EndIf
	EndIf
ElseIf nBtn == 4 //Editar
	oMemo:lReadOnly := .F.
	If nPosDesc > 0
		aAF250Desc[nPosDesc, 3] := .T.
	EndIf
ElseIf nBtn == 5 //Limpar
	If nPosDesc == 0
		aAdd( aAF250Desc, {{}, N, Mv_Par05==1, {}} )
	Else
		aAF250Desc[nPosDesc][1] := {}
		aAF250Desc[nPosDesc][3] := Mv_Par05==1//.F. //Aqui
		aAF250Desc[nPosDesc][4] := {}
	EndIf
	For nA := 1 To Len( aAF250DOri )
		If aAF250DOri[nA][7] == n
			aAF250DOri[nA][7] := 0
		EndIF
	Next nA
EndIf

If nPosDesc > 0 .and. !aAF250Desc[nPosDesc,3]
	aAF250Desc[nPosDesc][1] := {}
	For nA := 1 To Len( aAF250Desc[nPosDesc][4] )
		For nB := 1 To Len( aAF250DOri[aAF250Desc[nPosDesc][4][nA]][6] )
			If nB == Len( aAF250DOri[aAF250Desc[nPosDesc][4][nA]][6] )
				aAdd( aAF250Desc[nPosDesc][1], {StrZero(++nC,nTamLinha), AllTrim(aAF250DOri[aAF250Desc[nPosDesc][4][nA]][6][nB][2])+CRLF } )
			Else
				aAdd( aAF250Desc[nPosDesc][1], {StrZero(++nC,nTamLinha), aAF250DOri[aAF250Desc[nPosDesc][4][nA]][6][nB][2]} )
			EndIf
		Next nB
	Next nA
ElseIf nPosDesc > 0 .and. aAF250Desc[nPosDesc,3] .and. nBtn == 3
	For nB := 1 To Len( aAF250DOri[oLBx:nAt][6] )
		If nB == Len( aAF250DOri[oLBx:nAt][6] )
			aAdd( aAF250Desc[nPosDesc][1], {StrZero(++nC,nTamLinha), AllTrim(aAF250DOri[oLBx:nAt][6][nB][2])+CRLF } )
		Else
			aAdd( aAF250Desc[nPosDesc][1], {StrZero(++nC,nTamLinha), aAF250DOri[oLBx:nAt][6][nB][2]} )
		EndIf
	Next nB
EndIf

If nPosDesc > 0
	cTexto := ""
	For nA := 1 To Len( aAF250Desc[nPosDesc][1] )
		cTexto += aAF250Desc[nPosDesc][1][nA][2] //+ CRLF
	Next nA
EndIf

oMemo:Refresh()

Return

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³AF250AtBtR ³ Autor ³ Evaldo V. Batista    ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Atualiza os botoes de atribuicao                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³AF250AtBtR(aBtn)								       		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Atfa250                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function AF250AtBtR(aBtn, oMemoExib, cTexto, aAF250DOri,oLBx) //, oLbx, aAF250DOri, oGet, oMemo, aAF250Desc )
Local nA := 0

For nA := 1 To Len( aBtn )
	aBtn[nA]:SetFocus()
	aBtn[nA]:Refresh()
Next nA

cTexto	:= ""

For nA := 1 To Len( aAF250DOri[oLBx:nAt][6] )
	cTexto += aAF250DOri[oLBx:nAt][6][nA][2]
Next nA

oMemoExib:Refresh()

Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ AF250Grupo ³ Autor ³ Evaldo V. Batista     ³ Data ³ 14.08.08 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Preenche Taxa deprecia‡„o para todas das moedas.             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ ATFA250                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function AF250Grupo(lGrupo)

Local nTaxa 	:= 0
Local lOk 		:= .T.
Local aEntidade := {}
Local aHelpPor  := {}
Local aHelpSpa  := {}
Local aHelpEng  := {}
Local lRet 		:= .T.
Local nPosSNG 	:= 0
Local ny		:= 0
Local cSN1Grupo	:= &(ReadVar())

//********************************
// Controle de multiplas moedas  *
//********************************
Local __aNMoed

/*Local __lNMoed2	:= Empty(GETMV("MV_MOEDA2"))
Local __lNMoed3	:= Empty(GETMV("MV_MOEDA3"))
Local __lNMoed4	:= Empty(GETMV("MV_MOEDA4"))
Local __lNMoed5	:= Empty(GETMV("MV_MOEDA5"))*/
Local __lZeraDepr := GetNewPar("MV_ZRADEPR",.F.)
DEFAULT lGrupo := .F.

If lMultMoed
	__aNMoed := {}
	AtfMultMoe(,,{|x| aAdd(__aNMoed,Empty(GETMV("MV_MOEDA"+Alltrim(str(x))))) })
Else
	__aNMoed :=  { Empty(GETMV("MV_MOEDA1")),Empty(GETMV("MV_MOEDA2")),Empty(GETMV("MV_MOEDA3")),Empty(GETMV("MV_MOEDA4")),Empty(GETMV("MV_MOEDA5")) }
EndIf

SNG->(DbSeek(xFilial("SNG") + cSN1Grupo))

// Cria array com os nomes dos campos do SNG (Cadastro de grupos)
IF Len(aEntidade) == 0
	SX3->(MsSeek("SNG"))
	SX3->(DbEval( { || Aadd(aEntidade, SX3->X3_CAMPO ) }, , { || SX3->X3_ARQUIVO == "SNG" } ) )
ENDIF

For ny:=1 To Len(aHeader)
	If  Trim(aHeader[ny][2]) == "N3_TXDEPR1"
		aCols[n][ny] := SNG->NG_TXDEPR1
		If __lZeraDepr .and. !lGrupo
			nTaxa := &(ReadVar())
		EndIf
	//********************************
	// Controle de multiplas moedas  *
	//********************************
	ElseIf "N3_TXDEP" $ Trim(aHeader[ny][2])
		If "N3_TXDEPR" $ Trim(aHeader[ny][2])
			nMoed := Val(StrTran(aHeader[ny][2],"N3_TXDEPR",""))
		Else
			nMoed := Val(StrTran(aHeader[ny][2],"N3_TXDEP",""))
		EndIf
		If __aNMoed[nMoed]				/// Se não tem a moeda informada no parâmetro (Moeda em branco)
			aCols[n][ny] := 0
		Else
			aCols[n][ny] := SNG->&(If(nMoed>9,"NG_TXDEP","NG_TXDEPR")+Alltrim(Str(nMoed)))
		EndIf
/*	ElseIf Trim(aHeader[ny][2]) == "N3_TXDEPR2"
		If __lNMoed2				/// Se não tem a moeda informada no parâmetro (Moeda em branco)
			aCols[n][ny] := 0
		Else
			aCols[n][ny] := SNG->NG_TXDEPR2
		EndIf
	ElseIf Trim(aHeader[ny][2]) == "N3_TXDEPR3"
		If __lNMoed3				/// Se não tem a moeda informada no parâmetro (Moeda em branco)
			aCols[n][ny] := 0
		Else
			aCols[n][ny] := SNG->NG_TXDEPR3
		EndIf
	ElseIf Trim(aHeader[ny][2]) == "N3_TXDEPR4"
		If __lNMoed4				/// Se não tem a moeda informada no parâmetro (Moeda em branco)
			aCols[n][ny] := 0
		Else
			aCols[n][ny] := SNG->NG_TXDEPR4
		EndIf
	ElseIf Trim(aHeader[ny][2]) == "N3_TXDEPR5"
		If __lNMoed5				/// Se não tem a moeda informada no parâmetro (Moeda em branco)
			aCols[n][ny] :=  0
		Else
			aCols[n][ny] := SNG->NG_TXDEPR5
		EndIf*/
	ElseIf Trim(aHeader[nY][2]) != "N3_FILIAL" .AND. aHeader[nY][8] == "C" .AND.; // SOMENTE CAMPOS CARACTER
		(nPosSNG := aScan(aEntidade,{|cEntidade| ALLTRIM(SUBSTR(cEntidade,4,10)) == ALLTRIM(SUBSTR(aHeader[nY][2],4,10))})) > 0
		If EMPTY(aCols[n][ny]) .AND. !EMPTY(&("SNG->"+ALLTRIM(aEntidade[nPosSNG]))) // SOMENTE SE O CAMPO NO GRID ESTIVER VAZIO PARA PRESERVAR DIGITACAO
			aCols[n][ny] := &("SNG->"+aEntidade[nPosSNG])
		Endif
	EndIf
	
	If  "N3_CCONTAB" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCONTAB  
	EndIf
	If  "N3_CUSTBEM" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CUSTBEM  
	EndIf
	If  "N3_CDEPREC" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CDEPREC  
	EndIf
	If  "N3_CCUSTO" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCUSTO  
	EndIf
	If  "N3_CCDEPR" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCDEPR  
	EndIf
	If  "N3_CDESP" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CDESP  
	EndIf
	If  "N3_CCORREC" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCORREC  
	EndIf
	If  "N3_CCCORR" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCCORR  
	EndIf 
	If  "N3_CCCDEP" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCCDEP  
	EndIf
	If  "N3_CCDESP" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCDESP  
	EndIf
	If  "N3_CCCDES" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CCCDES  
	EndIf
	If  "N3_SUBCCON" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_SUBCCON  
	EndIf
	If  "N3_SUBCCOR" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_SUBCCOR  
	EndIf
	If  "N3_SUBCDEP" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_SUBCDEP  
	EndIf
	If  "N3_SUBCDES" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_SUBCDES  
	EndIf
	If  "N3_SUBCCDE" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_SUBCCDE  
	EndIf
	If  "N3_CLVLCON" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CLVLCON  
	EndIf
	If  "N3_CLVLCOR" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CLVLCOR  
	EndIf
	If  "N3_CLVLDEP" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CLVLDEP  
	EndIf
	If  "N3_CLVLDES" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CLVLDES  
	EndIf
	If  "N3_CLVLCDE" $ Trim(aHeader[ny][2])
		aCols[n][ny] := SNG->NG_CLVLCDE  
	EndIf
Next ny

If (Type('lAtfAuto') == "U" .Or. ! lAtfAuto) .And. Type("__oGet") == "O"
	__oGet:Refresh()
EndIf

Return .T.


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³MenuDef   ³ Autor ³ Ana Paula N. Silva     ³ Data ³29/11/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Utilizacao de menu Funcional                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Array com opcoes da rotina.                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³Parametros do array a Rotina:                               ³±±
±±³          ³1. Nome a aparecer no cabecalho                             ³±±
±±³          ³2. Nome da Rotina associada                                 ³±±
±±³          ³3. Reservado                                                ³±±
±±³          ³4. Tipo de Transa‡„o a ser efetuada:                        ³±±
±±³          ³		1 - Pesquisa e Posiciona em um Banco de Dados     ³±±
±±³          ³    2 - Simplesmente Mostra os Campos                       ³±±
±±³          ³    3 - Inclui registros no Bancos de Dados                 ³±±
±±³          ³    4 - Altera o registro corrente                          ³±±
±±³          ³    5 - Remove o registro corrente do Banco de Dados        ³±±
±±³          ³5. Nivel de acesso                                          ³±±
±±³          ³6. Habilita Menu Funcional                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetua
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MenuDef()
Local aAF250BUT := {}
Local nX      	:= 0
Local aRotina 	:= { 	{STR0001,"AxPesqui"   , 0 , 1 , ,.F.},; // "Pesquisar"
						{STR0002,"VIEWDEF.ATFA012" , 0 , 2},; // "Visualizar"
						{STR0003,"AF250Baix"  , 0 , 3},; // "Baixa Adiant"
						{STR0004,"Af250Canc(,,,,,,'000366','ATFA250')"  , 0 , 5} } // "Canc. Adiant"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ P.E. Utilizado para adicionar botoes ao Menu Principal       ³ //Ewerton
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("AF250BUT")
	aAF250BUT := ExecBlock("AF250BUT",.F.,.F.,aRotina)
	IF ValType(aAF250BUT) == "A" .AND. Len(aAF250BUT) > 0
		For nX := 1 to len(aAF250BUT)
			aAdd(aRotina,aAF250BUT[nX])
		Next
	ENDIF
Endif

Return(aRotina)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF250ChkCiap ºAutor  ³Marcos Berto     º Data ³  03.02.09   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Verifica se o campo N1_CIAP existe no SX3                   º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ ATFA250                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF250ChkCiap()

//Verifica N1_CIAP se a mesma ainda for nula.
If lN1Ciap == Nil

	dbSelectArea("SX3")
	SX3->(DbSetOrder(2))

	// Verifica se o campo N1_CIAP existe no SX3.
	If SX3->(DbSeek('N1_CIAP')) .AND. cPaisLoc == "BRA"
		lN1Ciap	:= .T.
	Else
		lN1Ciap	:= .F.
	EndIf

	SX3->(DbSetOrder(1))

Endif

Return


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ AF060VldTrf³ Autor ³ Claudio Donizete      ³ Data ³ 02/08/10 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ VErifica se o bem esta bloqueado e nao permite a transf.     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cFilDest	- Indica a filial de destino     						 ³±±
±±³          ³ cCodigo	- Codigo do Bem 									          ³±±
±±³          ³ cItem	- Item do Bem										             ³±±
±±³          ³ lMarc	- Indica se esta na tela de marcacao manual para	    ³±±
±±³          ³ poder mostrar o Help      			 						          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ ATFA060  												                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A250VldAquis(cCodigo,cItem,lMarc)

Local aArea, cAlias := Alias()
Local lRet     := .T.
Local lExisFicha	:= .F.
Local lCiap := .F.
Local dCiap := CTOD("")

aArea    := SN1->(GetArea())
SN1->(dbSetOrder(1))
lExisFicha := SN1->(MsSeek(xFilial("SN1")+cCodigo+cItem))
If lExisFicha .And. (!Empty(SN1->N1_DTBLOQ) .Or. SN1->N1_STATUS $ "2|3" )	//(SN1->N1_STATUS == "2"))
   If lMarc
		HELP( " ",1,"A060BLOQ" )
	EndIf
	lRet := .F.
EndIf

/*
 * Se a ficha de ativo existir, verificar se é do tipo Orçamento de Despesa de Provisão ou Provisão de Despesa para não permitir a transferência
 */
If lExisFicha
	If AllTrim(SN1->N1_PATRIM) $ "O"
		Help(" ",1,"ATFA250AO",,STR0126 ,1,0) //'Este ativo faz parte do processo de constituição de provisão. Este tipo de ativo não poderá ser transferido'
		lRet := .F.
	ElseIf AllTrim(SN1->N1_PATRIM) $ "V"
		Help(" ",1,"ATFA250AV",,STR0127 ,1,0) //'Este ativo foi gerado a partir do processo de constituição de provisão. Este tipo de ativo não poderá ser transferido'
		lRet := .F.
	EndIf
EndIf

If lRet .and. ATFXVerPrj(cCodigo,cItem, .T. )
	lRet := .F.
EndIf

//MRG
//Se o bem possuir bens gerenciais (10, 13 ou 15) não deve ser marcado
IF lRet .and. AF250TpGer(cCodigo,cItem, .T. )
	lRet := .F.
EndIf	

//Verifica se houve movimentos de apropriacao (CIAP)	
IF !Empty(SN1->N1_CODCIAP)
	DbSelectArea("SF9")
	DbSetOrder(1)
	If DbSeek(xFilial("SF9")+SN1->N1_CODCIAP)
		DbSelectArea("SFA")
		DbSetOrder(1)
		DbSeek(xFilial("SFA")+SF9->F9_CODIGO)
		While SFA->(!Eof() .And.  FA_FILIAL+FA_CODIGO == xFilial("SFA")+SF9->F9_CODIGO )
			If SFA->FA_DATA > dDataBase
				dCiap := SFA->FA_DATA
				lCiap := .T.
			EndIf			
			SFA->(DbSkip())
		Enddo
		
		If lCiap
			lRet := .F.
			Help(" ",1,"ATFA250CIAP",,STR0132 + DTOC(dCiap) ,1,0) //"Data da ultima apropriação de CIAP superior a data base do sistema."                                                                                                                                                                                                                                                                                                                                                                                                                                                
		EndIf
	Endif
EndIf

SN1->(RestArea(aArea))
dbSelectArea( cAlias )

Return(lRet)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AjRetParamºAutor  ³Alvaro Camillo Neto º Data ³  17/12/08   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Ajusta as repostas do aParambox                             º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºParametros³ aRet: Array contendo as respostas do parambox (aRetPB)     º±±
±±º          ³ aParamBox: Array de perguntas do parambox (aParam)         º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ ATFA175                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AjRetParam(aRet,aParamBox)
Local nX    := 1

If ValType(aRet) == "A" .and. Len(aRet) == Len(aParamBox)
      For nX := 1 to Len(aParamBox)
            If aParamBox[nX][1] == 1
                  aRet[nX] := aRet[nX]
            ElseIf aParamBox[nX][1] == 2 .AND. ValType(aRet[nX]) == "C"
                  aRet[nX] := aScan(aParamBox[nX][4],{|x| Alltrim(x) == aRet[nX]})
            ElseIf aParamBox[nX][1] == 2 .AND. ValType(aRet[nX]) == "N"
                  aRet[nX] := aRet[nX]
            Endif
      Next nX
EndIf
Return aRet


//AVP
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³AF250VAVP ºAutor  ³Jair Ribeiro        º Data ³  11/15/11   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Valida o uso de fichas com AVP                             º±±
±±º          ³                                                            º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Aquisicao por tranferencia                                 º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function AF250VAVP()
Local lRet		:= .T.
Local aArea		:= {}
Local cChave	:= ""
Local nI		:= 0
Local lFieldAvp	:= AFAvpAtf()


If lFieldAvp
	aAdd(aArea,GetArea())
	aAdd(aArea,SN3->(GetArea()))

	SN3->(DbGoTop())
	While SN3->(!EOF())
		If SN3->N3_OK == cMarca
	   		cChave:=SN3->N3_FILIAL+SN3->N3_CBASE+SN3->N3_ITEM
	   		SN3->(DbSetOrder(1))
			SN3->(DbSeek(cChave))
			While SN3->(!EOF()) .and. SN3->(N3_FILIAL+N3_CBASE+N3_ITEM) == cChave
				If AllTrim(SN3->N3_TIPO) $ "14"
					Help(" ", 1,"AF251IAVP",, STR0124,1,0) //"Um dos ativos selecionados possui AVP e nao pode ser utilizado por essa rotina"
					lRet := .F.
				EndIf
				SN3->(DbSkip())
			EndDo

	   	EndIf
		SN3->(DbSkip())
	EndDo
	For nI := 1 To Len(aArea)
		RestArea(aArea[nI])
	Next nI
EndIf
Return lRet



/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ ATFA250  ºAutor  ³ Marylly A. Silva   º Data ³  29/05/12   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Função que filtra os ativos com classificação de ativo:    º±±
±±º          ³ "O" -> Orçamento de Provisão de Despesa                    º±±
±±º          ³ "V" -> Provisão de Despesa                                 º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Controle AVP - ICPC 01                                     º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function AF250FTOV(cBase,cItem)
Local lRet		:= .T.
Local aArea		:= GetArea()
Local aAreaSN1	:= {}
Local aAreaSN3	:= {}

DbSelectArea("SN1")
aAreaSN1 := SN1->(GetArea())

DbSelectArea("SN3")
aAreaSN3 := SN3->(GetArea())

If SN1->(MsSeek(xFilial("SN1")+cBase+cItem))
	If AllTrim(SN1->N1_PATRIM) $ "O|V"
		lRet := .F.
	EndIf
EndIf

RestArea(aAreaSN3)
RestArea(aAreaSN1)
RestArea(aArea)
Return lRet




/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³AFVerTpGer ³ Autor ³ Mauricio Pequim Jr.  ³ Data ³ 11/09/12 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Verifica se existe tipo gerencial ou tipo 15 no bem        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ AFVerTpGer(cCBase,cItem,cTpSaldo)						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC01= Codigo base do bem                                 ³±±
±±³          ³ ExpC02= Item do bem              			              ³±±
±±³          ³ ExpL03= Mostra ou nao help                                 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
//MRG
*/
STATIC Function AF250TpGer(cBase,cItem,lHelp)

Local lRet			:= .F.
Local aArea   		:= GetArea()
Local aAreaSN3		:= SN3->(GetArea())
Local lDefTop    	:= IfDefTopCTB() // verificar se pode executar query (TOPCONN)
Local cSN3Filtro	:= ""
Local cQuery      	:= ""
Local cTabAux		:= "TRBAF250"

DEFAULT cBase	:= ""
DEFAULT cItem	:= ""
Default lHelp	:= .F.

If lDefTop
	cQuery += " SELECT "
	cQuery += "     COUNT(*) N3CONT  "
	cQuery += " FROM " + RetSqlName("SN3")
	cQuery += " WHERE "
	cQuery += "     N3_FILIAL = '"+xFilial("SN3")+"' AND "
	cQuery += "     N3_CBASE  = '"+cBase+"' AND "
	cQuery += "     N3_ITEM   = '"+cItem+"' AND "
	cQuery += "     N3_TIPO   IN ('13','15') AND "
	cQuery += "     D_E_L_E_T_= '' "
	cQuery := ChangeQuery(cQuery )
	dbUseArea( .T. , "TOPCONN" , TcGenQry(,,cQuery) , cTabAux , .T. , .F.)

	If (cTabAux)->N3CONT > 0
		lRet := .T.
	EndIf

	(cTabAux)->(dbCloseArea())

Else
	//Guarda filtro da SN3
	cSN3Filtro	:= SN3->(dbFilter())

	//Limpa o filtro da SN3
	If !Empty(cSN3Filtro)
		SN3->(dbClearFilter())
	EndIf

	SN3->(dbSetOrder(1))
	//Verifica se existe Tipo 13 - Adiantamento gerencial
	If SN3->(MsSeek(xFilial("SN3") + cBase + cItem + '13' ))
		lRet := .T.
	EndIf

	//Verifica se existe Tipo 15 - margem gerencial
	If !lRet .and. SN3->(MsSeek(xFilial("SN3") + cBase + cItem + '15' ))
		lRet := .T.
	EndIf

	//Restasra o Filtro da SN3
	If !Empty(cSN3Filtro)
		SN3->(DbSetfilter({||&cSN3Filtro},cSN3Filtro))
	EndIf
EndIf

If lRet .And. lHelp
	Help(" ",1,"AF250TPGER",,STR0128,1,0) //"Ativos com o tipo 13 - Adiantamento Gerencial ou tipo 15 - Margem Gerencial devem ser baixados pela rotina de aquisição por transfêrencia (ATFA251)."
EndIf

RestArea(aAreaSN3)
RestArea(aArea)

Return lRet
