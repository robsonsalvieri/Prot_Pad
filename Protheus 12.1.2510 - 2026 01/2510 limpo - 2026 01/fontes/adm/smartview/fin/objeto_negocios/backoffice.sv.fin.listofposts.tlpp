#include "totvs.ch"
#include "msobject.ch"
#include "tlpp-rest.th"
#include "tlpp-core.th"
#include "totvs.framework.treports.integratedprovider.th"
#include "backoffice.sv.fin.listofposts.ch"

namespace totvs.protheus.backoffice.fin.smartView.integratedProvider

@totvsFrameworkTReportsIntegratedProvider(active=.T., team="SIGAFIN", tables="SE1,SE2,FK1,FK2,FK5,F7G,SED,SA2,SA1", name="Relação de baixas", country="ALL", ;
    customTables="SE1,SE2,FK1,FK2,SED,SA2,SA1")
//-------------------------------------------------------------------
/*/{Protheus.doc} ListOfPostsSmartViewBusinessObject
Classe para criação do Objeto de Negócio para a Relação das Baixas a Pagar ou Receber

@author Fábio Andrade
@since 06/06/2023
@version 1.0
*/
//-------------------------------------------------------------------
class ListOfPostsSmartViewBusinessObject from totvs.protheus.backoffice.fin.smartView.integratedProvider.FinIntegratedProvider
    public method new() as object
    public method mySetSchema()

    protected data oFinClassUtil as object
    protected data oStatementMaxSeq as object
    protected data oStatementImpostos as object
    protected data lDistinguirJuros as logical
    protected data lFiltrarDatas as logical
    protected data nOrdem as numeric

    protected data lPagar as logical
    protected data dBaixaDe as date
    protected data dBaixaAte as date
    protected data dEmissaoDe as date
    protected data dEmissaoAte as date
    protected data dVencimentoDe as date
    protected data dVencimentoAte as date
    protected data cBancoDe as character
    protected data cBancoAte as character
    protected data cNaturezaDe as character
    protected data cNaturezaAte as character
    protected data cCliForDe as character
    protected data cCliForAte as character
    protected data nMoeda as numeric
    protected data lListarOutrasMoedas as logical
    protected data dDigitacaoDe as date
    protected data dDigitacaoAte as date
    protected data lListOfPosts as logical
    protected data lListOfInterests as logical
    protected data lPostRelationByLot as logical 
    protected data cSGBD as character 

    protected data cSelectRec as character
    protected data cSelectPay as character
    protected data cWhereRec as character
    protected data cWherePay as character

    protected method loadStatement()
    protected method loadStatementListaDeBaixasAPagar()
    protected method loadStatementListaDeBaixasAReceber()

    protected method handleData()
    protected method handleDataPay() 
    protected method handleDataRec()

    protected method handleQuery() as character
    protected method handleStatementPayable()
    protected method handleStatementReceivable()
    protected method completeStatementPayable()
    protected method completeStatementReceivable()
    protected method loadParameters()
    protected method maxSeq() as character
    protected method taxesOnIssuing() as numeric
    protected method taxesOnPosting() as numeric
    protected method loadDefaultParameters()
    protected method converteMoedaMovimento() as numeric
    protected method initializeBusinessObject()
    protected method traduzFiltroPagarParaReceber() as character
    protected method postCloseQuery()
    protected method loadMainTableSelectedBranches()
    protected method getSelectLocalizationFieldsPay() as character

endclass

//-------------------------------------------------------------------
/*{Protheus.doc} new
Método de instância da classe

@return object: self

@author Fábio Andrade
@since 06/06/2023
@version 1.0
*/
//-------------------------------------------------------------------
method new() class ListOfPostsSmartViewBusinessObject
    _Super:new()    
    self:initializeBusinessObject()

    self:setBranchFilter(.T., .T.)
    self:lShowBranchName := .T.    
    self:lDistinguirJuros := .F.
    self:lFiltrarDatas := .T.

    self:cSelectRec := ""
    self:cSelectPay := ""
    self:cWhereRec := ""
    self:cWherePay := ""
    self:nOrdem := 1

    self:cSGBD := Upper(TcGetDb())

    self:oFinClassUtil := FinClassUtil():New()

return self

//-------------------------------------------------------------------
/*{Protheus.doc} initializeBusinessObject

@author Fábio Andrade
@since 05/01/2024
@version 1.0
*/
//-------------------------------------------------------------------
method initializeBusinessObject() class ListOfPostsSmartViewBusinessObject
    self:setDisplayName(STR0002) //"Relação de Baixas"
    self:setDescription(STR0003) //"Relação de Baixas a Pagar ou Receber"

    self:setPergunte("FINT001")
return

//-------------------------------------------------------------------
/*{Protheus.doc}
    @author fabioh.andrade@totvs.com.br
    @since 14/11/2024
    @version 12.1.2410
*/
//-------------------------------------------------------------------
method loadMainTableSelectedBranches() class ListOfPostsSmartViewBusinessObject
    if self:lPagar
        self:setMainTable("SE2")
    else
        self:setMainTable("SE1")
    endIf
    _Super:loadMainTableSelectedBranches()
return 

//-------------------------------------------------------------------
/*{Protheus.doc}
    @author guilherme.sordi@totvs.com.br
    @since 10/01/2023
    @version 12.1.2310
*/
//-------------------------------------------------------------------
method loadStatement() class ListOfPostsSmartViewBusinessObject
    if self:lPagar
        self:loadStatementListaDeBaixasAPagar()
    else
        self:loadStatementListaDeBaixasAReceber()
    endIf
return

//-------------------------------------------------------------------
/*{Protheus.doc}
    @author guilherme.sordi@totvs.com.br
    @since 10/01/2023
    @version 12.1.2310
*/
//-------------------------------------------------------------------
method handleData() class ListOfPostsSmartViewBusinessObject
    If self:lPagar
        DbSelectArea("SE2")
        self:handleDataPay()
    Else
        DbSelectArea("SE1")
        self:handleDataRec()
    EndIf
return

//-------------------------------------------------------------------
/*{Protheus.doc}
    @author guilherme.sordi@totvs.com.br
    @since 10/01/2023
    @version 12.1.2310
*/
//-------------------------------------------------------------------
method postCloseQuery() class ListOfPostsSmartViewBusinessObject    
    FreeObj(self:oStatementMaxSeq)
    FreeObj(self:oStatementImpostos)
return

//-------------------------------------------------------------------
/*{Protheus.doc} mySetSchema
Retorna a estrutura dos campos e conjunto de parametros

@return object: self:oSchema

@author Fábio Andrade
@since 06/06/2023
@version 1.0
*/
//-------------------------------------------------------------------
method mySetSchema() class ListOfPostsSmartViewBusinessObject
    Local aFieldsSE2 := {} as array
    Local aFieldsSED := {} as array
    Local aFieldsFK2 := {} as array
    Local aFieldsFK5 := {} as array

    aFieldsSE2 := { "E2_FILIAL", "E2_PREFIXO", "E2_NUM", "E2_PARCELA",;
        "E2_TIPO", "E2_NATUREZ","E2_LOJA", "E2_EMISSAO","E2_BAIXA",; 
        "E2_VENCTO","E2_VENCREA", "E2_VALOR", "E2_SALDO" }
    aFieldsSED := { "ED_DESCRIC" }
    aFieldsFK2 := { "FK2_VALOR", "FK2_HISTOR", "FK2_MOTBX", "FK2_DTDIGI" }
    aFieldsFK5 := { "FK5_BANCO", "FK5_AGENCI", "FK5_CONTA" }

    self:oSchema:aliasToSchema("SE2", aFieldsSE2)
    self:oSchema:aliasToSchema("SED", aFieldsSED)
    self:oSchema:aliasToSchema("FK2", aFieldsFK2)
    self:oSchema:aliasToSchema("FK5", aFieldsFK5)

    self:finAddProperty("E2_FORNECE"     , STR0004, "string")            //"Cod. Cli/Forn."
    self:finAddProperty("F7G_DESCRI"     , STR0005, "string")            //"Motivo da Baixa"
    self:finAddProperty("DADOS_TITULO"   , STR0006, "string", "E2_NUM")  //"Dados do Título"
    self:finAddProperty("VALOR_CORRECAO" , STR0007, "number")            //"Valor de Correção"
    self:finAddProperty("VALOR_ACESSORIO", STR0008, "number")            //"Valor Acessório"
    self:finAddProperty("ABATIMENTO"     , STR0009, "number")            //"Tot. Abatimento"
    self:finAddProperty("E2_NOMFOR"      , STR0010, "string")            //"Nome Cli/Forn."
    self:finAddProperty("DADOS_CLIFOR"   , STR0011, "string", "A1_NOME") //"Dados Cli/Forn."
    self:finAddProperty("NATUREZA_BAIXA" , STR0014, "string")            //"Natureza da baixa"
    self:finAddProperty("IMPOSTOS"       , STR0015, "number")            //"Tot. Imp. Retidos"

return


//-------------------------------------------------------------------
/*{Protheus.doc} loadStatementListaDeBaixasAPagar
Retorna a query a ser executada na função getData

@author Fábio Andrade
@since 06/06/2023
@version 1.0
*/
//-------------------------------------------------------------------
method loadStatementListaDeBaixasAPagar() class ListOfPostsSmartViewBusinessObject
    Local cQuery  := "" as character

    self:aStruct := {}
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E2_EMISSAO" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E2_VENCTO" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E2_VENCREA" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E2_BAIXA" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "FK2_DATA" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "FK2_DTDIGI" ) )

    cQuery := "SELECT * FROM ( "

    cQuery += "SELECT "
    cQuery += " E2_FILIAL, E2_PREFIXO, E2_NUM, E2_PARCELA, E2_TIPO, E2_NATUREZ, "
    cQuery += " E2_FORNECE, E2_LOJA, E2_NOMFOR, E2_EMISSAO, E2_VENCTO, E2_VENCREA, E2_BAIXA, "
    cQuery += " E2_VALOR, E2_SALDO, SED.ED_DESCRIC, FK2_TPDOC, FK2_TXMOED, FK2_MOTBX, FK2_HISTOR, FK2_NATURE NATURE, SEDFK2.ED_DESCRIC DESCNATBX, "
    cQuery += " F7G_DESCRI, FK2_IDFK2, FK2_VALOR, FK2_VLMOE2, FK2_DATA, FK2_DTDIGI, FK2_MOEDA, FK2_SEQ, FK7_IDDOC, E2_MOEDA, SE2.R_E_C_N_O_ RECNO, "
    cQuery += " E2_TXMOEDA, FK5_BANCO, FK5_AGENCI, FK5_CONTA, "

    cQuery += " ? "

    self:loadCustomFieldsPayAndRec(cQuery)

    cQuery += self:cSelectCustomFieldsPay

  cQuery += " (SELECT "
    
    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
    EndIf 

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK2")
    cQuery += " 	AND FK6.FK6_IDORIG = FK2.FK2_IDFK2 "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_CORRECAO, "

    cQuery += " (SELECT 

    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),?) "
    EndIf

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK2")
    cQuery += " 	AND FK6.FK6_IDORIG = FK2.FK2_IDFK2 "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC NOT IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_ACESSORIO "

    if self:lDistinguirJuros
        cQuery += ", ( SELECT

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK2")
        cQuery += " 	AND FK6.FK6_IDORIG = FK2.FK2_IDFK2 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC = ? "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS JUROS "
        
        cQuery += ", ( SELECT 

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK2")
        cQuery += " 	AND FK6.FK6_IDORIG = FK2.FK2_IDFK2 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS MULTA " 

        cQuery += ", ( SELECT 
        
        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK2")
        cQuery += " 	AND FK6.FK6_IDORIG = FK2.FK2_IDFK2 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS DESCONTO "
    endIf

    cQuery += self:cSelectPay
    cQuery += "FROM " + RetSQLName("SE2") + " SE2 "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SED "
    cQuery += "  ON " + FWJoinFilial("SED", "SE2") + " AND "
    cQuery += "  SED.ED_CODIGO = E2_NATUREZ AND "
    cQuery += "  SED.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SA2") + "  SA2 "
    cQuery += "  ON " + FWJoinFilial("SA2", "SE2") + " AND "
    cQuery += "  SA2.A2_COD = SE2.E2_FORNECE AND "
    cQuery += "  SA2.A2_LOJA = SE2.E2_LOJA AND "
    cQuery += "  SA2.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK7") + " FK7 "
    cQuery += "  ON " + FWJoinFilial("FK7", "SE2") + " AND "
    cQuery += "  FK7.FK7_FILTIT = SE2.E2_FILIAL AND "
    cQuery += "  FK7.FK7_PREFIX = SE2.E2_PREFIXO AND "
    cQuery += "  FK7.FK7_NUM = SE2.E2_NUM AND "
    cQuery += "  FK7.FK7_PARCEL = SE2.E2_PARCELA AND "
    cQuery += "  FK7.FK7_TIPO = SE2.E2_TIPO AND "
    cQuery += "  FK7.FK7_CLIFOR = SE2.E2_FORNECE AND "
    cQuery += "  FK7.FK7_LOJA = SE2.E2_LOJA AND "
    cQuery += "  FK7.FK7_ALIAS = ? AND "
    cQuery += "  FK7.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK2") + " FK2 "
    cQuery += "  ON " + FWJoinFilial("FK2", "FK7") + " AND "
    cQuery += "  FK2.FK2_IDDOC = FK7.FK7_IDDOC AND "
    cQuery += "  FK2.FK2_MOTBX NOT IN(?) AND "

    if self:lFiltrarDatas
        cQuery += " FK2.FK2_DATA BETWEEN ? AND ? AND "
    endIf

    cQuery += " FK2.D_E_L_E_T_ = ? AND "
    cQuery += " NOT EXISTS( "
    cQuery += "  SELECT FK2EST.FK2_IDDOC FROM  " + RetSQLName("FK2") + " FK2EST "
    cQuery += "  WHERE FK2EST.FK2_IDDOC = FK2.FK2_IDDOC "
    cQuery += "   AND FK2EST.FK2_SEQ = FK2.FK2_SEQ "
    cQuery += "   AND FK2EST.FK2_TPDOC = ? "
    cQuery += "   AND FK2EST.D_E_L_E_T_ = ? ) "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SEDFK2 "
    cQuery += "  ON " + FWJoinFilial("SED", "FK2", "SEDFK2", "FK2") + " AND "
    cQuery += "  SEDFK2.ED_CODIGO = FK2_NATURE AND "
    cQuery += "  SEDFK2.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FKA") + " FKAO "
    cQuery += "  ON " + FWJoinFilial("FKA", "FK2", "FKAO", "FK2")
    cQuery += "  AND FKAO.FKA_IDORIG = FK2.FK2_IDFK2 "
    cQuery += "  AND FKAO.FKA_TABORI = ? "
    cQuery += "  AND FKAO.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FKA") + " FKAD "
    cQuery += "  ON " + FWJoinFilial("FKA", "FKA", "FKAD", "FKAO")
    cQuery += "  AND FKAD.FKA_IDPROC = FKAO.FKA_IDPROC "
    cQuery += "  AND FKAD.FKA_TABORI = ? "
    cQuery += "  AND FKAD.D_E_L_E_T_ = ? "
    if empty(self:cBancoDe)
        cQuery += " LEFT"
    else
        cQuery += " INNER"
    endIf
    cQuery += " JOIN " + RetSQLName("FK5") + " FK5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FKA", "FK5", "FKAD")
    cQuery += "  AND FK5.FK5_IDMOV = FKAD.FKA_IDORIG  "
    cQuery += "  AND FK5.FK5_BANCO BETWEEN ? AND ? "
    cQuery += "  AND FK5.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("F7G") + " F7G "
    cQuery += "  ON " + FWJoinFilial("F7G", "FK2")
    cQuery += "  AND F7G.F7G_SIGLA = FK2.FK2_MOTBX "
    cQuery += "  AND F7G.D_E_L_E_T_ = ? "
    cQuery += "WHERE "
    cQuery += self:getSQLBranchFilter()
    if self:lFiltrarDatas
        cQuery += " AND SE2.E2_EMISSAO BETWEEN ? AND ? "
        cQuery += " AND SE2.E2_VENCREA BETWEEN ? AND ? "
    endIf
    cQuery += " AND SE2.E2_NATUREZ BETWEEN ? AND ? "
    cQuery += " AND SE2.E2_FORNECE BETWEEN ? AND ? "

    if !self:lListarOutrasMoedas
        cQuery += " AND SE2.E2_MOEDA = ? "
    endIf

    cQuery +=  " ? " //Filtros

    cQuery += self:cWherePay

    cQuery += " AND SE2.D_E_L_E_T_ = ? "

    cQuery := self:handleQuery(cQuery)

    cQuery += " UNION "

    cQuery += " SELECT "
    cQuery += " E2_FILIAL, E2_PREFIXO, E2_NUM, E2_PARCELA, E2_TIPO, E2_NATUREZ, "
    cQuery += " E2_FORNECE, E2_LOJA, E2_NOMFOR, E2_EMISSAO, E2_VENCTO, E2_VENCREA, E2_BAIXA, "
    cQuery += " E2_VALOR, E2_SALDO, SED.ED_DESCRIC, FK5_TPDOC, FK5_TXMOED, E5_MOTBX, FK5_HISTOR, FK5_NATURE NATURE, SEDFK5.ED_DESCRIC DESCNATBX, "
    cQuery += " F7G_DESCRI, FK5_IDDOC, FK5_VALOR, FK5_VLMOE2, FK5_DATA, FK5_DTDISP, FK5_MOEDA, FK5_SEQ, FK5_IDDOC, E2_MOEDA, SE2.R_E_C_N_O_ RECNO, "
    cQuery += " E2_TXMOEDA, FK5_BANCO, FK5_AGENCI, FK5_CONTA, "

    cQuery += "?"

    cQuery += self:cSelectCustomFieldsPay

    cQuery += " (SELECT "
    
    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
    EndIf 

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
    cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_CORRECAO, "

    cQuery += " (SELECT 

    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),?) "
    EndIf

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
    cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC NOT IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_ACESSORIO "

    if self:lDistinguirJuros
        cQuery += ", ( SELECT

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC = ? "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS JUROS "
        
        cQuery += ", ( SELECT 

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS MULTA " 

        cQuery += ", ( SELECT 
        
        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS DESCONTO "
    endIf

    cQuery += self:cSelectPay

    cQuery += "FROM " + RetSQLName("SE2") + " SE2 "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SED "
    cQuery += "  ON " + FWJoinFilial("SED", "SE2") + " AND "
    cQuery += "  SED.ED_CODIGO = E2_NATUREZ AND "
    cQuery += "  SED.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SA2") + " SA2 "
    cQuery += "  ON " + FWJoinFilial("SA2", "SE2") + " AND "
    cQuery += "  SA2.A2_COD = SE2.E2_FORNECE AND "
    cQuery += "  SA2.A2_LOJA = SE2.E2_LOJA AND "
    cQuery += "  SA2.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK7") + " FK7 "
    cQuery += "  ON " + FWJoinFilial("FK7", "SE2") + " AND "
    cQuery += "  FK7.FK7_FILTIT = SE2.E2_FILIAL AND "
    cQuery += "  FK7.FK7_PREFIX = SE2.E2_PREFIXO AND "
    cQuery += "  FK7.FK7_NUM = SE2.E2_NUM AND "
    cQuery += "  FK7.FK7_PARCEL = SE2.E2_PARCELA AND "
    cQuery += "  FK7.FK7_TIPO = SE2.E2_TIPO AND "
    cQuery += "  FK7.FK7_CLIFOR = SE2.E2_FORNECE AND "
    cQuery += "  FK7.FK7_LOJA = SE2.E2_LOJA AND "
    cQuery += "  FK7.FK7_ALIAS = ? AND "
    cQuery += "  FK7.D_E_L_E_T_ = ? "

    if empty(self:cBancoDe)
        cQuery += " LEFT"
    else
        cQuery += " INNER"
    endIf

    cQuery += " JOIN " + RetSQLName("FK5") + " FK5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FK7")
    cQuery += "  AND FK5.FK5_IDDOC = FK7.FK7_IDDOC  "
    cQuery += "  AND FK5.FK5_BANCO BETWEEN ? AND ? "

    if self:lFiltrarDatas
        cQuery += " AND FK5.FK5_DATA BETWEEN ? AND ? "
    endIf

    cQuery += "  AND FK5.FK5_TPDOC NOT IN (?) "
    cQuery += "  AND FK5.FK5_RECPAG = ? "
    cQuery += "  AND FK5.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SEDFK5 "
    cQuery += "  ON " + FWJoinFilial("SED", "FK5", "SEDFK5", "FK5") + " AND "
    cQuery += "  SEDFK5.ED_CODIGO = FK5_NATURE AND "
    cQuery += "  SEDFK5.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SE5") + " SE5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "SE5") + " AND "
    cQuery += "  SE5.E5_IDORIG = FK5.FK5_IDMOV "
    cQuery += "  AND SE5.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("F7G") + " F7G "
    cQuery += "  ON " + FWJoinFilial("FK5", "F7G")
    cQuery += "  AND F7G.F7G_SIGLA = SE5.E5_MOTBX "
    cQuery += "  AND F7G.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FK2") + " FK2 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FK2")
    cQuery += "  AND FK2.FK2_IDDOC = FK5.FK5_IDDOC "
    cQuery += "  AND FK2.D_E_L_E_T_ = ? "
    cQuery += " WHERE "

    cQuery += self:getSQLBranchFilter()

    if self:lFiltrarDatas
        cQuery += " AND SE2.E2_EMISSAO BETWEEN ? AND ? "
        cQuery += " AND SE2.E2_VENCREA BETWEEN ? AND ? "
    endIf

    cQuery += " AND SE2.E2_NATUREZ BETWEEN ? AND ? "
    cQuery += " AND SE2.E2_FORNECE BETWEEN ? AND ? "

    if !self:lListarOutrasMoedas
        cQuery += " AND SE2.E2_MOEDA = ? "
    endIf

    cQuery +=  " ? " //Filtros

    cQuery += self:cWherePay

    cQuery += " AND SE2.D_E_L_E_T_ = ? ) QUERYPAGAR "

    cQuery += "ORDER BY " + SqlOrder(SE2->(IndexKey( 1 )))

    cQuery := ChangeQuery(cQuery)

    self:oStatement := FWExecStatement():New(cQuery)

    self:handleStatementPayable()

return


//-------------------------------------------------------------------
/*{Protheus.doc} loadStatementListaDeBaixasAReceber
Retorna a query a ser executada na função getData

@author Fábio Andrade
@since 06/06/2023
@version 1.0
*/
//-------------------------------------------------------------------
method loadStatementListaDeBaixasAReceber() class ListOfPostsSmartViewBusinessObject
    Local cQuery  := "" as character

    self:aStruct := {}
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E1_EMISSAO" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E1_VENCTO" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E1_VENCREA" ) )
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "E1_BAIXA" ) )    
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "FK1_DATA" ) )    
    aAdd(self:aStruct, FWSX3Util():GetFieldStruct( "FK1_DTDIGI" ) )    

    cQuery := "SELECT * FROM ( "

    cQuery += "SELECT "
    cQuery += " E1_FILIAL, E1_PREFIXO, E1_NUM, E1_PARCELA, E1_TIPO, E1_NATUREZ, "
    cQuery += " E1_CLIENTE, E1_LOJA, E1_NOMCLI, E1_EMISSAO, E1_VENCTO, E1_VENCREA, E1_BAIXA, "
    cQuery += " E1_VALOR, E1_SALDO, SED.ED_DESCRIC, FK1_TPDOC, FK1_TXMOED, FK1_MOTBX, FK1_HISTOR, FK1_NATURE NATURE, SEDFK1.ED_DESCRIC DESCNATBX, "
    cQuery += " F7G_DESCRI, FK1_IDFK1, FK1_VALOR, FK1_VLMOE2, FK1_DATA, FK1_DTDIGI, FK1_MOEDA, FK1_SEQ, FK7_IDDOC, E1_MOEDA, SE1.R_E_C_N_O_ RECNO, "
    cQuery += " E1_TXMOEDA, FK5_BANCO, FK5_AGENCI, FK5_CONTA, "

    self:loadCustomFieldsPayAndRec(cQuery)

    cQuery += self:cSelectCustomFieldsRec

    cQuery += " (SELECT "
    
    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
    EndIf 

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK1")
    cQuery += " 	AND FK6.FK6_IDORIG = FK1.FK1_IDFK1 "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_CORRECAO, "

      cQuery += " (SELECT 

    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),?) "
    EndIf

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK1")
    cQuery += " 	AND FK6.FK6_IDORIG = FK1.FK1_IDFK1 "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC NOT IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_ACESSORIO "

    if self:lDistinguirJuros
        cQuery += ", ( SELECT

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK1")
        cQuery += " 	AND FK6.FK6_IDORIG = FK1.FK1_IDFK1 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC = ? "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS JUROS "

        cQuery += ", ( SELECT 

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK1")
        cQuery += " 	AND FK6.FK6_IDORIG = FK1.FK1_IDFK1 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS MULTA "

        cQuery += ", ( SELECT 
        
        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK1")
        cQuery += " 	AND FK6.FK6_IDORIG = FK1.FK1_IDFK1 "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS DESCONTO "
    endIf

    cQuery += self:cSelectRec
    cQuery += "FROM " + RetSQLName("SE1") + " SE1 "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SED "
    cQuery += "  ON " + FWJoinFilial("SED", "SE1") + " AND "
    cQuery += "  SED.ED_CODIGO = E1_NATUREZ AND "
    cQuery += "  SED.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SA1") + " SA1 "
    cQuery += "  ON " + FWJoinFilial("SA1", "SE1") + " AND "
    cQuery += "  SA1.A1_COD = E1_CLIENTE AND "
    cQuery += "  SA1.A1_LOJA = E1_LOJA AND "
    cQuery += "  SA1.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK7") + " FK7 "
    cQuery += "  ON FK7.FK7_ALIAS = ? AND "
    cQuery += "  FK7.FK7_FILTIT = SE1.E1_FILIAL AND "
    cQuery += "  FK7.FK7_PREFIX = SE1.E1_PREFIXO AND "
    cQuery += "  FK7.FK7_NUM = SE1.E1_NUM AND "
    cQuery += "  FK7.FK7_PARCEL = SE1.E1_PARCELA AND "
    cQuery += "  FK7.FK7_TIPO = SE1.E1_TIPO AND "
    cQuery += "  FK7.FK7_CLIFOR = SE1.E1_CLIENTE AND "
    cQuery += "  FK7.FK7_LOJA = SE1.E1_LOJA AND "
    cQuery += "  FK7.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK1") + " FK1 "
    cQuery += "  ON " + FWJoinFilial("FK1", "FK7") + " AND "
    cQuery += "  FK1.FK1_IDDOC = FK7.FK7_IDDOC AND "
    cQuery += "  FK1.FK1_MOTBX NOT IN(?) AND "
    if self:lFiltrarDatas
        cQuery += " FK1.FK1_DATA BETWEEN ? AND ? AND "
    endIf
    cQuery += " FK1.D_E_L_E_T_ = ? AND "
    cQuery += " NOT EXISTS( "
    cQuery += "  SELECT FK1EST.FK1_IDDOC FROM " + RetSQLName("FK1") + " FK1EST "
    cQuery += "  WHERE FK1EST.FK1_IDDOC = FK1.FK1_IDDOC "
    cQuery += "   AND FK1EST.FK1_SEQ = FK1.FK1_SEQ "
    cQuery += "   AND FK1EST.FK1_TPDOC = ? "
    cQuery += "   AND FK1EST.D_E_L_E_T_ = ? ) "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SEDFK1 "
    cQuery += "  ON " + FWJoinFilial("SED", "FK1", "SEDFK1", "FK1") + " AND "
    cQuery += "  SEDFK1.ED_CODIGO = FK1_NATURE AND "
    cQuery += "  SEDFK1.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FKA") + " FKAO "
    cQuery += "  ON " + FWJoinFilial("FKA", "FK1", "FKAO", "FK1")
    cQuery += "  AND FKAO.FKA_IDORIG = FK1.FK1_IDFK1 "
    cQuery += "  AND FKAO.FKA_TABORI = ? "
    cQuery += "  AND FKAO.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FKA") + " FKAD "
    cQuery += "  ON " + FWJoinFilial("FKA","FKA", "FKAD", "FKAO")
    cQuery += "  AND FKAD.FKA_IDPROC = FKAO.FKA_IDPROC "
    cQuery += "  AND FKAD.FKA_TABORI = ? "
    cQuery += "  AND FKAD.D_E_L_E_T_ = ? "
    if empty(self:cBancoDe)
        cQuery += " LEFT"
    else
        cQuery += " INNER"
    endIf
    cQuery += " JOIN " + RetSQLName("FK5") + " FK5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FKA", "FK5", "FKAD")
    cQuery += "  AND FK5.FK5_IDMOV = FKAD.FKA_IDORIG "
    cQuery += "  AND FK5.FK5_BANCO BETWEEN ? AND ? "
    cQuery += "  AND FK5.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("F7G") + " F7G "
    cQuery += "  ON " + FWJoinFilial("F7G", "FK1")
    cQuery += "  AND F7G.F7G_SIGLA = FK1.FK1_MOTBX "
    cQuery += "  AND F7G.D_E_L_E_T_ = ? "
    cQuery += "WHERE "
    cQuery += self:getSQLBranchFilter()
    if self:lFiltrarDatas
        cQuery += " AND SE1.E1_EMISSAO BETWEEN ? AND ? "
        cQuery += " AND SE1.E1_VENCREA BETWEEN ? AND ? "
    endIf
    cQuery += " AND SE1.E1_NATUREZ BETWEEN ? AND ? "
    cQuery += " AND SE1.E1_CLIENTE BETWEEN ? AND ? "

    if !self:lListarOutrasMoedas
        cQuery += " AND SE1.E1_MOEDA = ? "
    EndIf

    cQuery += " ? " //Filtros

    cQuery += self:cWhereRec

    cQuery += " AND SE1.D_E_L_E_T_ = ? "

    cQuery := self:handleQuery(cQuery)

    cQuery += " UNION "

    cQuery += " SELECT "
    cQuery += " E1_FILIAL, E1_PREFIXO, E1_NUM, E1_PARCELA, E1_TIPO, E1_NATUREZ, "
    cQuery += " E1_CLIENTE, E1_LOJA, E1_NOMCLI, E1_EMISSAO, E1_VENCTO, E1_VENCREA, E1_BAIXA, "
    cQuery += " E1_VALOR, E1_SALDO, SED.ED_DESCRIC, FK5_TPDOC, FK5_TXMOED, E5_MOTBX, FK5_HISTOR, FK5_NATURE NATURE, SEDFK5.ED_DESCRIC DESCNATBX, "
    cQuery += " F7G_DESCRI, FK5_IDDOC, FK5_VALOR, FK5_VLMOE2, FK5_DATA, FK5_DTDISP, FK5_MOEDA, FK5_SEQ, FK5_IDDOC, E1_MOEDA, SE1.R_E_C_N_O_ RECNO, "
    cQuery += " E1_TXMOEDA, FK5_BANCO, FK5_AGENCI, FK5_CONTA, "

    cQuery += self:cSelectCustomFieldsRec

    cQuery += " (SELECT "
    
    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
    EndIf 

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
    cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_CORRECAO, "

    cQuery += " (SELECT 

    If self:cSGBD == 'ORACLE'
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),TO_NUMBER(?)) "
    Else 
        cQuery += " COALESCE(SUM(CASE WHEN FK6.FK6_TPDOC NOT IN (?) THEN FK6.FK6_VALMOV ELSE -FK6.FK6_VALMOV END),?) "
    EndIf

    cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
    cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
    cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
    cQuery += " 	AND FK6.FK6_TABORI = ? "
    cQuery += " 	AND FK6.FK6_TPDOC NOT IN (?) "
    cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS VALOR_ACESSORIO "

    if self:lDistinguirJuros
        cQuery += ", ( SELECT

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC = ? "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS JUROS "
        
        cQuery += ", ( SELECT 

        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 
        
        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS MULTA " 

        cQuery += ", ( SELECT 
        
        If self:cSGBD == 'ORACLE'
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),TO_NUMBER(?)) "
        Else 
            cQuery += " COALESCE(SUM(FK6.FK6_VALMOV),?)  "
        EndIf 

        cQuery += " 	FROM " + RetSQLName("FK6") + " FK6 "
        cQuery += " 	WHERE " + FWJoinFilial("FK6", "FK5")
        cQuery += " 	AND FK6.FK6_IDORIG = FK5.FK5_IDDOC "
        cQuery += " 	AND FK6.FK6_TABORI = ? "
        cQuery += " 	AND FK6.FK6_TPDOC IN (?) "
        cQuery += " 	AND FK6.D_E_L_E_T_ = ?) AS DESCONTO "
    endIf

    cQuery += self:cSelectRec

    cQuery += "FROM " + RetSQLName("SE1") + " SE1 "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SED "
    cQuery += "  ON " + FWJoinFilial("SED", "SE1") + " AND "
    cQuery += "  SED.ED_CODIGO = E1_NATUREZ AND "
    cQuery += "  SED.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SA1") + " SA1 "
    cQuery += "  ON " + FWJoinFilial("SA1", "SE1") + " AND "
    cQuery += "  SA1.A1_COD = SE1.E1_CLIENTE AND "
    cQuery += "  SA1.A1_LOJA = SE1.E1_LOJA AND "
    cQuery += "  SA1.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("FK7") + " FK7 "
    cQuery += "  ON " + FWJoinFilial("FK7", "SE1") + " AND "
    cQuery += "  FK7.FK7_FILTIT = SE1.E1_FILIAL AND "
    cQuery += "  FK7.FK7_PREFIX = SE1.E1_PREFIXO AND "
    cQuery += "  FK7.FK7_NUM = SE1.E1_NUM AND "
    cQuery += "  FK7.FK7_PARCEL = SE1.E1_PARCELA AND "
    cQuery += "  FK7.FK7_TIPO = SE1.E1_TIPO AND "
    cQuery += "  FK7.FK7_CLIFOR = SE1.E1_CLIENTE AND "
    cQuery += "  FK7.FK7_LOJA = SE1.E1_LOJA AND "
    cQuery += "  FK7.FK7_ALIAS = ? AND "
    cQuery += "  FK7.D_E_L_E_T_ = ? "

    if empty(self:cBancoDe)
        cQuery += " LEFT"
    else
        cQuery += " INNER"
    endIf

    cQuery += " JOIN " + RetSQLName("FK5") + " FK5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FK7")
    cQuery += "  AND FK5.FK5_IDDOC = FK7.FK7_IDDOC  "
    cQuery += "  AND FK5.FK5_BANCO BETWEEN ? AND ? "

    if self:lFiltrarDatas
        cQuery += " AND FK5.FK5_DATA BETWEEN ? AND ? "
    endIf

    cQuery += "  AND FK5.FK5_TPDOC NOT IN (?) "
    cQuery += "  AND FK5.FK5_RECPAG = ? "
    cQuery += "  AND FK5.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SED") + " SEDFK5 "
    cQuery += "  ON " + FWJoinFilial("SED", "FK5", "SEDFK5", "FK5") + " AND "
    cQuery += "  SEDFK5.ED_CODIGO = FK5_NATURE AND "
    cQuery += "  SEDFK5.D_E_L_E_T_ = ? "
    cQuery += " INNER JOIN " + RetSQLName("SE5") + " SE5 "
    cQuery += "  ON " + FWJoinFilial("FK5", "SE5") + " AND "
    cQuery += "  SE5.E5_IDORIG = FK5.FK5_IDMOV "
    cQuery += "  AND SE5.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("F7G") + " F7G "
    cQuery += "  ON " + FWJoinFilial("FK5", "F7G")
    cQuery += "  AND F7G.F7G_SIGLA = SE5.E5_MOTBX "
    cQuery += "  AND F7G.D_E_L_E_T_ = ? "
    cQuery += " LEFT JOIN " + RetSQLName("FK1") + " FK1 "
    cQuery += "  ON " + FWJoinFilial("FK5", "FK1")
    cQuery += "  AND FK1.FK1_IDDOC = FK5.FK5_IDDOC "
    cQuery += "  AND FK1.D_E_L_E_T_ = ? "
    cQuery += " WHERE "

    cQuery += self:getSQLBranchFilter()

    if self:lFiltrarDatas
        cQuery += " AND SE1.E1_EMISSAO BETWEEN ? AND ? "
        cQuery += " AND SE1.E1_VENCREA BETWEEN ? AND ? "
    endIf

    cQuery += " AND SE1.E1_NATUREZ BETWEEN ? AND ? "
    cQuery += " AND SE1.E1_CLIENTE BETWEEN ? AND ? "

    if !self:lListarOutrasMoedas
        cQuery += " AND SE1.E1_MOEDA = ? "
    endIf

    cQuery +=  " ? " //Filtros

    cQuery += self:cWhereRec

    cQuery += " AND SE1.D_E_L_E_T_ = ? ) QUERYRECEBER "

    cQuery += "ORDER BY " + SqlOrder(SE1->(IndexKey( 1 )))

    cQuery := ChangeQuery(cQuery)

    self:oStatement := FWExecStatement():New(cQuery)

    self:handleStatementReceivable()

Return


//-------------------------------------------------------------------
/*{Protheus.doc} handleStatementPayable
Permite manipular os parametros da query.


@author Matheus Monteiro da Silva
@since 27/12/2023
@version 1.0
*/
//-------------------------------------------------------------------
method handleStatementPayable() class ListOfPostsSmartViewBusinessObject
    
    self:oStatement:SetUnsafe(self:nOrdem++, self:getSelectLocalizationFieldsPay())
	self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK2')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetIn(self:nOrdem++, {'DC', 'D2'})
	self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK2')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})	
	self:oStatement:SetString(self:nOrdem++, ' ')
    if self:lDistinguirJuros
		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK2')
		self:oStatement:SetString(self:nOrdem++, 'JR')
		self:oStatement:SetString(self:nOrdem++, ' ')

		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK2')
		self:oStatement:SetIn(self:nOrdem++, {'MT', 'M2'})
		self:oStatement:SetString(self:nOrdem++, ' ')

        self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK2')
		self:oStatement:SetIn(self:nOrdem++, {'D2','DC'})
		self:oStatement:SetString(self:nOrdem++, ' ')
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, 'SE2')
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetIn(self:nOrdem++, {'DSD', 'STP'})
    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaDe)
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaAte)
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, 'ES')
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, 'FK2')
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetString(self:nOrdem++, ' ')

    self:oStatement:SetString(self:nOrdem++, self:cBancoDe)
    self:oStatement:SetString(self:nOrdem++, self:cBancoAte)
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, ' ')
    self:setStatementBranchFilter(@self:nOrdem)
    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoAte)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoAte)
    endIf
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaDe)
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaAte)
    self:oStatement:SetString(self:nOrdem++, self:cCliForDe)
    self:oStatement:SetString(self:nOrdem++, self:cCliForAte)

    If !self:lListarOutrasMoedas
        self:oStatement:SetNumeric(self:nOrdem++, self:nMoeda)
    EndIf

    self:oStatement:SetUnsafe(self:nOrdem++, self:getFilterToSQL(.T.)) //Retorna apenas o filtro	

    self:completeStatementPayable()

    self:oStatement:SetString(self:nOrdem++, ' ')

    self:oStatement:SetUnsafe(self:nOrdem++, self:getSelectLocalizationFieldsPay())
    self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetIn(self:nOrdem++, {'DC', 'D2'})
	self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})	
	self:oStatement:SetString(self:nOrdem++, ' ')
    if self:lDistinguirJuros
		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetString(self:nOrdem++, 'JR')
		self:oStatement:SetString(self:nOrdem++, ' ')

		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetIn(self:nOrdem++, {'MT', 'M2'})
		self:oStatement:SetString(self:nOrdem++, ' ')

        self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetIn(self:nOrdem++, {'D2','DC'})
		self:oStatement:SetString(self:nOrdem++, ' ')
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetString(self:nOrdem++, 'SE2')
	self:oStatement:SetString(self:nOrdem++, ' ')

    self:oStatement:SetString(self:nOrdem++, self:cBancoDe)
    self:oStatement:SetString(self:nOrdem++, self:cBancoAte)

    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaDe)
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaAte)
    endIf

	self:oStatement:SetIn(self:nOrdem++, {'ES','E2','DH'})
    self:oStatement:SetString(self:nOrdem++, 'P')
	self:oStatement:SetString(self:nOrdem++, ' ')
    
	self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')

    self:setStatementBranchFilter(@self:nOrdem)

    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoAte)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoAte)
    endIf

    self:oStatement:SetString(self:nOrdem++, self:cNaturezaDe)
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaAte)
    self:oStatement:SetString(self:nOrdem++, self:cCliForDe)
    self:oStatement:SetString(self:nOrdem++, self:cCliForAte)
    
    If !self:lListarOutrasMoedas
        self:oStatement:SetNumeric(self:nOrdem++, self:nMoeda)
    EndIf

    self:oStatement:SetUnsafe(self:nOrdem++, self:getFilterToSQL(.T.)) //Retorna apenas o filtro	

    self:completeStatementPayable()

    self:oStatement:SetString(self:nOrdem++, ' ')
return

//-------------------------------------------------------------------
/*{Protheus.doc} handleStatementReceivable
Permite manipular os parametros da query.


@author Matheus Monteiro da Silva
@since 27/12/2023
@version 1.0
*/
//-------------------------------------------------------------------
method handleStatementReceivable() class ListOfPostsSmartViewBusinessObject

    self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK1')
	self:oStatement:SetIn(self:nOrdem++, {'CM','VM','C2'})
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetIn(self:nOrdem++, {'DC', 'D2'})
	self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK1')
	self:oStatement:SetIn(self:nOrdem++, {'CM','VM','C2'})
	self:oStatement:SetString(self:nOrdem++, ' ')
	
    if self:lDistinguirJuros
		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK1')
		self:oStatement:SetString(self:nOrdem++, 'JR')
		self:oStatement:SetString(self:nOrdem++, ' ')
		
        self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK1')
		self:oStatement:SetIn(self:nOrdem++, {'MT', 'M2'})
		self:oStatement:SetString(self:nOrdem++, ' ')
		
		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK1')
		self:oStatement:SetIn(self:nOrdem++, {'D2','DC'})
		self:oStatement:SetString(self:nOrdem++, ' ')
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, 'SE1')
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetIn(self:nOrdem++, {'DSD','STP'})
    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++, self:dBaixaDe)
        self:oStatement:SetDate(self:nOrdem++, self:dBaixaAte)
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, 'ES')
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, ' ')

	self:oStatement:SetString(self:nOrdem++, 'FK1')
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetString(self:nOrdem++, ' ')
	
    self:oStatement:SetString(self:nOrdem++, self:cBancoDe)
    self:oStatement:SetString(self:nOrdem++, self:cBancoAte)
	self:oStatement:SetString(self:nOrdem++, ' ')
	
	self:oStatement:SetString(self:nOrdem++, ' ')
	
    self:setStatementBranchFilter(@self:nOrdem)
    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoAte)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoAte)
    endIf
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaDe)
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaAte)
    self:oStatement:SetString(self:nOrdem++, self:cCliForDe)
    self:oStatement:SetString(self:nOrdem++, self:cCliForAte)

    If !self:lListarOutrasMoedas
        self:oStatement:SetNumeric(self:nOrdem++, self:nMoeda)
    EndIf

    self:oStatement:SetUnsafe(self:nOrdem++, self:traduzFiltroPagarParaReceber(self:getFilterToSQL(.T.))) //Retorna apenas o filtro)

    self:completeStatementReceivable()

    self:oStatement:SetString(self:nOrdem++, ' ')

    self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetIn(self:nOrdem++, {'DC', 'D2'})
	self:oStatement:SetNumeric(self:nOrdem++, 0)
	self:oStatement:SetString(self:nOrdem++, 'FK5')
	self:oStatement:SetIn(self:nOrdem++, {'CM', 'VM','C2'})	
	self:oStatement:SetString(self:nOrdem++, ' ')
    if self:lDistinguirJuros
		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetString(self:nOrdem++, 'JR')
		self:oStatement:SetString(self:nOrdem++, ' ')

		self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetIn(self:nOrdem++, {'MT', 'M2'})
		self:oStatement:SetString(self:nOrdem++, ' ')

        self:oStatement:SetNumeric(self:nOrdem++, 0)
		self:oStatement:SetString(self:nOrdem++, 'FK5')
		self:oStatement:SetIn(self:nOrdem++, {'D2','DC'})
		self:oStatement:SetString(self:nOrdem++, ' ')
    endIf
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetString(self:nOrdem++, ' ')
	self:oStatement:SetString(self:nOrdem++, 'SE1')
	self:oStatement:SetString(self:nOrdem++, ' ')

    self:oStatement:SetString(self:nOrdem++, self:cBancoDe)
    self:oStatement:SetString(self:nOrdem++, self:cBancoAte)

    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaDe)
        self:oStatement:SetDate(self:nOrdem++,  self:dBaixaAte)
    endIf

	self:oStatement:SetIn(self:nOrdem++, {'ES','E2','DH'})
    self:oStatement:SetString(self:nOrdem++, 'R')
	self:oStatement:SetString(self:nOrdem++, ' ')
    
	self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')
    self:oStatement:SetString(self:nOrdem++, ' ')

    self:setStatementBranchFilter(@self:nOrdem)

    if self:lFiltrarDatas
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dEmissaoAte)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoDe)
        self:oStatement:SetDate(self:nOrdem++, self:dVencimentoAte)
    endIf

    self:oStatement:SetString(self:nOrdem++, self:cNaturezaDe)
    self:oStatement:SetString(self:nOrdem++, self:cNaturezaAte)
    self:oStatement:SetString(self:nOrdem++, self:cCliForDe)
    self:oStatement:SetString(self:nOrdem++, self:cCliForAte)
    
    If !self:lListarOutrasMoedas
        self:oStatement:SetNumeric(self:nOrdem++, self:nMoeda)
    EndIf

    self:oStatement:SetUnsafe(self:nOrdem++, self:traduzFiltroPagarParaReceber(self:getFilterToSQL(.T.))) //Retorna apenas o filtro)	

    self:completeStatementReceivable()

    self:oStatement:SetString(self:nOrdem++, ' ')
return

//-------------------------------------------------------------------
/*{Protheus.doc} traduzFiltroPagarParaReceber

@return character: cQuery
@author Fábio Andrade
@since 05/01/2024
@version 1.0
*/
//-------------------------------------------------------------------
method traduzFiltroPagarParaReceber(cFiltro) as character class ListOfPostsSmartViewBusinessObject
    cFiltro := replace(cFiltro, "E2_FORNECE", "E1_CLIENTE")
    cFiltro := replace(cFiltro, "E2_NOMFOR", "E1_NOMCLI")
    cFiltro := replace(cFiltro, "FK2","FK1")
    cFiltro := replace(cFiltro, "E2_","E1_")
return cFiltro

//-------------------------------------------------------------------
/*{Protheus.doc} handleDataPay
Adiciona dados das baixas no objeto de negócios

@return character: cQuery

@author Fábio Andrade
@since 30/05/2023
@version 1.0
*/
//-------------------------------------------------------------------
method handleDataPay() class ListOfPostsSmartViewBusinessObject
    Local nSaldo             := 0  as numeric
    Local nTaxesOnIssuing    := 0  as numeric
    Local nTaxes             := 0  as numeric
    Local nValor             := 0  as numeric
    Local nBaixa             := 0  as numeric
    Local nTxOrigem          := 0  as numeric
    Local nTxDestino         := 0  as numeric
    Local nMoedaBaixa        := 0  as numeric
    Local cDadosTitulo       := "" as character
    Local cDadosFornece      := "" as character
    Local nAbatimento        := 0  as numeric
    Local nValoresAcessorios := 0  as numeric
    Local nValorCorrecao     := 0  as numeric
    Local cNaturezaBaixa     := "" as character

    SE2->(DBGoTo((self:cAlias)->RECNO))

    nMoedaBaixa := Val(AllTrim((self:cAlias)->FK2_MOEDA))

    nTaxesOnIssuing := self:taxesOnIssuing() 
    nTaxes := self:taxesOnPosting()


    nAbatimento := 0
    If (self:cAlias)->E2_SALDO == 0 .and. (self:cAlias)->FK2_SEQ == self:maxSeq()
        nAbatimento := SomaAbat((self:cAlias)->E2_PREFIXO,(self:cAlias)->E2_NUM,(self:cAlias)->E2_PARCELA,"P",(self:cAlias)->E2_MOEDA,,(self:cAlias)->E2_FORNECE,(self:cAlias)->E2_LOJA)
        nTaxes += nTaxesOnIssuing
    EndIf

    If (self:cAlias)->E2_MOEDA > 1 .And. nMoedaBaixa == self:nMoeda
        nTxOrigem := (self:cAlias)->E2_TXMOEDA
        nTxDestino := (self:cAlias)->FK2_TXMOED
    Else 
        nTxOrigem := (self:cAlias)->FK2_TXMOED
        nTxDestino := 0
    EndIf

    nValor := xMoeda((self:cAlias)->E2_VALOR+nTaxesOnIssuing,(self:cAlias)->E2_MOEDA, self:nMoeda,(self:cAlias)->E2_EMISSAO, self:nDecimals, nTxOrigem,nTxDestino)
    nSaldo := xMoeda((self:cAlias)->E2_SALDO,(self:cAlias)->E2_MOEDA, self:nMoeda,(self:cAlias)->E2_EMISSAO, self:nDecimals, nTxOrigem,nTxDestino)
    nAbatimento:= xMoeda(nAbatimento,(self:cAlias)->E2_MOEDA, self:nMoeda, (self:cAlias)->E2_EMISSAO,  self:nDecimals, nTxOrigem,nTxDestino)
    nTaxes:= xMoeda(nTaxes,(self:cAlias)->E2_MOEDA, self:nMoeda, (self:cAlias)->E2_EMISSAO,  self:nDecimals, nTxOrigem,nTxDestino)

    nBaixa := xMoeda((self:cAlias)->FK2_VALOR,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK2_DATA , self:nDecimals, nTxOrigem,nTxDestino)
    nValoresAcessorios := xMoeda((self:cAlias)->VALOR_ACESSORIO,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK2_DATA , self:nDecimals, nTxOrigem)
    nValorCorrecao     := xMoeda((self:cAlias)->VALOR_CORRECAO ,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK2_DATA , self:nDecimals, nTxOrigem)

    cDadosTitulo := AllTrim((self:cAlias)->E2_PREFIXO)+"-"+AllTrim((self:cAlias)->E2_NUM)+"-"+AllTrim((self:cAlias)->E2_PARCELA)+"-"+AllTrim((self:cAlias)->E2_TIPO)
    cDadosFornece:= AllTrim((self:cAlias)->E2_FORNECE)+"/"+ AllTrim((self:cAlias)->E2_LOJA)+"-"+AllTrim((self:cAlias)->E2_NOMFOR)
    cNaturezaBaixa := self:oFinClassUtil:mascNat((self:cAlias)->NATURE) + " - " + AllTrim((self:cAlias)->DESCNATBX)

    self:jData := {"E2_FILIAL":     AllTrim((self:cAlias)->E2_FILIAL),;
        "E2_FORNECE":     AllTrim((self:cAlias)->E2_FORNECE),;
        "E2_LOJA":        AllTrim((self:cAlias)->E2_LOJA),;
        "E2_NOMFOR":      AllTrim((self:cAlias)->E2_NOMFOR),;
        "E2_PREFIXO":     AllTrim((self:cAlias)->E2_PREFIXO),;
        "E2_NUM":         AllTrim((self:cAlias)->E2_NUM),;
        "E2_PARCELA":     AllTrim((self:cAlias)->E2_PARCELA),;
        "E2_TIPO":        AllTrim((self:cAlias)->E2_TIPO),;
        "E2_EMISSAO":     self:varToTimeStamp( (self:cAlias)->E2_EMISSAO ),;
        "E2_VENCTO":      self:varToTimeStamp( (self:cAlias)->E2_VENCTO ),;
        "E2_VENCREA":     self:varToTimeStamp( (self:cAlias)->E2_VENCREA ),;
        "E2_BAIXA":       self:varToTimeStamp( (self:cAlias)->FK2_DATA ),;
        "FK2_DTDIGI":     self:varToTimeStamp( (self:cAlias)->FK2_DTDIGI ),;
        "FK5_BANCO":      AllTrim((self:cAlias)->FK5_BANCO),;
        "FK5_AGENCI":     AllTrim((self:cAlias)->FK5_AGENCI),;
        "FK5_CONTA":      AllTrim((self:cAlias)->FK5_CONTA),;
        "E2_VALOR":       nValor,;
        "E2_SALDO":       nSaldo,;
        "FK2_VALOR":      nBaixa,;
        "ABATIMENTO":     nAbatimento,;
        "FK2_MOTBX":      AllTrim((self:cAlias)->FK2_MOTBX),;
        "FK2_HISTOR":     AllTrim((self:cAlias)->FK2_HISTOR),;
        "E2_NATUREZ":     self:oFinClassUtil:mascNat((self:cAlias)->E2_NATUREZ),;
        "NATUREZA_BAIXA": cNaturezaBaixa,;
        "ED_DESCRIC":     AllTrim((self:cAlias)->ED_DESCRIC),;
        "F7G_DESCRI":     AllTrim((self:cAlias)->F7G_DESCRI),;
        "DADOS_TITULO":   cDadosTitulo,;
        "DADOS_CLIFOR":   cDadosFornece,;
        "IMPOSTOS":       nTaxes,;
        "VALOR_CORRECAO": nValorCorrecao,;
        "VALOR_ACESSORIO":nValoresAcessorios}

return

//-------------------------------------------------------------------
/*{Protheus.doc} handleDataRec
Adiciona dados das baixas no objeto de negócios

@return character: cQuery

@author Fábio Andrade
@since 30/05/2023
@version 1.0
*/
//-------------------------------------------------------------------
method handleDataRec() class ListOfPostsSmartViewBusinessObject
    Local nSaldo             := 0  as numeric
    Local nTaxes             := 0  as numeric
    Local nValor             := 0  as numeric
    Local nBaixa             := 0  as numeric
    Local nTxOrigem          := 0  as numeric
    Local nTxDestino         := 0  as numeric
    Local nMoedaBaixa        := 0  as numeric
    Local cDadosTitulo       := "" as character
    Local cDadosCliente      := "" as character
    Local nAbatimento        := 0  as numeric
    Local nAbatImp           := 0  as numeric
    Local nValoresAcessorios := 0  as numeric
    Local nValorCorrecao     := 0  as numeric
    Local cNaturezaBaixa     := "" as character

    SE1->(DBGoTo((self:cAlias)->RECNO))

    nAbatimento := 0
    nAbatImp    := 0  
    nTxOrigem := 0
    nTxDestino := 0
    nTaxes := self:taxesOnPosting()
    if (self:cAlias)->E1_SALDO == 0 .and. (self:cAlias)->FK1_SEQ == self:maxSeq()
        nAbatimento := SumAbatRec((self:cAlias)->E1_PREFIXO, (self:cAlias)->E1_NUM, (self:cAlias)->E1_PARCELA, (self:cAlias)->E1_MOEDA, "V", (self:cAlias)->FK1_DATA, @nAbatImp, , Nil, Nil, Nil, Nil, Nil, Nil, Nil, .T.)
        nAbatimento := nAbatimento - nAbatImp
        nTaxes += nAbatImp 
    endIf

    nMoedaBaixa := Val(AllTrim((self:cAlias)->FK1_MOEDA))
    If (self:cAlias)->E1_MOEDA > 1 .And. nMoedaBaixa == self:nMoeda
        nTxOrigem := (self:cAlias)->E1_TXMOEDA
        nTxDestino := (self:cAlias)->FK1_TXMOED
    EndIf

    nValor := xMoeda((self:cAlias)->E1_VALOR,(self:cAlias)->E1_MOEDA, self:nMoeda,(self:cAlias)->E1_EMISSAO, self:nDecimals, nTxOrigem,nTxDestino)
    nSaldo := xMoeda((self:cAlias)->E1_SALDO,(self:cAlias)->E1_MOEDA, self:nMoeda,(self:cAlias)->E1_EMISSAO, self:nDecimals, nTxOrigem,nTxDestino)
    nAbatimento:= xMoeda(nAbatimento,(self:cAlias)->E1_MOEDA, self:nMoeda, (self:cAlias)->E1_EMISSAO,  self:nDecimals, nTxOrigem,nTxDestino)

    nBaixa := xMoeda((self:cAlias)->FK1_VALOR,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK1_DATA , self:nDecimals, nTxOrigem,nTxDestino)
    nValoresAcessorios := xMoeda((self:cAlias)->VALOR_ACESSORIO,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK1_DATA , self:nDecimals, nTxOrigem)
    nValorCorrecao     := xMoeda((self:cAlias)->VALOR_CORRECAO ,nMoedaBaixa, self:nMoeda,(self:cAlias)->FK1_DATA , self:nDecimals, nTxOrigem)

    cDadosTitulo := AllTrim((self:cAlias)->E1_PREFIXO)+"-"+AllTrim((self:cAlias)->E1_NUM)+"-"+AllTrim((self:cAlias)->E1_PARCELA)
    cDadosCliente:= AllTrim((self:cAlias)->E1_CLIENTE)+"/"+ AllTrim((self:cAlias)->E1_LOJA)+"-"+AllTrim((self:cAlias)->E1_NOMCLI)
    cNaturezaBaixa := self:oFinClassUtil:mascNat((self:cAlias)->NATURE) + " - " + AllTrim((self:cAlias)->DESCNATBX)

    self:jData := {"E2_FILIAL":     AllTrim((self:cAlias)->E1_FILIAL),;
        "E2_FORNECE":     AllTrim((self:cAlias)->E1_CLIENTE),;
        "E2_LOJA":        AllTrim((self:cAlias)->E1_LOJA),;
        "E2_NOMFOR":      AllTrim((self:cAlias)->E1_NOMCLI),;
        "E2_PREFIXO":     AllTrim((self:cAlias)->E1_PREFIXO),;
        "E2_NUM":         AllTrim((self:cAlias)->E1_NUM),;
        "E2_PARCELA":     AllTrim((self:cAlias)->E1_PARCELA),;
        "E2_TIPO":        AllTrim((self:cAlias)->E1_TIPO),;
        "E2_EMISSAO":     self:varToTimeStamp( (self:cAlias)->E1_EMISSAO ),;
        "E2_VENCTO":      self:varToTimeStamp( (self:cAlias)->E1_VENCTO ),;
        "E2_VENCREA":     self:varToTimeStamp( (self:cAlias)->E1_VENCREA ),;
        "E2_BAIXA":       self:varToTimeStamp( (self:cAlias)->FK1_DATA ),;
        "FK2_DTDIGI":     self:varToTimeStamp( (self:cAlias)->FK1_DTDIGI ),;
        "FK5_BANCO":      AllTrim((self:cAlias)->FK5_BANCO),;
        "FK5_AGENCI":     AllTrim((self:cAlias)->FK5_AGENCI),;
        "FK5_CONTA":      AllTrim((self:cAlias)->FK5_CONTA),;
        "E2_VALOR":       nValor,;
        "E2_SALDO":       nSaldo,;
        "FK2_VALOR":      nBaixa,;
        "ABATIMENTO":     nAbatimento,;
        "FK2_MOTBX":      AllTrim((self:cAlias)->FK1_MOTBX),;
        "FK2_HISTOR":     AllTrim((self:cAlias)->FK1_HISTOR),;
        "E2_NATUREZ":     self:oFinClassUtil:mascNat((self:cAlias)->E1_NATUREZ),;
        "NATUREZA_BAIXA": cNaturezaBaixa,;
        "ED_DESCRIC":     AllTrim((self:cAlias)->ED_DESCRIC),;
        "F7G_DESCRI":     AllTrim((self:cAlias)->F7G_DESCRI),;
        "DADOS_TITULO":   cDadosTitulo,;
        "DADOS_CLIFOR":   cDadosCliente,;
        "IMPOSTOS":       nTaxes,;
        "VALOR_CORRECAO": nValorCorrecao,;
        "VALOR_ACESSORIO":nValoresAcessorios}

return

//-------------------------------------------------------------------
/*{Protheus.doc} loadDefaultParameters
    Define um padrão para os parâmetros do relatório, levando em consideração
    que classes extendidas podem não usar os mesmos parâmetros.
    @author guilherme.sordi@totvs.com.br
    @since 24/08/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method loadDefaultParameters() class ListOfPostsSmartViewBusinessObject
    self:lListOfPosts := ( self:cPergunte == 'FINT001' )
    self:lListOfInterests := ( self:cPergunte == 'FINT010' )
    self:lPostRelationByLot := ( self:cPergunte == 'FINT018' )

    self:lPagar := .F.
    self:dBaixaDe := cToD('01/01/1900')
    self:dBaixaAte := cToD('31/12/2099')

    self:dEmissaoDe := cToD('01/01/1900')
    self:dEmissaoAte := cToD('31/12/2099')
    self:dVencimentoDe := cToD('01/01/1900')
    self:dVencimentoAte := cToD('31/12/2099')
    self:cBancoDe := " "
    self:cBancoAte := "ZZZ"
    self:cNaturezaDe := " "
    self:cNaturezaAte := "ZZZ"
    self:cCliForDe := " "
    self:cCliForAte := "ZZZ"

    self:dDigitacaoDe := cToD('01/01/1900')
    self:dDigitacaoAte := cToD('31/12/2099')

    self:nMoeda := 1
    self:lListarOutrasMoedas := .F. 
return

//-------------------------------------------------------------------
/*{Protheus.doc} loadParameters
    Definição de parâmetros do objeto de negócio
    @author guilherme.sordi@totvs.com.br
    @since 21/06/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method loadParameters() class ListOfPostsSmartViewBusinessObject    
    if self:oCurrentFilter != NIL
        self:lPagar := MV_PAR01 == 1
        self:dBaixaDe := MV_PAR02
        self:dBaixaAte := MV_PAR03
        self:dEmissaoDe := MV_PAR04
        self:dEmissaoAte := MV_PAR05
        self:dVencimentoDe := MV_PAR06
        self:dVencimentoAte := MV_PAR07
        self:cBancoDe := MV_PAR08
        self:cBancoAte := MV_PAR09
        self:cNaturezaDe := MV_PAR10
        self:cNaturezaAte := MV_PAR11
        self:cCliForDe := MV_PAR12
        self:cCliForAte := MV_PAR13
        self:nMoeda := self:getCurrencyValue(MV_PAR14)
        self:lListarOutrasMoedas := MV_PAR15 == 1
    endIf
return

//-------------------------------------------------------------------
/*{Protheus.doc} maxSeq
    Retorna a maior sequencia de baixa do registro posicionado em self:cAlias
    @author guilherme.sordi@totvs.com.br
    @since 21/06/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method maxSeq() as character class ListOfPostsSmartViewBusinessObject
    local cQuery := "" as character
    local cRet := "" as character
    local nOrdem := 1 as numeric

    if self:oStatementMaxSeq == NIL
        if self:lPagar
            cQuery := "SELECT COALESCE(MAX(FK2_SEQ),?) MAXSEQ FROM "+ RetSQLName("FK2") +" FK2 WHERE FK2_IDDOC = ? AND FK2.D_E_L_E_T_ = ? "
        else
            cQuery := "SELECT COALESCE(MAX(FK1_SEQ),?) MAXSEQ FROM "+ RetSQLName("FK1") +" FK1 WHERE FK1_IDDOC = ? AND FK1.D_E_L_E_T_ = ? "
        endIf
        self:oStatementMaxSeq := FWExecStatement():New(changeQuery(cQuery))
    endIf

    self:oStatementMaxSeq:SetString(nOrdem++,'0')
    self:oStatementMaxSeq:setString(nOrdem++, (self:cAlias)->FK7_IDDOC)
    self:oStatementMaxSeq:SetString(nOrdem++,' ')

    cRet := self:oStatementMaxSeq:ExecScalar("MAXSEQ")
return cRet


//-------------------------------------------------------------------
/*{Protheus.doc} taxesOnIssuing
    retorna o total de retenção de impostos retidos na emissão 
    para o registro posicionado no self:cAlias
    @author Pâmela Bernardo
    @since 30/06/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method taxesOnIssuing() as numeric class ListOfPostsSmartViewBusinessObject
    
return 0


//-------------------------------------------------------------------
/*{Protheus.doc} taxesOnPosting
    retorna o total de retenção de impostos na baixa para o registro posicionado no self:cAlias
    @author Pâmela Bernardo
    @since 30/06/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method taxesOnPosting() as numeric class ListOfPostsSmartViewBusinessObject
    
return 0

//-------------------------------------------------------------------
/*{Protheus.doc} handleQuery
    Permite manipular a query, transformando ela em view e executando filtros depois do primeiro resultado.
    Criado para o objeto de negócios List Of Interests.
    @author guilherme.sordi@totvs.com.br
    @since 28/08/2023
    @version 12.1.2210
*/
//-------------------------------------------------------------------
method handleQuery(cQuery as character) as character class ListOfPostsSmartViewBusinessObject
    
return cQuery


//----------------------------------------------------------------
/*/{Protheus.doc}converteMoedaMovimento
    Converte o valor do movimento para a moeda do relatório. 

    @author guilherme.sordi@totvs.com.br
    @since  14/08/2023
    @version 12.1.2210
/*/
//-----------------------------------------------------------------
method converteMoedaMovimento(nValor as numeric) as numeric class ListOfPostsSmartViewBusinessObject
    local dConversao := dDatabase as numeric
    local nTaxaContratada := 0 as numeric
    local nTaxaOrigem := 0 as numeric
    local nTaxaDestino := 0 as numeric
    local nMoedaMovimento := 1 as numeric

    if self:lPagar
        nMoedaMovimento := val((self:cAlias)->FK2_MOEDA)
        dConversao := (self:cAlias)->FK2_DATA
        if nMoedaMovimento <> 1
            nTaxaContratada := (self:cAlias)->FK2_TXMOED
        endIf
    else
        nMoedaMovimento := val((self:cAlias)->FK1_MOEDA)
        dConversao := (self:cAlias)->FK1_DATA        
        if nMoedaMovimento <> 1
            nTaxaContratada := (self:cAlias)->FK1_TXMOED
        endIf
    endIf

    if nMoedaMovimento == 1
        nTaxaDestino := nTaxaContratada
    else
        nTaxaOrigem := nTaxaContratada
    endIf

    nValor := xMoeda(nValor, nMoedaMovimento, self:nMoeda, dConversao, self:nDecimals, nTaxaOrigem, nTaxaDestino)
return nValor


//-------------------------------------------------------------------
/*{Protheus.doc} completeStatementPayable()
    Complementa os parametros dos fontes filhos.
    @author Matheus Monteiro da Silva
    @since 27/12/2023
    @version 12.1.2310
*/
//-------------------------------------------------------------------
method completeStatementPayable() class ListOfPostsSmartViewBusinessObject

return

//-------------------------------------------------------------------
/*{Protheus.doc} completeStatementReceivable()
    Complementa os parametros dos fontes filhos.
    @author Matheus Monteiro da Silva
    @since 27/12/2023
    @version 12.1.2310
*/
//-------------------------------------------------------------------
method completeStatementReceivable() class ListOfPostsSmartViewBusinessObject

return

//-------------------------------------------------------------------
/*{Protheus.doc} getSelectLocalizationFieldsPay()
    Adiciona campos localizados no Select do Contas a Pagar.
    @author Guilherme de Paula Santos
    @since 13/12/2024
    @version 12.1.2410
*/
//-------------------------------------------------------------------
method getSelectLocalizationFieldsPay() as character class ListOfPostsSmartViewBusinessObject
return ""
