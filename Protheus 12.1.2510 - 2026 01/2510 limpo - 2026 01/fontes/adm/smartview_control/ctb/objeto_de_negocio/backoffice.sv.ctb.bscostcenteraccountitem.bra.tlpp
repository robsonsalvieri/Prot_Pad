#include "totvs.ch"
#include "msobject.ch"
#include "totvs.framework.treports.integratedprovider.th"
#include "tlpp-core.th"
#include "tlpp-rest.th"
#include "backoffice.sv.ctb.bscostcenteraccountitem.bra.ch"

namespace totvs.protheus.ctb.smartviewintegratedprovider
using namespace control.sv.functions.utils

@totvsFrameworkTReportsIntegratedProvider(active=.T.,team="SIGACTB",tables="CT2,CTT,CTD", NAME="Balancete Centro de Custo x Conta x Item", country="ALL")

class BsCostCenterAccountItemSmartViewBusinessObject from totvs.protheus.ctb.smartviewintegratedprovider.SmartviewCtbFunctions
    
    public method new()                     as object
    public method getDescription()          as character
    public method getCtgGerPlanData()       as object
    public method getCtGerPlanSchema()      as object
    
    public method handleCtgGerPlanParams() 
    public method handleCtgGerPlanAppend()  as object
    public method handleExeCtgGerPlan()     as object

    public method processData()             as json
    public method preSchema()               as object
    public method preData()                 as object    

    public method ExecDBSkipTemp()          as logical
    
endclass

method new() as object class BsCostCenterAccountItemSmartViewBusinessObject
    _Super:new()
    //Define o nome do Objeto de Negócio
    self:setDisplayName(STR0001) // "Balancete Centro de Custo x Conta x Item"
    self:setPergunte("CTR185") //Indica o pergunte que será utilizado no relatório
return self

method getDescription() as character class BsCostCenterAccountItemSmartViewBusinessObject
return STR0002 //"Objeto contendo informações sobre o Balancete Centro de Custo x Item"

method getCtGerPlanSchema() as object class BsCostCenterAccountItemSmartViewBusinessObject
return self:oSchema

method getCtgGerPlanData(nPage as numeric, oFilter as object) as object class BsCostCenterAccountItemSmartViewBusinessObject
    //Carrega lista de parametros para a memória
    CTBsetValueMVPAR(oFilter:getParameters(),self:cPergunte)
    self:handleCtgGerPlanParams( oFilter )
    FreeObj(oFilter:getParameters())      
return self:oData

method handleExeCtgGerPlan(oFilter as object) as object class BsCostCenterAccountItemSmartViewBusinessObject
//execução da CTGERPLAN
return self:oData

method handleCtgGerPlanAppend(oFilter as object) as object class BsCostCenterAccountItemSmartViewBusinessObject
//execução do Append
return self:oData

method handleCtgGerPlanParams( oFilter ) class BsCostCenterAccountItemSmartViewBusinessObject
   
    local cContaIni         as Character
    local cContaFim         as Character
    local cCCIni            as Character
    local cCCFim            as Character
    local cItemIni          as Character
    local cItemFim          as Character
    local cMoeda  :=  "01"  as Character
    local cTpsald :=  "1"   as Character
    Local nDivide := 1      as numeric
    local lImpAntLP         as logical
    Local lImpSint          as Logical 
    Local lImpMov           as Logical 
    Local lPrintZero        as Logical
    local aSetOfBook        as array
    local aSelFil           as array
    local dDataIni          as Date
    local dDataFim          as Date
    local dDataLP           as Date
    
    dDataIni    := MV_PAR01 //Data Inicial ? 
    dDataFim    := MV_PAR02 //Data Final ?   
    cContaIni	:= MV_PAR03 //Conta Inicial ?               
    cContaFim	:= MV_PAR04 //Conta Final ?                 
    cCCIni      := MV_PAR05 //Do Centro de Custo ?          
    cCCFim      := MV_PAR06 //Ate o Centro de Custo ?       
    cItemIni    := MV_PAR07 //Do Item Contabil ?            
    cItemFim    := MV_PAR08 //Ate o Item Contabil ?         
    lImpSint    := Iif(mv_par09==1 .Or. mv_par09 ==3,.T.,.F.)//Imprime Contas ?              
    aSetOfBook  := iIf(!Empty(MV_PAR10),CTBSetOf(MV_PAR10),CTBSetOf("")) //Cod. Config. Livros ?         
    cMoeda      := iIf(!empty(MV_PAR11),MV_PAR11,cMoeda)//Moeda ?                       
    cTpsald     := iif(!Empty(MV_PAR13),PadR(AllTrim(MV_PAR13), TamSX3("CT2_TPSALD")[1]),cTpsald)//Tipo de Saldo ?               
    cFilSeg     := MV_PAR16 //Filtra Segmento No. ?         
    cConteudIni := MV_PAR17 //Conteudo Inicial Segmento ?   
    cConteudFim := MV_PAR18 //Conteudo Final Segmento ?     
    cConteudCont:= MV_PAR19 //Conteudo Contido em ?         
    lImpMov     := Iif(MV_PAR20==1,.T.,.F.)//Imprime Coluna Mov. ?         
    lPrintZero  := Iif(MV_PAR23==1,.T.,.F.)//Imprime Valor 0,00 ?          
    nDivide     := MV_PAR26
	lImpAntLP   := Iif(MV_PAR27 == 1,.T.,.F.) //Posicao Ant. L/P ?            
    dDataLP     := MV_PAR28 //Data Lucros/Perdas ?          
    aSelFil     := {xFilial('CT2')}
    
    //Setando os atributos
    self:dDataIni       := dDataIni
    self:dDataFim       := dDataFim
    self:cAlias         := "CT4"//são obrigatórios
    self:cIdent         := ""//são obrigatórios   
    self:cContaIni      := cContaIni
    self:cContaFim      := cContaFim
    self:cCCIni         := cCCIni  
    self:cCCFim         := cCCFim  
    self:cItemIni       := cItemIni
    self:cItemFim       := cItemFim
    self:cMoeda         := cMoeda
    self:cSaldos        := cTpsald
    self:aSetOfBook     := aSetOfBook
    self:cSegmento      := cFilSeg     
    self:cSegIni        := cConteudIni 
    self:cSegFim        := cConteudFim 
    self:cFiltSegm      := cConteudCont
    self:lNImpMov       := .F.
    self:lImpConta      := .T.
    self:cHeader        := 'CTT'
    self:lImpAntLP      := lImpAntLP     
    self:dDataLP        := dDataLP  
    self:nDivide        := nDivide
    self:lVlrZerado     := .F.
    self:aSelFil        := aSelFil
    self:lTodasFil      := .F.
    self:lImpSint       := lImpSint
    self:lImp3Ent       := .T.
    self:lCTBR185SV     := .T.
    
return 

/*/{Protheus.doc} BsCostCenterAccountItemSmartViewBusinessObject::preSchema
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method preSchema() as object class BsCostCenterAccountItemSmartViewBusinessObject 
return self:oSchema

/*/{Protheus.doc} BsCostCenterAccountItemSmartViewBusinessObject::preData
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method preData() as object class BsCostCenterAccountItemSmartViewBusinessObject 
return self:oData

/*/{Protheus.doc} BsCostCenterAccountItemSmartViewBusinessObject::processData
Metodo que será consumido pelo M.I.
@type method
@version 1.0  
@author loex
@since 11/13/2024
/*/

method processData() as json class BsCostCenterAccountItemSmartViewBusinessObject
return ::jDados

method ExecDBSkipTemp(cArqTmp As character) as logical class BsCostCenterAccountItemSmartViewBusinessObject
   
    Local lRet := .T.

    If mv_par09 == 1					// So imprime Sinteticas
        If cArqTMP->TIPOCONTA == "2" 
            lRet := .F.
        EndIf
	EndIf

    If mv_par09 == 2 .Or. mv_par09 == 3
        If cArqTMP->TIPOCONTA == "2" .And. Empty(cArqTMP->ITEM)
            lRet := .F.
        EndIf
    EndIf

return lRet
